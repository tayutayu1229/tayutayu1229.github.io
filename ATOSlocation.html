<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åˆ—è»Šãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    .line-selector {
      margin-bottom: 20px;
    }
    #monitor {
      position: relative;
      user-select: none;
    }
    .station-line {
      position: relative;
      margin-bottom: 20px;
      height: auto;
      min-height: 140px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 20px;
    }
    .track-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      background: #666;
      transform: translateY(-50%);
      z-index: 0;
      border-radius: 2px;
    }
    .station {
      position: absolute;
      width: 60px;
      height: 30px;
      background: #fff;
      border: 1px solid #000;
      text-align: center;
      line-height: 30px;
      font-size: 12px;
      transform: translate(-50%, -50%);
      top: 50%;
      z-index: 10;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      user-select: none;
    }
    .train {
      position: absolute;
      width: 120px; /* ã‚ˆã‚Šæ¨ªé•·ã« */
      height: 40px; /* é«˜ã•ã‚’å›ºå®š */
      padding: 4px 8px;
      font-size: 11px;
      text-align: center;
      border: 2px solid;
      background: white;
      cursor: pointer;
      user-select: none;
      box-sizing: border-box;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      white-space: nowrap;
      font-weight: 600;
      z-index: 5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transform: translateX(-50%); /* ä¸­å¤®æƒãˆ */
    }
    /* ä¸‹ã‚Šï¼ˆOutboundï¼‰å³å‘ãåˆ‡ã‚Šæ¬ ã - ã‚ˆã‚Šæ¨ªé•·å¯¾å¿œ */
    .train.down {
      clip-path: polygon(
        0 0, 100px 0, 
        108px 12px, 120px 25px, 108px 38px, 100px 50px,
        0 50px
      );
    }
    /* ä¸Šã‚Šï¼ˆInboundï¼‰å·¦å‘ãåˆ‡ã‚Šæ¬ ã - ã‚ˆã‚Šæ¨ªé•·å¯¾å¿œ */
    .train.up {
      clip-path: polygon(
        20px 0, 120px 0, 120px 50px, 20px 50px,
        12px 38px, 0 25px, 12px 12px
      );
    }
    .train-number {
      white-space: nowrap;
      font-weight: 700;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .delay {
      color: red;
      font-weight: bold;
      font-size: 11px;
    }
    .train-info {
      margin-top: 1px;
      font-size: 9px;
      color: #333;
      line-height: 1.1;
      user-select: none;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    /* è©³ç´°æƒ…å ±ãƒ‘ãƒãƒ« */
    .details {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 280px;
      background: #fff;
      border: 1px solid #aaa;
      padding: 12px 16px;
      font-size: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      border-radius: 8px;
      display: none;
      z-index: 9999;
      user-select: text;
    }
    .details strong {
      display: inline-block;
      width: 70px;
    }
    .close-btn {
      position: absolute;
      top: 6px;
      right: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      color: #666;
      user-select: none;
    }
    .close-btn:hover {
      color: #000;
    }
    /* æ›´æ–°ãƒœã‚¿ãƒ³ */
    .update-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 9999;
      user-select: none;
      transition: background-color 0.2s;
    }
    .update-btn:hover {
      background: #0056b3;
    }
    .update-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="line-selector">
    <label for="lineSelect">è·¯ç·šé¸æŠ:</label>
    <select id="lineSelect" onchange="render()"></select>
  </div>
  <div id="monitor"></div>

  <div id="details" class="details">
    <div class="close-btn" onclick="hideDetails()">Ã—</div>
    <div id="details-content"></div>
  </div>

  <!-- æ›´æ–°ãƒœã‚¿ãƒ³ -->
  <button id="updateBtn" class="update-btn" onclick="manualUpdate()">
    ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  </button>

<script>
  const token = "wvzxbmrc468he3y0p93ufz8ovhcqn5sauiiuixepg22wluhptpc42o78xfe38onh"; // â† ã“ã“ã«ã”è‡ªèº«ã®TOKENã‚’å…¥ã‚Œã¦ãã ã•ã„

  // è·¯ç·šã”ã¨ã®è‰²ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ å¯èƒ½ï¼‰
  const lineColors = {
    "odpt.Railway:JR-East.KeihinTohokuNegishi": "#0078BD",
    "odpt.Railway:JR-East.ChuoSobuLocal": "#FFE500",
  };

  // é§…åçŸ­ç¸®ãƒãƒƒãƒ—
  const stationNameMap = {
    "é«˜è¼ªã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤": "é«˜è¼ªã‚²ãƒˆ",
    "åƒè‘‰ã¿ãªã¨": "åƒè‘‰æ¸¯",
    "ã•ã„ãŸã¾æ–°éƒ½å¿ƒ": "ã•æ–°éƒ½å¿ƒ",
    "Maebashi": "å‰æ©‹"
  };

  let trainData = [];
  let railwayData = [];
  let stationTitles = {};
  let detailsTimer = null; // è©³ç´°ãƒ‘ãƒãƒ«è‡ªå‹•éè¡¨ç¤ºç”¨ã‚¿ã‚¤ãƒãƒ¼

  // ç¨®åˆ¥åå¤‰æ›ãƒãƒƒãƒ—
  const trainTypeMap = {
    "odpt.TrainType:JR-East.Local": [1, "æ™®é€š", ""],
    "odpt.TrainType:JR-East.LimitedExpress": [2, "ç‰¹æ€¥", "ç‰¹"],
    "odpt.TrainType:JR-East.Rapid": [3, "å¿«é€Ÿ", "å¿«"],
    "odpt.TrainType:JR-East.SpecialRapid": [4, "ç‰¹åˆ¥å¿«é€Ÿ", "ç‰¹å¿«"],
    "odpt.TrainType:JR-East.ChuoSpecialRapid": [5, "ä¸­å¤®ç‰¹å¿«", "ä¸­å¿«"],
    "odpt.TrainType:JR-East.CommuterRapid": [6, "é€šå‹¤å¿«é€Ÿ", "é€šå¿«"],
    "odpt.TrainType:JR-East.OmeSpecialRapid": [7, "é’æ¢…ç‰¹å¿«", "é’å¿«"],
    "odpt.TrainType:JR-East.CommuterSpecialRapid": [8, "é€šå‹¤ç‰¹å¿«", "é€šç‰¹"]
  };

  // é§…åã‚’4æ–‡å­—ä»¥å†…ã«ã‚«ãƒƒãƒˆï¼†çŸ­ç¸®ãƒãƒƒãƒ—é©ç”¨
  function shortenStationName(name) {
    if (stationNameMap[name]) return stationNameMap[name];
    if (name.length > 4) return name.slice(0, 4);
    return name;
  }

  // é§…IDâ†’æ—¥æœ¬èªé§…åçŸ­ç¸®
  function getStationTitle(stationId) {
    if (!stationId) return "ä¸æ˜";
    if (stationTitles[stationId]) return stationTitles[stationId];
    const parts = stationId.split(".");
    const last = parts[parts.length - 1];
    return shortenStationName(last);
  }

  // è·¯ç·šIDâ†’è·¯ç·šåï¼ˆæ—¥æœ¬èªï¼‰
  function getLineTitle(lineId) {
    const line = railwayData.find(r => r["owl:sameAs"] === lineId);
    return line?.["odpt:railwayTitle"]?.ja || lineId;
  }

  // ç¨®åˆ¥åã‚’å–å¾—
  function getTrainTypeName(trainType) {
    if (!trainType) return "ä¸æ˜";
    const typeInfo = trainTypeMap[trainType];
    return typeInfo ? typeInfo[1] : trainType.split(":").pop();
  }

  // é§…åãƒãƒƒãƒ—ã‚’ä½œæˆ
  function buildStationTitleMap() {
    stationTitles = {};
    railwayData.forEach(line => {
      (line["odpt:stationOrder"] || []).forEach(st => {
        const id = st["odpt:station"];
        const ja = st["odpt:stationTitle"]?.ja || id.split(".").pop();
        stationTitles[id] = shortenStationName(ja);
      });
    });
  }

  // ã‚»ãƒ¬ã‚¯ãƒˆã«è·¯ç·šã‚’å…¥ã‚Œã‚‹
  function populateLineSelect() {
    const select = document.getElementById("lineSelect");
    select.innerHTML = "";
    const uniqueLines = [...new Set(trainData.map(t => t["odpt:railway"]))];
    uniqueLines.forEach(lineId => {
      const option = document.createElement("option");
      option.value = lineId;
      option.textContent = getLineTitle(lineId);
      select.appendChild(option);
    });
  }

  // è©³ç´°ãƒ‘ãƒãƒ«ã‚’éš ã™
  function hideDetails() {
    document.getElementById("details").style.display = "none";
    if (detailsTimer) {
      clearTimeout(detailsTimer);
      detailsTimer = null;
    }
  }

  // è©³ç´°ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºï¼ˆ5ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤ºï¼‰
  function showDetails(train) {
    const d = document.getElementById("details");
    const content = document.getElementById("details-content");
    const delayMin = train["odpt:delay"] ? Math.floor(train["odpt:delay"] / 60) : 0;

    // èµ°è¡ŒåŒºé–“ï¼ˆfromã€œtoï¼‰ã‚’å–å¾—
    const fromStation = getStationTitle(train["odpt:fromStation"]) || "ä¸æ˜";
    const toStation = train["odpt:toStation"] ? getStationTitle(train["odpt:toStation"]) : null;
    
    let sectionInfo;
    if (toStation) {
      sectionInfo = `${fromStation}ã€œ${toStation}ï¼ˆé§…é–“èµ°è¡Œä¸­ï¼‰`;
    } else {
      sectionInfo = `${fromStation}ï¼ˆé§…åœè»Šä¸­ï¼‰`;
    }

    // çµ‚ç‚¹é§…
    const destStations = train["odpt:destinationStation"] || [];
    const destination = destStations.length > 0 ? getStationTitle(destStations[0]) : "ä¸æ˜";

    content.innerHTML =
      `<strong>åˆ—è»Šç•ªå·:</strong> ${train["odpt:trainNumber"] || 'ä¸æ˜'}<br>` +
      `<strong>æ–¹å‘:</strong> ${train["odpt:railDirection"] === "odpt.RailDirection:Outbound" ? "ä¸‹ã‚Š" : "ä¸Šã‚Š"}<br>` +
      `<strong>é…å»¶:</strong> ${delayMin > 0 ? delayMin + "åˆ†" : "ãªã—"}<br>` +
      `<strong>èµ°è¡ŒåŒºé–“:</strong> ${sectionInfo}<br>` +
      `<strong>çµ‚ç‚¹é§…:</strong> ${destination}<br>` +
      `<strong>ç¨®åˆ¥:</strong> ${getTrainTypeName(train["odpt:trainType"])}<br>` +
      `<strong>ç·¨æˆä¸¡æ•°:</strong> ${train["odpt:carComposition"] || 'ä¸æ˜'}ä¸¡`;
    
    d.style.display = "block";
    
    // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (detailsTimer) {
      clearTimeout(detailsTimer);
    }
    
    // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
    detailsTimer = setTimeout(() => {
      hideDetails();
    }, 5000);
  }

  // ãƒ¡ã‚¤ãƒ³æç”»é–¢æ•°
  function render() {
    const selectedLine = document.getElementById("lineSelect").value;
    const color = lineColors[selectedLine] || "#666";
    const monitor = document.getElementById("monitor");
    monitor.innerHTML = "";

    const lineData = railwayData.find(l => l["owl:sameAs"] === selectedLine);
    if (!lineData) return;

    // é§…ã‚’é †åºé€šã‚Šå–å¾—
    const stations = (lineData["odpt:stationOrder"] || [])
      .sort((a, b) => a["odpt:index"] - b["odpt:index"])
      .map(s => s["odpt:station"]);

    // 4é§…ãšã¤åŒºåˆ‡ã£ã¦æç”»
    for (let i = 0; i < stations.length; i += 4) {
      const group = stations.slice(i, i + 4);
      const lineDiv = document.createElement("div");
      lineDiv.className = "station-line";

      const track = document.createElement("div");
      track.className = "track-line";
      track.style.background = color;
      lineDiv.appendChild(track);

      // é§…è¡¨ç¤ºï¼ˆç·šã®ä¸­å¤®ä¸Šï¼‰
      group.forEach((stationId, idx) => {
        const s = document.createElement("div");
        s.className = "station";
        s.textContent = getStationTitle(stationId);
        // æ¨ªä½ç½®ã¯å‡ç­‰å‰²ã‚Šï¼ˆ1ï½lengthã®é–“ã§ï¼‰
        s.style.left = `${(idx + 1) * (100 / (group.length + 1))}%`;
        lineDiv.appendChild(s);
      });

      // åŒä¸€åŒºé–“ã®åˆ—è»Šä½ç½®èª¿æ•´ç”¨é…åˆ—
      const positionOffsets = {};
      let maxUpTrains = 0;    // ä¸Šã‚Šåˆ—è»Šã®æœ€å¤§é‡è¤‡æ•°
      let maxDownTrains = 0;  // ä¸‹ã‚Šåˆ—è»Šã®æœ€å¤§é‡è¤‡æ•°

      // ã¾ãšå…¨ã¦ã®åˆ—è»Šã‚’åé›†ã—ã¦é‡è¤‡æ•°ã‚’è¨ˆç®—
      const trainsToRender = [];
      trainData.forEach(train => {
        if (train["odpt:railway"] !== selectedLine) return;

        const from = train["odpt:fromStation"];
        const to = train["odpt:toStation"];
        const direction = train["odpt:railDirection"];

        // fromStationãŒã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const idxFrom = group.indexOf(from);
        if (idxFrom === -1) return;

        let trainPosition;
        let positionKey;

        if (to === null || to === undefined) {
          // é§…ã«åœè»Šä¸­ï¼šfromStationä½ç½®ã«è¡¨ç¤º
          trainPosition = (idxFrom + 1) * (100 / (group.length + 1));
          positionKey = `station-${idxFrom}-${direction}`;
        } else {
          // é§…é–“èµ°è¡Œä¸­ï¼šfromã¨toã®ä¸­é–“ã«è¡¨ç¤º
          const idxTo = group.indexOf(to);
          if (idxTo === -1) return; // toStationãŒã‚°ãƒ«ãƒ¼ãƒ—ã«ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          
          const fromPos = (idxFrom + 1) * (100 / (group.length + 1));
          const toPos = (idxTo + 1) * (100 / (group.length + 1));
          trainPosition = (fromPos + toPos) / 2;
          positionKey = `between-${Math.min(idxFrom, idxTo)}-${Math.max(idxFrom, idxTo)}-${direction}`;
        }

        const offsetCount = positionOffsets[positionKey] || 0;
        positionOffsets[positionKey] = offsetCount + 1;

        // æœ€å¤§é‡è¤‡æ•°ã‚’æ›´æ–°
        if (direction === "odpt.RailDirection:Inbound") {
          maxUpTrains = Math.max(maxUpTrains, offsetCount + 1);
        } else {
          maxDownTrains = Math.max(maxDownTrains, offsetCount + 1);
        }

        trainsToRender.push({
          train,
          trainPosition,
          direction,
          offsetCount,
          isAtStation: (to === null || to === undefined)
        });
      });

      // é§…åŒºé–“ã®é«˜ã•ã‚’å‹•çš„ã«èª¿æ•´
      const trainHeight = 60; // åˆ—è»Š1ã¤åˆ†ã®é«˜ã•ï¼ˆä½™ç™½å«ã‚€ï¼‰
      const minHeight = 140;
      const requiredHeight = minHeight + (maxUpTrains + maxDownTrains) * trainHeight;
      lineDiv.style.height = `${requiredHeight}px`;

      // åˆ—è»Šæç”»
      trainsToRender.forEach(({ train, trainPosition, direction, offsetCount, isAtStation }) => {
        const delay = train["odpt:delay"] ? Math.floor(train["odpt:delay"] / 60) : 0;
        const number = train["odpt:trainNumber"] || "ä¸æ˜";
        const carCount = train["odpt:carComposition"] || "";
        const destStations = train["odpt:destinationStation"] || [];
        const destination = destStations.length > 0 ? getStationTitle(destStations[0]) : "ä¸æ˜";

        const div = document.createElement("div");
        div.className = "train " + (direction === "odpt.RailDirection:Outbound" ? "down" : "up");
        div.style.borderColor = color;

        // é§…åœè»Šä¸­ã¯å°‘ã—ç•°ãªã‚‹è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«
        //if (isAtStation) {
        //  div.style.backgroundColor = "#f0f8ff"; // è–„ã„é’ã§åœè»Šä¸­ã‚’è¡¨ç¾
        //  div.style.borderStyle = "dashed"; // ç‚¹ç·šã§åœè»Šä¸­ã‚’è¡¨ç¾
        //}

        // åˆ—è»Šã®æ¨ªä½ç½®
        div.style.left = `${trainPosition}%`;

        // ä¸Šã‚Šï¼ˆå·¦å‘ãï¼‰åˆ—è»Šã¯ç”»é¢ä¸‹éƒ¨ã«é…ç½®
        if (direction === "odpt.RailDirection:Inbound") {
          div.style.bottom = `${20 + offsetCount * trainHeight}px`;
        } else {
          // ä¸‹ã‚Šï¼ˆå³å‘ãï¼‰åˆ—è»Šã¯ç”»é¢ä¸Šéƒ¨ã«é…ç½®
          div.style.top = `${20 + offsetCount * trainHeight}px`;
        }

        // å†…éƒ¨æ§‹é€ ï¼ˆç•ªå·ï¼‹é…å»¶ï¼‹ä¸¡æ•°ï¼‹è¡Œå…ˆï¼‰
        const statusText = isAtStation ? "åœè»Šä¸­" : "";
        div.innerHTML =
          `<div class="train-number">${number}${delay > 0 ? `<span class="delay">+${delay}</span>` : ""}</div>` +
          `<div class="train-info">${statusText ? statusText + " " : ""}${carCount ? carCount + "ä¸¡" : ""} ${destination}</div>`;

        // è©³ç´°è¡¨ç¤ºã‚¤ãƒ™ãƒ³ãƒˆ
        div.onclick = () => showDetails(train);

        lineDiv.appendChild(div);
      });

      monitor.appendChild(lineDiv);
    }
  }

  // æ‰‹å‹•æ›´æ–°
  function manualUpdate() {
    const btn = document.getElementById("updateBtn");
    btn.disabled = true;
    btn.textContent = "ğŸ”„ æ›´æ–°ä¸­...";
    
    fetchData().then(() => {
      btn.disabled = false;
      btn.textContent = "ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°";
    }).catch(() => {
      btn.disabled = false;
      btn.textContent = "ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°";
    });
  }

  // APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†åˆæœŸæç”»
  async function fetchData() {
  try {
    // ğŸ”¸ ç¾åœ¨é¸ã°ã‚Œã¦ã„ã‚‹è·¯ç·šã‚’ä¿æŒ
    const select = document.getElementById("lineSelect");
    const previousSelectedLine = select.value;

    const [trainRes, railRes] = await Promise.all([
      fetch(`https://api-challenge.odpt.org/api/v4/odpt:Train?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${token}`),
      fetch(`https://api-challenge.odpt.org/api/v4/odpt:Railway?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${token}`)
    ]);

    if (!trainRes.ok || !railRes.ok) throw new Error("APIå–å¾—ã‚¨ãƒ©ãƒ¼");

    trainData = await trainRes.json();
    railwayData = await railRes.json();

    buildStationTitleMap();
    populateLineSelect();

    // ğŸ”¸ å‰å›é¸ã‚“ã§ã„ãŸè·¯ç·šãŒã‚ã‚Œã°å¾©å…ƒ
    if ([...select.options].some(opt => opt.value === previousSelectedLine)) {
      select.value = previousSelectedLine;
    }

    render();
  } catch (e) {
    alert("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
  }
}


  // 30ç§’ã”ã¨ã«è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
  setInterval(fetchData, 30000);

  fetchData();
</script>
</body>
</html>
