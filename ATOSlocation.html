<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ATOSåœ¨ç·šãƒ¢ãƒ‹ã‚¿</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    .line-selector {
      margin-bottom: 20px;
    }
    
    /* é‹è¡Œæƒ…å ±ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    .train-info-ticker {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #333;
      color: white;
      height: 40px;
      overflow: hidden;
      z-index: 1000;
      display: flex;
      align-items: center;
    }
    .train-info-content {
      white-space: nowrap;
      animation: scroll-left 30s linear infinite;
      font-size: 14px;
      font-weight: 500;
    }
    @keyframes scroll-left {
      0% {
        transform: translateX(100%);
      }
      100% {
        transform: translateX(-100%);
      }
    }
    body {
      font-family: sans-serif;
      padding: 60px 20px 20px 20px; /* ä¸Šéƒ¨ã«ãƒ†ã‚£ãƒƒã‚«ãƒ¼åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ */
      background: #f9f9f9;
      margin: 0;
    }
    #monitor {
      position: relative;
      user-select: none;
    }
    .station-line {
      position: relative;
      margin-bottom: 30px;
      height: auto;
      min-height: 140px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      background: #fafafa;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .track-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      background: #666;
      transform: translateY(-50%);
      z-index: 0;
      border-radius: 2px;
    }
    .station {
      position: absolute;
      width: 90px;
      height: 30px;
      background: #fff;
      border: 1px solid #000;
      text-align: center;
      line-height: 30px;
      font-size: 12px;
      transform: translate(-50%, -50%);
      top: 50%;
      z-index: 10;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      user-select: none;
    }

    .train {
      position: absolute;
      width: 120px;
      height: 40px;
      padding: 4px 8px;
      font-size: 11px;
      text-align: center;
      border: 2px solid;
      background: white;
      cursor: pointer;
      user-select: none;
      box-sizing: border-box;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      white-space: nowrap;
      font-weight: 600;
      z-index: 5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transform: translateX(-50%);
    }
    /* ã‚°ãƒ«ãƒ¼ãƒ—é–“åˆ—è»Šç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .train.cross-group {
      right: -60px; /* ã‚°ãƒ«ãƒ¼ãƒ—ã®å³ç«¯è¿‘ãã«é…ç½® */
      transform: translateX(0);
    }
    /* ä¸‹ã‚Šï¼ˆOutboundï¼‰å³å‘ãåˆ‡ã‚Šæ¬ ã */
    .train.down {
      clip-path: polygon(
        0 0,       
        90px 0,    
        120px 50px,
        0 50px     
      );
    }
    /* ä¸Šã‚Šï¼ˆInboundï¼‰å·¦å‘ãåˆ‡ã‚Šæ¬ ã */
    .train.up {
      clip-path: polygon(
       20px 0,     /* æ–œã‚å…ˆé ­ */
        120px 0,    /* å³ä¸Š */
        120px 50px, /* å³ä¸‹ */
        0px 50px   /* æ–œã‚å…ˆé ­ä¸‹ */
      );
    }
    .train-number {
      white-space: nowrap;
      font-weight: 700;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .delay {
      color: red;
      font-weight: bold;
      font-size: 11px;
    }
    .train-info {
      margin-top: 1px;
      font-size: 9px;
      color: #333;
      line-height: 1.1;
      user-select: none;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .details {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 280px;
      background: #fff;
      border: 1px solid #aaa;
      padding: 12px 16px;
      font-size: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      border-radius: 8px;
      display: none;
      z-index: 9999;
      user-select: text;
    }
    .details strong {
      display: inline-block;
      width: 70px;
    }
    .close-btn {
      position: absolute;
      top: 6px;
      right: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      color: #666;
      user-select: none;
      background: transparent;
      border: none;
      padding: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .close-btn:hover {
      color: #000;
      background: rgba(0,0,0,0.1);
      border-radius: 12px;
    }
    .update-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 9999;
      user-select: none;
      transition: background-color 0.2s;
    }
    .update-btn:hover {
      background: #0056b3;
    }
    .update-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <button onclick="window.location.href='toppage.html'">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
  <br>
  <br>
  <!-- é‹è¡Œæƒ…å ±ãƒ†ã‚£ãƒƒã‚«ãƒ¼ -->
  <div class="train-info-ticker">
    <div class="train-info-content" id="trainInfoTicker">
      é‹è¡Œæƒ…å ±ã‚’å–å¾—ä¸­...
    </div>
  </div>

  <div class="line-selector">
    <label for="lineSelect">è·¯ç·šé¸æŠ:</label>
    <select id="lineSelect" onchange="render()"></select>
  </div>
  <div id="monitor"></div>

  <div id="details" class="details">
    <button class="close-btn" onclick="hideDetails()">Ã—</button>
    <div id="details-content"></div>
  </div>

  <button id="updateBtn" class="update-btn" onclick="manualUpdate()">
    ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  </button>

<script>
  const token = "wvzxbmrc468he3y0p93ufz8ovhcqn5sauiiuixepg22wluhptpc42o78xfe38onh";

  const lineColors = {
    "odpt.Railway:JR-East.KeihinTohokuNegishi": "#0078BD",
    "odpt.Railway:JR-East.ChuoSobuLocal": "#FFE500",
    "odpt.Railway:JR-East.Takasaki": "#FF8C00",
    "odpt.Railway:JR-East.Utsunomiya": "#FF8C00",
    "odpt.Railway:JR-East.ShonanShinjuku": "#FF8C00",
    "odpt.Railway:JR-East.Tokaido": "#FF8C00",
    "odpt.Railway:JR-East.Chuo": "#FFA500",
    "odpt.Railway:JR-East.Ome": "#FFA500",
    "odpt.Railway:JR-East.Itsukaichi": "#FFA500",
    "odpt.Railway:JR-East.ChuoRapid": "#FFA500",
    "odpt.Railway:JR-East.Musashino": "#734E30",
    "odpt.Railway:JR-East.Nambu": "yellow",
    "odpt.Railway:JR-East.Yamanote": "#32cd32",
    "odpt.Railway:JR-East.Keiyo": "#EF454A",
    "odpt.Railway:JR-East.SaikyoKawagoe": "#00AC84",
    "odpt.Railway:JR-East.JobanRapid": "#0000ff",
    "odpt.Railway:JR-East.Yokohama": "#00ff00",
    "odpt.Railway:JR-East.Yokosuka": "#0033cc",
    "odpt.Railway:JR-East.SobuRapid": "#0033cc",
    "odpt.Railway:JR-East.JobanLocal": "#2F9A9A",
    "odpt.Railway:JR-East.Joban": "#006881",
  };

  // åŒä¸€ç·šåŒºã‚’çµ±åˆã™ã‚‹ãƒãƒƒãƒ”ãƒ³ã‚°
  const lineGroups = {
    "æ¹˜å—æ–°å®¿ãƒ©ã‚¤ãƒ³": [
      "odpt.Railway:JR-East.ShonanShinjuku"
    ],
    "åŸ¼äº¬ãƒ»å·è¶Šç·š": [
      "odpt.Railway:JR-East.SaikyoKawagoe"
    ],
    "äº¬æµœæ±åŒ—ãƒ»æ ¹å²¸ç·š": [
      "odpt.Railway:JR-East.KeihinTohokuNegishi"
    ],
    "ä¸­å¤®ãƒ»ç·æ­¦å„é§…åœè»Š": [
      "odpt.Railway:JR-East.ChuoSobuLocal"
    ],
    "å±±æ‰‹ç·š": [
      "odpt.Railway:JR-East.Yamanote"
    ]
  };

  // é«˜å´ç·šãƒ»å®‡éƒ½å®®ç·šã®å…±é€šåŒºé–“å®šç¾©ï¼ˆæ±äº¬ã€œå¤§å®®ï¼‰
  const sharedSections = {
    "odpt.Railway:JR-East.Takasaki": ["odpt.Railway:JR-East.Utsunomiya"],
    "odpt.Railway:JR-East.Utsunomiya": ["odpt.Railway:JR-East.Takasaki"]
  };

  // æ–¹å‘åˆ¤å®šã®æ”¹å–„ - è·¯ç·šã”ã¨ã®æ–¹å‘ãƒãƒƒãƒ”ãƒ³ã‚°
  const railwayDirectionMap = {
    // æ¹˜å—æ–°å®¿ãƒ©ã‚¤ãƒ³
    "odpt.Railway:JR-East.ShonanShinjuku": {
      "odpt.RailDirection:Northbound": "down",
      "odpt.RailDirection:Southbound": "up",
      "odpt.RailDirection:Inbound": "up",
      "odpt.RailDirection:Outbound": "down"
    },
  };

  // æ–¹å‘åˆ¤å®šã®æ”¹å–„
  function getTrainDirection(railDirection, railwayId) {
    // è·¯ç·šå›ºæœ‰ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
    if (railwayDirectionMap[railwayId] && railwayDirectionMap[railwayId][railDirection]) {
      return railwayDirectionMap[railwayId][railDirection];
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ–¹å‘åˆ¤å®š
    switch (railDirection) {
      // å¾“æ¥ã®ä¸Šã‚Š/ä¸‹ã‚Š
      case "odpt.RailDirection:Inbound":
        return "up";
      case "odpt.RailDirection:Outbound":
        return "down";
      
      // åŒ—è¡Œ/å—è¡Œ
      case "odpt.RailDirection:Northbound":
        return "up";
      case "odpt.RailDirection:Southbound":
        return "down";
      
      // æ±è¡Œ/è¥¿è¡Œ
      case "odpt.RailDirection:Eastbound":
        return "down";
      case "odpt.RailDirection:Westbound":
        return "up";
      
      // å†…å›ã‚Š/å¤–å›ã‚Š
      case "odpt.RailDirection:InnerLoop":
        return "up";
      case "odpt.RailDirection:OuterLoop":
        return "down";
      
      default:
        return "down"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸‹ã‚Šæ‰±ã„
    }
  }

  function getDirectionText(railDirection, railwayId) {
    // è·¯ç·šå›ºæœ‰ã®è¡¨ç¤ºåãŒã‚ã‚‹å ´åˆã®åˆ¤å®š
    const lineSpecificText = {
      "odpt.Railway:JR-East.Yamanote": {
        "odpt.RailDirection:InnerLoop": "å†…å›ã‚Š",
        "odpt.RailDirection:OuterLoop": "å¤–å›ã‚Š"
      },
      "odpt.Railway:JR-East.ChuoSobuLocal": {
        "odpt.RailDirection:Eastbound": "æ±è¡Œ",
        "odpt.RailDirection:Westbound": "è¥¿è¡Œ"
      }
    };
    
    if (lineSpecificText[railwayId] && lineSpecificText[railwayId][railDirection]) {
      return lineSpecificText[railwayId][railDirection];
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ–¹å‘è¡¨ç¤º
    switch (railDirection) {
      case "odpt.RailDirection:Inbound":
        return "ä¸Šã‚Š";
      case "odpt.RailDirection:Outbound":
        return "ä¸‹ã‚Š";
      case "odpt.RailDirection:Northbound":
        return "åŒ—è¡Œ";
      case "odpt.RailDirection:Southbound":
        return "å—è¡Œ";
      case "odpt.RailDirection:Eastbound":
        return "æ±è¡Œ";
      case "odpt.RailDirection:Westbound":
        return "è¥¿è¡Œ";
      case "odpt.RailDirection:InnerLoop":
        return "å†…å›ã‚Š";
      case "odpt.RailDirection:OuterLoop":
        return "å¤–å›ã‚Š";
      default:
        return "ä¸æ˜";
    }
  }

  const stationNameMap = {
    "é«˜è¼ªã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤": "é«˜è¼ªã‚²ãƒˆ",
    "åƒè‘‰ã¿ãªã¨": "åƒè‘‰æ¸¯",
    "ã•ã„ãŸã¾æ–°éƒ½å¿ƒ": "ã•æ–°éƒ½å¿ƒ",
    "Maebashi": "å‰æ©‹"
  };

  let trainData = [];
  let railwayData = [];
  let stationTitles = {};
  let detailsTimer = null; 
  let trainInformationData = []; 

  const trainTypeMap = {
    "odpt.TrainType:JR-East.Local": [1, "æ™®é€š", ""],
    "odpt.TrainType:JR-East.LimitedExpress": [2, "ç‰¹æ€¥", "ç‰¹"],
    "odpt.TrainType:JR-East.Rapid": [3, "å¿«é€Ÿ", "å¿«"],
    "odpt.TrainType:JR-East.SpecialRapid": [4, "ç‰¹åˆ¥å¿«é€Ÿ", "ç‰¹å¿«"],
    "odpt.TrainType:JR-East.ChuoSpecialRapid": [5, "ä¸­å¤®ç‰¹å¿«", "ä¸­å¿«"],
    "odpt.TrainType:JR-East.CommuterRapid": [6, "é€šå‹¤å¿«é€Ÿ", "é€šå¿«"],
    "odpt.TrainType:JR-East.OmeSpecialRapid": [7, "é’æ¢…ç‰¹å¿«", "é’å¿«"],
    "odpt.TrainType:JR-East.CommuterSpecialRapid": [8, "é€šå‹¤ç‰¹å¿«", "é€šç‰¹"]
  };

  function shortenStationName(name) {
    if (stationNameMap[name]) return stationNameMap[name];
    if (name.length > 4) return name.slice(0, 4);
    return name;
  }

  function getStationTitle(stationId) {
    if (!stationId) return "ä¸æ˜";
    if (stationTitles[stationId]) return stationTitles[stationId];
    const parts = stationId.split(".");
    const last = parts[parts.length - 1];
    return shortenStationName(last);
  }

  function getLineTitle(lineId) {
    // ã‚°ãƒ«ãƒ¼ãƒ—åã§æ¤œç´¢
    for (const [groupName, lines] of Object.entries(lineGroups)) {
      if (lines.includes(lineId)) {
        return groupName;
      }
    }
    
    // å€‹åˆ¥è·¯ç·šå
    const line = railwayData.find(r => r["owl:sameAs"] === lineId);
    return line?.["odpt:railwayTitle"]?.ja || lineId;
  }

  function getTrainTypeName(trainType) {
    if (!trainType) return "ä¸æ˜";
    const typeInfo = trainTypeMap[trainType];
    return typeInfo ? typeInfo[1] : trainType.split(":").pop();
  }

  function buildStationTitleMap() {
    stationTitles = {};
    railwayData.forEach(line => {
      (line["odpt:stationOrder"] || []).forEach(st => {
        const id = st["odpt:station"];
        const ja = st["odpt:stationTitle"]?.ja || id.split(".").pop();
        stationTitles[id] = shortenStationName(ja);
      });
    });
  }

  function populateLineSelect() {
    const select = document.getElementById("lineSelect");
    select.innerHTML = "";
    
    // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸè·¯ç·šé¸æŠè‚¢ã‚’ä½œæˆ
    const addedGroups = new Set();
    const uniqueLines = [...new Set(trainData.map(t => t["odpt:railway"]))];
    
    uniqueLines.forEach(lineId => {
      let groupName = null;
      let isGrouped = false;
      
      // ã‚°ãƒ«ãƒ¼ãƒ—ã«å±ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      for (const [gName, lines] of Object.entries(lineGroups)) {
        if (lines.includes(lineId)) {
          groupName = gName;
          isGrouped = true;
          break;
        }
      }
      
      if (isGrouped && !addedGroups.has(groupName)) {
        // ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã—ã¦è¿½åŠ 
        const option = document.createElement("option");
        option.value = groupName;
        option.textContent = groupName;
        select.appendChild(option);
        addedGroups.add(groupName);
      } else if (!isGrouped) {
        // å€‹åˆ¥è·¯ç·šã¨ã—ã¦è¿½åŠ 
        const option = document.createElement("option");
        option.value = lineId;
        option.textContent = getLineTitle(lineId);
        select.appendChild(option);
      }
    });
    
    updateTrainInfoTicker();
  }

  function updateTrainInfoTicker() {
    const selectedLine = document.getElementById("lineSelect").value;
    const ticker = document.getElementById("trainInfoTicker");
    
    if (!selectedLine) {
      ticker.textContent = "è·¯ç·šã‚’é¸æŠã—ã¦ãã ã•ã„";
      return;
    }
    
    // é¸æŠã•ã‚ŒãŸè·¯ç·šï¼ˆã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã®é‹è¡Œæƒ…å ±ã‚’å–å¾—
    let targetLines = [];
    if (lineGroups[selectedLine]) {
      targetLines = lineGroups[selectedLine];
    } else {
      targetLines = [selectedLine];
    }
    
    let displayTexts = [];
    targetLines.forEach(lineId => {
      const lineInfo = trainInformationData.find(info => info["odpt:railway"] === lineId);
      if (lineInfo) {
        const infoText = lineInfo["odpt:trainInformationText"]?.ja || "é‹è¡Œæƒ…å ±ãªã—";
        const status = lineInfo["odpt:trainInformationStatus"]?.ja || "";
        const cause = lineInfo["odpt:trainInformationCause"]?.ja || "";
        const range = lineInfo["odpt:trainInformationRange"]?.ja || "";
        
        let text = infoText;
        if (status && status !== "å¹³å¸¸é‹è»¢") {
          text = `ã€${status}ã€‘${infoText}`;
          if (cause) text += ` (åŸå› : ${cause})`;
          if (range) text += ` [åŒºé–“: ${range}]`;
        }
        displayTexts.push(text);
      }
    });
    
    if (displayTexts.length > 0) {
      ticker.textContent = displayTexts.join(" | ");
    } else {
      ticker.textContent = `${getLineTitle(selectedLine)}: é‹è¡Œæƒ…å ±ãªã—`;
    }

    document.getElementById("details").style.display = "none";
    if (detailsTimer) {
      clearTimeout(detailsTimer);
      detailsTimer = null;
    }
  }

  function hideDetails() {
    document.getElementById("details").style.display = "none";
    if (detailsTimer) {
      clearTimeout(detailsTimer);
      detailsTimer = null;
    }
  }

  function showDetails(train) {
    const d = document.getElementById("details");
    const content = document.getElementById("details-content");
    const delayMin = train["odpt:delay"] ? Math.floor(train["odpt:delay"] / 60) : 0;

    const fromStation = getStationTitle(train["odpt:fromStation"]) || "ä¸æ˜";
    const toStation = train["odpt:toStation"] ? getStationTitle(train["odpt:toStation"]) : null;
    
    let sectionInfo;
    if (toStation) {
      sectionInfo = `${fromStation}ã€œ${toStation}`;
    } else {
      sectionInfo = `${fromStation}ã€€ã€€ã€€`;
    }

    const destStations = train["odpt:destinationStation"] || [];
    const destination = destStations.length > 0 ? getStationTitle(destStations[0]) : "ä¸æ˜";

    content.innerHTML =
      `<strong>åˆ—è»Šç•ªå·:</strong> ${train["odpt:trainNumber"] || 'ä¸æ˜'}<br>` +
      `<strong>æ–¹å‘:</strong> ${getDirectionText(train["odpt:railDirection"], train["odpt:railway"])}<br>` +
      `<strong>é…å»¶:</strong> ${delayMin > 0 ? delayMin + "åˆ†" : "ãªã—"}<br>` +
      `<strong>èµ°è¡ŒåŒºé–“:</strong> ${sectionInfo}<br>` +
      `<strong>çµ‚ç‚¹é§…:</strong> ${destination}<br>` +
      `<strong>ç¨®åˆ¥:</strong> ${getTrainTypeName(train["odpt:trainType"])}<br>` +
      `<strong>ç·¨æˆä¸¡æ•°:</strong> ${train["odpt:carComposition"] || 'ä¸æ˜'}ä¸¡`;
    
    d.style.display = "block";
    
    if (detailsTimer) {
      clearTimeout(detailsTimer);
    }
    
    detailsTimer = setTimeout(() => {
      hideDetails();
    }, 5000);
  }

  function render() {
    const selectedLine = document.getElementById("lineSelect").value;
    const monitor = document.getElementById("monitor");
    monitor.innerHTML = "";

    updateTrainInfoTicker();

    // é¸æŠã•ã‚ŒãŸè·¯ç·šï¼ˆã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã«å«ã¾ã‚Œã‚‹å®Ÿéš›ã®è·¯ç·šIDã‚’å–å¾—
    let targetLines = [];
    let primaryLineId = selectedLine;
    
    if (lineGroups[selectedLine]) {
      targetLines = lineGroups[selectedLine];
      primaryLineId = targetLines[0]; // ä»£è¡¨è·¯ç·šã‚’ä½¿ç”¨ã—ã¦stationOrderã‚’å–å¾—
    } else {
      targetLines = [selectedLine];
      // é«˜å´ç·šãƒ»å®‡éƒ½å®®ç·šã®å ´åˆã¯å…±é€šåŒºé–“ã‚‚å«ã‚ã‚‹
      if (sharedSections[selectedLine]) {
        targetLines = targetLines.concat(sharedSections[selectedLine]);
      }
    }

    const color = lineColors[primaryLineId] || "#666";
    const lineData = railwayData.find(l => l["owl:sameAs"] === primaryLineId);
    if (!lineData) return;

    // å…¨é§…ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»˜ãï¼‰
    const allStations = (lineData["odpt:stationOrder"] || [])
      .sort((a, b) => a["odpt:index"] - b["odpt:index"]);
    
    const stationIds = allStations.map(s => s["odpt:station"]);

    // ç’°çŠ¶ç·šã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆå±±æ‰‹ç·šãªã©ï¼‰
    const isCircularLine = selectedLine === "å±±æ‰‹ç·š" || primaryLineId === "odpt.Railway:JR-East.Yamanote";

    // 4é§…ãšã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²ã—ã¦æç”»
    let groupIndex = 0;
    for (let i = 0; i < stationIds.length; i += 4) {
      const group = stationIds.slice(i, i + 4);
      
      if (group.length === 0) break;
      
      const lineDiv = document.createElement("div");
      lineDiv.className = "station-line";

      const track = document.createElement("div");
      track.className = "track-line";
      track.style.background = color;
      lineDiv.appendChild(track);

      // é§…è¡¨ç¤º
      group.forEach((stationId, idx) => {
        const s = document.createElement("div");
        s.className = "station";
        s.textContent = getStationTitle(stationId);
        s.style.left = `${(idx + 1) * (100 / (group.length + 1))}%`;
        lineDiv.appendChild(s);
      });

      // åŒä¸€åŒºé–“ã®åˆ—è»Šä½ç½®èª¿æ•´ç”¨é…åˆ—
      const positionOffsets = {};
      let maxUpTrains = 0;
      let maxDownTrains = 0;

      const trainsToRender = [];
      
      // å¯¾è±¡è·¯ç·šã‚°ãƒ«ãƒ¼ãƒ—ã®åˆ—è»Šã‚’ãƒã‚§ãƒƒã‚¯
      trainData.forEach(train => {
        if (!targetLines.includes(train["odpt:railway"])) return;

        const from = train["odpt:fromStation"];
        const to = train["odpt:toStation"];
        const direction = train["odpt:railDirection"];

        const globalFromIdx = stationIds.indexOf(from);
        const globalToIdx = to ? stationIds.indexOf(to) : -1;

        if (globalFromIdx === -1) return;

        let shouldRender = false;
        let trainPosition;
        let positionKey;

        const localFromIdx = group.indexOf(from);
        if (localFromIdx !== -1) {
          if (to === null || to === undefined) {
            trainPosition = (localFromIdx + 1) * (100 / (group.length + 1));
            positionKey = `station-${localFromIdx}-${direction}`;
            shouldRender = true;
          } else {
            const localToIdx = group.indexOf(to);
            if (localToIdx !== -1) {
              const fromPos = (localFromIdx + 1) * (100 / (group.length + 1));
              const toPos = (localToIdx + 1) * (100 / (group.length + 1));
              trainPosition = (fromPos + toPos) / 2;
              positionKey = `between-${Math.min(localFromIdx, localToIdx)}-${Math.max(localFromIdx, localToIdx)}-${direction}`;
              shouldRender = true;
            }
          }
        }

        if (shouldRender) {
          const offsetCount = positionOffsets[positionKey] || 0;
          positionOffsets[positionKey] = offsetCount + 1;

          const trainDir = getTrainDirection(direction, train["odpt:railway"]);
          if (trainDir === "up") {
            maxUpTrains = Math.max(maxUpTrains, offsetCount + 1);
          } else {
            maxDownTrains = Math.max(maxDownTrains, offsetCount + 1);
          }

          trainsToRender.push({
            train,
            trainPosition,
            direction,
            trainDir,
            offsetCount,
            isAtStation: (to === null || to === undefined)
          });
        }
      });

      // é§…åŒºé–“ã®é«˜ã•ã‚’å‹•çš„ã«èª¿æ•´
      const trainHeight = 60;
      const minHeight = 140;
      const requiredHeight = minHeight + (maxUpTrains + maxDownTrains) * trainHeight;
      lineDiv.style.height = `${requiredHeight}px`;

      // åˆ—è»Šæç”»
      trainsToRender.forEach(({ train, trainPosition, direction, trainDir, offsetCount, isAtStation }) => {
        const delay = train["odpt:delay"] ? Math.floor(train["odpt:delay"] / 60) : 0;
        const number = train["odpt:trainNumber"] || "ä¸æ˜";
        const carCount = train["odpt:carComposition"] || "";
        const destStations = train["odpt:destinationStation"] || [];
        const destination = destStations.length > 0 ? getStationTitle(destStations[0]) : "ä¸æ˜";

        const div = document.createElement("div");
        div.className = "train " + trainDir;
        div.style.borderColor = color;
        div.style.left = `${trainPosition}%`;

        if (trainDir === "up") {
          div.style.top = `calc(50% + 25px + ${offsetCount * trainHeight}px)`;
        } else {
          div.style.bottom = `calc(50% + 25px + ${offsetCount * trainHeight}px)`;
        }

        const statusText = isAtStation ? "" : "";
        div.innerHTML =
          `<div class="train-number">${number}${delay > 0 ? `<span class="delay">+${delay}</span>` : ""}</div>` +
          `<div class="train-info">${statusText ? statusText + " " : ""}${carCount ? carCount + "ä¸¡" : ""} ${destination}</div>`;

        div.onclick = () => showDetails(train);

        lineDiv.appendChild(div);
      });

      monitor.appendChild(lineDiv);
      groupIndex++;
    }
  }

  function manualUpdate() {
    const btn = document.getElementById("updateBtn");
    btn.disabled = true;
    btn.textContent = "ğŸ”„ æ›´æ–°ä¸­...";
    
    fetchData().then(() => {
      btn.disabled = false;
      btn.textContent = "ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°";
    }).catch(() => {
      btn.disabled = false;
      btn.textContent = "ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°";
    });
  }

  async function fetchData() {
    try {
      const select = document.getElementById("lineSelect");
      const previousSelectedLine = select.value;

      const [trainRes, railRes, infoRes] = await Promise.all([
        fetch(`https://api-challenge.odpt.org/api/v4/odpt:Train?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${token}`),
        fetch(`https://api-challenge.odpt.org/api/v4/odpt:Railway?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${token}`),
        fetch(`https://api-challenge.odpt.org/api/v4/odpt:TrainInformation?odpt:operator=odpt.Operator:jre-is&acl:consumerKey=${token}`)
      ]);

      if (!trainRes.ok || !railRes.ok) throw new Error("APIå–å¾—ã‚¨ãƒ©ãƒ¼");

      // é‹è¡Œæƒ…å ±ã®å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼‰
      try {
        if (infoRes.ok) {
          trainInformationData = await infoRes.json();
        }
      } catch (e) {
        console.warn("é‹è¡Œæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        trainInformationData = [];
      }

      trainData = await trainRes.json();
      railwayData = await railRes.json();

      buildStationTitleMap();
      populateLineSelect();

      if ([...select.options].some(opt => opt.value === previousSelectedLine)) {
        select.value = previousSelectedLine;
      }

      render();
    } catch (e) {
      alert("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
    }
  }

  setInterval(fetchData, 30000);
  fetchData();
</script>
</body>
</html>
