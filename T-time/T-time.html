<body>
  <header>
    <h1>列車別ダイヤモニタ</h1>
  </header>
  <div class="container">
    <a href="../toppage.html" class="back-button">前のページに戻る</a>
    <a href="alltrain.html">登録列車一覧を見る</a>
    <div id="error-log"></div>

    <div class="selection">
      <div class="selection-header">表示内容選択</div>
      <div class="selection-group">
        <label for="line">線区:</label>
        <select id="line">
          <option value="">すべて</option>
        </select>
      </div>
      <div class="selection-group hidden" id="date-selector-container">
        <label for="select-date">施行日:</label>
        <select id="select-date"></select>
      </div>
      <div class="selection-group">
        <label for="train-type">列車種別:</label>
        <select id="train-type">
          <option value="">すべて</option>
        </select>
      </div>
      <div class="selection-group">
        <label for="train-number">列車番号:</label>
        <input type="text" id="train-number" placeholder="例: 123M">
      </div>
      <button class="display-button" id="display-button">表示</button>
    </div>

    <div id="train-info" style="margin-top: 10px; display: none;">
      <p>■<span id="info-line"></span>　施行日: <span id="info-date"></span></p>
      <p>運転区間: <span id="operation-section"></span>　列車番号：<span id="train-id"></span></p>
      <table style="max-width: 500px;">
        <tbody>
          <tr><td>平日/土休日</td><td id="info-daytype"></td></tr>
          <tr><td>速度種別</td><td id="info-speed"></td></tr>
          <tr><td>列車名</td><td id="info-name"></td></tr>
        </tbody>
      </table>
    </div>

    <table style="width: 100%;">
      <thead>
        <tr>
          <th style="width: 50px;">列車種別</th>
          <th style="width: 100px;">駅名</th>
          <th style="width: 100px;">着時刻</th>
          <th style="width: 100px;">発時刻</th>
          <th style="width: 50px;">番線</th>
        </tr>
      </thead>
      <tbody id="timetable"></tbody>
    </table>
  </div>

  <script>
    let timetableData = [];
    let currentMatches = [];

    async function loadTimetableData() {
      try {
        const res = await fetch("timetables.json");
        timetableData = await res.json();

        const lines = [...new Set(timetableData.map(t => t.line))];
        const lineSelect = document.getElementById("line");
        lines.forEach(l => {
          const opt = document.createElement("option");
          opt.value = l;
          opt.textContent = l;
          lineSelect.appendChild(opt);
        });

        const types = [...new Set(timetableData.map(t => t.type))].sort();
        const typeSelect = document.getElementById("train-type");
        types.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          typeSelect.appendChild(opt);
        });
      } catch (e) {
        document.getElementById("error-log").textContent = "JSONの読み込みに失敗しました。";
        document.getElementById("error-log").style.display = "block";
      }
    }

    function displayTrain(train) {
      document.getElementById("train-info").style.display = "block";
      document.getElementById("info-line").textContent = train.line;
      document.getElementById("info-date").textContent = train.startDate;
      document.getElementById("train-id").textContent = train.trainNumber;
      document.getElementById("operation-section").textContent = train.origin + "〜" + train.destination;
      document.getElementById("info-daytype").textContent = train.dayType;
      document.getElementById("info-speed").textContent = train.speed;
      document.getElementById("info-name").textContent = train.name;

      const tbody = document.getElementById("timetable");
      tbody.innerHTML = "";
      train.stops.forEach((stop, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index === 0 ? train.type : ""}</td>
          <td>${stop.station}</td>
          <td>${stop.arrival || "…"}</td>
          <td>${stop.departure || "…"}</td>
          <td>${stop.trackN || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function searchTrain() {
      const line = document.getElementById("line").value;
      const type = document.getElementById("train-type").value;
      const numberInput = document.getElementById("train-number").value.trim().toUpperCase().replace(/[^\d]/g, '');

      if (!numberInput) {
        document.getElementById("error-log").textContent = "列車番号の数字部分を入力してください。";
        document.getElementById("error-log").style.display = "block";
        document.getElementById("train-info").style.display = "none";
        document.getElementById("timetable").innerHTML = "";
        document.getElementById("date-selector-container").classList.add("hidden");
        return;
      }

      currentMatches = timetableData.filter(t => {
        const trainNumberDigits = t.trainNumber.replace(/[^\d]/g, '');
        return (line === "" || t.line === line) &&
               (type === "" || t.type === type) &&
               trainNumberDigits === numberInput;
      });

      if (currentMatches.length === 0) {
        document.getElementById("error-log").textContent = "列車が見つかりませんでした。";
        document.getElementById("error-log").style.display = "block";
        document.getElementById("train-info").style.display = "none";
        document.getElementById("timetable").innerHTML = "";
        document.getElementById("date-selector-container").classList.add("hidden");
        return;
      }

      document.getElementById("error-log").style.display = "none";

      if (currentMatches.length === 1) {
        document.getElementById("date-selector-container").classList.add("hidden");
        displayTrain(currentMatches[0]);
      } else {
        const dateSelect = document.getElementById("select-date");
        const uniqueDates = [...new Set(currentMatches.map(d => d.startDate))];
        dateSelect.innerHTML = uniqueDates.map(d => `<option value="${d}">${d}</option>`).join("");
        document.getElementById("date-selector-container").classList.remove("hidden");
        displayTrain(currentMatches[0]);
      }
    }

    document.getElementById("display-button").addEventListener("click", searchTrain);
    document.getElementById("train-number").addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        searchTrain();
      }
    });
    document.getElementById("select-date").addEventListener("change", function () {
      const selected = currentMatches.find(m => m.startDate === this.value);
      if (selected) displayTrain(selected);
    });
    document.getElementById("train-type").addEventListener("change", searchTrain);

    loadTimetableData();

    const token = localStorage.getItem('authToken');
    const tokenExpiry = localStorage.getItem('tokenExpiry');

    if (!token || !tokenExpiry || Date.now() > tokenExpiry) {
        alert('セッションが切れました');
        window.location.href = '../index.html';
    }

    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('tokenExpiry');
        window.location.href = '../index.html';
    }

    const logoutButton = document.querySelector('.logout-button');
    if (logoutButton) {
        logoutButton.addEventListener('click', logout);
    }
  </script>
</body>
