<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8" />
Â  <title>åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</title>
Â  <style>
Â  Â  /* (CSSéƒ¨åˆ†ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) */
Â  Â  body {
Â  Â  Â  font-family: "MS PGothic", sans-serif;
Â  Â  Â  font-weight: bold;
Â  Â  Â  background-color: #ffffff;
Â  Â  Â  color: #000000;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  }

Â  Â  header {
Â  Â  Â  background-color: #01977a;
Â  Â  Â  color: white;
Â  Â  Â  padding: 10px;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .container {
Â  Â  Â  margin: 20px;
Â  Â  }

Â  Â  .selection-header {
Â  Â  Â  background-color: #01977a;
Â  Â  Â  color: white;
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  display: inline-block;
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  border-radius: 5px;
Â  Â  }

Â  Â  .selection {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 15px;
Â  Â  }

Â  Â  .selection label {
Â  Â  Â  margin-right: 8px;
Â  Â  }

Â  Â  .selection select,
Â  Â  .selection input {
Â  Â  Â  padding: 5px;
Â  Â  }

Â  Â  .selection-group {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  }

Â  Â  .hidden {
Â  Â  Â  display: none;
Â  Â  }

Â  Â  table {
Â  Â  Â  width: 80%;
Â  Â  Â  border-collapse: collapse;
Â  Â  Â  margin-top: 20px;
Â  Â  }

Â  Â  table, th, td {
Â  Â  Â  border: 1px solid #01977a;
Â  Â  }

Â  Â  th, td {
Â  Â  Â  padding: 6px;
Â  Â  Â  line-height: 1.2;
Â  Â  }
Â Â 
Â  Â  th {
Â  Â  Â  background-color: #01977a;
Â  Â  Â  color: white;
Â  Â  Â  padding: 10px;
Â  Â  Â  text-align: left;
Â  Â  }

Â  Â  td {
Â  Â  Â  padding: 10px;
Â  Â  Â  color: #000;
Â  Â  Â  background-color: #ffffff;
Â  Â  }

Â  Â  .back-button,
Â  Â  .display-button {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  display: inline-block;
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  background-color: #01977a;
Â  Â  Â  color: white;
Â  Â  Â  text-decoration: none;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  border: none;
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  .back-button:hover,
Â  Â  .display-button:hover {
Â  Â  Â  background-color: #017a63;
Â  Â  }

Â  Â  #error-log {
Â  Â  Â  background-color: #ffcccc;
Â  Â  Â  color: #990000;
Â  Â  Â  padding: 10px;
Â  Â  Â  margin: 10px 0;
Â  Â  Â  border: 1px solid #990000;
Â  Â  Â  display: none;
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <h1>åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</h1>
Â  </header>
Â  <div class="container">
Â  Â  <a href="../toppage.html" class="back-button">å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
Â  Â  <a href="alltrain.html">ç™»éŒ²åˆ—è»Šä¸€è¦§ã‚’è¦‹ã‚‹</a>

Â  Â  <div id="error-log"></div>

Â  Â Â 
Â  Â  <div class="selection">
Â  Â  Â  <div class="selection-header">è¡¨ç¤ºå†…å®¹é¸æŠ</div>
Â  Â  Â  
      Â  Â  Â  <div class="selection-group">
Â  Â  Â  Â  <label for="company">äº‹æ¥­è€…:</label>
Â  Â  Â  Â  <select id="company">
Â  Â  Â  Â  Â  <option value="">ã™ã¹ã¦</option>
Â  Â  Â  Â  Â  <option value="JRåŒ—æµ·é“">JRåŒ—æµ·é“</option>
Â  Â  Â  Â  Â  <option value="JRæ±æ—¥æœ¬">JRæ±æ—¥æœ¬</option>
Â  Â  Â  Â  Â  <option value="JRæ±æµ·">JRæ±æµ·</option>
Â  Â  Â  Â  Â  <option value="JRè¥¿æ—¥æœ¬">JRè¥¿æ—¥æœ¬</option>
Â  Â  Â  Â  Â  <option value="JRä¹å·">JRä¹å·</option>
Â  Â  Â  Â  Â  <option value="æ±æ—¥æœ¬ç§é‰„">æ±æ—¥æœ¬ç§é‰„</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

      Â  Â  Â  <div class="selection-group">
Â  Â  Â  Â  <label for="line">ç·šåŒº:</label>
Â  Â  Â  Â  <select id="line" disabled>
Â  Â  Â  Â  Â  <option value="">ã™ã¹ã¦</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="selection-group hidden" id="date-selector-container">
Â  Â  Â  Â  <label for="select-date">æ–½è¡Œæ—¥:</label>
Â  Â  Â  Â  <select id="select-date"></select>
Â  Â  Â  </div>
Â  Â  Â  <div class="selection-group">
Â  Â  Â  Â  <label for="train-number">åˆ—è»Šç•ªå·:</label>
Â  Â  Â  Â  <select id="crown">
Â  Â  Â  Â  Â  <option value="">ã™ã¹ã¦</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <input type="text" id="train-number" pattern="^[0-9].*" placeholder="ä¾‹: 123M">
Â  Â  Â  </div>
Â  Â  Â  <button class="display-button" id="display-button">è¡¨ç¤º</button>
Â  Â  </div>

Â  Â Â 
Â  Â  <div id="train-info" style="margin-top: 10px; display: none;">
Â  Â  Â  <p>â– <span id="info-line"></span>ã€€æ–½è¡Œæ—¥: <span id="info-date"></span></p>
Â  Â  Â  <p>é‹è»¢åŒºé–“: <span id="operation-section"></span>ã€€åˆ—è»Šç•ªå·ï¼š<span id="train-id"></span></p>
Â  Â  Â  <table style="max-width: 500px;">
Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  <tr><td>å¹³æ—¥/åœŸä¼‘æ—¥</td><td id="info-daytype"></td></tr>
Â  Â  Â  Â  Â  <tr><td>é€Ÿåº¦ç¨®åˆ¥</td><td id="info-speed"></td></tr>
Â  Â  Â  Â  Â  <tr><td>åˆ—è»Šå</td><td id="info-name"></td></tr>
Â  Â  Â  Â  </tbody>
Â  Â  Â  </table>
Â  Â  </div>

Â  Â  <table style="width: 100%;">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th style="width: 50px;">åˆ—è»Šç¨®åˆ¥</th>
Â  Â  Â  Â  Â  <th style="width: 100px;">é§…å</th>
Â  Â  Â  Â  Â  <th style="width: 100px;">ç€æ™‚åˆ»</th>
Â  Â  Â  Â  Â  <th style="width: 100px;">ç™ºæ™‚åˆ»</th>
Â  Â  Â  Â  Â  <th style="width: 50px;">ç•ªç·š</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="timetable"></tbody>
Â  Â  </table>
Â  </div>

Â  <script>
Â  Â  let timetableData = [];
Â  Â  let currentMatches = [];

Â  Â  // DOMè¦ç´ ã®å–å¾—
    const companySelect = document.getElementById("company"); 
Â  Â  const lineSelect = document.getElementById("line");
Â  Â  const crownSelect = document.getElementById("crown");
Â  Â  const trainNumberInput = document.getElementById("train-number");
Â  Â  const displayButton = document.getElementById("display-button");
Â  Â  const errorLog = document.getElementById("error-log");
Â  Â  const dateSelectorContainer = document.getElementById("date-selector-container");
Â  Â  const selectDate = document.getElementById("select-date");

    // =========================================================================
    // ğŸš¨ ä¿®æ­£ãŒå¿…è¦ãªã®ã¯ã“ã®éƒ¨åˆ†ã§ã™ ğŸš¨
    // é¸æŠè‚¢ã«å‡ºã—ãŸã„ç·šåŒºã‚’ã€äº‹æ¥­è€…ã«åˆã‚ã›ã¦æ‰‹å‹•ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
    // é…åˆ—å†…ã®ç·šåŒºåã¯ã€timetables.jsonã®t.lineã®å€¤ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã¦ãã ã•ã„ã€‚
    const manuallyDefinedLines = {
        "JRåŒ—æµ·é“": ["å‡½é¤¨æœ¬ç·š", "å®¤è˜­æœ¬ç·š", "åƒæ­³ç·š", "æœ­æ²¼ç·š"],
        "JRæ±æ—¥æœ¬": ["ä¸­å¤®ç·š", "æ±åŒ—æœ¬ç·š", "æ±æµ·é“ç·š", "å±±æ‰‹ç·š", "äº¬æµœæ±åŒ—ç·š", "å¸¸ç£ç·š"],
        "JRæ±æµ·": ["æ±æµ·é“ç·š", "ä¸­å¤®æœ¬ç·š", "é–¢è¥¿æœ¬ç·š", "å¾¡æ®¿å ´ç·š"],
        "JRè¥¿æ—¥æœ¬": ["æ±æµ·é“ãƒ»å±±é™½ç·š", "åŒ—é™¸æœ¬ç·š", "é–¢è¥¿æœ¬ç·š", "ãŠãŠã•ã‹æ±ç·š"],
        "JRä¹å·": ["é¹¿å…å³¶æœ¬ç·š", "æ—¥è±Šæœ¬ç·š", "é•·å´æœ¬ç·š"],
        "æ±æ—¥æœ¬ç§é‰„": ["æ±æ­¦ä¼Šå‹¢å´ç·š", "äº¬ç‹ç·š", "å°ç”°æ€¥ç·š", "æ±æ€¥æ±æ¨ªç·š"],
        "ãã®ä»–": ["ãã®ä»–ã®ç·šåŒºA", "ãã®ä»–ã®ç·šåŒºB"]
    };
    // =========================================================================

    /**
     * ç·šåŒºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
     * @param {string} selectedCompany - é¸æŠã•ã‚ŒãŸäº‹æ¥­è€…å (ä¾‹: "JRæ±æ—¥æœ¬")
     */
    function updateLineOptions(selectedCompany) {
        lineSelect.innerHTML = `<option value="">ã™ã¹ã¦</option>`;
        lineSelect.disabled = true; 
        
        if (selectedCompany === "") {
            return;
        }

        // æ‰‹å‹•ã§å®šç¾©ã—ãŸãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰ç·šåŒºãƒªã‚¹ãƒˆã‚’å–å¾—
        const lines = manuallyDefinedLines[selectedCompany] ? manuallyDefinedLines[selectedCompany].sort() : [];

        if (lines.length > 0) {
            lines.forEach(l => {
                const opt = document.createElement("option");
                // valueã¯JSONãƒ‡ãƒ¼ã‚¿å†…ã®t.lineã¨ä¸€è‡´ã•ã›ã‚‹
                opt.value = l; 
                opt.textContent = l;
                lineSelect.appendChild(opt);
            });
            lineSelect.disabled = false;
        }
    }


Â  Â  async function loadTimetableData() {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch("timetables.json");
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  throw new Error(`JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status} ${res.statusText})`);
Â  Â  Â  Â  }
Â  Â  Â  Â  timetableData = await res.json();
Â  Â  Â  Â  if (!Array.isArray(timetableData) || timetableData.length === 0) {
Â  Â  Â  Â  Â  throw new Error("timetables.jsonã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã‹ã€å½¢å¼ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚");
Â  Â  Â  Â  }

        // å† ï¼ˆcrownï¼‰ã®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
Â  Â  Â  Â  const crowns = [...new Set(timetableData.map(t => t.crown).filter(c => c))].sort();
Â  Â  Â  Â  crownSelect.innerHTML = `<option value="">ã™ã¹ã¦</option>`;
Â  Â  Â  Â  crowns.forEach(c => {
Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  opt.value = c;
Â  Â  Â  Â  Â  opt.textContent = c;
Â  Â  Â  Â  Â  crownSelect.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  errorLog.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
Â  Â  Â  Â  errorLog.style.display = "block";
Â  Â  Â  Â  displayButton.disabled = true;
Â  Â  Â  Â  trainNumberInput.disabled = true;
Â  Â  Â  Â  lineSelect.disabled = true;
        companySelect.disabled = true; 
Â  Â  Â  Â  crownSelect.disabled = true;
Â  Â  Â  }
Â  Â  }

Â  Â  function displayTrain(train) {
Â  Â  Â  document.getElementById("train-info").style.display = "block";
Â  Â  Â  document.getElementById("info-line").textContent = train.line;
Â  Â  Â  document.getElementById("info-date").textContent = train.startDate;
Â  Â  Â  document.getElementById("train-id").textContent = train.trainNumber;
Â  Â  Â  document.getElementById("operation-section").textContent = train.origin + "ã€œ" + train.destination;
Â  Â  Â  document.getElementById("info-daytype").textContent = train.dayType;
Â  Â  Â  document.getElementById("info-speed").textContent = train.speed;
Â  Â  Â  document.getElementById("info-name").textContent = train.name;

Â  Â  Â  const tbody = document.getElementById("timetable");
Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  train.stops.forEach((stop, index) => {
Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td>${index === 0 ? train.type : ""}</td>
Â  Â  Â  Â  Â  <td>${stop.station}</td>
Â  Â  Â  Â  Â  <td>${stop.arrival || "â€¦"}</td>
Â  Â  Â  Â  Â  <td>${stop.departure || "â€¦"}</td>
Â  Â  Â  Â  Â  <td>${stop.trackN || ""}</td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  async function searchTrain() {
Â  Â  Â  // äº‹æ¥­è€…ï¼ˆcompanyï¼‰ã®å€¤ã¯æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ã¨ã—ã¦ä½¿ç”¨ã›ãšã€é¸æŠã•ã‚ŒãŸç·šåŒºï¼ˆlineï¼‰ã®å€¤ã®ã¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
Â  Â  Â  const line = lineSelect.value;
Â  Â  Â  const number = trainNumberInput.value.trim();
Â  Â  Â  const crown = crownSelect.value;
Â  Â  Â  
Â  Â  Â  errorLog.style.display = "none";
Â  Â  Â  document.getElementById("train-info").style.display = "none";
Â  Â  Â  document.getElementById("timetable").innerHTML = "";
Â  Â  Â  dateSelectorContainer.classList.add("hidden");

Â  Â  Â  if (number !== "" && !trainNumberInput.checkValidity()) {
Â  Â  Â  Â  errorLog.textContent = "åˆ—è»Šç•ªå·ã¯æ•°å­—ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚";
Â  Â  Â  Â  errorLog.style.display = "block";
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  if (number === "" && line === "" && crown === "") {
Â  Â  Â  Â  errorLog.textContent = "æ¤œç´¢æ¡ä»¶ã‚’ä¸€ã¤ä»¥ä¸ŠæŒ‡å®šã—ã¦ãã ã•ã„ã€‚";
Â  Â  Â  Â  errorLog.style.display = "block";
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  currentMatches = timetableData.filter(t => {
Â  Â  Â  Â  // 1. ç·šåŒºã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: é¸æŠã•ã‚ŒãŸç·šåŒºã¨ãƒ‡ãƒ¼ã‚¿ä¸Šã®ç·šåŒºãŒä¸€è‡´ã™ã‚‹ã‹
Â  Â  Â  Â  const lineMatch = (line === "" || t.line === line);

        // 2. åˆ—è»Šç•ªå·ã¨ç¨®åˆ¥å† ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
Â  Â  Â  Â  let numberAndCrownMatch = false;

Â  Â  Â  Â  if (crown !== "") {
Â  Â  Â  Â  Â  const trainNumberBase = t.trainNumber.replace(new RegExp(`${t.crown}$`), ''); 
Â  Â  Â  Â  Â  if (t.crown === crown) {
Â  Â  Â  Â  Â  Â  if (number === "") {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true; 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = trainNumberBase === number;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (number === "") {
Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true; 
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (t.trainNumber === number) {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true;
Â  Â  Â  Â  Â  Â  } else if (t.trainNumber.replace(new RegExp(`${t.crown}$`), '') === number) {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true;
Â  Â  Â  Â  Â  Â  } else if (t.trainNumber.replace(/^[^0-9]+/, '') === number) {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  return lineMatch && numberAndCrownMatch;
Â  Â  Â  });

Â  Â  Â  if (currentMatches.length === 0) {
Â  Â  Â  Â  errorLog.textContent = "åˆ—è»ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
Â  Â  Â  Â  errorLog.style.display = "block";
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // (æ—¥ä»˜é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥)
Â  Â  Â  if (currentMatches.length === 1) {
Â  Â  Â  Â  displayTrain(currentMatches[0]);
Â  Â  Â  } else {
Â  Â  Â  Â  const uniqueDates = [...new Set(currentMatches.map(d => d.startDate))];
Â  Â  Â  Â  selectDate.innerHTML = uniqueDates.map(d => `<option value="${d}">${d}</option>`).join("");
Â  Â  Â  Â  dateSelectorContainer.classList.remove("hidden");
Â  Â  Â  Â  const selected = currentMatches.find(m => m.startDate === selectDate.value);
Â  Â  Â  Â  if (selected) displayTrain(selected);
Â  Â  Â  }
Â  Â  };

Â  Â  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ  ---
Â  Â  
    // ã€äº‹æ¥­è€…å¤‰æ›´æ™‚ã®å‡¦ç†ã€‘ç·šåŒºãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹
    companySelect.addEventListener("change", function() {
        const selectedCompany = this.value;
        updateLineOptions(selectedCompany);
        lineSelect.value = ""; // ç·šåŒºã‚’ãƒªã‚»ãƒƒãƒˆ
    });

Â  Â  displayButton.addEventListener("click", searchTrain);

Â  Â  trainNumberInput.addEventListener("keypress", function (event) {
Â  Â  Â  if (event.key === "Enter") {
Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  searchTrain();
Â  Â  Â  }
Â  Â  });
Â  Â  Â Â 
Â  Â  selectDate.addEventListener("change", function () {
Â  Â  Â  const selected = currentMatches.find(m => m.startDate === this.value);
Â  Â  Â  if (selected) displayTrain(selected);
Â  Â  });
Â  Â  
Â  Â  crownSelect.addEventListener("change", function () {
Â  Â  Â  if (this.value !== "") {
Â  Â  Â  Â  trainNumberInput.disabled = true;
Â  Â  Â  Â  trainNumberInput.value = ""; 
Â  Â  Â  } else {
Â  Â  Â  Â  trainNumberInput.disabled = false;
Â  Â  Â  }
Â  Â  });

Â  Â  trainNumberInput.addEventListener("input", function() {
Â  Â  Â  if (this.value.trim() !== "") {
Â  Â  Â  Â  crownSelect.disabled = true;
Â  Â  Â  Â  crownSelect.value = ""; 
Â  Â  Â  } else {
Â  Â  Â  Â  crownSelect.disabled = false;
Â  Â  Â  }
Â  Â  });

    // åˆæœŸãƒ­ãƒ¼ãƒ‰
Â  Â  loadTimetableData();
Â  Â Â 
Â  </script>
</body>
</html>
