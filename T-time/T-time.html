<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8" />
Â  <title>åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</title>
Â  <style>
    /* =========================================================================
     * CSS ã‚¹ã‚¿ã‚¤ãƒ«
     * ä»¥å‰ã®è¦‹ãŸç›®ã‚’å®Œå…¨ã«å†ç¾ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã§ã™ã€‚
     * ========================================================================= */
Â  Â  body {
Â  Â  Â  font-family: "MS PGothic", sans-serif;
Â  Â  Â  font-weight: bold;
Â  Â  Â  background-color: #ffffff;
Â  Â  Â  color: #000000;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  }

Â  Â  header {
Â  Â  Â  background-color: #01977a;
Â  Â  Â  color: white;
Â  Â  Â  padding: 10px;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .container {
Â  Â  Â  margin: 20px;
Â  Â  }

Â  Â  .selection-header {
Â  Â  Â  background-color: #01977a;
Â  Â  Â  color: white;
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  display: inline-block;
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  border-radius: 5px;
Â  Â  }

Â  Â  .selection {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 15px; /* è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
Â  Â  }

Â  Â  .selection label {
Â  Â  Â  margin-right: 8px;
Â  Â  }

Â  Â  .selection select,
Â  Â  .selection input[type="text"] { /* input[type="text"] ã‚’æ˜ç¤º */
Â  Â  Â  padding: 5px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 3px;
Â  Â  }

Â  Â  .selection-group {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  }

Â  Â  .hidden {
Â  Â  Â  display: none;
Â  Â  }

Â  Â  table {
Â  Â  Â  width: 100%; /* å¹…ã‚’100%ã«èª¿æ•´ */
Â  Â  Â  border-collapse: collapse;
Â  Â  Â  margin-top: 20px;
Â  Â  }

Â  Â  table, th, td {
Â  Â  Â  border: 1px solid #01977a;
Â  Â  }

Â  Â  th, td {
Â  Â  Â  padding: 6px;
Â  Â  Â  line-height: 1.2;
Â  Â  Â  text-align: left; /* th ã‚‚å·¦å¯„ã›ã«çµ±ä¸€ */
Â  Â  }
Â Â 
Â  Â  th {
Â  Â  Â  background-color: #01977a;
Â  Â  Â  color: white;
Â  Â  Â  padding: 10px;
Â  Â  }

Â  Â  td {
Â  Â  Â  padding: 10px;
Â  Â  Â  color: #000;
Â  Â  Â  background-color: #ffffff;
Â  Â  }

Â  Â  .back-button,
Â  Â  .display-button {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  display: inline-block;
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  background-color: #01977a;
Â  Â  Â  color: white;
Â  Â  Â  text-decoration: none;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  border: none;
Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  .back-button:hover,
Â  Â  .display-button:hover {
Â  Â  Â  background-color: #017a63;
Â  Â  }

Â  Â  #error-log {
Â  Â  Â  background-color: #ffcccc;
Â  Â  Â  color: #990000;
Â  Â  Â  padding: 10px;
Â  Â  Â  margin: 10px 0;
Â  Â  Â  border: 1px solid #990000;
Â  Â  Â  display: none;
Â  Â  Â  border-radius: 5px;
Â  Â  }

    /* train-info ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    #train-info {
        background-color: #e0f2f1; /* è–„ã„èƒŒæ™¯è‰² */
        border: 1px solid #01977a;
        border-radius: 5px;
        padding: 10px 15px;
        margin-bottom: 20px;
    }
    #train-info p {
        margin: 5px 0;
        line-height: 1.5;
    }
    #train-info table {
        width: auto; /* infoå†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å¹…è‡ªå‹• */
        border: none;
        margin-top: 5px;
    }
    #train-info table tr td {
        border: none;
        padding: 2px 5px;
        background-color: transparent;
    }
    #train-info table tr:nth-child(odd) {
        background-color: #f0fafa; /* ç¸æ¨¡æ§˜ */
    }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <h1>åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</h1>
Â  </header>
Â  <div class="container">
Â  Â  <a href="../toppage.html" class="back-button">å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
Â  Â  <a href="alltrain.html" class="display-button" style="margin-left: 10px;">ç™»éŒ²åˆ—è»Šä¸€è¦§ã‚’è¦‹ã‚‹</a>

Â  Â  <div id="error-log"></div>

Â  Â Â 
Â  Â  <div class="selection">
Â  Â  Â  <div class="selection-header">è¡¨ç¤ºå†…å®¹é¸æŠ</div>
Â  Â  Â  
      <div class="selection-group">
Â  Â  Â  Â  <label for="line">ç·šåŒº:</label>
Â  Â  Â  Â  <select id="line">
          Â  Â  Â  Â  Â  <option value="">ç·šåŒºã‚’é¸æŠ</option> 
          Â  Â  Â  Â  Â  <option value="select_JRåŒ—æµ·é“">â–¶ï¸ JRåŒ—æµ·é“</option>
Â  Â  Â  Â  Â  <option value="select_JRæ±æ—¥æœ¬">â–¶ï¸ JRæ±æ—¥æœ¬</option>
Â  Â  Â  Â  Â  <option value="select_JRæ±æµ·">â–¶ï¸ JRæ±æµ·</option>
Â  Â  Â  Â  Â  <option value="select_JRè¥¿æ—¥æœ¬">â–¶ï¸ JRè¥¿æ—¥æœ¬</option>
Â  Â  Â  Â  Â  <option value="select_JRä¹å·">â–¶ï¸ JRä¹å·</option>
Â  Â  Â  Â  Â  <option value="select_æ±æ—¥æœ¬ç§é‰„">â–¶ï¸ æ±æ—¥æœ¬ç§é‰„</option>
          <option value="select_ãã®ä»–">â–¶ï¸ ãã®ä»–</option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="selection-group hidden" id="date-selector-container">
Â  Â  Â  Â  <label for="select-date">æ–½è¡Œæ—¥:</label>
Â  Â  Â  Â  <select id="select-date"></select>
Â  Â  Â  </div>
Â  Â  Â  <div class="selection-group">
Â  Â  Â  Â  <label for="train-number">åˆ—è»Šç•ªå·:</label>
Â  Â  Â  Â  <select id="crown">
Â  Â  Â  Â  Â  <option value="">ã™ã¹ã¦</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <input type="text" id="train-number" pattern="^[0-9].*" placeholder="ä¾‹: 123M">
Â  Â  Â  </div>
Â  Â  Â  <button class="display-button" id="display-button">è¡¨ç¤º</button>
Â  Â  </div>

Â  Â Â 
Â  Â  <div id="train-info" style="margin-top: 10px; display: none;">
Â  Â  Â  <p>â– <span id="info-line"></span>ã€€æ–½è¡Œæ—¥: <span id="info-date"></span></p>
Â  Â  Â  <p>é‹è»¢åŒºé–“: <span id="operation-section"></span>ã€€åˆ—è»Šç•ªå·ï¼š<span id="train-id"></span></p>
Â  Â  Â  <table style="max-width: 500px;">
Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  <tr><td>å¹³æ—¥/åœŸä¼‘æ—¥</td><td id="info-daytype"></td></tr>
Â  Â  Â  Â  Â  <tr><td>é€Ÿåº¦ç¨®åˆ¥</td><td id="info-speed"></td></tr>
Â  Â  Â  Â  Â  <tr><td>åˆ—è»Šå</td><td id="info-name"></td></tr>
Â  Â  Â  Â  </tbody>
Â  Â  Â  </table>
Â  Â  </div>

Â  Â  <table style="width: 100%;">
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th style="width: 50px;">åˆ—è»Šç¨®åˆ¥</th>
Â  Â  Â  Â  Â  <th style="width: 100px;">é§…å</th>
Â  Â  Â  Â  Â  <th style="width: 100px;">ç€æ™‚åˆ»</th>
Â  Â  Â  Â  Â  <th style="width: 100px;">ç™ºæ™‚åˆ»</th>
Â  Â  Â  Â  Â  <th style="width: 50px;">ç•ªç·š</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody id="timetable"></tbody>
Â  Â  </table>
Â  </div>

Â  <script>
    // =========================================================================
    // JavaScript ã‚³ãƒ¼ãƒ‰
    // =========================================================================
Â  Â  let timetableData = [];
Â  Â  let currentMatches = [];

Â  Â  // DOMè¦ç´ ã®å–å¾—
Â  Â  const lineSelect = document.getElementById("line");
Â  Â  const crownSelect = document.getElementById("crown");
Â  Â  const trainNumberInput = document.getElementById("train-number");
Â  Â  const displayButton = document.getElementById("display-button");
Â  Â  const errorLog = document.getElementById("error-log");
Â  Â  const dateSelectorContainer = document.getElementById("date-selector-container");
Â  Â  const selectDate = document.getElementById("select-date");

    // =========================================================================
    // ğŸš¨ ã“ã“ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ ğŸš¨
    // é¸æŠè‚¢ã«å‡ºã—ãŸã„ç·šåŒºã‚’ã€äº‹æ¥­è€…ã«åˆã‚ã›ã¦æ‰‹å‹•ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
    // é…åˆ—å†…ã®ç·šåŒºå (valueã¨text) ã¯ã€timetables.jsonã®t.lineã®å€¤ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã¦ãã ã•ã„ã€‚
    const manuallyDefinedLines = {
        // åˆæœŸè¡¨ç¤ºæ™‚ï¼ˆäº‹æ¥­è€…ãƒªã‚¹ãƒˆï¼‰
        "initial": [
            { value: "select_JRåŒ—æµ·é“", text: "â–¶ï¸ JRåŒ—æµ·é“" },
            { value: "select_JRæ±æ—¥æœ¬", text: "â–¶ï¸ JRæ±æ—¥æœ¬" },
            { value: "select_JRæ±æµ·", text: "â–¶ï¸ JRæ±æµ·" },
            { value: "select_JRè¥¿æ—¥æœ¬", text: "â–¶ï¸ JRè¥¿æ—¥æœ¬" },
            { value: "select_JRä¹å·", text: "â–¶ï¸ JRä¹å·" },
            { value: "select_æ±æ—¥æœ¬ç§é‰„", text: "â–¶ï¸ æ±æ—¥æœ¬ç§é‰„" },
            { value: "select_ãã®ä»–", text: "â–¶ï¸ ãã®ä»–" }
        ],
        // å„äº‹æ¥­è€…ã®ç·šåŒºãƒªã‚¹ãƒˆ (æ‰‹å‹•ã§ç·¨é›†ã—ã¦ãã ã•ã„)
        "JRåŒ—æµ·é“": [
            { value: "back_to_company", text: "â—€ï¸ äº‹æ¥­è€…é¸æŠã«æˆ»ã‚‹" }, // æˆ»ã‚‹ãƒœã‚¿ãƒ³
            { value: "", text: "ã™ã¹ã¦" }, // ã“ã®äº‹æ¥­è€…å†…ã®ã™ã¹ã¦ã®ç·šåŒºã‚’å¯¾è±¡ã¨ã™ã‚‹é¸æŠè‚¢
            { value: "å‡½é¤¨æœ¬ç·š", text: "å‡½é¤¨æœ¬ç·š" }, 
            { value: "å®¤è˜­æœ¬ç·š", text: "å®¤è˜­æœ¬ç·š" }, 
            { value: "åƒæ­³ç·š", text: "åƒæ­³ç·š" },
            { value: "å®—è°·æœ¬ç·š", text: "å®—è°·æœ¬ç·š" }, // ä¾‹ã¨ã—ã¦è¿½åŠ 
            { value: "çŸ³å‹ç·š", text: "çŸ³å‹ç·š" } // ä¾‹ã¨ã—ã¦è¿½åŠ 
            // ... ä»–ã®JRåŒ—æµ·é“ã®ç·šåŒºã‚’è¿½åŠ 
        ],
        "JRæ±æ—¥æœ¬": [
            { value: "back_to_company", text: "â—€ï¸ äº‹æ¥­è€…é¸æŠã«æˆ»ã‚‹" }, 
            { value: "", text: "ã™ã¹ã¦" },
            { value: "ä¸­å¤®æœ¬ç·š", text: "ä¸­å¤®æœ¬ç·š" }, // JSONã®t.lineã¨ä¸€è‡´ã•ã›ã‚‹
            { value: "æ±åŒ—æœ¬ç·š", text: "æ±åŒ—æœ¬ç·š" }, 
            { value: "æ±æµ·é“æœ¬ç·š(æ±)", text: "æ±æµ·é“æœ¬ç·š(æ±)" }, // JSONã®t.lineã¨ä¸€è‡´ã•ã›ã‚‹
            { value: "å±±æ‰‹ç·š", text: "å±±æ‰‹ç·š" }, 
            { value: "äº¬æµœæ±åŒ—ç·š", text: "äº¬æµœæ±åŒ—ç·š" }, 
            { value: "å¸¸ç£ç·š", text: "å¸¸ç£ç·š" },
            { value: "é«˜å´ç·š", text: "é«˜å´ç·š" } // ä¾‹ã¨ã—ã¦è¿½åŠ 
            // ... ä»–ã®JRæ±æ—¥æœ¬ã®ç·šåŒºã‚’è¿½åŠ 
        ],
        "JRæ±æµ·": [
            { value: "back_to_company", text: "â—€ï¸ äº‹æ¥­è€…é¸æŠã«æˆ»ã‚‹" }, 
            { value: "", text: "ã™ã¹ã¦" },
            { value: "æ±æµ·é“æœ¬ç·š(æµ·)", text: "æ±æµ·é“æœ¬ç·š(æµ·)" }, 
            { value: "ä¸­å¤®æœ¬ç·š(æµ·)", text: "ä¸­å¤®æœ¬ç·š(æµ·)" }, 
            { value: "é–¢è¥¿æœ¬ç·š(æµ·)", text: "é–¢è¥¿æœ¬ç·š(æµ·)" }, 
            { value: "å¾¡æ®¿å ´ç·š", text: "å¾¡æ®¿å ´ç·š" },
            { value: "èº«å»¶ç·š", text: "èº«å»¶ç·š" } // ä¾‹ã¨ã—ã¦è¿½åŠ 
            // ... ä»–ã®JRæ±æµ·ã®ç·šåŒºã‚’è¿½åŠ 
        ],
        "JRè¥¿æ—¥æœ¬": [
            { value: "back_to_company", text: "â—€ï¸ äº‹æ¥­è€…é¸æŠã«æˆ»ã‚‹" }, 
            { value: "", text: "ã™ã¹ã¦" },
            { value: "æ±æµ·é“æœ¬ç·š(è¥¿)", text: "æ±æµ·é“æœ¬ç·š(è¥¿)" }, // ä¾‹: æ¹–è¥¿ç·šã‚’å«ã‚€å ´åˆãªã©
            { value: "å±±é™½æœ¬ç·š", text: "å±±é™½æœ¬ç·š" }, 
            { value: "åŒ—é™¸æœ¬ç·š", text: "åŒ—é™¸æœ¬ç·š" }, 
            { value: "é–¢è¥¿æœ¬ç·š(è¥¿)", text: "é–¢è¥¿æœ¬ç·š(è¥¿)" }, // ä¾‹: å¤§å’Œè·¯ç·š
            { value: "å¤§é˜ªç’°çŠ¶ç·š", text: "å¤§é˜ªç’°çŠ¶ç·š" } // ä¾‹ã¨ã—ã¦è¿½åŠ 
            // ... ä»–ã®JRè¥¿æ—¥æœ¬ã®ç·šåŒºã‚’è¿½åŠ 
        ],
        "JRä¹å·": [
            { value: "back_to_company", text: "â—€ï¸ äº‹æ¥­è€…é¸æŠã«æˆ»ã‚‹" }, 
            { value: "", text: "ã™ã¹ã¦" },
            { value: "é¹¿å…å³¶æœ¬ç·š", text: "é¹¿å…å³¶æœ¬ç·š" }, 
            { value: "æ—¥è±Šæœ¬ç·š", text: "æ—¥è±Šæœ¬ç·š" }, 
            { value: "é•·å´æœ¬ç·š", text: "é•·å´æœ¬ç·š" },
            { value: "ç­‘è±Šæœ¬ç·š", text: "ç­‘è±Šæœ¬ç·š" } // ä¾‹ã¨ã—ã¦è¿½åŠ 
            // ... ä»–ã®JRä¹å·ã®ç·šåŒºã‚’è¿½åŠ 
        ],
        "æ±æ—¥æœ¬ç§é‰„": [
            { value: "back_to_company", text: "â—€ï¸ äº‹æ¥­è€…é¸æŠã«æˆ»ã‚‹" }, 
            { value: "", text: "ã™ã¹ã¦" },
            { value: "æ±æ­¦ä¼Šå‹¢å´ç·š", text: "æ±æ­¦ä¼Šå‹¢å´ç·š" }, 
            { value: "äº¬ç‹ç·š", text: "äº¬ç‹ç·š" }, 
            { value: "å°ç”°æ€¥ç·š", text: "å°ç”°æ€¥ç·š" }, 
            { value: "æ±æ€¥æ±æ¨ªç·š", text: "æ±æ€¥æ±æ¨ªç·š" },
            { value: "è¥¿æ­¦æ± è¢‹ç·š", text: "è¥¿æ­¦æ± è¢‹ç·š" } // ä¾‹ã¨ã—ã¦è¿½åŠ 
            // ... ä»–ã®æ±æ—¥æœ¬ç§é‰„ã®ç·šåŒºã‚’è¿½åŠ 
        ],
        "ãã®ä»–": [
            { value: "back_to_company", text: "â—€ï¸ äº‹æ¥­è€…é¸æŠã«æˆ»ã‚‹" }, 
            { value: "", text: "ã™ã¹ã¦" },
            { value: "ãã®ä»–ã®ç·šåŒºA", text: "ãã®ä»–ã®ç·šåŒºA" }, 
            { value: "ãã®ä»–ã®ç·šåŒºB", text: "ãã®ä»–ã®ç·šåŒºB" }, 
            // ... ãã®ä»–ã®ç·šåŒºã‚’è¿½åŠ 
        ]
    };
    // =========================================================================
    
    // ç¾åœ¨ã®ç·šåŒºé¸æŠã®çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    // "initial": äº‹æ¥­è€…ãƒªã‚¹ãƒˆè¡¨ç¤ºä¸­
    // "JRæ±æ—¥æœ¬"ãªã©: ç‰¹å®šã®äº‹æ¥­è€…ã®ç·šåŒºãƒªã‚¹ãƒˆè¡¨ç¤ºä¸­
    let currentLineSelectionState = "initial"; 

    /**
     * ç·šåŒºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å†…å®¹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
     * @param {string} stateKey - è¡¨ç¤ºã™ã‚‹ãƒªã‚¹ãƒˆã®ã‚­ãƒ¼ ("initial" ã¾ãŸã¯äº‹æ¥­è€…å)
     * ä¾‹: "initial" (äº‹æ¥­è€…ãƒªã‚¹ãƒˆ), "JRæ±æ—¥æœ¬" (JRæ±æ—¥æœ¬ã®ç·šåŒºãƒªã‚¹ãƒˆ)
     */
    function updateLineOptions(stateKey) {
        // selectè¦ç´ ã‚’ã‚¯ãƒªã‚¢ã—ã€æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        lineSelect.innerHTML = ''; // ã¾ãšæ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã™ã¹ã¦å‰Šé™¤

        // æˆ»ã‚‹/äº‹æ¥­è€…é¸æŠãƒªã‚¹ãƒˆã®ç”Ÿæˆ
        const optionsToDisplay = manuallyDefinedLines[stateKey] || [];

        optionsToDisplay.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.value;
            opt.textContent = item.text;
            lineSelect.appendChild(opt);
        });
        
        currentLineSelectionState = stateKey; // ç¾åœ¨ã®çŠ¶æ…‹ã‚’æ›´æ–°
    }

Â  Â  async function loadTimetableData() {
Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch("timetables.json");
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  throw new Error(`JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${res.status} ${res.statusText})`);
Â  Â  Â  Â  }
Â  Â  Â  Â  timetableData = await res.json();
Â  Â  Â  Â  if (!Array.isArray(timetableData) || timetableData.length === 0) {
Â  Â  Â  Â  Â  throw new Error("timetables.jsonã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã‹ã€å½¢å¼ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚");
Â  Â  Â  Â  }

        // åˆæœŸè¡¨ç¤º: ç·šåŒºãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«äº‹æ¥­è€…ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
        updateLineOptions("initial"); 

        // å† ï¼ˆcrownï¼‰ã®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
Â  Â  Â  Â  const crowns = [...new Set(timetableData.map(t => t.crown).filter(c => c))].sort();
Â  Â  Â  Â  crownSelect.innerHTML = `<option value="">ã™ã¹ã¦</option>`;
Â  Â  Â  Â  crowns.forEach(c => {
Â  Â  Â  Â  Â  const opt = document.createElement("option");
Â  Â  Â  Â  Â  opt.value = c;
Â  Â  Â  Â  Â  opt.textContent = c;
Â  Â  Â  Â  Â  crownSelect.appendChild(opt);
Â  Â  Â  Â  });
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  errorLog.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
Â  Â  Â  Â  errorLog.style.display = "block";
Â  Â  Â  Â  displayButton.disabled = true;
Â  Â  Â  Â  trainNumberInput.disabled = true;
Â  Â  Â  Â  lineSelect.disabled = true;
Â  Â  Â  Â  crownSelect.disabled = true;
Â  Â  Â  }
Â  Â  }

Â  Â  function displayTrain(train) {
Â  Â  Â  document.getElementById("train-info").style.display = "block";
Â  Â  Â  document.getElementById("info-line").textContent = train.line;
Â  Â  Â  document.getElementById("info-date").textContent = train.startDate;
Â  Â  Â  document.getElementById("train-id").textContent = train.trainNumber;
Â  Â  Â  document.getElementById("operation-section").textContent = train.origin + "ã€œ" + train.destination;
Â  Â  Â  document.getElementById("info-daytype").textContent = train.dayType;
Â  Â  Â  document.getElementById("info-speed").textContent = train.speed;
Â  Â  Â  document.getElementById("info-name").textContent = train.name;

Â  Â  Â  const tbody = document.getElementById("timetable");
Â  Â  Â  tbody.innerHTML = "";
Â  Â  Â  train.stops.forEach((stop, index) => {
Â  Â  Â  Â  const tr = document.createElement("tr");
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td>${index === 0 ? train.type : ""}</td>
Â  Â  Â  Â  Â  <td>${stop.station}</td>
Â  Â  Â  Â  Â  <td>${stop.arrival || "â€¦"}</td>
Â  Â  Â  Â  Â  <td>${stop.departure || "â€¦"}</td>
Â  Â  Â  Â  Â  <td>${stop.trackN || ""}</td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  async function searchTrain() {
Â  Â  Â  // é¸æŠã•ã‚Œã¦ã„ã‚‹ã®ãŒå…·ä½“çš„ãªç·šåŒºåï¼ˆt.lineã¨ä¸€è‡´ã™ã‚‹å€¤ï¼‰ã§ã‚ã‚‹ã‹ç¢ºèª
Â  Â  Â  let line = lineSelect.value;
      
      // ã¾ã äº‹æ¥­è€…é¸æŠã®çŠ¶æ…‹ã§ã‚ã‚‹å ´åˆã€æ¤œç´¢ã¯è¡Œã‚ãªã„
      if (currentLineSelectionState === "initial" && line.startsWith("select_")) {
          errorLog.textContent = "å…·ä½“çš„ãªç·šåŒºã‚’é¸æŠã—ã¦ã‹ã‚‰ã€Œè¡¨ç¤ºã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
          errorLog.style.display = "block";
          return;
      }
      // ç·šåŒºãƒªã‚¹ãƒˆå†…ã§ã€Œã™ã¹ã¦ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã€ã¾ãŸã¯ã€Œäº‹æ¥­è€…é¸æŠã«æˆ»ã‚‹ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ¤œç´¢ã—ãªã„
      if (line === "back_to_company") {
          errorLog.textContent = "å…·ä½“çš„ãªç·šåŒºã‚’é¸æŠã™ã‚‹ã‹ã€ç·šåŒºæŒ‡å®šã‚’ç©ºæ¬„ã«ã—ã¦ãã ã•ã„ã€‚";
          errorLog.style.display = "block";
          return;
      }

Â  Â  Â  const number = trainNumberInput.value.trim();
Â  Â  Â  const crown = crownSelect.value;
Â  Â  Â  
Â  Â  Â  errorLog.style.display = "none";
Â  Â  Â  document.getElementById("train-info").style.display = "none";
Â  Â  Â  document.getElementById("timetable").innerHTML = "";
Â  Â  Â  dateSelectorContainer.classList.add("hidden");

Â  Â  Â  if (number !== "" && !trainNumberInput.checkValidity()) {
Â  Â  Â  Â  errorLog.textContent = "åˆ—è»Šç•ªå·ã¯æ•°å­—ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚";
Â  Â  Â  Â  errorLog.style.display = "block";
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  if (number === "" && line === "" && crown === "") {
Â  Â  Â  Â  errorLog.textContent = "æ¤œç´¢æ¡ä»¶ã‚’ä¸€ã¤ä»¥ä¸ŠæŒ‡å®šã—ã¦ãã ã•ã„ã€‚";
Â  Â  Â  Â  errorLog.style.display = "block";
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  currentMatches = timetableData.filter(t => {
Â  Â  Â  Â  // 1. ç·šåŒºã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: é¸æŠã•ã‚ŒãŸç·šåŒºã¨ãƒ‡ãƒ¼ã‚¿ä¸Šã®ç·šåŒºãŒä¸€è‡´ã™ã‚‹ã‹
Â  Â  Â  Â  const lineMatch = (line === "" || t.line === line);

        // 2. åˆ—è»Šç•ªå·ã¨ç¨®åˆ¥å† ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ãªã—)
Â  Â  Â  Â  let numberAndCrownMatch = false;
        
        if (crown !== "") {
Â  Â  Â  Â  Â  const trainNumberBase = t.trainNumber.replace(new RegExp(`${t.crown}$`), ''); 
Â  Â  Â  Â  Â  if (t.crown === crown) {
Â  Â  Â  Â  Â  Â  if (number === "") {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true; 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = trainNumberBase === number;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (number === "") {
Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true; 
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (t.trainNumber === number) {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true;
Â  Â  Â  Â  Â  Â  } else if (t.trainNumber.replace(new RegExp(`${t.crown}$`), '') === number) {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true;
Â  Â  Â  Â  Â  Â  } else if (t.trainNumber.replace(/^[^0-9]+/, '') === number) {
Â  Â  Â  Â  Â  Â  Â  numberAndCrownMatch = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  return lineMatch && numberAndCrownMatch;
Â  Â  Â  });

Â  Â  Â  if (currentMatches.length === 0) {
Â  Â  Â  Â  errorLog.textContent = "åˆ—è»ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
Â  Â  Â  Â  errorLog.style.display = "block";
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // (æ—¥ä»˜é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
Â  Â  Â  if (currentMatches.length === 1) {
Â  Â  Â  Â  displayTrain(currentMatches[0]);
Â  Â  Â  } else {
Â  Â  Â  Â  const uniqueDates = [...new Set(currentMatches.map(d => d.startDate))];
Â  Â  Â  Â  selectDate.innerHTML = uniqueDates.map(d => `<option value="${d}">${d}</option>`).join("");
Â  Â  Â  Â  dateSelectorContainer.classList.remove("hidden");
Â  Â  Â  Â  const selected = currentMatches.find(m => m.startDate === selectDate.value);
Â  Â  Â  Â  if (selected) displayTrain(selected);
Â  Â  Â  }
Â  Â  };

Â  Â  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ ï¼ˆç·šåŒºé¸æŠã®å‡¦ç†ã®ã¿å¤‰æ›´ï¼‰ ---
Â  Â  
    // ã€ç·šåŒºï¼ˆ#lineï¼‰å¤‰æ›´æ™‚ã®å‡¦ç†ã€‘: äº‹æ¥­è€…é¸æŠã‚’æ¤œçŸ¥ã—ã€ç·šåŒºãƒªã‚¹ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹
    lineSelect.addEventListener("change", function() {
        const selectedValue = this.value;
        
        // 1. äº‹æ¥­è€…é¸æŠé …ç›®ã ã£ãŸå ´åˆ (ä¾‹: "select_JRæ±æ—¥æœ¬")
        if (selectedValue.startsWith("select_")) {
            // "select_"ã‚’å‰Šé™¤ã—ã¦äº‹æ¥­è€…åã‚’å–å¾—ã—ã€ç·šåŒºãƒªã‚¹ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹
            const companyName = selectedValue.substring(7); // "select_" ã¯7æ–‡å­—
            updateLineOptions(companyName);
        
        // 2. æˆ»ã‚‹ãƒœã‚¿ãƒ³ã ã£ãŸå ´åˆ (ä¾‹: "back_to_company")
        } else if (selectedValue === "back_to_company") {
            // åˆæœŸçŠ¶æ…‹ï¼ˆäº‹æ¥­è€…ãƒªã‚¹ãƒˆï¼‰ã«æˆ»ã™
            updateLineOptions("initial");
        }
        
        // 3. å…·ä½“çš„ãªç·šåŒºåã‚„ã€Œã™ã¹ã¦ã€ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
        // ä½•ã‚‚ã›ãšã€æ¤œç´¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
    });

Â  Â  displayButton.addEventListener("click", searchTrain);

Â  Â  trainNumberInput.addEventListener("keypress", function (event) {
Â  Â  Â  if (event.key === "Enter") {
Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  searchTrain();
Â  Â  Â  }
Â  Â  });
Â  Â  Â Â 
Â  Â  selectDate.addEventListener("change", function () {
Â  Â  Â  const selected = currentMatches.find(m => m.startDate === this.value);
Â  Â  Â  if (selected) displayTrain(selected);
Â  Â  });
Â  Â  
Â  Â  crownSelect.addEventListener("change", function () {
Â  Â  Â  if (this.value !== "") {
Â  Â  Â  Â  trainNumberInput.disabled = true;
Â  Â  Â  Â  trainNumberInput.value = ""; 
Â  Â  Â  } else {
Â  Â  Â  Â  trainNumberInput.disabled = false;
Â  Â  Â  }
Â  Â  });

Â  Â  trainNumberInput.addEventListener("input", function() {
Â  Â  Â  if (this.value.trim() !== "") {
Â  Â  Â  Â  crownSelect.disabled = true;
Â  Â  Â  Â  crownSelect.value = ""; 
Â  Â  Â  } else {
Â  Â  Â  Â  crownSelect.disabled = false;
Â  Â  Â  }
Â  Â  });

    // åˆæœŸãƒ­ãƒ¼ãƒ‰
Â  Â  loadTimetableData();
Â  Â Â 
Â  </script>
</body>
</html>
