<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App</title>
    <style>
        :root {
            --atos-font: "MS PGothic", "ＭＳ Ｐゴシック", sans-serif;
            --atos-table-header: #1A968A; 
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;

            /* 横幅固定設定 */
            --w-line-side: 70px;
            --w-train-no: 95px;   
            --w-type: 110px;      
            --w-power: 55px;      
            --w-time-plan: 90px;  
            --w-time-act: 45px;   
            --w-track: 65px;      
            --w-op-info: 60px;    
            --w-op-no: 95px;      
            --w-dest: 115px;      

            --atos-row-height: 28px;
        }

        body {
            font-family: var(--atos-font);
            background-color: var(--bg-white);
            margin: 0; padding: 0;
            font-weight: bold; color: var(--text-black);
            -webkit-text-size-adjust: 100%;
        }
        
        #appContainer { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 5px; }
        
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #999; height: 32px;
        }
        .header-title { font-size: 16px; flex-grow: 1; text-align: center; color: #444; }
        .clock-area { font-size: 15px; min-width: 220px; text-align: right; }

        .filter-bar {
            background-color: #e0e0e0; padding: 8px; display: flex; align-items: center;
            gap: 12px; border-bottom: 1px solid #999;
        }
        
        .selection-summary {
            background-color: #f9f9f9; padding: 5px 10px; font-size: 16px;
            border-bottom: 1px solid #ccc; color: #333;
        }

        select, input {
            border: 1px solid #999; padding: 2px 4px; font-size: 15px;
            height: 26px; border-radius: 2px; font-weight: bold; font-family: var(--atos-font);
        }

        .monitor-table-container { width: 100%; overflow-x: auto; margin-top: 5px; position: relative; }
        table { border-collapse: collapse; table-layout: fixed; width: auto; min-width: 100%; }
        th {
            background-color: var(--atos-table-header); color: white; border: 1px solid var(--border-white);
            padding: 0 2px; font-size: 15px; height: var(--atos-row-height); white-space: nowrap;
        }
        td { border: 1px solid var(--border-white); background-color: var(--row-gray); height: var(--atos-row-height); text-align: center; font-size: 16px; font-family: var(--atos-font); font-weight: bold; }

        .td-line-side { background-color: #f0f0f0; border-right: 2px solid #888; vertical-align: middle; }
        .row-boundary td { border-top: 3px solid #333; }

        .col-type, .col-dst { text-align: left; padding-left: 6px; }
        .col-time, .col-trk { text-align: right; padding-right: 6px; }
        .link-text { color: blue; text-decoration: underline; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="header-title">Mobile ATOS App Ver2.4.4</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">
        <div class="filter-bar">
            <div>施行日：<input type="date" id="dateInput"></div>
            <div>線区：<select id="lineSelect"><option value="">(選択)</option></select></div>
            <div>駅名：<select id="stationSelect"><option value="">(選択)</option></select></div>
        </div>

        <div class="selection-summary">
            線区：【<span id="summaryLine"></span>】駅名：【<span id="summaryStation"></span>】
        </div>

        <div class="monitor-table-container">
            <div id="loadingMsg" class="hidden" style="text-align: center; padding: 20px;">データを読み込んでいます...</div>
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width:70px;" rowspan="2">線別</th>
                        <th style="width:95px;" rowspan="2">列車番号</th>
                        <th style="width:110px;" rowspan="2">列車種別</th>
                        <th style="width:55px;" rowspan="2">動力</th>
                        <th colspan="2">着時刻</th><th colspan="2">発時刻</th>
                        <th style="width:65px;" rowspan="2">番線</th><th style="width:60px;" rowspan="2">運用<br>情報</th>
                        <th style="width:95px;" rowspan="2">運用列番</th><th style="width:115px;" rowspan="2">行先</th>
                    </tr>
                    <tr>
                        <th style="width:90px;">計画</th><th style="width:45px;">到着</th><th style="width:90px;">計画</th><th style="width:45px;">発車</th>
                    </tr>
                </thead>
                <tbody id="timetableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let rawTimetableData = [];

        async function loadData() {
            const loadingMsg = document.getElementById('loadingMsg');
            loadingMsg.classList.remove('hidden');
            try {
                const response = await fetch('timetables.json');
                rawTimetableData = await response.json();
                populateLines();
            } catch (e) { console.error(e); } finally { loadingMsg.classList.add('hidden'); }
        }

        /**
         * 時刻文字列を解析。
         * 空白・… 等は同一視してソート順を最後(999999)にする。
         * 有効な時刻のみ hh:mm:ss 形式に整形して表示。
         */
        function parseTime(timeStr) {
            // 空白、null、undefined、または「…」「=」等の記号を「データなし」と判定
            if (!timeStr || timeStr.trim() === "" || timeStr === "…" || timeStr === "=") {
                return { seconds: 999999, display: timeStr || "" };
            }

            const parts = timeStr.split(':');
            let h = parseInt(parts[0], 10);
            let m = parseInt(parts[1], 10);
            let s = parseInt(parts[2], 10) || 0;

            // 数字として妥当でない場合もデータなし扱い
            if (isNaN(h) || isNaN(m)) {
                return { seconds: 999999, display: timeStr };
            }

            const totalSeconds = (h * 3600) + (m * 60) + s;
            const displayStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            
            return { seconds: totalSeconds, display: displayStr };
        }

        function populateLines() {
            const lines = [...new Set(rawTimetableData.map(d => d.line))].sort();
            const lineSelect = document.getElementById('lineSelect');
            lineSelect.innerHTML = '<option value="">(選択)</option>' + lines.map(l => `<option value="${l}">${l}</option>`).join('');
            
            lineSelect.onchange = () => {
                const stations = new Set();
                rawTimetableData.filter(d => d.line === lineSelect.value).forEach(d => d.stops.forEach(s => stations.add(s.station)));
                document.getElementById('stationSelect').innerHTML = '<option value="">(選択)</option>' + [...stations].sort().map(s => `<option value="${s}">${s}</option>`).join('');
                updateSummary();
                render();
            };
        }

        function getNsLabel(train) {
            const dict = {"A":"上り","B":"下り","N":"北行","S":"南行","U":"内回り","O":"外回り"};
            if (train.ns && dict[train.ns]) return dict[train.ns];
            const numMatch = train.trainNumber.match(/\d+/);
            if (numMatch) return (parseInt(numMatch[0], 10) % 2 === 0) ? "上り" : "下り";
            return "その他";
        }

        function getPowerLabel(train) {
            if (train.power) return train.power;
            const tNo = train.trainNumber;
            if (tNo.includes('D')) return "DC";
            if (tNo.match(/[A-Z]/)) return "EC";
            return ""; 
        }

        function updateSummary() {
            document.getElementById('summaryLine').innerText = document.getElementById('lineSelect').value || "";
            document.getElementById('summaryStation').innerText = document.getElementById('stationSelect').value || "";
        }

        function render() {
            const dateVal = document.getElementById('dateInput').value;
            const line = document.getElementById('lineSelect').value;
            const station = document.getElementById('stationSelect').value;
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';
            updateSummary();

            if (!line || !station) return;

            const targetDateStr = dateVal.replace(/-/g, '/');
            const dObj = new Date(targetDateStr);
            const isWeekend = (dObj.getDay() === 0 || dObj.getDay() === 6); 
            const targetDayType = isWeekend ? "土休日" : "平日";

            let candidates = rawTimetableData.filter(train => {
                const hasStation = train.stops.some(s => s.station === station);
                if (!hasStation || train.line !== line) return false;
                if (train.startDate === targetDateStr) return true;
                const isAfterRevision = new Date(train.startDate) <= dObj;
                return isAfterRevision && (train.dayType === targetDayType || !train.dayType || train.dayType === "");
            });

            const trainMap = new Map();
            candidates.forEach(train => {
                const existing = trainMap.get(train.trainNumber);
                if (!existing || train.startDate === targetDateStr) trainMap.set(train.trainNumber, train);
            });

            const finalData = Array.from(trainMap.values());
            if (finalData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12">該当するデータがありません。</td></tr>';
                return;
            }

            updateClock(targetDateStr);

            const grouped = {};
            finalData.forEach(t => {
                const label = getNsLabel(t);
                if (!grouped[label]) grouped[label] = [];
                grouped[label].push(t);
            });

            const sortOrder = ["上り", "下り", "北行", "南行", "内回り", "外回り", "その他"];
            const sortedLabels = Object.keys(grouped).sort((a, b) => sortOrder.indexOf(a) - sortOrder.indexOf(b));

            sortedLabels.forEach((label, groupIdx) => {
                // グループ内ソート
                grouped[label].sort((a, b) => {
                    const sa = a.stops.find(s => s.station === station);
                    const sb = b.stops.find(s => s.station === station);
                    
                    const timeA = parseTime(sa.arrival || sa.departure);
                    const timeB = parseTime(sb.arrival || sb.departure);
                    
                    return timeA.seconds - timeB.seconds;
                });

                grouped[label].forEach((train, rowIdx) => {
                    const s = train.stops.find(st => st.station === station);
                    const stopIdx = train.stops.findIndex(st => st.station === station);
                    const isFirst = (stopIdx === 0);
                    const isLast = (stopIdx === train.stops.length - 1);
                    
                    const arrivalInfo = parseTime(s.arrival);
                    const departureInfo = parseTime(s.departure);

                    const tr = document.createElement('tr');
                    if (rowIdx === 0 && groupIdx > 0) tr.classList.add('row-boundary');

                    if (rowIdx === 0) {
                        const tdLine = document.createElement('td');
                        tdLine.className = 'td-line-side';
                        tdLine.rowSpan = grouped[label].length;
                        tdLine.innerText = label;
                        tr.appendChild(tdLine);
                    }

                    let opText = ""; let opNo = "";
                    if (isFirst) {
                        opText = train.tt1 === 'k' ? '継送' : (train.tt1 === 'o' ? '折返' : '');
                        opNo = train.tr1 || "";
                    } else if (isLast) {
                        opText = train.tt2 === 'k' ? '継送' : (train.tt2 === 'o' ? '折返' : '');
                        opNo = train.tr2 || "";
                    }

                    tr.innerHTML += `
                        <td class="link-text">${train.trainNumber}</td>
                        <td class="col-type">${train.type}</td>
                        <td>${getPowerLabel(train)}</td>
                        <td class="col-time">${arrivalInfo.display}</td>
                        <td class="col-act"></td>
                        <td class="col-time">${departureInfo.display}</td>
                        <td class="col-act"></td>
                        <td class="col-trk">${s.trackN}</td>
                        <td>${opText}</td>
                        <td class="link-text">${opNo}</td>
                        <td class="col-dst">${train.destination}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function updateClock(dateStr) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() - 2); d.setHours(22, 45, Math.floor(Math.random()*60));
            const fmt = (n) => String(n).padStart(2, '0');
            document.getElementById('clockDisplay').innerText = `${d.getFullYear()}/${fmt(d.getMonth()+1)}/${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} 現在`;
        }

        document.getElementById('dateInput').onchange = render;
        document.getElementById('stationSelect').onchange = render;
        window.onload = () => {
            const today = new Date();
            document.getElementById('dateInput').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            loadData();
        };
    </script>
</body>
</html>
