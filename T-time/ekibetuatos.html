<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App</title>
    <style>
        :root {
            --atos-font: "MS PGothic", "ＭＳ Ｐゴシック", sans-serif;
            --atos-table-header: #1A968A; 
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;

            /* 横幅固定設定 */
            --w-line-side: 75px;
            --w-train-no: 95px;   
            --w-type: 110px;      
            --w-power: 55px;
            --w-station: 130px;   
            --w-time-plan: 85px;  
            --w-time-act: 45px;   
            --w-track: 65px;      
            --w-op-info: 60px;    
            --w-op-no: 95px;      
            --w-dest: 110px;      

            --atos-row-height: 28px;
        }

        body {
            font-family: var(--atos-font);
            background-color: var(--bg-white);
            margin: 0; padding: 0;
            font-weight: bold; color: var(--text-black);
        }
        
        #appContainer { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 5px; }
        
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #999; height: 32px;
        }
        .header-title { font-size: 16px; flex-grow: 1; text-align: center; color: #444; }
        .clock-area { font-size: 15px; min-width: 220px; text-align: right; }

        .filter-bar {
            background-color: #e0e0e0; padding: 8px; display: flex; align-items: center;
            gap: 12px; border-bottom: 1px solid #999;
        }
        select, input {
            border: 1px solid #999; padding: 2px 4px; font-size: 15px;
            height: 26px; border-radius: 2px; font-weight: bold; font-family: var(--atos-font);
        }

        .monitor-table-container { width: 100%; overflow-x: auto; margin-top: 5px; position: relative; }
        table { border-collapse: collapse; table-layout: fixed; width: auto; min-width: 100%; }
        th {
            background-color: var(--atos-table-header); color: white; border: 1px solid var(--border-white);
            padding: 0 2px; font-size: 15px; height: var(--atos-row-height); white-space: nowrap;
        }
        td { border: 1px solid var(--border-white); background-color: var(--row-gray); height: var(--atos-row-height); text-align: center; font-size: 16px; }

        .w-line-side { width: var(--w-line-side); }
        .w-tno { width: var(--w-train-no); }
        .w-type { width: var(--w-type); }
        .w-pwr { width: var(--w-power); }
        .w-st { width: var(--w-station); }
        .w-time { width: var(--w-time-plan); }
        .w-act { width: var(--w-time-act); }
        .w-trk { width: var(--w-track); }
        .w-opi { width: var(--w-op-info); }
        .w-opn { width: var(--w-op-no); }
        .w-dst { width: var(--w-dest); }

        .col-type, .col-st, .col-dst { text-align: left; padding-left: 6px; }
        .col-time, .col-trk { text-align: right; padding-right: 6px; }
        .link-text { color: blue; text-decoration: underline; cursor: pointer; }
        
        #loadingMsg { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; 
            z-index: 10; font-size: 18px;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="header-title">Mobile ATOS App Ver2.3.0</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">
        <div class="filter-bar">
            <div>施行日：<input type="date" id="dateInput"></div>
            <div>線区：<select id="lineSelect"><option value="">(選択)</option></select></div>
            <div>駅名：<select id="stationSelect"><option value="">(選択)</option></select></div>
        </div>

        <div class="monitor-table-container">
            <div id="loadingMsg" class="hidden">データを読み込んでいます...</div>
            <table>
                <thead>
                    <tr>
                        <th class="w-line-side" rowspan="2">線別</th>
                        <th class="w-tno" rowspan="2">列車番号</th>
                        <th class="w-type" rowspan="2">列車種別</th>
                        <th class="w-pwr" rowspan="2">動力</th>
                        <th class="w-st" rowspan="2">駅名</th>
                        <th colspan="2">着時刻</th>
                        <th colspan="2">発時刻</th>
                        <th class="w-trk" rowspan="2">番線</th>
                        <th class="w-opi" rowspan="2">運用<br>情報</th>
                        <th class="w-opn" rowspan="2">運用列番</th>
                        <th class="w-dst" rowspan="2">行先</th>
                    </tr>
                    <tr>
                        <th class="w-time">計画</th>
                        <th class="w-act">到着</th>
                        <th class="w-time">計画</th>
                        <th class="w-act">発車</th>
                    </tr>
                </thead>
                <tbody id="timetableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let rawTimetableData = [];

        async function loadData() {
            const loadingMsg = document.getElementById('loadingMsg');
            loadingMsg.classList.remove('hidden');
            try {
                const response = await fetch('timetables.json');
                rawTimetableData = await response.json();
                populateLines();
            } catch (e) {
                console.error("JSON fetch error:", e);
            } finally {
                loadingMsg.classList.add('hidden');
            }
        }

        function populateLines() {
            const lines = [...new Set(rawTimetableData.map(d => d.line))].sort();
            const lineSelect = document.getElementById('lineSelect');
            lineSelect.innerHTML = '<option value="">(選択)</option>' + lines.map(l => `<option value="${l}">${l}</option>`).join('');
            
            lineSelect.onchange = () => {
                const stations = new Set();
                rawTimetableData.filter(d => d.line === lineSelect.value).forEach(d => d.stops.forEach(s => stations.add(s.station)));
                document.getElementById('stationSelect').innerHTML = '<option value="">(選択)</option>' + [...stations].sort().map(s => `<option value="${s}">${s}</option>`).join('');
                render();
            };
        }

        // 線別の自動判別ロジック
        function getNsLabel(train) {
            // 1. JSONに値がある場合はそれを使用
            const dict = {"A":"上り","B":"下り","N":"北行","S":"南行","U":"内回り","O":"外回り"};
            if (train.ns && dict[train.ns]) {
                return dict[train.ns];
            }

            // 2. 値がない場合、列車番号から推測 (末尾が偶数＝上り、奇数＝下り)
            // 数値部分のみを抽出
            const numMatch = train.trainNumber.match(/\d+/);
            if (numMatch) {
                const num = parseInt(numMatch[0], 10);
                return (num % 2 === 0) ? "上り" : "下り";
            }
            return "－";
        }

        function render() {
            const dateVal = document.getElementById('dateInput').value;
            const line = document.getElementById('lineSelect').value;
            const station = document.getElementById('stationSelect').value;
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';

            // 初期状態（選択されていない場合）はメッセージを表示
            if (!line || !station) {
                tbody.innerHTML = '<tr><td colspan="13">線区と駅名を選択してください。</td></tr>';
                return;
            }

            const targetDateStr = dateVal.replace(/-/g, '/');
            const dObj = new Date(targetDateStr);
            const isWeekend = (dObj.getDay() === 0 || dObj.getDay() === 6); 
            const targetDayType = isWeekend ? "土休日" : "平日";

            // 候補抽出
            let candidates = rawTimetableData.filter(train => {
                const hasStation = train.stops.some(s => s.station === station);
                if (!hasStation || train.line !== line) return false;
                if (train.startDate === targetDateStr) return true;
                const isAfterRevision = new Date(train.startDate) <= dObj;
                const isCorrectDayType = (train.dayType === targetDayType || train.dayType === "" || !train.dayType);
                return isAfterRevision && isCorrectDayType;
            });

            // 重複排除 (特定日優先)
            const trainMap = new Map();
            candidates.forEach(train => {
                const existing = trainMap.get(train.trainNumber);
                if (!existing || train.startDate === targetDateStr) {
                    trainMap.set(train.trainNumber, train);
                }
            });

            const finalData = Array.from(trainMap.values());
            
            if (finalData.length > 0) {
                updateClock(targetDateStr);

                // 【修正】着時刻を最優先、着時刻がない場合は発時刻でソート
                finalData.sort((a,b) => {
                    const sa = a.stops.find(s => s.station === station);
                    const sb = b.stops.find(s => s.station === station);
                    const timeA = sa.arrival || sa.departure;
                    const timeB = sb.arrival || sb.departure;
                    return timeA.localeCompare(timeB);
                });

                finalData.forEach(train => {
                    const s = train.stops.find(st => st.station === station);
                    const stopIdx = train.stops.findIndex(st => st.station === station);
                    const isFirst = (stopIdx === 0);
                    const isLast = (stopIdx === train.stops.length - 1);

                    const tr = document.createElement('tr');
                    
                    let opText = "";
                    let opNo = "";
                    if (isFirst) {
                        opText = train.tt1 === 'k' ? '継送' : (train.tt1 === 'o' ? '折返' : '');
                        opNo = train.tr1 || "";
                    } else if (isLast) {
                        opText = train.tt2 === 'k' ? '継送' : (train.tt2 === 'o' ? '折返' : '');
                        opNo = train.tr2 || "";
                    }

                    tr.innerHTML = `
                        <td>${getNsLabel(train)}</td>
                        <td class="link-text">${train.trainNumber}</td>
                        <td class="col-type">${train.type}</td>
                        <td>${train.power || ""}</td>
                        <td class="col-st">${s.station}</td>
                        <td class="col-time">${s.arrival || '…'}</td>
                        <td class="col-act"></td>
                        <td class="col-time">${s.departure==='='?'=':(s.departure||'…')}</td>
                        <td class="col-act"></td>
                        <td class="col-trk">${s.trackN}</td>
                        <td>${opText}</td>
                        <td class="link-text">${opNo}</td>
                        <td class="col-dst">${train.destination}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="13">該当するデータがありません。</td></tr>';
            }
        }

        function updateClock(dateStr) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() - 2);
            d.setHours(22, 45, Math.floor(Math.random()*60));
            const fmt = (n) => String(n).padStart(2, '0');
            document.getElementById('clockDisplay').innerText = `${d.getFullYear()}/${fmt(d.getMonth()+1)}/${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} 現在`;
        }

        document.getElementById('dateInput').onchange = render;
        document.getElementById('stationSelect').onchange = render;
        
        window.onload = () => {
            // 初期状態の設定
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateInput').value = `${y}-${m}-${d}`;
            
            // 線区・駅名はデフォルト「(選択)」の状態
            loadData();
        };
    </script>
</body>
</html>
