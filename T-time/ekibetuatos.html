<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App Ver2.5.0</title>
    <style>
        :root {
            --atos-table-header: #1A968A; 
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;
            --error-red: #ff0000;
            --time-status-width: 20px; 
            --time-plan-width: 90px;
            --atos-row-height: 26px;
        }

        body {
            font-family: "MS Gothic", "MS PGothic", sans-serif;
            background-color: var(--bg-white);
            margin: 0; padding: 0; font-size: 15px; color: var(--text-black);
            overflow-x: hidden; font-weight: bold;
        }
        
        #appContainer { max-width: 1000px; margin: 0 auto; padding: 0 5px; }
        
        /* --- Header & Filter (変更なし) --- */
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #999; height: 30px;
        }
        .header-title { font-size: 16px; flex-grow: 1; text-align: center; }
        .clock-area { font-size: 15px; min-width: 180px; text-align: right; }
        .filter-bar { background-color: #e0e0e0; padding: 8px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #999; }
        select, input { border: 1px solid #999; padding: 2px 4px; font-size: 15px; height: 24px; font-weight: bold; }

        /* --- Main Table --- */
        .monitor-table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { background-color: var(--atos-table-header); color: white; border: 1px solid var(--border-white); height: var(--atos-row-height); font-size: 14px; }
        td { border: 1px solid var(--border-white); background-color: var(--row-gray); height: var(--atos-row-height); text-align: center; font-size: 16px; }
        .col-align-left { text-align: left !important; padding-left: 8px !important; }
        .col-align-right { text-align: right !important; padding-right: 5px !important; }
        .link-text { color: #0000EE; text-decoration: underline; cursor: pointer; }

        /* ==================================================
           【新規】オーバーレイ（時刻表）スタイル
           ================================================== */
        #modalOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--bg-white); width: 95%; max-width: 850px; max-height: 90vh;
            border: 3px solid #333; overflow-y: auto; position: relative;
        }
        .modal-header {
            background: #444; color: white; padding: 10px; font-size: 16px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-btn { cursor: pointer; font-size: 24px; padding: 0 10px; }
        .modal-body { padding: 10px; }
        .modal-train-info { background: #eee; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; font-size: 15px; }
        
        /* オーバーレイ内のテーブル幅調整 */
        .modal-table th:nth-child(1) { width: 150px; } /* 駅名 */
        .modal-table th:nth-child(2), .modal-table th:nth-child(4) { width: 100px; } /* 時間 */
        .modal-table th:nth-child(3), .modal-table th:nth-child(5) { width: 30px; } /* 実績 */
        .modal-table th:nth-child(6) { width: 60px; } /* 番線 */

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="header-title">モバイル ATOS アプリ Ver2.5.0</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">
        <div class="filter-bar">
            <span>線区：<select id="lineSelect" onchange="performSearch()"></select></span>
            <span>施行日：<input type="date" id="dateInput" onchange="performSearch()"></span>
            <span>列番：<input type="text" id="trainNoInput" style="width:70px; background:#fff9c4;" oninput="performSearch()"></span>
        </div>

        <div id="messageArea" class="error-msg hidden"></div>
        <div id="contentArea" class="hidden">
            <div class="train-summary" id="trainSummary" style="background:#eee; padding:8px; border-bottom:1px solid #ccc;"></div>
            <div class="monitor-table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2" style="width:80px;">列車種別</th><th rowspan="2" style="width:40px;">抑止</th><th rowspan="2">駅名</th>
                            <th colspan="2">着時刻</th><th colspan="2">発時刻</th><th rowspan="2" style="width:60px;">番線</th>
                            <th rowspan="2" style="width:50px;">運用</th><th rowspan="2" style="width:80px;">運用列番</th>
                        </tr>
                        <tr>
                            <th style="width:90px;">時間</th><th style="width:20px;">着</th><th style="width:90px;">時間</th><th style="width:20px;">発</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalOverlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span>列車別ダイヤモニタ (全停車駅)</span>
                <span class="close-btn" onclick="closeModal()">×</span>
            </div>
            <div class="modal-body">
                <div class="modal-train-info" id="modalTrainSummary"></div>
                <div class="monitor-table-container">
                    <table class="modal-table">
                        <thead>
                            <tr>
                                <th rowspan="2">駅名</th><th colspan="2">着時刻</th><th colspan="2">発時刻</th><th rowspan="2">番線</th>
                            </tr>
                            <tr>
                                <th>計画</th><th>到着</th><th>計画</th><th>発車</th>
                            </tr>
                        </thead>
                        <tbody id="modalTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawJsonData = [];
        const PERIOD_START = new Date('2025/03/15');
        const PERIOD_END = new Date('2026/03/13');

        async function loadData() {
            try {
                const res = await fetch('timetables.json');
                rawJsonData = await res.json();
                populateLines();
                performSearch();
            } catch (e) { console.error("Data load error", e); }
        }

        function performSearch() {
            const line = document.getElementById('lineSelect').value;
            const dateUI = document.getElementById('dateInput').value;
            const trainNo = document.getElementById('trainNoInput').value.toUpperCase();
            if (!line || !dateUI || !trainNo) return;

            const searchDate = new Date(dateUI);
            const dateJSON = dateUI.replace(/-/g, '/');
            
            // 1. 施行日完全一致 (特定日) を検索
            let result = rawJsonData.find(d => d.line === line && d.trainNumber === trainNo && d.startDate === dateJSON);
            
            // 2. なければ所定ダイヤを検索
            if (!result && searchDate >= PERIOD_START && searchDate <= PERIOD_END) {
                const dayType = (searchDate.getDay() === 0 || searchDate.getDay() === 6) ? "土休日" : "平日";
                result = rawJsonData.find(d => d.line === line && d.trainNumber === trainNo && (d.dayType === "" || d.dayType === dayType));
            }

            const content = document.getElementById('contentArea');
            const msg = document.getElementById('messageArea');
            if (result) {
                content.classList.remove('hidden'); msg.classList.add('hidden');
                document.getElementById('trainSummary').innerHTML = `■${line} 施行日:${dateJSON}<br>運転区間:${result.origin}～${result.destination} 列車番号: <span class="link-text" onclick="showFullTimetable()">${result.trainNumber}</span>`;
                renderTable(result);
                window.currentTrainData = result; // オーバーレイ用に保持
            } else {
                content.classList.add('hidden'); msg.classList.remove('hidden');
                msg.innerText = "該当するダイヤが見つかりません。";
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            data.stops.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-align-left">${i === 0 ? data.type : ''}</td><td></td>
                    <td class="col-align-left">${s.station}</td>
                    <td class="col-align-right">${s.arrival || '…'}</td><td></td>
                    <td class="col-align-right">${s.departure || '…'}</td><td></td>
                    <td class="col-align-right">${s.trackN || ''}</td>
                    <td>${(i === 0 && data.tt1 === 'k') ? '継送' : (i === data.stops.length-1 && data.tt2 === 'k' ? '継送' : '')}</td>
                    <td class="link-text">${(i === 0) ? (data.tr1 || '') : (i === data.stops.length-1 ? (data.tr2 || '') : '')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- オーバーレイ表示機能 ---
        function showFullTimetable() {
            const data = window.currentTrainData;
            if (!data) return;
            document.getElementById('modalTrainSummary').innerText = `■${data.line} ${data.trainNumber} (${data.type}) 運転区間:${data.origin}～${data.destination}`;
            const tbody = document.getElementById('modalTableBody');
            tbody.innerHTML = '';
            data.stops.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-align-left">${s.station}</td>
                    <td class="col-align-right">${s.arrival || '…'}</td><td></td>
                    <td class="col-align-right">${s.departure || '…'}</td><td></td>
                    <td class="col-align-right">${s.trackN || ''}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

        function populateLines() {
            const lines = [...new Set(rawJsonData.map(d => d.line))];
            document.getElementById('lineSelect').innerHTML = lines.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        window.onload = () => {
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            loadData();
        };
    </script>
</body>
</html>
