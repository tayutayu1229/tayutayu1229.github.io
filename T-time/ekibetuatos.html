<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App</title>
    <style>
        /* ===========================================================
         【 数値調整エリア 】強制的に幅を固定する設定
         ===========================================================
        */
        :root {
            --atos-font: "MS PGothic", "ＭＳ Ｐゴシック", sans-serif;
            --atos-table-header: #1A968A; 
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;

            /* 横幅設定 (ここを書き換えると確実に反映されます) */
            --w-ns: 75px;         /* 区分 */
            --w-train-no: 95px;   /* 列車番号 */
            --w-type: 110px;      /* 列車種別 */
            --w-power: 50px;      /* 動力 */
            --w-station: 130px;   /* 駅名 */
            --w-time-plan: 85px;  /* 計画時刻 */
            --w-time-act: 45px;   /* 到着・発車の実績枠 */
            --w-track: 65px;      /* 番線 */
            --w-op-info: 60px;    /* 運用情報 */
            --w-op-no: 95px;      /* 運用列番 */
            --w-dest: 110px;      /* 行先 */

            --atos-row-height: 28px;
        }

        body {
            font-family: var(--atos-font);
            background-color: var(--bg-white);
            margin: 0;
            padding: 0;
            font-weight: bold;
            color: var(--text-black);
        }
        
        #appContainer {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto; 
            padding: 0 5px; 
        }
        
        /* --- Header --- */
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #999;
            height: 32px;
        }
        .header-title { font-size: 16px; flex-grow: 1; text-align: center; color: #444; }
        .clock-area { font-size: 15px; min-width: 220px; text-align: right; }

        /* --- Filter Bar --- */
        .filter-bar {
            background-color: #e0e0e0; padding: 8px; display: flex; align-items: center;
            gap: 12px; border-bottom: 1px solid #999;
        }
        select, input {
            border: 1px solid #999; padding: 2px 4px; font-size: 15px;
            height: 26px; border-radius: 2px; font-weight: bold; font-family: var(--atos-font);
        }

        /* --- Main Table --- */
        .monitor-table-container { 
            width: 100%; 
            overflow-x: auto; 
            margin-top: 5px; 
        }
        
        table {
            border-collapse: collapse;
            table-layout: fixed; 
            width: auto; 
            min-width: 100%;
        }

        th {
            background-color: var(--atos-table-header); 
            color: white;
            border: 1px solid var(--border-white); 
            padding: 0 2px;
            font-size: 15px;
            height: var(--atos-row-height);
            white-space: nowrap;
        }
        
        td {
            border: 1px solid var(--border-white); 
            background-color: var(--row-gray);
            height: var(--atos-row-height);
            text-align: center;
            white-space: nowrap; 
            overflow: hidden;
            font-size: 16px; 
        }

        /* 文字サイズ調整：到着・発車の「到着」「発車」の文字 */
        .col-act { font-size: 16px; }

        /* 幅のクラス設定 */
        .w-ns { width: var(--w-ns); }
        .w-tno { width: var(--w-train-no); }
        .w-type { width: var(--w-type); }
        .w-pwr { width: var(--w-power); }
        .w-st { width: var(--w-station); }
        .w-time { width: var(--w-time-plan); }
        .w-act { width: var(--w-time-act); }
        .w-trk { width: var(--w-track); }
        .w-opi { width: var(--w-op-info); }
        .w-opn { width: var(--w-op-no); }
        .w-dst { width: var(--w-dest); }

        .col-type, .col-st, .col-dst { text-align: left; padding-left: 6px; }
        .col-time, .col-trk { text-align: right; padding-right: 6px; }

        .link-text { color: blue; text-decoration: underline; cursor: pointer; }
        .footer-legend { padding: 10px; font-size: 15px; }
        .loading-overlay { padding: 20px; font-size: 18px; text-align: center; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="header-title">Mobile ATOS App Ver2.3.0</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">
        <div class="filter-bar">
            <div>施行日：<input type="date" id="dateInput"></div>
            <div>線区：<select id="lineSelect"><option value="">読み込み中...</option></select></div>
            <div>駅名：<select id="stationSelect"><option value="">(選択)</option></select></div>
        </div>

        <div class="monitor-table-container">
            <div id="loadingMsg" class="loading-overlay hidden">データを読み込んでいます...</div>
            <table>
                <thead>
                    <tr>
                        <th class="w-ns" rowspan="2">区分</th>
                        <th class="w-tno" rowspan="2">列車番号</th>
                        <th class="w-type" rowspan="2">列車種別</th>
                        <th class="w-pwr" rowspan="2">動力</th>
                        <th class="w-st" rowspan="2">駅名</th>
                        <th colspan="2">着時刻</th>
                        <th colspan="2">発時刻</th>
                        <th class="w-trk" rowspan="2">番線</th>
                        <th class="w-opi" rowspan="2">運用<br>情報</th>
                        <th class="w-opn" rowspan="2">運用列番</th>
                        <th class="w-dst" rowspan="2">行先</th>
                    </tr>
                    <tr>
                        <th class="w-time">計画</th>
                        <th class="w-act">到着</th>
                        <th class="w-time">計画</th>
                        <th class="w-act">発車</th>
                    </tr>
                </thead>
                <tbody id="timetableBody">
                    <tr><td colspan="13">線区と駅名を選択してください。</td></tr>
                </tbody>
            </table>
        </div>

        <div class="footer-legend">
            「$」…運休　「*」…運済　「#」…変更　「¥」…運転禁止
        </div>
    </div>

    <script>
        let rawTimetableData = [];

        // 外部JSONの読み込み
        async function loadJsonData() {
            const loadingMsg = document.getElementById('loadingMsg');
            loadingMsg.classList.remove('hidden');
            try {
                const response = await fetch('timetables.json');
                if (!response.ok) throw new Error('JSONファイルの読み込みに失敗しました。');
                rawTimetableData = await response.json();
                console.log('Data loaded:', rawTimetableData.length, 'records');
                initLineSelect();
            } catch (error) {
                console.error(error);
                alert('エラー: timetables.json が見つからないか、形式が正しくありません。');
            } finally {
                loadingMsg.classList.add('hidden');
            }
        }

        const dateInput = document.getElementById('dateInput');
        const lineSelect = document.getElementById('lineSelect');
        const stationSelect = document.getElementById('stationSelect');
        const timetableBody = document.getElementById('timetableBody');

        window.onload = () => {
            // 初期日付（今日）
            const today = new Date();
            dateInput.value = today.toISOString().split('T')[0];
            
            // JSON読み込み開始
            loadJsonData();
        };

        function initLineSelect() {
            const lines = [...new Set(rawTimetableData.map(d => d.line))].sort();
            lineSelect.innerHTML = '<option value="">(選択)</option>' + lines.map(l => `<option value="${l}">${l}</option>`).join('');
            
            lineSelect.onchange = () => {
                const selectedLine = lineSelect.value;
                const stations = new Set();
                rawTimetableData.filter(d => d.line === selectedLine).forEach(d => {
                    d.stops.forEach(s => stations.add(s.station));
                });
                
                stationSelect.innerHTML = '<option value="">(選択)</option>' + [...stations].sort().map(s => `<option value="${s}">${s}</option>`).join('');
                render();
            };

            stationSelect.onchange = render;
            dateInput.onchange = render;
        }

        // 施行日の2日前の22時45分（ランダム秒）に設定
        function updateFixedClock(baseDateStr) {
            if (!baseDateStr) return;
            const d = new Date(baseDateStr);
            d.setDate(d.getDate() - 2); 
            d.setHours(22, 45);
            const randomSec = Math.floor(Math.random() * 60);
            d.setSeconds(randomSec);

            const fmt = (n) => String(n).padStart(2, '0');
            const str = `${d.getFullYear()}/${fmt(d.getMonth()+1)}/${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} 現在`;
            document.getElementById('clockDisplay').innerText = str;
        }

        function getNsLabel(ns) {
            const labels = {"A": "上り", "B": "下り", "N": "北行", "S": "南行", "S_OUT": "外回り", "U": "内回り"};
            // JSONのSを南行とするか外回りとするかは適宜調整してください
            if (ns === "S") return "南行"; 
            return labels[ns] || "－";
        }

        function getOpText(code) {
            return code === "k" ? "継送" : (code === "o" ? "折返" : "");
        }

        function render() {
            const line = lineSelect.value;
            const station = stationSelect.value;
            const selectedDate = dateInput.value;
            
            timetableBody.innerHTML = '';
            if (!line || !station) {
                timetableBody.innerHTML = '<tr><td colspan="13">線区と駅名を選択してください。</td></tr>';
                document.getElementById('clockDisplay').innerText = "----/--/-- --:--:-- 現在";
                return;
            }

            const filtered = rawTimetableData.filter(train => {
                return train.line === line && train.stops.some(s => s.station === station);
            });

            if (filtered.length > 0) {
                updateFixedClock(selectedDate);
            } else {
                timetableBody.innerHTML = '<tr><td colspan="13">該当するデータがありません。</td></tr>';
                return;
            }

            // 表示用データの構築とソート
            const rows = filtered.map(train => {
                const stopIdx = train.stops.findIndex(s => s.station === station);
                return { 
                    train, 
                    stop: train.stops[stopIdx], 
                    isFirst: stopIdx === 0, 
                    isLast: stopIdx === train.stops.length - 1 
                };
            });

            rows.sort((a, b) => (a.stop.departure || a.stop.arrival).localeCompare(b.stop.departure || b.stop.arrival));

            rows.forEach(r => {
                const tr = document.createElement('tr');
                const power = r.train.trainNumber.includes('M') ? 'EC' : 'EL';
                
                let opText = "";
                let opNo = "";
                if (r.isFirst) {
                    opText = getOpText(r.train.tt1);
                    opNo = r.train.tr1 || "";
                } else if (r.isLast) {
                    opText = getOpText(r.train.tt2);
                    opNo = r.train.tr2 || "";
                }

                tr.innerHTML = `
                    <td>${getNsLabel(r.train.ns)}</td>
                    <td class="link-text">${r.train.trainNumber}</td>
                    <td class="col-type">${r.train.type}</td>
                    <td>${power}</td>
                    <td class="col-st">${r.stop.station}</td>
                    <td class="col-time">${r.stop.arrival || '…'}</td>
                    <td class="col-act"></td>
                    <td class="col-time">${r.stop.departure === '=' ? '=' : (r.stop.departure || '…')}</td>
                    <td class="col-act"></td>
                    <td class="col-trk">${r.stop.trackN}</td>
                    <td>${opText}</td>
                    <td class="link-text">${opNo}</td>
                    <td class="col-dst">${r.train.destination}</td>
                `;
                timetableBody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
