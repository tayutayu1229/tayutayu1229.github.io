<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App</title>
    <style>
        :root {
            --atos-font: "MS PGothic", "ＭＳ Ｐゴシック", sans-serif;
            --atos-table-header: #1A968A; 
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;
            --atos-row-height: 28px;
        }

        body {
            font-family: var(--atos-font);
            background-color: var(--bg-white);
            margin: 0; padding: 0;
            font-weight: bold; color: var(--text-black);
        }
        
        /* 表の左右に余白を設定 */
        #appContainer { 
            width: calc(100% - 20px); 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 10px; /* 左右と上下に余白 */
        }
        
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #999; height: 32px;
        }
        .header-title { font-size: 16px; flex-grow: 1; text-align: center; color: #444; }
        .clock-area { font-size: 15px; min-width: 220px; text-align: right; }

        .filter-bar {
            background-color: #e0e0e0; padding: 12px; display: flex; align-items: center;
            gap: 12px; border-bottom: 1px solid #999; border-radius: 4px;
        }
        
        .monitor-table-container { width: 100%; overflow-x: auto; margin-top: 10px; }
        table { border-collapse: collapse; table-layout: fixed; width: auto; min-width: 100%; }
        
        th {
            background-color: var(--atos-table-header); color: white; border: 1px solid var(--border-white);
            padding: 0 2px; font-size: 15px; height: var(--atos-row-height); white-space: nowrap;
        }
        
        td { 
            border: 1px solid var(--border-white); 
            background-color: var(--row-gray); 
            height: var(--atos-row-height); 
            text-align: center; 
            font-size: 16px; 
            font-family: var(--atos-font); 
            font-weight: bold; 
        }

        /* 線別（上り下り）セルの背景色を他と同じに統一 */
        .td-line-side { 
            background-color: var(--row-gray); 
            border-right: 2px solid #888; 
            vertical-align: middle; 
        }

        .row-boundary td { border-top: 3px solid #333; }
        .col-time, .col-trk { text-align: right; padding-right: 6px; }
        .link-text { color: blue; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="header-title">Mobile ATOS App Ver2.5.1</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">
        <div class="filter-bar">
            <div>施行日：<input type="date" id="dateInput"></div>
            <div>線区：<select id="lineSelect"><option value="">(選択)</option></select></div>
            <div>駅名：<select id="stationSelect"><option value="">(選択)</option></select></div>
        </div>

        <div class="monitor-table-container">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width:70px;" rowspan="2">線別</th>
                        <th style="width:95px;" rowspan="2">列車番号</th>
                        <th style="width:110px;" rowspan="2">列車種別</th>
                        <th style="width:55px;" rowspan="2">動力</th>
                        <th colspan="2">着時刻</th><th colspan="2">発時刻</th>
                        <th style="width:65px;" rowspan="2">番線</th><th style="width:60px;" rowspan="2">運用<br>情報</th>
                        <th style="width:95px;" rowspan="2">運用列番</th><th style="width:115px;" rowspan="2">行先</th>
                    </tr>
                    <tr>
                        <th style="width:90px;">計画</th><th style="width:45px;">到着</th><th style="width:90px;">計画</th><th style="width:45px;">発車</th>
                    </tr>
                </thead>
                <tbody id="timetableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let rawTimetableData = [];

        async function loadData() {
            try {
                const response = await fetch('timetables.json');
                rawTimetableData = await response.json();
                populateLines();
            } catch (e) { console.error(e); }
        }

        function safeVal(val) {
            return (val === undefined || val === null) ? "" : String(val).trim();
        }

        /**
         * 動力の自動判定ロジック
         * 1. JSONに動力(power)がある場合はそれを優先
         * 2. 列車番号末尾が M, T, H 等の場合は EC/DC 判定
         */
        function autoDeterminePower(train) {
            if (train.power && train.power.trim() !== "") return train.power;
            
            const tNo = safeVal(train.trainNumber).toUpperCase();
            if (tNo.endsWith('M') || tNo.endsWith('T') || tNo.endsWith('H') || tNo.endsWith('S')) return "EC";
            if (tNo.endsWith('D')) return "DC";
            if (tNo.match(/[A-Z]$/)) return "EC"; // その他アルファベット末尾は基本EC
            return ""; 
        }

        function parseTimeValue(timeStr) {
            const s = safeVal(timeStr);
            if (s === "" || s === "…" || s === "=") return null;
            const parts = s.split(':');
            const h = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            const sec = parseInt(parts[2], 10) || 0;
            return isNaN(h) || isNaN(m) ? null : (h * 3600) + (m * 60) + sec;
        }

        function formatDisplayTime(timeStr) {
            const val = parseTimeValue(timeStr);
            if (val === null) return safeVal(timeStr) === "=" ? "=" : "…";
            const h = Math.floor(val / 3600);
            const m = Math.floor((val % 3600) / 60);
            const sec = val % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }

        function populateLines() {
            const lines = [...new Set(rawTimetableData.map(d => d.line))].sort();
            const lineSelect = document.getElementById('lineSelect');
            lineSelect.innerHTML = '<option value="">(選択)</option>' + lines.map(l => `<option value="${l}">${l}</option>`).join('');
            lineSelect.onchange = () => {
                const stations = new Set();
                rawTimetableData.filter(d => d.line === lineSelect.value).forEach(d => d.stops.forEach(s => stations.add(s.station)));
                document.getElementById('stationSelect').innerHTML = '<option value="">(選択)</option>' + [...stations].sort().map(s => `<option value="${s}">${s}</option>`).join('');
                render();
            };
        }

        function getDayType(dateObj) {
            const day = dateObj.getDay();
            return (day === 0 || day === 6) ? "土休日" : "平日";
        }

        function render() {
            const line = document.getElementById('lineSelect').value;
            const station = document.getElementById('stationSelect').value;
            const dateVal = document.getElementById('dateInput').value;
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';
            if (!line || !station || !dateVal) return;

            const targetDate = new Date(dateVal);
            const targetDateStr = dateVal.replace(/-/g, '/');
            const targetDayType = getDayType(targetDate);

            const candidates = rawTimetableData.filter(train => {
                return train.line === line && train.stops.some(s => s.station === station);
            });

            const trainMap = new Map();
            const uniqueTrainNumbers = [...new Set(candidates.map(t => t.trainNumber))];

            uniqueTrainNumbers.forEach(tNo => {
                const versions = candidates.filter(v => v.trainNumber === tNo);
                const specialDay = versions.find(v => v.startDate === targetDateStr);
                
                if (specialDay) {
                    trainMap.set(tNo, specialDay);
                } else {
                    const validVersions = versions.filter(v => {
                        const start = new Date(v.startDate);
                        return start <= targetDate && (v.dayType === targetDayType || v.dayType === "" || v.dayType === undefined);
                    });
                    if (validVersions.length > 0) {
                        validVersions.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                        trainMap.set(tNo, validVersions[0]);
                    }
                }
            });

            const finalData = Array.from(trainMap.values());

            const grouped = {};
            finalData.forEach(t => {
                const label = (safeVal(t.trainNumber).match(/\d+/) && parseInt(t.trainNumber.match(/\d+/)[0]) % 2 === 0) ? "上り" : "下り";
                if (!grouped[label]) grouped[label] = [];
                grouped[label].push(t);
            });

            Object.keys(grouped).sort().forEach((label, groupIdx) => {
                grouped[label].sort((a, b) => {
                    const sa = a.stops.find(s => s.station === station);
                    const sb = b.stops.find(s => s.station === station);
                    const valA = parseTimeValue(sa.arrival) || parseTimeValue(sa.departure) || 0;
                    const valB = parseTimeValue(sb.arrival) || parseTimeValue(sb.departure) || 0;
                    return valA - valB;
                });

                grouped[label].forEach((train, rowIdx) => {
                    const s = train.stops.find(st => st.station === station);
                    const stopIdx = train.stops.findIndex(st => st.station === station);
                    const isLast = (stopIdx === train.stops.length - 1);
                    const tr = document.createElement('tr');
                    if (rowIdx === 0 && groupIdx > 0) tr.classList.add('row-boundary');

                    if (rowIdx === 0) {
                        const tdLine = document.createElement('td');
                        tdLine.className = 'td-line-side';
                        tdLine.rowSpan = grouped[label].length;
                        tdLine.innerText = label;
                        tr.appendChild(tdLine);
                    }

                    tr.innerHTML += `
                        <td class="link-text">${safeVal(train.trainNumber)}</td>
                        <td style="text-align:left; padding-left:4px;">${safeVal(train.type)}</td>
                        <td>${autoDeterminePower(train)}</td>
                        <td class="col-time">${formatDisplayTime(s.arrival)}</td>
                        <td></td>
                        <td class="col-time">${formatDisplayTime(s.departure)}</td>
                        <td></td>
                        <td class="col-trk">${safeVal(s.trackN)}</td>
                        <td>${(stopIdx === 0 && train.tt1 === 'k') ? '継送' : (isLast && train.tt2 === 'k' ? '継送' : '')}</td>
                        <td class="link-text">${(stopIdx === 0) ? safeVal(train.tr1) : (isLast ? safeVal(train.tr2) : "")}</td>
                        <td style="text-align:left; padding-left:4px;">${safeVal(train.destination)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
            updateClock(targetDateStr);
        }

        function updateClock(dateStr) {
            const d = new Date();
            const fmt = (n) => String(n).padStart(2, '0');
            document.getElementById('clockDisplay').innerText = `${dateStr} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} 現在`;
        }

        document.getElementById('dateInput').onchange = render;
        document.getElementById('stationSelect').onchange = render;
        window.onload = () => {
            const today = new Date();
            document.getElementById('dateInput').value = today.toISOString().split('T')[0];
            loadData();
        };
    </script>
</body>
</html>
