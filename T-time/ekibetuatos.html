<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App</title>
    <style>
        :root {
            --atos-table-header: #1A968A; 
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;
            --time-status-width: 15px;
            --atos-row-height: 23px;
        }

        body {
            font-family: "MS Gothic", "MS PGothic", sans-serif;
            background-color: var(--bg-white);
            margin: 0; padding: 0;
            font-size: 15px; color: var(--text-black);
            font-weight: bold;
        }
        
        #appContainer { max-width: 1200px; margin: 0 auto; padding: 0 10px; }
        
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #999; height: 30px;
        }
        .header-title { font-size: 16px; flex-grow: 1; text-align: center; }
        .clock-area { font-size: 15px; min-width: 180px; text-align: right; }

        .filter-bar {
            background-color: #e0e0e0; padding: 8px; display: flex; align-items: center;
            gap: 15px; border-bottom: 1px solid #999; overflow-x: auto;
        }
        
        .filter-group { display: flex; align-items: center; gap: 5px; }
        select, input { border: 1px solid #999; padding: 2px 4px; font-size: 15px; height: 24px; font-weight: bold; }

        .train-summary {
            background-color: #eee; padding: 5px 10px; font-size: 15px;
            border-bottom: 1px solid #ccc; line-height: 1.5;
        }

        .monitor-table-container { width: 100%; overflow-x: auto; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        th {
            background-color: var(--atos-table-header); color: white; border: 1px solid var(--border-white);
            font-size: 15px; height: var(--atos-row-height); text-align: center;
        }
        
        /* 列幅設定（Ver2.3.0準拠） */
        th:nth-child(1) { width: 70px; } /* 種別 */
        th:nth-child(2) { width: 45px; } /* 動力 */
        th:nth-child(3) { width: 100px; } /* 駅名 */
        .col-time-main { width: 80px; }
        .col-time-sub { width: var(--time-status-width); }

        td {
            border: 1px solid var(--border-white); background-color: var(--row-gray);
            height: var(--atos-row-height); text-align: center; font-size: 16px;
        }
        
        .col-type, .col-station { text-align: left; padding-left: 10px; }
        .col-time { text-align: right; padding-right: 5px; }
        .link-text { color: #0000EE; text-decoration: underline; cursor: pointer; }
        .hidden { display: none !important; }
        .error-msg { color: #ff0000; padding: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="header-title">モバイル ATOS アプリ Ver2.5.6</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">
        <div class="filter-bar">
            <div class="filter-group">
                <span>線区：</span>
                <select id="lineSelect" onchange="performSearch()"><option value="">(選択)</option></select>
            </div>
            <div class="filter-group">
                <span>施行日：</span>
                <input type="date" id="dateInput" onchange="performSearch()">
            </div>
            <div class="filter-group">
                <span>列番：</span>
                <input type="text" id="trainNoInput" style="width:80px;" oninput="performSearch()">
            </div>
        </div>

        <div id="messageArea" class="hidden error-msg"></div>

        <div id="contentArea" class="hidden">
            <div class="train-summary" id="trainSummary"></div>
            <div class="monitor-table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">列車種別</th>
                            <th rowspan="2">動力</th>
                            <th rowspan="2">駅名</th>
                            <th colspan="2">着時刻</th>
                            <th colspan="2">発時刻</th>
                            <th rowspan="2" style="width:50px;">番線</th>
                            <th rowspan="2" style="width:40px;">情報</th>
                            <th rowspan="2" style="width:80px;">運用列番</th>
                        </tr>
                        <tr>
                            <th class="col-time-main">時間</th><th class="col-time-sub"></th>
                            <th class="col-time-main">時間</th><th class="col-time-sub"></th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rawTimetableData = [];

        async function loadData() {
            try {
                const response = await fetch('timetables.json');
                rawTimetableData = await response.json();
                populateLines();
            } catch (e) { console.error(e); }
        }

        function safeVal(val) {
            const s = (val === undefined || val === null) ? "" : String(val).trim();
            return (s === "" || s === " " || s === "　" || s === "…") ? "…" : s;
        }

        function autoDeterminePower(train) {
            if (train.power && train.power.trim() !== "" && train.power !== "…") return train.power;
            const tNo = String(train.trainNumber).toUpperCase();
            return tNo.match(/[A-Z]$/) ? "EC" : "EL";
        }

        function populateLines() {
            const lines = [...new Set(rawTimetableData.map(d => d.line))].sort();
            const select = document.getElementById('lineSelect');
            lines.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l; opt.text = l; select.appendChild(opt);
            });
        }

        function performSearch() {
            const line = document.getElementById('lineSelect').value;
            const dateVal = document.getElementById('dateInput').value;
            const tNoInput = document.getElementById('trainNoInput').value.trim().toUpperCase();
            
            const messageArea = document.getElementById('messageArea');
            const contentArea = document.getElementById('contentArea');

            if (!line || !dateVal || !tNoInput) {
                contentArea.classList.add('hidden');
                return;
            }

            const targetDateStr = dateVal.replace(/-/g, '/');
            const targetDayType = (new Date(dateVal).getDay() === 0 || new Date(dateVal).getDay() === 6) ? "土休日" : "平日";

            // 1. 特定日検索
            let match = rawTimetableData.find(v => v.line === line && v.trainNumber.toUpperCase() === tNoInput && v.startDate === targetDateStr);

            // 2. 所定ダイヤ検索
            if (!match) {
                const versions = rawTimetableData.filter(v => v.line === line && v.trainNumber.toUpperCase() === tNoInput);
                const regular = versions.filter(v => {
                    const isPast = new Date(v.startDate) <= new Date(dateVal);
                    const isDayMatch = (v.dayType === targetDayType || v.dayType === "" || !v.dayType);
                    const isNotSpecific = (v.dayType === "" || v.dayType === "平日" || v.dayType === "土休日" || !v.dayType);
                    return isPast && isDayMatch && isNotSpecific;
                });
                if (regular.length > 0) {
                    regular.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                    match = regular[0];
                }
            }

            if (match) {
                messageArea.classList.add('hidden');
                contentArea.classList.remove('hidden');
                renderTable(match, targetDateStr);
            } else {
                contentArea.classList.add('hidden');
                messageArea.innerText = "該当するダイヤは見つかりませんでした。";
                messageArea.classList.remove('hidden');
            }
        }

        function renderTable(data, dateStr) {
            document.getElementById('trainSummary').innerHTML = `■${data.line} 施行日:${dateStr}<br>運転区間:${data.origin}～${data.destination} 列車番号:${data.trainNumber}`;
            
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            data.stops.forEach((stop, index) => {
                const tr = document.createElement('tr');
                const isFirst = index === 0;
                const isLast = index === data.stops.length - 1;

                let opInfo = "";
                let opNumHTML = "";
                if (isFirst && data.tr1) {
                    opInfo = data.tt1 === "k" ? "継送" : (data.tt1 === "o" ? "折返" : "");
                    opNumHTML = `<span class="link-text" onclick="jumpTo('${data.tr1}')">${data.tr1}</span>`;
                } else if (isLast && data.tr2) {
                    opInfo = data.tt2 === "k" ? "継送" : (data.tt2 === "o" ? "折返" : "");
                    opNumHTML = `<span class="link-text" onclick="jumpTo('${data.tr2}')">${data.tr2}</span>`;
                }

                tr.innerHTML = `
                    <td class="col-type">${isFirst ? data.type : ""}</td>
                    <td>${isFirst ? autoDeterminePower(data) : ""}</td>
                    <td class="col-station">${stop.station}</td>
                    <td class="col-time">${safeVal(stop.arrival)}</td><td></td>
                    <td class="col-time">${safeVal(stop.departure)}</td><td></td>
                    <td>${safeVal(stop.trackN)}</td>
                    <td>${opInfo}</td>
                    <td>${opNumHTML}</td>
                `;
                tbody.appendChild(tr);
            });
            updateClock(dateStr);
        }

        function jumpTo(tNo) {
            document.getElementById('trainNoInput').value = tNo;
            performSearch();
        }

        function updateClock(dateStr) {
            const d = new Date();
            const fmt = (n) => String(n).padStart(2, '0');
            document.getElementById('clockDisplay').innerText = `${dateStr} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} 現在`;
        }

        window.onload = () => {
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            loadData();
        };
    </script>
</body>
</html>
