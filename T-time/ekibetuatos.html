<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App</title>
    <style>
        :root {
            --atos-font: "MS PGothic", "ＭＳ Ｐゴシック", sans-serif;
            --atos-table-header: #1A968A; 
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;
            --atos-row-height: 28px;
        }

        body {
            font-family: var(--atos-font);
            background-color: var(--bg-white);
            margin: 0; padding: 0;
            font-weight: bold; color: var(--text-black);
            -webkit-text-size-adjust: 100%;
        }
        
        #appContainer { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 5px; }
        
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #999; height: 32px;
        }
        .header-title { font-size: 16px; flex-grow: 1; text-align: center; color: #444; }
        .clock-area { font-size: 15px; min-width: 220px; text-align: right; }

        .filter-bar {
            background-color: #e0e0e0; padding: 8px; display: flex; align-items: center;
            gap: 12px; border-bottom: 1px solid #999;
        }
        
        .monitor-table-container { width: 100%; overflow-x: auto; margin-top: 5px; }
        table { border-collapse: collapse; table-layout: fixed; width: auto; min-width: 100%; }
        th {
            background-color: var(--atos-table-header); color: white; border: 1px solid var(--border-white);
            padding: 0 2px; font-size: 15px; height: var(--atos-row-height); white-space: nowrap;
        }
        td { border: 1px solid var(--border-white); background-color: var(--row-gray); height: var(--atos-row-height); text-align: center; font-size: 16px; font-family: var(--atos-font); font-weight: bold; }

        .td-line-side { background-color: #f0f0f0; border-right: 2px solid #888; vertical-align: middle; }
        .row-boundary td { border-top: 3px solid #333; }

        .col-type, .col-dst { text-align: left; padding-left: 6px; }
        .col-time, .col-trk { text-align: right; padding-right: 6px; }
        .link-text { color: blue; text-decoration: underline; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="header-title">Mobile ATOS App Ver2.4.6</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">
        <div class="filter-bar">
            <div>施行日：<input type="date" id="dateInput"></div>
            <div>線区：<select id="lineSelect"><option value="">(選択)</option></select></div>
            <div>駅名：<select id="stationSelect"><option value="">(選択)</option></select></div>
        </div>

        <div class="monitor-table-container">
            <div id="loadingMsg" class="hidden" style="text-align: center; padding: 20px;">データを読み込んでいます...</div>
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width:70px;" rowspan="2">線別</th>
                        <th style="width:95px;" rowspan="2">列車番号</th>
                        <th style="width:110px;" rowspan="2">列車種別</th>
                        <th style="width:55px;" rowspan="2">動力</th>
                        <th colspan="2">着時刻</th><th colspan="2">発時刻</th>
                        <th style="width:65px;" rowspan="2">番線</th><th style="width:60px;" rowspan="2">運用<br>情報</th>
                        <th style="width:95px;" rowspan="2">運用列番</th><th style="width:115px;" rowspan="2">行先</th>
                    </tr>
                    <tr>
                        <th style="width:90px;">計画</th><th style="width:45px;">到着</th><th style="width:90px;">計画</th><th style="width:45px;">発車</th>
                    </tr>
                </thead>
                <tbody id="timetableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let rawTimetableData = [];

        async function loadData() {
            const loadingMsg = document.getElementById('loadingMsg');
            loadingMsg.classList.remove('hidden');
            try {
                const response = await fetch('timetables.json');
                rawTimetableData = await response.json();
                populateLines();
            } catch (e) { console.error(e); } finally { loadingMsg.classList.add('hidden'); }
        }

        /**
         * ソート用の数値化。データがない場合は純粋に null。
         */
        function parseTimeValue(timeStr) {
            if (!timeStr || timeStr.trim() === "" || timeStr === "…" || timeStr === "=") {
                return null; 
            }
            const parts = timeStr.split(':');
            let h = parseInt(parts[0], 10);
            let m = parseInt(parts[1], 10);
            let s = parseInt(parts[2], 10) || 0;
            if (isNaN(h) || isNaN(m)) return null;
            return (h * 3600) + (m * 60) + s;
        }

        /**
         * 表示用。値がない（nullまたは記号）場合は "…" を表示。
         * 時刻がある場合のみ hh:mm:ss に整形。
         */
        function formatDisplayTime(timeStr) {
            const totalSec = parseTimeValue(timeStr);
            // ソート値が null の場合、または元の文字が空白や記号なら「…」を表示
            if (totalSec === null) {
                // ただし「=」などはそのまま表示したい場合もあるため条件分岐
                if (timeStr === "=") return "=";
                return "…"; 
            }
            
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function populateLines() {
            const lines = [...new Set(rawTimetableData.map(d => d.line))].sort();
            const lineSelect = document.getElementById('lineSelect');
            lineSelect.innerHTML = '<option value="">(選択)</option>' + lines.map(l => `<option value="${l}">${l}</option>`).join('');
            
            lineSelect.onchange = () => {
                const stations = new Set();
                rawTimetableData.filter(d => d.line === lineSelect.value).forEach(d => d.stops.forEach(s => stations.add(s.station)));
                document.getElementById('stationSelect').innerHTML = '<option value="">(選択)</option>' + [...stations].sort().map(s => `<option value="${s}">${s}</option>`).join('');
                render();
            };
        }

        function getNsLabel(train) {
            const dict = {"A":"上り","B":"下り","N":"北行","S":"南行","U":"内回り","O":"外回り"};
            if (train.ns && dict[train.ns]) return dict[train.ns];
            const numMatch = train.trainNumber.match(/\d+/);
            if (numMatch) return (parseInt(numMatch[0], 10) % 2 === 0) ? "上り" : "下り";
            return "その他";
        }

        function render() {
            const line = document.getElementById('lineSelect').value;
            const station = document.getElementById('stationSelect').value;
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';
            if (!line || !station) return;

            const dateVal = document.getElementById('dateInput').value;
            const targetDateStr = dateVal.replace(/-/g, '/');
            const dObj = new Date(targetDateStr);
            const targetDayType = (dObj.getDay() === 0 || dObj.getDay() === 6) ? "土休日" : "平日";

            let candidates = rawTimetableData.filter(train => {
                const hasStation = train.stops.some(s => s.station === station);
                if (!hasStation || train.line !== line) return false;
                if (train.startDate === targetDateStr) return true;
                return new Date(train.startDate) <= dObj && (train.dayType === targetDayType || !train.dayType);
            });

            const trainMap = new Map();
            candidates.forEach(train => trainMap.set(train.trainNumber, train));
            const finalData = Array.from(trainMap.values());

            const grouped = {};
            finalData.forEach(t => {
                const label = getNsLabel(t);
                if (!grouped[label]) grouped[label] = [];
                grouped[label].push(t);
            });

            const sortedLabels = Object.keys(grouped).sort((a,b) => ["上り","下り"].indexOf(a) - ["上り","下り"].indexOf(b));

            sortedLabels.forEach((label, groupIdx) => {
                // ソートロジック：時刻がある場合のみ比較
                grouped[label].sort((a, b) => {
                    const sa = a.stops.find(s => s.station === station);
                    const sb = b.stops.find(s => s.station === station);
                    const valA = parseTimeValue(sa.arrival || sa.departure);
                    const valB = parseTimeValue(sb.arrival || sb.departure);
                    if (valA !== null && valB !== null) return valA - valB;
                    return 0; 
                });

                grouped[label].forEach((train, rowIdx) => {
                    const s = train.stops.find(st => st.station === station);
                    const stopIdx = train.stops.findIndex(st => st.station === station);
                    const tr = document.createElement('tr');
                    if (rowIdx === 0 && groupIdx > 0) tr.classList.add('row-boundary');

                    if (rowIdx === 0) {
                        const tdLine = document.createElement('td');
                        tdLine.className = 'td-line-side';
                        tdLine.rowSpan = grouped[label].length;
                        tdLine.innerText = label;
                        tr.appendChild(tdLine);
                    }

                    tr.innerHTML += `
                        <td class="link-text">${train.trainNumber}</td>
                        <td class="col-type">${train.type}</td>
                        <td>${train.power || ""}</td>
                        <td class="col-time">${formatDisplayTime(s.arrival)}</td>
                        <td></td>
                        <td class="col-time">${formatDisplayTime(s.departure)}</td>
                        <td></td>
                        <td class="col-trk">${s.trackN}</td>
                        <td>${(stopIdx===0 && train.tt1==='k')?'継送':''}</td>
                        <td class="link-text">${(stopIdx===0?train.tr1:'')}</td>
                        <td class="col-dst">${train.destination}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
            updateClock(targetDateStr);
        }

        function updateClock(dateStr) {
            const d = new Date(dateStr);
            d.setHours(12, 0, 0);
            const fmt = (n) => String(n).padStart(2, '0');
            document.getElementById('clockDisplay').innerText = `${d.getFullYear()}/${fmt(d.getMonth()+1)}/${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} 現在`;
        }

        document.getElementById('dateInput').onchange = render;
        document.getElementById('stationSelect').onchange = render;
        window.onload = () => {
            const today = new Date();
            document.getElementById('dateInput').value = today.toISOString().split('T')[0];
            loadData();
        };
    </script>
</body>
</html>
