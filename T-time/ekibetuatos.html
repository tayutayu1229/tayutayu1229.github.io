<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App</title>
    <style>
        :root {
            --atos-table-header: #1A968A; 
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;
            --time-status-width: 15px;
            --atos-row-height: 23px;
        }

        body {
            font-family: "MS Gothic", "MS PGothic", sans-serif;
            background-color: var(--bg-white);
            margin: 0; padding: 0;
            font-size: 15px; color: var(--text-black);
            font-weight: bold;
        }
        
        #appContainer { max-width: 1200px; margin: 0 auto; padding: 0 5px; }
        
        /* ヘッダー・フィルターバー（提供ファイルを継承） */
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #999; height: 30px;
        }
        .header-title { font-size: 16px; flex-grow: 1; text-align: center; }
        .clock-area { font-size: 15px; min-width: 180px; text-align: right; }

        .filter-bar {
            background-color: #e0e0e0; padding: 8px; display: flex; align-items: center;
            gap: 15px; border-bottom: 1px solid #999; overflow-x: auto;
        }
        
        .filter-group { display: flex; align-items: center; gap: 5px; }
        select, input { border: 1px solid #999; padding: 2px 4px; font-size: 15px; height: 24px; font-weight: bold; }

        /* テーブルスタイル */
        .monitor-table-container { width: 100%; overflow-x: auto; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th {
            background-color: var(--atos-table-header); color: white; border: 1px solid var(--border-white);
            font-size: 15px; height: var(--atos-row-height);
        }
        td {
            border: 1px solid var(--border-white); background-color: var(--row-gray);
            height: var(--atos-row-height); text-align: center; font-size: 16px;
        }
        .col-type, .col-station { text-align: left; padding-left: 10px; }
        .col-time { text-align: right; padding-right: 5px; width: 80px; }
        .link-text { color: #0000EE; text-decoration: underline; cursor: pointer; }

        /* ==================================================
           【新規】モーダル（全停車駅表示）用スタイル
           ================================================== */
        #modalOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--bg-white); width: 90%; max-width: 800px; max-height: 85vh;
            overflow-y: auto; border: 2px solid #333; position: relative; padding: 10px;
        }
        .modal-header {
            background: var(--atos-table-header); color: white; padding: 8px;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .close-btn { cursor: pointer; font-size: 20px; background: #fff; color: #333; padding: 0 8px; border: 1px solid #333; }
        
        .hidden { display: none !important; }
        .error-msg { color: #ff0000; padding: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="header-title">モバイル ATOS アプリ Ver2.5.5</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">
        <div class="filter-bar">
            <div class="filter-group">
                <span>線区：</span>
                <select id="lineSelect" onchange="renderTimetable()"><option value="">(選択)</option></select>
            </div>
            <div class="filter-group">
                <span>施行日：</span>
                <input type="date" id="dateInput" onchange="renderTimetable()">
            </div>
        </div>

        <div id="messageArea" class="hidden error-msg"></div>

        <div class="monitor-table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width:70px;" rowspan="2">線別</th>
                        <th style="width:95px;" rowspan="2">列車番号</th>
                        <th style="width:110px;" rowspan="2">列車種別</th>
                        <th style="width:55px;" rowspan="2">動力</th>
                        <th colspan="2">着時刻</th>
                        <th colspan="2">発時刻</th>
                        <th style="width:65px;" rowspan="2">番線</th>
                        <th style="width:115px;" rowspan="2">行先</th>
                    </tr>
                    <tr>
                        <th style="width:80px;">計画</th><th style="width:var(--time-status-width);"></th>
                        <th style="width:80px;">計画</th><th style="width:var(--time-status-width);"></th>
                    </tr>
                </thead>
                <tbody id="timetableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="modalOverlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="modalTitle">全停車駅一覧</span>
                <span class="close-btn" onclick="closeModal()">×</span>
            </div>
            <div id="modalTableContainer" class="monitor-table-container">
                </div>
        </div>
    </div>

    <script>
        let rawTimetableData = [];

        async function loadData() {
            try {
                const response = await fetch('timetables.json');
                rawTimetableData = await response.json();
                populateLines();
            } catch (e) { console.error(e); }
        }

        function safeVal(val) { return (val === undefined || val === null) ? "" : String(val).trim(); }

        function getDayType(dateObj) {
            const day = dateObj.getDay();
            return (day === 0 || day === 6) ? "土休日" : "平日";
        }

        function populateLines() {
            const lines = [...new Set(rawTimetableData.map(d => d.line))].sort();
            const select = document.getElementById('lineSelect');
            lines.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l; opt.text = l; select.appendChild(opt);
            });
        }

        // ==================================================
        // 【核心】特定日優先の検索ロジック
        // ==================================================
        function renderTimetable() {
            const line = document.getElementById('lineSelect').value;
            const dateVal = document.getElementById('dateInput').value;
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';
            if (!line || !dateVal) return;

            const targetDate = new Date(dateVal);
            const targetDateStr = dateVal.replace(/-/g, '/');
            const targetDayType = getDayType(targetDate);

            // 全列車番号を取得
            const uniqueNos = [...new Set(rawTimetableData.filter(d => d.line === line).map(d => d.trainNumber))];
            
            const finalDisplayList = [];

            uniqueNos.forEach(tNo => {
                const versions = rawTimetableData.filter(v => v.line === line && v.trainNumber === tNo);
                
                // 1. 特定日（施行日とstartDateが完全一致）を最優先
                let selectedVersion = versions.find(v => v.startDate === targetDateStr);

                // 2. 特定日がなければ所定ダイヤを探す
                if (!selectedVersion) {
                    const regularVersions = versions.filter(v => {
                        const start = new Date(v.startDate);
                        const isPast = start <= targetDate;
                        // 所定ダイヤ（平日/土休日一致、または空欄）
                        const isDayMatch = (v.dayType === targetDayType || v.dayType === "" || !v.dayType);
                        return isPast && isDayMatch;
                    });
                    if (regularVersions.length > 0) {
                        regularVersions.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                        selectedVersion = regularVersions[0];
                    }
                }

                if (selectedVersion) finalDisplayList.push(selectedVersion);
            });

            // 時刻ソートして描画
            finalDisplayList.sort((a,b) => {
                const timeA = a.stops[0].departure || a.stops[0].arrival || "00:00";
                const timeB = b.stops[0].departure || b.stops[0].arrival || "00:00";
                return timeA.localeCompare(timeB);
            });

            finalDisplayList.forEach(train => {
                const tr = document.createElement('tr');
                const firstStop = train.stops[0];
                const ns = (parseInt(safeVal(train.trainNumber).match(/\d+/)) % 2 === 0) ? "上り" : "下り";
                
                tr.innerHTML = `
                    <td>${ns}</td>
                    <td class="link-text" onclick="showTrainFullRoute('${train.trainNumber}', '${train.startDate}')">${train.trainNumber}</td>
                    <td class="col-type">${train.type}</td>
                    <td>${!safeVal(train.trainNumber).match(/[A-Z]$/) ? 'EL' : 'EC'}</td>
                    <td class="col-time">${firstStop.arrival || '…'}</td><td></td>
                    <td class="col-time">${firstStop.departure || '…'}</td><td></td>
                    <td>${firstStop.trackN || ''}</td>
                    <td class="col-type">${train.destination}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ==================================================
        // 【新規】全停車駅表示（モーダル）機能
        // ==================================================
        function showTrainFullRoute(tNo, sDate) {
            const train = rawTimetableData.find(v => v.trainNumber === tNo && v.startDate === sDate);
            if (!train) return;

            document.getElementById('modalTitle').innerText = `【${train.trainNumber}】全停車駅行路 - ${train.type} (${train.origin}発 ${train.destination}行)`;
            
            let html = `<table><thead><tr><th>駅名</th><th>着時刻</th><th>発時刻</th><th>番線</th></tr></thead><tbody>`;
            train.stops.forEach(s => {
                html += `<tr>
                    <td class="col-station">${s.station}</td>
                    <td class="col-time">${s.arrival || '…'}</td>
                    <td class="col-time">${s.departure || '…'}</td>
                    <td>${s.trackN || ''}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            
            document.getElementById('modalTableContainer').innerHTML = html;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        window.onload = () => {
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            loadData();
        };
    </script>
</body>
</html>
