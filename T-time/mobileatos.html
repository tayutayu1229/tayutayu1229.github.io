<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile ATOS App</title>
    <style>
        /* ===========================================================
         【 色設定エリア 】
         ここを変えると、ヘッダーの緑色などが変わります。
         ===========================================================
        */
        :root {
            /* ▼ 濃い緑（テーブルヘッダー背景色、ここを調整してください） */
            --atos-table-header: #4db6ac; 
            
            /* その他基本色 */
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;
            --error-red: #ff0000;
            
            /* ==================================================
             ★★★ 幅調整エリア ★★★
             時刻の実績/到着の列幅を調整できます。
             -------------------------------------------------- */
            /* ▼ 着時刻・発時刻の「到着/発車」(実績) の幅 (狭い方の列) */
            --time-status-width: 10px; 
            /* ================================================== */
        }
        /* =========================================================== */

        /* 全体のフォントをMS Gothicに統一し、太字を適用 */
        body {
            font-family: "MS Gothic", "MS PGothic", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg-white);
            margin: 0;
            padding: 0;
            font-size: 15px;
            color: var(--text-black);
            overflow-x: hidden;
            font-weight: bold;
        }
        
        /* 左右余白を持たせ、幅によって調整するためのコンテナ */
        #appContainer {
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 5px; 
        }
        
        /* --- 1. Header --- */
        .system-header {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #999;
            color: #444;
            height: 30px;
        }
        
        /* タイトルを中央均等配置にする */
        .header-title { 
            font-size: 16px; 
            flex-grow: 1; 
            text-align: center;
            font-family: inherit;
        }
        
        /* 時刻表示の背景を透明化し、フォントを統一 */
        .clock-area {
            background-color: transparent; 
            color: #333; 
            padding: 2px 8px;
            font-family: inherit; 
            font-size: 15px; 
            min-width: 180px;
            text-align: right;
            font-weight: bold;
            width: 180px; 
        }
        
        /* アイコンは左端に固定 */
        .icon-menu {
            width: 20px; 
            height: 16px;
            flex-shrink: 0;
        }


        /* --- 2. Filter / Search Area --- */
        .filter-bar {
            background-color: #e0e0e0;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #999;
            flex-wrap: nowrap;
            overflow-x: auto;
            font-size: 15px;
        }

        .filter-label-text { color: #333; white-space: nowrap; }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: transparent;
            border: none;
            padding: 0;
            height: auto;
        }

        select, input {
            border: 1px solid #999;
            padding: 2px 4px;
            font-size: 15px;
            height: 24px;
            border-radius: 2px;
            font-weight: bold;
            font-family: inherit;
        }
        
        input[type="date"] {
            width: 130px; 
            text-align: center;
            padding-right: 2px;
        }

        input#trainNoInput {
            background-color: #fff9c4;
            width: 70px;
            text-align: left; 
        }

        /* エラーメッセージ表示用のスタイル */
        .error-msg {
            color: var(--error-red);
            font-weight: bold;
            padding: 10px;
            font-size: 16px;
            background-color: var(--bg-white);
            border-bottom: 1px solid #ccc;
        }
        
        /* 代替検索成功時の通知メッセージスタイル (非表示を維持) */
        .notice-msg {
            color: #007bff; 
            font-weight: bold;
            padding: 10px;
            font-size: 16px;
            background-color: #e3f2fd; 
            border-bottom: 1px solid #bbdefb;
        }
        
        /* --- DEBUG AREA STYLE (非表示) --- */
        #debugArea {
            display: none !important;
        }


        /* --- 3. Train Summary --- */
        .train-summary {
            background-color: #eee;
            padding: 5px 10px;
            font-size: 15px;
            border-bottom: 1px solid #ccc;
            line-height: 1.5;
            font-weight: bold;
        }

        /* --- 4. Main Table --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            color: #000;
            /* テーブル全体の幅を固定幅で管理 */
            table-layout: fixed;
        }

        th {
            background-color: var(--atos-table-header);
            color: white;
            border: 1px solid var(--border-white);
            padding: 5px;
            font-weight: bold;
            white-space: nowrap;
            text-align: center;
            font-size: 15px;
        }
        
        /* TH 幅調整 (合計幅は約550px) */
        th:nth-child(1) { width: 70px; } /* 列車種別 */
        th:nth-child(2) { width: 30px; } /* 抑止 */
        th:nth-child(3) { width: 100px; } /* 駅名: 狭く */
        /* 着時刻 (時間 + 実績/到着) の合計幅 */
        th:nth-child(4) { width: calc(80px + var(--time-status-width)); } 
        /* 発時刻 (時間 + 実績/発車) の合計幅 */
        th:nth-child(5) { width: calc(80px + var(--time-status-width)); } 
        th:nth-child(6) { width: 70px; } /* 番線 */
        th:nth-child(7) { width: 40px; } /* 運用情報 */
        th:nth-child(8) { width: 70px; } /* 運用列番 */
        
        /* 副ヘッダーの幅調整 */
        /* 着時刻-時間 (広い方の列幅: 80pxを固定とする) */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(1) { width: 80px; } 
        /* 着時刻-到着 (狭い方の列幅: CSS変数で指定) */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(2) { width: var(--time-status-width); } 
        /* 発時刻-時間 (広い方の列幅: 80pxを固定とする) */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(3) { width: 80px; } 
        /* 発時刻-発車 (狭い方の列幅: CSS変数で指定) */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(4) { width: var(--time-status-width); } 


        td {
            border: 1px solid var(--border-white);
            padding: 2px 5px;
            text-align: center;
            background-color: var(--row-gray);
            height: 30px; 
            font-weight: bold;
            font-size: 16px; 
            line-height: 1.2;
            vertical-align: middle;
        }
        
        /* 列車種別セルを左揃えにする */
        .col-type {
            text-align: left !important;
            padding-left: 10px !important;
        }

        /* 時刻表示（着時刻・発時刻の「時間」列）を右揃えにする */
        /* TDの位置: [1(Type)], [2(抑止)], [3(駅名)], [4(着時間)], [5(着実績)], [6(発時間)], [7(発実績)], [8(番線)], [9(運用情報)], [10(運用列番)] */
        td:nth-child(4), td:nth-child(6) {
            text-align: right !important;
            padding-right: 5px;
            font-family: inherit; 
            font-size: 16px; 
            letter-spacing: normal;
        }
        
        /* **修正**: 着時刻・発時刻の「実績/到着/発車」列 (5番目, 7番目) の幅を調整 */
        td:nth-child(5), td:nth-child(7) {
            width: var(--time-status-width);
            text-align: center;
        }

        /* 番線セルを右揃えにする (8番目のTD) */
        td:nth-child(8) {
            text-align: right !important;
            padding-right: 5px;
        }
        
        .col-station { text-align: left; padding-left: 10px; }
        
        /* リンク用スタイル */
        .link-text {
            color: #0000EE;
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- 5. Footer (凡例) --- */
        .footer-legend {
            background-color: var(--bg-white);
            padding: 10px 10px 5px 10px; 
            font-size: 15px;
            font-weight: bold;
            margin-top: 15px;
        }
        
        /* 表示切り替え用 */
        .hidden { display: none !important; }

        /* Icon styling (unchanged) */
        .icon-menu {
            width: 20px; 
            height: 16px;
            border-top: 3px solid #666; border-bottom: 3px solid #666;
            position: relative;
        }
        .icon-menu::after {
            content: ""; position: absolute; top: 4px; width: 100%; height: 3px; background: #666;
        }
    </style>
</head>
<body>

    <div class="system-header">
        <div class="icon-menu"></div>
        <div class="header-title">モバイル ATOS アプリ Ver2.3.0</div>
        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- 現在</div>
    </div>
    
    <div id="appContainer">

        <div class="filter-bar">
            
            <div class="filter-group">
                <span class="filter-label-text">線区：</span>
                <select id="lineSelect" onchange="performSearch()">
                    <option value="">(選択)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <span class="filter-label-text">施行日：</span>
                <input type="date" id="dateInput" onchange="performSearch()">
            </div>

            <div class="filter-group">
                <span class="filter-label-text">列車番号：</span>
                <select id="crownSelect" style="width:50px;" onchange="performSearch()">
                    <option value=""></option>
                    <option value="回">回</option>
                    <option value="試">試</option>
                    <option value="単">単</option>
                    <option value="工">工</option>
                    <option value="配">配</option>
                    <option value="試単">試単</option>
                </select>
                <input type="text" id="trainNoInput" value="" oninput="performSearch()">
            </div>
        </div>

        <div id="messageArea" class="hidden error-msg"></div>
        
        <div id="debugArea" class="hidden">
            <pre id="debugContent"></pre>
        </div>
        <div id="contentArea" class="hidden">
            
            <div class="train-summary" id="trainSummary">
                </div>

            <div class="monitor-table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">列車種別</th>
                            <th rowspan="2">抑止</th>
                            <th rowspan="2">駅名</th>
                            <th colspan="2">着時刻</th>
                            <th colspan="2">発時刻</th>
                            <th rowspan="2">番線</th>
                            <th rowspan="2">運用<br>情報</th>
                            <th rowspan="2">運用列番</th>
                        </tr>
                        <tr>
                            <th>時間</th>
                            <th>到着</th>
                            <th>時間</th>
                            <th>発車</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>

            <div class="footer-legend">
                「$」…運休　「*」…運済　「#」…変更　「¥」…運転禁止
            </div>
        </div>
    </div> <script>
        let rawJsonData = [];
        const JSON_FILE = 'timetables.json';
        
        // =======================================================================================
        // <<<<<<<<<<<<<<<<<<<< デバッグ機能の有効/無効 フラグ >>>>>>>>>>>>>>>>>>>>>>>>>
        // =======================================================================================
        const ENABLE_DEBUG = false; // ★★★ デバッグ情報を表示しないため false ★★★
        // =======================================================================================
        
        /**
         * YYYY-MM-DD 形式にフォーマット
         */
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        /**
         * YYYY/MM/DD 形式にフォーマット (JSONデータ形式に合わせる)
         */
        function formatJsonDate(date) {
            if (typeof date === 'string') {
                return date.replace(/-/g, '/');
            }
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        }

        /**
         * 文字列の正規化 (全角半角・大文字小文字無視)
         */
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            
            let normalized = str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            normalized = normalized.toUpperCase().replace(/\s/g, '').trim();

            return normalized;
        }

        function updateDebugInfo(searchParams, result, mode) {
            if (!ENABLE_DEBUG) return;
            // ... (デバッグロジックは省略)
        }
        
        // ==========================================
        //  JSONデータ読み込み
        // ==========================================
        async function loadData() {
            try {
                const response = await fetch(JSON_FILE);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                rawJsonData = await response.json();
            } catch (error) {
                console.error(`Error loading ${JSON_FILE}:`, error);
                
                if (ENABLE_DEBUG) {
                    document.getElementById('debugArea').classList.remove('hidden');
                    document.getElementById('debugContent').textContent = `JSONファイル (${JSON_FILE}) の読み込み中にエラーが発生しました。ファイルが存在するか、JSON形式が正しいか確認してください。\nエラー: ${error.message}`;
                }
            }
        }
        
        // ==========================================
        //  UI初期化関数 (ロード時に実行される)
        // ==========================================
        function populateLines() {
            const select = document.getElementById('lineSelect');
            select.innerHTML = '<option value="">(選択)</option>';

            if (rawJsonData.length === 0) return;

            const lines = [...new Set(rawJsonData.map(d => d.line))];
            
            lines.forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.text = line;
                
                if (rawJsonData[0] && line === rawJsonData[0].line) option.selected = true;
                select.appendChild(option);
            });
        }


        /**
         * 検索条件に合致するデータかチェックする共通ロジック
         */
        function checkTrainMatch(d, searchParams, dateMode) {
            
            const { selectedLine, targetTrainNoNormalized, searchDate, selectedDateJSON } = searchParams;
            
            if (d.line !== selectedLine) return false;

            const dataTrainNoNormalized = normalizeString(d.trainNumber);
            if (dataTrainNoNormalized !== targetTrainNoNormalized) return false;


            const dataStartDate = d.startDate;
            let dateMatch = false;
            
            if (dateMode === 'strict') {
                dateMatch = (dataStartDate === selectedDateJSON);
            } else if (dateMode === 'flexible') {
                const searchTime = searchDate.getTime();
                
                if (dataStartDate === '2025/03/15') {
                    const rangeStart = new Date('2025/03/15').getTime();
                    const rangeEnd = new Date('2026/03/13').getTime();
                    dateMatch = (searchTime >= rangeStart && searchTime <= rangeEnd);
                } else if (dataStartDate === '2026/03/14') {
                    const rangeStart = new Date('2026/03/14').getTime();
                    const rangeEnd = new Date('2027/03/13').getTime();
                    dateMatch = (searchTime >= rangeStart && searchTime <= rangeEnd);
                }
            }
            
            return dateMatch; 
        }


        function performSearch() {
            const lineSelect = document.getElementById('lineSelect');
            const dateInput = document.getElementById('dateInput');
            const crownSelect = document.getElementById('crownSelect');
            const noInput = document.getElementById('trainNoInput');
            const messageArea = document.getElementById('messageArea'); 

            const selectedLine = lineSelect.value;
            const selectedDateUI = dateInput.value; 
            const searchDate = new Date(selectedDateUI); 
            
            const crownPart = crownSelect.value;
            const numberPart = noInput.value;
            const targetTrainNoNormalized = normalizeString(crownPart + numberPart);
            const selectedDateJSON = formatJsonDate(searchDate);

            const contentArea = document.getElementById('contentArea');
            
            const searchParams = {
                selectedLine,
                targetTrainNoNormalized,
                searchDate,
                selectedDateJSON,
                crownPart,
                numberPart
            };


            // UIリセット
            contentArea.classList.add('hidden');
            messageArea.classList.add('hidden'); // エラーメッセージを一旦隠す

            
            if (targetTrainNoNormalized === "" || selectedLine === "" || !selectedDateUI) {
                updateDebugInfo(searchParams, null, '初期状態/入力不足');
                return;
            }
            
            if (rawJsonData.length === 0) {
                messageArea.innerText = `データが読み込まれていません。${JSON_FILE}を確認してください。`;
                messageArea.classList.remove('hidden'); // エラー表示
                updateDebugInfo(searchParams, null, 'データなし');
                return;
            }

            let result = null;
            let searchMode = '';
            
            // --- 1. 厳密検索 ---
            searchMode = '厳密検索';
            result = rawJsonData.find(d => checkTrainMatch(d, searchParams, 'strict'));

            if (!result) {
                // --- 2. 代替検索 ---
                searchMode = '期間検索 (代替)';
                result = rawJsonData.find(d => {
                    if (d.startDate !== '2025/03/15' && d.startDate !== '2026/03/14') return false;
                    return checkTrainMatch(d, searchParams, 'flexible');
                });
            }


            // --- 結果表示 ---
            if (result) {
                
                updateDebugInfo(searchParams, result, searchMode);
                contentArea.classList.remove('hidden');
                messageArea.classList.add('hidden'); // 成功時はメッセージを隠す

                document.getElementById('trainSummary').innerHTML = 
                    `■${selectedLine} 施行日:${selectedDateJSON}<br>` +
                    `運転区間:${result.origin}～${result.destination} 列車番号: ${crownPart}${numberPart}`;

                updateSystemClock(formatDate(searchDate));
                renderTable(result);
            } else {
                updateDebugInfo(searchParams, null, searchMode);
                contentArea.classList.add('hidden');
                
                // ** データが見つからない場合のみエラーメッセージを表示 **
                messageArea.innerText = `検索した列車番号 (${crownPart}${numberPart}) は (${selectedLine}) / (${selectedDateJSON}) に存在していません`;
                messageArea.classList.remove('hidden'); // エラー表示
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            const totalStops = data.stops.length;

            data.stops.forEach((stop, index) => {
                const tr = document.createElement('tr');
                
                const typeText = (index === 0) ? data.type : '';
                
                let opInfo = ""; 
                let opNum = "";

                // 運用情報 / 運用列番 の判定ロジック
                if (index === 0) {
                    if (data.tt1 === "k") opInfo = "継送";
                    else if (data.tt1 === "o") opInfo = "折返";
                    
                    if (data.tr1) {
                        const kid1 = data.kid1 || '';
                        // 修正: kid1 を正しく引数に渡す (変更なし、前回の修正でOK)
                        opNum = `<span class="link-text" onclick="jumpToTrain('${data.tr1}', '${kid1}', 'prev')">${data.tr1}</span>`;
                    }
                } else if (index === totalStops - 1) {
                    if (data.tt2 === "k") opInfo = "継送";
                    else if (data.tt2 === "o") opInfo = "折返";

                    if (data.tr2) {
                        const kid2 = data.kid2 || '';
                        // 修正: kid2 を正しく引数に渡す (変更なし、前回の修正でOK)
                        opNum = `<span class="link-text" onclick="jumpToTrain('${data.tr2}', '${kid2}', 'next')">${data.tr2}</span>`;
                    }
                }

                // HTML生成
                tr.innerHTML = `
                    <td class="col-type">${typeText}</td> 
                    <td></td> 
                    <td class="col-station">${stop.station}</td>
                    
                    <td class="col-time">${stop.arrival || ''}</td>
                    <td></td> 

                    <td class="col-time">${stop.departure || ''}</td>
                    <td></td> 

                    <td>${stop.trackN}</td>
                    
                    <td>${opInfo}</td>
                    <td>${opNum}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        /**
         * 運用列番のリンクジャンプ処理 (kidを優先)
         * @param {string} targetTrainNum - リンク先の列車番号 (tr1/tr2)
         * @param {string} targetKid - リンク元のkid値 (kid1/kid2)
         * @param {string} direction - 'prev' または 'next'
         */
        function jumpToTrain(targetTrainNum, targetKid, direction) {
            if (rawJsonData.length === 0) return;

            const targetTrainNumNormalized = normalizeString(targetTrainNum);
            const targetKidNormalized = normalizeString(targetKid);

            let match = null;
            
            // 1. **kid マッチング (最優先)**
            if (targetKidNormalized !== "") {
                if (direction === 'prev') {
                    // リンク元(tr1/kid1) -> リンク先(trainNumber/kid2)
                    match = rawJsonData.find(d => 
                        normalizeString(d.trainNumber) === targetTrainNumNormalized && 
                        normalizeString(d.kid2 || '') === targetKidNormalized
                    );
                } 
                else if (direction === 'next') {
                    // リンク元(tr2/kid2) -> リンク先(trainNumber/kid1)
                    match = rawJsonData.find(d => 
                        normalizeString(d.trainNumber) === targetTrainNumNormalized && 
                        normalizeString(d.kid1 || '') === targetKidNormalized
                    );
                }
            }

            // 2. **kid マッチングに失敗した場合、列車番号のみで検索 (フォールバック)**
            if (!match) {
                 const candidates = rawJsonData.filter(d => 
                    normalizeString(d.trainNumber) === targetTrainNumNormalized
                 );
                 
                 // フォールバックでは、単純に最初の候補を採用
                 if (candidates.length > 0) {
                     match = candidates[0];
                 }
            }


            if (match) {
                // UIの線区、列車番号、施行日を、見つかったマッチング結果に合わせて更新する
                document.getElementById('lineSelect').value = match.line;
                
                const trainNum = match.trainNumber;
                let crown = match.crown || "";
                let numOnly = trainNum;

                if (crown && trainNum.startsWith(crown)) {
                    numOnly = trainNum.substring(crown.length);
                } else {
                    const potentialCrowns = ["回", "試", "単", "工", "配", "試単"];
                    for (const pc of potentialCrowns) {
                        if (trainNum.startsWith(pc)) {
                            crown = pc;
                            numOnly = trainNum.substring(pc.length);
                            break;
                        }
                    }
                }
                document.getElementById('crownSelect').value = crown;
                document.getElementById('trainNoInput').value = numOnly;

                // 施行日も更新して検索する (これにより、その日のデータが再検索される)
                const dateParts = match.startDate.split('/');
                const matchDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                document.getElementById('dateInput').value = formatDate(matchDate);


                // 検索実行
                performSearch();

            } else {
                // リンク先のデータが見つからなかった場合
                document.getElementById('messageArea').innerText = `リンク先の列車番号 (${targetTrainNum}) に対応するデータが見つかりませんでした。`;
                document.getElementById('messageArea').classList.remove('hidden');
                document.getElementById('contentArea').classList.add('hidden');
            }
        }

        function updateSystemClock(dateStr) {
            if (!dateStr) return;
            try {
                const d = new Date(dateStr);
                d.setDate(d.getDate() - 2); 
                d.setHours(22, 45);
                const randomSec = Math.floor(Math.random() * 60);
                d.setSeconds(randomSec);

                const fmt = (n) => String(n).padStart(2, '0');
                const str = `${d.getFullYear()}/${fmt(d.getMonth()+1)}/${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} 現在`;
                
                document.getElementById('clockDisplay').innerText = str;
            } catch(e) {}
        }
        
        // ==========================================
        //  APP ENTRY POINT (window.onload)
        // ==========================================
        window.onload = async function() {
            // 初期日付を今日の日付にセット
            document.getElementById('dateInput').value = formatDate(new Date());
            
            await loadData();
            populateLines(); 
            performSearch(); 
        };
    </script>
</body>
</html>
