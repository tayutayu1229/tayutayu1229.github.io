<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebATOS - åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</title>
    <style>
        /* ===========================================================
         ã€ è‰²è¨­å®šã‚¨ãƒªã‚¢ ã€‘
         ç”»åƒã‚’å‚è€ƒã«ã€æ¿ƒã„é’ç°è‰²ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã€æ˜ã‚‹ã„ç°è‰²ã®è¡Œã‚’è¨­å®šã€‚
         ===========================================================
        */
        :root {
            /* â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼èƒŒæ™¯è‰² (ç”»åƒã®ã‚ˆã†ãªæ¿ƒã„é’ç°/ã‚¹ãƒ¬ãƒ¼ãƒˆè‰²) */
            --atos-table-header: #404B57; 
            
            /* ãã®ä»–åŸºæœ¬è‰² */
            --bg-white: #ffffff;
            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã®èƒŒæ™¯è‰²ã‚’è–„ã„ã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ (ã™ã¹ã¦ã®è¡Œã«é©ç”¨) */
            --row-gray: #f0f0f0; 
            --text-black: #222;
            /* ç½«ç·šã‚’æ¿ƒãã—ã¦ãƒãƒƒã‚­ãƒªã¨ */
            --border-white: #666; 
            --error-red: #ff0000;
            
            /* ==================================================
             â˜…â˜…â˜… å¹…ãƒ»é«˜ã•èª¿æ•´ã‚¨ãƒªã‚¢ â˜…â˜…â˜…
             -------------------------------------------------- */
            /* â–¼ ç€æ™‚åˆ»ãƒ»ç™ºæ™‚åˆ»ã®ã€Œåˆ°ç€/ç™ºè»Šã€(å®Ÿç¸¾) ã®å¹… (ç‹­ã„æ–¹ã®åˆ—) */
            --time-status-width: 15px; 
            /* â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã®é«˜ã• (ç¸¦å¹…) */
            --atos-row-height: 23px; 
            /* ================================================== */
        }
        /* =========================================================== */

        /* å…¨ä½“ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’MS Gothicã«çµ±ä¸€ã—ã€å¤ªå­—ã‚’é©ç”¨ */
        body {
            font-family: "MS Gothic", "MS PGothic", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg-white);
            margin: 0;
            padding: 0;
            font-size: 15px;
            color: var(--text-black);
            overflow-x: hidden;
            font-weight: bold;
        }
        
        /* å·¦å³ä½™ç™½ã‚’æŒãŸã›ã€å¹…ã«ã‚ˆã£ã¦èª¿æ•´ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        #appContainer {
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 5px; 
        }
        
        /* --- 1. Header (ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ–é¢¨) --- */
        .system-header {
            background: #f0f0f0; 
            padding: 0;
            display: block; 
            border-bottom: 2px solid #999; 
            height: auto; 
        }
        
        .header-tab-menu {
            display: flex;
            flex-wrap: nowrap; 
            gap: 1px;
            overflow-x: auto;
        }
        .header-tab-menu div {
            background-color: #ddd; 
            border: 1px solid #aaa;
            padding: 5px 10px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            margin-bottom: -1px; 
            cursor: pointer;
            flex-shrink: 0;
            border-radius: 2px 2px 0 0;
            white-space: nowrap;
        }
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .header-tab-menu .active-tab {
            background-color: var(--atos-table-header); 
            color: white;
            border-color: var(--atos-table-header);
            border-bottom-color: var(--atos-table-header); 
        }
        
        .header-title, .clock-area, .icon-menu { 
            display: none !important; 
        }


        /* --- 2. Filter / Search Area (ç”»åƒã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«åˆã‚ã›ãŸçµ±ä¸€æ„Ÿ) --- */
        .filter-bar {
            background-color: var(--bg-white);
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #999;
            flex-wrap: nowrap;
            overflow-x: auto;
            font-size: 15px;
            justify-content: flex-start;
        }

        .filter-label-text { color: #333; white-space: nowrap; }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        /* Select/Inputã®ã‚µã‚¤ã‚ºã‚’çµ±ä¸€ (ç”»åƒã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å¿ å®Ÿã«å†ç¾) */
        select, input {
            border: 1px solid #888;
            padding: 2px 4px;
            font-size: 15px;
            height: 28px; 
            border-radius: 0; 
            font-weight: bold;
            font-family: inherit;
            box-sizing: border-box; 
            text-align: center;
        }
        
        input[type="date"] {
            width: 120px; 
        }
        
        /* Selectã®å¹… */
        .filter-group select {
            width: 60px; 
        }
        /* ç·šåŒºé¸æŠã®å¹… */
        .filter-group select#lineSelect {
            width: 120px; 
        }
        
        /* åˆ—è»Šç•ªå·å…¥åŠ›æ¬„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        input#trainNoInput {
            background-color: #ffffcc; /* æ˜ã‚‹ã„é»„è‰² */
            border-color: #ffcc00; 
            width: 60px; 
        }
        
        /* æ›´æ–°ãƒœã‚¿ãƒ³ */
        .action-buttons {
            margin-left: auto; 
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .refresh-button {
            background-color: #55aaff; 
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 28px;
            box-sizing: border-box;
        }
        .refresh-button::before {
            content: "â†»";
            font-size: 18px;
            line-height: 1;
        }
        
        /* ? (ãƒ˜ãƒ«ãƒ—ã‚¢ã‚¤ã‚³ãƒ³) ã¯éè¡¨ç¤º */
        .help-icon { display: none !important; }


        /* --- 3. Train Summary --- */
        .train-summary {
            background-color: #eee;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            border-bottom: 1px solid #ccc;
            line-height: 1.5;
            font-weight: bold;
        }
        
        .summary-text {
            font-size: 15px;
            font-weight: bold;
            line-height: 1.5;
        }
        
        .status-time {
            font-size: 14px;
            color: #555;
            white-space: nowrap;
        }

        /* --- 4. Main Table --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            color: #000;
            table-layout: fixed;
        }

        th {
            background-color: var(--atos-table-header);
            color: white;
            border: 1px solid var(--border-white);
            padding: 4px 5px; 
            font-weight: bold;
            white-space: nowrap;
            text-align: center;
            font-size: 15px;
            height: auto; 
        }
        
        /* TH å¹…èª¿æ•´ (é…å»¶(åˆ†)ã‚’å‰Šé™¤ã—ã€é‹ç”¨åˆ—ç•ªã‚’è¿½åŠ ) */
        /* Col 1: åˆ—è»Šç¨®åˆ¥ (70px) */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(1) { width: 70px; } 
        /* Col 2: æŠ‘æ­¢ (30px) */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(2) { width: 30px; } 
        /* Col 3: é§…å (100px) */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(3) { width: 100px; } 
        /* Col 4: ç€æ™‚åˆ» (colspan 3) */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(4) { 
            width: calc(50px + 50px + var(--time-status-width)); 
        } 
        /* Col 5: ç™ºæ™‚åˆ» (colspan 3) */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(5) { 
            width: calc(50px + 50px + var(--time-status-width)); 
        }
        /* Col 6: ç•ªç·š (70px) */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(6) { width: 70px; } 
        /* Col 7: é‹ç”¨æƒ…å ± (40px) */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(7) { width: 40px; } 
        /* Col 8: é‹ç”¨åˆ—ç•ª (70px) */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(8) { width: 70px; } 

        /* å‰¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®å¹…èª¿æ•´ */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(1) { width: 50px; } /* ç€æ™‚åˆ»-è¨ˆç”» */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(2) { width: 50px; } /* ç€æ™‚åˆ»-äºˆæ¸¬ */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(3) { width: var(--time-status-width); } /* ç€æ™‚åˆ»-åˆ°ç€ */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(4) { width: 50px; } /* ç™ºæ™‚åˆ»-è¨ˆç”» */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(5) { width: 50px; } /* ç™ºæ™‚åˆ»-äºˆæ¸¬ */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(6) { width: var(--time-status-width); } /* ç™ºæ™‚åˆ»-ç™ºè»Š */

        td {
            border: 1px solid var(--border-white);
            padding: 2px 5px;
            text-align: center;
            background-color: var(--row-gray); /* ã™ã¹ã¦ç°è‰² */
            height: var(--atos-row-height); 
            font-weight: bold;
            font-size: 15px; 
            line-height: 1.2;
            vertical-align: middle;
        }
        
        /* TDã®ä½ç½®èª¿æ•´ */
        /* [1(ç¨®åˆ¥)], [2(æŠ‘æ­¢)], [3(é§…å)], [4(ç€è¨ˆç”»)], [5(ç€äºˆæ¸¬)], [6(ç€å®Ÿç¸¾)], [7(ç™ºè¨ˆç”»)], [8(ç™ºäºˆæ¸¬)], [9(ç™ºå®Ÿç¸¾)], [10(ç•ªç·š)], [11(é‹ç”¨æƒ…å ±)], [12(é‹ç”¨åˆ—ç•ª)] */
        .col-type { text-align: left !important; padding-left: 10px !important; }
        .col-station { text-align: left; padding-left: 10px; }
        
        /* æ™‚åˆ»è¡¨ç¤ºï¼ˆè¨ˆç”»ãƒ»äºˆæ¸¬ï¼‰ã®åˆ—ã‚’å³æƒãˆã«ã™ã‚‹ */
        td:nth-child(4), td:nth-child(5), td:nth-child(7), td:nth-child(8) {
            text-align: right !important;
            padding-right: 5px;
            font-family: inherit; 
            font-size: 16px; 
            letter-spacing: normal;
        }
        
        /* å®Ÿç¸¾/åˆ°ç€/ç™ºè»Š åˆ— (6ç•ªç›®, 9ç•ªç›®) ã®å¹…ã‚’èª¿æ•´ */
        td:nth-child(6), td:nth-child(9) {
            width: var(--time-status-width) !important; 
            min-width: var(--time-status-width) !important; 
            text-align: center;
        }

        /* ç•ªç·šã‚»ãƒ«ã‚’å³æƒãˆã«ã™ã‚‹ (10ç•ªç›®ã®TD) */
        td:nth-child(10) {
            text-align: right !important;
            padding-right: 5px;
        }
        
        .link-text {
            color: #000;
            text-decoration: none; 
            cursor: pointer;
            font-weight: bold;
        }

        /* --- 5. Footer (å‡¡ä¾‹) --- */
        .footer-legend {
            background-color: var(--bg-white);
            padding: 10px 10px 5px 10px; 
            font-size: 15px;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .footer-legend::after {
            content: "";
            display: block;
            height: 30px; 
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <div class="system-header">
        <div class="header-tab-menu">
            <div>é‹è¡ŒæŠŠæ¡ãƒ¢ãƒ‹ã‚¿</div>
            <div>é§…é…å»¶ãƒ¢ãƒ‹ã‚¿</div>
            <div>åˆ—è»Šåœ¨ç·šãƒ¢ãƒ‹ã‚¿</div>
            <div>åˆ—è»Šæ¢ç´¢ãƒ¢ãƒ‹ã‚¿</div>
            <div>é‹è»¢è¨ˆç”»ãƒ¢ãƒ‹ã‚¿</div>
            <div class="active-tab">åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</div>
            <div>åŒºé–“åˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</div>
            <div>å…¥å‡ºåŒºãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</div>
        </div>
        <div class="header-tab-menu">
            <div>é‹è»¢æƒ…å ±ãƒ¢ãƒ‹ã‚¿</div>
            <div>é…å»¶è¨¼æ˜ãƒ¢ãƒ‹ã‚¿</div>
            <div>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</div>
            <div>ä»–ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒ³ã‚¯</div>
        </div>
    </div>
    
    <div id="appContainer">

        <div class="filter-bar">
            
            <div class="filter-group">
                <span class="filter-label-text">è¡¨ç¤ºå†…å®¹é¸æŠ ç·šåŒºï¼š</span>
                <select id="lineSelect" onchange="performSearch()">
                    <option value="">(é¸æŠ)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <span class="filter-label-text">æ–½è¡Œæ—¥ï¼š</span>
                <input type="date" id="dateInput" onchange="performSearch()">
                <div style="font-size: 18px; line-height: 28px;">ğŸ“…</div> 
            </div>

            <div class="filter-group">
                <span class="filter-label-text">åˆ—è»Šç•ªå·ï¼š</span>
                <select id="crownSelect" onchange="performSearch()">
                    <option value=""></option>
                    <option value="å›">å›</option>
                    <option value="è©¦">è©¦</option>
                    <option value="å˜">å˜</option>
                    <option value="å·¥">å·¥</option>
                    <option value="é…">é…</option>
                    <option value="è©¦å˜">è©¦å˜</option>
                </select>
                <input type="text" id="trainNoInput" value="" placeholder="9875" oninput="performSearch()">
            </div>

            <div class="action-buttons">
                <div class="refresh-button">æ›´æ–°</div>
                </div>
        </div>

        <div id="messageArea" class="hidden error-msg"></div>
        
        <div id="contentArea" class="hidden">
            
            <div class="train-summary" id="trainSummary">
                <div class="summary-text">
                    â– ç·šåŒº æ–½è¡Œæ—¥:YYYY/MM/DD<br>
                    é‹è»¢åŒºé–“:å§‹ç™ºé§…ï½çµ‚ç€é§… åˆ—è»Šç•ªå·: 
                </div>
                <div class="status-time" id="clockDisplay">----/--/-- --:--:-- ç¾åœ¨</div>
            </div>

            <div class="monitor-table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">åˆ—è»Šç¨®åˆ¥</th>
                            <th rowspan="2">æŠ‘æ­¢</th>
                            <th rowspan="2">é§…å</th>
                            <th colspan="3">ç€æ™‚åˆ»</th>
                            <th colspan="3">ç™ºæ™‚åˆ»</th>
                            <th rowspan="2">ç•ªç·š</th>
                            <th rowspan="2">é‹ç”¨<br>æƒ…å ±</th>
                            <th rowspan="2">é‹ç”¨åˆ—ç•ª</th>
                        </tr>
                        <tr>
                            <th>è¨ˆç”»</th>
                            <th>äºˆæ¸¬</th>
                            <th>åˆ°ç€</th>
                            <th>è¨ˆç”»</th>
                            <th>äºˆæ¸¬</th>
                            <th>ç™ºè»Š</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>

            <div class="footer-legend">
                å‡¡ä¾‹ï¼šã€Œ$ã€â€¦é‹ä¼‘ã€€ã€Œ*ã€â€¦é‹æ¸ˆã€€ã€Œ#ã€â€¦å¤‰æ›´ã€€ã€ŒÂ¥ã€â€¦é‹è»¢ç¦æ­¢
            </div>
        </div>
    </div> 
    
    <script>
        let rawJsonData = [];
        // JSONãƒ•ã‚¡ã‚¤ãƒ«å (åŒéšå±¤ã«é…ç½®)
        const JSON_FILE = 'timetables.json';
        const HOLIDAY_API_URL = 'https://holidays-jp.github.io/api/v1/date.json';
        
        let holidayData = {}; 

        // æ‰€å®šãƒ€ã‚¤ãƒ¤ã®é‹è¡ŒæœŸé–“ (ä¾‹ã¨ã—ã¦è¨­å®š)
        const PERIOD_START = new Date('2025/03/15');
        const PERIOD_END = new Date('2026/03/13');
        
        
        // =======================================================================================
        // <<<<<<<<<<<<<<<<<<<< ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° >>>>>>>>>>>>>>>>>>>>>>>>>
        // =======================================================================================
        
        /**
         * YYYY-MM-DD å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         */
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        /**
         * YYYY/MM/DD å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (JSONãƒ‡ãƒ¼ã‚¿å½¢å¼ã«åˆã‚ã›ã‚‹)
         */
        function formatJsonDate(date) {
            if (typeof date === 'string') {
                return date.replace(/-/g, '/');
            }
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        }

        /**
         * æ–‡å­—åˆ—ã®æ­£è¦åŒ– (å…¨è§’åŠè§’ãƒ»å¤§æ–‡å­—å°æ–‡å­—ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ç„¡è¦–)
         */
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            
            let normalized = str.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            normalized = normalized.toUpperCase().replace(/\s/g, '').trim();

            return normalized;
        }

        /**
         * ç¥æ—¥åˆ¤å®š (åœŸæ—¥ã€ãŠã‚ˆã³APIã‹ã‚‰å–å¾—ã—ãŸç¥æ—¥ãƒ‡ãƒ¼ã‚¿)
         */
        function isHoliday(date) {
            const dayOfWeek = date.getDay(); // 0: æ—¥, 6: åœŸ
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return true; // åœŸæ—¥
            }
            
            const dateKey = formatDate(date); // YYYY-MM-DD å½¢å¼
            return holidayData.hasOwnProperty(dateKey); // ç¥æ—¥
        }

        // ==========================================
        //  JSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        // ==========================================
        async function loadData() {
            try {
                // 1. ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                const holidayResponse = await fetch(HOLIDAY_API_URL);
                if (holidayResponse.ok) {
                    holidayData = await holidayResponse.json();
                } else {
                    console.warn(`Holiday API error: ${holidayResponse.status}.`);
                }
                
                // 2. ãƒ€ã‚¤ãƒ¤ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                const dataResponse = await fetch(JSON_FILE);
                if (!dataResponse.ok) {
                    console.error(`Data file (${JSON_FILE}) not found or failed to load. Using mock data for demo.`);
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®JSONã‚µãƒ³ãƒ—ãƒ«ã‚’å…ƒã«ã—ãŸãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
                    rawJsonData = [
                        {
                            "trainNumber": "å›3174M",
                            "type": "å›é›»",
                            "crown": "å›",
                            "dayType": "å¹³æ—¥",
                            "startDate": "2025/09/18", /* æ–½è¡Œæ—¥ã¨ä¸€è‡´ã•ã›ã‚‹ãŸã‚æ—¥ä»˜å¤‰æ›´ */
                            "origin": "æ±å¤§å®®æ“",
                            "destination": "æ±ã€€äº¬",
                            "speed": "é€šé›»A3 ã€œã‚¦ã‚¨ . ã‚¦ã‚¨ã€œé€šé›»A2",
                            "name": "",
                            "line": "æ±åŒ—",
                            "tr1": "å˜9875", /* é‹ç”¨åˆ—ç•ª (å‰åˆ—è»Š) ã®ä¾‹ */
                            "tr2": "å›3175M", /* é‹ç”¨åˆ—ç•ª (å¾Œåˆ—è»Š) ã®ä¾‹ */
                            "stops": [
                                { "station": "æ±å¤§å®®æ“", "arrival": "...", "departure": "17:30:00", "trackN": "å…¥" },
                                { "station": "å¤§ã€€å®®", "arrival": "17:36:30" , "departure": "17:48:15", "trackN": "ï¼—ç•ª"},
                                { "station": "ã•æ–°éƒ½å¿ƒ", "arrival": "||" , "departure": "||" , "trackN": "å®¢ä¸Š"},
                                { "station": "æµ¦ã€€å’Œ", "arrival": "â€¦", "departure": "17:56:30" , "trackN": "å®¢ä¸Š"},
                                { "station": "å·ã€€å£", "arrival": "â€¦", "departure": "18:02:15" , "trackN": "å®¢ä¸Š"},
                                { "station": "èµ¤ã€€ç¾½", "arrival": "â€¦", "departure": "18:09:45" , "trackN": "å®¢ä¸Š"},
                                { "station": "å°¾ã€€ä¹…", "arrival": "â€¦", "departure": "18:11:30" , "trackN": "ä¸Šæœ¬"},
                                { "station": "äº•ã€€å €", "arrival": "â€¦", "departure": "18:11:30" , "trackN": "é«˜æ¶ä¸Š"},
                                { "station": "ä¸Šã€€é‡", "arrival": "18:16:45", "departure": "18:17:45", "trackN": "ï¼˜ç•ª"},
                                { "station": "æ±ã€€äº¬", "arrival": "18:23:00" , "departure": "=", "trackN": "ï¼™ç•ª"}
                            ]
                        },
                        { "trainNumber": "å˜9875", "type": "å˜æ©Ÿ", "crown": "å˜", "dayType": "", "startDate": "2025/09/18", "origin": "å·å´è²¨ç‰©", "destination": "æ–°é¶´è¦‹", "line": "æ±æµ·é“", "stops": [{ "station": "å·å´è²¨ç‰©", "departure": "18:52:00", "trackN": "****" }] }
                    ];
                } else {
                    rawJsonData = await dataResponse.json();
                }
                
            } catch (error) {
                console.error(`Error loading data:`, error);
                document.getElementById('messageArea').innerText = `ãƒ‡ãƒ¼ã‚¿ (${JSON_FILE}) ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                document.getElementById('messageArea').classList.remove('hidden');
            }
        }
        
        // ==========================================
        //  ãƒ¡ã‚¤ãƒ³æ¤œç´¢å‡¦ç†
        // ==========================================

        function performSearch() {
            const lineSelect = document.getElementById('lineSelect');
            const dateInput = document.getElementById('dateInput');
            const crownSelect = document.getElementById('crownSelect');
            const noInput = document.getElementById('trainNoInput');
            const messageArea = document.getElementById('messageArea'); 
            const contentArea = document.getElementById('contentArea');

            const selectedLine = lineSelect.value;
            const selectedDateUI = dateInput.value; 
            
            // UIãƒªã‚»ãƒƒãƒˆ
            contentArea.classList.add('hidden');
            messageArea.classList.add('hidden');
            document.getElementById('scheduleBody').innerHTML = '';
            document.getElementById('clockDisplay').innerText = `----/--/-- --:--:-- ç¾åœ¨`;

            if (selectedDateUI === "" || selectedLine === "" || noInput.value === "") {
                 return;
            }
            
            const searchDate = new Date(selectedDateUI); 
            const crownPart = crownSelect.value;
            const numberPart = noInput.value;
            const targetTrainNoFull = crownPart + numberPart; // åˆ—è»Šç•ªå·ã‚’ç¨®åˆ¥å† ã¨åˆä½“
            const targetTrainNoNormalized = normalizeString(targetTrainNoFull);
            const selectedDateJSON = formatJsonDate(searchDate); // YYYY/MM/DDå½¢å¼

            
            // æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            const isTargetHoliday = isHoliday(searchDate);
            const searchDayType = isTargetHoliday ? "åœŸä¼‘æ—¥" : "å¹³æ—¥";
            const searchTime = searchDate.getTime();
            
            let result = null;
            
            // 1. æœ€å„ªå…ˆï¼šç‰¹å®šæ—¥ãƒ€ã‚¤ãƒ¤æ¤œç´¢ (ç·šåŒºã€åˆ—è»Šç•ªå·ã€æ–½è¡Œæ—¥ å®Œå…¨ä¸€è‡´)
            result = rawJsonData.find(d => 
                d.line === selectedLine &&
                normalizeString(d.trainNumber) === targetTrainNoNormalized &&
                d.startDate === selectedDateJSON
            );
            
            if (result) {
                updateSummaryAndTable(result, selectedLine, selectedDateJSON, targetTrainNoFull);
                return;
            }

            // 2. ç¬¬2å„ªå…ˆï¼šæ‰€å®šãƒ€ã‚¤ãƒ¤æ¤œç´¢ (dayType / æœŸé–“ãƒãƒƒãƒ)
            
            const isInPeriod = (searchTime >= PERIOD_START.getTime() && searchTime <= PERIOD_END.getTime());
            
            if (isInPeriod) {
                // æ‰€å®šãƒ€ã‚¤ãƒ¤ã®åŸºæº–æ—¥ãƒªã‚¹ãƒˆ (ä¾‹: 2025/03/15, 2025/03/17, 2026/03/14ãªã©ã€æœŸé–“å†…ã§å›ºå®šã•ã‚ŒãŸstartDateã‚’æŒã¤ã‚‚ã®)
                const standardStartDates = ['2025/03/15', '2025/03/17']; 

                result = rawJsonData.find(d => {
                    if (d.line !== selectedLine || normalizeString(d.trainNumber) !== targetTrainNoNormalized) {
                        return false;
                    }
                    
                    const dataDayType = d.dayType || ""; 
                    
                    // dayTypeãŒç©ºæ¬„ï¼ˆæ¯æ—¥ãƒ€ã‚¤ãƒ¤ï¼‰ã®å ´åˆã€åŸºæº–æ—¥ã«ä¸€è‡´ã™ã‚Œã°æ¡ç”¨
                    if (dataDayType === "") {
                        if (standardStartDates.includes(d.startDate)) {
                             return true;
                        }
                    } 
                    
                    // dayTypeãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ (å¹³æ—¥ or åœŸä¼‘æ—¥)ã€æ›œæ—¥ã¨åŸºæº–æ—¥ã«ä¸€è‡´ã™ã‚Œã°æ¡ç”¨
                    else if (dataDayType === searchDayType) {
                        if (standardStartDates.includes(d.startDate)) { 
                            return true;
                        }
                    }
                    
                    return false;
                });
            }

            // --- çµæœè¡¨ç¤º ---
            if (result) {
                updateSummaryAndTable(result, selectedLine, selectedDateJSON, targetTrainNoFull);
            } else {
                
                messageArea.innerText = `æ¤œç´¢ã—ãŸåˆ—è»Šç•ªå· (${targetTrainNoFull}) ã®ãƒ€ã‚¤ãƒ¤ (${selectedLine}, æ–½è¡Œæ—¥:${selectedDateJSON}, æ›œæ—¥:${searchDayType}) ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
                messageArea.classList.remove('hidden');
            }
        }
        
        /**
         * æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®è¡¨ç¤ºæ›´æ–°å‡¦ç†
         */
        function updateSummaryAndTable(result, selectedLine, selectedDateJSON, targetTrainNoFull) {
            document.getElementById('contentArea').classList.remove('hidden');
            document.getElementById('messageArea').classList.add('hidden');

            // é‹è»¢åŒºé–“ã‚µãƒãƒªãƒ¼ã®æ›´æ–°
            document.querySelector('.summary-text').innerHTML = 
                `â– ${selectedLine} æ–½è¡Œæ—¥:${selectedDateJSON}<br>` +
                `é‹è»¢åŒºé–“:${result.origin}ï½${result.destination} åˆ—è»Šç•ªå·: ${targetTrainNoFull}`;

            // æ™‚è¨ˆè¡¨ç¤ºã‚’æ›´æ–° (ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿)
            updateSystemClock(selectedDateJSON);
            renderTable(result);
        }

        // ==========================================
        //  ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å‡¦ç†
        // ==========================================

        function renderTable(data) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            const totalStops = data.stops.length;

            data.stops.forEach((stop, index) => {
                const tr = document.createElement('tr');
                
                // åˆ—è»Šç¨®åˆ¥ã¯æœ€åˆã®è¡Œã®ã¿è¡¨ç¤º (ã‚»ãƒ«ã¯çµåˆã—ãªã„)
                const typeText = (index === 0) ? data.type : '';
                
                let opInfo = ""; // é‹ç”¨æƒ…å ±
                let opNum = "";  // é‹ç”¨åˆ—ç•ª
                let currentKid = data.kid || ''; 

                // é‹ç”¨æƒ…å ± / é‹ç”¨åˆ—ç•ª ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒ‡ãƒ¢ã¨ã—ã¦å›ºå®šå€¤ã‚’ä½¿ç”¨
                if (index === 0) {
                    if (data.tt1 === "k") opInfo = "ç¶™é€";
                    else if (data.tt1 === "o") opInfo = "æŠ˜è¿”";
                    // å‰åˆ—è»Šã¸ã®ãƒªãƒ³ã‚¯
                    if (data.tr1) {
                        const kidToPass = data.kid1 || currentKid; 
                        opNum = `<span class="link-text" onclick="jumpToTrain('${data.tr1}', '${kidToPass}', 'prev')">${data.tr1}</span>`;
                    }
                } else if (index === totalStops - 1) {
                    if (data.tt2 === "k") opInfo = "ç¶™é€";
                    else if (data.tt2 === "o") opInfo = "æŠ˜è¿”";
                    // å¾Œåˆ—è»Šã¸ã®ãƒªãƒ³ã‚¯
                    if (data.tr2) {
                        const kidToPass = data.kid2 || currentKid; 
                        opNum = `<span class="link-text" onclick="jumpToTrain('${data.tr2}', '${kidToPass}', 'next')">${data.tr2}</span>`;
                    }
                }

                // HTMLç”Ÿæˆ
                // TDã®ä½ç½®: [1(ç¨®åˆ¥)], [2(æŠ‘æ­¢)], [3(é§…å)], [4(ç€è¨ˆç”»)], [5(ç€äºˆæ¸¬)], [6(ç€å®Ÿç¸¾)], [7(ç™ºè¨ˆç”»)], [8(ç™ºäºˆæ¸¬)], [9(ç™ºå®Ÿç¸¾)], [10(ç•ªç·š)], [11(é‹ç”¨æƒ…å ±)], [12(é‹ç”¨åˆ—ç•ª)]
                tr.innerHTML = `
                    <td class="col-type">${typeText}</td> 
                    <td></td> <td class="col-station">${stop.station}</td>
                    
                    <td class="col-time">${stop.arrival || '...'}</td> <td class="col-time">${stop.arrival ? '...' : ''}</td> <td></td> <td class="col-time">${stop.departure || '...'}</td> <td class="col-time">${stop.departure ? '...' : ''}</td> <td></td> <td>${stop.trackN || ''}</td> <td>${opInfo}</td> <td>${opNum}</td> `;

                tbody.appendChild(tr);
            });
        }

        /**
         * é‹ç”¨åˆ—ç•ªã®ãƒªãƒ³ã‚¯ã‚¸ãƒ£ãƒ³ãƒ—å‡¦ç† (ãƒ‡ãƒ¢ç”¨: åˆ—è»Šç•ªå·ã¨ç·šåŒºã‚’æ›´æ–°ã—ã¦å†æ¤œç´¢)
         */
        function jumpToTrain(targetTrainNum, currentKid, direction) {
            if (rawJsonData.length === 0) return;

            const targetTrainNumNormalized = normalizeString(targetTrainNum);
            const selectedDateJSON = document.getElementById('dateInput').value.replace(/-/g, '/');

            // ãƒªãƒ³ã‚¯å…ˆã®åˆ—è»Šç•ªå·ã¨æ–½è¡Œæ—¥ãŒä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
            const match = rawJsonData.find(d => 
                normalizeString(d.trainNumber) === targetTrainNumNormalized &&
                d.startDate === selectedDateJSON
            );
            
            if (match) {
                // æ¤œç´¢çª“ã®ç·šåŒºã¨åˆ—è»Šç•ªå·ã®ã¿ã‚’æ›´æ–°
                document.getElementById('lineSelect').value = match.line;
                
                // åˆ—è»Šç•ªå· (ç¨®åˆ¥å† ã¨æ•°å­—éƒ¨åˆ†ã‚’åˆ†é›¢)
                const trainNum = match.trainNumber;
                let crown = match.crown || "";
                let numOnly = trainNum;

                if (crown && trainNum.startsWith(crown)) {
                    numOnly = trainNum.substring(crown.length);
                } 
                
                document.getElementById('crownSelect').value = crown;
                document.getElementById('trainNoInput').value = numOnly;

                // æ¤œç´¢å®Ÿè¡Œ (é¸æŠã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ã¨æ–°ã—ã„åˆ—è»Šç•ªå·ã§æ¤œç´¢ã—ç›´ã™)
                performSearch();

            } else {
                document.getElementById('messageArea').innerText = `ãƒªãƒ³ã‚¯å…ˆã®åˆ—è»Šç•ªå· (${targetTrainNum}) ã«å¯¾å¿œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
                document.getElementById('messageArea').classList.remove('hidden');
                document.getElementById('contentArea').classList.add('hidden');
            }
        }

        /**
         * ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»è¡¨ç¤ºã®æ›´æ–° (æ–½è¡Œæ—¥ã®2æ—¥å‰ã®22æ™‚45åˆ†ãƒ©ãƒ³ãƒ€ãƒ ç§’)
         */
        function updateSystemClock(dateStr) {
            if (!dateStr) return;
            try {
                // æ–½è¡Œæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨
                const d = new Date(dateStr);
                // 2æ—¥å‰
                d.setDate(d.getDate() - 2); 
                // 22æ™‚45åˆ†
                d.setHours(22, 45, 0, 0); 
                // ãƒ©ãƒ³ãƒ€ãƒ ç§’ (0ã€œ59)
                const randomSec = Math.floor(Math.random() * 60);
                d.setSeconds(randomSec);

                const fmt = (n) => String(n).padStart(2, '0');
                const str = `${d.getFullYear()}/${fmt(d.getMonth()+1)}/${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} ç¾åœ¨`;
                
                document.getElementById('clockDisplay').innerText = str;
            } catch(e) {
                console.error("Failed to set clock display:", e);
                document.getElementById('clockDisplay').innerText = `----/--/-- --:--:-- ç¾åœ¨`;
            }
        }
        
        // ==========================================
        //  APP ENTRY POINT (window.onload)
        // ==========================================
        window.onload = async function() {
            // åˆæœŸæ—¥ä»˜ã‚’ä¾‹ã¨ã—ã¦è¨­å®š
            document.getElementById('dateInput').value = '2025-09-18'; 
            
            await loadData();
            
            populateLines(); 
            
            // ãƒ‡ãƒ¢æ¤œç´¢å®Ÿè¡Œ (ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ)
            if (rawJsonData.length > 0) {
                 // æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ç·šåŒºã€ç¨®åˆ¥å† ã€åˆ—è»Šç•ªå·ã‚’è¨­å®š
                 document.getElementById('lineSelect').value = rawJsonData[0].line;
                 document.getElementById('crownSelect').value = rawJsonData[0].crown;
                 const trainNumOnly = rawJsonData[0].trainNumber.replace(rawJsonData[0].crown, '');
                 document.getElementById('trainNoInput').value = trainNumOnly;
            }

            performSearch(); 
        };

        /**
         * JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä¸€æ„ã®ç·šåŒºåã‚’æŠ½å‡ºã—ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
         */
        function populateLines() {
            const select = document.getElementById('lineSelect');
            select.innerHTML = '<option value="">(é¸æŠ)</option>';

            if (rawJsonData.length === 0) return;

            const lines = [...new Set(rawJsonData.map(d => d.line).filter(Boolean))].sort();
            
            lines.forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.text = line;
                
                select.appendChild(option);
            });
        }
    </script>
</body>
</html>
