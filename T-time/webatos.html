<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</title>
    <style>
        /* ===========================================================
         ã€ è‰²è¨­å®šã‚¨ãƒªã‚¢ ã€‘
         (WebATOSé¢¨ é’ç³»ã«ä¿®æ­£)
         ===========================================================
        */
        :root {
            /* â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼èƒŒæ™¯è‰² / ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ ã®æ¿ƒã„é’ç·‘ (ç”»åƒã®è‰²ã«è¿‘ã¥ã‘ã‚‹) */
            --atos-table-header: #4271A2; 
            /* â–¼ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ ã€æ›´æ–°ãƒœã‚¿ãƒ³ã®é’è‰² */
            --atos-blue: #4271A2; 
            
            /* ãã®ä»–åŸºæœ¬è‰² */
            --bg-white: #ffffff;
            --row-gray: #cfcfcf;
            --text-black: #222;
            --border-white: #ffffff;
            --error-red: #ff0000;
            
            /* ==================================================
             â˜…â˜…â˜… å¹…ãƒ»é«˜ã•èª¿æ•´ã‚¨ãƒªã‚¢ â˜…â˜…â˜…
             -------------------------------------------------- */
            /* â–¼ æ™‚åˆ»ã®ã€Œåˆ°ç€/ç™ºè»Šã€(å®Ÿç¸¾) ã®å¹… (ç‹­ã„æ–¹ã®åˆ—) */
            --time-status-width: 15px; 
            /* â–¼ è¨ˆç”»/äºˆæ¸¬ã®æ™‚åˆ»ã®å¹… (åºƒã„æ–¹ã®åˆ—) */
            --time-planned-width: 55px; 
            /* â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã®é«˜ã• (ç¸¦å¹…) */
            --atos-row-height: 23px; 
            /* ================================================== */
        }
        /* =========================================================== */

        /* å…¨ä½“ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’MS Gothicã«çµ±ä¸€ã—ã€å¤ªå­—ã‚’é©ç”¨ */
        body {
            font-family: "MS Gothic", "MS PGothic", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg-white);
            margin: 0;
            padding: 0;
            font-size: 15px;
            color: var(--text-black);
            overflow-x: hidden;
            font-weight: bold;
        }
        
        /* å·¦å³ä½™ç™½ã‚’æŒãŸã›ã€å¹…ã«ã‚ˆã£ã¦èª¿æ•´ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        #appContainer {
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 5px; 
        }
        
        /* --- 1. Header & Tabs --- */
        .system-header-tabs {
            background-color:#fff; 
            border-bottom:1px solid #999;
        }
        .header-tab-menu {
            display:flex; 
            flex-wrap:nowrap; 
            overflow-x:auto; 
            gap:1px; 
            border-bottom:1px solid #aaa; 
            padding-top:2px;
        }
        /* éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã®è‰²ã‚’ç°è‰²ã«ã™ã‚‹ */
        .header-tab-menu > div {
            background-color:#ddd; 
            border:1px solid #aaa; 
            padding:5px 10px; 
            font-size:14px; 
            font-weight:bold; 
            text-align:center; 
            flex-shrink:0; 
            border-radius:2px 2px 0 0; 
            white-space:nowrap;
            cursor: pointer;
        }
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‚’ç”»åƒã«åˆã‚ã›ã¦æ¿ƒã„é’/é»„è‰²ã«ã™ã‚‹ */
        .header-tab-menu .active-tab {
            background-color:#E9C51D; /* ç”»åƒã«åˆã‚ã›ã¦é»„è‰² */
            color:black; 
            border:1px solid #E9C51D;
        }
        .header-sub-menu {
            display:flex; 
            align-items:center; 
            padding:3px 10px; 
            background-color:#eee; 
            border-bottom:1px solid #999;
        }
        .header-sub-menu > div {
            font-size:14px; 
            margin-right:15px; 
            color:#333; 
            cursor:pointer; 
            font-weight:normal;
            white-space: nowrap;
        }

        /* ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»è¡¨ç¤º */
        .clock-area {
            position: absolute; 
            right: 15px;
            top: 70px; 
            font-size: 15px; 
            font-weight: bold;
            color: #333;
            width: 200px; 
            text-align: right;
            line-height: 1;
        }

        /* --- 2. Filter / Search Area (ç”»åƒãƒ‡ã‚¶ã‚¤ãƒ³å†ç¾) --- */
        .filter-bar {
            background-color: #e0e0e0;
            padding: 8px;
            display: flex;
            align-items: flex-start; 
            gap: 15px;
            border-bottom: 1px solid #999;
            flex-wrap: nowrap;
            overflow-x: auto;
            font-size: 15px;
            position: relative;
        }
        
        /* è¡¨ç¤ºå†…å®¹é¸æŠã®é’ã„æ ã‚’å†ç¾ */
        .filter-container-wrapper {
            border: 2px solid var(--atos-blue);
            padding: 5px 10px;
            padding-top: 15px; 
            background-color: var(--bg-white);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }
        
        /* ã€Œè¡¨ç¤ºå†…å®¹é¸æŠã€ãƒ©ãƒ™ãƒ« */
        .filter-container-wrapper::before {
            content: "è¡¨ç¤ºå†…å®¹é¸æŠ";
            position: absolute;
            left: -2px; 
            top: -2px; 
            padding: 2px 6px;
            font-size: 14px;
            color: white;
            background-color: var(--atos-blue);
            border: 2px solid var(--atos-blue); 
            border-bottom-right-radius: 4px;
            font-weight: bold;
            line-height: 1.5;
            white-space: nowrap;
        }

        .filter-label-text { 
            color: #333; 
            white-space: nowrap; 
            font-weight: bold; 
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
            line-height: 1;
        }

        /* Select/Inputã®ã‚µã‚¤ã‚ºã‚’çµ±ä¸€ */
        select, input {
            border: 1px solid #888;
            padding: 2px 4px;
            font-size: 15px;
            height: 24px; 
            border-radius: 2px; 
            font-weight: bold;
            font-family: inherit;
            box-sizing: border-box; 
            text-align: center;
        }
        
        input[type="date"] {
            width: 110px; 
            padding-right: 2px;
        }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†ç¾ */
        .date-icon {
            font-size: 20px;
            color: var(--atos-blue);
            line-height: 24px;
            cursor: default;
            margin-left: -5px;
        }
        
        .filter-group select#lineSelect {
            width: 80px; 
        }
        .filter-group select#crownSelect {
            width: 40px;
        }
        
        input#trainNoInput {
            background-color: #fff9c4; 
            border-color: #ffc107; 
            width: 60px; 
            text-align: right; 
        }
        
        .action-buttons {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            flex-shrink: 0;
            margin-top: 5px; 
        }
        
        /* æ›´æ–°ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ (ç”»åƒã«åˆã‚ã›ã¦æ¿ƒã„é’ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ä¿®æ­£) */
        .refresh-button {
            /* ç”»åƒã«åˆã‚ã›ãŸæ¿ƒã„é’ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
            background: linear-gradient(to bottom, #7BA2D4, #4B79B2); 
            color: white;
            padding: 4px 10px; 
            border: 1px solid #2C5A90; 
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 28px; 
            box-sizing: border-box;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        .refresh-button::before {
             content: "æ›´æ–°";
        }
        
        .help-icon { 
            font-size: 16px;
            color: var(--atos-blue);
            text-decoration: none;
            cursor: pointer;
            border: 2px solid var(--atos-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            font-weight: bold;
            margin-top: 2px;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .error-msg {
            color: var(--error-red);
            font-weight: bold;
            padding: 10px;
            font-size: 16px;
            background-color: var(--bg-white);
            border-bottom: 1px solid #ccc;
        }
        
        .hidden { display: none !important; }

        /* --- 3. Train Summary --- */
        .train-summary {
            background-color: var(--bg-white);
            padding: 5px 10px;
            font-size: 15px;
            border-bottom: 1px solid #ccc;
            line-height: 1.5;
            font-weight: bold;
            position: relative;
        }
        .summary-line {
            color: var(--atos-table-header); /* ç·šåŒºã¯ãƒ˜ãƒƒãƒ€ãƒ¼è‰²ã¨åŒã˜é’ç·‘ */
        }


        /* --- 4. Main Table --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            color: #000;
            table-layout: fixed;
        }

        th {
            /* ãƒ˜ãƒƒãƒ€ãƒ¼èƒŒæ™¯è‰²ã‚’é’ç·‘ã«çµ±ä¸€ */
            background-color: var(--atos-table-header);
            color: white;
            border: 1px solid var(--border-white);
            padding: 2px 5px; 
            font-weight: bold;
            white-space: nowrap;
            text-align: center;
            font-size: 14px;
            height: var(--atos-row-height); 
        }
        
        /* TH å¹…èª¿æ•´ (3åˆ†å‰²æ™‚åˆ»è¡¨ã«åˆã‚ã›ãŸå¹…è¨­å®š) */
        /* åˆ—ã®æ§‹æˆ: [åˆ—è»Šç¨®åˆ¥], [æŠ‘æ­¢], [é§…å], [ç€æ™‚åˆ» (3åˆ—)], [ç™ºæ™‚åˆ» (3åˆ—)], [ç•ªç·š], [é…å»¶(åˆ†)], [é‹ç”¨æƒ…å ±], [é‹ç”¨åˆ—ç•ª] */
        th:nth-child(1) { width: 70px; } /* åˆ—è»Šç¨®åˆ¥ */
        th:nth-child(2) { width: 30px; } /* æŠ‘æ­¢ */
        th:nth-child(3) { width: 100px; } /* é§…å */
        /* ç€æ™‚åˆ» (è¨ˆç”» + äºˆæ¸¬ + åˆ°ç€) */
        th:nth-child(4) { width: calc(var(--time-planned-width) * 2 + var(--time-status-width)); } 
        /* ç™ºæ™‚åˆ» (è¨ˆç”» + äºˆæ¸¬ + ç™ºè»Š) */
        th:nth-child(5) { width: calc(var(--time-planned-width) * 2 + var(--time-status-width)); } 
        th:nth-child(6) { width: 70px; } /* ç•ªç·š */
        th:nth-child(7) { width: 50px; } /* é…å»¶(åˆ†) - NEW */
        th:nth-child(8) { width: 40px; } /* é‹ç”¨æƒ…å ± */
        th:nth-child(9) { width: 70px; } /* é‹ç”¨åˆ—ç•ª */
        
        /* å‰¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®å¹…èª¿æ•´ (3åˆ†å‰²) */
        /* [1(è¨ˆç”»)], [2(äºˆæ¸¬)], [3(åˆ°ç€)] - ç€æ™‚åˆ» */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(1),
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(2) { 
             width: var(--time-planned-width); /* è¨ˆç”»/äºˆæ¸¬: 55px */
        } 
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(3) { 
            width: var(--time-status-width); /* åˆ°ç€: 15px */
        } 
        /* [4(è¨ˆç”»)], [5(äºˆæ¸¬)], [6(ç™ºè»Š)] - ç™ºæ™‚åˆ» */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(4),
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(5) { 
             width: var(--time-planned-width); /* è¨ˆç”»/äºˆæ¸¬: 55px */
        } 
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(6) { 
            width: var(--time-status-width); /* ç™ºè»Š: 15px */
        } 


        td {
            border: 1px solid var(--border-white);
            padding: 2px 5px;
            text-align: center;
            background-color: var(--row-gray);
            height: var(--atos-row-height); 
            font-weight: bold;
            font-size: 16px; 
            line-height: 1.2;
            vertical-align: middle;
        }
        
        /* TDã®ä½ç½®èª¿æ•´ (13åˆ—) */
        /* [1(Type)], [2(æŠ‘æ­¢)], [3(é§…å)], [4(ç€è¨ˆç”»)], [5(ç€äºˆæ¸¬)], [6(ç€åˆ°ç€)], [7(ç™ºè¨ˆç”»)], [8(ç™ºäºˆæ¸¬)], [9(ç™ºç™ºè»Š)], [10(ç•ªç·š)], [11(é…å»¶)], [12(é‹ç”¨æƒ…å ±)], [13(é‹ç”¨åˆ—ç•ª)] */
        
        .col-type { text-align: left !important; padding-left: 10px !important; }
        .col-station { text-align: left; padding-left: 10px; }
        
        /* æ™‚åˆ»è¡¨ç¤ºï¼ˆè¨ˆç”»/äºˆæ¸¬ï¼‰ã®åˆ—ã‚’å³æƒãˆã«ã™ã‚‹ */
        td:nth-child(4), td:nth-child(5), td:nth-child(7), td:nth-child(8) { 
            text-align: right !important;
            padding-right: 5px;
            font-family: inherit; 
            font-size: 16px; 
            letter-spacing: normal;
            width: var(--time-planned-width) !important;
        }
        
        /* å®Ÿç¸¾/åˆ°ç€/ç™ºè»Š åˆ— (6ç•ªç›®, 9ç•ªç›®) ã®å¹…ã‚’èª¿æ•´ */
        td:nth-child(6), td:nth-child(9) { 
            width: var(--time-status-width) !important; 
            min-width: var(--time-status-width) !important; 
            padding: 0 1px; 
            text-align: center;
        }

        /* ç•ªç·šã‚»ãƒ«ã‚’å³æƒãˆã«ã™ã‚‹ (10ç•ªç›®ã®TD) */
        td:nth-child(10) {
            text-align: right !important;
            padding-right: 5px;
        }

        /* é…å»¶(åˆ†)ã‚»ãƒ« (11ç•ªç›®ã®TD) */
        td:nth-child(11) {
            text-align: center !important;
            padding: 2px;
        }
        
        /* ãƒªãƒ³ã‚¯ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .link-text {
            color: #0000EE;
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- 5. Footer (å‡¡ä¾‹) --- */
        .footer-legend {
            background-color: var(--bg-white);
            padding: 10px 10px 5px 10px; 
            font-size: 15px;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .footer-legend::after {
            content: "";
            display: block;
            height: 150px; 
        }
    </style>
</head>
<body>
    
    <div class="system-header-tabs">
        <div class="header-tab-menu">
            <div>é‹è¡ŒæŠŠæ¡ãƒ¢ãƒ‹ã‚¿</div>
            <div>é§…é…å»¶ãƒ¢ãƒ‹ã‚¿</div>
            <div>åˆ—è»Šåœ¨ç·šãƒ¢ãƒ‹ã‚¿</div>
            <div>åˆ—è»Šæ¢ç´¢ãƒ¢ãƒ‹ã‚¿</div>
            <div>é‹è»¢è¨ˆç”»ãƒ¢ãƒ‹ã‚¿</div>
            <div class="active-tab">åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</div> <div>åŒºé–“åˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</div>
            <div>å…¥å‡ºåŒºãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</div>
        </div>
        <div class="header-sub-menu">
            <div>é‹è»¢æƒ…å ±ãƒ¢ãƒ‹ã‚¿</div>
            <div>é…å»¶è¨¼æ˜ãƒ¢ãƒ‹ã‚¿</div>
            <div>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</div>
            <div>ä»–ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒ³ã‚¯</div>
        </div>
    </div>
    
    <div id="appContainer">

        <div class="clock-area" id="clockDisplay">----/--/-- --:--:-- ç¾åœ¨</div>

        <div class="filter-bar">
            
            <div class="filter-container-wrapper">
                
                <div class="filter-group">
                    <span class="filter-label-text">ç·šåŒºï¼š</span>
                    <select id="lineSelect" onchange="performSearch()">
                        <option value="">(é¸æŠ)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label-text">æ–½è¡Œæ—¥ï¼š</span>
                    <input type="date" id="dateInput" onchange="performSearch()">
                    <span class="date-icon">ğŸ“…</span>
                </div>

                <div class="filter-group">
                    <span class="filter-label-text">åˆ—è»Šç•ªå·ï¼š</span>
                    <select id="crownSelect" style="width:50px;" onchange="performSearch()">
                        <option value=""></option>
                        <option value="å›">å›</option>
                        <option value="è©¦">è©¦</option>
                        <option value="å˜">å˜</option>
                        <option value="å·¥">å·¥</option>
                        <option value="é…">é…</option>
                        <option value="è©¦å˜">è©¦å˜</option>
                    </select>
                    <input type="text" id="trainNoInput" value="" oninput="performSearch()">
                </div>
            </div>

            <div class="action-buttons">
                <button class="refresh-button" onclick="performSearch()">
                     <img src="https://example.com/refresh-icon.png" alt="æ›´æ–°" style="display:none;"> 
                </button>
                <a href="#" class="help-icon">?</a>
            </div>
        </div>


        <div id="messageArea" class="hidden error-msg"></div>
        
        <div id="contentArea" class="hidden">
            
            <div class="train-summary" id="trainSummary">
                </div>

            <div class="monitor-table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">åˆ—è»Šç¨®åˆ¥</th>
                            <th rowspan="2">æŠ‘æ­¢</th>
                            <th rowspan="2">é§…å</th>
                            <th colspan="3">ç€æ™‚åˆ»</th> <th colspan="3">ç™ºæ™‚åˆ»</th> <th rowspan="2">ç•ªç·š</th>
                            <th rowspan="2">é…å»¶<br>(åˆ†)</th> <th rowspan="2">é‹ç”¨<br>æƒ…å ±</th>
                            <th rowspan="2">é‹ç”¨åˆ—ç•ª</th>
                        </tr>
                        <tr>
                            <th>è¨ˆç”»</th>
                            <th>äºˆæ¸¬</th>
                            <th>åˆ°ç€</th>
                            <th>è¨ˆç”»</th>
                            <th>äºˆæ¸¬</th>
                            <th>ç™ºè»Š</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>

            <div class="footer-legend">
                ã€Œ$ã€â€¦é‹ä¼‘ã€€ã€Œ*ã€â€¦é‹æ¸ˆã€€ã€Œ#ã€â€¦å¤‰æ›´ã€€ã€ŒÂ¥ã€â€¦é‹è»¢ç¦æ­¢
            </div>
        </div>
    </div> <script>
        let rawJsonData = [];
        const JSON_FILE = 'timetables.json';
        const HOLIDAY_API_URL = 'https://holidays-jp.github.io/api/v1/date.json';
        
        let holidayData = {}; 

        // æ‰€å®šãƒ€ã‚¤ãƒ¤ã®é‹è¡ŒæœŸé–“
        const PERIOD_START = new Date('2025/03/15');
        const PERIOD_END = new Date('2026/03/13');
        
        
        // =======================================================================================
        // <<<<<<<<<<<<<<<<<<<< ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° >>>>>>>>>>>>>>>>>>>>>>>>>
        // =======================================================================================
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function formatJsonDate(date) {
            if (typeof date === 'string') {
                return date.replace(/-/g, '/');
            }
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        }

        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            
            let normalized = str.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            normalized = normalized.toUpperCase().replace(/\s/g, '').trim();

            return normalized;
        }
        
        function isHoliday(date) {
            const dayOfWeek = date.getDay(); 
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return true; 
            }
            
            const dateKey = formatDate(date); 
            return holidayData.hasOwnProperty(dateKey); 
        }

        // ==========================================
        //  JSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        // ==========================================
        async function loadData() {
            try {
                const holidayResponse = await fetch(HOLIDAY_API_URL);
                if (holidayResponse.ok) {
                    holidayData = await holidayResponse.json();
                } else {
                    console.warn(`Holiday API error! status: ${holidayResponse.status}. Proceeding without external holiday data.`);
                }
                
                const dataResponse = await fetch(JSON_FILE);
                if (!dataResponse.ok) {
                    throw new Error(`HTTP error! status: ${dataResponse.status}`);
                }
                rawJsonData = await dataResponse.json();
                
            } catch (error) {
                console.error(`Error loading required data:`, error);
                document.getElementById('messageArea').innerText = `ãƒ‡ãƒ¼ã‚¿ (${JSON_FILE} ã¾ãŸã¯ ç¥æ—¥API) ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`;
                document.getElementById('messageArea').classList.remove('hidden');
            }
        }
        
        // ==========================================
        //  ãƒ¡ã‚¤ãƒ³æ¤œç´¢å‡¦ç†
        // ==========================================

        function performSearch() {
            const lineSelect = document.getElementById('lineSelect');
            const dateInput = document.getElementById('dateInput');
            const crownSelect = document.getElementById('crownSelect');
            const noInput = document.getElementById('trainNoInput');
            const messageArea = document.getElementById('messageArea'); 
            const contentArea = document.getElementById('contentArea');

            const selectedLine = lineSelect.value;
            const selectedDateUI = dateInput.value; 
            
            if (selectedDateUI === "") {
                 contentArea.classList.add('hidden');
                 messageArea.classList.add('hidden');
                 return;
            }
            
            const searchDate = new Date(selectedDateUI); 
            
            const crownPart = crownSelect.value;
            const numberPart = noInput.value;
            const targetTrainNoNormalized = normalizeString(crownPart + numberPart);
            const selectedDateJSON = formatJsonDate(searchDate);

            // UIãƒªã‚»ãƒƒãƒˆ
            contentArea.classList.add('hidden');
            messageArea.classList.add('hidden');

            
            // åˆ—è»Šç•ªå·ãŒç©ºæ¬„ã®å ´åˆã¯æ¤œç´¢çµæœã‚’è¡¨ç¤ºã—ãªã„ï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰
            if (targetTrainNoNormalized === "" || selectedLine === "" || rawJsonData.length === 0) {
                return;
            }
            
            // æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            const isTargetHoliday = isHoliday(searchDate);
            const searchDayType = isTargetHoliday ? "åœŸä¼‘æ—¥" : "å¹³æ—¥";
            const searchTime = searchDate.getTime();
            
            let result = null;
            
            // 1. ç‰¹å®šæ—¥ãƒ€ã‚¤ãƒ¤æ¤œç´¢ (startDate å®Œå…¨ä¸€è‡´)
            result = rawJsonData.find(d => 
                d.line === selectedLine &&
                normalizeString(d.trainNumber) === targetTrainNoNormalized &&
                d.startDate === selectedDateJSON
            );
            
            if (result) {
                updateSummaryAndTable(result, selectedLine, selectedDateJSON, crownPart, numberPart);
                return;
            }

            // 2. æ‰€å®šãƒ€ã‚¤ãƒ¤æ¤œç´¢ (dayType / æœŸé–“ãƒãƒƒãƒ)
            const isInPeriod = (searchTime >= PERIOD_START.getTime() && searchTime <= PERIOD_END.getTime());
            
            if (isInPeriod) {
                result = rawJsonData.find(d => {
                    if (d.line !== selectedLine || normalizeString(d.trainNumber) !== targetTrainNoNormalized) {
                        return false;
                    }
                    
                    const dataDayType = d.dayType || ""; 
                    const standardStartDates = ['2025/03/15', '2025/03/17', '2026/03/14']; 

                    if (standardStartDates.includes(d.startDate)) {
                        if (dataDayType === "" || dataDayType === searchDayType) {
                            return true;
                        }
                    }
                    
                    return false;
                });
            }

            // --- çµæœè¡¨ç¤º ---
            if (result) {
                updateSummaryAndTable(result, selectedLine, selectedDateJSON, crownPart, numberPart);
            } else {
                contentArea.classList.add('hidden');
                
                messageArea.innerText = `æ¤œç´¢ã—ãŸåˆ—è»Šç•ªå· (${crownPart}${numberPart}) ã®ãƒ€ã‚¤ãƒ¤ (${selectedLine}, æ–½è¡Œæ—¥:${selectedDateJSON}, æ›œæ—¥:${searchDayType}) ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
                messageArea.classList.remove('hidden');
            }
        }
        
        /**
         * æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®è¡¨ç¤ºæ›´æ–°å‡¦ç†
         */
        function updateSummaryAndTable(result, selectedLine, selectedDateJSON, crownPart, numberPart) {
            document.getElementById('contentArea').classList.remove('hidden');
            document.getElementById('messageArea').classList.add('hidden');

            // Summaryè¡¨ç¤ºã®ä¿®æ­£
            document.getElementById('trainSummary').innerHTML = 
                `<span class="summary-line">â– ${selectedLine}</span> æ–½è¡Œæ—¥:${selectedDateJSON}<br>` +
                `é‹è»¢åŒºé–“:${result.origin}ï½${result.destination} åˆ—è»Šç•ªå·: ${crownPart}${numberPart}`;

            updateSystemClock(selectedDateJSON);
            renderTable(result);
        }

        // ==========================================
        //  ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å‡¦ç† (3åˆ†å‰²æ™‚åˆ»è¡¨ã«å¯¾å¿œ)
        // ==========================================

        function renderTable(data) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            const totalStops = data.stops.length;

            data.stops.forEach((stop, index) => {
                const tr = document.createElement('tr');
                
                const typeText = (index === 0) ? data.type : '';
                
                let opInfo = ""; 
                let opNum = "";
                let currentKid = data.kid || ''; 

                // é‹ç”¨æƒ…å ± / é‹ç”¨åˆ—ç•ª ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
                if (index === 0) {
                    if (data.tt1 === "k") opInfo = "ç¶™é€";
                    else if (data.tt1 === "o") opInfo = "æŠ˜è¿”";
                    
                    if (data.tr1) {
                        const kidToPass = data.kid1 || currentKid; 
                        opNum = `<span class="link-text" onclick="jumpToTrain('${data.tr1}', '${kidToPass}', 'prev')">${data.tr1}</span>`;
                    }
                } else if (index === totalStops - 1) {
                    if (data.tt2 === "k") opInfo = "ç¶™é€";
                    else if (data.tt2 === "o") opInfo = "æŠ˜è¿”";

                    if (data.tr2) {
                        const kidToPass = data.kid2 || currentKid; 
                        opNum = `<span class="link-text" onclick="jumpToTrain('${data.tr2}', '${kidToPass}', 'next')">${data.tr2}</span>`;
                    }
                }
                
                // â˜…ä¿®æ­£: 13åˆ—ã®TDã‚’ç”Ÿæˆ
                tr.innerHTML = `
                    <td class="col-type">${typeText}</td> 
                    <td></td> <td class="col-station">${stop.station}</td>
                    
                    <td class="col-time">${stop.arrival || ''}</td> <td></td> <td></td> <td class="col-time">${stop.departure || ''}</td> <td></td> <td></td> <td>${stop.trackN}</td> <td></td> <td>${opInfo}</td> <td>${opNum}</td> `;

                tbody.appendChild(tr);
            });
        }

        /**
         * é‹ç”¨åˆ—ç•ªã®ãƒªãƒ³ã‚¯ã‚¸ãƒ£ãƒ³ãƒ—å‡¦ç† (å¤‰æ›´ãªã—)
         */
        function jumpToTrain(targetTrainNum, currentKid, direction) {
            if (rawJsonData.length === 0) return;

            const targetTrainNumNormalized = normalizeString(targetTrainNum);
            const currentKidNormalized = normalizeString(currentKid);
            const selectedDateJSON = document.getElementById('dateInput').value.replace(/-/g, '/');

            let match = null;
            
            const candidates = rawJsonData.filter(d => 
                normalizeString(d.trainNumber) === targetTrainNumNormalized
            );
            
            // 1. kid ãƒãƒƒãƒãƒ³ã‚°
            if (currentKidNormalized !== "") {
                if (direction === 'prev') {
                    match = candidates.find(d => 
                        normalizeString(d.kid2 || '') === currentKidNormalized
                    );
                } 
                else if (direction === 'next') {
                    match = candidates.find(d => 
                        normalizeString(d.kid1 || '') === currentKidNormalized
                    );
                }
            }

            // 2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (!match) {
                 match = candidates.find(d => d.startDate === selectedDateJSON);
                 
                 if (!match && candidates.length > 0) {
                     match = candidates[0];
                 }
            }


            if (match) {
                document.getElementById('lineSelect').value = match.line;
                
                const trainNum = match.trainNumber;
                let crown = match.crown || "";
                let numOnly = trainNum;

                if (crown && trainNum.startsWith(crown)) {
                    numOnly = trainNum.substring(crown.length);
                } else {
                    const potentialCrowns = ["å›", "è©¦", "å˜", "å·¥", "é…", "è©¦å˜"];
                    for (const pc of potentialCrowns) {
                        if (trainNum.startsWith(pc)) {
                            crown = pc;
                            numOnly = trainNum.substring(pc.length);
                            break;
                        }
                    }
                }
                document.getElementById('crownSelect').value = crown;
                document.getElementById('trainNoInput').value = numOnly;

                performSearch();

            } else {
                document.getElementById('messageArea').innerText = `ãƒªãƒ³ã‚¯å…ˆã®åˆ—è»Šç•ªå· (${targetTrainNum}) ã«å¯¾å¿œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
                document.getElementById('messageArea').classList.remove('hidden');
                document.getElementById('contentArea').classList.add('hidden');
            }
        }

        /**
         * ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»è¡¨ç¤ºã®æ›´æ–° (ç”»åƒã«åˆã‚ã›ãŸæ›¸å¼ã«å¾®ä¿®æ­£)
         */
        function updateSystemClock(dateStr) {
            if (!dateStr) return;
            try {
                // é¸æŠã•ã‚ŒãŸæ–½è¡Œæ—¥ã‹ã‚‰éå»ã®é©å½“ãªæ™‚åˆ»ã‚’ç”Ÿæˆï¼ˆç”»åƒã«åˆã‚ã›ã‚‹ï¼‰
                const d = new Date(dateStr);
                d.setDate(d.getDate() - 2); 
                d.setHours(22, 48);
                d.setMinutes(49); // é©å½“ã«åˆ†ã‚‚ä¿®æ­£
                const randomSec = Math.floor(Math.random() * 60);
                d.setSeconds(randomSec);

                const fmt = (n) => String(n).padStart(2, '0');
                // YYYY/MM/DD HH:MM:SS ç¾åœ¨ ã®å½¢å¼
                const str = `${d.getFullYear()}/${fmt(d.getMonth()+1)}/${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} ç¾åœ¨`;
                
                document.getElementById('clockDisplay').innerText = str;
            } catch(e) {}
        }
        
        // ==========================================
        //  APP ENTRY POINT (window.onload)
        // ==========================================
        window.onload = async function() {
            // â˜…ä¿®æ­£: åˆæœŸæ—¥ä»˜ã‚’ç¾åœ¨ã®æ—¥ä»˜ã«ã‚»ãƒƒãƒˆ
            document.getElementById('dateInput').value = formatDate(new Date()); 
            
            await loadData();
            
            populateLines(); 
            
            // â˜…ä¿®æ­£: åˆæœŸç·šåŒºã¯ (é¸æŠ)ã€åˆ—è»Šç•ªå·ã¯ç©ºæ¬„ã®ã¾ã¾
            document.getElementById('lineSelect').value = ''; 
            document.getElementById('crownSelect').value = '';
            document.getElementById('trainNoInput').value = '';
            
            // åˆ—è»Šç•ªå·ãŒç©ºæ¬„ã®ãŸã‚ã€performSearch()ãŒå®Ÿè¡Œã•ã‚Œã¦ã‚‚æ™‚åˆ»è¡¨ç¤ºã¯ã•ã‚Œãªã„
            performSearch(); 
        };

        function populateLines() {
            const select = document.getElementById('lineSelect');
            select.innerHTML = '<option value="">(é¸æŠ)</option>';

            if (rawJsonData.length === 0) return;

            const lines = [...new Set(rawJsonData.map(d => d.line))].sort();
            
            lines.forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.text = line;
                
                select.appendChild(option);
            });
        }
    </script>
</body>
</html>
