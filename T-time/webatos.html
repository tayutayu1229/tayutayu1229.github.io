<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebATOS - 列車別ダイヤモニタ</title>
    <style>
        /* ===========================================================
         【 色設定エリア 】
         画像を参考に、薄い青灰色のヘッダーと、明るい灰色の行を設定。
         ===========================================================
        */
        :root {
            /* ▼ テーブルヘッダー背景色 (画像のような薄い青灰/スレート色 #78909C に変更) */
            --atos-table-header: #78909C; 
            
            /* その他基本色 */
            --bg-white: #ffffff;
            /* テーブルの行の背景色を薄いグレーに変更 (すべての行に適用) */
            --row-gray: #f0f0f0; 
            --text-black: #222;
            /* 罫線を濃くしてハッキリと */
            --border-white: #666; 
            --error-red: #ff0000;
            
            /* ==================================================
             ★★★ 幅・高さ調整エリア ★★★
             -------------------------------------------------- */
            /* ▼ 着時刻・発時刻の「到着/発車」(実績) の幅 (狭い方の列) */
            --time-status-width: 8px; /* 縮小 */
            /* ▼ テーブルの行の高さ (縦幅) */
            --atos-row-height: 23px; 
            /* 計画時刻の幅を広く確保 */
            --plan-time-width: 110px; /* 拡大 */
            /* ================================================== */
        }
        /* =========================================================== */

        /* 全体のフォントをMS Gothicに統一し、太字を適用 */
        body {
            font-family: "MS Gothic", "MS PGothic", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg-white);
            margin: 0;
            padding: 0;
            font-size: 15px;
            color: var(--text-black);
            overflow-x: hidden;
            font-weight: bold;
        }
        
        /* 左右余白を持たせ、幅によって調整するためのコンテナ */
        #appContainer {
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 5px; 
        }
        
        /* --- 1. Header (ナビゲーションタブ風) --- */
        .system-header {
            background: #f0f0f0; 
            padding: 0;
            display: block; 
            border-bottom: 2px solid #999; 
            height: auto; 
        }
        
        .header-tab-menu {
            display: flex;
            flex-wrap: nowrap; 
            gap: 1px;
            overflow-x: auto;
        }
        .header-tab-menu div {
            background-color: #ddd; 
            border: 1px solid #aaa;
            padding: 5px 10px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            margin-bottom: -1px; 
            cursor: pointer;
            flex-shrink: 0;
            border-radius: 2px 2px 0 0;
            white-space: nowrap;
        }
        /* アクティブタブのスタイル */
        .header-tab-menu .active-tab {
            background-color: var(--atos-table-header); 
            color: white;
            border-color: var(--atos-table-header);
            border-bottom-color: var(--atos-table-header); 
        }
        
        .header-title, .clock-area, .icon-menu { 
            display: none !important; 
        }


        /* --- 2. Filter / Search Area --- */
        .filter-bar {
            background-color: var(--bg-white);
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #999;
            flex-wrap: nowrap;
            overflow-x: auto;
            font-size: 15px;
            justify-content: flex-start;
        }
        
        /* ★ 2-1. 表示内容選択の囲み全体 */
        .filter-container {
            display: flex;
            align-items: center;
            gap: 10px; /* グループ間の間隔 */
            padding: 2px 10px 2px 5px; /* 囲み内のパディング */
            border: 1px solid #777; /* 薄めの黒色の枠線 */
            background-color: var(--bg-white); /* 囲まれた領域の背景色 */
            position: relative;
        }
        
        /* ★ 2-2. 「表示内容選択」ラベルのスタイル (画像に合わせて変更) */
        .filter-container::before {
            content: "表示内容選択 |";
            position: absolute;
            left: -1px; 
            top: -1px;
            padding: 2px 6px;
            font-size: 14px;
            color: #333;
            background-color: #e0e0e0; /* ラベルの背景色 */
            border-right: 1px solid #777;
            border-bottom: 1px solid #777;
            font-weight: bold;
            line-height: 1.5;
            white-space: nowrap;
        }
        
        /* 「表示内容選択」の幅を確保するため、コンテンツを右にずらす */
        .filter-container > *:first-child {
            margin-left: 105px; 
        }

        .filter-label-text { color: #333; white-space: nowrap; }
        
        /* 施行日と列車番号のラベルは、画像のように細字で左揃えにする */
        .filter-group .filter-label-text {
            font-weight: normal; 
            text-align: left;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        /* Select/Inputのサイズを統一 */
        select, input {
            border: 1px solid #888;
            padding: 2px 4px;
            font-size: 15px;
            height: 28px; 
            border-radius: 0; 
            font-weight: bold;
            font-family: inherit;
            box-sizing: border-box; 
            text-align: center;
        }
        
        input[type="date"] {
            width: 120px; 
        }
        
        .filter-group select {
            width: 70px; /* 線区のドロップダウンは少し広めに */
        }
        .filter-group select#lineSelect {
            width: 100px; 
        }
        .filter-group select#crownSelect {
            width: 50px;
        }
        
        input#trainNoInput {
            background-color: #ffffcc; 
            border-color: #ffcc00; 
            width: 60px; 
        }
        
        .action-buttons {
            margin-left: auto; 
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        /* ★ 2-3. 更新ボタンのデザインを画像に合わせる */
        .refresh-button {
            /* 緑色のグラデーション */
            background: linear-gradient(to bottom, #66BB6A, #4CAF50); 
            color: white;
            padding: 5px 12px;
            border: 1px solid #000; /* 普通の黒色枠 */
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            height: 28px;
            box-sizing: border-box;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .refresh-button::before {
            content: "↻";
            font-size: 18px;
            line-height: 1;
            margin-right: -2px;
        }
        
        .help-icon { 
            font-size: 20px;
            color: #555;
            text-decoration: none;
            cursor: pointer;
            border: 1px solid #555;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }


        /* --- 3. Train Summary --- */
        .train-summary {
            background-color: #eee;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            border-bottom: 1px solid #ccc;
            line-height: 1.5;
            font-weight: bold;
        }
        
        .summary-text {
            font-size: 15px;
            font-weight: bold;
            line-height: 1.5;
        }
        
        .status-time {
            font-size: 14px;
            color: #555;
            white-space: nowrap;
        }

        /* --- 4. Main Table --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
            color: #000;
            table-layout: fixed;
        }

        th {
            background-color: var(--atos-table-header);
            color: white;
            border: 1px solid var(--border-white);
            padding: 4px 5px; 
            font-weight: bold;
            white-space: nowrap;
            text-align: center;
            font-size: 15px;
            height: auto; 
        }
        
        /* TH 幅調整 */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(1) { width: 70px; } 
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(2) { width: 30px; } 
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(3) { width: 100px; } 
        
        /* 着時刻 (colspan 2) - 計画(110px) + 到着(8px) = 118px */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(4) { 
            width: calc(var(--plan-time-width) + var(--time-status-width)); 
        } 
        /* 発時刻 (colspan 2) - 計画(110px) + 発車(8px) = 118px */
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(5) { 
            width: calc(var(--plan-time-width) + var(--time-status-width)); 
        }
        
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(6) { width: 70px; } 
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(7) { width: 40px; } 
        .monitor-table-container table thead tr:nth-child(1) th:nth-child(8) { width: 70px; } 

        /* 副ヘッダーの幅調整 */
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(1) { width: var(--plan-time-width); } /* 着時刻-計画 (拡大) */
        .monitor-table-container table tbody tr td:nth-child(4) { width: var(--plan-time-width); } /* TDにも反映 */
        
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(2) { width: var(--time-status-width); } /* 着時刻-到着 (縮小) */
        
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(3) { width: var(--plan-time-width); } /* 発時刻-計画 (拡大) */
        .monitor-table-container table tbody tr td:nth-child(6) { width: var(--plan-time-width); } /* TDにも反映 */
        
        .monitor-table-container table thead tr:nth-child(2) th:nth-child(4) { width: var(--time-status-width); } /* 発時刻-発車 (縮小) */

        td {
            border: 1px solid var(--border-white);
            padding: 2px 5px;
            text-align: center;
            background-color: var(--row-gray); 
            height: var(--atos-row-height); 
            font-weight: bold;
            font-size: 15px; 
            line-height: 1.2;
            vertical-align: middle;
        }
        
        /* TDの位置調整 */
        /* [1(種別)], [2(抑止)], [3(駅名)], [4(着計画)], [5(着実績)], [6(発計画)], [7(発実績)], [8(番線)], [9(運用情報)], [10(運用列番)] */
        .col-type { text-align: left !important; padding-left: 10px !important; }
        .col-station { text-align: left; padding-left: 10px; }
        
        /* 時刻表示（計画）の列を右揃えにする */
        td:nth-child(4), td:nth-child(6) { 
            text-align: right !important;
            padding-right: 5px;
            font-family: inherit; 
            font-size: 16px; 
            letter-spacing: normal;
        }
        
        /* 実績/到着/発車 列 (5番目, 7番目) の幅を調整 */
        td:nth-child(5), td:nth-child(7) { 
            /* 幅をCSS変数でコントロール */
            width: var(--time-status-width) !important; 
            min-width: var(--time-status-width) !important; 
            padding: 0 1px; /* 内部パディングも減らしてコンパクトに */
            text-align: center;
        }

        /* 番線セルを右揃えにする (8番目のTD) */
        td:nth-child(8) {
            text-align: right !important;
            padding-right: 5px;
        }
        
        .link-text {
            color: #000;
            text-decoration: none; 
            cursor: pointer;
            font-weight: bold;
        }
        
        .error-msg {
            color: var(--error-red);
            font-weight: bold;
            padding: 10px;
            font-size: 16px;
            background-color: var(--bg-white);
            border-bottom: 1px solid #ccc;
        }

        /* --- 5. Footer (凡例) --- */
        .footer-legend {
            background-color: var(--bg-white);
            padding: 10px 10px 5px 10px; 
            font-size: 15px;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .footer-legend::after {
            content: "";
            display: block;
            height: 30px; 
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <div class="system-header">
        <div class="header-tab-menu">
            <div>運行把握モニタ</div>
            <div>駅遅延モニタ</div>
            <div>列車在線モニタ</div>
            <div>列車探索モニタ</div>
            <div>運転計画モニタ</div>
            <div class="active-tab">列車別ダイヤモニタ</div>
            <div>区間別ダイヤモニタ</div>
            <div>入出区ダイヤモニタ</div>
        </div>
        <div class="header-tab-menu">
            <div>運転情報モニタ</div>
            <div>遅延証明モニタ</div>
            <div>アカウント設定</div>
            <div>他システムリンク</div>
        </div>
    </div>
    
    <div id="appContainer">

        <div class="filter-bar">
            
            <div class="filter-container">
                
                <div class="filter-group">
                    <span class="filter-label-text">線区：</span>
                    <select id="lineSelect" onchange="performSearch()">
                        <option value="">(選択)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label-text">施行日：</span>
                    <input type="date" id="dateInput" onchange="performSearch()">
                </div>
    
                <div class="filter-group">
                    <span class="filter-label-text">列車番号：</span>
                    <select id="crownSelect" onchange="performSearch()">
                        <option value=""></option>
                        <option value="回">回</option>
                        <option value="試">試</option>
                        <option value="単">単</option>
                        <option value="工">工</option>
                        <option value="配">配</option>
                        <option value="試単">試単</option>
                    </select>
                    <input type="text" id="trainNoInput" value="" placeholder="9875" oninput="performSearch()">
                </div>
            </div>

            <div class="action-buttons">
                <div class="refresh-button">更新</div>
                <a href="#" class="help-icon">?</a>
            </div>
        </div>

        <div id="messageArea" class="hidden error-msg"></div>
        
        <div id="contentArea" class="hidden">
            
            <div class="train-summary" id="trainSummary">
                <div class="summary-text">
                    ■線区 施行日:YYYY/MM/DD<br>
                    運転区間:始発駅～終着駅 列車番号: 
                </div>
                <div class="status-time" id="clockDisplay">----/--/-- --:--:-- 現在</div>
            </div>

            <div class="monitor-table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">列車種別</th>
                            <th rowspan="2">抑止</th>
                            <th rowspan="2">駅名</th>
                            <th colspan="2">着時刻</th>
                            <th colspan="2">発時刻</th>
                            <th rowspan="2">番線</th>
                            <th rowspan="2">運用<br>情報</th>
                            <th rowspan="2">運用列番</th>
                        </tr>
                        <tr>
                            <th>計画</th>
                            <th>到着</th>
                            <th>計画</th>
                            <th>発車</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>

            <div class="footer-legend">
                凡例：「$」…運休　「*」…運済　「#」…変更　「¥」…運転禁止
            </div>
        </div>
    </div> 
    
    <script>
        let rawJsonData = [];
        const JSON_FILE = 'timetables.json'; 
        const HOLIDAY_API_URL = 'https://holidays-jp.github.io/api/v1/date.json';
        
        let holidayData = {}; 

        const PERIOD_START = new Date('2025/03/15');
        const PERIOD_END = new Date('2026/03/13');
        
        
        // =======================================================================================
        // <<<<<<<<<<<<<<<<<<<< ユーティリティ関数 >>>>>>>>>>>>>>>>>>>>>>>>>
        // =======================================================================================
        
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        
        function formatJsonDate(date) {
            if (typeof date === 'string') {
                return date.replace(/-/g, '/');
            }
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        }

        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            
            let normalized = str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            normalized = normalized.toUpperCase().replace(/\s/g, '').trim();

            return normalized;
        }
        
        function normalizeKid(kid) {
            return (typeof kid === 'string' || typeof kid === 'number') ? String(kid).trim() : '';
        }

        function isHoliday(date) {
            const dayOfWeek = date.getDay(); 
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                return true; 
            }
            
            const dateKey = formatDate(date); 
            return holidayData.hasOwnProperty(dateKey); 
        }

        // ==========================================
        //  JSONデータ読み込み
        // ==========================================
        async function loadData() {
            try {
                // 1. 祝日データの読み込み
                const holidayResponse = await fetch(HOLIDAY_API_URL);
                if (holidayResponse.ok) {
                    holidayData = await holidayResponse.json();
                } else {
                    console.warn(`Holiday API error: ${holidayResponse.status}.`);
                }
                
                // 2. ダイヤデータの読み込み
                const dataResponse = await fetch(JSON_FILE);
                
                if (!dataResponse.ok) {
                    throw new Error(`HTTP error! status: ${dataResponse.status}`);
                } 
                
                rawJsonData = await dataResponse.json();
                
            } catch (error) {
                console.error(`Error loading data:`, error);
                const message = error.message.includes("HTTP error! status: 404") 
                    ? `ダイヤファイル (${JSON_FILE}) が見つかりません。ファイルが同じ階層に存在するか確認してください。`
                    : `データ (${JSON_FILE}) の読み込み中に予期せぬエラーが発生しました。JSONの形式を確認してください。`;
                
                document.getElementById('messageArea').innerText = message;
                document.getElementById('messageArea').classList.remove('hidden');
                
                rawJsonData = [];
            }
        }
        
        // ==========================================
        //  メイン検索処理
        // ==========================================

        function performSearch() {
            const lineSelect = document.getElementById('lineSelect');
            const dateInput = document.getElementById('dateInput');
            const crownSelect = document.getElementById('crownSelect');
            const noInput = document.getElementById('trainNoInput');
            const messageArea = document.getElementById('messageArea'); 
            const contentArea = document.getElementById('contentArea');

            const selectedLine = lineSelect.value;
            const selectedDateUI = dateInput.value; 
            
            // UIリセット
            contentArea.classList.add('hidden');
            messageArea.classList.add('hidden');
            document.getElementById('scheduleBody').innerHTML = '';
            document.getElementById('clockDisplay').innerText = `----/--/-- --:--:-- 現在`;

            if (rawJsonData.length === 0) {
                 messageArea.innerText = `ダイヤデータがロードされていません。${JSON_FILE}ファイルを確認してください。`;
                 messageArea.classList.remove('hidden');
                 return;
            }

            if (selectedDateUI === "" || selectedLine === "" || noInput.value === "") {
                 return;
            }
            
            const searchDate = new Date(selectedDateUI); 
            const crownPart = crownSelect.value;
            const numberPart = noInput.value;
            const targetTrainNoFull = crownPart + numberPart; 
            const targetTrainNoNormalized = normalizeString(targetTrainNoFull);
            const selectedDateJSON = formatJsonDate(searchDate); 

            
            // 検索パラメータ
            const isTargetHoliday = isHoliday(searchDate);
            const searchDayType = isTargetHoliday ? "土休日" : "平日";
            const searchTime = searchDate.getTime();
            
            let result = null;
            
            // 1. 最優先：特定日ダイヤ検索 (線区、列車番号、施行日 完全一致)
            result = rawJsonData.find(d => 
                d.line === selectedLine &&
                normalizeString(d.trainNumber) === targetTrainNoNormalized &&
                d.startDate === selectedDateJSON
            );
            
            if (result) {
                updateSummaryAndTable(result, selectedLine, selectedDateJSON, targetTrainNoFull);
                return;
            }

            // 2. 第2優先：所定ダイヤ検索 (dayType / 期間マッチ)
            
            const isInPeriod = (searchTime >= PERIOD_START.getTime() && searchTime <= PERIOD_END.getTime());
            
            if (isInPeriod) {
                const standardStartDates = ['2025/03/15', '2025/03/17']; 

                result = rawJsonData.find(d => {
                    if (d.line !== selectedLine || normalizeString(d.trainNumber) !== targetTrainNoNormalized) {
                        return false;
                    }
                    
                    const dataDayType = d.dayType || ""; 
                    
                    if (dataDayType === "") {
                        if (standardStartDates.includes(d.startDate)) {
                             return true;
                        }
                    } 
                    
                    else if (dataDayType === searchDayType) {
                        if (standardStartDates.includes(d.startDate)) { 
                            return true;
                        }
                    }
                    
                    return false;
                });
            }

            // --- 結果表示 ---
            if (result) {
                updateSummaryAndTable(result, selectedLine, selectedDateJSON, targetTrainNoFull);
            } else {
                
                messageArea.innerText = `検索した列車番号 (${targetTrainNoFull}) のダイヤ (${selectedLine}, 施行日:${selectedDateJSON}, 曜日:${searchDayType}) は見つかりませんでした。`;
                messageArea.classList.remove('hidden');
            }
        }
        
        /**
         * 検索結果が見つかった場合の表示更新処理
         */
        function updateSummaryAndTable(result, selectedLine, selectedDateJSON, targetTrainNoFull) {
            document.getElementById('contentArea').classList.remove('hidden');
            document.getElementById('messageArea').classList.add('hidden');

            // 運転区間サマリーの更新
            document.querySelector('.summary-text').innerHTML = 
                `■${selectedLine} 施行日:${selectedDateJSON}<br>` +
                `運転区間:${result.origin}～${result.destination} 列車番号: ${targetTrainNoFull}`;

            // 時計表示を更新
            updateSystemClock(selectedDateJSON);
            renderTable(result);
        }

        // ==========================================
        //  テーブル描画処理
        // ==========================================

        function renderTable(data) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            const totalStops = data.stops.length;

            data.stops.forEach((stop, index) => {
                const tr = document.createElement('tr');
                
                const typeText = (index === 0) ? data.type : '';
                
                let opInfo = ""; 
                let opNum = ""; 
                
                // 運用情報 / 運用列番 の判定ロジック
                if (index === 0) {
                    if (data.tt1 === "k") opInfo = "継走";
                    else if (data.tt1 === "o") opInfo = "折返";
                    // tr1 (前列車) のリンク。kid1 (現在の列車への「入り」のKid) を渡す。
                    if (data.tr1) {
                        const targetKid = normalizeKid(data.kid1); 
                        opNum = `<span class="link-text" onclick="jumpToTrain('${data.tr1}', '${targetKid}', 'prev')">${data.tr1}</span>`;
                    }
                } else if (index === totalStops - 1) {
                    if (data.tt2 === "k") opInfo = "継走";
                    else if (data.tt2 === "o") opInfo = "折返";
                    // tr2 (後列車) のリンク。kid2 (現在の列車からの「出」のKid) を渡す。
                    if (data.tr2) {
                        const targetKid = normalizeKid(data.kid2); 
                        opNum = `<span class="link-text" onclick="jumpToTrain('${data.tr2}', '${targetKid}', 'next')">${data.tr2}</span>`;
                    }
                }
                

                // HTML生成
                // TDの位置: [1(種別)], [2(抑止)], [3(駅名)], [4(着計画)], [5(着実績)], [6(発計画)], [7(発実績)], [8(番線)], [9(運用情報)], [10(運用列番)]
                tr.innerHTML = `
                    <td class="col-type">${typeText}</td> 
                    <td></td> <td class="col-station">${stop.station}</td>
                    
                    <td class="col-time">${stop.arrival || '...'}</td> <td></td> <td class="col-time">${stop.departure || '...'}</td> <td></td> <td>${stop.trackN || ''}</td> <td>${opInfo}</td> <td>${opNum}</td> `;

                tbody.appendChild(tr);
            });
        }

        /**
         * 運用列番のリンクジャンプ処理 (kid対応版)
         */
        function jumpToTrain(targetTrainNum, targetKid, direction) {
            if (rawJsonData.length === 0) {
                document.getElementById('messageArea').innerText = `ダイヤデータがロードされていません。リンク機能が動作しません。`;
                document.getElementById('messageArea').classList.remove('hidden');
                document.getElementById('contentArea').classList.add('hidden');
                return;
            }

            const targetTrainNumNormalized = normalizeString(targetTrainNum);
            const normalizedTargetKid = normalizeKid(targetKid);
            const selectedDateJSON = document.getElementById('dateInput').value.replace(/-/g, '/');

            let match = null;

            // 1. **kid マッチング (最優先)**: 列車番号、施行日、Kidの連結ロジックが一致するもの
            if (normalizedTargetKid !== "") {
                match = rawJsonData.find(d => {
                    // 必須条件: 列車番号と施行日が一致
                    if (normalizeString(d.trainNumber) !== targetTrainNumNormalized || d.startDate !== selectedDateJSON) {
                        return false;
                    }
                    
                    // 継走ロジック:
                    // 'prev' (前列車へ): リンク先の列車 (d) の後継走 kid2 が、現在の列車から渡された kid1 と一致すること
                    if (direction === 'prev') {
                        return normalizeKid(d.kid2) === normalizedTargetKid;
                    } 
                    // 'next' (後列車へ): リンク先の列車 (d) の前継走 kid1 が、現在の列車から渡された kid2 と一致すること
                    else if (direction === 'next') {
                        return normalizeKid(d.kid1) === normalizedTargetKid;
                    }
                    return false;
                });
            }

            // 2. **kid マッチングに失敗した場合、列車番号と施行日で再検索 (フォールバック)**
            if (!match) {
                 match = rawJsonData.find(d => 
                    normalizeString(d.trainNumber) === targetTrainNumNormalized &&
                    d.startDate === selectedDateJSON
                 );
            }
            
            if (match) {
                // 検索窓の線区と列車番号を更新
                document.getElementById('lineSelect').value = match.line;
                
                const trainNum = match.trainNumber;
                let crown = match.crown || "";
                let numOnly = trainNum;

                if (crown && trainNum.startsWith(crown)) {
                    numOnly = trainNum.substring(crown.length);
                    crown = match.crown; 
                } else {
                    // crownがJSONにない場合、列車番号から自動検出を試みる
                    const potentialCrowns = ["回", "試", "単", "工", "配", "試単"];
                    for (const pc of potentialCrowns) {
                        if (trainNum.startsWith(pc)) {
                            crown = pc;
                            numOnly = trainNum.substring(pc.length);
                            break;
                        }
                    }
                    if (crown === "") {
                        numOnly = trainNum;
                    }
                }
                
                document.getElementById('crownSelect').value = crown;
                document.getElementById('trainNoInput').value = numOnly;

                // 検索実行
                performSearch();

            } else {
                const errorMessage = `リンク先の列車番号 (${targetTrainNum}) に対応するダイヤが見つかりませんでした。(Kid: ${normalizedTargetKid}, 施行日: ${selectedDateJSON})`;
                document.getElementById('messageArea').innerText = errorMessage;
                document.getElementById('messageArea').classList.remove('hidden');
                document.getElementById('contentArea').classList.add('hidden');
            }
        }

        /**
         * システム時刻表示の更新 (施行日の2日前の22時45分ランダム秒)
         */
        function updateSystemClock(dateStr) {
            if (!dateStr) return;
            try {
                const d = new Date(dateStr);
                d.setDate(d.getDate() - 2); 
                d.setHours(22, 45, 0, 0); 
                const randomSec = Math.floor(Math.random() * 60);
                d.setSeconds(randomSec);

                const fmt = (n) => String(n).padStart(2, '0');
                const str = `${d.getFullYear()}/${fmt(d.getMonth()+1)}/${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())} 現在`;
                
                document.getElementById('clockDisplay').innerText = str;
            } catch(e) {
                console.error("Failed to set clock display:", e);
                document.getElementById('clockDisplay').innerText = `----/--/-- --:--:-- 現在`;
            }
        }
        
        // ==========================================
        //  APP ENTRY POINT (window.onload)
        // ==========================================
        window.onload = async function() {
            // 初期日付をデモ値にセット
            document.getElementById('dateInput').value = '2025-09-18'; 
            
            await loadData();
            
            populateLines(); 
            
            if (rawJsonData.length > 0) {
                 // 東海支社のデモ列車(単9875)を初期値にセット (JSONデータに依存するため、存在しない場合は最初の列車を採用)
                 const demoData = rawJsonData.find(d => d.line === "東海道" && d.trainNumber.includes("9875"));
                 const initialData = demoData || rawJsonData[0];
                 
                 document.getElementById('lineSelect').value = initialData.line;
                 
                 let crown = initialData.crown || "";
                 let trainNumOnly = initialData.trainNumber;
                 
                 // 列車番号から冠を取り出す処理
                 if (crown && initialData.trainNumber.startsWith(crown)) {
                    trainNumOnly = initialData.trainNumber.substring(crown.length);
                 } else {
                     const potentialCrowns = ["回", "試", "単", "工", "配", "試単"];
                     for (const pc of potentialCrowns) {
                         if (initialData.trainNumber.startsWith(pc)) {
                             crown = pc;
                             trainNumOnly = initialData.trainNumber.substring(pc.length);
                             break;
                         }
                     }
                 }
                 
                 document.getElementById('crownSelect').value = crown;
                 document.getElementById('trainNoInput').value = trainNumOnly;
                 
                 performSearch(); 
            } else {
                 // データがロードできなかった場合は、エラーメッセージが表示されているはず
            }
        };

        /**
         * JSONデータから一意の線区名を抽出し、ドロップダウンを生成
         */
        function populateLines() {
            const select = document.getElementById('lineSelect');
            select.innerHTML = '<option value="">(選択)</option>';

            if (rawJsonData.length === 0) return;

            const lines = [...new Set(rawJsonData.map(d => d.line).filter(Boolean))].sort();
            
            lines.forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.text = line;
                
                select.appendChild(option);
            });
        }
    </script>
</body>
</html>
