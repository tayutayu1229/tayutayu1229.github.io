<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JRF 運行管理：シンプルエクスプローラー</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* 貨物カラーと無骨なデザイン */
        body { background: #888; margin: 0; font-family: "MS UI Gothic", sans-serif; display: flex; flex-direction: column; height: 100vh; }
        header { background: #b22222; color: white; padding: 5px 15px; border-bottom: 2px solid #000033; font-size: 14px; font-weight: bold; }
        #main { display: flex; flex: 1; overflow: hidden; gap: 2px; padding: 2px; }
        #side { width: 280px; background: #ddd; border: 2px inset #fff; display: flex; flex-direction: column; }
        #map { flex: 1; border: 2px inset #fff; background: #cad7d0; }
        .trip-list { flex: 1; overflow-y: scroll; background: white; border-top: 1px solid #999; }
        .trip-row { padding: 5px; border-bottom: 1px solid #ccc; cursor: pointer; font-size: 12px; }
        .trip-row:hover { background: #ffffaa; }
        .trip-row.active { background: #000080; color: white; }
        #status { background: #333; color: #0f0; font-family: monospace; font-size: 11px; padding: 2px 10px; }
    </style>
</head>
<body>

<header>JR貨物 運行エクスプローラー (2025年改正対応版)</header>

<div id="main">
    <div id="side">
        <div style="padding:5px; background:#ccc; font-size:11px;">■ 列車番号検索</div>
        <input type="text" id="q" style="width:calc(100% - 10px); margin:5px;">
        <div class="trip-list" id="trip-list"></div>
    </div>
    <div id="map"></div>
</div>

<div id="status">Ready.</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let db = {};
    const map = L.map('map').setView([38.0, 138.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let layerGrp = L.layerGroup().addTo(map);

    async function init() {
        // 軽量なファイルだけ先に読み込む
        const files = ['trips', 'stop_times', 'stops', 'calendar'];
        for (const f of files) {
            const r = await fetch(`${f}.txt`);
            const t = await r.text();
            db[f] = Papa.parse(t.trim(), { header: true, skipEmptyLines: true }).data;
        }
        document.getElementById('status').innerText = "System Online. Select a trip.";
        renderList();
        document.getElementById('q').oninput = renderList;
    }

    function renderList() {
        const q = document.getElementById('q').value.toLowerCase();
        const list = document.getElementById('trip-list');
        list.innerHTML = '';
        db.trips.filter(t => t.trip_id.toLowerCase().includes(q)).forEach(t => {
            const d = document.createElement('div');
            d.className = 'trip-row';
            d.innerHTML = `ID: ${t.trip_id}<br>${t.trip_headsign} 行`;
            d.onclick = () => loadTrip(t, d);
            list.appendChild(d);
        });
    }

    async function loadTrip(trip, el) {
        document.querySelectorAll('.trip-row').forEach(r => r.classList.remove('active'));
        el.classList.add('active');
        layerGrp.clearLayers();

        // 1. まず駅間を直線で結ぶ（仮）
        const stimes = db.stop_times.filter(s => s.trip_id === trip.trip_id).sort((a,b)=>a.stop_sequence-b.stop_sequence);
        const pts = stimes.map(st => {
            const s = db.stops.find(x => x.stop_id === st.stop_id);
            return s ? [parseFloat(s.stop_lat), parseFloat(s.stop_lon)] : null;
        }).filter(p => p);

        // 2. 分割した詳細形状データがあれば取得して上書き
        if (trip.shape_id) {
            document.getElementById('status').innerText = `Loading shape: ${trip.shape_id}...`;
            try {
                // ここで分割JSONを読み込む
                const res = await fetch(`shapes_data/${trip.shape_id}.json`);
                const shapePts = await res.json();
                L.polyline(shapePts, {color: 'red', weight: 4}).addTo(layerGrp);
                document.getElementById('status').innerText = `Active: ${trip.trip_id} (High Precision)`;
            } catch (e) {
                // JSONがない場合は直線
                L.polyline(pts, {color: 'red', weight: 3, dashArray: '5,5'}).addTo(layerGrp);
                document.getElementById('status').innerText = `Active: ${trip.trip_id} (Simple Line)`;
            }
        }
        
        // 駅にマーカー設置
        pts.forEach(p => L.circleMarker(p, {radius: 4, color: '#003'}).addTo(layerGrp));
        map.fitBounds(L.polyline(pts).getBounds(), {padding: [50,50]});
    }

    init();
</script>
</body>
</html>
