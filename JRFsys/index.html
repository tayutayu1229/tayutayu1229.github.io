<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WB-OCC é‹è¡Œç®¡ç†ç«¯æœ« v9.1</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg: #1e1e1e; --panel: #2d2d30; --text: #f5f5f5; --border: #3f3f46; --accent: #0078d4;
        }
        body.light-mode {
            --bg: #f0f0f0; --panel: #ffffff; --text: #000000; --border: #cccccc; --accent: #005a9e;
        }
        * { box-sizing: border-box; }
        body { 
            margin: 0; font-family: "Segoe UI", "Meiryo", sans-serif; 
            background: var(--bg); color: var(--text);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        
        header { 
            height: 55px; background: #000; color: #fff; display: flex; 
            justify-content: space-between; align-items: center; padding: 0 15px; 
            border-bottom: 2px solid var(--accent);
        }

        #main-layout { display: grid; grid-template-columns: 350px 1fr 400px; flex: 1; overflow: hidden; gap: 1px; background: var(--border); }
        .panel { background: var(--panel); display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { background: rgba(0,0,0,0.1); padding: 8px 12px; font-size: 13px; font-weight: bold; border-bottom: 1px solid var(--border); }

        .control-box { padding: 10px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; }
        input, select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px; font-size: 13px; }

        #trip-list { flex: 1; overflow-y: auto; }
        .trip-card { 
            padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; 
            border-left: 4px solid transparent; transition: 0.2s;
        }
        .trip-card:hover { background: rgba(0,120,212,0.1); }
        .trip-card.active { background: var(--accent); color: #fff; border-left-color: #fff; }

        .relay-area { padding: 12px; background: rgba(0,120,212,0.08); border-bottom: 1px solid var(--border); }
        .relay-text { font-size: 16px; font-weight: 900; color: var(--accent); margin-top: 4px; display: block; }

        .st-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .st-table th { background: rgba(0,0,0,0.1); position: sticky; top: 0; padding: 8px; text-align: left; }
        .st-table td { padding: 8px; border-bottom: 1px solid var(--border); }

        /* å°åˆ·è¨­å®š */
        @media print {
            @page { size: A4; margin: 10mm; }
            body * { visibility: hidden; }
            #modal-op, #modal-op * { visibility: visible; }
            #modal-op { position: absolute; left: 0; top: 0; width: 100%; padding: 0; }
            .op-sheet { box-shadow: none; border: none; width: 100%; max-width: none; height: auto; padding: 0; margin: 0; }
            .no-print { display: none !important; }
        }

        #modal-op { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; padding: 20px; overflow-y: auto; }
        .op-sheet { background: #fff; color: #000; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm; }
        
        button { padding: 8px 12px; cursor: pointer; background: var(--accent); color: #fff; border: none; font-size: 12px; }
        #loader { position: fixed; top: 60px; right: 20px; background: #f1c40f; color: #000; padding: 4px 10px; display: none; z-index: 10001; }
    </style>
</head>
<body class="dark-mode">

<div id="loader">ã‚·ã‚¹ãƒ†ãƒ å‡¦ç†ä¸­...</div>

<header>
    <div style="display: flex; align-items: center; gap: 15px;">
        <span style="font-weight: bold; font-size: 18px;">WB-OCC v9.1</span>
        <button onclick="toggleDic()" style="background:#444;">é§…ã‚³ãƒ¼ãƒ‰è¾æ›¸</button>
    </div>
    <div style="display: flex; gap: 15px; align-items: center;">
        <select id="map-style-select" onchange="updateMapStyle()">
            <option value="dark">åœ°å›³ï¼šãƒ€ãƒ¼ã‚¯</option>
            <option value="light">åœ°å›³ï¼šãƒ©ã‚¤ãƒˆ</option>
            <option value="sat">åœ°å›³ï¼šè¡›æ˜Ÿå†™çœŸ</option>
        </select>
        <button onclick="toggleGlobalTheme()" id="theme-btn">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã¸</button>
        <div id="clock" style="font-family: monospace; font-size: 16px;">00:00:00</div>
    </div>
</header>

<div id="main-layout">
    <div class="panel">
        <div class="panel-title">åˆ—è»Šæ¤œç´¢</div>
        <div class="control-box">
            <label style="font-size:10px;">å§‹ç™ºæ—¥é¸æŠ:</label>
            <input type="date" id="base_date">
            <input type="text" id="q_input" placeholder="åˆ—è»Šç•ªãƒ»åŒºé–“ãƒ»é§…åã‚’å…¥åŠ›...">
        </div>
        <div id="trip-list"></div>
    </div>

    <div class="panel">
        <div class="panel-title">åœ°å›³ãƒ¢ãƒ‹ã‚¿</div>
        <div id="map" style="flex:1;"></div>
    </div>

    <div class="panel">
        <div class="panel-title">æ™‚åˆ»è¡¨ãƒ»ç¶™èµ°</div>
        <div class="relay-area">
            <span style="font-size:10px; opacity:0.7;">ç¶™èµ°åˆ—è»Š:</span>
            <span id="relay-text" class="relay-text">-</span>
        </div>
        <div style="flex:1; overflow-y:auto;">
            <table class="st-table">
                <thead><tr><th>ã‚³ãƒ¼ãƒ‰</th><th>é§…å</th><th>ç€</th><th>ç™º</th></tr></thead>
                <tbody id="st-body"></tbody>
            </table>
        </div>
        <div style="padding:10px;"><button style="width:100%" onclick="showOpSheet()">é‹è¡Œé †åºè¡¨ã‚’ç”Ÿæˆ</button></div>
    </div>
</div>

<div id="modal-dic" style="display:none; position:fixed; top:60px; left:15px; width:320px; background:var(--panel); border:1px solid var(--accent); z-index:11000; padding:12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>é§…ã‚³ãƒ¼ãƒ‰æ¤œç´¢</b><span onclick="toggleDic()" style="cursor:pointer;">Ã—</span></div>
    <input type="text" id="dic_input" placeholder="é§…åã‚’å…¥åŠ›..." style="width:100%;">
    <div id="dic-results" style="max-height:400px; overflow-y:auto; font-size:12px; margin-top:10px;"></div>
</div>

<div id="modal-op">
    <div class="no-print" style="max-width:210mm; margin: 0 auto 10px auto; text-align:right;">
        <button onclick="window.print()" style="background:#000; padding:10px 20px;">PDFå‡ºåŠ›ãƒ»å°åˆ·</button>
        <button onclick="document.getElementById('modal-op').style.display='none'" style="background:#f44336;">é–‰ã˜ã‚‹</button>
    </div>
    <div class="op-sheet" id="op-content"></div>
</div>

<script>
    const dateInput = document.getElementById('base_date');
    dateInput.valueAsDate = new Date();

    const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([36.5, 138], 6);
    const tileLayers = {
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
        sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
    };
    tileLayers.dark.addTo(map);

    window.gtfsDB = { trips: [], stops: {}, stopTimes: {}, stopToTrips: {} };
    let currentTripId = "";
    let currentTimeline = [];

    function updateMapStyle() {
        const val = document.getElementById('map-style-select').value;
        Object.values(tileLayers).forEach(l => map.removeLayer(l));
        tileLayers[val].addTo(map);
    }

    function toggleGlobalTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        document.getElementById('theme-btn').innerText = isLight ? "ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã¸" : "ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã¸";
        const styleSelect = document.getElementById('map-style-select');
        styleSelect.value = isLight ? "light" : "dark";
        updateMapStyle();
    }

    function parseTime(timeStr, baseDateStr) {
        if (!timeStr || timeStr === "undefined") return { full: "-", label: "-", time: "-" };
        let [h, m] = timeStr.split(':').map(Number);
        let dayOffset = Math.floor(h / 24);
        let date = new Date(baseDateStr);
        date.setDate(date.getDate() + dayOffset);
        let h24 = h % 24;
        return {
            full: (dayOffset > 0 ? `+${dayOffset}æ—¥ ` : "") + `${String(h24).padStart(2, '0')}:${String(m).padStart(2, '0')}`,
            label: `${date.getMonth()+1}/${date.getDate()}`,
            time: `${String(h24).padStart(2, '0')}:${String(m).padStart(2, '0')}`
        };
    }

    // ğŸ’¡ ç¶™èµ°ã¨åŒºé–“åã®ãƒ‘ãƒ¼ã‚¹
    function getRelayDisplay(id, timeline) {
        if (!id) return { relay: "-", range: "-" };
        const parts = id.split('_').slice(2);
        const relayParts = parts.map((p, i) => {
            const nearStop = timeline[i] || timeline[i+1] || {name: ""};
            const isRoad = nearStop.name.includes("ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ«") || nearStop.name.includes("å–¶æ¥­æ‰€");
            if (p.endsWith('b') || isRoad) return parseInt(p, 10) + "ä¾¿";
            return (p.length >= 4 ? p.substring(0,4) : p) + "ãƒ¬";
        });

        const startName = timeline[0]?.name || "ä¸æ˜";
        const endName = timeline[timeline.length - 1]?.name || "ä¸æ˜";

        return {
            relay: relayParts.join(" ã€œ "),
            range: `${startName} ã€œ ${endName}`
        };
    }

    async function init() {
        document.getElementById("loader").style.display = "block";
        const [t, s, st] = await Promise.all([
            fetch('./trips.txt').then(r => r.text()),
            fetch('./stops.txt').then(r => r.text()),
            fetch('./stop_times.txt').then(r => r.text())
        ]);
        window.gtfsDB.trips = Papa.parse(t.trim(), { header: true }).data;
        Papa.parse(s.trim(), { header: true }).data.forEach(x => { window.gtfsDB.stops[x.stop_id] = x; });
        Papa.parse(st.trim(), { header: true }).data.forEach(x => {
            if (!window.gtfsDB.stopTimes[x.trip_id]) window.gtfsDB.stopTimes[x.trip_id] = [];
            window.gtfsDB.stopTimes[x.trip_id].push(x);
            const sobj = window.gtfsDB.stops[x.stop_id];
            if(sobj) {
                [sobj.stop_name, sobj.stop_code].forEach(k => {
                    if(!window.gtfsDB.stopToTrips[k]) window.gtfsDB.stopToTrips[k] = new Set();
                    window.gtfsDB.stopToTrips[k].add(x.trip_id);
                });
            }
        });
        renderTrips("");
        document.getElementById("loader").style.display = "none";
    }

    function renderTrips(f) {
        const list = document.getElementById("trip-list");
        list.innerHTML = "";
        const filter = f.toLowerCase();
        window.gtfsDB.trips.filter(t => {
            if (!filter) return true;
            if (t.trip_id.toLowerCase().includes(filter)) return true;
            return Object.keys(window.gtfsDB.stopToTrips).some(k => k.toLowerCase().includes(filter) && window.gtfsDB.stopToTrips[k].has(t.trip_id));
        }).slice(0, 50).forEach(t => {
            const st = window.gtfsDB.stopTimes[t.trip_id] || [];
            const sName = window.gtfsDB.stops[st[0]?.stop_id]?.stop_name || "??";
            const eName = window.gtfsDB.stops[st[st.length-1]?.stop_id]?.stop_name || "??";
            
            const card = document.createElement("div");
            card.className = "trip-card" + (t.trip_id === currentTripId ? " active" : "");
            card.innerHTML = `
                <div style="font-size:10px; opacity:0.6;">${t.trip_id}</div>
                <div style="font-weight:bold; font-size:14px; margin:2px 0;">${parseRelayDisplayForList(t.trip_id)}</div>
                <div style="font-size:11px; color:var(--accent); font-weight:600;">${sName} ã€œ ${eName}</div>
            `;
            card.onclick = () => loadTrip(t);
            list.appendChild(card);
        });
    }

    function parseRelayDisplayForList(id) {
        return id.split('_').slice(2).map(p => p.endsWith('b') ? p.replace('b','ä¾¿') : p.substring(0,4)+'ãƒ¬').join("ã€œ");
    }

    async function loadTrip(t) {
        currentTripId = t.trip_id;
        document.getElementById("loader").style.display = "block";
        const shardKey = t.shape_id.substring(0, 2);
        try {
            const shard = await fetch(`./shapes_shards/shard_${shardKey}.json`).then(r => r.json());
            window.dispatchEvent(new CustomEvent("py-process", { 
                detail: { tid: t.trip_id, geo: JSON.stringify(shard[t.shape_id]) } 
            }));
        } catch (e) { console.error(e); document.getElementById("loader").style.display = "none"; }
    }

    window.updateUI = (geo_s, time_s) => {
        const timeRaw = JSON.parse(time_s);
        const geoPoints = JSON.parse(geo_s);
        const baseDate = document.getElementById('base_date').value;
        
        currentTimeline = timeRaw.map(s => ({
            ...s,
            arrP: parseTime(s.arr, baseDate),
            depP: parseTime(s.dep, baseDate)
        }));

        const displayInfo = getRelayDisplay(currentTripId, currentTimeline);
        document.getElementById("relay-text").innerText = displayInfo.relay;
        
        // Clear old layers
        map.eachLayer(l => { if(l instanceof L.Polyline || l instanceof L.CircleMarker) map.removeLayer(l); });

        // Draw Route
        const hasORS = currentTimeline.some(s => s.name.includes("ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ«") || s.name.includes("å–¶æ¥­æ‰€"));
        if(hasORS) {
            L.polyline(geoPoints, { color: '#0078d4', weight: 6, opacity: 0.8 }).addTo(map);
        } else {
            L.polyline(geoPoints, { color: '#000', weight: 5 }).addTo(map);
            L.polyline(geoPoints, { color: '#fff', weight: 2, dashArray: '8, 12' }).addTo(map);
        }

        map.fitBounds(L.polyline(geoPoints).getBounds(), { padding: [40,40] });

        const tbody = document.getElementById("st-body");
        tbody.innerHTML = "";
        currentTimeline.forEach(s => {
            tbody.innerHTML += `<tr><td>${s.code}</td><td><b>${s.name}</b></td><td>${s.arrP.full}</td><td>${s.depP.full}</td></tr>`;
            L.circleMarker([s.lat, s.lon], { radius: 4, color: '#fff', fillColor: '#000', fillOpacity: 1, weight: 2 }).addTo(map).bindPopup(s.name);
        });
        document.getElementById("loader").style.display = "none";
    };

    function showOpSheet() {
        if(!currentTimeline.length) return;
        const displayInfo = getRelayDisplay(currentTripId, currentTimeline);
        const content = document.getElementById("op-content");
        let rows = currentTimeline.map(s => `
            <tr>
                <td>${s.code}</td>
                <td style="text-align:left; font-weight:bold;">${s.name}</td>
                <td>${s.arrP.label}<br>${s.arrP.time}</td>
                <td>${s.depP.label}<br>${s.depP.time}</td>
                <td></td>
            </tr>`).join("");

        content.innerHTML = `
            <div style="border-bottom:4pt solid #000; padding-bottom:10px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:flex-end;">
                <h1 style="margin:0; font-size:26pt;">è²¨ç‰©é‹é€ é‹è¡Œé †åºè¡¨</h1>
                <span style="font-size:12pt;">ç™ºè¡Œæ—¥: ${new Date().toLocaleDateString()}</span>
            </div>
            <div style="margin-bottom:20px; font-size:14pt; line-height:1.6;">
                <div><b>ç¶™èµ°åˆ—è»Š:</b> ${displayInfo.relay}</div>
                <div><b>é‹è¡ŒåŒºé–“:</b> ${displayInfo.range}</div>
                <div><b>å§‹ç™ºæ—¥:</b> ${document.getElementById("base_date").value}</div>
            </div>
            <table style="width:100%; border-collapse:collapse; text-align:center;" border="2">
                <tr style="background:#eee;">
                    <th style="width:15%; padding:10px;">é§…ã‚³ãƒ¼ãƒ‰</th>
                    <th style="width:40%;">åœè»Šé§…ãƒ»ORSå</th>
                    <th style="width:15%;">ç€æ™‚åˆ»</th>
                    <th style="width:15%;">ç™ºæ™‚åˆ»</th>
                    <th>å‚™è€ƒ</th>
                </tr>
                ${rows}
            </table>
        `;
        document.getElementById("modal-op").style.display = "block";
    }

    function toggleDic() {
        const d = document.getElementById("modal-dic");
        d.style.display = d.style.display === "none" ? "block" : "none";
        renderDic("");
    }
    function renderDic(f) {
        const res = document.getElementById("dic-results");
        res.innerHTML = "";
        Object.values(window.gtfsDB.stops).filter(s => s.stop_name.includes(f)).slice(0, 50).forEach(s => {
            const div = document.createElement("div");
            div.style.padding = "6px"; div.style.borderBottom = "1px solid #444"; div.style.cursor="pointer";
            div.innerHTML = `<span style="color:var(--accent); font-weight:bold;">${s.stop_code}</span> : ${s.stop_name}`;
            div.onclick = () => { document.getElementById("q_input").value = s.stop_name; renderTrips(s.stop_name); toggleDic(); };
            res.appendChild(div);
        });
    }
    document.getElementById("dic_input").oninput = (e) => renderDic(e.target.value);

    setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleTimeString(); }, 1000);
    init();
    document.getElementById("q_input").oninput = (e) => renderTrips(e.target.value);
</script>

<py-script>
import js, json
from pyodide.ffi import create_proxy

async def process(event):
    data = event.detail.to_py()
    tid = data['tid']
    try:
        db = js.window.gtfsDB
        # JSãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®Ÿã«Pythonè¾æ›¸ã¨ã—ã¦å–å¾—
        st_data = db.stopTimes.to_py()
        if tid not in st_data:
            js.console.warn(f"Trip ID {tid} not found in stopTimes")
            return
            
        st_list = sorted(st_data[tid], key=lambda x: int(x['stop_sequence']))
        stops_dict = db.stops.to_py()
        
        timeline = []
        for r in st_list:
            sid = r['stop_id']
            if sid in stops_dict:
                s = stops_dict[sid]
                timeline.append({
                    "name": s['stop_name'],
                    "code": s['stop_code'] if s['stop_code'] != "undefined" else "-",
                    "arr": str(r['arrival_time']),
                    "dep": str(r['departure_time']),
                    "lat": float(s['stop_lat']),
                    "lon": float(s['stop_lon'])
                })
        
        # JSã®updateUIã‚’å‘¼ã³å‡ºã—
        js.window.updateUI(data['geo'], json.dumps(timeline))
    except Exception as e:
        js.console.error(f"Python Error: {str(e)}")
        js.document.getElementById("loader").style.display = "none"

js.window.addEventListener("py-process", create_proxy(process))
</py-script>
</body>
</html>
