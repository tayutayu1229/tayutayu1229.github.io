<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB-OCC Master v8.1 (Lightweight)</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg-base: #000814; --panel-bg: #001b33; --border-primary: #004d99;
            --accent-danger: #ff2b56; --accent-active: #00ffcc; --accent-warning: #ffcc00;
            --text-silver: #e0f2f7; --font-main: "Segoe UI", "Meiryo", "Consolas", sans-serif;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-main); background: var(--bg-base); color: var(--text-silver); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 50px; background: #001b33; border-bottom: 2px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 1000; }
        #main-layout { display: grid; grid-template-columns: 350px 1fr 380px; flex: 1; overflow: hidden; gap: 2px; background: var(--border-primary); }
        .panel { background: var(--bg-base); display: flex; flex-direction: column; overflow: hidden; }
        
        .search-box { padding: 10px; background: var(--panel-bg); }
        #q_input { width: 100%; background: #000; border: 1px solid var(--border-primary); color: var(--accent-active); padding: 8px; border-radius: 4px; outline: none; font-size: 13px; }
        
        #trip-list { flex: 1; overflow-y: auto; will-change: transform; }
        .trip-card { padding: 10px; border-bottom: 1px solid rgba(0, 77, 153, 0.2); cursor: pointer; font-size: 13px; }
        .trip-card:hover { background: rgba(0, 255, 204, 0.05); }
        .trip-card.active { background: #002244; border-left: 4px solid var(--accent-danger); }

        #modal-op { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; padding: 20px; }
        .op-sheet { background: #fff; color: #000; height: 100%; max-width: 800px; margin: 0 auto; padding: 30px; font-family: "MS Mincho", serif; overflow-y: auto; }
        .op-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .op-table th, .op-table td { border: 1px solid #000; padding: 5px; text-align: center; }

        .action-bar { padding: 8px; display: flex; gap: 4px; background: #000; }
        .act-btn { flex: 1; padding: 8px; background: var(--border-primary); border: none; color: #fff; cursor: pointer; font-size: 11px; border-radius: 3px; }
        
        #timeline-view { flex: 1; overflow-y: auto; padding: 15px; }
        .station-node { border-left: 2px solid var(--border-primary); margin-left: 10px; padding: 0 0 15px 20px; position: relative; font-size: 13px; }
        .station-node::before { content: ""; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: var(--accent-active); border-radius: 50%; }

        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; display: none; justify-content: center; align-items: center; color: var(--accent-active); font-weight: bold; }
    </style>
</head>
<body>

<div id="loader"><div id="load-msg">ÊúÄÈÅ©Âåñ‰∏≠...</div></div>

<div id="modal-op">
    <div style="margin-bottom: 10px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
        <button class="act-btn" onclick="window.print()" style="max-width: 100px;">PDFÂá∫Âäõ</button>
        <button class="act-btn" onclick="document.getElementById('modal-op').style.display='none'" style="max-width: 100px; background:#444;">Èñâ„Åò„Çã</button>
    </div>
    <div class="op-sheet" id="op-content"></div>
</div>

<header>
    <div style="font-weight: 900; color: var(--accent-danger);">WB-OCC v8.1</div>
    <div id="clock" style="font-family: Consolas; color: var(--accent-active);">00:00:00</div>
</header>

<div id="main-layout">
    <div class="panel">
        <div class="search-box">
            <input type="text" id="q_input" placeholder="ID / ÈßÖÂêç / ÈßÖ„Ç≥„Éº„Éâ„ÅßÊ§úÁ¥¢...">
        </div>
        <div id="trip-list"></div>
    </div>
    <div class="panel"><div id="map" style="height: 100%;"></div></div>
    <div class="panel">
        <div class="action-bar">
            <button class="act-btn" onclick="showOpSheet()">ÈÅãË°åË°® Ë°®Á§∫</button>
            <button class="act-btn" onclick="exportData()">„Éá„Éº„Çø‰øùÂ≠ò</button>
        </div>
        <div id="relay-display" style="padding:8px; background:#001b33; font-size:12px; border-bottom:1px solid var(--border-primary);">
            RELAY: <span id="relay-text" style="color:var(--accent-active)">--</span>
        </div>
        <div id="timeline-view"></div>
    </div>
</div>

<script>
    const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([36.5, 138], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let routeGroup = L.layerGroup().addTo(map);
    let markerGroup = L.layerGroup().addTo(map);

    // üí° „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂåñ„Åï„Çå„Åü„Éá„Éº„Çø„Éô„Éº„Çπ
    window.gtfsDB = {
        trips: [],
        stops: {},      // stop_id„Çí„Ç≠„Éº„Å´„Åó„ÅüËæûÊõ∏
        stopTimes: {},  // trip_id„Çí„Ç≠„Éº„Å´„Åó„Åü„ÄÅÈßÖÊôÇÂàª„ÅÆÈÖçÂàóËæûÊõ∏
        stopToTrips: {} // stop_name/code„Çí„Ç≠„Éº„Å´„Åó„Åü„ÄÅÈñ¢ÈÄ£„Åô„Çãtrip_id„ÅÆMap
    };
    let currentTripData = null;
    let currentTripId = "";

    async function init() {
        document.getElementById("loader").style.display = "flex";
        try {
            const [tText, sText, stText] = await Promise.all([
                fetch('./trips.txt').then(r => r.text()),
                fetch('./stops.txt').then(r => r.text()),
                fetch('./stop_times.txt').then(r => r.text())
            ]);

            window.gtfsDB.trips = Papa.parse(tText.trim(), { header: true }).data;
            
            // Stops„ÇíËæûÊõ∏Âåñ
            Papa.parse(sText.trim(), { header: true }).data.forEach(s => {
                window.gtfsDB.stops[s.stop_id] = s;
            });

            // StopTimes„ÇíTrip„Åî„Å®„Å´„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂåñÔºà„Åì„Åì„ÅåÊúÄÈáçË¶Å„ÅÆËªΩÈáèÂåñÔºâ
            Papa.parse(stText.trim(), { header: true }).data.forEach(st => {
                if (!window.gtfsDB.stopTimes[st.trip_id]) window.gtfsDB.stopTimes[st.trip_id] = [];
                window.gtfsDB.stopTimes[st.trip_id].push(st);
                
                // ÈÄÜÂºï„ÅçÁî®„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
                const sObj = window.gtfsDB.stops[st.stop_id];
                if(sObj) {
                    const keys = [sObj.stop_name, sObj.stop_code];
                    keys.forEach(k => {
                        if(!window.gtfsDB.stopToTrips[k]) window.gtfsDB.stopToTrips[k] = new Set();
                        window.gtfsDB.stopToTrips[k].add(st.trip_id);
                    });
                }
            });

            renderTrips("");
        } catch (e) { console.error(e); }
        document.getElementById("loader").style.display = "none";
    }

    function renderTrips(filter) {
        const list = document.getElementById("trip-list");
        list.innerHTML = "";
        const f = filter.toLowerCase();

        // üí° È´òÈÄü„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        const filtered = window.gtfsDB.trips.filter(t => {
            if (!f) return true;
            if (t.trip_id.toLowerCase().includes(f)) return true;
            // ÈÄÜÂºï„Åç„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åã„ÇâÊ§úÁ¥¢
            return Object.keys(window.gtfsDB.stopToTrips).some(k => k.includes(f) && window.gtfsDB.stopToTrips[k].has(t.trip_id));
        }).slice(0, 50);

        const fragment = document.createDocumentFragment();
        filtered.forEach(t => {
            const st = window.gtfsDB.stopTimes[t.trip_id]?.sort((a,b)=>a.stop_sequence-b.stop_sequence) || [];
            const sName = window.gtfsDB.stops[st[0]?.stop_id]?.stop_name || "??";
            const eName = window.gtfsDB.stops[st[st.length-1]?.stop_id]?.stop_name || "??";
            
            const card = document.createElement("div");
            card.className = "trip-card";
            card.innerHTML = `<div style="color:var(--accent-active); font-size:10px;">${t.trip_id}</div><b>${sName} ‚ñ∂ ${eName}</b>`;
            card.onclick = () => loadTrip(t);
            fragment.appendChild(card);
        });
        list.appendChild(fragment);
    }

    async function loadTrip(t) {
        currentTripId = t.trip_id;
        document.getElementById("loader").style.display = "flex";
        const shardKey = t.shape_id.substring(0, 2);
        const res = await fetch(`./shapes_shards/shard_${shardKey}.json`);
        const shard = await res.json();
        
        // Á∂ôËµ∞„Éë„Éº„Çπ
        const relays = t.trip_id.split('_').slice(2).filter(p => p.length >= 4).map(p => p.substring(0,4) + "„É¨");
        document.getElementById("relay-text").innerText = relays.join(" „Äú ");

        window.dispatchEvent(new CustomEvent("py-process", { 
            detail: { tid: t.trip_id, geo: JSON.stringify(shard[t.shape_id]) } 
        }));
    }

    window.updateUI = (geo_s, time_s) => {
        const time = JSON.parse(time_s); currentTripData = time;
        const geo = JSON.parse(geo_s);
        routeGroup.clearLayers(); markerGroup.clearLayers();
        
        L.polyline(geo, {color: 'var(--accent-danger)', weight: 3}).addTo(routeGroup);
        map.fitBounds(L.polyline(geo).getBounds(), {padding: [20,20]});

        const view = document.getElementById("timeline-view");
        view.innerHTML = "";
        time.forEach(s => {
            const node = document.createElement("div");
            node.className = "station-node";
            node.innerHTML = `<div>${s.name} (${s.code})</div><div style="font-size:11px; color:var(--accent-warning)">ÁùÄ ${s.arr} / Áô∫ ${s.dep}</div>`;
            view.appendChild(node);
            L.circleMarker([s.lat, s.lon], {radius: 4, color: '#00ffcc', fillOpacity: 1}).addTo(markerGroup);
        });
        document.getElementById("loader").style.display = "none";
    };

    function showOpSheet() {
        if(!currentTripData) return;
        const modal = document.getElementById("modal-op");
        const content = document.getElementById("op-content");
        let rows = currentTripData.map(s => `<tr><td>${s.code}</td><td style="text-align:left;">${s.name}</td><td>${s.arr}</td><td>${s.dep}</td><td></td></tr>`).join("");
        content.innerHTML = `<h3>Ë≤®Áâ©ÂàóËªäÈÅãË°åÊôÇÂàªË°®</h3><p>Trip ID: ${currentTripId}</p><table class="op-table"><thead><tr><th>„Ç≥„Éº„Éâ</th><th>ÈßÖÂêç</th><th>ÁùÄ</th><th>Áô∫</th><th>ÂÇôËÄÉ</th></tr></thead><tbody>${rows}</tbody></table>`;
        modal.style.display = "block";
    }

    function exportData() {
        if(!currentTripData) return;
        const blob = new Blob([JSON.stringify(currentTripData)], {type: "application/json"});
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `${currentTripId}.json`; a.click();
    }

    setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleTimeString(); }, 1000);
    init();
    let timeout;
    document.getElementById("q_input").oninput = (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => renderTrips(e.target.value), 200); // ÂÖ•ÂäõË≤†Ëç∑ËªΩÊ∏õ
    };
</script>

<py-script>
import js, json
from pyodide.ffi import create_proxy

async def process(event):
    data = event.detail.to_py()
    coords = json.loads(data['geo'])
    tid = data['tid']
    try:
        db = js.window.gtfsDB
        st = sorted(db.stopTimes[tid].to_py(), key=lambda x: int(x['stop_sequence']))
        timeline = []
        for r in st:
            s = db.stops[r['stop_id']]
            timeline.append({"name": s['stop_name'], "code": s['stop_code'], "arr": r['arrival_time'], "dep": r['departure_time'], "lat": float(s['stop_lat']), "lon": float(s['stop_lon'])})
        js.window.updateUI(json.dumps(coords), json.dumps(timeline))
    except Exception as e:
        js.console.error(str(e))
        js.document.getElementById('loader').style.display = 'none'

js.window.addEventListener("py-process", create_proxy(process))
</py-script>
</body>
</html>
