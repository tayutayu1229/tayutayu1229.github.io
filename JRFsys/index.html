<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB-OCC Strategic Railway Terminal v6.1</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg-base: #000814; --panel-bg: #001b33; --border-primary: #004d99;
            --accent-danger: #ff2b56; --accent-active: #00ffcc; --text-silver: #e0f2f7;
            --font-main: "Consolas", "Monaco", "Courier New", monospace;
        }
        body { margin: 0; padding: 0; font-family: var(--font-main); background: var(--bg-base); color: var(--text-silver); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { height: 65px; background: linear-gradient(180deg, #002b5c 0%, #001b33 100%); border-bottom: 3px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; padding: 0 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.7); z-index: 1000; }
        .logo { font-size: 24px; font-weight: 900; color: var(--accent-danger); border: 2px solid var(--accent-danger); padding: 4px 12px; box-shadow: 0 0 15px rgba(255, 43, 86, 0.4); }

        #container-main { display: flex; flex: 1; gap: 12px; padding: 12px; overflow: hidden; }
        
        /* 左：検索 & 運転区間表示 */
        #panel-selection { width: 380px; background: var(--panel-bg); border: 1px solid var(--border-primary); display: flex; flex-direction: column; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        .section-header { background: var(--border-primary); padding: 10px 15px; font-size: 11px; font-weight: bold; letter-spacing: 2px; color: #fff; }
        #q_input { width: 100%; background: #000; border: 1px solid var(--border-primary); color: var(--accent-active); padding: 12px; font-size: 14px; outline: none; box-sizing: border-box; }
        #trip-list { flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .trip-card { padding: 18px; border-bottom: 1px solid rgba(0, 77, 153, 0.4); cursor: pointer; transition: background 0.2s; }
        .trip-card:hover { background: rgba(0, 255, 204, 0.05); }
        .trip-card.active { background: #003366; border-left: 10px solid var(--accent-danger); }
        .trip-id-text { font-weight: bold; color: var(--accent-active); font-size: 14px; }
        .trip-route-text { font-size: 12px; margin-top: 6px; color: #ffffff; font-weight: 500; }

        /* 中：マップ */
        #panel-map { flex: 1; background: #000; border: 1px solid var(--border-primary); position: relative; }
        #map { height: 100%; width: 100%; }

        /* 右：駅情報 */
        #panel-analysis { width: 420px; background: var(--panel-bg); border: 1px solid var(--border-primary); display: flex; flex-direction: column; }
        #timeline-view { flex: 1; overflow-y: auto; padding: 20px; }
        .station-node { position: relative; padding-left: 40px; padding-bottom: 30px; border-left: 2px solid var(--border-primary); margin-left: 15px; cursor: pointer; }
        .station-node::before { content: ""; position: absolute; left: -11px; top: 0; width: 18px; height: 18px; background: var(--bg-base); border: 2px solid var(--accent-active); border-radius: 50%; }

        /* 下：ログ & 統計 */
        #footer-panel { height: 180px; display: flex; gap: 12px; padding: 0 12px 12px 12px; }
        #stats-panel { width: 380px; background: var(--panel-bg); border: 1px solid var(--border-primary); padding: 15px; font-size: 13px; }
        #log-panel { flex: 1; background: #000; border: 1px solid var(--border-primary); padding: 15px; overflow-y: auto; font-size: 11px; color: var(--accent-active); }

        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 60px; height: 60px; border: 4px solid #111; border-top: 4px solid var(--accent-danger); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div style="margin-top: 25px; color: #fff; letter-spacing: 3px;">DOWNLOADING SHAPES FROM CLOUD...</div>
</div>

<header>
    <div class="logo">WB-OCC</div>
    <div id="clock-display" style="font-size: 20px; font-weight: bold; color: var(--accent-active);">00:00:00</div>
</header>

<div id="container-main">
    <div id="panel-selection">
        <div class="section-header">TARGET TRIP INDEX</div>
        <div style="padding:15px;"><input type="text" id="q_input" placeholder="TRIP ID / KEYWORD..."></div>
        <div id="trip-list"></div>
    </div>
    <div id="panel-map"><div id="map"></div></div>
    <div id="panel-analysis">
        <div class="section-header">ARRIVAL FEED</div>
        <div id="timeline-view"></div>
    </div>
</div>

<div id="footer-panel">
    <div id="stats-panel">
        <div class="section-header" style="margin:-15px -15px 15px -15px;">TELEMETRY</div>
        <div id="stats-display">READY FOR ANALYSIS.</div>
    </div>
    <div id="log-panel"><div id="log-content">System modules loaded.</div></div>
</div>

<script>
    const map = L.map('map', { zoomControl: false }).setView([36.5, 138], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let routeGroup = L.layerGroup().addTo(map);
    let markerGroup = L.layerGroup().addTo(map);

    window.gtfsDB = { trips: [], stops: [], stop_times: [] };

    function pushLog(msg, isError = false) {
        const log = document.getElementById("log-content");
        const div = document.createElement("div");
        if(isError) div.style.color = "var(--accent-danger)";
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.prepend(div);
    }

    async function init() {
        try {
            for(const t of ['trips', 'stops', 'stop_times']) {
                const res = await fetch(`./${t}.txt`);
                const data = await res.text();
                window.gtfsDB[t] = Papa.parse(data.trim(), { header: true }).data;
            }
            renderTrips("");
            pushLog("GTFS local data synchronized.");
        } catch (e) { pushLog("INIT ERROR: " + e.message, true); }
    }

    function renderTrips(filter) {
        const list = document.getElementById("trip-list");
        list.innerHTML = "";
        window.gtfsDB.trips.filter(t => t.trip_id.includes(filter)).slice(0, 100).forEach(t => {
            // 運転区間（始発〜終着）を計算
            const st_subset = window.gtfsDB.stop_times.filter(s => s.trip_id === t.trip_id).sort((a,b) => a.stop_sequence - b.stop_sequence);
            let sectionName = "Unknown Section";
            if(st_subset.length > 0) {
                const sName = window.gtfsDB.stops.find(s => s.stop_id === st_subset[0].stop_id)?.stop_name || "??";
                const eName = window.gtfsDB.stops.find(s => s.stop_id === st_subset[st_subset.length-1].stop_id)?.stop_name || "??";
                sectionName = `${sName} 〜 ${eName}`;
            }

            const card = document.createElement("div");
            card.className = "trip-card";
            card.innerHTML = `<div class="trip-id-text">${t.trip_id}</div><div class="trip-route-text">${sectionName}</div>`;
            card.onclick = () => {
                document.querySelectorAll(".trip-card").forEach(c => c.classList.remove("active"));
                card.classList.add("active");
                document.getElementById("loader").style.display = "flex";
                window.dispatchEvent(new CustomEvent("trigger-analysis", { detail: t.trip_id }));
            };
            list.appendChild(card);
        });
    }

    window.callbackUI = (geo_s, time_s, stat_s) => {
        const geo = JSON.parse(geo_s); const time = JSON.parse(time_s); const stats = JSON.parse(stat_s);
        routeGroup.clearLayers(); markerGroup.clearLayers();
        if(geo.length > 0) {
            const poly = L.polyline(geo, { color: 'var(--accent-danger)', weight: 4 }).addTo(routeGroup);
            map.fitBounds(poly.getBounds(), { padding: [40, 40] });
        }
        const view = document.getElementById("timeline-view");
        view.innerHTML = "";
        time.forEach(s => {
            const d = document.createElement("div");
            d.className = "station-node";
            d.innerHTML = `<div style="font-weight:bold;">${s.name}</div><div style="font-size:11px;color:var(--accent-active);">${s.arr} / ${s.dep}</div>`;
            d.onclick = () => map.flyTo([s.lat, s.lon], 14);
            view.appendChild(d);
            L.circleMarker([s.lat, s.lon], { radius: 6, color: '#00ffcc', fillOpacity: 1 }).addTo(markerGroup);
        });
        document.getElementById("stats-display").innerHTML = `ID: ${stats.id}<br>DISTANCE: ${stats.dist.toFixed(2)} KM<br>NODES: ${stats.count}`;
        document.getElementById("loader").style.display = "none";
        pushLog(`Mapping successful for ${stats.id}`);
    };

    document.getElementById("q_input").oninput = (e) => renderTrips(e.target.value);
    setInterval(() => { document.getElementById("clock-display").innerText = new Date().toLocaleTimeString(); }, 1000);
    init();
</script>

<py-script>
import js, json, math, re
from pyodide.http import pyfetch
from pyodide.ffi import create_proxy

# --- クラウド設定：CORSを回避するための強力なエンドポイント ---
FILE_ID = "18T7-qEaUqX6S5gG_N_Q_v9xI6IuP8x2x"
# alloriginsプロキシを介して、Google Driveの「uc(download)」を叩く
SHAPES_URL = f"https://api.allorigins.win/raw?url={encodeURIComponent('https://drive.google.com/uc?export=download&id=' + FILE_ID)}"

# JavaScriptの関数をPythonから使うためのヘルパー
def encodeURIComponent(s):
    from urllib.parse import quote
    return quote(s, safe='')

async def run_analysis(event):
    tid = event.detail
    js.pushLog(f"Requesting cloud data for: {tid}")
    try:
        db = js.window.gtfsDB
        trip = next((t for t in db.trips.to_py() if t['trip_id'] == tid), None)
        sid = trip.get('shape_id')

        # 1. Timeline
        st_subset = sorted([s for s in db.stop_times.to_py() if s['trip_id'] == tid], key=lambda x: int(x['stop_sequence']))
        timeline = []
        for r in st_subset:
            s_info = next((s for s in db.stops.to_py() if s['stop_id'] == r['stop_id']), None)
            timeline.append({"name": s_info['stop_name'], "arr": r['arrival_time'], "dep": r['departure_time'], "lat": float(s_info['stop_lat']), "lon": float(s_info['stop_lon'])})

        # 2. Geometry Fetch (CORS Bypass Engine)
        js.pushLog(f"Bypassing CORS for SID: {sid}...")
        res = await pyfetch(SHAPES_URL)
        if not res.ok: raise Exception(f"HTTP Error: {res.status}")
        content = await res.string()
        
        if "<!DOCTYPE html>" in content:
            raise Exception("Cloud Fetch Error: Google Drive returned HTML. Please check sharing permissions.")

        # 3. CSV Parsing
        lines = content.lstrip('\ufeff').replace('\r\n', '\n').replace('\r', '\n').strip().split('\n')
        header = [re.sub(r'[^a-z0-9_]', '', x.lower().strip()) for x in lines[0].split(',')]
        
        idx = { 'id': header.index('shape_id'), 'lat': header.index('shape_pt_lat'), 'lon': header.index('shape_pt_lon'), 'seq': header.index('shape_pt_sequence') }
        
        geo_points = []
        for line in lines[1:]:
            cols = [c.strip() for c in line.split(',')]
            if len(cols) > idx['id'] and cols[idx['id']] == sid:
                geo_points.append([float(cols[idx['lat']]), float(cols[idx['lon']]), int(cols[idx['seq']])])
        
        geo_points.sort(key=lambda x: x[2])
        coords = [[p[0], p[1]] for p in geo_points]

        # 4. Calculation
        total_dist = 0
        if len(coords) > 1:
            for i in range(len(coords)-1):
                p1, p2 = coords[i], coords[i+1]
                a = math.sin(math.radians(p2[0]-p1[0])/2)**2 + math.cos(math.radians(p1[0]))*math.cos(math.radians(p2[0]))*math.sin(math.radians(p2[1]-p1[1])/2)**2
                total_dist += 6371 * 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))

        js.window.callbackUI(json.dumps(coords), json.dumps(timeline), json.dumps({"id": tid, "dist": total_dist, "count": len(timeline)}))

    except Exception as e:
        js.pushLog(f"CRITICAL ERROR: {str(e)}", True)
        js.document.getElementById('loader').style.display = 'none'

js.window.addEventListener("trigger-analysis", create_proxy(run_analysis))
js.pushLog("Analyzer Core Online.")
</py-script>

</body>
</html>
