<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JRF OCC White Base Command Terminal v4.5</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --wb-bg: #000814; --wb-navy: #001a33; --wb-blue: #003366;
            --wb-red: #ff2d55; --wb-cyan: #00ffcc; --wb-yellow: #ffcc00;
            --wb-text: #e0f2f7; --wb-font: 'Consolas', 'Monaco', monospace;
        }

        body {
            margin: 0; font-family: var(--wb-font); background: var(--wb-bg);
            color: var(--wb-text); display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }
        
        /* ヘッダー：指揮官用ステータスバー */
        header {
            height: 50px; background: var(--wb-navy); border-bottom: 2px solid var(--wb-blue);
            display: flex; justify-content: space-between; align-items: center; padding: 0 25px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8); z-index: 1000;
        }
        .sys-logo { font-size: 26px; font-weight: 900; color: var(--wb-red); text-shadow: 0 0 10px var(--wb-red); }
        .sys-title { font-size: 14px; letter-spacing: 2px; }
        #live-clock { color: var(--wb-cyan); font-weight: bold; margin-right: 20px; }
        #kernel-status { font-size: 10px; border: 1px solid var(--wb-cyan); padding: 3px 8px; color: var(--wb-cyan); }

        #main-container { display: flex; flex: 1; overflow: hidden; gap: 8px; padding: 8px; }

        /* 左パネル：ターゲット検索 */
        #left-panel { width: 340px; background: var(--wb-navy); display: flex; flex-direction: column; border: 1px solid var(--wb-blue); }
        .panel-header { background: var(--wb-blue); padding: 8px 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .search-area { padding: 12px; background: rgba(0,0,0,0.4); }
        #q_input { width: 100%; background: #000; border: 1px solid var(--wb-blue); color: var(--wb-cyan); padding: 10px; font-size: 14px; outline: none; }
        #trip-list { flex: 1; overflow-y: auto; }
        .trip-row { padding: 12px; border-bottom: 1px solid rgba(0,64,128,0.3); cursor: pointer; transition: 0.2s; }
        .trip-row:hover { background: rgba(0,255,204,0.1); }
        .trip-row.active { background: var(--wb-blue); border-left: 6px solid var(--wb-red); }
        .trip-id { font-weight: bold; color: var(--wb-cyan); }
        .trip-info { font-size: 10px; color: #888; margin-top: 4px; }

        /* 中央パネル：タクティカルマップ */
        #center-panel { flex: 1; border: 1px solid var(--wb-blue); position: relative; box-shadow: inset 0 0 30px rgba(0,0,0,0.5); }
        #map { height: 100%; width: 100%; background: #000; }
        .map-overlay { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.7); padding: 5px 12px; border: 1px solid var(--wb-cyan); font-size: 11px; color: var(--wb-cyan); z-index: 1000; }

        /* 右パネル：テレメトリー・解析 */
        #right-panel { width: 380px; background: var(--wb-navy); display: flex; flex-direction: column; border: 1px solid var(--wb-blue); }
        #station-timeline { flex: 1; overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.3); }
        .st-entry { position: relative; padding-left: 30px; padding-bottom: 22px; border-left: 2px dashed #004488; margin-left: 10px; transition: 0.3s; }
        .st-entry::before { content: ""; position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: #003366; border: 2px solid var(--wb-navy); }
        .st-entry.active::before { background: var(--wb-red); box-shadow: 0 0 12px var(--wb-red); }
        .st-name { font-weight: bold; font-size: 14px; color: #fff; }
        .st-time { font-size: 12px; color: var(--wb-cyan); font-family: monospace; }
        
        #metrics-display { height: 180px; background: rgba(0,0,0,0.5); padding: 15px; border-top: 1px solid var(--wb-blue); font-size: 12px; line-height: 1.8; }
        .metric-val { color: var(--wb-cyan); font-weight: bold; }

        /* コンソール：ログモニター */
        #console-log { height: 130px; background: #000; color: var(--wb-cyan); font-size: 11px; padding: 12px; overflow-y: auto; border-top: 3px solid var(--wb-blue); line-height: 1.4; }
        .log-error { color: var(--wb-red); }
        .log-warn { color: var(--wb-yellow); }

        /* ロード画面 */
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .wb-spinner { width: 60px; height: 60px; border: 4px solid #111; border-top: 4px solid var(--wb-red); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="wb-spinner"></div>
    <div style="margin-top:20px; letter-spacing: 5px; font-weight: bold;">MISSION DATA LOADING...</div>
</div>

<header>
    <div style="display:flex; align-items:center; gap:20px;">
        <span class="sys-logo">WB-OCC</span>
        <span class="sys-title">WHITE BASE STRATEGIC TERMINAL</span>
    </div>
    <div>
        <span id="live-clock">00:00:00</span>
        <span id="kernel-status">PY-KERNEL: BOOTING</span>
    </div>
</header>

<div id="main-container">
    <div id="left-panel">
        <div class="panel-header">Target Acquisition (Trips)</div>
        <div class="search-area"><input type="text" id="q_input" placeholder="TRIP ID SEARCH..."></div>
        <div id="trip-list"></div>
    </div>
    
    <div id="center-panel">
        <div id="map"></div>
        <div class="map-overlay" id="map-coords">LAT: -- LON: --</div>
    </div>
    
    <div id="right-panel">
        <div class="panel-header">Station Telemetry (Timeline)</div>
        <div id="station-timeline">
            <div style="text-align:center; padding-top:50px; color:#555;">Waiting for target selection...</div>
        </div>
        <div class="panel-header">Operations Metrics</div>
        <div id="metrics-display">SYSTEM STANDBY.</div>
    </div>
</div>

<div id="console-log"></div>

<script>
    // --- JavaScript Environment ---
    const map = L.map('map', { zoomControl: false }).setView([36, 138], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let routeLayer = L.layerGroup().addTo(map);
    let markerLayer = L.layerGroup().addTo(map);

    // Pythonから参照できるよう window にグローバル展開
    window.gtfsDB = { trips: [], stops: [], stop_times: [] };

    function writeLog(msg, level="info") {
        const con = document.getElementById("console-log");
        const div = document.createElement("div");
        if(level === "error") div.className = "log-error";
        if(level === "warn") div.className = "log-warn";
        div.innerText = `[${new Date().toLocaleTimeString()}] [${level.toUpperCase()}] ${msg}`;
        con.appendChild(div); con.scrollTop = con.scrollHeight;
    }

    async function initSystem() {
        writeLog("Initializing White Base Command System...");
        try {
            const files = ['trips', 'stops', 'stop_times'];
            for(const f of files) {
                const res = await fetch(`./${f}.txt`);
                if(!res.ok) throw new Error(`${f}.txt not found`);
                const text = await res.text();
                // window.gtfsDB に格納
                window.gtfsDB[f] = Papa.parse(text.trim(), { header: true, skipEmptyLines: true }).data;
                writeLog(`Resource ${f}.txt synchronized.`);
            }
            renderTripList("");
        } catch (e) {
            writeLog(`Initialization failed: ${e.message}`, "error");
        }
    }

    function renderTripList(q) {
        const list = document.getElementById('trip-list');
        list.innerHTML = '';
        window.gtfsDB.trips.filter(t => t.trip_id.includes(q)).slice(0, 60).forEach(t => {
            const div = document.createElement('div');
            div.className = 'trip-row';
            div.innerHTML = `<div class="trip-id">${t.trip_id}</div><div class="trip-info">${t.trip_headsign || 'Standard Route'}</div>`;
            div.onclick = () => {
                document.querySelectorAll('.trip-row').forEach(r => r.classList.remove('active'));
                div.classList.add('active');
                document.getElementById('loader').style.display = 'flex';
                // Pythonに解析を依頼
                window.dispatchEvent(new CustomEvent("trigger-analysis", { detail: t.trip_id }));
            };
            list.appendChild(div);
        });
    }

    document.getElementById('q_input').oninput = (e) => renderTripList(e.target.value);
    
    // Pythonからのコールバック
    window.updateDisplay = (coords_json, stations_json, stats_json) => {
        const coords = JSON.parse(coords_json);
        const stations = JSON.parse(stations_json);
        const stats = JSON.parse(stats_json);

        routeLayer.clearLayers(); markerLayer.clearLayers();
        
        if(coords.length > 0) {
            const poly = L.polyline(coords, {color: '#ff2d55', weight: 4, opacity: 0.8}).addTo(routeLayer);
            map.fitBounds(poly.getBounds(), {padding: [60,60]});
        }

        const timeline = document.getElementById('station-timeline');
        timeline.innerHTML = '';
        stations.forEach(s => {
            const entry = document.createElement('div');
            entry.className = 'st-entry active';
            entry.innerHTML = `<div class="st-name">${s.name}</div><div class="st-time">ARR: ${s.arr} | DEP: ${s.dep}</div>`;
            entry.onclick = () => map.flyTo([s.lat, s.lon], 13);
            timeline.appendChild(entry);
            
            L.circleMarker([s.lat, s.lon], {radius: 6, color: '#00ffcc', fillColor: '#000', fillOpacity: 1, weight: 2})
                .addTo(markerLayer).bindPopup(`<b>${s.name}</b><br>Arrival: ${s.arr}`);
        });

        document.getElementById('metrics-display').innerHTML = `
            TARGET_ID: <span class="metric-val">${stats.id}</span><br>
            STATION_NODES: <span class="metric-val">${stats.count}</span> pts<br>
            EST_DISTANCE: <span class="metric-val">${stats.dist.toFixed(2)} km</span><br>
            COMM_STATUS: <span class="metric-val">ENCRYPTED</span><br>
            ANALYSIS_ENGINE: <span class="metric-val">PY-KERNEL v3.0</span>
        `;
        document.getElementById('loader').style.display = 'none';
        writeLog(`Telemetry for ${stats.id} updated successfully.`);
    };

    // マップ座標表示
    map.on('mousemove', (e) => {
        document.getElementById('map-coords').innerText = `LAT: ${e.latlng.lat.toFixed(4)} LON: ${e.latlng.lng.toFixed(4)}`;
    });

    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    initSystem();
</script>

<py-script>
import js, json, math
from pyodide.http import pyfetch
from pyodide.ffi import create_proxy

# Google Drive ID (shapes.txt用)
GD_ID = "12uumDK-VYglG26_33nkMhcVjfUaFLdrE"
SHAPES_URL = f"https://docs.google.com/spreadsheets/d/{GD_ID}/export?format=csv"

def log(msg, level="info"):
    js.writeLog(f"[PY] {msg}", level)

def get_distance(p1, p2):
    # Haversine formula
    R = 6371
    lat1, lon1 = math.radians(p1[0]), math.radians(p1[1])
    lat2, lon2 = math.radians(p2[0]), math.radians(p2[1])
    dlat, dlon = lat2-lat1, lon2-lon1
    a = math.sin(dlat/2)**2 + math.cos(lat1)*math.cos(lat2)*math.sin(dlon/2)**2
    return R * 2 * math.asin(math.sqrt(a))

async def run_analysis(event):
    trip_id = event.detail
    log(f"Starting telemetry analysis for target: {trip_id}")
    
    try:
        # 共有メモリ(window.gtfsDB)からデータを取得
        db = js.window.gtfsDB
        if not db:
            raise Exception("gtfsDB is not initialized in window scope")
            
        trips = db.trips.to_py()
        stops = db.stops.to_py()
        stop_times = db.stop_times.to_py()

        target = next((t for t in trips if t['trip_id'] == trip_id), None)
        if not target: raise Exception("Target Trip not found in DB")
        
        sid = target.get('shape_id')

        # 1. タイムライン構築
        my_st = sorted([s for s in stop_times if s['trip_id'] == trip_id], key=lambda x: int(x['stop_sequence']))
        timeline = []
        for ms in my_st:
            st = next((s for s in stops if s['stop_id'] == ms['stop_id']), None)
            if st:
                timeline.append({
                    "name": st['stop_name'], 
                    "arr": ms['arrival_time'], 
                    "dep": ms['departure_time'], 
                    "lat": float(st['stop_lat']), 
                    "lon": float(st['stop_lon'])
                })

        # 2. 形状データ取得 (Cloud)
        log(f"Requesting geometry from cloud for SHAPE_ID: {sid}")
        res = await pyfetch(SHAPES_URL)
        raw_text = await res.string()
        
        # 解析（シンプルなCSVパース）
        lines = raw_text.strip().split('\n')
        header = [x.strip() for x in lines[0].split(',')]
        idx_sid = header.index('shape_id')
        idx_lat = header.index('shape_pt_lat')
        idx_lon = header.index('shape_pt_lon')
        idx_seq = header.index('shape_pt_sequence')

        coords = []
        for line in lines[1:]:
            cols = line.split(',')
            if len(cols) > idx_sid and cols[idx_sid] == sid:
                coords.append([float(cols[idx_lat]), float(cols[idx_lon]), int(cols[idx_seq])])
        
        coords.sort(key=lambda x: x[2])
        final_coords = [[c[0], c[1]] for c in coords]

        # 3. 統計計算
        total_dist = 0
        if len(final_coords) > 1:
            for i in range(len(final_coords)-1):
                total_dist += get_distance(final_coords[i], final_coords[i+1])
        
        stats = {"id": trip_id, "count": len(timeline), "dist": total_dist}

        # JSへ返却
        js.window.updateDisplay(json.dumps(final_coords), json.dumps(timeline), json.dumps(stats))
        log("Trajectory acquisition complete.", "success")

    except Exception as e:
        log(f"CRITICAL ERROR during analysis: {str(e)}", "error")
        js.document.getElementById('loader').style.display = 'none'

# イベントリスナーの登録
js.window.addEventListener("trigger-analysis", create_proxy(run_analysis))

js.document.getElementById("kernel-status").innerText = "PY-KERNEL: ONLINE"
log("All combat systems operational. Command Terminal ready.")
</py-script>

</body>
</html>
