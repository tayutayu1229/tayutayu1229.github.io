<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB-OCC Logistics Master v7.5</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg-base: #000814; --panel-bg: #001b33; --border-primary: #004d99;
            --accent-danger: #ff2b56; --accent-active: #00ffcc; --accent-warning: #ffcc00;
            --text-silver: #e0f2f7; --lane-bg: #001b33;
            --font-main: "Segoe UI", "Meiryo", "Consolas", sans-serif;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-main); background: var(--bg-base); color: var(--text-silver); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { height: 65px; background: linear-gradient(180deg, #002b5c 0%, #001b33 100%); border-bottom: 3px solid var(--border-primary); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 1000; }
        .logo { font-size: 24px; font-weight: 900; color: var(--accent-danger); border: 2px solid var(--accent-danger); padding: 2px 12px; }
        
        #main-layout { display: grid; grid-template-columns: 380px 1fr 420px; flex: 1; overflow: hidden; gap: 4px; background: var(--border-primary); }
        .panel { background: var(--bg-base); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Left Panel */
        .search-box { padding: 15px; background: var(--panel-bg); display: flex; flex-direction: column; gap: 10px; }
        #q_input { width: 100%; background: #000; border: 1px solid var(--border-primary); color: var(--accent-active); padding: 10px; border-radius: 4px; outline: none; }
        .dict-btn { background: var(--border-primary); color: white; border: none; padding: 5px; cursor: pointer; font-size: 11px; border-radius: 4px; }
        
        #trip-list { flex: 1; overflow-y: auto; }
        .trip-card { padding: 14px; border-bottom: 1px solid rgba(0, 77, 153, 0.3); cursor: pointer; }
        .trip-card.active { background: #002244; border-left: 5px solid var(--accent-danger); }
        .area-badge { font-size: 10px; background: #555; padding: 1px 5px; border-radius: 3px; color: #fff; margin-bottom: 5px; display: inline-block; }

        /* Middle: Map */
        #map { height: 100%; width: 100%; }
        .map-tools { position: absolute; top: 10px; left: 50px; z-index: 1000; display: flex; gap: 5px; }
        .t-btn { background: #001b33; border: 1px solid var(--border-primary); color: white; padding: 5px 10px; cursor: pointer; font-size: 11px; }

        /* Right Panel: Relay Bar & Timeline */
        .relay-bar { background: #000; border-bottom: 2px solid var(--accent-danger); padding: 10px; }
        .relay-item { display: inline-block; font-size: 12px; color: var(--accent-active); font-weight: bold; background: #002244; padding: 3px 8px; border-radius: 4px; margin-right: 5px; border: 1px solid var(--border-primary); }
        
        #timeline-view { flex: 1; overflow-y: auto; padding: 20px; }
        .station-node { position: relative; padding-left: 35px; padding-bottom: 25px; border-left: 2px solid var(--border-primary); margin-left: 10px; }
        .station-node::before { content: ""; position: absolute; left: -9px; top: 0; width: 16px; height: 16px; background: var(--bg-base); border: 3px solid var(--accent-active); border-radius: 50%; box-shadow: 0 0 8px var(--accent-active); }
        
        /* Modal for Dictionary */
        #modal-dict { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; padding: 50px; }
        .modal-content { background: var(--panel-bg); height: 100%; border: 2px solid var(--border-primary); display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: var(--border-primary); display: flex; justify-content: space-between; }
        #dict-list { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }

        footer { height: 150px; display: grid; grid-template-columns: 380px 1fr; gap: 10px; padding: 10px; background: #000; border-top: 2px solid var(--border-primary); }
        #log-box { background: rgba(0,0,0,0.5); padding: 10px; font-size: 11px; color: #88aaee; overflow-y: auto; font-family: 'Consolas', monospace; }

        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #111; border-top-color: var(--accent-danger); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div style="margin-top:20px; color:var(--accent-danger);">ANALYZING RELAY SEQUENCES...</div></div>

<div id="modal-dict">
    <div class="modal-content">
        <div class="modal-header">
            <span>STATION DICTIONARY</span>
            <button onclick="document.getElementById('modal-dict').style.display='none'">CLOSE</button>
        </div>
        <div id="dict-list"></div>
    </div>
</div>

<header>
    <div class="logo">WB-OCC v7.5</div>
    <div id="clock" style="font-size: 24px; font-weight: 900; color: var(--accent-active);">00:00:00</div>
</header>

<div id="main-layout">
    <div class="panel">
        <div class="search-box">
            <button class="dict-btn" onclick="openDict()">ÈßÖ„Ç≥„Éº„ÉâËæûÂÖ∏„ÇíÈñã„Åè</button>
            <input type="text" id="q_input" placeholder="Search Trip / Station / Code...">
        </div>
        <div id="trip-list"></div>
    </div>

    <div class="panel" style="position:relative;">
        <div class="map-tools">
            <button class="t-btn" onclick="toggleMap('dark')">DARK</button>
            <button class="t-btn" onclick="toggleMap('gsi')">Âú∞ÂΩ¢Âõ≥</button>
        </div>
        <div id="map"></div>
    </div>

    <div class="panel">
        <div class="relay-bar" id="relay-container">
            <div style="font-size:10px; color:#446688; margin-bottom:5px;">ÁªßËµ∞ÂàóËªä„Ç∑„Éº„Ç±„É≥„Çπ</div>
            <div id="relay-content">--</div>
        </div>
        <div id="timeline-view"></div>
    </div>
</div>

<footer>
    <div style="padding:10px; font-size:13px;">
        <div>SELECTED: <span id="st-id" style="color:var(--accent-active)">---</span></div>
        <div>DIST: <span id="st-dist" style="color:var(--accent-active)">0.0 KM</span></div>
        <div id="st-google" style="margin-top:10px;"></div>
    </div>
    <div id="log-box">Logistics Engine Standby.</div>
</footer>

<script>
    const map = L.map('map', { zoomControl: false }).setView([36.5, 138], 6);
    const layers = {
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map),
        gsi: L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png')
    };
    let routeGroup = L.layerGroup().addTo(map);
    let markerGroup = L.layerGroup().addTo(map);

    function toggleMap(k) { Object.values(layers).forEach(l => map.removeLayer(l)); layers[k].addTo(map); }

    // üí° ÂàóËªäÁï™Âè∑„Éë„Éº„Çπ„É≠„Ç∏„ÉÉ„ÇØ v7.5
    function parseTripRelay(id) {
        const parts = id.split('_');
        const relayLanes = [];
        
        // ÊúÄÂàù„ÅÆ2„Éñ„É≠„ÉÉ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„ÄÅ3„Éñ„É≠„ÉÉ„ÇØÁõÆ‰ª•Èôç„ÇíËß£Êûê
        for (let i = 2; i < parts.length; i++) {
            const p = parts[i];
            if (p.length === 6 && /^\d+$/.test(p)) {
                // 6Ê°ÅÊï∞Â≠óÔºöÊúÄÂàù„ÅÆ4Ê°Å„ÇíÂàóËªäÁï™Âè∑„ÄÅÂæå„Çç2Ê°Å„ÇíÊûùÁï™„Å®„Åô„Çã
                relayLanes.push(p.substring(0, 4) + '„É¨');
            } else if (/^\d{3,4}$/.test(p)) {
                relayLanes.push(p + '„É¨');
            } else if (/^\d+b$/.test(p)) {
                relayLanes.push(p.replace('b', '‰æø'));
            }
        }
        return relayLanes;
    }

    window.gtfsDB = { trips: [], stops: [], stop_times: [], routes: [] };

    async function init() {
        try {
            const files = ['trips', 'stops', 'stop_times', 'routes'];
            for(const t of files) {
                const res = await fetch(`./${t}.txt`);
                const data = await res.text();
                window.gtfsDB[t] = Papa.parse(data.trim(), { header: true }).data;
            }
            renderTrips("");
        } catch (e) { console.error(e); }
    }

    function renderTrips(filter) {
        const list = document.getElementById("trip-list");
        list.innerHTML = "";
        const f = filter.toLowerCase();

        window.gtfsDB.trips.filter(t => {
            const st = window.gtfsDB.stop_times.filter(s => s.trip_id === t.trip_id).sort((a,b) => a.stop_sequence - b.stop_sequence);
            const s = window.gtfsDB.stops.find(s => s.stop_id === st[0]?.stop_id);
            const e = window.gtfsDB.stops.find(s => s.stop_id === st[st.length-1]?.stop_id);
            const match = t.trip_id.toLowerCase().includes(f) || 
                          (s?.stop_name + s?.stop_code).includes(f) || 
                          (e?.stop_name + e?.stop_code).includes(f);
            return match;
        }).slice(0, 100).forEach(t => {
            const st = window.gtfsDB.stop_times.filter(s => s.trip_id === t.trip_id).sort((a,b) => a.stop_sequence - b.stop_sequence);
            const s = window.gtfsDB.stops.find(s => s.stop_id === st[0]?.stop_id);
            const e = window.gtfsDB.stops.find(s => s.stop_id === st[st.length-1]?.stop_id);
            const route = window.gtfsDB.routes.find(r => r.route_id === t.route_id);
            
            const relays = parseTripRelay(t.trip_id);

            const card = document.createElement("div");
            card.className = "trip-card";
            card.innerHTML = `
                ${route ? `<div class="area-badge">${route.route_long_name}</div>` : ''}
                <div style="font-size:11px; color:var(--accent-active);">${t.trip_id}</div>
                <div style="font-weight:bold; font-size:14px;">
                    ${s?.stop_name}(${s?.stop_code}) ‚ñ∂ ${e?.stop_name}(${e?.stop_code})
                </div>
                <div style="font-size:11px; color:var(--accent-warning); margin-top:5px;">Á∂ôËµ∞: ${relays.join(' „Äú ')}</div>
            `;
            
            card.onclick = async () => {
                document.querySelectorAll(".trip-card").forEach(c => c.classList.remove("active"));
                card.classList.add("active");
                document.getElementById("loader").style.display = "flex";
                
                // Á∂ôËµ∞„Éê„Éº„ÅÆÊõ¥Êñ∞
                const relayHtml = relays.map(r => `<span class="relay-item">${r}</span>`).join(' <span style="font-size:10px">‚ñ∂</span> ');
                document.getElementById("relay-content").innerHTML = relayHtml;
                
                const shardKey = t.shape_id.substring(0, 2);
                const res = await fetch(`./shapes_shards/shard_${shardKey}.json`);
                const shard = await res.json();
                
                window.dispatchEvent(new CustomEvent("py-process", { 
                    detail: { tid: t.trip_id, geo: JSON.stringify(shard[t.shape_id]) } 
                }));
            };
            list.appendChild(card);
        });
    }

    function openDict() {
        const modal = document.getElementById("modal-dict");
        const list = document.getElementById("dict-list");
        list.innerHTML = "";
        window.gtfsDB.stops.sort((a,b) => a.stop_code - b.stop_code).forEach(s => {
            const item = document.createElement("div");
            item.style.padding = "5px";
            item.style.borderBottom = "1px solid #113355";
            item.innerHTML = `<span style="color:var(--accent-active)">${s.stop_code}</span>: ${s.stop_name}`;
            list.appendChild(item);
        });
        modal.style.display = "block";
    }

    window.updateUI = (geo_s, time_s, stat_s) => {
        const geo = JSON.parse(geo_s); const time = JSON.parse(time_s); const stats = JSON.parse(stat_s);
        routeGroup.clearLayers(); markerGroup.clearLayers();
        if(geo.length > 0) {
            L.polyline(geo, { color: 'var(--accent-danger)', weight: 4 }).addTo(routeGroup);
            map.fitBounds(L.polyline(geo).getBounds(), { padding: [50, 50] });
        }
        const view = document.getElementById("timeline-view");
        view.innerHTML = "";
        time.forEach(s => {
            const d = document.createElement("div");
            d.className = "station-node";
            const sInfo = window.gtfsDB.stops.find(st => st.stop_name === s.name);
            d.innerHTML = `
                <div style="font-weight:bold;">${s.name}${sInfo ? `(${sInfo.stop_code})` : ''}</div>
                <div style="color:var(--accent-warning); font-size:12px;">ÁùÄ ${s.arr} / Áô∫ ${s.dep}</div>
            `;
            view.appendChild(d);
            L.circleMarker([s.lat, s.lon], { radius: 5, color: '#00ffcc', fillOpacity: 1 }).addTo(markerGroup);
        });
        document.getElementById("st-id").innerText = stats.id;
        document.getElementById("st-dist").innerText = stats.dist.toFixed(2) + " KM";
        document.getElementById("loader").style.display = "none";
    };

    setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleTimeString(); }, 1000);
    init();
    document.getElementById("q_input").oninput = (e) => renderTrips(e.target.value);
</script>

<py-script>
import js, json, math
from pyodide.ffi import create_proxy

async def process(event):
    data = event.detail.to_py()
    coords = json.loads(data['geo'])
    tid = data['tid']
    try:
        db = js.window.gtfsDB
        st = sorted([s for s in db.stop_times.to_py() if s['trip_id'] == tid], key=lambda x: int(x['stop_sequence']))
        stops = {s['stop_id']: s for s in db.stops.to_py()}
        timeline = [{"name": stops[r['stop_id']]['stop_name'], "arr": r['arrival_time'], "dep": r['departure_time'], "lat": float(stops[r['stop_id']]['stop_lat']), "lon": float(stops[r['stop_id']]['stop_lon'])} for r in st]
        
        dist = 0
        for i in range(len(coords)-1):
            p1, p2 = coords[i], coords[i+1]
            a = math.sin(math.radians(p2[0]-p1[0])/2)**2 + math.cos(math.radians(p1[0]))*math.cos(math.radians(p2[0]))*math.sin(math.radians(p2[1]-p1[1])/2)**2
            dist += 6371 * 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
            
        js.window.updateUI(json.dumps(coords), json.dumps(timeline), json.dumps({"id": tid, "dist": dist}))
    except Exception as e:
        js.console.error(str(e))
        js.document.getElementById('loader').style.display = 'none'

js.window.addEventListener("py-process", create_proxy(process))
</py-script>
</body>
</html>
