<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WB-OCC OPERATIONAL COMMAND v8.7</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --panel-bg: #2d2d30;
            --accent-blue: #0078d4;
            --text-main: #f5f5f5;
            --text-dim: #cccccc;
            --border-color: #3f3f46;
        }
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: "Segoe UI", "Meiryo", sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Layout */
        header { 
            height: 50px; 
            background: #000; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 20px; 
            border-bottom: 2px solid var(--accent-blue);
        }
        #main-layout { display: grid; grid-template-columns: 350px 1fr 400px; flex: 1; overflow: hidden; background: #000; gap: 1px; }
        .panel { background: var(--panel-bg); display: flex; flex-direction: column; overflow: hidden; }
        
        .panel-header {
            background: #333337;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
        }

        /* List Area */
        .search-area { padding: 12px; border-bottom: 1px solid var(--border-color); }
        #q_input { 
            width: 100%; 
            background: #3f3f46; 
            border: 1px solid #555; 
            color: #fff; 
            padding: 10px; 
            font-size: 14px;
            outline: none;
        }
        #trip-list { flex: 1; overflow-y: auto; }
        .trip-card { 
            padding: 15px 12px; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            transition: background 0.2s;
        }
        .trip-card:hover { background: #3e3e42; }
        .trip-card.active { background: var(--accent-blue); }

        /* Relay Bar */
        .relay-display { 
            padding: 12px; 
            background: #252526; 
            border-bottom: 1px solid var(--border-color);
        }
        .relay-text { 
            font-size: 16px; 
            font-weight: bold; 
            color: var(--accent-blue); 
            display: block;
            margin-top: 4px;
        }

        /* Timeline Table */
        #timeline-view { flex: 1; overflow-y: auto; padding: 0; }
        .st-table { width: 100%; border-collapse: collapse; }
        .st-table th { background: #333; position: sticky; top: 0; text-align: left; font-size: 12px; padding: 10px; border-bottom: 2px solid #555; }
        .st-table td { padding: 12px 10px; font-size: 14px; border-bottom: 1px solid #3f3f46; }

        /* Report Modal */
        #modal-op { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; padding: 40px; }
        .op-sheet { 
            background: #fff; 
            color: #000; 
            max-width: 900px; 
            height: 100%; 
            margin: 0 auto; 
            padding: 50px; 
            overflow-y: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        button {
            background: var(--accent-blue);
            color: #fff;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }
        button:hover { opacity: 0.9; }

        #loader { position: fixed; top: 60px; right: 20px; background: var(--accent-blue); padding: 5px 15px; font-size: 12px; display: none; }
    </style>
</head>
<body>

<div id="loader">SYSTEM_BUSY</div>

<header>
    <div style="font-size: 18px; font-weight: bold; letter-spacing: 1px;">OCC OPERATIONAL TERMINAL</div>
    <div id="clock" style="font-family: monospace; font-size: 18px;">00:00:00</div>
</header>

<div id="main-layout">
    <div class="panel">
        <div class="panel-header">Unit Search</div>
        <div class="search-area"><input type="text" id="q_input" placeholder="Enter Trip ID or Station Name..."></div>
        <div id="trip-list"></div>
    </div>

    <div class="panel">
        <div class="panel-header">Geographic Monitor</div>
        <div id="map" style="flex:1;"></div>
    </div>

    <div class="panel">
        <div class="panel-header">Lane Sequence</div>
        <div class="relay-display">
            <span style="font-size:11px; color:#888;">CURRENT_RELAY_SEQ:</span>
            <span id="relay-text" class="relay-text">--</span>
        </div>
        <div id="timeline-view">
            <table class="st-table">
                <thead><tr><th>CODE</th><th>STATION</th><th>ARR</th><th>DEP</th></tr></thead>
                <tbody id="st-body"></tbody>
            </table>
        </div>
        <div style="padding:15px; background:#252526; display:flex; gap:10px;">
            <button style="flex:1;" onclick="showOpSheet()">GENERATE_REPORT</button>
            <button style="background:#444;" onclick="location.reload()">RESET</button>
        </div>
    </div>
</div>

<div id="modal-op">
    <div style="text-align:right; margin-bottom:10px;">
        <button onclick="window.print()">PRINT_PDF</button>
        <button style="background:#f44336;" onclick="document.getElementById('modal-op').style.display='none'">CLOSE</button>
    </div>
    <div class="op-sheet" id="op-content"></div>
</div>

<script>
    const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([36.5, 138], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let routeGroup = L.layerGroup().addTo(map);
    let markerGroup = L.layerGroup().addTo(map);

    window.gtfsDB = { trips: [], stops: {}, stopTimes: {}, stopToTrips: {} };
    let currentTripData = null;
    let currentTripId = "";

    function parseRelayText(id) {
        const parts = id.split('_').slice(2);
        return parts.map(p => {
            if (p.endsWith('b')) return p.replace('b', '‰æø');
            if (p.length === 6 && /^\d+$/.test(p)) return p.substring(0, 4) + '„É¨';
            if (/^\d{2,4}$/.test(p)) return p + '„É¨';
            return p;
        }).filter(p => p !== "").join(" „Äú ");
    }

    async function init() {
        document.getElementById("loader").style.display = "block";
        try {
            const [t, s, st] = await Promise.all([
                fetch('./trips.txt').then(r => r.text()),
                fetch('./stops.txt').then(r => r.text()),
                fetch('./stop_times.txt').then(r => r.text())
            ]);
            window.gtfsDB.trips = Papa.parse(t.trim(), { header: true }).data;
            Papa.parse(s.trim(), { header: true }).data.forEach(x => { window.gtfsDB.stops[x.stop_id] = x; });
            Papa.parse(st.trim(), { header: true }).data.forEach(x => {
                if (!window.gtfsDB.stopTimes[x.trip_id]) window.gtfsDB.stopTimes[x.trip_id] = [];
                window.gtfsDB.stopTimes[x.trip_id].push(x);
                const sobj = window.gtfsDB.stops[x.stop_id];
                if(sobj) {
                    [sobj.stop_name, sobj.stop_code].forEach(k => {
                        if(!window.gtfsDB.stopToTrips[k]) window.gtfsDB.stopToTrips[k] = new Set();
                        window.gtfsDB.stopToTrips[k].add(x.trip_id);
                    });
                }
            });
            renderTrips("");
        } catch (e) { console.error(e); }
        document.getElementById("loader").style.display = "none";
    }

    function renderTrips(filter) {
        const list = document.getElementById("trip-list");
        list.innerHTML = "";
        const f = filter.toLowerCase();
        window.gtfsDB.trips.filter(t => {
            if (!f) return true;
            if (t.trip_id.toLowerCase().includes(f)) return true;
            return Object.keys(window.gtfsDB.stopToTrips).some(k => k.includes(f) && window.gtfsDB.stopToTrips[k].has(t.trip_id));
        }).slice(0, 50).forEach(t => {
            const st = window.gtfsDB.stopTimes[t.trip_id] || [];
            const sName = window.gtfsDB.stops[st[0]?.stop_id]?.stop_name || "??";
            const eName = window.gtfsDB.stops[st[st.length-1]?.stop_id]?.stop_name || "??";
            const card = document.createElement("div");
            card.className = "trip-card";
            card.innerHTML = `<div style="font-size:11px; color:#888;">${t.trip_id}</div><div style="font-weight:bold;">${sName} ‚ñ∂ ${eName}</div>`;
            card.onclick = () => loadTrip(t);
            list.appendChild(card);
        });
    }

    async function loadTrip(t) {
        currentTripId = t.trip_id;
        document.getElementById("loader").style.display = "block";
        const shardKey = t.shape_id.substring(0, 2);
        const shard = await fetch(`./shapes_shards/shard_${shardKey}.json`).then(r => r.json());
        
        document.getElementById("relay-text").innerText = parseRelayText(t.trip_id);

        window.dispatchEvent(new CustomEvent("py-process", { 
            detail: { tid: t.trip_id, geo: JSON.stringify(shard[t.shape_id]) } 
        }));
    }

    window.updateUI = (geo_s, time_s) => {
        const time = JSON.parse(time_s); 
        currentTripData = time;
        const geo = JSON.parse(geo_s);
        routeGroup.clearLayers(); markerGroup.clearLayers();

        // üí° Á®ÆÂà•„Å´„Çà„ÇãÊèè„ÅçÂàÜ„Åë
        const isTruck = parseRelayText(currentTripId).includes('‰æø');
        if (isTruck) {
            L.polyline(geo, { color: '#0078d4', weight: 6, opacity: 0.8 }).addTo(routeGroup);
        } else {
            L.polyline(geo, { color: '#000', weight: 5 }).addTo(routeGroup);
            L.polyline(geo, { color: '#fff', weight: 2, dashArray: '8, 12' }).addTo(routeGroup);
        }

        map.fitBounds(L.polyline(geo).getBounds(), { padding: [40,40] });
        
        const tbody = document.getElementById("st-body");
        tbody.innerHTML = "";
        time.forEach(s => {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${s.code}</td><td>${s.name}</td><td>${s.arr}</td><td>${s.dep}</td>`;
            tbody.appendChild(row);
            L.circleMarker([s.lat, s.lon], { radius: 4, color: '#fff', fillColor: '#000', fillOpacity: 1, weight: 2 }).addTo(markerGroup);
        });
        document.getElementById("loader").style.display = "none";
    };

    function showOpSheet() {
        if(!currentTripData) return;
        const modal = document.getElementById("modal-op");
        const content = document.getElementById("op-content");
        let rows = currentTripData.map(s => `<tr><td>${s.code}</td><td>${s.name}</td><td>${s.arr}</td><td>${s.dep}</td><td></td></tr>`).join("");
        content.innerHTML = `
            <div style="border-bottom:3px solid #000; padding-bottom:10px; margin-bottom:20px;">
                <h1 style="margin:0; text-align:center;">Ë≤®Áâ©ÂàóËªäÈÅãË°åË°®</h1>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <span>Ë≠òÂà•Áï™Âè∑: ${currentTripId}</span>
                    <span>Á∂ôËµ∞Âå∫ÂàÜ: ${document.getElementById("relay-text").innerText}</span>
                </div>
            </div>
            <table style="width:100%; border-collapse:collapse;" border="1">
                <thead><tr style="background:#eee;"><th>ÈßÖ„Ç≥„Éº„Éâ</th><th>ÂÅúËªäÈßÖ</th><th>ÁùÄÊôÇÂàª</th><th>Áô∫ÊôÇÂàª</th><th>Ë®ò‰∫ã</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        `;
        modal.style.display = "block";
    }

    setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleTimeString(); }, 1000);
    init();
    document.getElementById("q_input").oninput = (e) => renderTrips(e.target.value);
</script>

<py-script>
import js, json
from pyodide.ffi import create_proxy

async def process(event):
    data = event.detail.to_py()
    coords = json.loads(data['geo'])
    tid = data['tid']
    try:
        db = js.window.gtfsDB
        # JS Proxy object handling
        st_data = db.stopTimes.to_py()
        if tid not in st_data:
            return
            
        st_list = sorted(st_data[tid], key=lambda x: int(x['stop_sequence']))
        stops_dict = db.stops.to_py()
        
        timeline = []
        for r in st_list:
            sid = r['stop_id']
            if sid in stops_dict:
                s = stops_dict[sid]
                timeline.append({
                    "name": s['stop_name'],
                    "code": s['stop_code'],
                    "arr": r['arrival_time'],
                    "dep": r['departure_time'],
                    "lat": float(s['stop_lat']),
                    "lon": float(s['stop_lon'])
                })
        js.window.updateUI(json.dumps(coords), json.dumps(timeline))
    except Exception as e:
        js.console.error("Python Runtime Error: " + str(e))
        js.document.getElementById('loader').style.display = 'none'

js.window.addEventListener("py-process", create_proxy(process))
</py-script>
</body>
</html>
