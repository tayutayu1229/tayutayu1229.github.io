<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WB-OCC 運行管理 v9.4</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --bg: #1e1e1e; --panel: #2d2d30; --text: #f5f5f5; --border: #3f3f46; --accent: #0078d4; }
        body.light-mode { --bg: #f3f3f3; --panel: #ffffff; --text: #000000; --border: #cccccc; --accent: #005a9e; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Helvetica Neue", "Arial", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { height: 50px; background: #000; color: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 2px solid var(--accent); z-index: 100; }
        
        #main-layout { display: grid; grid-template-columns: 350px 1fr 400px; flex: 1; overflow: hidden; gap: 1px; background: var(--border); }
        .panel { background: var(--panel); display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { background: rgba(0,0,0,0.1); padding: 8px 12px; font-size: 13px; font-weight: bold; border-bottom: 1px solid var(--border); }
        
        .control-box { padding: 10px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; }
        input, select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px; font-size: 13px; border-radius: 4px; }
        
        #trip-list { flex: 1; overflow-y: auto; }
        .trip-card { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; border-left: 4px solid transparent; }
        .trip-card:hover { background: rgba(0,120,212,0.1); }
        .trip-card.active { background: var(--accent); color: #fff; border-left-color: #fff; }
        .card-relay { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .card-range { font-size: 11px; color: #3498db; }
        body.light-mode .card-range { color: #005a9e; }
        .active .card-range { color: #d1ecf1; }

        .relay-area { padding: 12px; background: rgba(0,120,212,0.1); border-bottom: 1px solid var(--border); }
        .relay-text { font-size: 15px; font-weight: bold; color: var(--accent); }

        .st-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .st-table th { background: rgba(0,0,0,0.2); position: sticky; top: 0; padding: 10px 8px; text-align: left; }
        .st-table td { padding: 8px; border-bottom: 1px solid var(--border); }

        /* 印刷レイアウト（書類風・4割縮小） */
        @media print {
            @page { size: A4; margin: 15mm; }
            body * { visibility: hidden; background: #fff !important; color: #000 !important; }
            #modal-op, #modal-op * { visibility: visible; }
            #modal-op { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; }
            .op-sheet { width: 100%; border: none; box-shadow: none; padding: 0; font-size: 0.6rem !important; color: #000; }
            .op-sheet h2 { border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px; font-size: 1.2rem; }
            .op-sheet table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.6rem !important; }
            .op-sheet th, .op-sheet td { border: 1px solid #000; padding: 4px 6px; }
            .op-sheet .meta-info { display: flex; justify-content: space-between; margin-bottom: 10px; border: 1px solid #ccc; padding: 8px; }
            .no-print { display: none !important; }
        }

        #modal-op { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; padding: 20px; overflow-y: auto; }
        .op-sheet { background: #fff; color: #000; width: 210mm; margin: 0 auto; padding: 20mm; min-height: 297mm; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        #modal-dic { display: none; position: fixed; top: 55px; left: 15px; width: 340px; background: var(--panel); border: 1px solid var(--accent); z-index: 1000; padding: 15px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
        #dic-list { max-height: 500px; overflow-y: auto; margin-top: 10px; border-top: 1px solid var(--border); }
        .dic-item { padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; }
        .dic-item:hover { background: rgba(255,255,255,0.05); }

        button { padding: 8px 12px; cursor: pointer; background: var(--accent); color: #fff; border: none; font-size: 12px; border-radius: 4px; }
        #loader { position: fixed; top: 60px; right: 20px; background: #f1c40f; color: #000; padding: 6px 12px; display: none; z-index: 10001; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
<div id="loader">DATA LOADING...</div>
<header>
    <div style="display:flex; align-items:center; gap:20px;">
        <span style="font-size:18px; font-weight:bold; letter-spacing:1px;">WB-OCC v9.4</span>
        <button onclick="toggleDic()" style="background:#444;">駅コード辞書</button>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <select id="map-mode" onchange="updateMapLayers()" style="height:30px;">
            <option value="standard">通常地図</option>
            <option value="sat">衛星写真</option>
        </select>
        <button onclick="toggleTheme()" id="theme-btn">モード切替</button>
        <div id="clock" style="font-family:monospace; font-size:16px; width:85px;">00:00:00</div>
    </div>
</header>

<div id="main-layout">
    <div class="panel">
        <div class="panel-title">列車一覧 / 検索</div>
        <div class="control-box">
            <input type="date" id="base_date">
            <select id="route_filter" onchange="renderTrips(document.getElementById('q_input').value)">
                <option value="">全ての方面を表示</option>
            </select>
            <input type="text" id="q_input" placeholder="列車番号または駅名を入力...">
        </div>
        <div id="trip-list"></div>
    </div>
    <div class="panel">
        <div class="panel-title">位置モニタ</div>
        <div id="map" style="flex:1;"></div>
    </div>
    <div class="panel">
        <div class="panel-title">運行計画・継走情報</div>
        <div class="relay-area">
            <div id="relay-text" class="relay-text">-</div>
        </div>
        <div style="flex:1; overflow-y:auto;">
            <table class="st-table">
                <thead><tr><th>駅コード</th><th>停車駅</th><th>到着時刻</th><th>出発時刻</th></tr></thead>
                <tbody id="st-body"></tbody>
            </table>
        </div>
        <div style="padding:12px; border-top:1px solid var(--border);">
            <button style="width:100%; padding:12px; font-weight:bold;" onclick="showOpSheet()">運行順序表 (A4書類) を生成</button>
        </div>
    </div>
</div>

<div id="modal-dic">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <b style="font-size:14px;">駅コード一覧</b>
        <button onclick="toggleDic()" style="background:transparent; color:#888; font-size:20px; padding:0;">×</button>
    </div>
    <input type="text" id="dic_search" placeholder="駅名でフィルタ..." style="width:100%;" oninput="filterDic()">
    <div id="dic-list"></div>
</div>

<div id="modal-op">
    <div class="no-print" style="max-width:210mm; margin: 0 auto 15px auto; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
        <button onclick="window.print()" style="background:#2ecc71; padding:10px 25px;">印刷 / PDF保存</button>
        <button onclick="document.getElementById('modal-op').style.display='none'" style="background:#e74c3c; padding:10px 25px;">閉じる</button>
    </div>
    <div class="op-sheet" id="op-content"></div>
</div>

<script>
    const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([36.5, 138], 6);
    const tiles = {
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
        sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
    };
    tiles.dark.addTo(map);

    window.gtfsDB = { trips: [], stops: {}, stopTimes: {}, routes: {} };
    let currentTripId = "";
    let currentTimeline = [];

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        updateMapLayers();
    }

    function updateMapLayers() {
        const isLight = document.body.classList.contains('light-mode');
        const mode = document.getElementById('map-mode').value;
        Object.values(tiles).forEach(t => map.removeLayer(t));
        if (mode === 'sat') tiles.sat.addTo(map);
        else tiles[isLight ? 'light' : 'dark'].addTo(map);
    }

    async function init() {
        document.getElementById("loader").style.display = "block";
        document.getElementById('base_date').valueAsDate = new Date();
        const [tr, st, s, rt] = await Promise.all([
            fetch('./trips.txt').then(r => r.text()), fetch('./stop_times.txt').then(r => r.text()),
            fetch('./stops.txt').then(r => r.text()), fetch('./routes.txt').then(r => r.text())
        ]);
        
        Papa.parse(rt.trim(), { header: true }).data.forEach(r => {
            if(r.route_id) {
                window.gtfsDB.routes[r.route_id] = r;
                const opt = document.createElement('option');
                opt.value = r.route_id; opt.innerText = r.route_long_name;
                document.getElementById('route_filter').appendChild(opt);
            }
        });

        window.gtfsDB.trips = Papa.parse(tr.trim(), { header: true }).data;
        Papa.parse(s.trim(), { header: true }).data.forEach(x => { window.gtfsDB.stops[x.stop_id] = x; });
        Papa.parse(st.trim(), { header: true }).data.forEach(x => {
            if (!window.gtfsDB.stopTimes[x.trip_id]) window.gtfsDB.stopTimes[x.trip_id] = [];
            window.gtfsDB.stopTimes[x.trip_id].push(x);
        });
        
        createDic();
        renderTrips("");
        document.getElementById("loader").style.display = "none";
    }

    function getRelayString(tid, timeline) {
        const parts = tid.split('_').slice(2);
        return parts.map((p, i) => {
            const stop = timeline[i] || {name:""};
            const isRoad = stop.name.includes("オフレール") || stop.name.includes("営業所");
            if (p.endsWith('b') || isRoad) return parseInt(p, 10) + "便";
            return (p.length >= 4 ? p.substring(0,4) : p) + "レ";
        }).join("〜");
    }

    function renderTrips(f) {
        const list = document.getElementById("trip-list");
        list.innerHTML = "";
        const rf = document.getElementById('route_filter').value;
        const filter = f.toLowerCase();

        window.gtfsDB.trips.filter(t => {
            const matchRoute = rf === "" || t.route_id === rf;
            const matchText = t.trip_id.toLowerCase().includes(filter);
            return matchRoute && matchText;
        }).slice(0, 50).forEach(t => {
            const st = window.gtfsDB.stopTimes[t.trip_id] || [];
            const sName = window.gtfsDB.stops[st[0]?.stop_id]?.stop_name || "-";
            const eName = window.gtfsDB.stops[st[st.length-1]?.stop_id]?.stop_name || "-";
            const relay = t.trip_id.split('_').slice(2).map(p => p.endsWith('b') ? p.replace('b','便') : p.substring(0,4)+'レ').join("〜");

            const card = document.createElement("div");
            card.className = "trip-card" + (t.trip_id === currentTripId ? " active" : "");
            card.innerHTML = `
                <div style="font-size:9px; opacity:0.6; margin-bottom:2px;">${t.trip_id}</div>
                <div class="card-relay">${relay}</div>
                <div class="card-range">${sName} 〜 ${eName}</div>
            `;
            card.onclick = () => loadTrip(t);
            list.appendChild(card);
        });
    }

    async function loadTrip(t) {
        currentTripId = t.trip_id;
        document.getElementById("loader").style.display = "block";
        const shard = await fetch(`./shapes_shards/shard_${t.shape_id.substring(0, 2)}.json`).then(r => r.json());
        window.dispatchEvent(new CustomEvent("py-process", { detail: { tid: t.trip_id, geo: JSON.stringify(shard[t.shape_id]) } }));
    }

    window.updateUI = (geo_s, time_s) => {
        const timeRaw = JSON.parse(time_s);
        const geoPoints = JSON.parse(geo_s);
        const bDate = document.getElementById('base_date').value;
        
        currentTimeline = timeRaw.map(s => {
            if(!s.arr || s.arr.includes("undefined")) return { ...s, arrP: " - ", depP: " - " };
            let [h, m] = s.arr.split(':').map(Number);
            let dOff = Math.floor(h/24);
            let dt = new Date(bDate); dt.setDate(dt.getDate()+dOff);
            let dayLabel = dOff > 0 ? `+${dOff}日 ` : "";
            return { 
                ...s, 
                arrP: `${dayLabel}${String(h%24).padStart(2,'0')}:${String(m).padStart(2,'0')}`,
                depP: s.dep && !s.dep.includes("undefined") ? `${dayLabel}${String(Number(s.dep.split(':')[0])%24).padStart(2,'0')}:${s.dep.split(':')[1]}` : " - "
            };
        });

        document.getElementById("relay-text").innerText = getRelayString(currentTripId, currentTimeline);

        map.eachLayer(l => { if(l instanceof L.Polyline || l instanceof L.CircleMarker) map.removeLayer(l); });
        for(let i=0; i<currentTimeline.length-1; i++) {
            const s = currentTimeline[i], e = currentTimeline[i+1];
            const isRoad = s.name.includes("オフレール") || s.name.includes("営業所") || e.name.includes("オフレール") || e.name.includes("営業所");
            const seg = [[s.lat, s.lon], [e.lat, e.lon]];
            if(isRoad) L.polyline(seg, { color: '#0078d4', weight: 6 }).addTo(map);
            else { L.polyline(seg, { color: '#000', weight: 5 }).addTo(map); L.polyline(seg, { color: '#fff', weight: 2, dashArray: '8,12' }).addTo(map); }
        }
        currentTimeline.forEach(s => L.circleMarker([s.lat, s.lon], { radius: 4, color: '#fff', fillColor: '#000', fillOpacity: 1, weight: 2 }).addTo(map).bindPopup(s.name));
        map.fitBounds(L.polyline(geoPoints).getBounds(), { padding: [40,40] });
        
        document.getElementById("st-body").innerHTML = currentTimeline.map(s => `<tr><td>${s.code}</td><td><b>${s.name}</b></td><td>${s.arrP}</td><td>${s.depP}</td></tr>`).join("");
        document.getElementById("loader").style.display = "none";
        renderTrips(document.getElementById("q_input").value);
    };

    function showOpSheet() {
        if(!currentTripId) return;
        const info = getRelayString(currentTripId, currentTimeline);
        const sName = currentTimeline[0]?.name;
        const eName = currentTimeline[currentTimeline.length-1]?.name;
        const content = document.getElementById("op-content");
        content.innerHTML = `
            <div style="text-align:right; font-size:0.6rem; margin-bottom:5px;">作成日: ${new Date().toLocaleDateString()}</div>
            <h2 style="text-align:center;">貨物列車 運行順序表</h2>
            <div class="meta-info">
                <div>
                    <b>継走番号:</b> ${info}<br>
                    <b>運行区間:</b> ${sName} 〜 ${eName}
                </div>
                <div style="text-align:right;">
                    <b>指定日:</b> ${document.getElementById("base_date").value}<br>
                    <b>管理番号:</b> ${currentTripId.substring(0,8)}
                </div>
            </div>
            <table>
                <thead><tr style="background:#f2f2f2;"><th>駅コード</th><th>停車駅 / ORS名</th><th>到着</th><th>出発</th><th>記事</th></tr></thead>
                <tbody>${currentTimeline.map(s => `<tr><td style="text-align:center">${s.code}</td><td><b>${s.name}</b></td><td style="text-align:center">${s.arrP}</td><td style="text-align:center">${s.depP}</td><td></td></tr>`).join("")}</tbody>
            </table>
            <div style="margin-top:20px; font-size:0.5rem; color:#666; border-top:1px solid #eee; padding-top:5px;">
                ※ 本書類はWB-OCC運行管理システムにより生成されました。ORS区間は道路交通状況により変動する場合があります。
            </div>
        `;
        document.getElementById("modal-op").style.display = "block";
    }

    function createDic() {
        const list = document.getElementById("dic-list");
        list.innerHTML = "";
        const sortedStops = Object.values(window.gtfsDB.stops)
            .filter(s => s.stop_code && s.stop_code !== "undefined")
            .sort((a,b) => a.stop_code.localeCompare(b.stop_code));
        
        sortedStops.forEach(s => {
            const div = document.createElement("div");
            div.className = "dic-item";
            div.innerHTML = `<b>${s.stop_code}</b> <span style="color:#aaa;">${s.stop_name}</span>`;
            div.onclick = () => { document.getElementById("q_input").value = s.stop_name; renderTrips(s.stop_name); toggleDic(); };
            list.appendChild(div);
        });
    }

    function filterDic() {
        const q = document.getElementById("dic_search").value.toLowerCase();
        Array.from(document.getElementsByClassName("dic-item")).forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(q) ? "flex" : "none";
        });
    }

    function toggleDic() { 
        const d = document.getElementById("modal-dic");
        d.style.display = d.style.display === "block" ? "none" : "block"; 
    }
    
    setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleTimeString('ja-JP', {hour12:false}); }, 1000);
    init();
    document.getElementById("q_input").oninput = (e) => renderTrips(e.target.value);
</script>

<py-script>
import js, json
from pyodide.ffi import create_proxy

async def process(event):
    data = event.detail.to_py()
    tid = data['tid']
    try:
        db = js.window.gtfsDB
        st_data = db.stopTimes.to_py()
        st_list = sorted(st_data[tid], key=lambda x: int(x['stop_sequence']))
        stops = db.stops.to_py()
        timeline = []
        for r in st_list:
            s = stops.get(r['stop_id'], {})
            timeline.append({
                "name": s.get('stop_name', "-"), 
                "code": s.get('stop_code', "-") if s.get('stop_code') != "undefined" else "-",
                "arr": str(r.get('arrival_time', "undefined")),
                "dep": str(r.get('departure_time', "undefined")),
                "lat": float(s.get('stop_lat', 0)), 
                "lon": float(s.get('stop_lon', 0))
            })
        js.window.updateUI(data['geo'], json.dumps(timeline))
    except Exception as e:
        js.console.error(f"Python Error: {str(e)}")
        js.document.getElementById("loader").style.display = "none"

js.window.addEventListener("py-process", create_proxy(process))
</py-script>
</body>
</html>
