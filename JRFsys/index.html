<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WB-OCC é‹è¡Œç®¡ç† v10.8 [Complete Edition]</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --bg: #f3f3f3; --panel: #ffffff; --text: #000000; --border: #cccccc; --accent: #005a9e; }
        body.dark-mode { --bg: #1e1e1e; --panel: #2d2d30; --text: #f5f5f5; --border: #3f3f46; --accent: #0078d4; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Helvetica Neue", "Segoe UI", "Meiryo", sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 50px; background: #000; color: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 2px solid var(--accent); flex-shrink: 0; }
        #main-layout { display: grid; grid-template-columns: 350px 1fr 420px; flex: 1; overflow: hidden; gap: 1px; background: var(--border); }
        .panel { background: var(--panel); display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { background: rgba(0,0,0,0.05); padding: 8px 12px; font-size: 13px; font-weight: bold; border-bottom: 1px solid var(--border); }
        .control-box { padding: 10px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; }
        input, select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px; font-size: 13px; border-radius: 4px; }
        #trip-list { flex: 1; overflow-y: auto; }
        .trip-card { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; border-left: 4px solid transparent; }
        .trip-card.active { background: var(--accent); color: #fff; }
        .card-relay { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .card-range { font-size: 11px; color: #3498db; }
        .relay-area { padding: 12px; background: rgba(0,90,158,0.05); border-bottom: 1px solid var(--border); }
        .relay-text { font-size: 15px; font-weight: bold; color: var(--accent); }
        .st-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .st-table th { background: rgba(0,0,0,0.05); position: sticky; top: 0; padding: 10px 8px; text-align: left; }
        .st-table td { padding: 8px; border-bottom: 1px solid var(--border); }
        .weather-btn { font-size: 10px; background: #2ecc71; color: white; border: none; padding: 2px 5px; border-radius: 3px; cursor: pointer; margin-left: 5px; }
        #weather-toast { display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 15px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 2000; border: 2px solid var(--accent); min-width: 250px; text-align: center; }
        #modal-op { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto; padding: 20px; }
        .op-container { background: white; width: 210mm; margin: 0 auto; min-height: 297mm; padding: 15mm; position: relative; color: #000; }
        #log-panel { display: none; height: 100px; background: #000; color: #ffffff; font-family: monospace; font-size: 11px; padding: 10px; overflow-y: auto; border-top: 2px solid var(--accent); }
        @media print {
            body * { visibility: hidden; }
            #modal-op, #modal-op * { visibility: visible; }
            #modal-op { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; padding: 0; margin: 0; }
            .op-container { box-shadow: none; border: none; width: 100%; padding: 10mm; transform: scale(0.9); transform-origin: top center; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="light-mode">
<div id="loader" style="position:fixed; top:60px; right:20px; background:#f1c40f; color:#000; padding:6px 12px; display:none; z-index:10001; font-weight:bold; border-radius:4px;">ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...</div>
<header>
    <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-size:18px; font-weight:bold;">WB-OCC v10.8</span>
        <button id="log-toggle-btn" onclick="toggleLog()" style="background:#444;">ãƒ­ã‚°è¡¨ç¤º</button>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <select id="map-mode" onchange="updateMapLayers()">
            <option value="standard">é€šå¸¸åœ°å›³ (Carto)</option>
            <option value="gsi">å›½åœŸåœ°ç†é™¢ (æ¨™æº–)</option>
            <option value="osm">OpenStreetMap</option>
            <option value="sat">è¡›æ˜Ÿå†™çœŸ (ESRI)</option>
        </select>
        <button onclick="toggleTheme()">èƒŒæ™¯è‰²åˆ‡æ›¿</button>
        <div id="clock">00:00:00</div>
    </div>
</header>

<div id="main-layout">
    <div class="panel">
        <div class="panel-title">åˆ—è»Šæ¤œç´¢</div>
        <div class="control-box">
            <input type="date" id="base_date">
            <select id="route_filter" onchange="renderTrips(document.getElementById('q_input').value)">
                <option value="">å…¨ã¦ã®æ–¹é¢</option>
            </select>
            <input type="text" id="q_input" placeholder="åˆ—è»Šç•ªå·ã¾ãŸã¯åœè»Šé§…å..." oninput="renderTrips(this.value)">
        </div>
        <div id="trip-list"></div>
    </div>
    <div class="panel" style="position:relative;">
        <div class="panel-title">ä½ç½®ãƒ¢ãƒ‹ã‚¿</div>
        <div id="weather-toast"></div>
        <div id="map" style="flex:1;"></div>
        <div id="log-panel"></div>
    </div>
    <div class="panel">
        <div class="panel-title">é‹è¡Œè¨ˆç”»ãƒ»ç¶™èµ°æƒ…å ±</div>
        <div class="relay-area"><div id="relay-text" class="relay-text">-</div></div>
        <div style="flex:1; overflow-y:auto;">
            <table class="st-table">
                <thead><tr><th>é§…ã‚³ãƒ¼ãƒ‰</th><th>åœè»Šé§…</th><th>åˆ°ç€æ™‚åˆ»</th><th>å‡ºç™ºæ™‚åˆ»</th></tr></thead>
                <tbody id="st-body"></tbody>
            </table>
        </div>
        <div style="padding:12px; border-top:1px solid var(--border);">
            <button style="width:100%" onclick="showOpSheet()">è¼¸é€åˆ—è»Šé †åºè³‡æ–™ (PDF) ç”Ÿæˆ</button>
        </div>
    </div>
</div>

<div id="modal-op">
    <div class="no-print" style="max-width:210mm; margin: 0 auto 10px auto; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="window.print()" style="background:#2ecc71; font-weight: bold; color:white;">å°åˆ· / PDFä¿å­˜</button>
        <button onclick="document.getElementById('modal-op').style.display='none'" style="background:#e74c3c; font-weight: bold; color:white;">é–‰ã˜ã‚‹</button>
    </div>
    <div class="op-container"><div id="op-content"></div></div>
</div>

<script>
    // ğŸ’¡ æ–¹é¢ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨å¾©å…ƒ
    const masterRoutes = [
        {id:"11", name:"åŒ—æµ·é“-åŒ—æµ·é“"}, {id:"12", name:"åŒ—æµ·é“-æ±åŒ—"}, {id:"13", name:"åŒ—æµ·é“-é–¢æ±"},
        {id:"14", name:"åŒ—æµ·é“-æ±æµ·"}, {id:"15", name:"åŒ—æµ·é“-é–¢è¥¿"}, {id:"16", name:"åŒ—æµ·é“-ä¹å·"},
        {id:"22", name:"æ±åŒ—-æ±åŒ—"}, {id:"23", name:"æ±åŒ—-é–¢æ±"}, {id:"24", name:"æ±åŒ—-æ±æµ·"},
        {id:"25", name:"æ±åŒ—-é–¢è¥¿"}, {id:"26", name:"æ±åŒ—-ä¹å·"}, {id:"33", name:"é–¢æ±-é–¢æ±"},
        {id:"34", name:"é–¢æ±-æ±æµ·"}, {id:"35", name:"é–¢æ±-é–¢è¥¿"}, {id:"36", name:"é–¢æ±-ä¹å·"},
        {id:"44", name:"æ±æµ·-æ±æµ·"}, {id:"45", name:"æ±æµ·-é–¢è¥¿"}, {id:"46", name:"æ±æµ·-ä¹å·"},
        {id:"55", name:"é–¢è¥¿-é–¢è¥¿"}, {id:"56", name:"é–¢è¥¿-ä¹å·"}, {id:"66", name:"ä¹å·-ä¹å·"}
    ];

    // ğŸ’¡ å¤©æ°—åœ°ç‚¹å®šç¾©ã®å®Œå…¨å®Ÿè£… (142åœ°ç‚¹)
    const weatherStations = [
        {id:"011000", n:"ç¨šå†…", lat:45.415, lon:141.673}, {id:"012010", n:"æ—­å·", lat:43.770, lon:142.357}, {id:"012020", n:"ç•™èŒ", lat:43.935, lon:141.644},
        {id:"013010", n:"ç¶²èµ°", lat:44.020, lon:144.273}, {id:"013020", n:"åŒ—è¦‹", lat:43.803, lon:143.894}, {id:"013030", n:"ç´‹åˆ¥", lat:44.356, lon:143.354},
        {id:"014010", n:"æ ¹å®¤", lat:43.330, lon:145.582}, {id:"014020", n:"é‡§è·¯", lat:42.984, lon:144.381}, {id:"014030", n:"å¸¯åºƒ", lat:42.923, lon:143.204},
        {id:"015010", n:"å®¤è˜­", lat:42.315, lon:140.973}, {id:"015020", n:"æµ¦æ²³", lat:42.168, lon:142.771}, {id:"016010", n:"æœ­å¹Œ", lat:43.064, lon:141.346},
        {id:"016020", n:"å²©è¦‹æ²¢", lat:43.204, lon:141.759}, {id:"016030", n:"å€¶çŸ¥å®‰", lat:42.901, lon:140.758}, {id:"017010", n:"å‡½é¤¨", lat:41.768, lon:140.729},
        {id:"017020", n:"æ±Ÿå·®", lat:41.869, lon:140.127}, {id:"020010", n:"é’æ£®", lat:40.824, lon:140.740}, {id:"020020", n:"ã‚€ã¤", lat:41.292, lon:141.183},
        {id:"020030", n:"å…«æˆ¸", lat:40.512, lon:141.488}, {id:"030010", n:"ç››å²¡", lat:39.703, lon:141.152}, {id:"030020", n:"å®®å¤", lat:39.641, lon:141.946},
        {id:"030030", n:"å¤§èˆ¹æ¸¡", lat:39.081, lon:141.708}, {id:"040010", n:"ä»™å°", lat:38.268, lon:140.869}, {id:"040020", n:"ç™½çŸ³", lat:38.002, lon:140.619},
        {id:"050010", n:"ç§‹ç”°", lat:39.718, lon:140.102}, {id:"050020", n:"æ¨ªæ‰‹", lat:39.311, lon:140.560}, {id:"060010", n:"å±±å½¢", lat:38.255, lon:140.339},
        {id:"060020", n:"ç±³æ²¢", lat:37.922, lon:140.116}, {id:"060030", n:"é…’ç”°", lat:38.914, lon:139.836}, {id:"060040", n:"æ–°åº„", lat:38.762, lon:140.301},
        {id:"070010", n:"ç¦å³¶", lat:37.760, lon:140.474}, {id:"070020", n:"å°åæµœ", lat:36.941, lon:140.858}, {id:"070030", n:"è‹¥æ¾", lat:37.487, lon:139.929},
        {id:"080010", n:"æ°´æˆ¸", lat:36.365, lon:140.471}, {id:"080020", n:"åœŸæµ¦", lat:36.077, lon:140.205}, {id:"090010", n:"å®‡éƒ½å®®", lat:36.555, lon:139.882},
        {id:"090020", n:"å¤§ç”°åŸ", lat:36.871, lon:140.016}, {id:"100010", n:"å‰æ©‹", lat:36.389, lon:139.062}, {id:"100020", n:"ã¿ãªã‹ã¿", lat:36.782, lon:138.972},
        {id:"110010", n:"ã•ã„ãŸã¾", lat:35.861, lon:139.645}, {id:"110020", n:"ç†Šè°·", lat:36.147, lon:139.388}, {id:"110030", n:"ç§©çˆ¶", lat:35.998, lon:139.086},
        {id:"120010", n:"åƒè‘‰", lat:35.607, lon:140.123}, {id:"120020", n:"éŠšå­", lat:35.734, lon:140.826}, {id:"120030", n:"é¤¨å±±", lat:34.996, lon:139.863},
        {id:"130010", n:"æ±äº¬", lat:35.689, lon:139.691}, {id:"130020", n:"å¤§å³¶", lat:34.750, lon:139.355}, {id:"130030", n:"å…«ä¸ˆå³¶", lat:33.114, lon:139.791},
        {id:"130040", n:"çˆ¶å³¶", lat:27.094, lon:142.193}, {id:"140010", n:"æ¨ªæµœ", lat:35.443, lon:139.638}, {id:"140020", n:"å°ç”°åŸ", lat:35.256, lon:139.153},
        {id:"150010", n:"æ–°æ½Ÿ", lat:37.916, lon:139.036}, {id:"150020", n:"é•·å²¡", lat:37.446, lon:138.851}, {id:"150030", n:"é«˜ç”°", lat:37.109, lon:138.243},
        {id:"150040", n:"ç›¸å·", lat:38.031, lon:138.240}, {id:"160010", n:"å¯Œå±±", lat:36.695, lon:137.211}, {id:"160020", n:"ä¼æœ¨", lat:36.791, lon:137.054},
        {id:"170010", n:"é‡‘æ²¢", lat:36.561, lon:136.656}, {id:"170020", n:"è¼ªå³¶", lat:37.391, lon:136.899}, {id:"180010", n:"ç¦äº•", lat:36.064, lon:136.222},
        {id:"180020", n:"æ•¦è³€", lat:35.645, lon:136.061}, {id:"190010", n:"ç”²åºœ", lat:35.662, lon:138.568}, {id:"190020", n:"æ²³å£æ¹–", lat:35.498, lon:138.761},
        {id:"200010", n:"é•·é‡", lat:36.648, lon:138.194}, {id:"200020", n:"æ¾æœ¬", lat:36.233, lon:137.971}, {id:"200030", n:"é£¯ç”°", lat:35.514, lon:137.821},
        {id:"210010", n:"å²é˜œ", lat:35.423, lon:136.760}, {id:"210020", n:"é«˜å±±", lat:36.146, lon:137.252}, {id:"220010", n:"é™å²¡", lat:34.975, lon:138.382},
        {id:"220020", n:"ç¶²ä»£", lat:35.044, lon:139.080}, {id:"220030", n:"ä¸‰å³¶", lat:35.118, lon:138.919}, {id:"220040", n:"æµœæ¾", lat:34.703, lon:137.733},
        {id:"230010", n:"åå¤å±‹", lat:35.181, lon:136.906}, {id:"230020", n:"è±Šæ©‹", lat:34.764, lon:137.387}, {id:"240010", n:"æ´¥", lat:34.717, lon:136.508},
        {id:"240020", n:"å°¾é·²", lat:34.072, lon:136.191}, {id:"250010", n:"å¤§æ´¥", lat:35.017, lon:135.854}, {id:"250020", n:"å½¦æ ¹", lat:35.274, lon:136.259},
        {id:"260010", n:"äº¬éƒ½", lat:35.011, lon:135.768}, {id:"260020", n:"èˆé¶´", lat:35.474, lon:135.385}, {id:"270000", n:"å¤§é˜ª", lat:34.693, lon:135.502},
        {id:"280010", n:"ç¥æˆ¸", lat:34.690, lon:135.195}, {id:"280020", n:"è±Šå²¡", lat:35.441, lon:134.819}, {id:"290010", n:"å¥ˆè‰¯", lat:34.685, lon:135.832},
        {id:"290020", n:"é¢¨å±‹", lat:34.120, lon:135.815}, {id:"300010", n:"å’Œæ­Œå±±", lat:34.226, lon:135.167}, {id:"300020", n:"æ½®å²¬", lat:33.433, lon:135.758},
        {id:"310010", n:"é³¥å–", lat:35.501, lon:134.235}, {id:"310020", n:"ç±³å­", lat:35.432, lon:133.328}, {id:"320010", n:"æ¾æ±Ÿ", lat:35.468, lon:133.048},
        {id:"320020", n:"æµœç”°", lat:34.899, lon:132.079}, {id:"320030", n:"è¥¿éƒ·", lat:36.205, lon:133.333}, {id:"330010", n:"å²¡å±±", lat:34.661, lon:133.934},
        {id:"330020", n:"æ´¥å±±", lat:35.060, lon:134.004}, {id:"340010", n:"åºƒå³¶", lat:34.385, lon:132.459}, {id:"340020", n:"åº„åŸ", lat:34.858, lon:133.017},
        {id:"350010", n:"ä¸‹é–¢", lat:33.957, lon:130.941}, {id:"350020", n:"å±±å£", lat:34.178, lon:131.474}, {id:"350030", n:"æŸ³äº•", lat:33.963, lon:132.106},
        {id:"350040", n:"è©", lat:34.408, lon:131.399}, {id:"360010", n:"å¾³å³¶", lat:34.071, lon:134.551}, {id:"360020", n:"æ—¥å’Œä½", lat:33.733, lon:134.533},
        {id:"370000", n:"é«˜æ¾", lat:34.342, lon:134.046}, {id:"380010", n:"æ¾å±±", lat:33.839, lon:132.765}, {id:"380020", n:"æ–°å±…æµœ", lat:33.960, lon:133.283},
        {id:"380030", n:"å®‡å’Œå³¶", lat:33.223, lon:132.558}, {id:"390010", n:"é«˜çŸ¥", lat:33.559, lon:133.531}, {id:"390020", n:"å®¤æˆ¸å²¬", lat:33.246, lon:134.175},
        {id:"390030", n:"æ¸…æ°´", lat:32.775, lon:132.958}, {id:"400010", n:"ç¦å²¡", lat:33.590, lon:130.401}, {id:"400020", n:"å…«å¹¡", lat:33.856, lon:130.793},
        {id:"400030", n:"é£¯å¡š", lat:33.645, lon:130.686}, {id:"400040", n:"ä¹…ç•™ç±³", lat:33.319, lon:130.508}, {id:"410010", n:"ä½è³€", lat:33.263, lon:130.300},
        {id:"410020", n:"ä¼Šä¸‡é‡Œ", lat:33.266, lon:129.879}, {id:"420010", n:"é•·å´", lat:32.750, lon:129.877}, {id:"420020", n:"ä½ä¸–ä¿", lat:33.179, lon:129.715},
        {id:"420030", n:"å³åŸ", lat:34.204, lon:129.288}, {id:"420040", n:"ç¦æ±Ÿ", lat:32.700, lon:128.841}, {id:"430010", n:"ç†Šæœ¬", lat:32.803, lon:130.707},
        {id:"430020", n:"é˜¿è˜‡ä¹™å§«", lat:32.956, lon:131.025}, {id:"430030", n:"ç‰›æ·±", lat:32.193, lon:130.024}, {id:"430040", n:"äººå‰", lat:32.211, lon:130.755},
        {id:"440010", n:"å¤§åˆ†", lat:33.238, lon:131.612}, {id:"440020", n:"ä¸­æ´¥", lat:33.598, lon:131.188}, {id:"440030", n:"æ—¥ç”°", lat:33.321, lon:130.941},
        {id:"440040", n:"ä½ä¼¯", lat:32.960, lon:131.899}, {id:"450010", n:"å®®å´", lat:31.907, lon:131.420}, {id:"450020", n:"å»¶å²¡", lat:32.582, lon:131.666},
        {id:"450030", n:"éƒ½åŸ", lat:31.720, lon:131.061}, {id:"450040", n:"é«˜åƒç©‚", lat:32.711, lon:131.309}, {id:"460010", n:"é¹¿å…å³¶", lat:31.596, lon:130.557},
        {id:"460020", n:"é¹¿å±‹", lat:31.378, lon:130.852}, {id:"460030", n:"ç¨®å­å³¶", lat:30.741, lon:130.983}, {id:"460040", n:"åç€¬", lat:28.378, lon:129.492},
        {id:"471010", n:"é‚£è¦‡", lat:26.212, lon:127.680}, {id:"471020", n:"åè­·", lat:26.591, lon:127.977}, {id:"471030", n:"ä¹…ç±³å³¶", lat:26.348, lon:126.772},
        {id:"472000", n:"å—å¤§æ±", lat:25.847, lon:131.229}, {id:"473000", n:"å®®å¤å³¶", lat:24.797, lon:125.281}, {id:"474010", n:"çŸ³å£å³¶", lat:24.341, lon:124.156},
        {id:"474020", n:"ä¸é‚£å›½å³¶", lat:24.467, lon:122.991}
    ];

    // ğŸ’¡ é“è·¯ãƒ»ä¾¿ã®åˆ¤å®šç”¨
    const roadKeywords = ["ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ«", "å–¶æ¥­æ‰€", "ORS"];
    const roadExcludeStops = ["ãƒ†ã‚¹ãƒˆé™¤å¤–é§…"]; // é™¤å¤–ã—ãŸã„é§…åã¯ã“ã“ã¸

    const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([36.5, 138], 6);
    const tiles = {
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
        sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
        gsi: L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png')
    };
    tiles.light.addTo(map);

    window.gtfsDB = { trips: [], stops: {}, stopTimes: {}, routes: {} };
    let currentTripId = "";
    let currentTimeline = [];

    async function init() {
        document.getElementById("loader").style.display = "block";
        document.getElementById('base_date').valueAsDate = new Date();
        const rf = document.getElementById("route_filter");
        masterRoutes.forEach(r => {
            const opt = document.createElement("option"); opt.value = r.id; opt.textContent = r.name; rf.appendChild(opt);
        });

        try {
            const [tr, st, s] = await Promise.all([
                fetch('./trips.txt').then(r => r.text()), fetch('./stop_times.txt').then(r => r.text()), fetch('./stops.txt').then(r => r.text())
            ]);
            window.gtfsDB.trips = Papa.parse(tr.trim(), { header: true }).data;
            Papa.parse(s.trim(), { header: true }).data.forEach(x => { window.gtfsDB.stops[x.stop_id] = x; });
            Papa.parse(st.trim(), { header: true }).data.forEach(x => {
                if (!window.gtfsDB.stopTimes[x.trip_id]) window.gtfsDB.stopTimes[x.trip_id] = [];
                window.gtfsDB.stopTimes[x.trip_id].push(x);
            });
            renderTrips("");
        } catch(e) { console.error(e); }
        document.getElementById("loader").style.display = "none";
    }

    function formatTripNo(no, stationName) {
        let clean = no.replace(/^0+/, '').replace('b','');
        if (clean.length > 4) clean = clean.substring(0, clean.length - 2);
        const isExclude = roadExcludeStops.some(ex => stationName.includes(ex));
        const isRoad = roadKeywords.some(kw => stationName.includes(kw)) && !isExclude;
        return isRoad ? clean + "ä¾¿" : clean + "ãƒ¬";
    }

    async function fetchWeather(lat, lon, stationName) {
        let minD = Infinity, cityId = "130010";
        weatherStations.forEach(s => {
            const d = Math.sqrt(Math.pow(lat-s.lat,2)+Math.pow(lon-s.lon,2));
            if(d < minD){ minD = d; cityId = s.id; }
        });
        try {
            const res = await fetch(`https://weather.tsukumijima.net/api/forecast/city/${cityId}`);
            const data = await res.json();
            const f = data.forecasts[0];
            const toast = document.getElementById('weather-toast');
            toast.innerHTML = `
                <div style="font-size:10px;">æœ€å¯„: ${data.location.city}</div>
                <div style="font-weight:bold;">${stationName} ã®å¤©æ°—</div>
                <img src="${f.image.url}" width="40"><span style="font-size:16px;">${f.telop}</span>
                <div style="font-size:11px;">æ°—æ¸©: ${f.temperature.max.celsius||'--'}â„ƒ / é™æ°´: ${f.chanceOfRain.T12_18}</div>
                <button onclick="this.parentElement.style.display='none'" style="font-size:10px; margin-top:5px;">é–‰ã˜ã‚‹</button>
            `;
            toast.style.display = 'block';
        } catch(e) { console.error(e); }
    }

    function renderTrips(f) {
        const list = document.getElementById("trip-list"); list.innerHTML = "";
        const query = (f || "").toLowerCase();
        const routeFilter = document.getElementById("route_filter").value;
        window.gtfsDB.trips.filter(t => {
            if (routeFilter && t.route_id !== routeFilter) return false;
            return t.trip_id.toLowerCase().includes(query) || (window.gtfsDB.stopTimes[t.trip_id]||[]).some(s => (window.gtfsDB.stops[s.stop_id]?.stop_name||"").toLowerCase().includes(query));
        }).slice(0, 50).forEach(t => {
            const st = window.gtfsDB.stopTimes[t.trip_id] || [];
            const sName = window.gtfsDB.stops[st[0]?.stop_id]?.stop_name || "-";
            const eName = window.gtfsDB.stops[st[st.length-1]?.stop_id]?.stop_name || "-";
            const displayNo = t.trip_id.split('_').slice(2).map(p => formatTripNo(p, sName)).join('ã€œ');
            const card = document.createElement("div"); card.className = "trip-card" + (t.trip_id === currentTripId ? " active" : "");
            card.innerHTML = `<div class="card-relay">${displayNo}</div><div class="card-range">${sName} ã€œ ${eName}</div>`;
            card.onclick = () => loadTrip(t);
            list.appendChild(card);
        });
    }

    async function loadTrip(t) {
        currentTripId = t.trip_id; document.getElementById("loader").style.display = "block";
        const shardId = t.shape_id ? t.shape_id.substring(0, 2) : "00";
        const shard = await fetch(`./shapes_shards/shard_${shardId}.json`).then(r => r.json());
        window.dispatchEvent(new CustomEvent("py-process", { detail: { tid: t.trip_id, geo: JSON.stringify(shard[t.shape_id] || []) } }));
    }

    window.updateUI = (geo_s, time_s) => {
        const timeRaw = JSON.parse(time_s); const geoPoints = JSON.parse(geo_s);
        const consolidated = []; const mapObj = {};
        timeRaw.forEach(s => {
            if(!mapObj[s.code]) {
                mapObj[s.code] = { code: s.code, name: s.name, arr: "None", dep: "None", lat: s.lat, lon: s.lon };
                consolidated.push(mapObj[s.code]);
            }
            if(s.id.startsWith('C')) mapObj[s.code].arr = s.arr;
            if(s.id.startsWith('T')) mapObj[s.code].dep = s.dep;
        });
        currentTimeline = consolidated.map(s => ({ ...s, arrD: formatTime(s.arr), depD: formatTime(s.dep) }));
        document.getElementById("relay-text").innerText = currentTripId.split('_').slice(2).map(p=>formatTripNo(p, currentTimeline[0]?.name||"")).join('ã€œ');
        map.eachLayer(l => { if(l instanceof L.Polyline || l instanceof L.CircleMarker) map.removeLayer(l); });
        for (let i = 0; i < currentTimeline.length - 1; i++) {
            const s = currentTimeline[i], e = currentTimeline[i+1], seg = extractSegment(geoPoints, s, e);
            const isRoad = roadKeywords.some(kw => s.name.includes(kw));
            if (isRoad) L.polyline(seg, { color: '#0078d4', weight: 8, opacity: 0.8 }).addTo(map);
            else { L.polyline(seg, { color: '#000', weight: 6 }).addTo(map); L.polyline(seg, { color: '#fff', weight: 2, dashArray: '8, 12' }).addTo(map); }
        }
        currentTimeline.forEach(s => {
            L.circleMarker([s.lat, s.lon], { radius: 4, color: '#fff', fillColor: '#000', fillOpacity: 1 }).addTo(map)
             .bindPopup(`<b>${s.name}</b><br><button onclick="fetchWeather(${s.lat},${s.lon},'${s.name}')">å¤©æ°—å–å¾—</button>`);
        });
        if(geoPoints.length > 0) map.fitBounds(L.polyline(geoPoints).getBounds(), { padding: [40,40] });
        document.getElementById("st-body").innerHTML = currentTimeline.map(s => `<tr><td>${s.code}</td><td><b>${s.name}</b><button class="weather-btn" onclick="fetchWeather(${s.lat},${s.lon},'${s.name}')">å¤©æ°—</button></td><td style="text-align:center;">${s.arrD}</td><td style="text-align:center;">${s.depD}</td></tr>`).join("");
        document.getElementById("loader").style.display = "none";
    };

    function extractSegment(p, s, e) {
        if(!p || p.length===0) return [[s.lat, s.lon], [e.lat, e.lon]];
        let si=0, ei=p.length-1, ms=Infinity, me=Infinity;
        p.forEach((pt, idx) => {
            let ds = Math.pow(pt[0]-s.lat, 2) + Math.pow(pt[1]-s.lon, 2);
            let de = Math.pow(pt[0]-e.lat, 2) + Math.pow(pt[1]-e.lon, 2);
            if(ds < ms) { ms = ds; si = idx; }
            if(de < me) { me = de; ei = idx; }
        });
        return p.slice(Math.min(si,ei), Math.max(si,ei) + 1);
    }
    function formatTime(t) {
        if(!t || t === "None") return " - ";
        const p = t.split(':'); return `${String(parseInt(p[0])%24).padStart(2,'0')}:${p[1]}`;
    }
    function showOpSheet() {
        if(!currentTimeline.length) return;
        document.getElementById("op-content").innerHTML = `
            <div style="text-align:right; font-size:10px;">WB-OCC v10.8 / ${document.getElementById("base_date").value}</div>
            <h2 style="text-align:center; border-bottom: 2px solid #000; padding-bottom:10px;">è¼¸é€åˆ—è»Šé †åºè³‡æ–™</h2>
            <div style="margin: 15px 0;"><b>ç¶™èµ°åˆ—è»Š:</b> ${document.getElementById("relay-text").innerText}</div>
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead><tr style="background:#f0f0f0;"><th style="border:1px solid #000; padding:8px;">é§…ã‚³ãƒ¼ãƒ‰</th><th style="border:1px solid #000; padding:8px;">åœè»Šé§…</th><th style="border:1px solid #000; padding:8px;">åˆ°ç€</th><th style="border:1px solid #000; padding:8px;">å‡ºç™º</th></tr></thead>
                <tbody>${currentTimeline.map(s => `<tr><td style="border:1px solid #000; padding:8px; text-align:center;">${s.code}</td><td style="border:1px solid #000; padding:8px;">${s.name}</td><td style="border:1px solid #000; padding:8px; text-align:center;">${s.arrD}</td><td style="border:1px solid #000; padding:8px; text-align:center;">${s.depD}</td></tr>`).join("")}</tbody>
            </table>
        `;
        document.getElementById("modal-op").style.display = "block";
    }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); updateMapLayers(); }
    function updateMapLayers() {
        const mode = document.getElementById('map-mode').value, isDark = document.body.classList.contains('dark-mode');
        Object.values(tiles).forEach(t => map.removeLayer(t));
        if (mode === 'sat') tiles.sat.addTo(map); else if (mode === 'osm') tiles.osm.addTo(map); else if (mode === 'gsi') tiles.gsi.addTo(map); else tiles[isDark ? 'dark' : 'light'].addTo(map);
    }
    function toggleLog() { const p = document.getElementById('log-panel'); p.style.display = p.style.display==='block'?'none':'block'; }
    setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleTimeString('ja-JP', {hour12:false}); }, 1000);
    init();
</script>

<py-script>
import js, json
from pyodide.ffi import create_proxy
async def process(event):
    data = event.detail.to_py()
    tid = data['tid']
    db = js.window.gtfsDB
    st_data = db.stopTimes.to_py()
    st_list = sorted(st_data[tid], key=lambda x: int(x['stop_sequence']))
    stops = db.stops.to_py()
    timeline = [{"id":str(r['stop_id']),"name":str(stops.get(r['stop_id'],{}).get('stop_name',"-")),"code":str(stops.get(r['stop_id'],{}).get('stop_code',"-")),"arr":str(r.get('arrival_time',"None")),"dep":str(r.get('departure_time',"None")),"lat":float(stops.get(r['stop_id'],{}).get('stop_lat',0)),"lon":float(stops.get(r['stop_id'],{}).get('stop_lon',0))} for r in st_list]
    js.window.updateUI(data['geo'], json.dumps(timeline))
js.window.addEventListener("py-process", create_proxy(process))
</py-script>
</body>
</html>
