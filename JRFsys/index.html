<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JRF 継走列車解析システム</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root { --jrf-red: #d32f2f; --jrf-dark: #000033; --console-bg: #1a1a1a; }
        body { margin: 0; font-family: "MS UI Gothic", "Meiryo", monospace; background: #333; color: #eee; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--jrf-red); padding: 8px 20px; border-bottom: 4px solid var(--jrf-dark); }
        .system-title { font-size: 16px; font-weight: bold; letter-spacing: 1px; }

        #layout { display: flex; flex: 1; overflow: hidden; gap: 4px; padding: 4px; }
        
        /* 検索パネル */
        #side { width: 350px; background: #ccc; color: #000; border: 2px inset #fff; display: flex; flex-direction: column; }
        .panel-label { background: var(--jrf-dark); color: #fff; padding: 4px 8px; font-size: 11px; }
        .search-area { padding: 10px; background: #bbb; border-bottom: 2px solid #888; }
        #q_input { width: 100%; padding: 10px; border: 2px inset #fff; box-sizing: border-box; font-size: 16px; font-weight: bold; background: #fff; }
        
        #trip-list { flex: 1; overflow-y: scroll; background: #fff; }
        .trip-row { padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer; font-size: 12px; line-height: 1.4; }
        .trip-row:hover { background: #eef; }
        .trip-row.active { background: var(--jrf-dark); color: #fff; }
        .trip-tag { background: #eee; border: 1px solid #999; padding: 1px 4px; border-radius: 3px; font-size: 10px; color: #333; margin-right: 4px; }

        /* メインビュー */
        #main-view { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        #map { flex: 1; border: 2px inset #fff; }
        #console { height: 180px; background: var(--console-bg); color: #0f0; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; overflow-y: auto; border: 2px inset #444; border-top: 5px solid #555; }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div style="font-size:20px; color:#0f0; margin-bottom:10px;">>> ANALYZING FREIGHT CHAIN...</div>
    <div style="color:white; font-family:monospace;">Fetching High-Precision Shapes from Cloud Storage</div>
</div>

<header>
    <div class="system-title">■ JRF-GTFS MULTI-TRIP ANALYZER [継走列車対応型]</div>
</header>

<div id="layout">
    <div id="side">
        <div class="panel-label">列車番号検索 (例: 2072, 50, 4091)</div>
        <div class="search-area">
            <input type="text" id="q_input" placeholder="列車番号を入力...">
        </div>
        <div id="trip-list"></div>
    </div>

    <div id="main-view">
        <div id="map"></div>
        <div class="panel-label">FREIGHT-LOG PARSER (Python 3.x)</div>
        <div id="console"></div>
    </div>
</div>

<script>
    const map = L.map('map').setView([38, 138], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let drawLayer = L.layerGroup().addTo(map);

    let tripsData = [];

    // 初期データロード
    async function initTrips() {
        try {
            const res = await fetch('trips.txt');
            const text = await res.text();
            tripsData = Papa.parse(text.trim(), { header: true, skipEmptyLines: true }).data;
            renderList("");
        } catch (e) {
            console.error("trips.txtが見つかりません");
        }
    }

    // 検索ロジック: 継走列車IDのどの部分にヒットしても表示する
    function renderList(filter) {
        const list = document.getElementById('trip-list');
        list.innerHTML = '';
        if (!filter) return;

        const filtered = tripsData.filter(t => t.trip_id.includes(filter));

        filtered.forEach(t => {
            const div = document.createElement('div');
            div.className = 'trip-row';
            // IDを分解して見やすく表示
            const parts = t.trip_id.split('_');
            const chainText = parts.slice(1).join(' → ');
            
            div.innerHTML = `
                <div style="font-weight:bold; color:#d32f2f;">${t.trip_id}</div>
                <div style="margin-top:4px;"><span class="trip-tag">継走</span>${chainText}</div>
            `;
            
            div.onclick = () => {
                document.querySelectorAll('.trip-row').forEach(r => r.classList.remove('active'));
                div.classList.add('active');
                const pyFunc = pyscript.interpreter.globals.get('analyze_freight_data');
                pyFunc(t.trip_id);
            };
            list.appendChild(div);
        });
    }

    document.getElementById('q_input').oninput = (e) => renderList(e.target.value);

    window.update_map_route = (points_json) => {
        const points = JSON.parse(points_json);
        drawLayer.clearLayers();
        if (points.length > 0) {
            const poly = L.polyline(points, {color: '#ff0000', weight: 4, opacity: 0.9}).addTo(drawLayer);
            points.forEach(p => L.circleMarker(p, {radius: 3, color: '#000', fillOpacity: 1}).addTo(drawLayer));
            map.fitBounds(poly.getBounds(), {padding: [40, 40]});
        }
        document.getElementById('loading').style.display = 'none';
    };

    initTrips();
</script>

<py-script>
import js
import json
from pyodide.http import pyfetch

# Google Drive ID (ここを実際のIDに書き換えてください)
GOOGLE_DRIVE_FILE_ID = "YOUR_GOOGLE_DRIVE_FILE_ID_HERE"
# uc?export=download は直リンクとして動作します
SHAPES_URL = f"https://docs.google.com/uc?export=download&id={GOOGLE_DRIVE_FILE_ID}"

# --- log関数を外に出すことで、どこからでも呼べるように修正 ---
def log(msg):
    console_el = js.document.getElementById("console")
    if console_el:
        div = js.document.createElement("div")
        div.innerText = f">> {msg}"
        console_el.appendChild(div)
        console_el.scrollTop = console_el.scrollHeight

async def analyze_freight_data(trip_id):
    loading_el = js.document.getElementById("loading")
    loading_el.style.display = "flex"
    
    # 継走解析のログ表示
    log(f"PARSING MULTI-TRIP ID: {trip_id}")
    chain_parts = trip_id.split('_')
    log(f"DETECTED {len(chain_parts)} SEGMENTS IN CHAIN.")
    
    # 列車番号の抽出を試みる（207200 -> 2072レ等）
    train_nums = [p for p in chain_parts if p.isdigit() or len(p) > 2]
    log(f"TRAIN NUMBER SEQUENCE: {' -> '.join(train_nums)}")

    try:
        # tripsDataはJavaScript側のグローバル変数から取得
        trips = js.tripsData.to_py()
        target = next((t for t in trips if t['trip_id'] == trip_id), None)
        
        if not target:
            log("ERROR: DATA NOT FOUND IN trips.txt")
            loading_el.style.display = "none"
            return

        sid = target.get('shape_id')
        if not sid:
            log("ERROR: この列車には shape_id が設定されていません。")
            loading_el.style.display = "none"
            return

        log(f"FETCHING SHAPE_ID: {sid} FROM GOOGLE DRIVE...")

        # Google Driveからデータを取得
        res = await pyfetch(SHAPES_URL)
        if not res.ok:
            log(f"ERROR: Google Driveへのアクセス失敗 (Status: {res.status})")
            loading_el.style.display = "none"
            return

        text = await res.string()
        lines = text.strip().split('\n')
        header = [x.strip() for x in lines[0].split(',')]
        
        # 各カラムのインデックスを特定
        idx_id = header.index('shape_id')
        idx_lat = header.index('shape_pt_lat')
        idx_lon = header.index('shape_pt_lon')
        idx_seq = header.index('shape_pt_sequence')

        coords = []
        for line in lines[1:]:
            cols = line.split(',')
            # shape_id が一致する行だけを抽出
            if len(cols) > idx_id and cols[idx_id] == sid:
                coords.append({
                    'lat': float(cols[idx_lat]),
                    'lon': float(cols[idx_lon]),
                    'seq': int(cols[idx_seq])
                })

        # 順序通りにソートしてリスト化
        coords.sort(key=lambda x: x['seq'])
        final_list = [[p['lat'], p['lon']] for p in coords]
        
        if len(final_list) == 0:
            log(f"WARNING: shape_id {sid} に一致する座標が shapes.txt 内に見つかりません。")
        else:
            log(f"SUCCESS: {len(final_list)} COORDINATES LOADED.")
            # JavaScriptの地図更新関数を呼び出し
            js.window.update_map_route(json.dumps(final_list))

    except Exception as e:
        log(f"CRITICAL ERROR: {str(e)}")
        loading_el.style.display = "none"

# 起動時のメッセージ（log関数が外にあるので正常に動作します）
log("PYTHON ENGINE LOADED. WAITING FOR COMMAND.")
</py-script>

</body>
</html>
