<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>WB-OCC OPERATIONAL TERMINAL v8.5</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --win-bg: #d4d0c8;
            --win-fg: #000000;
            --win-highlight: #ffffff;
            --win-shadow: #808080;
            --win-blue: #000080;
        }
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: "MS UI Gothic", "Meiryo", monospace; 
            background: #3a6ea5; 
            color: var(--win-fg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .win-panel {
            background: var(--win-bg);
            border-top: 2px solid var(--win-highlight);
            border-left: 2px solid var(--win-highlight);
            border-right: 2px solid var(--win-shadow);
            border-bottom: 2px solid var(--win-shadow);
            margin: 2px;
            display: flex;
            flex-direction: column;
        }
        .win-header {
            background: var(--win-blue);
            color: white;
            padding: 3px 5px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        
        #main-layout { display: grid; grid-template-columns: 320px 1fr 380px; flex: 1; overflow: hidden; }

        #trip-list { flex: 1; overflow-y: scroll; background: #fff; border: 2px inset var(--win-shadow); margin: 5px; }
        .trip-card { padding: 4px; border-bottom: 1px solid #ddd; cursor: pointer; font-size: 12px; }
        .trip-card:hover { background: #000080; color: #fff; }
        .trip-card.active { background: #000080; color: #fff; }

        #relay-bar-ui { display: flex; height: 18px; border: 2px inset var(--win-shadow); background: #000; margin: 5px; }
        .relay-seg { font-size: 10px; color: #fff; text-align: center; border-right: 1px solid #666; display: flex; align-items: center; justify-content: center; overflow: hidden; }

        #timeline-view { flex: 1; overflow-y: auto; background: #fff; border: 2px inset var(--win-shadow); margin: 5px; }
        .st-row { border-bottom: 1px solid #ccc; font-size: 11px; display: grid; grid-template-columns: 45px 1fr 50px 50px; padding: 2px; }
        .st-head { background: #eee; font-weight: bold; border-bottom: 2px solid #888; position: sticky; top: 0; }

        button {
            background: var(--win-bg);
            border-top: 1px solid var(--win-highlight);
            border-left: 1px solid var(--win-highlight);
            border-right: 1px solid var(--win-shadow);
            border-bottom: 1px solid var(--win-shadow);
            padding: 2px 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
        }
        button:active { border: 1px inset var(--win-shadow); }

        #modal-op { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; padding: 20px; }
        .op-sheet { background: #fff; border: 1px solid #000; width: 100%; height: 100%; padding: 40px; color: #000; overflow-y: auto; font-family: "MS Mincho", serif; }
        .op-table { width: 100%; border-collapse: collapse; }
        .op-table th, .op-table td { border: 1px solid #000; padding: 4px; text-align: center; font-size: 12px; }
        
        #loader { position: fixed; bottom: 5px; right: 5px; background: var(--win-bg); border: 1px solid #000; padding: 2px 10px; display: none; z-index: 10000; font-size: 11px; }
    </style>
</head>
<body>

<div id="loader">BUSY...</div>

<header class="win-panel">
    <div class="win-header">
        <span>WB-OCC OPERATIONAL COMMAND TERMINAL</span>
        <span id="clock">00:00:00</span>
    </div>
</header>

<div id="main-layout">
    <div class="win-panel">
        <div class="win-header">UNIT_QUERY</div>
        <div style="padding:5px;"><input type="text" id="q_input" style="width:100%; border:2px inset;" placeholder="Search..."></div>
        <div id="trip-list"></div>
    </div>

    <div class="win-panel">
        <div class="win-header">GEOGRAPHIC_MONITOR</div>
        <div id="map" style="flex:1;"></div>
    </div>

    <div class="win-panel">
        <div class="win-header">LANE_SEQUENCE</div>
        <div id="relay-bar-ui"></div>
        <div style="padding:2px 5px; font-size:11px; background:#eee; border-bottom:1px solid #888;">RELAY: <span id="relay-text">--</span></div>
        <div id="timeline-view"></div>
        <div style="padding:5px; display:flex; gap:2px; background:var(--win-bg);">
            <button style="flex:1" onclick="showOpSheet()">VIEW_REPORT</button>
            <button onclick="document.getElementById('modal-op').style.display='none'">EXIT</button>
        </div>
    </div>
</div>

<div id="modal-op">
    <div class="win-panel" style="height:100%;">
        <div class="win-header">REPORT_PREVIEW <button onclick="document.getElementById('modal-op').style.display='none'" style="color:#000; padding:0 3px;">[X]</button></div>
        <div class="op-sheet" id="op-content"></div>
    </div>
</div>

<script>
    const map = L.map('map', { zoomControl: false, preferCanvas: true }).setView([36.5, 138], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(map);
    let routeGroup = L.layerGroup().addTo(map);
    let markerGroup = L.layerGroup().addTo(map);

    window.gtfsDB = { trips: [], stops: {}, stopTimes: {}, stopToTrips: {} };
    let currentTripData = null;
    let currentTripId = "";

    function parseRelayLanes(id) {
        const parts = id.split('_').slice(2);
        return parts.map(p => {
            if (p.endsWith('b')) return p.replace('b', '‰æø');
            if (p.length === 6 && /^\d+$/.test(p)) return p.substring(0, 4) + '„É¨';
            if (/^\d{2,4}$/.test(p)) return p + '„É¨';
            return p;
        }).filter(p => p !== "");
    }

    async function init() {
        document.getElementById("loader").style.display = "block";
        try {
            const [t, s, st] = await Promise.all([
                fetch('./trips.txt').then(r => r.text()),
                fetch('./stops.txt').then(r => r.text()),
                fetch('./stop_times.txt').then(r => r.text())
            ]);
            window.gtfsDB.trips = Papa.parse(t.trim(), { header: true }).data;
            Papa.parse(s.trim(), { header: true }).data.forEach(x => { window.gtfsDB.stops[x.stop_id] = x; });
            Papa.parse(st.trim(), { header: true }).data.forEach(x => {
                if (!window.gtfsDB.stopTimes[x.trip_id]) window.gtfsDB.stopTimes[x.trip_id] = [];
                window.gtfsDB.stopTimes[x.trip_id].push(x);
                const sobj = window.gtfsDB.stops[x.stop_id];
                if(sobj) {
                    [sobj.stop_name, sobj.stop_code].forEach(k => {
                        if(!window.gtfsDB.stopToTrips[k]) window.gtfsDB.stopToTrips[k] = new Set();
                        window.gtfsDB.stopToTrips[k].add(x.trip_id);
                    });
                }
            });
            renderTrips("");
        } catch (e) { console.error(e); }
        document.getElementById("loader").style.display = "none";
    }

    function renderTrips(filter) {
        const list = document.getElementById("trip-list");
        list.innerHTML = "";
        const f = filter.toLowerCase();
        window.gtfsDB.trips.filter(t => {
            if (!f) return true;
            if (t.trip_id.toLowerCase().includes(f)) return true;
            return Object.keys(window.gtfsDB.stopToTrips).some(k => k.includes(f) && window.gtfsDB.stopToTrips[k].has(t.trip_id));
        }).slice(0, 50).forEach(t => {
            const st = window.gtfsDB.stopTimes[t.trip_id] || [];
            const sName = window.gtfsDB.stops[st[0]?.stop_id]?.stop_name || "??";
            const eName = window.gtfsDB.stops[st[st.length-1]?.stop_id]?.stop_name || "??";
            const card = document.createElement("div");
            card.className = "trip-card";
            card.innerHTML = `<div style="font-size:10px;">ID:${t.trip_id}</div>${sName} -> ${eName}`;
            card.onclick = () => loadTrip(t);
            list.appendChild(card);
        });
    }

    async function loadTrip(t) {
        currentTripId = t.trip_id;
        document.getElementById("loader").style.display = "block";
        const shardKey = t.shape_id.substring(0, 2);
        const shard = await fetch(`./shapes_shards/shard_${shardKey}.json`).then(r => r.json());
        
        const lanes = parseRelayLanes(t.trip_id);
        document.getElementById("relay-text").innerText = lanes.join(" - ");
        const bar = document.getElementById("relay-bar-ui");
        bar.innerHTML = "";
        lanes.forEach((l, i) => {
            const seg = document.createElement("div");
            seg.className = "relay-seg";
            seg.style.width = `${100 / lanes.length}%`;
            seg.style.backgroundColor = (l.includes('„É¨')) ? '#444' : '#004488';
            seg.innerText = l;
            bar.appendChild(seg);
        });

        window.dispatchEvent(new CustomEvent("py-process", { 
            detail: { tid: t.trip_id, geo: JSON.stringify(shard[t.shape_id]) } 
        }));
    }

    window.updateUI = (geo_s, time_s) => {
        const time = JSON.parse(time_s); 
        currentTripData = time;
        const geo = JSON.parse(geo_s);
        routeGroup.clearLayers(); markerGroup.clearLayers();

        // üí° ÂàóËªäÁ®ÆÂà•„Å´„Çà„ÇãÊèè„ÅçÂàÜ„Åë
        const isTrack = parseRelayLanes(currentTripId).some(l => l.includes('‰æø'));
        if (isTrack) {
            L.polyline(geo, { color: '#0044aa', weight: 5, opacity: 0.8 }).addTo(routeGroup);
        } else {
            // Á∑öË∑ØÈ¢®ÔºàÁôΩÈªíÁÇπÁ∑öÔºâ
            L.polyline(geo, { color: '#000', weight: 4 }).addTo(routeGroup);
            L.polyline(geo, { color: '#fff', weight: 2, dashArray: '5, 10' }).addTo(routeGroup);
        }

        map.fitBounds(L.polyline(geo).getBounds(), { padding: [30,30] });
        
        const view = document.getElementById("timeline-view");
        view.innerHTML = `<div class="st-row st-head"><div>CODE</div><div>STATION</div><div>ARR</div><div>DEP</div></div>`;
        time.forEach(s => {
            const row = document.createElement("div");
            row.className = "st-row";
            row.innerHTML = `<div>${s.code}</div><div>${s.name}</div><div>${s.arr}</div><div>${s.dep}</div>`;
            view.appendChild(row);
            L.circleMarker([s.lat, s.lon], { radius: 3, color: '#000', fillOpacity: 1 }).addTo(markerGroup);
        });
        document.getElementById("loader").style.display = "none";
    };

    function showOpSheet() {
        if(!currentTripData) return;
        const modal = document.getElementById("modal-op");
        const content = document.getElementById("op-content");
        let rows = currentTripData.map(s => `<tr><td>${s.code}</td><td style="text-align:left;">${s.name}</td><td>${s.arr}</td><td>${s.dep}</td><td></td></tr>`).join("");
        content.innerHTML = `
            <div style="text-align:center; border-bottom:2px solid #000; margin-bottom:10px;">
                <h2 style="margin:0;">Ë≤®Áâ©ÈÅãË°åÊåáÁ§∫Êõ∏</h2>
                <p style="text-align:right;">Trip ID: ${currentTripId}</p>
            </div>
            <table class="op-table">
                <thead><tr><th>ÈßÖ„Ç≥„Éº„Éâ</th><th>ÈßÖÂêçÁß∞</th><th>Âà∞ÁùÄÊôÇÂàª</th><th>Âá∫Áô∫ÊôÇÂàª</th><th>ÂÇôËÄÉ</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        `;
        modal.style.display = "block";
    }

    setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleTimeString(); }, 1000);
    init();
    document.getElementById("q_input").oninput = (e) => renderTrips(e.target.value);
</script>

<py-script>
import js, json
from pyodide.ffi import create_proxy

async def process(event):
    data = event.detail.to_py()
    coords = json.loads(data['geo'])
    tid = data['tid']
    try:
        db = js.window.gtfsDB
        # JSËæûÊõ∏„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„ÇãÈöõ„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊñπÊ≥ï„Çí‰øÆÊ≠£
        st_raw = db.stopTimes.get(tid)
        if not st_raw:
            return
            
        st_list = st_raw.to_py()
        st_sorted = sorted(st_list, key=lambda x: int(x['stop_sequence']))
        
        timeline = []
        for r in st_sorted:
            s = db.stops.get(r['stop_id']).to_py()
            timeline.append({
                "name": s['stop_name'],
                "code": s['stop_code'],
                "arr": r['arrival_time'],
                "dep": r['departure_time'],
                "lat": float(s['stop_lat']),
                "lon": float(s['stop_lon'])
            })
        js.window.updateUI(json.dumps(coords), json.dumps(timeline))
    except Exception as e:
        js.console.error("Python Error: " + str(e))
        js.document.getElementById('loader').style.display = 'none'

js.window.addEventListener("py-process", create_proxy(process))
</py-script>
</body>
</html>
