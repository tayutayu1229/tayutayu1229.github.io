<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JRF OCC White Base Command Terminal</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --wb-main-bg: #000a16; --wb-panel-bg: #001f3f; --wb-border-color: #004080;
            --wb-accent-red: #ff3366; --wb-text-light: #e0f2f7; --wb-text-green: #00ffcc;
            --wb-text-yellow: #ffeb3b; --wb-font: "Consolas", "Roboto Mono", monospace;
        }

        body {
            margin: 0; font-family: var(--wb-font); background: var(--wb-main-bg);
            color: var(--wb-text-light); display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }
        
        header {
            height: 50px; background: var(--wb-panel-bg); border-bottom: 2px solid var(--wb-border-color);
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        }
        .sys-logo { font-size: 24px; font-weight: bold; color: var(--wb-accent-red); text-shadow: 0 0 8px var(--wb-accent-red); }
        #live-clock { font-size: 14px; color: var(--wb-text-green); }
        #kernel-status { font-size: 11px; background: var(--wb-border-color); padding: 4px 10px; border-radius: 3px; }

        #main-container { display: flex; flex: 1; overflow: hidden; gap: 6px; padding: 6px; }

        /* Left Panel */
        #left-panel { width: 320px; background: var(--wb-panel-bg); display: flex; flex-direction: column; border: 1px solid var(--wb-border-color); }
        .panel-header { background: var(--wb-border-color); padding: 8px 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .search-area { padding: 10px; background: rgba(0,0,0,0.3); }
        #q_input { width: 100%; background: #000; border: 1px solid var(--wb-border-color); color: var(--wb-text-green); padding: 8px; outline: none; box-sizing: border-box; }
        #trip-list { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); }
        .trip-row { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .trip-row:hover { background: rgba(255,255,255,0.08); }
        .trip-row.active { background: var(--wb-border-color); border-left: 5px solid var(--wb-accent-red); }

        /* Center Panel */
        #center-panel { flex: 1; border: 1px solid var(--wb-border-color); position: relative; }
        #map { height: 100%; width: 100%; background: #000; }
        .map-coords { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: var(--wb-text-green); padding: 5px; font-size: 11px; z-index: 1000; }

        /* Right Panel */
        #right-panel { width: 360px; background: var(--wb-panel-bg); display: flex; flex-direction: column; border: 1px solid var(--wb-border-color); }
        #station-timeline { flex: 1; overflow-y: auto; padding: 10px 15px; background: rgba(0,0,0,0.2); }
        .st-entry { position: relative; padding-left: 25px; padding-bottom: 15px; border-left: 2px dashed rgba(255,255,255,0.1); margin-left: 10px; cursor: pointer; }
        .st-entry::before { content: ""; position: absolute; left: -8px; top: 0; width: 14px; height: 14px; border-radius: 50%; background: var(--wb-border-color); }
        .st-entry.highlight::before { background: var(--wb-accent-red); box-shadow: 0 0 10px var(--wb-accent-red); }
        .st-name { font-weight: bold; color: var(--wb-text-light); }
        .st-time { font-size: 12px; color: var(--wb-text-green); }

        #telemetry-display { height: 160px; background: rgba(0,0,0,0.3); padding: 10px; border-top: 1px solid var(--wb-border-color); font-size: 12px; line-height: 1.6; }
        
        /* Bottom Console */
        #console-log { height: 140px; background: #000; color: var(--wb-text-green); font-size: 11px; padding: 10px; overflow-y: auto; border-top: 2px solid var(--wb-border-color); }
        
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--wb-accent-red); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div id="loader-msg" style="margin-top:20px; letter-spacing: 2px;">CALCULATING TRAJECTORY...</div>
</div>

<header>
    <div class="header-left"><span class="sys-logo">WB-OCC</span><span> COMMAND TERMINAL</span></div>
    <div class="header-right"><span id="live-clock">00:00:00</span><span id="kernel-status">PY-KERNEL: BOOTING</span></div>
</header>

<div id="main-container">
    <div id="left-panel">
        <div class="panel-header">Target Acquisition</div>
        <div class="search-area"><input type="text" id="q_input" placeholder="TRIP ID..."></div>
        <div id="trip-list"></div>
    </div>
    <div id="center-panel">
        <div id="map"></div>
        <div id="map-coords" class="map-coords">LAT: -- LON: --</div>
    </div>
    <div id="right-panel">
        <div class="panel-header">Station Telemetry</div>
        <div id="station-timeline"></div>
        <div class="panel-header">Operations Metrics</div>
        <div id="telemetry-display">READY.</div>
    </div>
</div>

<div id="console-log"></div>

<script>
    // --- JavaScript Core ---
    const map = L.map('map', { zoomControl: false }).setView([35.68, 139.76], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let drawLayer = L.layerGroup().addTo(map);
    let markerLayer = L.layerGroup().addTo(map);

    let gtfsDB = { trips: [], stops: [], stop_times: [] };

    function writeLog(msg, source="JS") {
        const con = document.getElementById("console-log");
        const div = document.createElement("div");
        div.innerText = `[${new Date().toLocaleTimeString()}] [${source}] ${msg}`;
        con.appendChild(div); con.scrollTop = con.scrollHeight;
    }

    async function init() {
        writeLog("Starting system synchronization...");
        try {
            for(const f of ['trips', 'stops', 'stop_times']) {
                const res = await fetch(`./${f}.txt`);
                const text = await res.text();
                gtfsDB[f] = Papa.parse(text.trim(), { header: true }).data;
                writeLog(`${f}.txt indexed.`);
            }
            renderList("");
        } catch (e) { writeLog("INIT ERROR: " + e.message, "ERR"); }
    }

    function renderList(q) {
        const list = document.getElementById('trip-list');
        list.innerHTML = '';
        gtfsDB.trips.filter(t => t.trip_id.includes(q)).slice(0, 50).forEach(t => {
            const div = document.createElement('div');
            div.className = 'trip-row';
            div.innerHTML = `<strong>${t.trip_id}</strong><br><small>${t.trip_headsign || ''}</small>`;
            div.onclick = () => {
                document.querySelectorAll('.trip-row').forEach(r => r.classList.remove('active'));
                div.classList.add('active');
                document.getElementById('loader').style.display = 'flex';
                window.dispatchEvent(new CustomEvent("analyze", { detail: t.trip_id }));
            };
            list.appendChild(div);
        });
    }

    document.getElementById('q_input').oninput = (e) => renderList(e.target.value);
    
    window.updateUI = (coords_json, stations_json, stats_json) => {
        const coords = JSON.parse(coords_json);
        const stations = JSON.parse(stations_json);
        const stats = JSON.parse(stats_json);

        drawLayer.clearLayers(); markerLayer.clearLayers();
        if(coords.length > 0) {
            const poly = L.polyline(coords, {color: '#ff3366', weight: 4}).addTo(drawLayer);
            map.fitBounds(poly.getBounds(), {padding: [50,50]});
        }

        const timeline = document.getElementById('station-timeline');
        timeline.innerHTML = '';
        stations.forEach(s => {
            const entry = document.createElement('div');
            entry.className = 'st-entry highlight';
            entry.innerHTML = `<div class="st-name">${s.name}</div><div class="st-time">${s.arr} / ${s.dep}</div>`;
            entry.onclick = () => { map.flyTo([s.lat, s.lon], 14); };
            timeline.appendChild(entry);
            L.circleMarker([s.lat, s.lon], {radius: 5, color: '#00ffcc'}).addTo(markerLayer).bindPopup(s.name);
        });

        document.getElementById('telemetry-display').innerHTML = `
            NODE_COUNT: ${stats.count}<br>
            EST_DISTANCE: ${stats.dist.toFixed(2)} km<br>
            START: ${stations[0].arr}<br>
            END: ${stations[stations.length-1].dep}<br>
            SYSTEM_INTEGRITY: NOMINAL
        `;
        document.getElementById('loader').style.display = 'none';
        writeLog("Analysis display updated.", "OCC");
    };

    setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    init();
</script>

<py-script>
import js, json, math
from pyodide.http import pyfetch
from pyodide.ffi import create_proxy

GD_ID = "12uumDK-VYglG26_33nkMhcVjfUaFLdrE"
SHAPES_URL = f"https://docs.google.com/spreadsheets/d/{GD_ID}/export?format=csv"

def pylog(msg): js.writeLog(msg, "PY")

def haversine(c1, c2):
    R = 6371
    phi1, phi2 = math.radians(c1[0]), math.radians(c2[0])
    dphi = math.radians(c2[0]-c1[0])
    dlambda = math.radians(c2[1]-c1[1])
    a = math.sin(dphi/2)**2 + math.cos(phi1)*math.cos(phi2)*math.sin(dlambda/2)**2
    return R * 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))

async def handle_analyze(event):
    trip_id = event.detail
    pylog(f"Acquiring telemetry for {trip_id}...")
    try:
        trips = js.gtfsDB.trips.to_py()
        stops = js.gtfsDB.stops.to_py()
        stop_times = js.gtfsDB.stop_times.to_py()

        target = next((t for t in trips if t['trip_id'] == trip_id), None)
        sid = target.get('shape_id')

        # 1. Timeline
        my_st = sorted([s for s in stop_times if s['trip_id'] == trip_id], key=lambda x: int(x['stop_sequence']))
        timeline = []
        for ms in my_st:
            st = next((s for s in stops if s['stop_id'] == ms['stop_id']), None)
            if st:
                timeline.append({"name": st['stop_name'], "arr": ms['arrival_time'], "dep": ms['departure_time'], "lat": float(st['stop_lat']), "lon": float(st['stop_lon'])})

        # 2. Shapes
        pylog(f"Fetching cloud geometry: {sid}")
        res = await pyfetch(SHAPES_URL)
        text = await res.string()
        lines = text.strip().split('\n')
        h = [x.strip() for x in lines[0].split(',')]
        idx = {key: h.index(key) for key in ['shape_id', 'shape_pt_lat', 'shape_pt_lon', 'shape_pt_sequence']}
        
        coords = []
        for line in lines[1:]:
            cols = line.split(',')
            if len(cols) > idx['shape_id'] and cols[idx['shape_id']] == sid:
                coords.append([float(cols[idx['shape_pt_lat']]), float(cols[idx['shape_pt_lon']]), int(cols[idx['shape_pt_sequence']])])
        
        coords.sort(key=lambda x: x[2])
        final_coords = [[c[0], c[1]] for c in coords]

        # 3. Stats
        dist = sum(haversine(final_coords[i], final_coords[i+1]) for i in range(len(final_coords)-1))
        stats = {"count": len(timeline), "dist": dist}

        js.window.updateUI(json.dumps(final_coords), json.dumps(timeline), json.dumps(stats))
        pylog("Trajectory synchronized.")

    except Exception as e:
        pylog(f"CRITICAL ERROR: {str(e)}")
        js.document.getElementById('loader').style.display = 'none'

js.window.addEventListener("analyze", create_proxy(handle_analyze))
js.document.getElementById("kernel-status").innerText = "PY-KERNEL: ONLINE"
pylog("OCC Core Intelligence systems nominal.")
</py-script>

</body>
</html>
