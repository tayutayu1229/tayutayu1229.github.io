<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JAL フライトスケジュール</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }

    h1 {
      color: #003366;
    }

    .search-box {
      margin-bottom: 20px;
    }

    input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
    }

    .day-section {
      margin-bottom: 40px;
    }

    h2 {
      margin-top: 30px;
      color: #005599;
    }

    .flight {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
      border-left: 5px solid #005599;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .flight span {
      display: block;
      margin-bottom: 3px;
    }

    #json-debug {
      background: #eef;
      white-space: pre-wrap;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 12px;
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <h1>JAL フライトスケジュール</h1>

  <div class="search-box">
    <label>便名で検索：</label>
    <input type="text" id="search" placeholder="例：JL2050">
  </div>

  <div id="schedule">読み込み中...</div>

  <h2>🔍 取得したAPIデータ（デバッグ用）</h2>
  <pre id="json-debug">読み込み中...</pre>

  <script>
    const token = "wvzxbmrc468he3y0p93ufz8ovhcqn5sauiiuixepg22wluhptpc42o78xfe38onh"; // ← あなたのAPIキーを入力
    const apiUrl = `https://api.odpt.org/api/v4/odpt:FlightSchedule?odpt:operator=odpt.Operator:JAL&acl:consumerKey=${token}`;

    const airportMap = {
      "FUK": "福岡空港",
      "ITM": "大阪国際空港（伊丹）",
      "HND": "東京国際空港（羽田）",
      "NRT": "成田国際空港",
      "CTS": "新千歳空港",
      "KIX": "関西国際空港"
    };

    const dayMap = {
      "Monday": "月曜日",
      "Tuesday": "火曜日",
      "Wednesday": "水曜日",
      "Thursday": "木曜日",
      "Friday": "金曜日",
      "Saturday": "土曜日",
      "Sunday": "日曜日",
      "Weekday": "平日",
      "Holiday": "休日"
    };

    const scheduleContainer = document.getElementById('schedule');
    const debugOutput = document.getElementById('json-debug');
    const searchInput = document.getElementById('search');
    let allFlightDivs = [];

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        // JSONそのまま表示
        debugOutput.textContent = JSON.stringify(data, null, 2);

        scheduleContainer.innerHTML = '';
        allFlightDivs = [];

        data.forEach(item => {
          const date = item["dc:date"]?.split("T")[0] || "日付不明";
          const calendar = item["odpt:calendar"]?.split(":")[1] || "曜日不明";
          const weekday = dayMap[calendar] || calendar;

          const originCode = item["odpt:originAirport"].split(":")[1];
          const destCode = item["odpt:destinationAirport"].split(":")[1];
          const origin = airportMap[originCode] || originCode;
          const dest = airportMap[destCode] || destCode;

          const section = document.createElement("div");
          section.className = "day-section";

          const title = document.createElement("h2");
          title.textContent = `${weekday}（${date}）`;
          section.appendChild(title);

          (item["odpt:flightScheduleObject"] || []).forEach(flight => {
            const flightNum = flight["odpt:flightNumber"][0];
            const originTime = flight["odpt:originTime"];
            const destTime = flight["odpt:destinationTime"];
            const aircraft = flight["odpt:aircraftType"];
            const validFrom = flight["odpt:isValidFrom"]?.split("T")[0] || "";
            const validTo = flight["odpt:isValidTo"]?.split("T")[0] || "";

            const flightDiv = document.createElement("div");
            flightDiv.className = "flight";
            flightDiv.setAttribute("data-flight", flightNum.toUpperCase());

            flightDiv.innerHTML = `
              <span><strong>便名：</strong>${flightNum}</span>
              <span><strong>出発：</strong>${origin} ${originTime}</span>
              <span><strong>到着：</strong>${dest} ${destTime}</span>
              <span><strong>機材：</strong>${aircraft}</span>
              <span><strong>運行期間：</strong>${validFrom} ～ ${validTo}</span>
            `;

            section.appendChild(flightDiv);
            allFlightDivs.push(flightDiv);
          });

          scheduleContainer.appendChild(section);
        });
      })
      .catch(err => {
        debugOutput.textContent = `API取得エラー:\n${err}`;
        scheduleContainer.innerHTML = `<p style="color:red;">APIデータの取得に失敗しました。トークンやネットワーク接続を確認してください。</p>`;
      });

    searchInput.addEventListener("input", () => {
      const keyword = searchInput.value.trim().toUpperCase();
      allFlightDivs.forEach(div => {
        const flight = div.getAttribute("data-flight");
        div.style.display = keyword === "" || flight.includes(keyword) ? "block" : "none";
      });
    });
  </script>
</body>
</html>
