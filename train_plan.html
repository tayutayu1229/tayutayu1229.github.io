<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運転計画モニタ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2 {
            color: #01977a;
            text-align: center;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        input[type="date"] {
            padding: 5px;
            border: 1px solid #01977a;
            border-radius: 4px;
        }
        button {
            background-color: #01977a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #017a64;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #01977a;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .error-message {
            color: red;
            text-align: center;
            margin-top: 10px;
        }

        /* 既存のスタイル */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #01977a;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>運転計画モニタ</h1>
        <div class="controls">
            <input type="date" id="date-picker">
            <button onclick="fetchEvents()">予定を取得</button>
            <button onclick="showAllEvents()">全ての予定を表示</button>
        </div>
        <div id="events-container"></div>
        <div id="error-message" class="error-message"></div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const API_KEY = 'AIzaSyAfJghircP0PcuGyDB3g8RgYm_cx5KhgYI';
        const CLIENT_ID = '178325056160-6mtl7jmh883gp7m75vuhmd49r7q3mt81.apps.googleusercontent.com';

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            console.log('Initializing client...');
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                console.log('Client initialized');
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            }, function(error) {
                console.error('Error initializing client:', error);
                showError('初期化エラー: ' + error.details);
            });
        }

        function updateSigninStatus(isSignedIn) {
            console.log('Sign-in status:', isSignedIn);
            if (!isSignedIn) {
                gapi.auth2.getAuthInstance().signIn().catch(function(error) {
                    console.error('Sign-in error:', error);
                    showError('サインインに失敗しました: ' + error.error);
                });
            }
        }

        function fetchEvents() {
            if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
                showError('サインインしていません。再度お試しください。');
                return;
            }

            const date = document.getElementById('date-picker').value;
            if (!date) {
                showError('日付を選択してください');
                return;
            }

            showLoader();
            console.log('Fetching events for date:', date);

            const startDate = new Date(date);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 1);

            gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': startDate.toISOString(),
                'timeMax': endDate.toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'orderBy': 'startTime'
            }).then(function(response) {
                console.log('Events retrieved:', response.result.items);
                hideLoader();
                const events = response.result.items;
                displayEvents(events, '選択日の予定');
            }, function(error) {
                console.error('Error fetching events:', error);
                hideLoader();
                showError('予定の取得に失敗しました: ' + error.result.error.message);
            });
        }

        function showAllEvents() {
            if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
                showError('サインインしていません。再度お試しください。');
                return;
            }

            showLoader();
            console.log('Fetching all events');

            gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 250,
                'orderBy': 'startTime'
            }).then(function(response) {
                console.log('All events retrieved:', response.result.items);
                hideLoader();
                const events = response.result.items;
                displayEvents(events, '全ての予定');
            }, function(error) {
                console.error('Error fetching all events:', error);
                hideLoader();
                showError('予定の取得に失敗しました: ' + error.result.error.message);
            });
        }
        function displayEvents(events, title) {
            const container = document.getElementById('events-container');
            container.innerHTML = '';
            
            const h2 = document.createElement('h2');
            h2.textContent = title;
            container.appendChild(h2);

            if (events.length === 0) {
                container.innerHTML += '<p>予定はありません。</p>';
                return;
            }

            const table = document.createElement('table');
            const headerRow = table.insertRow();
            ['日付', '時間', '予定'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            events.forEach(event => {
                const row = table.insertRow();
                const start = new Date(event.start.dateTime || event.start.date);
                
                const dateCell = row.insertCell();
                dateCell.textContent = start.toLocaleDateString('ja-JP');

                const timeCell = row.insertCell();
                timeCell.textContent = event.start.dateTime ? start.toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'}) : '終日';

                const summaryCell = row.insertCell();
                summaryCell.textContent = event.summary || '(タイトルなし)';
            });

            container.appendChild(table);
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
        }

        function showLoader() {
            document.getElementById('loader').style.display = 'block';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        handleClientLoad();
    </script>
</body>
</html>
