<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運行情報一覧 - 東京圏輸送情報システム</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            line-height: 1.6;
            color: #333;
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        header {
            background-color: #01977a;
            color: white;
            text-align: center;
            padding: 1em;
            margin-bottom: 10px;
        }
        h1 { margin: 0; font-size: 1.8em; }
        
        main {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 800px;
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
            flex-wrap: wrap;
        }
        .update-timestamp {
            font-size: 0.85em;
            color: #666;
            background: #eee;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .filter-container {
            text-align: center; 
            margin-bottom: 15px; 
            background-color: #f9f9f9; 
            padding: 10px; 
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .train-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
            position: relative;
        }

        .railway-title {
            font-weight: 800;
            font-size: 1.25em;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            font-size: 0.65em;
            padding: 3px 10px;
            border-radius: 20px;
            color: #fff;
            font-weight: bold;
        }

        /* 状態別カラー */
        .status-normal { border-left: 8px solid #28a745; }
        .status-normal .status-badge { background-color: #28a745; }

        .status-delay { border-left: 8px solid #ffc107; background-color: #fffdf0; }
        .status-delay .status-badge { background-color: #ffc107; color: #333; }

        .status-suspend { border-left: 8px solid #dc3545; background-color: #fff5f5; }
        .status-suspend .status-badge { background-color: #dc3545; }

        .status-notice { border-left: 8px solid #17a2b8; background-color: #f0faff; }
        .status-notice .status-badge { background-color: #17a2b8; }

        /* 履歴表示 */
        .history-section {
            margin-top: 12px;
            border-top: 1px dashed #ccc;
            padding-top: 8px;
        }
        .history-toggle {
            font-size: 0.8em;
            color: #01977a;
            cursor: pointer;
            font-weight: bold;
            display: inline-block;
        }
        .history-list {
            display: none;
            font-size: 0.85em;
            background: #fafafa;
            padding: 10px;
            border-radius: 4px;
            list-style: none;
            margin: 8px 0 0 0;
            border: 1px solid #eee;
        }
        .history-item {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
        }
        .history-item:last-child { border-bottom: none; }
        .history-time {
            font-weight: bold;
            color: #333;
            background: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
            margin-right: 5px;
        }

        button {
            background-color: #01977a;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            display: block;
            margin: 10px auto;
            transition: 0.3s;
        }
        button:hover { background-color: #017a64; }
        footer { text-align: center; margin-top: 20px; color: #666; font-size: 0.8em; padding-bottom: 20px; }

        @media (max-width: 768px) {
            h1 { font-size: 1.4em; }
            button { width: 90%; }
        }
    </style>
</head>
<body>
    <div id="main-content" style="display: none;"> 
        <header>
            <h1>運行情報一覧</h1>
        </header>

        <button onclick="window.location.href='zaisen-JRE.html'">駅列車在線モニタに戻る</button>
        <button onclick="window.location.href='railinfo.html'">運行情報2へ</button>
        <button onclick="window.location.href='toppage.html'">メインメニューに戻る</button>

        <main>
            <div class="info-header">
                <div id="filter-area"></div>
                <div id="update-timestamp" class="update-timestamp">取得中...</div>
            </div>
            
            <div id="train-info">
                </div>
        </main>

        <button onclick="window.location.href='zaisen-JRE.html'">駅列車在線モニタに戻る</button>
        <button onclick="window.location.href='toppage.html'">メインメニューに戻る</button>

        <footer>
            <p>&copy; 2026 H・N／たゆたゆ運行情報取得システム</p>
        </footer>

        <script>
            // 路線名マッピング
            const railwayMap = {
                "JR-East.Chuo": "中央本線", "JR-East.Senzan": "仙山線", "JR-East.Yonesaka": "米坂線", "JR-East.Hanawa": "花輪線",
                "JR-East.Tsugaru": "津軽線", "JR-East.Ou": "奥羽本線", "JR-East.OuYamagata": "奥羽本線（山形線）", "JR-East.RikuEast": "陸羽東線",
                "JR-East.Tohoku": "東北本線", "JR-East.Uetsu": "羽越線", "JR-East.RikuWest": "陸羽西線", "JR-East.Iiyama": "飯山線",
                "JR-East.Yamanote": "山手線", "JR-East.KeihinTohokuNegishi": "京浜東北根岸線", "JR-East.ChuoRapid": "中央急行線",
                "JR-East.ChuoTatsunoBranch": "中央本線（辰野方面）", "JR-East.ChuoSobuLocal": "中央緩行線", "JR-East.SobuRapid": "総武快速線",
                "JR-East.Yokosuka": "横須賀線", "JR-East.Tokaido": "東海道線", "JR-East.ShonanShinjuku": "湘南新宿ライン",
                "JR-East.SotetsuDirect": "相鉄直通線", "JR-East.SaikyoKawagoe": "埼京川越線", "JR-East.Kawagoe": "川越線",
                "JR-East.Takasaki": "高崎線", "JR-East.Utsunomiya": "宇都宮線", "JR-East.Nikko": "日光線", "JR-East.Karasuyama": "烏山線",
                "JR-East.JobanRapid": "常磐快速線", "JR-East.Joban": "常磐線", "JR-East.JobanLocal": "常磐緩行線", "JR-East.Musashino": "武蔵野線",
                "JR-East.Sagami": "相模線", "JR-East.Nambu": "南武線", "JR-East.NambuBranch": "南武支線", "JR-East.Tsurumi": "鶴見線",
                "JR-East.TsurumiUmiShibauraBranch": "鶴見線（海芝浦方面）", "JR-East.TsurumiOkawaBranch": "鶴見線（大川方面）",
                "JR-East.Yokohama": "横浜線", "JR-East.Ito": "伊東線", "JR-East.Ome": "青梅線", "JR-East.Itsukaichi": "五日市線",
                "JR-East.Hachiko": "八高線", "JR-East.Shinetsu": "信越線", "JR-East.Joetsu": "上越線", "JR-East.Agatsuma": "吾妻線",
                "JR-East.Ryomo": "両毛線", "JR-East.Mito": "水戸線", "JR-East.Suigun": "水郡線", "JR-East.SuigunBranch": "水郡線常陸太田支線",
                "JR-East.Sobu": "総武本線", "JR-East.Narita": "成田線", "JR-East.NaritaAbikoBranch": "成田線（我孫子支線）",
                "JR-East.NaritaAirportBranch": "成田線（空港支線）", "JR-East.Kashima": "鹿島線", "JR-East.Keiyo": "京葉線",
                "JR-East.Uchibo": "内房線", "JR-East.Sotobo": "外房線", "JR-East.Togane": "東金線", "JR-East.Kururi": "久留里線",
                "JR-East.Koumi": "小海線", "JR-East.TohokuShinkansen": "東北新幹線", "JR-East.JoetsuShinkansen": "上越新幹線",
                "JR-East.HokurikuShinkansen": "北陸新幹線", "JR-East.YamagataShinkansen": "山形新幹線", "JR-East.AkitaShinkansen": "秋田新幹線",
                "JR-East.BanetsuEast": "磐越東線", "JR-East.Senseki": "仙石線", "JR-East.Ishinomaki": "石巻線", "JR-East.Aterazawa": "左沢線",
                "JR-East.Ofunato": "大船渡線", "JR-East.Kesennuma": "気仙沼線", "JR-East.Kitakami": "北上線", "JR-East.Kamaishi": "釜石線",
                "JR-East.Yamada": "山田線", "JR-East.Hachinohe": "八戸線", "JR-East.Ominato": "大湊線", "JR-East.Tazawako": "田沢湖線",
                "JR-East.Oga": "男鹿線", "JR-East.Gono": "五能線", "JR-East.Tadami": "只見線", "JR-East.BanetsuWest": "磐越西線",
                "JR-East.SensekiTohoku": "仙石東北ライン", "JR-East.Echigo": "越後線", "JR-East.Hakushin": "白新線",
                "JR-East.Yahiko": "弥彦線", "JR-East.Shinonoi": "篠ノ井線", "JR-East.Oito": "大糸線"
            };

            let cachedData = [];

            // フィルタの作成
            function initUI() {
                const area = document.getElementById('filter-area');
                area.innerHTML = `<div class="filter-container">
                    <label><input type="checkbox" id="hide-normal" onchange="renderInfo()"> 平常運転の線区を非表示</label>
                </div>`;
            }

            // 履歴保存 (中身のテキストが違う場合のみ)
            function saveHistory(data) {
                const KEY = 'train_history_content_based';
                let store = JSON.parse(localStorage.getItem(KEY) || '{}');
                let updated = false;

                data.forEach(item => {
                    const id = item["odpt:railway"];
                    const text = item["odpt:trainInformationText"]?.ja;
                    const date = item["dc:date"];
                    const status = item["odpt:trainInformationStatus"]?.ja || "平常運転";

                    if (!store[id]) store[id] = [];
                    const last = store[id][0];

                    // テキスト中身が前回と違う場合のみ記録
                    if (text && (!last || last.text !== text)) {
                        store[id].unshift({ date, text, status });
                        if (store[id].length > 10) store[id].pop(); // 最大10件
                        updated = true;
                    }
                });

                if (updated) localStorage.setItem(KEY, JSON.stringify(store));
                return store;
            }

            function fetchInfo() {
                const token = "wvzxbmrc468he3y0p93ufz8ovhcqn5sauiiuixepg22wluhptpc42o78xfe38onh";
                const url = `https://api-challenge.odpt.org/api/v4/odpt:TrainInformation?odpt:operator=odpt.Operator:jre-is&acl:consumerKey=${token}`;

                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        cachedData = data;
                        saveHistory(data);
                        renderInfo();
                    })
                    .catch(e => console.error("Fetch Error:", e));
            }

            function renderInfo() {
                const container = document.getElementById('train-info');
                const hideNormal = document.getElementById('hide-normal').checked;
                const historyStore = JSON.parse(localStorage.getItem('train_history_content_based') || '{}');

                if (cachedData.length > 0) {
                    const d = new Date(cachedData[0]["dc:date"]);
                    document.getElementById('update-timestamp').innerText = "データ更新: " + d.toLocaleTimeString();
                }

                const priority = { '運転見合わせ': 1, '一部運休': 1, '運転再開見込': 1, '遅延': 2, '平常運転': 3 };
                const sorted = [...cachedData].sort((a, b) => {
                    return (priority[a["odpt:trainInformationStatus"]?.ja] || 99) - (priority[b["odpt:trainInformationStatus"]?.ja] || 99);
                });

                let html = '';
                sorted.forEach((info, idx) => {
                    const status = info["odpt:trainInformationStatus"]?.ja || "平常運転";
                    if (hideNormal && status === '平常運転') return;

                    const rId = info["odpt:railway"];
                    const name = railwayMap[rId.replace("odpt.Railway:", "")] || rId;
                    const text = info["odpt:trainInformationText"]?.ja || "平常通り運転しています。";
                    
                    let cls = 'status-notice';
                    if (status === '平常運転') cls = 'status-normal';
                    else if (status.includes('遅延') || status.includes('再開')) cls = 'status-delay';
                    else if (status.includes('見合わせ') || status.includes('運休')) cls = 'status-suspend';

                    const history = historyStore[rId] || [];
                    const past = history.filter(h => h.date !== info["dc:date"]);

                    html += `
                    <div class="train-card ${cls}">
                        <div class="railway-title">${name} <span class="status-badge">${status}</span></div>
                        <p style="font-size:0.85em; color:#555;">事由: ${info["odpt:trainInformationCause"]?.ja || "---"} / 区間: ${info["odpt:trainInformationRange"]?.ja || "---"}</p>
                        <p style="font-weight:bold; margin-top:5px;">${text}</p>
                        ${past.length > 0 ? `
                        <div class="history-section">
                            <span class="history-toggle" onclick="document.getElementById('hlist-${idx}').style.display = (document.getElementById('hlist-${idx}').style.display === 'block' ? 'none' : 'block')">
                                ▼ 内容が変更された過去の履歴 (${past.length}件)
                            </span>
                            <ul class="history-list" id="hlist-${idx}">
                                ${past.map(p => `
                                    <li class="history-item">
                                        <span class="history-time">${new Date(p.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                        <span style="color:#d32f2f; font-weight:bold;">[${p.status}]</span><br>
                                        ${p.text}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>` : ''}
                    </div>`;
                });
                container.innerHTML = html || "<p style='text-align:center;'>表示する情報はありません。</p>";
            }

            window.onload = () => {
                initUI();
                fetchInfo();
                setInterval(fetchInfo, 60000); // 1分更新
            };
        </script>

        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
        <script src="auth_guard.js"></script> 
    </div>
</body> 
</html>
