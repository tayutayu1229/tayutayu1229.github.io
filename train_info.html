<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運行情報一覧 - 東京圏輸送情報システム</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            line-height: 1.6;
            color: #333;
            width: 100%;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        header {
            background-color: #01977a;
            color: white;
            text-align: center;
            padding: 1em;
            margin-bottom: 10px;
        }
        h1 { margin: 0; font-size: 1.8em; }
        
        main {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 800px;
        }

        /* 画面右上の更新時刻表示 */
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .update-timestamp {
            font-size: 0.85em;
            color: #666;
            background: #eee;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .filter-container {
            text-align: center; 
            margin-bottom: 15px; 
            background-color: #f9f9f9; 
            padding: 10px; 
            border-radius: 5px;
            border: 1px solid #eee;
        }

        /* 運行情報カードのスタイル */
        .train-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }

        /* 路線名の太字表示 */
        .railway-title {
            font-weight: 800;
            font-size: 1.25em;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ステータスバッジ */
        .status-badge {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 4px;
            color: #fff;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* 状態別色分け */
        .status-normal { border-left: 8px solid #28a745; }
        .status-normal .status-badge { background-color: #28a745; }

        .status-delay { border-left: 8px solid #ffc107; background-color: #fffdf0; }
        .status-delay .status-badge { background-color: #ffc107; color: #333; }

        .status-suspend { border-left: 8px solid #dc3545; background-color: #fff5f5; }
        .status-suspend .status-badge { background-color: #dc3545; }

        .status-notice { border-left: 8px solid #17a2b8; background-color: #f0faff; }
        .status-notice .status-badge { background-color: #17a2b8; }

        /* 履歴セクション */
        .history-section {
            margin-top: 12px;
            border-top: 1px dashed #ccc;
            padding-top: 8px;
        }
        .history-toggle {
            font-size: 0.8em;
            color: #01977a;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            font-weight: bold;
        }
        .history-list {
            display: none;
            font-size: 0.85em;
            background: #fcfcfc;
            padding: 10px;
            border-radius: 4px;
            list-style: none;
            margin: 8px 0 0 0;
            border: 1px solid #eee;
        }
        .history-item {
            border-bottom: 1px solid #eee;
            padding: 5px 0;
            color: #555;
        }
        .history-item:last-child { border-bottom: none; }
        .history-time {
            font-weight: bold;
            color: #333;
            margin-right: 8px;
            background: #eee;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        button {
            background-color: #01977a;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
            display: block;
            margin: 10px auto;
        }
        button:hover { background-color: #017a64; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        footer { text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; padding-bottom: 20px;}

        @media (max-width: 768px) {
            h1 { font-size: 1.4em; }
            button { width: calc(100% - 40px); }
        }
    </style>
</head>
<body>
    <div id="main-content" style="display: none;"> 
        <header>
            <h1>運行情報一覧</h1>
        </header>

        <div style="padding: 0 10px;">
            <button onclick="window.location.href='zaisen-JRE.html'">駅列車在線モニタに戻る</button>
            <button onclick="window.location.href='railinfo.html'">運行情報2へ</button>
            <button onclick="window.location.href='toppage.html'">メインメニューに戻る</button>
        </div>

        <main>
            <div class="info-header">
                <div id="filter-placeholder"></div>
                <div id="update-timestamp" class="update-timestamp">取得中...</div>
            </div>
            
            <div id="train-info">
                </div>
        </main>

        <button onclick="window.location.href='zaisen-JRE.html'">駅列車在線モニタに戻る</button>
        <button onclick="window.location.href='toppage.html'">メインメニューに戻る</button>

        <footer>
            <p>&copy; 2026 H・N／たゆたゆ運行情報取得システム</p>
        </footer>

        <script>
            // 全路線マッピング（既存のものを継承）
            const railwayMap = {
                "JR-East.Chuo": "中央本線", "JR-East.Senzan": "仙山線", "JR-East.Yonesaka": "米坂線", "JR-East.Hanawa": "花輪線",
                "JR-East.Tsugaru": "津軽線", "JR-East.Ou": "奥羽本線", "JR-East.OuYamagata": "奥羽本線（山形線）", "JR-East.RikuEast": "陸羽東線",
                "JR-East.Tohoku": "東北本線", "JR-East.Uetsu": "羽越線", "JR-East.RikuWest": "陸羽西線", "JR-East.Iiyama": "飯山線",
                "JR-East.Yamanote": "山手線", "JR-East.KeihinTohokuNegishi": "京浜東北根岸線", "JR-East.ChuoRapid": "中央急行線",
                "JR-East.ChuoTatsunoBranch": "中央本線（辰野方面）", "JR-East.ChuoSobuLocal": "中央緩行線", "JR-East.SobuRapid": "総武快速線",
                "JR-East.Yokosuka": "横須賀線", "JR-East.Tokaido": "東海道線", "JR-East.ShonanShinjuku": "湘南新宿ライン",
                "JR-East.SotetsuDirect": "相鉄直通線", "JR-East.SaikyoKawagoe": "埼京川越線", "JR-East.Kawagoe": "川越線",
                "JR-East.Takasaki": "高崎線", "JR-East.Utsunomiya": "宇都宮線", "JR-East.Nikko": "日光線", "JR-East.Karasuyama": "烏山線",
                "JR-East.JobanRapid": "常磐快速線", "JR-East.Joban": "常磐線", "JR-East.JobanLocal": "常磐緩行線", "JR-East.Musashino": "武蔵野線",
                "JR-East.Sagami": "相模線", "JR-East.Nambu": "南武線", "JR-East.NambuBranch": "南武支線", "JR-East.Tsurumi": "鶴見線",
                "JR-East.TsurumiUmiShibauraBranch": "鶴見線（海芝浦方面）", "JR-East.TsurumiOkawaBranch": "鶴見線（大川方面）",
                "JR-East.Yokohama": "横浜線", "JR-East.Ito": "伊東線", "JR-East.Ome": "青梅線", "JR-East.Itsukaichi": "五日市線",
                "JR-East.Hachiko": "八高線", "JR-East.Shinetsu": "信越線", "JR-East.Joetsu": "上越線", "JR-East.Agatsuma": "吾妻線",
                "JR-East.Ryomo": "両毛線", "JR-East.Mito": "水戸線", "JR-East.Suigun": "水郡線", "JR-East.SuigunBranch": "水郡線常陸太田支線",
                "JR-East.Sobu": "総武本線", "JR-East.Narita": "成田線", "JR-East.NaritaAbikoBranch": "成田線（我孫子支線）",
                "JR-East.NaritaAirportBranch": "成田線（空港支線）", "JR-East.Kashima": "鹿島線", "JR-East.Keiyo": "京葉線",
                "JR-East.Uchibo": "内房線", "JR-East.Sotobo": "外房線", "JR-East.Togane": "東金線", "JR-East.Kururi": "久留里線",
                "JR-East.Koumi": "小海線", "JR-East.TohokuShinkansen": "東北新幹線", "JR-East.JoetsuShinkansen": "上越新幹線",
                "JR-East.HokurikuShinkansen": "北陸新幹線", "JR-East.YamagataShinkansen": "山形新幹線", "JR-East.AkitaShinkansen": "秋田新幹線",
                "JR-East.BanetsuEast": "磐越東線", "JR-East.Senseki": "仙石線", "JR-East.Ishinomaki": "石巻線", "JR-East.Aterazawa": "左沢線",
                "JR-East.Ofunato": "大船渡線", "JR-East.Kesennuma": "気仙沼線", "JR-East.Kitakami": "北上線", "JR-East.Kamaishi": "釜石線",
                "JR-East.Yamada": "山田線", "JR-East.Hachinohe": "八戸線", "JR-East.Ominato": "大湊線", "JR-East.Tazawako": "田沢湖線",
                "JR-East.Oga": "男鹿線", "JR-East.Gono": "五能線", "JR-East.Tadami": "只見線", "JR-East.BanetsuWest": "磐越西線",
                "JR-East.SensekiTohoku": "仙石東北ライン", "JR-East.Echigo": "越後線", "JR-East.Hakushin": "白新線",
                "JR-East.Yahiko": "弥彦線", "JR-East.Shinonoi": "篠ノ井線", "JR-East.Oito": "大糸線", "": ""
            };

            function createFilterCheckboxes() {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'filter-container';
                filterDiv.innerHTML = `
                    <label style="cursor:pointer">
                        <input type="checkbox" id="hide-no-info"> 平常運転の線区を非表示
                    </label>
                `;
                document.getElementById('filter-placeholder').appendChild(filterDiv);
                document.getElementById('hide-no-info').addEventListener('change', fetchTrainInfo);
            }

            function toggleHistory(id) {
                const list = document.getElementById('hist-' + id);
                const isVisible = list.style.display === 'block';
                list.style.display = isVisible ? 'none' : 'block';
            }

            // 履歴保存機能 (最大10件保持)
            function saveToHistory(data) {
                let historyStore = JSON.parse(localStorage.getItem('train_history_v2') || '{}');
                data.forEach(item => {
                    const railwayKey = item["odpt:railway"];
                    const currentText = item["odpt:trainInformationText"]?.ja;
                    const currentDate = item["dc:date"];
                    
                    if (!historyStore[railwayKey]) historyStore[railwayKey] = [];
                    
                    // 重複チェック（最新の内容と異なる場合のみ保存）
                    const isDuplicate = historyStore[railwayKey].some(h => h.date === currentDate && h.text === currentText);
                    
                    if (!isDuplicate && currentText) {
                        historyStore[railwayKey].unshift({
                            date: currentDate,
                            text: currentText,
                            status: item["odpt:trainInformationStatus"]?.ja || "情報なし"
                        });
                        // 10件を超えたら古いものを削除
                        if (historyStore[railwayKey].length > 10) {
                            historyStore[railwayKey].pop();
                        }
                    }
                });
                localStorage.setItem('train_history_v2', JSON.stringify(historyStore));
                return historyStore;
            }

            function fetchTrainInfo() {
                const token = "wvzxbmrc468he3y0p93ufz8ovhcqn5sauiiuixepg22wluhptpc42o78xfe38onh";
                const url = `https://api-challenge.odpt.org/api/v4/odpt:TrainInformation?odpt:operator=odpt.Operator:jre-is&acl:consumerKey=${token}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const historyStore = saveToHistory(data);
                        
                        // 画面右上の最終更新表示
                        if(data.length > 0) {
                            const lastUpdate = new Date(data[0]["dc:date"]);
                            document.getElementById('update-timestamp').innerText = 
                                "データ更新: " + lastUpdate.toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                        }

                        // ステータス優先度
                        const statusPriority = {
                            '運転見合わせ': 1, '一部運休': 1, '運転再開見込': 1, '直通運転中止': 1,
                            '運転再開': 2, '遅延': 2, '平常運転': 3, 'お知らせ': 4
                        };

                        data.sort((a, b) => {
                            const statusA = statusPriority[a["odpt:trainInformationStatus"]?.ja] || 99;
                            const statusB = statusPriority[b["odpt:trainInformationStatus"]?.ja] || 99;
                            return statusA - statusB;
                        });

                        const hideNoInfo = document.getElementById('hide-no-info').checked;
                        const filteredData = data.filter(info => {
                            const status = info["odpt:trainInformationStatus"]?.ja || "情報なし";
                            if (hideNoInfo && status === '平常運転') return false;
                            return true;
                        });

                        let output = '';
                        filteredData.forEach((train_info, index) => {
                            const status = train_info["odpt:trainInformationStatus"]?.ja || "情報なし";
                            const cause = train_info["odpt:trainInformationCause"]?.ja || "---";
                            let railwayId = train_info["odpt:railway"]?.replace("odpt.Railway:", "") || "不明な路線";
                            const railwayName = railwayMap[railwayId] || railwayId;
                            const range = train_info["odpt:trainInformationRange"]?.ja || "全線";
                            const text = train_info["odpt:trainInformationText"]?.ja || "情報なし";

                            let statusClass = 'status-notice';
                            if (status === '平常運転') statusClass = 'status-normal';
                            else if (status.includes('再開') || status.includes('遅延')) statusClass = 'status-delay';
                            else if (status.includes('見合わせ') || status.includes('運休') || status.includes('中止')) statusClass = 'status-suspend';

                            // 同一路線の過去履歴（現在のデータ以外）
                            const allHistories = historyStore[train_info["odpt:railway"]] || [];
                            const pastHistories = allHistories.filter(h => h.date !== train_info["dc:date"]);

                            output += `
                                <div class="train-card ${statusClass}">
                                    <div class="railway-title">
                                        ${railwayName} 
                                        <span class="status-badge">${status}</span>
                                    </div>
                                    <p><strong>事由:</strong> ${cause} / <strong>区間:</strong> ${range}</p>
                                    <p style="margin-top:10px;">${text}</p>
                                    
                                    ${pastHistories.length > 0 ? `
                                    <div class="history-section">
                                        <div class="history-toggle" onclick="toggleHistory(${index})">
                                            ▼ 過去の履歴を表示 (${pastHistories.length}件)
                                        </div>
                                        <ul class="history-list" id="hist-${index}">
                                            ${pastHistories.map(h => `
                                                <li class="history-item">
                                                    <span class="history-time">${new Date(h.date).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'})}</span>
                                                    [${h.status}] ${h.text}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>` : ''}
                                </div>
                            `;
                        });
                        document.getElementById("train-info").innerHTML = output || "<p style='text-align:center; padding:20px;'>対象の路線はありません。</p>";
                    })
                    .catch(error => {
                        console.error("エラー:", error);
                        document.getElementById("train-info").innerHTML = "<p>データの取得に失敗しました。トークンや通信を確認してください。</p>";
                    });
            }

            window.onload = function() {
                createFilterCheckboxes();
                fetchTrainInfo();
                setInterval(fetchTrainInfo, 60000); // 1分ごとに自動更新
            };
        </script>

        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
        <script src="auth_guard.js"></script> 
    </div>
</body> 
</html>
