<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>列車旅客案内システム - 指令端末</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FontAwesome / Leaflet -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root {
      --bg: #f9f9f9;
      --accent: #008000; /* JR東日本グリーン */
    }
    html,body { height:100%; }
    body {
      background: var(--bg);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #1f2937;
    }
    /* sidebar fixed width on desktop; full-width on small screens */
    .sidebar { width: 320px; min-width: 280px; }
    @media (max-width: 768px) {
      .sidebar { width: 100%; min-width: 0; }
    }
    /* map height */
    #map { height: calc(100vh - 64px); border-radius: 0.5rem; }
    /* train marker */
    .train-marker {
      width: 32px; height: 32px; display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:700; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.25);
      border:2px solid #fff; font-size:12px; background:#3b82f6;
    }
    .train-marker.delayed { background:#ef4444; }
    /* card */
    .card { background:#fff; border-radius:8px; box-shadow: 0 6px 18px rgba(14, 30, 37, 0.06); }
  </style>
</head>
<body class="antialiased">

<div class="min-h-screen flex flex-col lg:flex-row">

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar p-6 card lg:mr-6 lg:mb-0 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-extrabold flex items-center gap-3 text-[var(--accent)]">
        <i class="fas fa-desktop"></i>
        <span>指令端末</span>
      </h1>
      <!-- 前のページに戻る -->
      <button id="back-button" class="bg-gray-100 text-[var(--accent)] px-3 py-1 rounded-md hover:bg-gray-50 border border-gray-200 text-sm">
        <i class="fas fa-arrow-left mr-2"></i>戻る
      </button>
    </div>

    <!-- 運行状況サマリー -->
    <section class="mb-6">
      <div class="px-4 py-3">
        <h2 class="text-lg font-semibold mb-2 border-b-2 border-[var(--accent)] pb-2">運行状況サマリー</h2>
        <div id="summary-panel" class="space-y-3">
          <div id="summary-total" class="flex justify-between items-center">
            <div class="text-sm text-gray-500">総路線数</div>
            <div class="text-2xl font-bold text-[var(--accent)]">-</div>
          </div>
          <div id="summary-delayed" class="flex justify-between items-center">
            <div class="text-sm text-gray-500">遅延路線数</div>
            <div class="text-2xl font-bold text-red-600">-</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 地図種別 -->
    <section class="mb-6 px-4 py-3">
      <h3 class="text-sm font-semibold mb-2">地図の種類</h3>
      <select id="map-style-select" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-md text-sm">
        <option value="osm">OpenStreetMap</option>
        <option value="gsi_std">国土地理院（標準地図）</option>
        <option value="gsi_light">国土地理院（淡色地図）</option>
        <option value="esri_topo">ESRI World Topo Map</option>
      </select>
    </section>

    <!-- 運行情報通知 -->
    <section class="mb-6 px-4 py-3">
      <h3 class="text-lg font-semibold mb-2 border-b-2 border-[var(--accent)] pb-2">運行情報通知</h3>
      <div id="alert-area" class="bg-gray-50 p-3 rounded-md min-h-[5rem] text-sm text-gray-700">
        <p id="alert-message">現在運行情報に関する通知はありません。</p>
      </div>
    </section>

    <!-- 操作パネル（UI非表示だが機能は残す） -->
    <section style="display:none;">
      <h4 class="text-sm font-medium mb-2">操作パネル（駅端末向け）</h4>
      <textarea id="message-input" rows="3" class="w-full p-2 border border-gray-200 rounded-md bg-gray-50"></textarea>
      <button id="update-button" class="mt-3 w-full bg-[var(--accent)] text-white py-2 rounded-md">即時更新</button>
      <div id="status-display" class="text-xs text-gray-500 mt-2">最終更新: <span id="last-updated-time">-</span></div>
    </section>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 flex flex-col">
    <header class="p-6">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-[var(--accent)]">列車運行状況マップ</h2>
          <div class="text-sm text-gray-500">最終更新: <span id="last-updated-time-header">-</span></div>
        </div>
      </div>
    </header>

    <div class="flex-1 p-6">
      <div id="map" class="card"></div>
    </div>
  </main>
</div>

<!-- モーダル（列車詳細） -->
<div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
    <div class="flex justify-between items-center mb-4 border-b pb-2">
      <h3 class="text-2xl font-bold">列車詳細情報</h3>
      <button id="close-modal" class="text-gray-600 text-3xl">&times;</button>
    </div>
    <div id="modal-content" class="text-gray-700"></div>
  </div>
</div>

<!-- Firebase + App logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Firebase config (元ファイルのものをそのまま使用)
  const firebaseConfig = {
    apiKey: "AIzaSyDmB-3bLXv_Z18Cx2MtFux_u74XYG_wgrM",
    authDomain: "shirei-e3601.firebaseapp.com",
    projectId: "shirei-e3601",
    storageBucket: "shirei-e3601.appspot.com",
    messagingSenderId: "889251305346",
    appId: "1:889251305346:web:0fd88ada7b7120c4e9a19b",
    measurementId: "G-RTBWJFCZ3P"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) { /* ignore analytics errors */ }
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM
  const backButton = document.getElementById('back-button');
  const mapStyleSelect = document.getElementById('map-style-select');
  const alertAreaEl = document.getElementById('alert-area');
  const alertMessageEl = document.getElementById('alert-message');
  const summaryTotalEl = document.getElementById('summary-total');
  const summaryDelayedEl = document.getElementById('summary-delayed');
  const lastUpdatedHeader = document.getElementById('last-updated-time-header');
  const modal = document.getElementById('modal');
  const closeModalBtn = document.getElementById('close-modal');
  const modalContentEl = document.getElementById('modal-content');

  const updateButton = document.getElementById('update-button');
  const messageInput = document.getElementById('message-input');
  const statusDisplay = document.getElementById('status-display');
  const lastUpdatedTime = document.getElementById('last-updated-time');

  // ODPT
  const API_KEY = 'wvzxbmrc468he3y0p93ufz8ovhcqn5sauiiuixepg22wluhptpc42o78xfe38onh';
  const API_ENDPOINT = 'https://api-challenge.odpt.org/api/v4/';
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  let userId = 'anonymous';
  let map;
  let currentTileLayer;
  let trainMarkers = [];
  let allStations = {};
  let allRailways = [];
  let allTimetables = {};

  const shortName = (uri) => uri ? uri.split(':').pop().split('.').pop() : '';

  /* ---------- map init ---------- */
  const createMap = () => {
    if (map) map.remove();
    map = L.map('map').setView([35.6812, 139.7671], 12);
    setMapStyle('osm');
  };

  const setMapStyle = (style) => {
    if (currentTileLayer) map.removeLayer(currentTileLayer);
    let tileUrl, attribution;
    switch(style) {
      case 'gsi_std':
        tileUrl = 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png';
        attribution = '<a href="http://www.gsi.go.jp/" target="_blank">国土地理院</a>';
        break;
      case 'gsi_light':
        tileUrl = 'https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png';
        attribution = '<a href="http://www.gsi.go.jp/" target="_blank">国土地理院</a>';
        break;
      case 'esri_topo':
        tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}';
        attribution = 'Tiles © Esri';
        break;
      default:
        tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        attribution = '&copy; OpenStreetMap contributors';
    }
    currentTileLayer = L.tileLayer(tileUrl, { attribution }).addTo(map);
  };

  /* ---------- fetch static resources ---------- */
  async function fetchRailwayData() {
    try {
      const res = await fetch(`${API_ENDPOINT}odpt:Railway?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${API_KEY}`);
      if (!res.ok) throw new Error('Failed to fetch railway data');
      allRailways = await res.json();
    } catch (e) { console.error('fetchRailwayData:', e); }
  }

  async function fetchStationData() {
    try {
      const res = await fetch(`${API_ENDPOINT}odpt:Station?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${API_KEY}`);
      if (!res.ok) throw new Error('Failed to fetch station data');
      const data = await res.json();
      data.forEach(st => {
        const s = shortName(st['owl:sameAs']);
        allStations[s] = {
          title: st['odpt:stationTitle']?.ja || s,
          geo: (st['geo:lat'] && st['geo:long']) ? { lat: st['geo:lat'], long: st['geo:long'] } : null,
          sameAs: st['owl:sameAs']
        };
      });
    } catch (e) { console.error('fetchStationData:', e); }
  }

  async function fetchTimetableData() {
    try {
      const res = await fetch(`${API_ENDPOINT}odpt:TrainTimetable?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${API_KEY}`);
      if (!res.ok) throw new Error('Failed to fetch timetable data');
      const data = await res.json();
      data.forEach(tt => {
        const tn = shortName(tt['odpt:trainNumber']);
        allTimetables[tn] = tt;
      });
    } catch (e) { console.error('fetchTimetableData:', e); }
  }

  /* ---------- train information / alerts ---------- */
  async function fetchTrainInformation() {
    try {
      const res = await fetch(`${API_ENDPOINT}odpt:TrainInformation?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${API_KEY}`);
      if (!res.ok) throw new Error('Failed to fetch train information');
      const data = await res.json();

      // Filter out '平常運転' and 'お知らせ'
      const filtered = data.filter(info => {
        const status = info['odpt:trainInformationStatus']?.ja;
        return status && status !== '平常運転' && status !== 'お知らせ';
      });

      if (filtered.length > 0) {
        alertAreaEl.innerHTML = '';
        filtered.forEach(info => {
          const p = document.createElement('p');
          const railwayName = allRailways.find(r => r['owl:sameAs'] === info['odpt:railway'])?.['odpt:railwayTitle']?.['ja'] || shortName(info['odpt:railway']);
          const status = info['odpt:trainInformationStatus']?.ja || '';
          const text = info['odpt:trainInformationText']?.ja || '';
          p.textContent = `${railwayName}: ${status} — ${text}`;
          alertAreaEl.appendChild(p);
        });
      } else {
        alertAreaEl.innerHTML = '<p id="alert-message">現在運行情報に関する通知はありません。</p>';
      }
    } catch (e) {
      console.error('fetchTrainInformation:', e);
      alertAreaEl.innerHTML = `<p class="text-red-500">運行情報の取得に失敗しました。</p>`;
    }
  }

  /* ---------- realtime trains + map rendering ---------- */
  async function updateDashboard() {
    try {
      const res = await fetch(`${API_ENDPOINT}odpt:Train?odpt:operator=odpt.Operator:JR-East&acl:consumerKey=${API_KEY}`);
      if (!res.ok) throw new Error('Failed to fetch train data');
      const trains = await res.json();

      // Update summaries (always global, no route selection)
      const activeRailways = new Set(trains.map(t => t['odpt:railway']));
      const totalRailways = activeRailways.size;
      const delayedRailways = new Set(trains.filter(t => t['odpt:delay'] > 0).map(t => t['odpt:railway'])).size;

      summaryTotalEl.querySelector('div:last-child')?.textContent !== undefined ?
        summaryTotalEl.querySelector('div:last-child').textContent = `${totalRailways}` :
        (summaryTotalEl.querySelector('div:nth-child(1)') && (summaryTotalEl.querySelector('div:nth-child(1)').innerText = `${totalRailways}`));

      // Set delayed text (safe)
      const delayedEl = summaryDelayedEl.querySelector('div:last-child') || summaryDelayedEl.querySelector('div:nth-child(2)');
      if (delayedEl) delayedEl.textContent = `${delayedRailways} / ${totalRailways}`;

      // clear markers
      trainMarkers.forEach(m => map.removeLayer(m));
      trainMarkers = [];

      trains.forEach(train => {
        const fromSn = shortName(train['odpt:fromStation']);
        const toSn = shortName(train['odpt:toStation']);
        const from = allStations[fromSn];
        const to = allStations[toSn];
        const delayMin = Math.floor(Number(train['odpt:delay'] || 0) / 60);
        const trainNumber = shortName(train['odpt:trainNumber']);

        if (from?.geo && to?.geo) {
          const lat = (from.geo.lat + to.geo.lat) / 2;
          const lng = (from.geo.long + to.geo.long) / 2;

          const iconHtml = `<div style="text-align:center"><i class="fas fa-train" style="font-size:12px"></i><div style="font-size:9px">${trainNumber}</div></div>`;
          const markerIcon = L.divIcon({
            className: `train-marker ${delayMin>0 ? 'delayed':''}`,
            html: iconHtml,
            iconSize: [40,40],
            iconAnchor: [20,20]
          });

          const marker = L.marker([lat,lng], { icon: markerIcon }).addTo(map);
          marker.bindPopup(createPopupContent(train, from, to, delayMin));
          marker.on('click', () => showTrainDetails(train));
          trainMarkers.push(marker);
        }
      });

      // update last updated time
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      lastUpdatedHeader.textContent = timeStr;
      lastUpdatedTime.textContent = timeStr;

    } catch (e) {
      console.error('updateDashboard:', e);
      alertAreaEl.innerHTML = `<p class="text-red-500">データの取得に失敗しました: ${e.message}</p>`;
    }
  }

  function createPopupContent(train, from, to, delayMin) {
    const rail = allRailways.find(r => r['owl:sameAs'] === train['odpt:railway']);
    const railName = rail?.['odpt:railwayTitle']?.['ja'] || shortName(train['odpt:railway']);
    const dest = (train['odpt:destinationStation'] && train['odpt:destinationStation'][0]) ? allStations[shortName(train['odpt:destinationStation'][0])]?.title : '不明';
    return `
      <div style="text-align:center;font-size:14px;color:#111">
        <strong style="display:block;margin-bottom:6px">${railName}</strong>
        <div>列車番号: ${shortName(train['odpt:trainNumber'])}</div>
        <div>行先: ${dest} 行</div>
        <div style="margin-top:6px;font-weight:700;color:${delayMin>0? '#b91c1c':'#15803d'}">${delayMin>0? `${delayMin}分遅延`:'定刻'}</div>
      </div>
    `;
  }

  function showTrainDetails(train) {
    const tn = shortName(train['odpt:trainNumber']);
    const rail = allRailways.find(r => r['owl:sameAs'] === train['odpt:railway']);
    const railName = rail?.['odpt:railwayTitle']?.['ja'] || shortName(train['odpt:railway']);
    const destTitle = (train['odpt:destinationStation'] && train['odpt:destinationStation'][0]) ? allStations[shortName(train['odpt:destinationStation'][0])]?.title : '不明';
    const fromTitle = allStations[shortName(train['odpt:fromStation'])]?.title || '不明';
    const toTitle = allStations[shortName(train['odpt:toStation'])]?.title || '不明';
    const delayMin = Math.floor(Number(train['odpt:delay'] || 0) / 60);
    const status = delayMin>0 ? '遅延' : '正常';

    modalContentEl.innerHTML = `
      <div class="space-y-3">
        <p><strong>路線名:</strong> ${railName}</p>
        <p><strong>列車番号:</strong> ${tn}</p>
        <p><strong>行先:</strong> ${destTitle} 行</p>
        <p><strong>遅延度合い:</strong> <span style="color:${delayMin>0? '#b91c1c':'#15803d'}; font-weight:700">${delayMin}分</span></p>
        <p><strong>運行状況:</strong> <span style="font-weight:700">${status}</span></p>
        <p><strong>現在位置:</strong> ${fromTitle} - ${toTitle} 間</p>
      </div>
    `;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  /* ---------- Firestore: station display message (operation panel functionality kept but UI hidden) ---------- */
  async function updateStationDisplayMessage() {
    try {
      if (!auth.currentUser) return;
      const message = messageInput.value || '';
      const messageRef = doc(db, `artifacts/${appId}/public/data/station_display/main_message`);
      await setDoc(messageRef, { text: message, updatedAt: new Date().toISOString() });
      console.log('station display message updated');
    } catch (e) { console.error('updateStationDisplayMessage:', e); }
  }

  function startMessageWatch() {
    try {
      const messageRef = doc(db, `artifacts/${appId}/public/data/station_display/main_message`);
      onSnapshot(messageRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          const updatedAt = data.updatedAt ? new Date(data.updatedAt).toLocaleTimeString() : '-';
          if (statusDisplay) statusDisplay.innerHTML = `最終更新: <span id="last-updated-time">${updatedAt}</span>`;
          if (messageInput) messageInput.value = data.text || '';
        }
      });
    } catch (e) { console.warn('startMessageWatch:', e); }
  }

  /* ---------- events ---------- */
  backButton.addEventListener('click', () => {
    try { history.back(); } catch(e) { console.warn(e); }
  });

  mapStyleSelect.addEventListener('change', (e) => setMapStyle(e.target.value));
  closeModalBtn.addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); });
  modal.addEventListener('click', (ev) => { if (ev.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } });
  if (updateButton) updateButton.addEventListener('click', updateStationDisplayMessage);

  /* ---------- init ---------- */
  async function init() {
    // auth
    try {
      if (typeof __initial_auth_token !== 'undefined') {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
      userId = auth.currentUser?.uid || 'anonymous';
    } catch (e) { console.warn('auth error, continuing anonymously', e); }

    createMap();
    await Promise.all([fetchStationData(), fetchRailwayData(), fetchTimetableData()]);

    // initial draw
    await updateDashboard();
    await fetchTrainInformation();
    startMessageWatch();

    // periodic
    setInterval(() => { updateDashboard(); fetchTrainInformation(); }, 15000);
  }

  // mobile: ensure map size correct after initial layout
  window.addEventListener('resize', () => { if (map) map.invalidateSize(); });

  init();

</script>

</body>
</html>
