<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KnowL — 社内ナレッジ共有</title>

  <!-- JR東日本風スタイル（ご提供のCSSを整理） -->
  <style>
    :root{
      --jr-green: #008000;
      --light-gray: #f5f5f5;
      --dark-gray: #333;
      --border-color: #ddd;
      --font-family: 'Yu Gothic','游ゴシック','Meiryo','メイリオ',sans-serif;
      --max-width: 1200px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font-family);
      background-color:var(--light-gray);
      color:var(--dark-gray);
      font-size:16px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{
      display:flex;
      flex-direction:column;
      min-height:100vh;
      align-items:center;
    }

    /* ヘッダー */
    .header{
      background-color:var(--jr-green);
      color:white;
      width:100%;
      padding:10px 20px;
      font-weight:bold;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    .header-inner{
      max-width:var(--max-width);
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      color:white;
      text-decoration:none;
      font-size:1.15em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .logo .brand{
      font-weight:700;
    }
    .header-actions{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .header .small{
      font-size:0.9rem;
      opacity:0.9;
    }

    /* メイン */
    .main-wrapper{
      display:flex;
      flex:1;
      width:100%;
      max-width:var(--max-width);
      margin:20px;
      gap:20px;
    }

    /* サイドバー */
    .sidebar{
      background-color:white;
      width:260px;
      border:1px solid var(--border-color);
      border-radius:6px;
      padding:16px;
      box-sizing:border-box;
      min-height:120px;
    }
    .sidebar h3{
      margin:0 0 10px 0;
      color:var(--jr-green);
      border-bottom:2px solid var(--jr-green);
      padding-bottom:6px;
      font-size:1.05em;
    }
    .sidebar .searchbox{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .sidebar input[type="search"]{
      flex:1;
      padding:8px 10px;
      border:1px solid var(--border-color);
      border-radius:4px;
      font-size:0.95rem;
    }
    .sidebar button{
      background:var(--jr-green);
      color:white;
      border:none;
      padding:8px 10px;
      border-radius:4px;
      cursor:pointer;
      font-weight:600;
    }
    .sidebar .categories,
    .sidebar .tags{
      margin-top:12px;
    }
    .sidebar ul{list-style:none;padding:0;margin:0}
    .sidebar li{margin-bottom:6px}
    .cat-btn{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      text-decoration:none;
      color:var(--dark-gray);
      border-radius:4px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      width:100%;
      text-align:left;
    }
    .cat-btn.active{
      background:linear-gradient(90deg, rgba(0,128,0,0.06), rgba(0,128,0,0.02));
      border-color: rgba(0,128,0,0.12);
    }
    .tag{
      display:inline-block;
      padding:4px 8px;
      margin:4px 6px 4px 0;
      border-radius:16px;
      background:var(--light-gray);
      font-size:0.85rem;
      cursor:pointer;
    }
    .tag.active{background:var(--jr-green);color:white}

    .sidebar .back-button{
      display:block;
      background:var(--jr-green);
      color:white;
      padding:10px 15px;
      text-decoration:none;
      border-radius:5px;
      font-weight:bold;
      text-align:center;
      margin-top:14px;
      border:none;
      cursor:pointer;
    }
    .sidebar .meta{
      margin-top:10px;
      font-size:0.85rem;
      color:#666;
    }

    /* コンテンツ */
    .content{
      flex:1;
      padding:18px;
      background-color:white;
      border:1px solid var(--border-color);
      border-radius:6px;
      min-height:300px;
    }
    .breadcrumb{
      margin-bottom:12px;
      font-size:0.9em;
      color:#555;
    }
    .breadcrumb a{color:var(--jr-green);text-decoration:none}
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .controls .count{
      color:#666;
      font-size:0.95rem;
    }
    .article-list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
    }
    .card{
      border:1px solid var(--border-color);
      padding:12px;
      border-radius:6px;
      background:linear-gradient(180deg, #fff, #fbfbfb);
      cursor:pointer;
      transition:box-shadow .12s ease, transform .08s ease;
    }
    .card:hover{box-shadow:0 6px 18px rgba(0,0,0,0.06); transform:translateY(-2px)}
    .card h3{margin:0 0 6px 0; color:var(--jr-green); font-size:1.02rem}
    .card p{margin:0 0 8px 0; color:#444; line-height:1.6; font-size:0.95rem; max-height:4.5em; overflow:hidden}
    .meta-row{display:flex; gap:10px; align-items:center; font-size:0.85rem; color:#666}
    .meta-row .tag-inline{background:var(--light-gray); padding:3px 8px; border-radius:12px; font-size:0.8rem}
    .article-full{
      display:none;
      padding:12px;
      border-radius:6px;
      border:1px solid var(--border-color);
      margin-top:12px;
      background:#fff;
    }
    .article-full h1{margin-top:0; color:var(--jr-green)}
    .article-full .content-body{line-height:1.9; color:#333}
    .article-full pre{background:#f0f0f0;padding:12px;border-radius:6px;overflow:auto}
    .article-full .close-btn{
      display:inline-block;padding:6px 10px;border-radius:5px;border:1px solid var(--border-color);cursor:pointer;background:#fff;margin-top:12px;
    }

    /* モーダル（記事詳細） */
    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:60;padding:20px;
    }
    .modal .dialog{
      width:100%;max-width:900px;background:white;border-radius:8px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.25);max-height:90vh;overflow:auto;
    }
    .modal .dialog header{display:flex;align-items:center;gap:12px}
    .modal .dialog header h2{margin:0;color:var(--jr-green)}
    .modal .dialog .body{margin-top:12px;color:#222;line-height:1.85}
    .modal .dialog .footer{margin-top:14px;display:flex;justify-content:flex-end;gap:8px}

    /* フッター */
    .footer{
      text-align:center;
      padding:12px;
      background-color:#e0e0e0;
      font-size:0.9em;
      width:100%;
      border-top:1px solid var(--border-color);
      margin-top:20px;
    }

    /* レスポンシブ */
    @media (max-width: 1000px){
      .article-list{grid-template-columns: repeat(1, minmax(0,1fr))}
      .sidebar{width:220px}
    }
    @media (max-width: 768px){
      .main-wrapper{flex-direction:column; margin:12px}
      .sidebar{width:100%; border-bottom:1px solid var(--border-color)}
      .content{width:100%}
      .header-inner{gap:8px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header" role="banner">
      <div class="header-inner">
        <a class="logo" href="https://tayunet-traininfo.com/" target="_blank" rel="noopener">
          <svg width="28" height="20" viewBox="0 0 28 20" xmlns="http://www.w3.org/2000/svg" aria-hidden>
            <rect width="28" height="20" rx="3" fill="#fff"/>
            <rect x="2" y="3" width="24" height="14" rx="2" fill="#006934"/>
          </svg>
          <span class="brand">KnowL</span>
          <span class="small">社内ナレッジ共有</span>
        </a>

        <div class="header-actions">
          <div class="small">場所: JRE業務 / KnowL</div>
        </div>
      </div>
    </header>

    <main class="main-wrapper" role="main">
      <aside class="sidebar" aria-label="サイドメニュー">
        <h3>検索</h3>
        <div class="searchbox">
          <input id="globalSearch" type="search" placeholder="キーワード検索（タイトル・本文・タグ）" aria-label="検索">
          <button id="searchBtn">検索</button>
        </div>

        <div class="categories">
          <h3>カテゴリ</h3>
          <ul id="categoryList">
            <!-- カテゴリボタン挿入 -->
            <li><button class="cat-btn active" data-cat="all">すべて</button></li>
          </ul>
        </div>

        <div class="tags" aria-live="polite">
          <h3>タグ</h3>
          <div id="tagCloud" style="margin-top:6px">
            <!-- タグ挿入 -->
          </div>
        </div>

        <button class="back-button" id="reloadBtn">データ再読み込み</button>

        <div class="meta">
          <div>データ: <code>data.json</code></div>
          <div style="margin-top:6px">更新日時: <span id="lastLoaded">-</span></div>
        </div>
      </aside>

      <section class="content" id="contentArea">
        <div class="breadcrumb" id="breadcrumb">Home / KnowL</div>

        <div class="controls">
          <div class="count" id="resultCount">記事: 0</div>
          <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
            <label style="font-size:0.9rem;color:#666">並び替え</label>
            <select id="sortSelect" aria-label="並び替え">
              <option value="new">更新順（新しい）</option>
              <option value="old">更新順（古い）</option>
              <option value="title">タイトル順</option>
            </select>
          </div>
        </div>

        <div id="articleList" class="article-list" aria-live="polite">
          <!-- 記事カード -->
        </div>

        <div class="article-full" id="articleFull" aria-hidden="true">
          <!-- 展開表示（小画面用） -->
        </div>
      </section>
    </main>

    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="dialog" role="document">
        <header>
          <h2 id="modalTitle">タイトル</h2>
          <div style="margin-left:auto;color:#666" id="modalMeta"></div>
        </header>
        <div class="body" id="modalBody"></div>
        <div class="footer">
          <button id="modalClose" class="close-btn">閉じる</button>
        </div>
      </div>
    </div>

    <footer class="footer" role="contentinfo">
      &copy; <span id="year"></span> Tayutayu — KnowL
    </footer>
  </div>

  <!-- JavaScript: JSON読み込み・描画・検索・フィルタ -->
  <script>
    // 基本設定
    const DATA_PATH = './data.json'; // 必ず同階層に data.json を配置
    let allData = [];
    let filtered = [];
    let currentCategory = 'all';
    let activeTags = new Set();

    // Helper: フェッチしてJSONを返す（エラー時はサンプルデータを使う）
    async function fetchData(){
      try {
        const res = await fetch(DATA_PATH + '?t=' + Date.now());
        if(!res.ok) throw new Error('fetch failed');
        const json = await res.json();
        document.getElementById('lastLoaded').textContent = new Date().toLocaleString();
        return json;
      } catch (e){
        console.warn('data.json読み込み失敗:', e);
        // フォールバック用サンプル
        const sample = [
          {
            "id": 1,
            "title": "システムA 操作手順（サンプル）",
            "category": "システム",
            "tags": ["操作","マニュアル"],
            "content": "システムAのログインから操作までの手順をここに記述します。\n\n- Step 1: ログイン\n- Step 2: メニュー選択\n\n詳細は該当部署へお問い合わせください。",
            "last_update": "2025-08-12"
          },
          {
            "id": 2,
            "title": "トラブルB 対応フロー",
            "category": "トラブルシュート",
            "tags": ["障害","対応"],
            "content": "トラブルBが発生した際の一次対応手順をまとめます。\n\n1. 影響範囲の確認\n2. ログの収集\n3. エスカレーション",
            "last_update": "2025-08-10"
          }
        ];
        document.getElementById('lastLoaded').textContent = '（サンプル） ' + new Date().toLocaleString();
        return sample;
      }
    }

    // 描画系
    function renderCategories(data){
      const cats = ['all', ...Array.from(new Set(data.map(d => d.category))).sort()];
      const ul = document.getElementById('categoryList');
      ul.innerHTML = '';
      cats.forEach(cat => {
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.className = 'cat-btn' + (cat==='all' ? ' active' : '');
        btn.dataset.cat = cat;
        btn.textContent = (cat==='all' ? 'すべて' : cat);
        // カウント
        const count = data.filter(d => cat==='all' || d.category === cat).length;
        const span = document.createElement('span');
        span.style.opacity = '0.6';
        span.style.fontSize = '0.9rem';
        span.textContent = ' ' + count;
        btn.appendChild(span);

        btn.addEventListener('click', () => {
          document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentCategory = cat;
          applyFilters();
        });
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    function renderTags(data){
      const tagCloud = document.getElementById('tagCloud');
      const tags = {};
      data.forEach(d => (d.tags||[]).forEach(t => tags[t] = (tags[t]||0)+1));
      tagCloud.innerHTML = '';
      Object.keys(tags).sort().forEach(t => {
        const el = document.createElement('button');
        el.className = 'tag';
        el.textContent = t + ' (' + tags[t] + ')';
        el.dataset.tag = t;
        el.addEventListener('click', () => {
          if(activeTags.has(t)) { activeTags.delete(t); el.classList.remove('active'); }
          else { activeTags.add(t); el.classList.add('active'); }
          applyFilters();
        });
        tagCloud.appendChild(el);
      });
    }

    function mkExcerpt(text, max=160){
      const s = text.replace(/\n+/g,' ').trim();
      return s.length>max ? s.slice(0,max).trim() + '…' : s;
    }

    function renderArticles(list){
      const container = document.getElementById('articleList');
      container.innerHTML = '';
      if(!list.length){
        container.innerHTML = '<div style="grid-column:1/-1;color:#666;padding:18px;background:#fff;border:1px dashed var(--border-color);border-radius:6px">該当する記事が見つかりませんでした。</div>';
        document.getElementById('resultCount').textContent = '記事: 0';
        return;
      }
      document.getElementById('resultCount').textContent = '記事: ' + list.length;
      list.forEach(item => {
        const card = document.createElement('article');
        card.className = 'card';
        card.tabIndex = 0;
        const h = document.createElement('h3'); h.textContent = item.title;
        const p = document.createElement('p'); p.textContent = mkExcerpt(item.content || '');
        const metaRow = document.createElement('div'); metaRow.className='meta-row';
        const c = document.createElement('div'); c.textContent = item.category || '未分類';
        const lu = document.createElement('div'); lu.textContent = (item.last_update || '');
        lu.style.marginLeft = 'auto';
        const tagsWrap = document.createElement('div'); tagsWrap.style.display='flex'; tagsWrap.style.gap='6px';
        (item.tags || []).slice(0,3).forEach(t => {
          const ts = document.createElement('span');
          ts.className='tag-inline';
          ts.textContent = t;
          tagsWrap.appendChild(ts);
        });
        metaRow.appendChild(c);
        metaRow.appendChild(tagsWrap);
        metaRow.appendChild(lu);

        card.appendChild(h);
        card.appendChild(p);
        card.appendChild(metaRow);
        // クリックでモーダル表示
        card.addEventListener('click', () => openArticleModal(item));
        card.addEventListener('keypress', (e) => { if(e.key==='Enter') openArticleModal(item); });

        container.appendChild(card);
      });
    }

    function openArticleModal(item){
      const modal = document.getElementById('modal');
      document.getElementById('modalTitle').textContent = item.title;
      document.getElementById('modalMeta').textContent = `${item.category || ''} / ${item.last_update || ''}`;
      const body = document.getElementById('modalBody');
      // Markdown未対応: 改行を保持して表示
      body.innerHTML = '';
      const paragraphs = String(item.content || '').split(/\n{2,}/);
      paragraphs.forEach(p => {
        const div = document.createElement('div');
        // 簡易にコードブロック判定（行頭に4スペース or ` ``` ` がある場合）
        if(/^\s*```/.test(p)){
          const pre = document.createElement('pre');
          pre.textContent = p.replace(/^\s*```/,'').replace(/```$/,'');
          body.appendChild(pre);
        } else {
          const pp = document.createElement('p');
          pp.textContent = p.trim();
          body.appendChild(pp);
        }
      });
      // tags
      if(item.tags && item.tags.length){
        const twrap = document.createElement('div');
        twrap.style.marginTop='10px';
        twrap.textContent = 'タグ: ';
        item.tags.forEach(t => {
          const b = document.createElement('button');
          b.className = 'tag';
          b.style.marginLeft='6px';
          b.textContent = t;
          b.addEventListener('click', () => {
            // タグを有効化して絞り込み
            if(!activeTags.has(t)){
              activeTags.add(t);
              document.querySelectorAll('.tag').forEach(e=>{ if(e.dataset && e.dataset.tag===t) e.classList.add('active')});
            }
            applyFilters();
            closeModal();
            // スクロールトップ
            window.scrollTo({top:0, behavior:'smooth'});
          });
          twrap.appendChild(b);
        });
        body.appendChild(twrap);
      }
      // show
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      const modal = document.getElementById('modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    function applyFilters(){
      const kw = document.getElementById('globalSearch').value.trim().toLowerCase();
      filtered = allData.filter(d => {
        // category
        if(currentCategory !== 'all' && d.category !== currentCategory) return false;
        // tags
        if(activeTags.size > 0){
          const has = (d.tags || []).some(t => activeTags.has(t));
          if(!has) return false;
        }
        // keyword in title/body/tags
        if(!kw) return true;
        const hay = (d.title + ' ' + (d.content || '') + ' ' + (d.tags||[]).join(' ')).toLowerCase();
        return hay.indexOf(kw) !== -1;
      });
      sortAndRender();
      // update breadcrumbs
      const bc = document.getElementById('breadcrumb');
      bc.textContent = `Home / KnowL${currentCategory==='all' ? '' : ' / ' + currentCategory}${ activeTags.size ? ' / tags:' + Array.from(activeTags).join(',') : '' }`;
    }

    function sortAndRender(){
      const mode = document.getElementById('sortSelect').value;
      const list = [...filtered];
      list.sort((a,b) => {
        if(mode === 'new'){
          return (b.last_update || '').localeCompare(a.last_update || '');
        } else if(mode === 'old'){
          return (a.last_update || '').localeCompare(b.last_update || '');
        } else {
          return (a.title || '').localeCompare(b.title || '');
        }
      });
      renderArticles(list);
    }

    // イベント初期化
    function bindEvents(){
      document.getElementById('searchBtn').addEventListener('click', applyFilters);
      document.getElementById('globalSearch').addEventListener('keydown', (e) => { if(e.key==='Enter') applyFilters(); });
      document.getElementById('reloadBtn').addEventListener('click', init);
      document.getElementById('sortSelect').addEventListener('change', sortAndRender);
      document.getElementById('modalClose').addEventListener('click', closeModal);
      document.getElementById('modal').addEventListener('click', (e) => { if(e.target.id === 'modal') closeModal(); });
      // ESC で閉じる
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });
    }

    // 初期化
    async function init(){
      const data = await fetchData();
      // 正規化: tags を配列にし、last_updateを短く
      allData = (data || []).map(d => {
        return {
          id: d.id ?? Math.random().toString(36).slice(2,9),
          title: d.title ?? '無題',
          category: d.category ?? '未分類',
          tags: Array.isArray(d.tags) ? d.tags : (d.tags ? [d.tags] : []),
          content: d.content ?? '',
          last_update: d.last_update ?? ''
        };
      });
      // render
      renderCategories(allData);
      renderTags(allData);
      // reset filters
      currentCategory = 'all';
      activeTags = new Set();
      // clear active classes on tags
      document.querySelectorAll('.tag').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
      const allBtn = document.querySelector('.cat-btn[data-cat="all"]');
      if(allBtn) allBtn.classList.add('active');
      // set filtered and render
      filtered = [...allData];
      sortAndRender();
    }

    // 最後に実行
    document.getElementById('year').textContent = new Date().getFullYear();
    bindEvents();
    init();

  </script>
</body>
</html>
