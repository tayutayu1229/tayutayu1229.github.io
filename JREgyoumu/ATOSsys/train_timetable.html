<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【列車時刻表】</title>
    <style>
        /* CSS */
        body {
            font-family: 'ＭＳ Ｐゴシック', 'MS PGothic', sans-serif;
            background-color: #f0f0f0;
            color: #000000;
            margin: 20px;
            padding: 0;
            font-size: 16px; /* 文字を大きく */
        }

        .timetable-container {
            width: fit-content;
            min-width: 750px; /* 最小幅を少し広げる */
            margin: 0 auto;
            background-color: #ffffff;
            border: 2px solid #000000;
            padding: 5px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        h2 {
            font-size: 20px; /* 少し大きく */
            text-align: left;
            margin: 0;
            padding: 5px 0 5px 5px;
            border-bottom: 1px solid #000000;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 14px; /* 少し大きく */
            margin-bottom: 5px;
            padding: 0 5px;
        }
        /* 【修正点】ヘッダー情報の枠線を削除 */
        .header-top .left-info,
        .header-top .right-info {
            border: none; 
            padding: 2px 5px;
            background-color: transparent;
        }
        .header-top .right-info {
            text-align: right;
        }

        /* --- 全てのテーブルセルの基本スタイル --- */
        .info-table, .main-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-bottom: 10px;
        }

        .info-table th, .info-table td, .main-table th, .main-table td {
            border: 1px solid #000000;
            padding: 3px 5px;
            vertical-align: middle;
            height: 24px; /* セルの高さを少し増やす */
            box-sizing: border-box;
            font-size: 16px; /* 文字サイズを統一 */
        }
        
        /* --- 情報テーブルのスタイル --- */
        .info-table th {
            background-color: #AFCBEB; /* 水色系 */
            width: 120px;
            text-align: center;
        }
        .info-table td {
            text-align: left;
        }
        
        /* --- メイン時刻表のスタイル --- */
        .main-table thead th {
            background-color: #AFCBEB; /* 水色系 */
            text-align: center;
            vertical-align: middle;
            font-weight: normal;
        }
        
        /* 線区名セル (縦結合を含む) */
        .main-table .line-name {
            width: 100px;
            text-align: center;
            vertical-align: middle !important; 
        }
        
        .main-table .station-name {
            width: 120px;
        }
        
        /* 時刻表示セル */
        .main-table .time-col {
            width: 100px;
            text-align: center;
            font-weight: bold; /* 時刻を目立たせる */
            padding-top: 5px;
            padding-bottom: 0;
        }
        
        /* 着発線表示セル */
        .main-table .track-col-display {
            width: 100px;
            text-align: center;
            font-size: 12px; /* 着発線は小さく */
            height: 18px; /* 高さを小さく */
            padding-top: 0;
            padding-bottom: 5px;
            vertical-align: top;
        }
        
        /* 罫線調整: 着発線セルは罫線を薄くするか、上/下罫線を消す（ここでは上罫線を消すことで、時刻と着発線が一体に見えるようにする） */
        .main-table .track-col-display {
            border-top: none; 
        }
        /* ただし、時刻表のヘッダー直後の最初の着発線行は罫線が必要なので例外処理 */
        .main-table tbody tr:first-child + tr .track-col-display {
             /* 実際には、時刻行と着発線行が交互に続くため、CSSでの制御は複雑。
                HTML構造で時刻と着発線を別々の<tr>に配置することで、見やすくする。 */
        }
        
        /* 特殊文字のスタイル調整 */
        .special-time {
            font-size: 16px;
            font-weight: bold;
            display: block;
            line-height: 1;
        }
        
        /* 元々の着発線列は非表示を継続 */
        .main-table .track-col {
            display: none;
        }
    </style>
</head>
<body>

    <div class="timetable-container">
        <div class="header-top">
            <div class="left-info">1 / 1</div>
            <div class="right-info">
                作成日時：<span id="created-date"></span><br>
                出力箇所：東海道貨物指令
            </div>
        </div>

        <h2>【列車時刻表】</h2>
        
        <table class="info-table" id="info-table">
            <tbody>
                <tr>
                    <th style="width: 120px;">列車番号</th>
                    <td id="train-number-val" colspan="3">―</td>
                </tr>
                <tr>
                    <th>列車種別</th>
                    <td id="type-val">―</td>
                    <td colspan="2" rowspan="2" id="name-val-combined">―</td> 
                </tr>
                <tr>
                    <th>速度種別</th>
                    <td id="speed-val">―</td>
                </tr>
                <tr>
                    <th>列車名</th>
                    <td id="name-val" colspan="3">―</td>
                </tr>
                <tr>
                    <th>始発〜終着</th>
                    <td id="route-val" colspan="3">―</td>
                </tr>
                <tr>
                    <th>旅客案内区間</th>
                    <td id="travel-section-val" colspan="3">―</td>
                </tr>
                <tr>
                    <th>始発日付</th>
                    <td id="start-date-val" colspan="3">―</td>
                </tr>
            </tbody>
        </table>
        
        
        <table class="main-table" id="main-timetable">
            <thead>
                <tr>
                    <th class="line-name" rowspan="2">線区</th>
                    <th class="station-name" rowspan="2">駅</th>
                    <th class="time-col" colspan="2">着時刻</th>
                    <th class="time-col" colspan="2">発時刻</th>
                </tr>
                <tr>
                    <th class="track-col-display">番線/着発線</th>
                    <th class="track-col-display">番線/着発線</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

    </div>

    <script>
        // JavaScript
        document.addEventListener('DOMContentLoaded', () => {
            const timetableBody = document.querySelector('#main-timetable tbody');
            const selectedDataString = sessionStorage.getItem('selectedTrainData');

            // 作成日時
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('created-date').textContent = `${year}年${month}月${day}日 ${hours}時${minutes}分`;

            if (!selectedDataString) {
                timetableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">データがありません。列車選択画面からアクセスしてください。</td></tr>';
                return;
            }

            let allTrainData;
            try {
                allTrainData = JSON.parse(selectedDataString);
            } catch (e) {
                timetableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">データの解析に失敗しました。</td></tr>';
                return;
            }

            if (allTrainData.length === 0) {
                 timetableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: red;">選択された列車データが空です。</td></tr>';
                return;
            }

            // 列車基本情報の表示
            const targetTrainData = allTrainData[0];
            let trainType = targetTrainData.type || '';
            if (trainType === "選択なし") { trainType = ""; }

            document.getElementById('train-number-val').textContent = targetTrainData.trainNumber || '―';
            document.getElementById('type-val').textContent = trainType || '―';
            document.getElementById('speed-val').textContent = targetTrainData.speed || '―';
            // 速度種別と列車種別を分けたため、列車名の行を分ける
            document.getElementById('name-val').textContent = targetTrainData.name || '―';
            document.getElementById('route-val').textContent = `${targetTrainData.origin || '―'} 〜 ${targetTrainData.destination || '―'}`;
            document.getElementById('travel-section-val').textContent = `${targetTrainData.origin || '―'} 〜 ${targetTrainData.destination || '―'}`; 
            document.getElementById('start-date-val').textContent = targetTrainData.startDate || '―';


            // **********************************
            // 時刻表の詳細表示と重複駅/線区処理
            // **********************************
            
            let allStops = [];
            let previousStationName = null;

            // 駅の重複排除ロジック (前回の修正を維持)
            allTrainData.forEach((segment, segmentIndex) => {
                segment.stops.forEach((stop, stopIndex) => {
                    // セグメントの継ぎ目で駅が重複しているかチェック
                    const isDuplicate = (segmentIndex > 0 && stopIndex === 0 && stop.station === previousStationName);

                    if (!isDuplicate) {
                         allStops.push({
                            line: segment.line, // 線区名
                            segmentIndex: segmentIndex, // どのセグメントに属するか
                            ...stop
                        });
                    }
                    previousStationName = stop.station;
                });
            });

            // 線区の縦結合と表示
            let i = 0;
            while (i < allStops.length) {
                const currentLine = allStops[i].line;
                const currentSegmentIndex = allStops[i].segmentIndex;
                let j = i;
                
                // 同じ線区が続く限り、jを進める
                while (j < allStops.length && allStops[j].line === currentLine && allStops[j].segmentIndex === currentSegmentIndex) {
                    j++;
                }

                const segmentLength = j - i; 
                // 各駅で時刻行と着発線行の2行を使用するため、rowSpanは segmentLength * 2
                const lineRowSpan = segmentLength * 2; 

                for (let k = i; k < j; k++) {
                    const stop = allStops[k];
                    
                    // --- 1. 時刻行 (<tr>) の作成 ---
                    const timeRow = timetableBody.insertRow();
                    
                    // 線区名セル (2駅分 * 2行 = 4行結合)
                    if (k === i) {
                        const lineCell = timeRow.insertCell();
                        lineCell.className = 'line-name';
                        lineCell.rowSpan = lineRowSpan;
                        // line-name CSSで縦方向中央揃えを実現
                        lineCell.textContent = currentLine || '―';
                    }

                    // 駅名セル (2行結合)
                    const stationCell = timeRow.insertCell();
                    stationCell.className = 'station-name';
                    stationCell.rowSpan = 2; // 時刻行と着発線行を結合
                    stationCell.textContent = stop.station || '―';
                    
                    // 着時刻セル (時刻のみ)
                    const arrivalTimeCell = timeRow.insertCell();
                    arrivalTimeCell.className = 'time-col';
                    arrivalTimeCell.textContent = (stop.arrival === "||" || stop.arrival === "...") ? stop.arrival : (stop.arrival === "=" ? "" : stop.arrival || '―');
                    
                    // 着発線（着）セル (時刻行側は空)
                    timeRow.insertCell().className = 'time-col';

                    // 発時刻セル (時刻のみ)
                    const departureTimeCell = timeRow.insertCell();
                    departureTimeCell.className = 'time-col';
                    departureTimeCell.textContent = (stop.departure === "||" || stop.departure === "...") ? stop.departure : (stop.departure === "=" ? "=" : stop.departure || '―');
                    
                    // 着発線（発）セル (時刻行側は空)
                    timeRow.insertCell().className = 'time-col';


                    // --- 2. 着発線行 (<tr>) の作成 ---
                    const trackRow = timetableBody.insertRow();
                    
                    // 着発線（着）セル
                    const arrivalTrackCell = trackRow.insertCell();
                    arrivalTrackCell.className = 'track-col-display';
                    // 時刻が非停車または終着でなければ着発線を表示
                    if (stop.arrival !== "||" && stop.arrival !== "..." && stop.arrival !== "=") {
                       arrivalTrackCell.textContent = stop.trackN || '―';
                    }
                    
                    // 時刻行側の着発線セル (未使用)
                    trackRow.insertCell().className = 'track-col-display';

                    // 着発線（発）セル
                    const departureTrackCell = trackRow.insertCell();
                    departureTrackCell.className = 'track-col-display';
                    // 時刻が非停車または始発でなければ着発線を表示
                     if (stop.departure !== "||" && stop.departure !== "..." && stop.departure !== "=") {
                        departureTrackCell.textContent = stop.trackN || '―';
                    }
                    
                    // 時刻行側の着発線セル (未使用)
                    trackRow.insertCell().className = 'track-col-display';
                }
                i = j;
            }
        });
    </script>
</body>
</html>
