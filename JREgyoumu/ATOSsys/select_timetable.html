<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【列車時刻表選択画面】</title>
    <style>
        /* CSS */
        body {
            font-family: 'ＭＳ Ｐゴシック', 'MS PGothic', sans-serif;
            background-color: #f0f0f0;
            color: #000000;
            margin: 20px;
            padding: 0;
            font-size: 14px;
        }

        .container {
            width: 80%;
            margin: 0 auto;
            background-color: #ffffff;
            border: 1px solid #000000;
            padding: 15px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        h2 {
            font-size: 18px;
            text-align: center;
            margin-top: 0;
            border-bottom: 2px solid #000000;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        /* 検索フォームのスタイル */
        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }

        .search-form label {
            font-weight: bold;
            white-space: nowrap;
        }

        .search-form input[type="text"] {
            padding: 5px;
            border: 1px solid #000000;
            font-family: 'ＭＳ Ｐゴシック', 'MS PGothic', sans-serif;
        }

        .search-form button {
            padding: 5px 15px;
            background-color: #e0e0e0;
            border: 1px solid #000000;
            cursor: pointer;
            font-family: 'ＭＳ Ｐゴシック', 'MS PGothic', sans-serif;
        }
        .search-form button:hover {
            background-color: #d0d0d0;
        }

        .select-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .select-table th, .select-table td {
            border: 1px solid #000000;
            padding: 5px;
            text-align: left;
        }

        .select-table th {
            background-color: #e0e0e0;
            text-align: center;
        }

        .select-table tbody tr {
            cursor: pointer;
        }

        .select-table tbody tr:hover {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>【列車時刻表 選択】</h2>
        
        <div class="search-form">
            <label for="search-date">施行日：</label>
            <input type="text" id="search-date" placeholder="例: 2025/03/15">
            
            <label for="search-number">列車番号：</label>
            <input type="text" id="search-number" placeholder="例: 回3174M">
            
            <button id="search-button">検索</button>
            <button id="reset-button">リセット</button>
        </div>

        <table class="select-table" id="timetable-list">
            <thead>
                <tr>
                    <th style="width: 15%;">施行日</th>
                    <th style="width: 10%;">列車種別</th>
                    <th style="width: 15%;">列車番号</th>
                    <th style="width: 50%;">区間（始発〜終着）</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        // JavaScript
        document.addEventListener('DOMContentLoaded', () => {
            const JSON_PATH = '../../T-time/timetables.json'; 
            const listBody = document.querySelector('#timetable-list tbody');
            const searchDateInput = document.getElementById('search-date');
            const searchNumberInput = document.getElementById('search-number');
            const searchButton = document.getElementById('search-button');
            const resetButton = document.getElementById('reset-button');
            
            let cachedAllData = []; // 読み込んだ全データを保持するキャッシュ

            // fetchでJSON_PATHからデータを取得する関数
            const loadTimetables = async () => {
                try {
                    const response = await fetch(JSON_PATH);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - JSONファイルの読み込みに失敗しました。パスを確認してください。`);
                    }
                    // データをキャッシュに保存
                    cachedAllData = await response.json();
                    renderTimetableList(cachedAllData);
                } catch (error) {
                    console.error('Error fetching the timetable data:', error);
                    listBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: red;">データの読み込みに失敗しました。JSONファイルが存在するか、パスが正しいか確認してください。</td></tr>';
                    cachedAllData = [];
                }
            };
            
            // フィルタリングとグルーピングを行い、テーブルを描画する関数
            const renderTimetableList = (data) => {
                listBody.innerHTML = ''; // テーブルをクリア

                if (data.length === 0) {
                     listBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">該当するデータがありません。</td></tr>';
                     return;
                }
                
                // 列車を一意に識別するためのキー（施行日-列車番号-始発駅-終着駅）でデータをグループ化
                const groupedTrains = data.reduce((acc, train) => {
                    const key = `${train.startDate}-${train.trainNumber}-${train.origin}-${train.destination}`;
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(train);
                    return acc;
                }, {});

                // グループ化されたデータを一覧表に表示
                Object.keys(groupedTrains).forEach(key => {
                    const trainGroup = groupedTrains[key];
                    const representativeTrain = trainGroup[0]; 

                    const row = listBody.insertRow();
                    row.insertCell().textContent = representativeTrain.startDate || '―';
                    
                    // 列車種別: crownなし、typeのみ。"選択なし"なら空白
                    let trainType = representativeTrain.type || '';
                    if (trainType === "選択なし") {
                        trainType = "";
                    }
                    row.insertCell().textContent = trainType;
                    
                    row.insertCell().textContent = representativeTrain.trainNumber || '―';
                    
                    // 区間（始発〜終着）
                    row.insertCell().textContent = `${representativeTrain.origin || '―'} 〜 ${representativeTrain.destination || '―'}`;

                    // クリックイベントで詳細画面へ遷移
                    row.addEventListener('click', () => {
                        sessionStorage.setItem('selectedTrainData', JSON.stringify(trainGroup));
                        window.location.href = 'train_timetable.html';
                    });
                });
            };
            
            // 検索実行関数
            const applySearchFilter = () => {
                const dateFilter = searchDateInput.value.trim().toLowerCase();
                const numberFilter = searchNumberInput.value.trim().toLowerCase();
                
                // キャッシュされた全データに対してフィルタを適用
                const filteredData = cachedAllData.filter(train => {
                    let dateMatch = true;
                    let numberMatch = true;
                    
                    // 施行日の絞り込み
                    if (dateFilter) {
                        dateMatch = (train.startDate && train.startDate.toLowerCase().includes(dateFilter));
                    }
                    
                    // 列車番号の絞り込み
                    if (numberFilter) {
                        numberMatch = (train.trainNumber && train.trainNumber.toLowerCase().includes(numberFilter));
                    }
                    
                    // 両方の条件に一致する場合にtrue
                    return dateMatch && numberMatch;
                });
                
                renderTimetableList(filteredData);
            };

            // イベントリスナーの設定
            searchButton.addEventListener('click', applySearchFilter);
            
            // リセットボタンの機能
            resetButton.addEventListener('click', () => {
                searchDateInput.value = '';
                searchNumberInput.value = '';
                renderTimetableList(cachedAllData); // 全データを再描画
            });

            // 初期データのロード
            loadTimetables();
        });
    </script>
</body>
</html>
