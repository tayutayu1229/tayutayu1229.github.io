<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuBase - 文書共有システム</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* 変数定義（濃い緑ベース） */
        :root {
            --primary-color: #006400; /* 濃い深緑 */
            --primary-light: #007C00; 
            --accent-color: #FF6F00;  /* オレンジ */
            --pdf-color: #E74C3C;     /* PDF (赤) */
            --word-color: #2b5797;    /* Word (青) */
            --excel-color: #1e7145;   /* Excel (深緑) */
            --background-color: #F8F8F8;
            --card-background: #ffffff;
            --text-color: #333;
            --meta-color: #666;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.1);
            
            --admin-bg-color: #fff3cd;      
            --admin-border-color: #ffeeba;  
            --admin-text-color: #856404;    
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px 10px; 
            min-height: 100vh;
        }
        
        /* 基本レイアウト */
        .header-container { max-width: 1200px; margin: 0 auto 30px; padding-bottom: 10px; border-bottom: 3px solid var(--primary-color); display: flex; align-items: center; flex-wrap: wrap; }
        .back-button { background: var(--primary-color); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-right: 10px; transition: background-color 0.2s; }
        .back-button:hover { background-color: var(--primary-light); }
        .header-title-area { flex-grow: 1; min-width: 200px; }
        .header-title-area h1 { color: var(--primary-color); font-weight: 600; font-size: 2em; margin: 0; }
        .header-title-area h1 i { margin-right: 10px; }
        .filter-nav { max-width: 1200px; margin: 0 auto 20px; display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-nav button { background: none; border: 1px solid var(--primary-color); border-radius: 20px; padding: 6px 12px; font-size: 0.85em; cursor: pointer; color: var(--primary-color); transition: all 0.2s; }
        .filter-nav button.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .content-section { max-width: 1200px; margin: 0 auto; padding-top: 10px; }
        .control-area { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 15px; gap: 10px; }
        .search-sort-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .search-sort-group input, .search-sort-group select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; }
        #bulkDownload { background-color: var(--accent-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        
        /* 日付フィルタエリア */
        .date-filter-area { padding: 15px; background-color: #f0f0f0; border-radius: 8px; display: flex; gap: 10px; align-items: center; border: 1px solid #ccc; flex-wrap: wrap; margin-bottom: 20px; }
        .date-filter-area label { font-weight: 600; color: var(--text-color); white-space: nowrap; font-size: 0.9em; }
        .date-filter-area input[type="date"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; flex-grow: 1; min-width: 120px; }
        .date-filter-button, .clear-button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9em; }
        .date-filter-button { background-color: var(--accent-color); color: white; }
        .clear-button { background-color: #ddd; color: var(--text-color); }

        .layout-switcher { display: flex; gap: 5px; }
        .layout-switcher button { background: none; border: 1px solid #ccc; color: #666; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .layout-switcher button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* ファイルグリッドの基本設定 */
        .file-grid { margin-top: 15px; gap: 20px; display: grid; }
        .file-card {
            background: var(--card-background);
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #eee;
            position: relative;
        }
        .file-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); border-color: var(--primary-color); }
        .file-card a { text-decoration: none; color: inherit; display: block; }
        .card-info { 
            padding: 15px;
            position: relative; /* チェックボックスとアクションボタンの基点 */
        }
        
        /* --- プレビューエリア --- */
        .card-preview { position: relative; height: 160px; overflow: hidden; } 
        .card-preview img { width: 100%; height: 100%; object-fit: cover; }
        .card-preview .no-image { 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; height: 100%; background-color: #e0e0e0; 
            color: var(--primary-color); 
            font-size: 1.1em;
        }
        .card-preview .no-image i { font-size: 2em; margin-bottom: 10px; }
        
        /* ファイルアイコン (PDF, Wordなどの角丸ラベル) */
        .file-icon { position: absolute; top: 10px; right: 10px; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; z-index: 10;}
        .file-icon i { margin-right: 5px; }
        .pdf-type { background-color: var(--pdf-color); }
        .image-type { background-color: var(--primary-color); }
        .word-type { background-color: var(--word-color); }
        .excel-type { background-color: var(--excel-color); }
        .other-type { background-color: var(--meta-color); }

        .card-info h2 { font-size: 1.1em; margin-top: 0; margin-bottom: 8px; color: var(--text-color); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* --- メタデータ表示の強化 (カード表示用) --- */
        .metadata-detail {
            font-size: 0.85em;
            color: var(--meta-color);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }
        .metadata-detail div {
            margin-bottom: 5px;
            display: flex;
            align-items: flex-start;
        }
        .metadata-detail strong {
            color: var(--text-color);
            width: 50px;
            font-weight: 600;
            flex-shrink: 0;
            margin-right: 10px;
        }
        .metadata-detail span {
            flex-grow: 1;
            line-height: 1.4;
        }


        /* --- カスタムチェックボックスとアクションボタン --- */
        .select-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            opacity: 0; /* 標準のチェックボックスを隠す */
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .select-checkbox + label {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 9;
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 4px; /* 四角だが角を丸く */
            background: #fff;
            transition: all 0.2s;
            cursor: pointer;
        }
        .select-checkbox:checked + label {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
        }
        .select-checkbox:checked + label::after {
            content: "\f00c"; /* Font Awesomeのチェックマーク */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 12px;
            color: white;
            position: absolute;
            top: 2px;
            left: 3px;
        }
        .card-actions {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 5;
        }
        .action-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s;
            margin-left: 5px;
        }
        .action-btn:hover {
            background-color: var(--primary-light);
        }

        
        /* 1. カード表示 (初期/正方形) */
        .file-grid.grid-cards { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); grid-auto-rows: min-content; }
        
        /* 2. リスト表示 */
        .file-grid.grid-list { grid-template-columns: 1fr; gap: 10px; }
        .file-grid.grid-list .file-card { display: flex; align-items: center; padding: 10px; height: auto; position: relative; }
        .file-grid.grid-list .card-preview { height: 50px; width: 50px; flex-shrink: 0; border-radius: 4px; margin: 0 15px 0 30px; }
        .file-grid.grid-list .card-info { padding: 0; flex-grow: 1; display: flex; justify-content: space-between; align-items: center; }
        .file-grid.grid-list .card-info h2 { width: 40%; }
        .file-grid.grid-list .metadata-detail { display: none; }
        .file-grid.grid-list .metadata { display: flex; gap: 20px; font-size: 0.9em; }
        .file-grid.grid-list .action-btn { position: static; margin-left: 10px; }
        .file-grid.grid-list .select-checkbox + label { left: 10px; }
        

        /* 3. サムネイル表示 */
        .file-grid.grid-thumb { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .file-grid.grid-thumb .file-card { height: 200px; padding: 0; display: flex; flex-direction: column; }
        .file-grid.grid-thumb .card-preview { height: 120px; }
        .file-grid.grid-thumb .card-info { padding: 8px; flex-grow: 1; }
        .file-grid.grid-thumb .card-info h2 { font-size: 0.9em; margin: 0; white-space: normal; height: 3.6em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .file-grid.grid-thumb .metadata-detail { display: none; }
        .file-grid.grid-thumb .select-checkbox + label { top: 8px; left: 8px; }
        .file-grid.grid-thumb .card-actions { bottom: 8px; right: 8px; }

        /* 4. 詳細リスト表示 */
        .file-grid.grid-detail { grid-template-columns: 1fr; gap: 1px; }
        .file-grid.grid-detail .file-card {
            display: grid; 
            grid-template-columns: 30px 1fr 150px 60px; /* Checkbox, Info(Title), Meta, Actions */
            align-items: center;
            border-radius: 0;
            border-left: none;
            border-right: none;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
            box-shadow: none;
            overflow: visible;
        }
        .file-grid.grid-detail .card-preview, .file-grid.grid-detail .file-icon, .file-grid.grid-detail .metadata-detail { display: none; }
        .file-grid.grid-detail .select-checkbox + label { position: static; margin: auto; }
        .file-grid.grid-detail .card-info { padding: 0 15px; margin: auto 0; }
        .file-grid.grid-detail .card-info h2 { margin: 0; }
        .file-grid.grid-detail .metadata { display: flex; gap: 20px; font-size: 0.9em; color: var(--meta-color); }
        .file-grid.grid-detail .card-actions { position: static; margin: auto; }


        /* --- 管理者エリアのCSS --- */
        #admin-section {
            background-color: var(--admin-bg-color);
            border: 1px solid var(--admin-border-color);
            padding: 20px;
            border-radius: 8px;
            color: var(--admin-text-color);
            margin-top: 20px;
        }
        #admin-section h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        #admin-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: var(--text-color);
        }
        #admin-section p, #admin-section ul {
            font-size: 0.95em;
            line-height: 1.6;
        }
        #admin-section a {
            color: var(--accent-color);
            text-decoration: underline;
        }

        /* --- ローディングオーバーレイの修正 --- */
        #loading-overlay {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden { display: none !important; }

        /* モーダルCSS (閉じるボタンの位置修正済み) */
        .modal {
            display: none; 
            position: fixed;
            z-index: 200;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 1200px;
            text-align: center;
        }
        .modal-content img, .modal-content iframe {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .modal-caption {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            text-align: center;
            color: #ccc;
            padding: 10px 0;
            height: 150px;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px; 
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }
        .modal-close:hover, .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: var(--primary-color);">データを読み込み中...</p>
    </div>

    <div id="fileModal" class="modal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <div id="modal-body"></div>
        </div>
        <div id="modal-caption" class="modal-caption"></div>
    </div>

    <header class="header-container">
        <button class="back-button" onclick="history.back()"><i class="fas fa-arrow-left"></i> 戻る</button>
        <div class="header-title-area">
            <h1><i class="fas fa-database"></i>DocuBase</h1> 
        </div>
    </header>

    <nav class="filter-nav main-nav">
        <button data-target="file-list" class="active">ファイルリスト</button>
        <button data-target="admin-area">管理</button>
    </nav>
    
    <div id="file-list" class="content-section">

        <div class="control-area">
            <div class="search-sort-group">
                <input type="text" id="searchInput" placeholder="ファイル名、タグを検索..." onkeyup="applyMasterFilter()">
                <select id="sortSelect" onchange="applyMasterFilter()">
                    <option value="date_desc">日付順 (新)</option>
                    <option value="date_asc">日付順 (古)</option>
                    <option value="name_asc">ファイル名順 (昇)</option>
                    <option value="size_desc">サイズ順 (大)</option>
                </select>
                <div class="layout-switcher">
                    <button class="layout-btn active" data-layout="grid-cards" title="カード表示"><i class="fas fa-th-large"></i></button>
                    <button class="layout-btn" data-layout="grid-list" title="リスト表示"><i class="fas fa-list"></i></button>
                    <button class="layout-btn" data-layout="grid-thumb" title="サムネイル表示"><i class="fas fa-grip-horizontal"></i></button>
                    <button class="layout-btn" data-layout="grid-detail" title="詳細表示"><i class="fas fa-list-alt"></i></button>
                </div>
            </div>
            <button id="bulkDownload"><i class="fas fa-download"></i> 選択ファイルをダウンロード</button>
        </div>
        
        <div class="date-filter-area">
            <label for="startDate">期間フィルタ (AND):</label>
            <input type="date" id="startDate">
            <label for="endDate">～</label>
            <input type="date" id="endDate">
            <button id="applyDateFilter" class="date-filter-button"><i class="fas fa-search"></i> 絞り込み</button>
            <button id="clearDateFilter" class="clear-button"><i class="fas fa-times"></i> クリア</button>
        </div>

        <nav class="filter-nav tag-nav">
            <button data-filter="all" class="active">すべて</button>
            </nav>
        
        <main id="fileGrid" class="file-grid grid-cards"> 
            </main>
    </div>

    <div id="admin-area" class="content-section hidden">
        <section id="admin-section">
            <h2><i class="fas fa-cogs"></i> 管理者向け情報</h2>
            <div id="admin-stats"></div>
            <p>ファイルを追加・更新・削除する場合は、**`data.json`** ファイルを直接編集してください。このページは、そのJSONファイルに基づいて自動生成されています。</p>
            <ul>
                <li>**新しいファイル追加の手順:**
                    <ol>
                        <li>PDFは`pdfs/`に、画像は`images/`に、プレビュー画像は`previews/`に格納してください。</li>
                        <li>**`data.json`** を開き、新しいファイルのエントリを**日付、サイズ、タイプ**を含めて追加します。</li>
                        <li>ブラウザを再読み込みすると、新しいファイルが表示されます。</li>
                    </ol>
                </li>
                <li>**データファイル:** <a href="data.json" target="_blank">data.json を確認</a></li>
            </ul>
        </section>
    </div>

    <script>
        // 設定定数と要素
        const tagMap = {
            'all': 'すべて', 'pdf': 'PDF文書', 'image': '画像ファイル', 
            'manual': 'マニュアル', 'report': 'レポート', 'other': 'その他',
            'word': 'Word文書', 'excel': 'Excel文書' 
        };
        const typeMap = {
            'pdf': { icon: 'fa-file-pdf', folder: 'pdfs/' },
            'image': { icon: 'fa-image', folder: 'images/' },
            'word': { icon: 'fa-file-word', folder: 'documents/' },
            'excel': { icon: 'fa-file-excel', folder: 'documents/' },
            'other': { icon: 'fa-file', folder: 'documents/' }
        };

        const fileGrid = document.getElementById('fileGrid');
        const tagNav = document.querySelector('.tag-nav');
        const loadingOverlay = document.getElementById('loading-overlay');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const sortSelect = document.getElementById('sortSelect');
        const searchInput = document.getElementById('searchInput');
        const layoutButtons = document.querySelectorAll('.layout-btn');
        const bulkDownloadButton = document.getElementById('bulkDownload');
        const fileModal = document.getElementById('fileModal');
        const modalBody = document.getElementById('modal-body');
        const modalCaption = document.getElementById('modal-caption');
        
        let fileData = [];
        let currentFilterTag = 'all';
        let currentDateRange = { start: null, end: null };
        let currentLayout = 'grid-cards'; // 初期レイアウト

        // --- ヘルパー関数 ---
        const parseDate = (dateString) => {
            if (!dateString) return null;
            const parts = dateString.split('/').map(Number);
            return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
        };
        const formatSize = (kb) => {
            if (kb === undefined || kb === null || isNaN(kb) || kb === 0) return 'N/A';
            if (kb < 1024) return `${kb} KB`;
            return `${(kb / 1024).toFixed(2)} MB`;
        };
        const getFilepath = (file) => {
            const typeInfo = typeMap[file.type] || typeMap['other'];
            let folder = typeInfo.folder;
            if (file.type === 'image') {
                folder = 'images/';
            } else if (file.type === 'pdf') {
                folder = 'pdfs/';
            }
            return `${folder}${file.filename}`;
        };
        const getFileTypeClass = (type) => {
            if (type === 'pdf') return 'pdf-type';
            if (type === 'image') return 'image-type';
            if (type === 'word') return 'word-type';
            if (type === 'excel') return 'excel-type';
            return 'other-type';
        };
        const getFileIcon = (type) => {
            return typeMap[type] ? typeMap[type].icon : typeMap['other'].icon;
        };
        
        // --- タグフィルタボタンのセットアップ関数 ---
        const setupFilters = (data) => {
            const existingTags = new Set(['pdf', 'image', 'word', 'excel']);
            data.forEach(file => {
                if (file.tag) existingTags.add(file.tag);
            });
            
            tagNav.innerHTML = '';
            
            const allButton = document.createElement('button');
            allButton.setAttribute('data-filter', 'all');
            allButton.textContent = tagMap['all'];
            allButton.classList.add('active');
            tagNav.appendChild(allButton);

            existingTags.forEach(tag => {
                if (tag === 'all') return;
                const button = document.createElement('button');
                button.setAttribute('data-filter', tag);
                button.textContent = tagMap[tag] || tag.charAt(0).toUpperCase() + tag.slice(1);
                tagNav.appendChild(button);
            });

            tagNav.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentFilterTag = e.target.getAttribute('data-filter');
                    tagNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    applyMasterFilter();
                });
            });
        };


        // --- モーダル/プレビュー機能 ---
        const openModal = (file) => {
            const filePath = getFilepath(file);
            modalBody.innerHTML = '';
            modalCaption.textContent = file.title;

            if (file.type === 'image') {
                const img = document.createElement('img');
                img.src = filePath;
                modalBody.appendChild(img);
            } else if (file.type === 'pdf') {
                const iframe = document.createElement('iframe');
                iframe.src = filePath;
                iframe.style.width = '90vw';
                iframe.style.height = '90vh';
                iframe.setAttribute('frameborder', '0');
                modalBody.appendChild(iframe);
            } else {
                modalBody.innerHTML = `<p style="color:white; font-size: 1.2em; margin-top: 100px;">このファイル形式はプレビューできません。<br><a href="${filePath}" target="_blank" style="color:var(--accent-color); text-decoration: underline;">ここをクリックしてダウンロード</a>してください。</p>`;
            }
            fileModal.style.display = 'block';
        };

        const closeModal = () => {
            fileModal.style.display = 'none';
            modalBody.innerHTML = '';
        };
        window.onclick = (event) => {
            if (event.target === fileModal) {
                closeModal();
            }
        };


        // --- メインフィルタリング & ソートロジック ---
        const applyMasterFilter = () => {
            let filteredData = fileData;
            const searchTerm = searchInput.value.toLowerCase();
            const start = currentDateRange.start;
            const end = currentDateRange.end;

            filteredData = filteredData.filter(file => {
                const titleMatch = file.title.toLowerCase().includes(searchTerm);
                const tagMatch = currentFilterTag === 'all' || 
                                 (currentFilterTag === 'pdf' && file.type === 'pdf') ||
                                 (currentFilterTag === 'image' && file.type === 'image') ||
                                 (file.tag === currentFilterTag);
                
                let dateMatch = true;
                if (start || end) {
                    const fileDate = parseDate(file.date);
                    if (!fileDate) dateMatch = false;
                    else {
                        if (start) dateMatch = dateMatch && (fileDate.getTime() >= start.getTime());
                        if (end) dateMatch = dateMatch && (fileDate.getTime() <= end.getTime());
                    }
                }
                
                return titleMatch && tagMatch && dateMatch;
            });

            const sortValue = sortSelect.value;
            filteredData.sort((a, b) => {
                if (sortValue === 'date_desc') return parseDate(b.date) - parseDate(a.date);
                if (sortValue === 'date_asc') return parseDate(a.date) - parseDate(b.date);
                if (sortValue === 'name_asc') return a.title.localeCompare(b.title, 'ja');
                if (sortValue === 'size_desc') return (b.size_kb || 0) - (a.size_kb || 0);
                return 0;
            });
            
            renderFileCards(filteredData);
        };


        // --- ファイルカード生成関数 (デザイン強化) ---
        const renderFileCards = (dataToRender) => {
            fileGrid.innerHTML = ''; 
            
            // fileGridに現在のレイアウトクラスを適用
            fileGrid.className = `file-grid ${currentLayout}`; 
            
            if (dataToRender.length === 0) {
                fileGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--meta-color);">該当するファイルは見つかりませんでした。</p>';
                return;
            }
            dataToRender.forEach(file => {
                const filePath = getFilepath(file);
                const fileExtension = file.filename.split('.').pop().toUpperCase();

                const card = document.createElement('section');
                card.className = `file-card`;
                card.setAttribute('data-id', file.filename);
                card.setAttribute('data-type', file.type);
                
                // --- チェックボックス (カスタムデザイン) ---
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'select-checkbox';
                checkbox.id = `checkbox-${file.filename}`;
                checkbox.value = filePath;
                card.appendChild(checkbox);

                const checkboxLabel = document.createElement('label');
                checkboxLabel.setAttribute('for', `checkbox-${file.filename}`);
                card.appendChild(checkboxLabel);


                // --- アクションボタン (共有マーク) ---
                const actionDiv = document.createElement('div');
                actionDiv.className = 'card-actions';
                
                const shareButton = document.createElement('button');
                shareButton.className = 'action-btn';
                shareButton.title = '共有リンクをコピー';
                shareButton.innerHTML = '<i class="fas fa-share-alt"></i>';
                shareButton.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    const fullUrl = new URL(filePath, document.URL).href; 
                    navigator.clipboard.writeText(fullUrl);
                    alert('共有リンクをクリップボードにコピーしました:\n' + fullUrl);
                };
                actionDiv.appendChild(shareButton);


                // --- リンク (詳細リストではタイトルに適用するため、ここではリンク先は一旦保留)
                const link = document.createElement('a');
                link.href = filePath;
                
                // PDFと画像はモーダル表示に設定
                if (file.type === 'pdf' || file.type === 'image') {
                    link.onclick = (e) => {
                        e.preventDefault(); 
                        openModal(file);
                    };
                } else {
                    link.target = '_blank';
                }

                // --- プレビューエリア ---
                const previewDiv = document.createElement('div');
                previewDiv.className = 'card-preview';
                
                let previewPath = file.preview_path || '';
                const hasPreviewImage = previewPath.trim() !== '';
                
                if (hasPreviewImage) {
                    const img = document.createElement('img');
                    img.src = previewPath;
                    img.alt = `${file.title} プレビュー`;
                    
                    const noImageDiv = document.createElement('div');
                    noImageDiv.className = 'no-image';
                    noImageDiv.innerHTML = `<i class="fas ${getFileIcon(file.type)}"></i> プレビューなし`;

                    img.onerror = function() {
                        this.style.display = 'none';
                        noImageDiv.style.display = 'flex';
                    };
                    
                    previewDiv.appendChild(img);
                    previewDiv.appendChild(noImageDiv);
                    noImageDiv.style.display = 'none';

                } else {
                    const noImageDiv = document.createElement('div');
                    noImageDiv.className = 'no-image';
                    noImageDiv.innerHTML = `<i class="fas ${getFileIcon(file.type)}"></i> プレビューなし`;
                    previewDiv.appendChild(noImageDiv);
                }

                
                // ファイルアイコン (PDF, Wordなどのタグ)
                const iconSpan = document.createElement('span');
                iconSpan.className = `file-icon ${getFileTypeClass(file.type)}`;
                iconSpan.innerHTML = `<i class="fas ${getFileIcon(file.type)}"></i> ${fileExtension}`;
                previewDiv.appendChild(iconSpan); 

                link.appendChild(previewDiv);

                // --- 情報エリア ---
                const infoDiv = document.createElement('div');
                infoDiv.className = 'card-info';

                const titleH2 = document.createElement('h2');
                titleH2.textContent = file.title;
                
                // タイトルクリック動作の設定（詳細リストの場合）
                if (currentLayout === 'grid-detail') {
                    titleH2.style.cursor = 'pointer';
                    if (file.type === 'pdf' || file.type === 'image') {
                        titleH2.onclick = (e) => { e.preventDefault(); openModal(file); };
                    } else {
                        titleH2.onclick = () => { window.open(filePath, '_blank'); };
                    }
                }

                infoDiv.appendChild(titleH2);

                // --- メタデータ詳細（カード表示用） ---
                const metadataDetailDiv = document.createElement('div');
                metadataDetailDiv.className = 'metadata-detail';
                const displayDescription = file.description && file.description.trim() !== '' ? file.description : '説明なし';
                
                metadataDetailDiv.innerHTML = `
                    <div><strong>種別:</strong> <span>${tagMap[file.tag] || file.tag}</span></div>
                    <div><strong>サイズ:</strong> <span>${formatSize(file.size_kb)}</span></div>
                    <div><strong>日付:</strong> <span>${file.date || 'N/A'}</span></div>
                    <div><strong>説明:</strong> <span>${displayDescription}</span></div>
                `; 
                infoDiv.appendChild(metadataDetailDiv);
                
                // --- リスト/詳細表示用の簡略メタデータ ---
                const metadataDiv = document.createElement('div');
                metadataDiv.className = 'metadata';
                metadataDiv.innerHTML = `
                    <span data-label="タグ">${tagMap[file.tag] || file.tag}</span>
                    <span data-label="サイズ">${formatSize(file.size_kb)}</span>
                    <span data-label="日付">${file.date || 'N/A'}</span>
                `; 
                if (currentLayout === 'grid-list' || currentLayout === 'grid-detail') {
                    infoDiv.appendChild(metadataDiv);
                }


                if (currentLayout === 'grid-detail' || currentLayout === 'grid-list') {
                    card.appendChild(infoDiv);
                    card.appendChild(actionDiv);
                } else {
                    link.appendChild(infoDiv);
                    card.appendChild(link);
                    card.appendChild(actionDiv); // カード表示ではリンクの外に配置
                }

                fileGrid.appendChild(card);
            });
        };

        // --- レイアウト切替機能 ---
        const setupLayoutSwitcher = () => {
            layoutButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const newLayout = button.getAttribute('data-layout');
                    
                    layoutButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    currentLayout = newLayout;
                    applyMasterFilter(); 
                });
            });
        };
        
        // --- データのロード ---
        const loadFiles = async () => {
            loadingOverlay.classList.remove('hidden');
            try {
                const response = await fetch('data.json');
                if (!response.ok) throw new Error(`Failed to load data.json. Status: ${response.status}`);
                fileData = await response.json();
                
                const totalSize = fileData.reduce((sum, file) => sum + (file.size_kb || 0), 0);
                document.getElementById('admin-stats').innerHTML = `
                    <p style="font-weight: 600;">合計ファイル数: ${fileData.length} 件</p>
                    <p style="font-weight: 600;">合計ファイルサイズ: ${formatSize(totalSize)}</p>
                `;

                setupFilters(fileData);
                applyMasterFilter();
            } catch (error) {
                 console.error('Error loading file data:', error);
                 fileGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--pdf-color);">ファイルの読み込みに失敗しました。data.jsonファイルが存在するか、形式が正しいか確認してください。</p>';
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        };

        // --- その他のイベントリスナー (変更なし) ---
        document.getElementById('applyDateFilter').addEventListener('click', () => {
            const startValue = startDateInput.value ? startDateInput.value.replace(/-/g, '/') : null;
            const endValue = endDateInput.value ? endDateInput.value.replace(/-/g, '/') : null;
            currentDateRange.start = startValue ? parseDate(startValue) : null;
            currentDateRange.end = endValue ? parseDate(endValue) : null;
            if (currentDateRange.start && currentDateRange.end && currentDateRange.start.getTime() > currentDateRange.end.getTime()) {
                alert('開始日が終了日より後の日付になっています。');
                return;
            }
            applyMasterFilter();
        });

        document.getElementById('clearDateFilter').addEventListener('click', () => {
            startDateInput.value = '';
            endDateInput.value = '';
            currentDateRange = { start: null, end: null };
            applyMasterFilter();
        });
        
        document.getElementById('bulkDownload').addEventListener('click', () => {
            // カスタムチェックボックスの処理
            const selectedFiles = document.querySelectorAll('.select-checkbox:checked');
            if (selectedFiles.length === 0) {
                alert('ダウンロードするファイルを1つ以上選択してください。');
                return;
            }
            if (confirm(`${selectedFiles.length}個のファイルをダウンロードします。よろしいですか？`)) {
                selectedFiles.forEach(checkbox => {
                    window.open(checkbox.value, '_blank');
                });
            }
        });

        document.querySelectorAll('.main-nav button').forEach(button => {
            button.addEventListener('click', (e) => {
                const target = e.target.getAttribute('data-target');
                document.querySelectorAll('.main-nav button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                document.getElementById('file-list').classList.add('hidden');
                document.getElementById('admin-area').classList.add('hidden');
                
                if (target === 'file-list') {
                    document.getElementById('file-list').classList.remove('hidden');
                } else if (target === 'admin-area') {
                    document.getElementById('admin-area').classList.remove('hidden');
                }
            });
        });

        // 初期化処理
        document.addEventListener('DOMContentLoaded', () => {
            setupLayoutSwitcher();
            loadFiles();
        });
    </script>
</body>
</html>
