<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuBase - 文書共有システム</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* 変数定義（濃い緑ベース） */
        :root {
            --primary-color: #006400; /* 濃い深緑 */
            --primary-light: #007C00; 
            --accent-color: #FF6F00;  /* オレンジ */
            --pdf-color: #E74C3C;     /* 赤 */
            --background-color: #F8F8F8;
            --card-background: #ffffff;
            --text-color: #333;
            --meta-color: #666;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 30px;
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto 40px;
            padding-bottom: 10px;
            border-bottom: 3px solid var(--primary-color);
            display: flex;
            align-items: center;
        }
        .back-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 20px;
            transition: background-color 0.2s;
        }
        .back-button:hover { background-color: var(--primary-light); }
        .header-title-area { flex-grow: 1; }
        .header-title-area h1 {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 2.5em;
            margin: 0;
        }
        .header-title-area h1 i { margin-right: 15px; }

        /* ナビゲーションボタン */
        .filter-nav {
            max-width: 1200px;
            margin: 0 auto 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-nav button {
            background: none;
            border: 1px solid var(--primary-color);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9em;
            cursor: pointer;
            color: var(--primary-color);
            transition: all 0.2s;
        }
        .filter-nav button.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        .filter-nav button:not(.active):hover { background-color: #E8F5E9; }

        .content-section {
            max-width: 1200px;
            margin: 0 auto;
            padding-top: 20px;
        }
        
        /* 日付フィルタエリア */
        .date-filter-area {
            max-width: 1200px;
            margin: 10px auto 30px;
            padding: 15px;
            background-color: #f0f0f0; 
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            border: 1px solid #ccc;
            flex-wrap: wrap;
        }
        .date-filter-area label { font-weight: 600; color: var(--text-color); white-space: nowrap; }
        .date-filter-area input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; flex-grow: 1; min-width: 120px; }
        .date-filter-button, .clear-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .date-filter-button { background-color: var(--accent-color); color: white; }
        .date-filter-button:hover { background-color: #E66100; }
        .clear-button { background-color: #ddd; color: var(--text-color); }
        .clear-button:hover { background-color: #ccc; }

        /* レイアウト切替ボタンエリア */
        .layout-switcher {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            justify-content: flex-end;
        }
        .layout-switcher button {
            background: none;
            border: 1px solid #ccc;
            color: #666;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .layout-switcher button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* ファイルグリッドの基本設定 */
        .file-grid {
            margin-top: 15px;
            gap: 30px;
            display: grid;
        }
        /* ファイルカードの基本設定 */
        .file-card {
            background: var(--card-background);
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #eee;
        }
        .file-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-color);
        }
        .file-card a {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .card-info { padding: 15px; }
        
        /* プレビュー関連のCSS (重要: 確実に再統合) */
        .card-preview { 
            position: relative; 
            height: 180px; 
            overflow: hidden; 
        }
        .card-preview img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: opacity 0.3s; 
        }
        .card-preview .no-image {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background-color: #e0e0e0;
            color: var(--meta-color);
            font-size: 1.1em;
        }
        .no-image i { font-size: 2em; margin-bottom: 10px; }

        /* ファイルアイコン/タグのCSS (重要: 確実に再統合) */
        .file-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        .file-icon i { margin-right: 5px; }
        .file-icon.pdf-type { 
            background-color: var(--pdf-color); /* PDFは赤 */
        }
        .file-icon.image-type { 
            background-color: var(--primary-color); /* 画像は濃緑 */
        }

        /* カード情報 */
        .card-info h2 {
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 8px;
            color: var(--text-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .metadata {
            font-size: 0.85em;
            color: var(--meta-color);
            display: flex;
            justify-content: space-between;
        }
        .metadata span i {
            margin-right: 5px;
            color: var(--primary-color);
        }


        /* ============================================== */
        /* === 1. カード表示 (初期設定) === */
        /* ============================================== */
        .file-grid.grid-cards {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        .file-grid.grid-cards .card-preview { display: block; }
        .file-grid.grid-cards .card-info h2 { font-size: 1.1em; }
        .file-grid.grid-cards .metadata span:nth-child(2) { display: inline; }


        /* ============================================== */
        /* === 2. リスト表示 === */
        /* ============================================== */
        .file-grid.grid-list {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .file-grid.grid-list .file-card {
            display: flex;
            align-items: center;
            border-left: 5px solid var(--primary-color);
            box-shadow: none;
            border-radius: 4px;
        }
        .file-grid.grid-list .card-preview {
            width: 50px;
            height: 50px;
            margin-left: 10px;
            border-radius: 4px;
        }
        .file-grid.grid-list .card-preview .file-icon { display: none; }
        .file-grid.grid-list .card-info {
            flex-grow: 1;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-grid.grid-list .card-info h2 { font-size: 1em; margin: 0; }
        .file-grid.grid-list .metadata { margin-left: 20px; }
        .file-grid.grid-list .metadata span:nth-child(2) { display: none; } /* タグ非表示 */

        /* ============================================== */
        /* === 3. サムネイル表示 === */
        /* ============================================== */
        .file-grid.grid-thumb {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        .file-grid.grid-thumb .card-preview { height: 100px; }
        .file-grid.grid-thumb .card-info { padding: 8px 10px; }
        .file-grid.grid-thumb .card-info h2 { font-size: 0.9em; margin-bottom: 0; }
        .file-grid.grid-thumb .metadata { display: none; } /* メタデータ非表示 */
        .file-grid.grid-thumb .file-card:hover { transform: none; box-shadow: var(--shadow-light); }

        /* ============================================== */
        /* === 4. 詳細表示 === */
        /* ============================================== */
        .file-grid.grid-detail {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .file-grid.grid-detail .file-card {
            display: flex;
            align-items: flex-start;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .file-grid.grid-detail .card-preview {
            width: 120px;
            height: 100px;
            flex-shrink: 0;
            border-radius: 8px 0 0 8px;
        }
        .file-grid.grid-detail .card-preview .file-icon { top: 5px; right: 5px; font-size: 0.7em; padding: 3px 6px; }
        .file-grid.grid-detail .card-info { padding: 15px; flex-grow: 1; }
        .file-grid.grid-detail .card-info h2 { font-size: 1.2em; margin-bottom: 10px; }
        .file-grid.grid-detail .metadata { display: block; font-size: 0.9em; }
        .file-grid.grid-detail .metadata span { display: block; margin-bottom: 5px; }
        .file-grid.grid-detail .metadata span:nth-child(2) { display: block; } /* タグ表示 */

        .hidden { display: none !important; }

    </style>
</head>
<body>

    <header class="header-container">
        <button class="back-button" onclick="history.back()"><i class="fas fa-arrow-left"></i> 戻る</button>
        <div class="header-title-area">
            <h1><i class="fas fa-database"></i>DocuBase</h1> </div>
    </header>

    <nav class="filter-nav main-nav">
        <button data-target="file-list" class="active">ファイルリスト</button>
        <button data-target="admin-area">管理</button>
    </nav>
    
    <div id="file-list" class="content-section">
        
        <div class="date-filter-area">
            <label for="startDate">開始日:</label>
            <input type="date" id="startDate">
            <label for="endDate">終了日:</label>
            <input type="date" id="endDate">
            <button id="applyDateFilter" class="date-filter-button"><i class="fas fa-search"></i> 期間で絞り込み</button>
            <button id="clearDateFilter" class="clear-button"><i class="fas fa-times"></i> クリア</button>
        </div>

        <div class="layout-switcher">
            <button class="layout-btn active" data-layout="grid-cards" title="カード表示"><i class="fas fa-th-large"></i></button>
            <button class="layout-btn" data-layout="grid-list" title="リスト表示"><i class="fas fa-list"></i></button>
            <button class="layout-btn" data-layout="grid-thumb" title="サムネイル表示"><i class="fas fa-grip-horizontal"></i></button>
            <button class="layout-btn" data-layout="grid-detail" title="詳細表示"><i class="fas fa-list-alt"></i></button>
        </div>

        <nav class="filter-nav tag-nav">
            <button data-filter="all" class="active">すべて</button>
            </nav>
        
        <main id="fileGrid" class="file-grid grid-cards"> <p id="loading-message">ファイルを読み込み中です...</p>
        </main>
    </div>

    <div id="admin-area" class="content-section hidden">
        <section id="admin-section">
            <h2><i class="fas fa-cogs"></i> 管理者向け情報</h2>
            <p>ファイルを追加・更新・削除する場合は、**`data.json`** ファイルを直接編集してください。このページは、そのJSONファイルに基づいて自動生成されています。</p>
            <ul>
                <li>**新しいファイル追加の手順:**
                    <ol>
                        <li>PDFは`pdfs/`に、画像（.jpg, .pngなど）は`images/`に、PDFのプレビュー画像は`previews/`に格納してください。</li>
                        <li>**`data.json`** を開き、新しいファイルのエントリを**日付（`YYYY/MM/DD`形式）を含めて**追加します。</li>
                        <li>ブラウザを再読み込みすると、新しいファイルが表示されます。</li>
                    </ol>
                </li>
                <li>**データファイル:** <a href="data.json" target="_blank">data.json を確認</a></li>
            </ul>
        </section>
    </div>

    <script>
        // タグ名と表示名のマッピング（日本語化）
        const tagMap = {
            'all': 'すべて',
            'pdf': 'PDF文書',
            'image': '画像ファイル',
            'manual': 'マニュアル',
            'report': 'レポート',
            'other': 'その他'
        };

        document.addEventListener('DOMContentLoaded', () => {
            const fileGrid = document.getElementById('fileGrid');
            const tagNav = document.querySelector('.tag-nav');
            const loadingMessage = document.getElementById('loading-message');
            const mainNavButtons = document.querySelectorAll('.main-nav button');
            const fileListSection = document.getElementById('file-list');
            const adminAreaSection = document.getElementById('admin-area');
            
            // 日付フィルタ要素
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const applyDateFilterButton = document.getElementById('applyDateFilter');
            const clearDateFilterButton = document.getElementById('clearDateFilter');

            // レイアウト切替ボタン
            const layoutButtons = document.querySelectorAll('.layout-btn');
            
            let fileData = [];
            let currentFilterTag = 'all';
            let currentDateRange = { start: null, end: null };
            let currentLayout = 'grid-cards';

            // --- ヘルパー関数 ---
            const parseDate = (dateString) => {
                if (!dateString) return null;
                const parts = dateString.split('/').map(Number);
                return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
            };

            // --- マスターフィルタ関数 ---
            const applyMasterFilter = () => {
                let filteredData = fileData;
                
                // 1. タグフィルタの適用
                if (currentFilterTag !== 'all') {
                    filteredData = filteredData.filter(file => {
                        if (currentFilterTag === 'pdf') return file.type === 'pdf';
                        if (currentFilterTag === 'image') return file.type === 'image';
                        return file.tag === currentFilterTag;
                    });
                }
                
                // 2. 日付フィルタの適用
                const start = currentDateRange.start;
                const end = currentDateRange.end;

                if (start || end) {
                    filteredData = filteredData.filter(file => {
                        const fileDate = parseDate(file.date);
                        if (!fileDate) return false; 

                        let isAfterStart = true;
                        if (start) {
                            isAfterStart = fileDate.getTime() >= start.getTime();
                        }

                        let isBeforeEnd = true;
                        if (end) {
                            isBeforeEnd = fileDate.getTime() <= end.getTime();
                        }

                        return isAfterStart && isBeforeEnd;
                    });
                }

                renderFileCards(filteredData);
            };

            // --- ファイルカード生成関数 (DOM生成による修正版) ---
            const renderFileCards = (dataToRender) => {
                fileGrid.innerHTML = ''; 
                if (dataToRender.length === 0) {
                    fileGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--meta-color);">該当するファイルは見つかりませんでした。</p>';
                    return;
                }
                dataToRender.forEach(file => {
                    const filePath = file.type === 'pdf' ? `pdfs/${file.filename}` : `images/${file.filename}`;
                    
                    let previewPath;
                    if (file.type === 'pdf') {
                        previewPath = file.preview_path || '';
                    } else if (file.type === 'image') {
                        previewPath = filePath; 
                    }

                    const hasPreview = previewPath !== '';
                    const fileExtension = file.filename.split('.').pop().toUpperCase();
                    const iconClass = file.type === 'pdf' ? 'fa-file-pdf' : 'fa-image';
                    const iconTypeClass = file.type === 'pdf' ? 'pdf-type' : 'image-type';

                    // --- HTMLをcreateElementで正しく組み立てる（表示崩れ対策） ---

                    // 1. 基本となる要素 (section, a)
                    const card = document.createElement('section');
                    card.className = `file-card`;
                    card.setAttribute('data-type', file.type);
                    card.setAttribute('data-tag', file.tag);

                    const link = document.createElement('a');
                    link.href = filePath;
                    link.target = '_blank';

                    // 2. プレビューエリア (.card-preview)
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'card-preview';

                    if (hasPreview) {
                        // プレビュー画像
                        const img = document.createElement('img');
                        img.src = previewPath;
                        img.alt = `${file.title} プレビュー`;
                        img.onerror = function() {
                            this.classList.add('hidden');
                            // nextElementSiblingが確実にnoImageDivを指すようにするため、noImageDivをimgの直後に配置
                            const noImage = this.nextElementSibling;
                            if (noImage) noImage.classList.remove('hidden');
                        };
                        previewDiv.appendChild(img);

                        // イメージなしブロック (画像がロードされない場合の代替表示)
                        const noImageDiv = document.createElement('div');
                        noImageDiv.className = 'no-image hidden';
                        noImageDiv.innerHTML = `<i class="fas ${file.type === 'pdf' ? 'fa-file-alt' : 'fa-image'}"></i> イメージなし`;
                        previewDiv.appendChild(noImageDiv);

                    } else {
                        // プレビュー画像がない場合 (初期表示)
                        const noImageDiv = document.createElement('div');
                        noImageDiv.className = 'no-image';
                        noImageDiv.innerHTML = `<i class="fas ${file.type === 'pdf' ? 'fa-file-alt' : 'fa-image'}"></i> イメージなし`;
                        previewDiv.appendChild(noImageDiv);
                    }
                    
                    // ファイルアイコン (ロゴとテキスト)
                    const iconSpan = document.createElement('span');
                    iconSpan.className = `file-icon ${iconTypeClass}`;
                    iconSpan.innerHTML = `<i class="fas ${iconClass}"></i> ${fileExtension}`;
                    previewDiv.appendChild(iconSpan); // ★ここがプレビューの部分のロゴ/タグの要素

                    link.appendChild(previewDiv);


                    // 3. 情報エリア (.card-info)
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'card-info';

                    const titleH2 = document.createElement('h2');
                    titleH2.textContent = file.title;
                    infoDiv.appendChild(titleH2);

                    const metadataDiv = document.createElement('div');
                    metadataDiv.className = 'metadata';
                    // メタデータ内のHTML要素もtextContentではなくinnerHTMLで設定
                    metadataDiv.innerHTML = `
                        <span><i class="fas fa-calendar-alt"></i> ${file.date}</span>
                        <span><i class="fas fa-tag"></i> ${tagMap[file.tag] || file.tag}</span>
                    `; // ★ここがタグ（マニュアル、レポートなど）の要素
                    infoDiv.appendChild(metadataDiv);
                    
                    link.appendChild(infoDiv);
                    card.appendChild(link);
                    fileGrid.appendChild(card);
                });
            };

            // --- フィルタボタンの動的生成と設定 (変更なし) ---
            const setupFilters = (data) => {
                const allButton = tagNav.querySelector('[data-filter="all"]');
                allButton.textContent = tagMap['all'];

                const existingTags = new Set(['pdf', 'image']);
                data.forEach(file => existingTags.add(file.tag));
                
                tagNav.innerHTML = '';
                tagNav.appendChild(allButton);
                
                existingTags.forEach(tag => {
                    if (tag === 'all') return;
                    const button = document.createElement('button');
                    button.setAttribute('data-filter', tag);
                    button.textContent = tagMap[tag] || tag.charAt(0).toUpperCase() + tag.slice(1);
                    tagNav.appendChild(button);
                });

                const filterButtons = tagNav.querySelectorAll('button');
                filterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const filter = button.getAttribute('data-filter');
                        
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');

                        currentFilterTag = filter;
                        applyMasterFilter();
                    });
                });
            };

            // --- レイアウト切替機能 (変更なし) ---
            layoutButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const newLayout = button.getAttribute('data-layout');
                    
                    layoutButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    fileGrid.classList.remove(currentLayout);
                    fileGrid.classList.add(newLayout);
                    currentLayout = newLayout;
                });
            });

            // --- JSONデータの読み込み (変更なし) ---
            const loadFiles = async () => {
                try {
                    const response = await fetch('data.json');
                    if (!response.ok) {
                        throw new Error(`Failed to load data.json. Status: ${response.status}`);
                    }
                    fileData = await response.json();
                    loadingMessage.classList.add('hidden'); 
                    setupFilters(fileData);
                    applyMasterFilter(); 
                } catch (error) {
                    console.error('Error loading file data:', error);
                    loadingMessage.textContent = 'ファイルの読み込みに失敗しました。data.jsonファイルを確認してください。';
                }
            };

            // --- イベントリスナーの設定 (変更なし) ---
            
            // 日付フィルタボタン
            applyDateFilterButton.addEventListener('click', () => {
                const startValue = startDateInput.value ? startDateInput.value.replace(/-/g, '/') : null;
                const endValue = endDateInput.value ? endDateInput.value.replace(/-/g, '/') : null;

                currentDateRange.start = startValue ? parseDate(startValue) : null;
                currentDateRange.end = endValue ? parseDate(endValue) : null;
                
                if (!currentDateRange.start && !currentDateRange.end) {
                     alert('開始日または終了日を入力してください。');
                     return;
                }

                if (currentDateRange.start && currentDateRange.end && currentDateRange.start.getTime() > currentDateRange.end.getTime()) {
                    alert('開始日が終了日より後の日付になっています。期間を確認してください。');
                    currentDateRange.start = null;
                    currentDateRange.end = null;
                    startDateInput.value = '';
                    endDateInput.value = '';
                    return;
                }

                applyMasterFilter();
            });

            // 日付フィルタクリアボタン
            clearDateFilterButton.addEventListener('click', () => {
                startDateInput.value = '';
                endDateInput.value = '';
                currentDateRange = { start: null, end: null };
                applyMasterFilter();
            });

            // メインナビゲーション
            mainNavButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const target = button.getAttribute('data-target');
                    
                    mainNavButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    fileListSection.classList.add('hidden');
                    adminAreaSection.classList.add('hidden');
                    
                    if (target === 'file-list') {
                        fileListSection.classList.remove('hidden');
                        tagNav.querySelector('[data-filter="all"]').click(); 
                        clearDateFilterButton.click();
                        document.querySelector('.layout-btn[data-layout="grid-cards"]').click(); 
                    } else if (target === 'admin-area') {
                        adminAreaSection.classList.remove('hidden');
                    }
                });
            });

            // 初期ロード
            loadFiles();
        });
    </script>
</body>
</html>
