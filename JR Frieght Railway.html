<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JR貨物 運行状況</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #1a73e8;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
        }
        .incident-list {
            margin-bottom: 20px;
        }
        .incident-item {
            background-color: #fce8e6;
            border: 1px solid #e74c3c;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .incident-item h3 {
            margin-top: 0;
            color: #e74c3c;
        }
        .train-line {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .train-line h3 {
            background-color: #e2e8f0;
            margin: 0;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .train-line h3::after {
            content: '+';
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }
        .train-line.active h3::after {
            content: '-';
        }
        .train-list {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .train-line.active .train-list {
            max-height: 20000px;
            padding: 15px;
        }
        .train-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .train-item:last-child {
            border-bottom: none;
        }
        .train-item p {
            margin: 5px 0;
        }
        .status-badge {
            display: inline-block;
            background-color: #f1c40f;
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-badge.停車中 {
            background-color: #3498db;
        }
        .status-badge.着予定 {
            background-color: #9b59b6;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-info">
        <div>
            <h1>JR貨物 運行状況</h1>
        </div>
        <div>
            <p id="company-name"></p>
            <p id="updated-time"></p>
        </div>
    </div>
    
    <div id="status-title"></div>

    <div class="incident-list">
        <h2>輸送障害情報</h2>
        <div id="incidents"></div>
    </div>

    <div id="affected-trains">
        <h2>影響のある貨物列車</h2>
    </div>
    
    <div id="related-files">
        <h2>関連情報</h2>
    </div>

</div>

<script>
    async function fetchAndUpdateData() {
        try {
            const response = await fetch('data.json');
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            const data = await response.json();
            renderPage(data);
        } catch (error) {
            console.error('Failed to fetch data.json:', error);
            document.querySelector('.container').innerHTML = '<p>データの取得に失敗しました。時間をおいて再度お試しください。最新の情報は<a href="https://www.jrfreight.co.jp/jrfreight/i_daiya.html">JR貨物公式サイト</a>でご確認ください。</p>';
        }
    }

    function renderPage(data) {
        // Header
        const companyNameEl = document.getElementById('company-name');
        if (companyNameEl) companyNameEl.textContent = data.company;

        const updatedTimeEl = document.getElementById('updated-time');
        if (updatedTimeEl) updatedTimeEl.textContent = `最終更新: ${data.date} ${data.time}`;
        
        const statusTitleEl = document.getElementById('status-title');
        if (statusTitleEl) statusTitleEl.innerHTML = data.status_title ? `<h2>${data.status_title}</h2>` : '';

        // Incidents
        const incidentContainer = document.getElementById('incidents');
        if (incidentContainer) {
            incidentContainer.innerHTML = '';
            if (data.incidents && data.incidents.length > 0) {
                data.incidents.forEach(incident => {
                    const incidentItem = document.createElement('div');
                    incidentItem.className = 'incident-item';
                    incidentItem.innerHTML = `
                        <h3>${incident.impact}</h3>
                        <p><strong>期間:</strong> ${incident.time_period}</p>
                        <p><strong>場所:</strong> ${incident.location}</p>
                        <p><strong>原因:</strong> ${incident.cause}</p>
                    `;
                    incidentContainer.appendChild(incidentItem);
                });
            } else {
                 incidentContainer.innerHTML = '<p>現在、輸送障害情報はございません。</p>';
            }
        }

        // Affected Trains
        const trainContainer = document.getElementById('affected-trains');
        if (trainContainer) {
            trainContainer.innerHTML = '<h2>影響のある貨物列車</h2>';
            if (data.affected_trains && data.affected_trains.length > 0) {
                data.affected_trains.forEach(line => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'train-line';
                    
                    const header = document.createElement('h3');
                    header.textContent = line.line;
                    lineDiv.appendChild(header);

                    const trainList = document.createElement('div');
                    trainList.className = 'train-list';
                    line.trains.forEach(train => {
                        const trainItem = document.createElement('div');
                        trainItem.className = 'train-item';
                        let statusBadgeClass = '';
                        if (train.status.includes('停車中')) {
                            statusBadgeClass = '停車中';
                        } else if (train.status.includes('予定') || train.status.includes('分')) {
                            statusBadgeClass = '着予定';
                        }
                        
                        trainItem.innerHTML = `
                            <p><strong>列車番号:</strong> ${train.train_number}</p>
                            <p><strong>区間:</strong> ${train.route}</p>
                            <p><strong>現在地:</strong> ${train.current_location}</p>
                            <p><strong>状況:</strong> <span class="status-badge ${statusBadgeClass}">${train.status}</span></p>
                        `;
                        trainList.appendChild(trainItem);
                    });
                    lineDiv.appendChild(trainList);
                    trainContainer.appendChild(lineDiv);
                });
            } else {
                 trainContainer.innerHTML = '<h2>影響のある貨物列車</h2><p>現在、影響のある貨物列車はございません。</p>';
            }
        }
        
        // Related Files
        const filesContainer = document.getElementById('related-files');
        if (filesContainer) {
            filesContainer.innerHTML = '<h2>関連情報</h2>';
            if (data.related_files && data.related_files.length > 0) {
                 data.related_files.forEach(file => {
                    const fileItem = document.createElement('p');
                    fileItem.innerHTML = `<a href="${file.url}">${file.title}</a>`;
                    filesContainer.appendChild(fileItem);
                });
            } else {
                filesContainer.innerHTML = '<h2>関連情報</h2><p>現在、関連情報ファイルはございません。</p>';
            }
        }

        document.querySelectorAll('.train-line h3').forEach(header => {
            header.addEventListener('click', (e) => {
                const parent = e.target.closest('.train-line');
                parent.classList.toggle('active');
            });
        });
    }

    window.onload = fetchAndUpdateData;

    // 毎時15分にページ全体を再読み込み
    function scheduleRefresh() {
      const now = new Date();
      let delay;
      if (now.getMinutes() < 15) {
        delay = (15 - now.getMinutes()) * 60 * 1000 - now.getSeconds() * 1000 - now.getMilliseconds();
      } else {
        const nextHour = new Date(now.getTime());
        nextHour.setHours(now.getHours() + 1);
        nextHour.setMinutes(15);
        nextHour.setSeconds(0);
        nextHour.setMilliseconds(0);
        delay = nextHour.getTime() - now.getTime();
      }
      setTimeout(() => {
        location.reload();
        scheduleRefresh();
      }, delay);
    }
    
    scheduleRefresh();
</script>
</body>
</html>
