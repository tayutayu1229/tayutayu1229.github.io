<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬åœè¼¸é€æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ  ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            max-width: 800px;
            width: 95%;
            display: none; 
        }
        #loading-page {
            text-align: center;
            font-size: 1.2rem;
            color: #01977a;
        }
        h1 {
            color: #01977a;
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        .button-container {
            display: grid;
            gap: 0.8rem;
        }
        .button {
            background-color: #01977a;
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 3px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: left;
            font-weight: bold;
        }
        .button:hover {
            background-color: #017a64;
        }
        .info {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #e8f8f5;
            border-left: 5px solid #01977a;
        }
        .info h2 {
            color: #01977a;
            margin-top: 0;
            font-size: 1.2rem;
            margin-bottom: 6px;
        }
        .additional-section {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 3px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .logout-container {
            text-align: right;
            margin-top: 1rem;
        }
        .logout-button {
            background-color: #d9534f;
            color: white;
            border: none;
            padding: 0.8rem 1.2rem;
            border-radius: 3px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .logout-button:hover {
            background-color: #c9302c;
        }
        /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .account-management {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }
        .account-management h3 {
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
        }
        .account-management button {
            background-color: #3f51b5;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: background-color 0.2s;
        }
        .account-management button:hover {
            background-color: #303f9f;
        }
        .account-status {
            margin-bottom: 0.8rem;
            font-size: 0.9rem;
            color: #555;
        }
        
        /* ğŸš¨ ã€ä¿®æ­£ã€‘ç®¡ç†è€…ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ é¢¨ã«å¤‰æ›´ ğŸš¨ */
        #admin-panel {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e6e6e6; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
            border: 1px solid #999; /* ã‚·ãƒ³ãƒ—ãƒ«ãªæ ç·š */
            border-radius: 5px;
            display: none; 
        }
        #admin-panel h2 {
            color: #333; /* æš—ã‚ã®è‰² */
            margin-top: 0;
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã«ã™ã‚‹ */
        #pending-users-list table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        #pending-users-list th, #pending-users-list td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        #pending-users-list th {
            background-color: #f5f5f5;
            font-weight: bold;
            color: #555;
        }
        #pending-users-list td button {
            background-color: #28a745; 
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #pending-users-list td button:hover {
             background-color: #1e7e34;
        }
    </style>
</head>
<body>
    
    <div id="loading-page">
        <p>èªè¨¼æƒ…å ±ã‚’ç¢ºèªä¸­ã§ã™...ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
    </div>

    <div class="container" id="main-container">
        
        <p id="user-info" style="text-align: right; margin-bottom: 1rem; font-weight: bold;"></p>
        
        <h1>æ±äº¬åœè¼¸é€æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <div class="account-management">
            <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</h3>
            <div id="account-status" class="account-status">ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</div>
            <button id="change-email-button">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´</button>
            <button id="change-password-button">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
        </div>

        <div id="admin-panel">
            <h2>ğŸš¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹æ‰¿èªãƒ‘ãƒãƒ«</h2>
            <div id="pending-users-list">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
        </div>
        
        <div class="button-container">
            <button class="button" onclick="location.href='ATOSlocation.html'">ATOSåœ¨ç·šãƒ¢ãƒ‹ã‚¿</button>
            <button class="button" onclick="location.href='train_zai-data.html'">åˆ—è»Šåœ¨ç·šçŠ¶æ³ä¸€è¦§è¡¨</button>
            <button class="button" onclick="location.href='train_grasp.html'">é‹è¡ŒæŠŠæ¡ãƒ¢ãƒ‹ã‚¿</button>
            <button class="button" onclick="location.href='T-time/mobileatos.html'">ATOSãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</button>
            <button class="button" onclick="location.href='train_info.html'">é‹è¡Œæƒ…å ±ä¸€è¦§</button>
            <button class="button" onclick="location.href='JRFtest/jr_freight_status.html'">è²¨ç‰©è¼¸é€çŠ¶æ³</button>
            <button class="button" onclick="location.href='JREgyoumu/JREtop.html'">æ±æ—¥æœ¬æ—…å®¢é‰„é“ã‚·ã‚¹ãƒ†ãƒ ãƒšãƒ¼ã‚¸</button>
            <button class="button" onclick="location.href='eastaria-info.html'">ä»–ä¼šç¤¾ç·šé‹è¡Œæƒ…å ±</button>
            <button class="button" onclick="location.href='flight/DAsystem.html'">é›¢ç€é™¸ç™ºç€ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </button>
            <button class="button" onclick="location.href='T-time/T-time.html'">åˆ—è»Šæ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </button>
            <button class="button" onclick="location.href='unnyou/unnyouindex.html'">é‹ç”¨æƒ…å ±æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </button>
            <button class="button" onclick="location.href='unnyou/datacreate.html'">é‹ç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</button>
            <button class="button" onclick="location.href='timeedit.html'">æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</button>
            <button class="button" onclick="location.href='tobu-zai.html'">æ±æ­¦ç·šåœ¨ç·šãƒ¢ãƒ‹ã‚¿</button>
            <button class="button" onclick="location.href='keisei-zai.html'">äº¬æˆç·šåœ¨ç·šãƒ¢ãƒ‹ã‚¿</button>
            <button class="button" onclick="location.href='zaisen-JRE.html'">JRæ±æ—¥æœ¬é§…åˆ—è»Šåœ¨ç·šãƒ¢ãƒ‹ã‚¿</button>
            <button class="button" onclick="location.href='TWR-top.html'">ã‚Šã‚“ã‹ã„ç·šã‚·ã‚¹ãƒ†ãƒ ãƒšãƒ¼ã‚¸</button>
            <button class="button" onclick="location.href='Flightpage.html'">ãƒ•ãƒ©ã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ãƒšãƒ¼ã‚¸</button>
            <button class="button" onclick="location.href='ekibetu.html'">é§…åˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</button>
            <button class="button" onclick="location.href='train_ressyabetu.html'">åˆ—è»Šåˆ¥ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ‹ã‚¿</button>
        </div>
        
        <div class="info">
            <h2>ã”åˆ©ç”¨ã«ã‚ãŸã£ã¦</h2>
            <p>æœ¬ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«é–¢ã™ã‚‹ã”è³ªå•ã‚„ã”æ„è¦‹ã¯ã€ä»¥ä¸‹ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€‚</p>
            <p><a href="mailto:tayutayu368@gmail.com">tayutayu368@gmail.com</a></p>
        </div>

        <div class="additional-section">
            <h2>ãã®ä»–</h2>
            <div class="button-container">
                <button class="button" onclick="location.href='outside.html'">å¤–éƒ¨ã‚µã‚¤ãƒˆ</button>
            </div>
        </div>
        <div class="logout-container">
            <button class="logout-button" id="firebase-logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --------------------------------------------------------------------------
        // ğŸš¨ ã€é‡è¦ã€‘ã”è‡ªèº«ã® Firebase è¨­å®šã«ç½®ãæ›ãˆã¦ãã ã•ã„
        // --------------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        try {
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth(); 
            const db = firebase.firestore();

            console.log("DEBUG: Firebase SDK åˆæœŸåŒ–æˆåŠŸ (toppage.html)");
            
            const mainContainer = document.getElementById('main-container');
            const loadingPage = document.getElementById('loading-page');
            const userInfo = document.getElementById('user-info');
            const logoutButton = document.getElementById('firebase-logout-button');
            const changeEmailButton = document.getElementById('change-email-button');
            const changePasswordButton = document.getElementById('change-password-button');
            const adminPanel = document.getElementById('admin-panel'); 
            const pendingUsersList = document.getElementById('pending-users-list');
            
            // èªè¨¼çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç›£è¦–ã—ã€ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚¬ãƒ¼ãƒ‰
            auth.onAuthStateChanged(async (user) => { 
                if (user) {
                    console.log(`DEBUG: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ - UID: ${user.uid}`);
                    
                    try {
                        const userDocRef = db.collection("users").doc(user.uid);
                        const userDoc = await userDocRef.get();
                        
                        // 1. æ‰¿èªãƒã‚§ãƒƒã‚¯
                        if (!userDoc.exists) {
                            console.error("DEBUG: Firestoreãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                            await auth.signOut();
                            alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™ã€‚å†ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
                            window.location.href = 'index.html';
                            return;
                        }

                        const userData = userDoc.data();
                        
                        if (!userData.approved) {
                            console.warn("DEBUG: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æœªæ‰¿èªã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ã€‚");
                            await auth.signOut();
                            alert("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã€‚ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç®¡ç†è€…ã«ã‚ˆã‚‹æ‰¿èªãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚");
                            window.location.href = 'index.html';
                            return;
                        }
                        
                        // 2. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                        loadingPage.style.display = 'none';
                        mainContainer.style.display = 'block';
                        
                        // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
                        userInfo.textContent = `(${user.email})ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`;

                        // 4. ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ã¨ãƒ‘ãƒãƒ«è¡¨ç¤º
                        if (userData.isAdmin) {
                            console.log("DEBUG: ç®¡ç†è€…æ¨©é™ã‚ã‚Šã€‚ç®¡ç†è€…ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
                            adminPanel.style.display = 'block';
                            loadPendingUsers(); 
                        } else {
                            adminPanel.style.display = 'none';
                        }

                    } catch (error) {
                        console.error('ERROR: Firestore/æ‰¿èªãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼', error);
                        alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚");
                        await auth.signOut();
                        window.location.href = 'index.html';
                    }

                } else {
                    console.log("DEBUG: æœªèªè¨¼ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€‚");
                    window.location.href = 'index.html';
                }
            });

            // ------------------------------------------------------------------
            // ç®¡ç†è€…æ©Ÿèƒ½ã®å®Ÿè£…
            // ------------------------------------------------------------------

            // æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆã‚’Firestoreã‹ã‚‰å–å¾—ã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º
            function loadPendingUsers() {
                console.log("DEBUG: æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...");
                db.collection("users")
                  .where("approved", "==", false)
                  .get()
                  .then((snapshot) => {
                    if (snapshot.empty) {
                        pendingUsersList.innerHTML = "æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚";
                        console.log("DEBUG: æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—ã€‚");
                        return;
                    }

                    let html = '<table>';
                    html += '<thead><tr><th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th><th>ç”³è«‹æ—¥æ™‚</th><th>æ“ä½œ</th></tr></thead>';
                    html += '<tbody>';
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const userId = doc.id;
                        const registrationTime = data.registeredAt ? 
                            data.registeredAt.toDate().toLocaleString('ja-JP') : 'N/A';
                        
                        html += `
                            <tr>
                                <td>${data.email}</td>
                                <td>${registrationTime}</td>
                                <td>
                                    <button onclick="window.approveUser('${userId}')">æ‰¿èª</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    pendingUsersList.innerHTML = html;
                    console.log(`DEBUG: æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${snapshot.size} ä»¶ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
                })
                .catch(error => {
                    console.error("ERROR: æ‰¿èªå¾…ã¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ã‚¨ãƒ©ãƒ¼: ", error);
                    pendingUsersList.innerHTML = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                });
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ‰¿èªã™ã‚‹å‡¦ç† (ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©)
            window.approveUser = async function(uid) {
                console.log(`DEBUG: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªå‡¦ç†é–‹å§‹ - UID: ${uid}`);
                if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${uid} ã‚’æ‰¿èªã—ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    try {
                        await db.collection("users").doc(uid).update({ approved: true });
                        alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${uid} ã‚’æ‰¿èªã—ã¾ã—ãŸã€‚æ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`);
                        console.log(`DEBUG: ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${uid} ã®æ‰¿èªã‚’Firestoreã§å®Œäº†ã€‚`);
                        loadPendingUsers(); // ãƒªã‚¹ãƒˆã‚’å†ãƒ­ãƒ¼ãƒ‰
                    } catch (error) {
                        console.error("ERROR: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªã‚¨ãƒ©ãƒ¼: ", error);
                        alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®å•é¡Œã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚");
                    }
                }
            };


            // ------------------------------------------------------------------
            // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½
            // ------------------------------------------------------------------

            // 1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´
            changeEmailButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) { return; }

                const newEmail = prompt(`ç¾åœ¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${user.email}\næ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);
                
                if (newEmail && newEmail.trim() !== user.email) {
                     console.log(`DEBUG: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´è©¦è¡Œ: ${user.email} -> ${newEmail.trim()}`);
                     alert("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´å¾Œã¯è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã€å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
                    try {
                        await user.updateEmail(newEmail.trim());
                        console.log("DEBUG: Authå´ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ›´æ–°æˆåŠŸ");
                        
                        // Firestoreã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚æ›´æ–°
                        await db.collection("users").doc(user.uid).update({ email: newEmail.trim() });
                        console.log("DEBUG: Firestoreå´ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ›´æ–°æˆåŠŸ");
                        
                        alert(`ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ ${newEmail.trim()} ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚`);
                        await auth.signOut();
                    } catch (error) {
                        console.error("ERROR: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ã‚¨ãƒ©ãƒ¼:", error.code, error.message);
                        let errMsg = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                        if (error.code === 'auth/requires-recent-login') {
                            errMsg += 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰ã€ã“ã®æ“ä½œã«ã¯æœ€è¿‘ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã€ã™ãã«å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚';
                        } else if (error.code === 'auth/invalid-email') {
                            errMsg += 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                        } else if (error.code === 'auth/email-already-in-use') {
                            errMsg += 'ãã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚';
                        }
                        alert(errMsg);
                    }
                }
            });

            // 2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ (å†è¨­å®šãƒ¡ãƒ¼ãƒ«ã‚’è‡ªåˆ†ã«é€ã‚‹)
            changePasswordButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) { return; }
                console.log("DEBUG: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡è©¦è¡Œ");
                if (confirm("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n(å¤‰æ›´ã¯ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„)")) {
                    try {
                        await auth.sendPasswordResetEmail(user.email);
                        alert(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’ ${user.email} ã«é€ä¿¡ã—ã¾ã—ãŸã€‚ã”ç¢ºèªãã ã•ã„ã€‚`);
                        console.log("DEBUG: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ");
                    } catch (error) {
                        console.error("ERROR: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
                        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦ãŠè©¦ã—ãã ã•ã„ã€‚");
                    }
                }
            });

            // 3. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
            async function firebaseLogout() {
                const confirmed = confirm("æœ¬å½“ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ");
                if (confirmed) {
                    console.log("DEBUG: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†å®Ÿè¡Œ");
                    try {
                        await auth.signOut();
                    } catch (error) {
                        console.error('ERROR: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                        alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                }
            }

            if (logoutButton) {
                logoutButton.addEventListener('click', firebaseLogout);
            }
        } catch (e) {
            console.error("FATAL ERROR: Firebase SDK åˆæœŸåŒ–å¤±æ•— (toppage.html)", e);
            document.getElementById('loading-page').innerHTML = '<h1>è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚</h1>';
        }
    });
    </script>
</body>
</html>
