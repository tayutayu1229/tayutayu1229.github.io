<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, th, td { border: 1px solid #999; border-collapse: collapse; padding: 5px; }
    textarea { width: 100%; height: 200px; }
    input, select, button { margin: 5px; padding: 5px; }
    label { display: inline-block; margin: 5px 0; }
    .error { color: red; font-weight: bold; margin-left: 10px; }
    .stop-buttons button { margin: 0 2px; }
    /* é †ç•ªç§»å‹•ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .move-btn { 
        padding: 2px 5px; 
        font-size: 10px;
        line-height: 1;
        cursor: pointer;
    }
  </style>
</head>
<body>
    <h1>â—‹æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
    <p>ãƒ¢ãƒã‚¤ãƒ«ATOSã«æº–ãšã‚‹æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚</p>

<h2>åˆ—è»ŠåŸºæœ¬æƒ…å ±</h2>
<form id="trainInfoForm">
  <label>åˆ—è»Šç•ªå·: <input id="trainNumber" type="text" onchange="updateJSON()"></label>
  <label>ç¨®åˆ¥: <input id="type" type="text" onchange="updateJSON()"></label>
  <label>å¹³æ—¥/åœŸä¼‘æ—¥: 
    <select id="dayType" onchange="updateJSON()">
      <option value="å¹³æ—¥">å¹³æ—¥</option>
      <option value="åœŸä¼‘æ—¥">åœŸä¼‘æ—¥</option>
    </select>
  </label>
  <label>å§‹ç™ºé§…ç™ºæ—¥: <input id="startDate" type="date" onchange="updateJSON()"></label><br>
  <label>å§‹ç™ºé§…: <input id="origin" type="text" onchange="updateJSON()"></label>
  <label>çµ‚ç€é§…: <input id="destination" type="text" onchange="updateJSON()"></label>
  <label>è·¯ç·šå: <input id="line" type="text" onchange="updateJSON()"></label>
  <label>é€Ÿåº¦ç¨®åˆ¥: <input id="speed" type="text" onchange="updateJSON()"></label>
  <label>åˆ—è»Šå: <input id="name" type="text" onchange="updateJSON()"></label>
</form>
<hr>

<h2>åœè»Šé§…ã®ç·¨é›†ã¨è¿½åŠ </h2>
<table style="width: 100%;">
  <thead>
    <tr><th>é †</th><th>é§…å</th><th>ç€</th><th>ç™º</th><th>ç•ªç·š</th><th>æ“ä½œ</th></tr>
  </thead>
  <tbody id="stopsTable">
    </tbody>
</table>

<div id="addStopForm">
  <label>é§…å: <input id="station" type="text" maxlength="5" placeholder="ä¾‹: å¤§ã€€å®®"></label>
  <label>ç€: <input id="arrival" type="text" placeholder="hh:mm:ss"></label>
  <label>ç™º(é€š): <input id="departure" type="text" placeholder="hh:mm:ss"></label>
  <label>ç•ªç·š: <input id="trackN" type="text" placeholder="ä¾‹: ï¼‘ï¼ç•ª"></label>
  <button onclick="addStop()">è¿½åŠ </button>
  <span id="validationError" class="error"></span>
</div>
<hr>

<h2>å‡ºåŠ›JSON</h2>
<textarea id="jsonOutput" readonly></textarea>
<button onclick="copyJson()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>

<br><br>
<h3>ã€æ›¸ãæ–¹ï¼ˆãƒ¢ãƒã‚¤ãƒ«ATOSæº–æ‹ ï¼‰ã€‘</h3>
<ul>
  <li>é§…åãŒï¼’æ–‡å­—ã®å ´åˆã¯ **å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‘ã¤** ã‚’é–‹ã‘ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: "å¤§ã€€å®®"ï¼‰ã€‚</li>
  <li>é§…åã¯**ï¼”æ–‡å­—ã¾ã§**ã§ã™ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€ï¼‰ã€‚</li>
  <li>ç€ç™ºç•ªç·šã§ã¯ã€æ•°å­—ã¯**å…¨è§’**ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 10ç•ªç·šã®å ´åˆã¯"ï¼‘ï¼ç•ª"ï¼‰ã€‚</li>
  <li>**å§‹ç™ºé§…ã®ç€æ™‚åˆ»**ã€**çµ‚ç€é§…ã®ç™ºæ™‚åˆ»**ã¯ãƒ–ãƒ©ãƒ³ã‚¯ã«ã—ã¦ãã ã•ã„ã€‚</li>
</ul>

<script>
  const stops = [];

  // æ™‚åˆ»å½¢å¼ hh:mm:ss ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  function isValidTime(timeStr) {
    if (!timeStr) return true;
    const timeRegex = /^([0-9]{2}):([0-5][0-9]):([0-5][0-9])$/;
    const isValid = timeRegex.test(timeStr);
    if (!isValid) return false;
    // 24æ™‚é–“ã‚’è¶…ãˆã‚‹æ™‚åˆ» (ä¾‹: 25:30:00) ã‚‚è¨±å¯ã™ã‚‹ãŸã‚ã€æ™‚ãƒ»åˆ†ãƒ»ç§’ã®ç¯„å›²ã®ã¿ãƒã‚§ãƒƒã‚¯
    return true; 
  }

  // æ–‡å­—åˆ—æ™‚åˆ»ã‚’ç§’æ•°ã«å¤‰æ›ï¼ˆç¿Œæ—¥ä»¥é™ã‚‚è€ƒæ…®ï¼‰
  function timeToSeconds(timeStr) {
    if (!timeStr || !isValidTime(timeStr)) return -1;
    const [h, m, s] = timeStr.split(':').map(Number);
    return h * 3600 + m * 60 + s;
  }

  function addStop() {
    const station = document.getElementById("station");
    const arrival = document.getElementById("arrival");
    const departure = document.getElementById("departure");
    const trackN = document.getElementById("trackN");
    const errorSpan = document.getElementById("validationError");
    errorSpan.textContent = "";

    if (!station.value.trim()) {
      errorSpan.textContent = "é§…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      station.focus();
      return;
    }
    
    // æ™‚åˆ»ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (arrival.value && !isValidTime(arrival.value)) {
      errorSpan.textContent = "ç€æ™‚åˆ»ãŒhh:mm:sså½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      arrival.focus();
      return;
    }
    if (departure.value && !isValidTime(departure.value)) {
      errorSpan.textContent = "ç™ºæ™‚åˆ»ãŒhh:mm:sså½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      departure.focus();
      return;
    }

    // ç€æ™‚åˆ»ã¨ç™ºæ™‚åˆ»ã®é †åºãƒã‚§ãƒƒã‚¯
    if (arrival.value && departure.value) {
      const arrSec = timeToSeconds(arrival.value);
      const depSec = timeToSeconds(departure.value);
      if (arrSec !== -1 && depSec !== -1 && arrSec > depSec) {
        errorSpan.textContent = "ç™ºæ™‚åˆ»ã¯ç€æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ã—ã¦ãã ã•ã„ã€‚";
        departure.focus();
        return;
      }
    }
    
    // åœè»Šé§…é–“ã®é †åºãƒã‚§ãƒƒã‚¯ (å‰ã®é§…ã®ç™ºæ™‚åˆ»ã‚ˆã‚Šå¾Œã®æ™‚åˆ»ã‹)
    if (stops.length > 0) {
      const lastStop = stops[stops.length - 1];
      const lastDepSec = timeToSeconds(lastStop.departure || lastStop.arrival); // ç™ºæ™‚åˆ»ãŒãªã„å ´åˆã¯ç€æ™‚åˆ»ã‚’ä»£ç”¨
      
      const newArrSec = timeToSeconds(arrival.value);
      const newDepSec = timeToSeconds(departure.value);
      
      if (lastDepSec !== -1) { // å‰ã®é§…ã®ç™ºæ™‚åˆ»ãŒæœ‰åŠ¹ãªå ´åˆ
          if (newArrSec !== -1 && newArrSec < lastDepSec) {
            errorSpan.textContent = "ç€æ™‚åˆ»ãŒå‰ã®é§…ã®ç™ºæ™‚åˆ»ã‚ˆã‚Šæ—©ã„ã§ã™ã€‚";
            arrival.focus();
            return;
          }
          if (newDepSec !== -1 && newDepSec < lastDepSec) {
            errorSpan.textContent = "ç™ºæ™‚åˆ»ãŒå‰ã®é§…ã®ç™ºæ™‚åˆ»ã‚ˆã‚Šæ—©ã„ã§ã™ã€‚";
            departure.focus();
            return;
          }
      }
    }

    stops.push({
      station: station.value.trim(),
      arrival: arrival.value.trim(),
      departure: departure.value.trim(),
      trackN: trackN.value.trim()
    });

    station.value = "";
    arrival.value = "";
    departure.value = "";
    trackN.value = "";

    updateTable();
    updateJSON();
    station.focus();
  }

  // åœè»Šé§…ã®é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã‚‹
  function moveStop(index, direction) {
    if (direction === 'up' && index > 0) {
      [stops[index], stops[index - 1]] = [stops[index - 1], stops[index]];
    } else if (direction === 'down' && index < stops.length - 1) {
      [stops[index], stops[index + 1]] = [stops[index + 1], stops[index]];
    }
    updateTable();
    updateJSON();
  }

  function removeStop(index) {
    stops.splice(index, 1);
    updateTable();
    updateJSON();
  }

  function updateTable() {
    const tbody = document.getElementById("stopsTable");
    tbody.innerHTML = "";
    stops.forEach((stop, i) => {
      const row = `<tr>
        <td>${i + 1}</td>
        <td>${stop.station}</td>
        <td>${stop.arrival}</td>
        <td>${stop.departure}</td>
        <td>${stop.trackN}</td>
        <td class="stop-buttons">
          <button class="move-btn" onclick="moveStop(${i}, 'up')">â–² ä¸Šã¸</button>
          <button class="move-btn" onclick="moveStop(${i}, 'down')">â–¼ ä¸‹ã¸</button>
          <button onclick="removeStop(${i})">å‰Šé™¤</button>
        </td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  }

  // åˆ—è»ŠåŸºæœ¬æƒ…å ±ã®å¤‰æ›´æ™‚ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§JSONã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€å…ƒã® updateJSON é–¢æ•°ã‚’ä½¿ç”¨
  function updateJSON() {
    const output = {
      trainNumber: document.getElementById("trainNumber").value,
      type: document.getElementById("type").value,
      dayType: document.getElementById("dayType").value,
      startDate: document.getElementById("startDate").value,
      origin: document.getElementById("origin").value,
      destination: document.getElementById("destination").value,
      speed: document.getElementById("speed").value,
      name: document.getElementById("name").value,
      line: document.getElementById("line").value,
      stops // è‡ªå‹•å‡¦ç†ã‚’è¡Œã‚ãªã„ã€ãã®ã¾ã¾ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONã«å‡ºåŠ›
    };
    document.getElementById("jsonOutput").value = JSON.stringify(output, null, 2);
  }

  function copyJson() {
    const jsonText = document.getElementById("jsonOutput").value;
    if (jsonText) {
      navigator.clipboard.writeText(jsonText)
        .then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"))
        .catch(err => console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err));
    } else {
      alert("JSONãŒç©ºã§ã™ã€‚");
    }
  }

  // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«JSONã‚’ç”Ÿæˆã—ã¦ãŠã
  document.addEventListener('DOMContentLoaded', updateJSON);
</script>
</body>
</html>
