<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ™‚åˆ»è¡¨ä½œæˆãƒ„ãƒ¼ãƒ« [Ultimate Edition v2]</title>
  <style>
    :root { --primary: #2563eb; --next: #059669; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; }
    body { font-family: sans-serif; padding: 10px; background-color: var(--bg); font-size: 12px; color: #334155; }
    h1 { font-size: 1.1rem; margin: 0 0 10px 0; }
    h2 { font-size: 0.85rem; margin: 0 0 5px 0; border-left: 3px solid var(--primary); padding-left: 6px; }
    
    .btn-group { display: flex; gap: 6px; margin-bottom: 10px; align-items: center; }
    button { padding: 6px 14px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; font-size: 11px; transition: 0.2s; }
    .btn-blue { background: var(--primary); color: white; }
    .btn-green { background: var(--next); color: white; }
    .btn-gray { background: #64748b; color: white; }
    .btn-red { background: #ef4444; color: white; padding: 2px 6px; }
    button:hover { opacity: 0.8; }

    .flex-container { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .section { background: var(--card); padding: 10px; border-radius: 6px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex: 1; min-width: 320px; }
    
    .grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .grid-info span { display: block; font-size: 10px; color: #64748b; margin-bottom: 1px; }

    input { padding: 5px 8px; border: 1px solid var(--border); border-radius: 3px; font-size: 12px; width: 100%; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    th, td { border: 1px solid var(--border); padding: 4px; text-align: left; }
    th { background: #f1f5f9; font-weight: 600; font-size: 11px; }

    /* JSONè¡¨ç¤ºæ¬„ã‚’å¤§ããç¢ºä¿ */
    textarea { width: 100%; height: 400px; font-family: "Consolas", "Monaco", monospace; font-size: 12px; border: 1px solid var(--border); border-radius: 4px; margin-top: 10px; background: #272822; color: #f8f8f2; padding: 10px; line-height: 1.5; }
    .hint-msg { font-size: 11px; color: var(--next); font-weight: bold; }
    .status-msg { font-size: 10px; color: #94a3b8; margin-left: auto; }
  </style>
</head>
<body>

<h1>ğŸ“… æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</h1>

<div class="btn-group">
  <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">
  <button class="btn-gray" onclick="document.getElementById('importFile').click()">ğŸ’¾ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  <button class="btn-blue" onclick="copyJson()">ğŸ“‹ JSONã‚³ãƒ”ãƒ¼</button>
  <button class="btn-green" onclick="prepareNextSection()">â¡ æ¬¡ã®åŒºé–“ã‚’ä½œæˆ</button>
  <span id="actionMessage" class="hint-msg"></span>
  <span id="loadStatus" class="status-msg">Master: èª­ã¿è¾¼ã¿ä¸­...</span>
</div>

<div class="flex-container">
  <div class="section">
    <h2>1. åŸºæœ¬æƒ…å ±</h2>
    <div class="grid-info">
      <label><span>åˆ—è»Šç•ªå·</span><input id="trainNumber" type="text" oninput="updateJSON()"></label>
      <label><span>ç¨®åˆ¥</span><input id="type" type="text" oninput="updateJSON()"></label>
      <label><span>å¹³æ—¥/åœŸä¼‘æ—¥</span><input id="dayType" type="text" placeholder="å¹³æ—¥" oninput="updateJSON()"></label>
      <label><span>å§‹ç™ºé§…ç™ºæ—¥</span><input id="startDate" type="date" oninput="updateJSON()"></label>
      <label><span>è·¯ç·šå</span><input id="line" type="text" oninput="updateJSON()"></label>
      <label><span>åˆ—è»Šå(ä»»æ„)</span><input id="name" type="text" oninput="updateJSON()"></label>
      <label><span>å§‹ç™ºé§…</span><input id="origin" type="text" oninput="updateJSON()"></label>
      <label><span>çµ‚ç€é§…</span><input id="destination" type="text" oninput="updateJSON()"></label>
    </div>
  </div>

  <div class="section">
    <h2>2. ç¶™èµ°ãƒ»æ¥ç¶š (Kid)</h2>
    <table>
      <thead><tr><th>æ–¹å‘</th><th>tt</th><th>tr</th><th>kid</th></tr></thead>
      <tbody>
        <tr><td><strong>å‰(1)</strong></td><td><input id="tt1" type="text" oninput="updateJSON()"></td><td><input id="tr1" type="text" oninput="updateJSON()"></td><td><input id="kid1" type="text" oninput="updateJSON()"></td></tr>
        <tr><td><strong>æ¬¡(2)</strong></td><td><input id="tt2" type="text" oninput="updateJSON()"></td><td><input id="tr2" type="text" oninput="updateJSON()"></td><td><input id="kid2" type="text" oninput="updateJSON()"></td></tr>
      </tbody>
    </table>
    <p style="margin: 5px 0 0 0; font-size: 10px; color: #64748b;">
      â€»ç¶™èµ°æƒ…å ±ã¯å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚ã£ãŸã‚‰ãƒ¢ãƒã‚¤ãƒ«ATOSä¸Šã§ç¶™èµ°ãŒè¦‹ã‚Œã¾ã™ã€‚
    </p>
  </div>
</div>

<div class="section">
  <h2>3. åœè»Šé§…ãƒªã‚¹ãƒˆ</h2>
  <table>
    <thead><tr><th style="width:30%">é§…å</th><th style="width:20%">ç€</th><th style="width:20%">ç™º</th><th style="width:20%">ç•ªç·š</th><th style="width:10%">å‰Š</th></tr></thead>
    <tbody id="stopsBody"></tbody>
  </table>
  <div style="display: flex; gap: 4px; margin-top: 8px; background: #f1f5f9; padding: 8px; border-radius: 4px;">
    <input id="in_station" type="text" placeholder="é§…å" list="stationList" oninput="updateTrackSuggestions()">
    <input id="in_arrival" type="text" placeholder="ç€">
    <input id="in_departure" type="text" placeholder="ç™º">
    <input id="in_track" type="text" placeholder="ç•ªç·š" list="trackSuggestions">
    <button class="btn-blue" onclick="addStop()">è¿½åŠ </button>
  </div>
</div>

<div class="section">
    <h2>å‡ºåŠ›JSON (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½)</h2>
    <textarea id="jsonOutput" readonly onclick="this.select()"></textarea>
</div>

<datalist id="stationList"></datalist>
<datalist id="trackSuggestions"></datalist>

<script>
  let stops = [];
  let masterData = [];

  // 1. å¤–éƒ¨ãƒã‚¹ã‚¿ã®èª­ã¿è¾¼ã¿ (T-time/timetables.json)
  window.onload = async function() {
    const status = document.getElementById('loadStatus');
    try {
      const res = await fetch('T-time/timetables.json');
      if(res.ok) {
        masterData = await res.json();
        const list = document.getElementById('stationList');
        const stations = [...new Set(masterData.flatMap(t => t.stops.map(s => s.station)))];
        stations.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          list.appendChild(opt);
        });
        status.innerText = "Master: èª­è¾¼æ¸ˆ (" + stations.length + "é§…)";
        status.style.color = "#059669";
      } else {
        throw new Error();
      }
    } catch(e) {
      status.innerText = "Master: æœªèª­è¾¼ (æ‰‹å‹•å…¥åŠ›å¯èƒ½)";
      status.style.color = "#ef4444";
    }
  };

  // 2. é§…åå…¥åŠ›æ™‚ã«ã€ãã®é§…ã§éå»ã«ä½¿ã‚ã‚ŒãŸç•ªç·šã‚’æŠ½å‡º
  function updateTrackSuggestions() {
    const station = document.getElementById('in_station').value;
    const list = document.getElementById('trackSuggestions');
    list.innerHTML = "";
    if(!station) return;

    // é§…åãŒå®Œå…¨ä¸€è‡´ã™ã‚‹éå»ãƒ‡ãƒ¼ã‚¿ã®ç•ªç·š(trackN)ã‚’å–å¾—
    const tracks = [...new Set(masterData.flatMap(t => 
      t.stops.filter(s => s.station === station).map(s => s.trackN)
    ))].filter(Boolean);

    tracks.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      list.appendChild(opt);
    });
  }

  // --- JSONæ›´æ–° ---
  function updateJSON() {
    const rawDate = document.getElementById("startDate").value;
    const data = {
      trainNumber: document.getElementById("trainNumber").value,
      type: document.getElementById("type").value,
      dayType: document.getElementById("dayType").value,
      startDate: rawDate ? rawDate.replace(/-/g, '/') : "",
      origin: document.getElementById("origin").value,
      destination: document.getElementById("destination").value,
      speed: "",
      name: document.getElementById("name").value,
      line: document.getElementById("line").value,
      tt1: document.getElementById("tt1").value,
      tt2: document.getElementById("tt2").value,
      tr1: document.getElementById("tr1").value,
      tr2: document.getElementById("tr2").value,
      kid1: document.getElementById("kid1").value,
      kid2: document.getElementById("kid2").value,
      stops: stops
    };
    document.getElementById("jsonOutput").value = JSON.stringify(data, null, 2);
  }

  // --- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ---
  function handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const d = JSON.parse(e.target.result);
        const setVal = (id, val) => document.getElementById(id).value = val || "";
        
        setVal("trainNumber", d.trainNumber);
        setVal("type", d.type);
        setVal("dayType", d.dayType);
        if (d.startDate) document.getElementById("startDate").value = d.startDate.replace(/\//g, '-');
        setVal("line", d.line);
        setVal("name", d.name);
        setVal("origin", d.origin);
        setVal("destination", d.destination);
        setVal("tt1", d.tt1);
        setVal("tt2", d.tt2);
        setVal("tr1", d.tr1);
        setVal("tr2", d.tr2);
        setVal("kid1", d.kid1);
        setVal("kid2", d.kid2);
        
        stops = Array.isArray(d.stops) ? d.stops : [];
        updateUI();
        event.target.value = "";
      } catch (err) { alert("JSONè§£æã‚¨ãƒ©ãƒ¼"); }
    };
    reader.readAsText(file);
  }

  // --- æ¬¡åŒºé–“ä½œæˆ (ã‚¹ãƒ©ã‚¤ãƒ‰) ---
  function prepareNextSection() {
    const curTrain = document.getElementById("trainNumber").value;
    const nxtTrain = document.getElementById("tr2").value;
    const nxtKid1 = document.getElementById("kid2").value;
    const nxtTt1 = document.getElementById("tt2").value;
    const nxtOrigin = document.getElementById("destination").value;

    if (!nxtTrain && !nxtKid1) { alert("æ¬¡åˆ—è»Šæƒ…å ±(tr2/kid2)ãŒå¿…è¦ã§ã™ã€‚"); return; }

    document.getElementById("trainNumber").value = nxtTrain;
    document.getElementById("tr1").value = curTrain;
    document.getElementById("kid1").value = nxtKid1;
    document.getElementById("tt1").value = nxtTt1;
    document.getElementById("origin").value = nxtOrigin;

    ["destination", "tr2", "kid2", "tt2", "line"].forEach(id => document.getElementById(id).value = "");
    stops = []; updateUI();
    
    const msg = document.getElementById("actionMessage");
    msg.innerText = "âœ¨ ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¾ã—ãŸ";
    setTimeout(() => { msg.innerText = ""; }, 3000);
  }

  // --- åœè»Šé§…æ“ä½œ ---
  function addStop() {
    const s = document.getElementById("in_station").value;
    if(!s) return;
    stops.push({
      station: s,
      arrival: document.getElementById("in_arrival").value,
      departure: document.getElementById("in_departure").value,
      trackN: document.getElementById("in_track").value
    });
    ["in_station", "in_arrival", "in_departure", "in_track"].forEach(id => document.getElementById(id).value = "");
    updateUI();
  }

  function updateUI() {
    const tbody = document.getElementById("stopsBody");
    tbody.innerHTML = "";
    stops.forEach((stop, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" value="${stop.station}" oninput="stops[${i}].station=this.value;updateJSON()"></td>
        <td><input type="text" value="${stop.arrival}" oninput="stops[${i}].arrival=this.value;updateJSON()"></td>
        <td><input type="text" value="${stop.departure}" oninput="stops[${i}].departure=this.value;updateJSON()"></td>
        <td><input type="text" value="${stop.trackN}" oninput="stops[${i}].trackN=this.value;updateJSON()"></td>
        <td><button class="btn-red" onclick="stops.splice(${i},1);updateUI()">Ã—</button></td>
      `;
      tbody.appendChild(tr);
    });
    updateJSON();
  }

  function copyJson() {
    const area = document.getElementById("jsonOutput");
    area.select();
    document.execCommand("copy");
    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  }
</script>
</body>
</html>
