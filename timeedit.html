<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>時刻表データ作成ツール</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, th, td { border: 1px solid #999; border-collapse: collapse; padding: 5px; }
    textarea { width: 100%; height: 200px; }
    input, select, button { margin: 5px; padding: 5px; }
    label { display: inline-block; margin: 5px 0; }
    .error { color: red; font-weight: bold; margin-left: 10px; }
    .stop-buttons button { margin: 0 2px; }
    .move-btn { 
        padding: 2px 5px; 
        font-size: 10px;
        line-height: 1;
        cursor: pointer;
    }
    .duration { font-weight: bold; color: #0066cc; } /* 所要時間用のスタイル */
  </style>
</head>
<body>
    <h1>○時刻表データ作成ツール</h1>
    <p>モバイルATOSに準ずる時刻表データを作成します。</p>

<h2>データ操作</h2>
<input type="file" id="importFile" accept="application/json">
<button onclick="importJson()">💾 インポート</button>
<button onclick="copyJson()">📋 JSONをコピー</button>
<hr>

<h2>列車基本情報</h2>
<form id="trainInfoForm">
  <label>列車番号: <input id="trainNumber" type="text" onchange="updateJSON()"></label>
  <label>種別: <input id="type" type="text" onchange="updateJSON()"></label>
  <label>平日/土休日: 
    <select id="dayType" onchange="updateJSON()">
      <option value="平日">平日</option>
      <option value="土休日">土休日</option>
    </select>
  </label>
  <label>始発駅発日: <input id="startDate" type="date" onchange="updateJSON()"></label><br>
  <label>始発駅: <input id="origin" type="text" onchange="updateJSON()"></label>
  <label>終着駅: <input id="destination" type="text" onchange="updateJSON()"></label>
  <label>路線名: <input id="line" type="text" onchange="updateJSON()"></label>
  <label>速度種別: <input id="speed" type="text" onchange="updateJSON()"></label>
  <label>列車名: <input id="name" type="text" onchange="updateJSON()"></label>
</form>
<hr>

<h2>停車駅の編集と追加</h2>
<table style="width: 100%;">
  <thead>
    <tr><th>順</th><th>駅名</th><th>着</th><th>発</th><th>番線</th><th>所要時間</th><th>操作</th></tr>
  </thead>
  <tbody id="stopsTable">
    </tbody>
</table>

<div id="addStopForm">
  <label>駅名: <input id="station" type="text" maxlength="5" placeholder="例: 大　宮"></label>
  <label>着: <input id="arrival" type="text" placeholder="hh:mm:ss"></label>
  <label>発(通): <input id="departure" type="text" placeholder="hh:mm:ss"></label>
  <label>番線: <input id="trackN" type="text" placeholder="例: １０番"></label>
  <button onclick="addStop()">追加</button>
  <span id="validationError" class="error"></span>
</div>
<hr>

<h2>出力JSON</h2>
<textarea id="jsonOutput" readonly></textarea>

<br><br>
<button onclick="copyJson()">📋 JSONをコピー</button>

<br><br>
<h3>【書き方（モバイルATOS準拠）】</h3>
<ul>
  <li>駅名が２文字の場合は **全角スペース１つ** を開けてください。入力時に自動で挿入を試みます。</li>
  <li>着発番線では、数字は**全角**で入力してください。入力時に半角は全角に自動変換されます。</li>
</ul>

<script>
  let stops = [];

  // ユーティリティ関数
  
  // 時刻形式 hh:mm:ss のバリデーション
  function isValidTime(timeStr) {
    if (!timeStr) return true;
    return /^([0-9]{2}):([0-5][0-9]):([0-5][0-9])$/.test(timeStr);
  }

  // 文字列時刻を秒数に変換（翌日以降も考慮）
  function timeToSeconds(timeStr) {
    if (!timeStr || !isValidTime(timeStr)) return -1;
    const [h, m, s] = timeStr.split(':').map(Number);
    return h * 3600 + m * 60 + s;
  }

  // 半角数字を全角に変換
  function toZenkaku(str) {
    if (!str) return '';
    return str.replace(/[0-9]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) + 0xFEE0);
    });
  }

  // 時刻の前後関係（逆走）チェック
  function checkTimeConsistency() {
    let lastDepartureSec = -1;
    for (let i = 0; i < stops.length; i++) {
        const stop = stops[i];
        
        const currentArrivalSec = timeToSeconds(stop.arrival);
        const currentDepartureSec = timeToSeconds(stop.departure);

        // 1. 駅内のチェック：着時刻 > 発時刻はNG
        if (currentArrivalSec !== -1 && currentDepartureSec !== -1 && currentArrivalSec > currentDepartureSec) {
            return `【警告】${stop.station} で発時刻が着時刻より早いです。`;
        }

        // 2. 駅間のチェック：前の駅の発時刻 > 現在の駅の着/発時刻はNG (逆走)
        if (lastDepartureSec !== -1) {
            if (currentArrivalSec !== -1 && currentArrivalSec < lastDepartureSec) {
                return `【警告】${stop.station} の着時刻が前の駅の発時刻より早いです。`;
            }
            if (currentDepartureSec !== -1 && currentDepartureSec < lastDepartureSec) {
                return `【警告】${stop.station} の発時刻が前の駅の発時刻より早いです。`;
            }
        }
        
        // 3. 次の駅のために現在の駅の有効な発時刻を記録
        if (currentDepartureSec !== -1) {
             lastDepartureSec = currentDepartureSec;
        } else if (currentArrivalSec !== -1 && i !== stops.length - 1) { // 停車はしないが通過時刻がある場合（最終駅以外）
             lastDepartureSec = currentArrivalSec;
        }
    }
    return null; // 問題なし
  }


  // データ品質とバリデーションの強化
  function validateAndNormalizeStop(station, arrival, departure, trackN) {
    const errorSpan = document.getElementById("validationError");
    errorSpan.textContent = "";
    
    let normStation = station.trim();
    let normTrackN = trackN.trim();

    if (!normStation) {
      errorSpan.textContent = "駅名を入力してください。"; return null;
    }
    
    // 1. 駅名の入力補助 (2文字に全角スペース)
    if (normStation.length === 2 && !normStation.includes('　')) {
        normStation = normStation[0] + '　' + normStation[1];
    }
    if (normStation.length > 5) { // 最大4文字+スペース1文字
         errorSpan.textContent = "駅名は5文字（全角スペース込み）以下にしてください。"; return null;
    }

    // 2. 番線の全角数字チェック/変換
    normTrackN = toZenkaku(normTrackN);

    // 3. 時刻のバリデーション
    if (arrival && !isValidTime(arrival)) {
      errorSpan.textContent = "着時刻がhh:mm:ss形式ではありません。"; return null;
    }
    if (departure && !isValidTime(departure)) {
      errorSpan.textContent = "発時刻がhh:mm:ss形式ではありません。"; return null;
    }

    // 駅内の着発時刻順序チェック (addStop内で行う)

    // 4. 駅名重複チェック (現在のリストに対して)
    if (stops.some(stop => stop.station === normStation)) {
        if (!confirm(`【警告】駅名 "${normStation}" は既に追加されています。続行しますか？`)) {
            return null;
        }
    }
    
    return {
      station: normStation,
      arrival: arrival.trim(),
      departure: departure.trim(),
      trackN: normTrackN
    };
  }


  function addStop() {
    const stationEl = document.getElementById("station");
    const arrivalEl = document.getElementById("arrival");
    const departureEl = document.getElementById("departure");
    const trackNEl = document.getElementById("trackN");

    const newStop = validateAndNormalizeStop(
        stationEl.value, 
        arrivalEl.value, 
        departureEl.value, 
        trackNEl.value
    );
    if (!newStop) return;

    // 駅内の着発時刻順序チェック
    if (newStop.arrival && newStop.departure) {
      const arrSec = timeToSeconds(newStop.arrival);
      const depSec = timeToSeconds(newStop.departure);
      if (arrSec !== -1 && depSec !== -1 && arrSec > depSec) {
        document.getElementById("validationError").textContent = "発時刻は着時刻より後にしてください。";
        departureEl.focus();
        return;
      }
    }

    stops.push(newStop);

    stationEl.value = "";
    arrivalEl.value = "";
    departureEl.value = "";
    trackNEl.value = "";

    updateTable();
    updateJSON();
    stationEl.focus();
  }

  // 停車駅の順番を入れ替える
  function moveStop(index, direction) {
    if ((direction === 'up' && index > 0) || (direction === 'down' && index < stops.length - 1)) {
      const newIndex = direction === 'up' ? index - 1 : index + 1;
      [stops[index], stops[newIndex]] = [stops[newIndex], stops[index]];
      
      const consistencyError = checkTimeConsistency();
      if (consistencyError) {
        // 逆転が発生したら元に戻す
        [stops[newIndex], stops[index]] = [stops[index], stops[newIndex]]; 
        alert(consistencyError + "\n順番を元に戻しました。時刻を修正してください。");
      }
      
      updateTable();
      updateJSON();
    }
  }

  function removeStop(index) {
    stops.splice(index, 1);
    updateTable();
    updateJSON();
  }

  function updateTable() {
    const tbody = document.getElementById("stopsTable");
    tbody.innerHTML = "";
    
    let lastTimeSec = -1; // 前の駅の着時刻または発時刻
    
    stops.forEach((stop, i) => {
      let durationDisplay = "";
      const currentTimeSec = timeToSeconds(stop.arrival || stop.departure);

      // 所要時間の計算
      if (i === 0) {
          // 始発駅：発時刻を基準とする
          lastTimeSec = timeToSeconds(stop.departure);
      } else if (currentTimeSec !== -1 && lastTimeSec !== -1) {
          let durationSec = currentTimeSec - lastTimeSec;
          // 24時間以上かかる場合は日数を考慮（ここでは秒数をそのまま表示）
          const h = Math.floor(durationSec / 3600);
          durationSec %= 3600;
          const m = Math.floor(durationSec / 60);
          const s = durationSec % 60;
          
          durationDisplay = `(+${h}h ${m}m ${s}s)`;
          
          // 次の駅のために、現在の駅の発時刻を更新。発がない場合は着時刻
          lastTimeSec = timeToSeconds(stop.departure || stop.arrival);
      } else {
           // 時刻が不完全な場合、所要時間は計算しない
           lastTimeSec = timeToSeconds(stop.departure || stop.arrival);
      }

      const row = `<tr>
        <td>${i + 1}</td>
        <td>${stop.station}</td>
        <td>${stop.arrival}</td>
        <td>${stop.departure}</td>
        <td>${stop.trackN}</td>
        <td class="duration">${durationDisplay}</td>
        <td class="stop-buttons">
          <button class="move-btn" onclick="moveStop(${i}, 'up')" ${i === 0 ? 'disabled' : ''}>▲ 上へ</button>
          <button class="move-btn" onclick="moveStop(${i}, 'down')" ${i === stops.length - 1 ? 'disabled' : ''}>▼ 下へ</button>
          <button onclick="removeStop(${i})">削除</button>
        </td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });

    // 時刻逆転の全体チェック
    const overallError = checkTimeConsistency();
    if (overallError) {
        document.getElementById("validationError").textContent = overallError;
    } else {
        document.getElementById("validationError").textContent = "";
    }
  }

  function updateJSON() {
    const output = {
      trainNumber: document.getElementById("trainNumber").value,
      type: document.getElementById("type").value,
      dayType: document.getElementById("dayType").value,
      startDate: document.getElementById("startDate").value,
      origin: document.getElementById("origin").value,
      destination: document.getElementById("destination").value,
      speed: document.getElementById("speed").value,
      name: document.getElementById("name").value,
      line: document.getElementById("line").value,
      stops: stops
    };
    document.getElementById("jsonOutput").value = JSON.stringify(output, null, 2);
  }

  function copyJson() {
    const jsonText = document.getElementById("jsonOutput").value;
    if (jsonText) {
      navigator.clipboard.writeText(jsonText)
        .then(() => alert("JSONをコピーしました！"))
        .catch(err => console.error('コピー失敗:', err));
    } else {
      alert("JSONが空です。");
    }
  }

  // JSONインポート機能
  function importJson() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    if (!file) {
      alert("ファイルを選択してください。");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        
        // 列車基本情報の反映
        document.getElementById("trainNumber").value = data.trainNumber || '';
        document.getElementById("type").value = data.type || '';
        document.getElementById("dayType").value = data.dayType || '平日';
        document.getElementById("startDate").value = data.startDate || '';
        document.getElementById("origin").value = data.origin || '';
        document.getElementById("destination").value = data.destination || '';
        document.getElementById("speed").value = data.speed || '';
        document.getElementById("name").value = data.name || '';
        document.getElementById("line").value = data.line || '';

        // 停車駅データの反映
        stops = Array.isArray(data.stops) ? data.stops : [];

        alert("データのインポートが完了しました。");
        updateTable();
        updateJSON();
      } catch (error) {
        alert("JSONファイルの解析に失敗しました。ファイル形式を確認してください。");
        console.error("Import Error:", error);
      }
    };
    reader.readAsText(file);
  }


  // 初期ロード
  document.addEventListener('DOMContentLoaded', updateJSON);
</script>
</body>
</html>
