<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, th, td { border: 1px solid #999; border-collapse: collapse; padding: 5px; }
    textarea { width: 100%; height: 200px; }
    input, select, button { margin: 5px; padding: 5px; }
    label { display: inline-block; margin: 5px 0; }
    .error { color: red; font-weight: bold; margin-left: 10px; }
    .stop-buttons button { margin: 0 2px; }
    .move-btn { 
        padding: 2px 5px; 
        font-size: 10px;
        line-height: 1;
        cursor: pointer;
    }
    .duration { font-weight: bold; color: #0066cc; }
    /* ç·¨é›†å¯èƒ½ãªã‚»ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .editable { cursor: pointer; min-width: 50px; } 
    .editable input { width: 90%; border: 1px solid #ccc; padding: 3px; box-sizing: border-box; }
  </style>
</head>
<body>
    <h1>â—‹æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
    <p>ãƒ¢ãƒã‚¤ãƒ«ATOSã«æº–ãšã‚‹æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚</p>

<h2>ãƒ‡ãƒ¼ã‚¿æ“ä½œ</h2>
<input type="file" id="importFile" accept="application/json">
<button onclick="importJson()">ğŸ’¾ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
<button onclick="copyJson()">ğŸ“‹ JSONã‚’ã‚³ãƒ”ãƒ¼</button>
<span id="validationError" class="error"></span>
<hr>

<h2>åˆ—è»ŠåŸºæœ¬æƒ…å ±</h2>
<form id="trainInfoForm">
  <label>åˆ—è»Šç•ªå·: <input id="trainNumber" type="text" onchange="updateJSON()"></label>
  <label>ç¨®åˆ¥: <input id="type" type="text" onchange="updateJSON()"></label>
  <label>å¹³æ—¥/åœŸä¼‘æ—¥: 
    <select id="dayType" onchange="updateJSON()">
      <option value="å¹³æ—¥">å¹³æ—¥</option>
      <option value="åœŸä¼‘æ—¥">åœŸä¼‘æ—¥</option>
    </select>
  </label>
  <label>å§‹ç™ºé§…ç™ºæ—¥: <input id="startDate" type="date" onchange="updateJSON()"></label><br>
  <label>å§‹ç™ºé§…: <input id="origin" type="text" onchange="updateJSON()"></label>
  <label>çµ‚ç€é§…: <input id="destination" type="text" onchange="updateJSON()"></label>
  <label>è·¯ç·šå: <input id="line" type="text" onchange="updateJSON()"></label>
  <label>é€Ÿåº¦ç¨®åˆ¥: <input id="speed" type="text" onchange="updateJSON()"></label>
  <label>åˆ—è»Šå: <input id="name" type="text" onchange="updateJSON()"></label>
</form>
<hr>

<h2>åœè»Šé§…ã®ç·¨é›†ã¨è¿½åŠ </h2>
<table style="width: 100%;">
  <thead>
    <tr><th>é †</th><th>é§…å</th><th>ç€</th><th>ç™º</th><th>ç•ªç·š</th><th>æ‰€è¦æ™‚é–“</th><th>æ“ä½œ</th></tr>
  </thead>
  <tbody id="stopsTable">
    </tbody>
</table>

<div id="addStopForm">
  <label>é§…å: <input id="station" type="text" maxlength="5" placeholder="ä¾‹: å¤§ã€€å®®"></label>
  <label>ç€: <input id="arrival" type="text" placeholder="hh:mm:ss"></label>
  <label>ç™º(é€š): <input id="departure" type="text" placeholder="hh:mm:ss"></label>
  <label>ç•ªç·š: <input id="trackN" type="text" placeholder="ä¾‹: ï¼‘ï¼ç•ª"></label>
  <button onclick="addStop()">è¿½åŠ </button>
</div>
<hr>

<h2>å‡ºåŠ›JSON</h2>
<textarea id="jsonOutput" readonly></textarea>

<br><br>
<h3>ã€æ›¸ãæ–¹ï¼ˆãƒ¢ãƒã‚¤ãƒ«ATOSæº–æ‹ ï¼‰ã€‘</h3>
<ul>
  <li>é§…åãŒï¼’æ–‡å­—ã®å ´åˆã¯ **å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ï¼‘ã¤** ã‚’é–‹ã‘ã¦ãã ã•ã„ã€‚å…¥åŠ›æ™‚ã«è‡ªå‹•ã§æŒ¿å…¥ã‚’è©¦ã¿ã¾ã™ã€‚</li>
  <li>ç€ç™ºç•ªç·šã§ã¯ã€æ•°å­—ã¯**å…¨è§’**ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å…¥åŠ›æ™‚ã«åŠè§’ã¯å…¨è§’ã«è‡ªå‹•å¤‰æ›ã•ã‚Œã¾ã™ã€‚</li>
</ul>

<script>
  let stops = [];

  // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ===

  function isValidTime(timeStr) {
    if (!timeStr) return true;
    return /^([0-9]{2}):([0-5][0-9]):([0-5][0-9])$/.test(timeStr);
  }

  function timeToSeconds(timeStr) {
    if (!timeStr || !isValidTime(timeStr)) return -1;
    const [h, m, s] = timeStr.split(':').map(Number);
    return h * 3600 + m * 60 + s;
  }

  function toZenkaku(str) {
    if (!str) return '';
    return str.replace(/[0-9]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) + 0xFEE0);
    });
  }

  // æ™‚åˆ»ã®å‰å¾Œé–¢ä¿‚ï¼ˆé€†èµ°ï¼‰ãƒã‚§ãƒƒã‚¯
  function checkTimeConsistency() {
    let lastDepartureSec = -1;
    for (let i = 0; i < stops.length; i++) {
        const stop = stops[i];
        
        const currentArrivalSec = timeToSeconds(stop.arrival);
        const currentDepartureSec = timeToSeconds(stop.departure);

        // 1. é§…å†…ã®ãƒã‚§ãƒƒã‚¯ï¼šç€æ™‚åˆ» > ç™ºæ™‚åˆ»ã¯NG
        if (currentArrivalSec !== -1 && currentDepartureSec !== -1 && currentArrivalSec > currentDepartureSec) {
            return `ã€è­¦å‘Šã€‘${stop.station} ã§ç™ºæ™‚åˆ»ãŒç€æ™‚åˆ»ã‚ˆã‚Šæ—©ã„ã§ã™ã€‚`;
        }

        // 2. é§…é–“ã®ãƒã‚§ãƒƒã‚¯ï¼šå‰ã®é§…ã®ç™ºæ™‚åˆ» > ç¾åœ¨ã®é§…ã®ç€/ç™ºæ™‚åˆ»ã¯NG (é€†èµ°)
        if (lastDepartureSec !== -1) {
            if (currentArrivalSec !== -1 && currentArrivalSec < lastDepartureSec) {
                return `ã€è­¦å‘Šã€‘${stop.station} ã®ç€æ™‚åˆ»ãŒå‰ã®é§…ã®ç™ºæ™‚åˆ»ã‚ˆã‚Šæ—©ã„ã§ã™ã€‚`;
            }
            if (currentDepartureSec !== -1 && currentDepartureSec < lastDepartureSec) {
                return `ã€è­¦å‘Šã€‘${stop.station} ã®ç™ºæ™‚åˆ»ãŒå‰ã®é§…ã®ç™ºæ™‚åˆ»ã‚ˆã‚Šæ—©ã„ã§ã™ã€‚`;
            }
        }
        
        if (currentDepartureSec !== -1) {
             lastDepartureSec = currentDepartureSec;
        } else if (currentArrivalSec !== -1 && i !== stops.length - 1) { 
             lastDepartureSec = currentArrivalSec;
        }
    }
    return null;
  }

  function validateAndNormalizeStop(station, arrival, departure, trackN, checkDuplicateIndex = -1) {
    let normStation = station.trim();
    let normTrackN = trackN.trim();
    
    if (!normStation) return { error: "é§…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" };
    
    // é§…åã®å…¥åŠ›è£œåŠ©/ãƒã‚§ãƒƒã‚¯
    if (normStation.length === 2 && !normStation.includes('ã€€')) {
        normStation = normStation[0] + 'ã€€' + normStation[1];
    }
    if (normStation.length > 5) {
         return { error: "é§…åã¯5æ–‡å­—ï¼ˆå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹è¾¼ã¿ï¼‰ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚" };
    }

    // ç•ªç·šã®å…¨è§’æ•°å­—ãƒã‚§ãƒƒã‚¯/å¤‰æ›
    normTrackN = toZenkaku(normTrackN);

    // æ™‚åˆ»ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (arrival && !isValidTime(arrival)) {
      return { error: "ç€æ™‚åˆ»ãŒhh:mm:sså½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" };
    }
    if (departure && !isValidTime(departure)) {
      return { error: "ç™ºæ™‚åˆ»ãŒhh:mm:sså½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚" };
    }
    
    // é§…åé‡è¤‡ãƒã‚§ãƒƒã‚¯ (ç¾åœ¨ã®ãƒªã‚¹ãƒˆã«å¯¾ã—ã¦)
    if (stops.some((stop, i) => i !== checkDuplicateIndex && stop.station === normStation)) {
        // é‡è¤‡ã¯è­¦å‘Šã™ã‚‹ãŒã€å¼·åˆ¶ã¯ã—ãªã„ (ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†æ™‚ã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã•ãªã„)
        // return { error: `é§…å "${normStation}" ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚` };
    }

    return {
      stop: {
        station: normStation,
        arrival: arrival.trim(),
        departure: departure.trim(),
        trackN: normTrackN
      }
    };
  }

  // === åœè»Šé§…ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œ ===

  function addStop() {
    const stationEl = document.getElementById("station");
    const arrivalEl = document.getElementById("arrival");
    const departureEl = document.getElementById("departure");
    const trackNEl = document.getElementById("trackN");
    const errorSpan = document.getElementById("validationError");

    const result = validateAndNormalizeStop(
        stationEl.value, 
        arrivalEl.value, 
        departureEl.value, 
        trackNEl.value, 
        -1 // æ–°è¦è¿½åŠ ã®ãŸã‚ãƒã‚§ãƒƒã‚¯å¯¾è±¡å¤–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã—
    );
    
    if (result.error) {
        errorSpan.textContent = result.error;
        return;
    }
    
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¯ addStop ã®å ´åˆã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ç¢ºèª
    if (stops.some(stop => stop.station === result.stop.station)) {
        if (!confirm(`ã€è­¦å‘Šã€‘é§…å "${result.stop.station}" ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }
    }
    
    stops.push(result.stop);

    stationEl.value = "";
    arrivalEl.value = "";
    departureEl.value = "";
    trackNEl.value = "";

    updateTable();
    updateJSON();
    stationEl.focus();
  }

  function moveStop(index, direction) {
    if ((direction === 'up' && index > 0) || (direction === 'down' && index < stops.length - 1)) {
      const newIndex = direction === 'up' ? index - 1 : index + 1;
      [stops[index], stops[newIndex]] = [stops[newIndex], stops[index]];
      
      const consistencyError = checkTimeConsistency();
      if (consistencyError) {
        [stops[newIndex], stops[index]] = [stops[index], stops[newIndex]]; // é€†è»¢ã—ãŸã‚‰å…ƒã«æˆ»ã™
        alert(consistencyError + "\né †ç•ªã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸã€‚æ™‚åˆ»ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚");
      }
      
      updateTable();
      updateJSON();
    }
  }

  function removeStop(index) {
    stops.splice(index, 1);
    updateTable();
    updateJSON();
  }

  // === ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†å‡¦ç† ===
  
  function handleEdit(event, index, field) {
    const cell = event.currentTarget;
    const currentValue = stops[index][field];
    
    // æ—¢ã«ç·¨é›†ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (cell.querySelector('input')) return;

    cell.innerHTML = '';
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.focus();
    
    // ç¢ºå®šå‡¦ç†
    const commitChange = () => {
        const newValue = input.value.trim();
        const oldStop = stops[index];
        
        // å¤‰æ›´å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼
        const result = validateAndNormalizeStop(
            field === 'station' ? newValue : oldStop.station,
            field === 'arrival' ? newValue : oldStop.arrival,
            field === 'departure' ? newValue : oldStop.departure,
            field === 'trackN' ? newValue : oldStop.trackN,
            index // è‡ªèº«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é™¤å¤–ã—ã¦é‡è¤‡ãƒã‚§ãƒƒã‚¯
        );
        
        const errorSpan = document.getElementById("validationError");
        if (result.error) {
            errorSpan.textContent = `ç·¨é›†ã‚¨ãƒ©ãƒ¼ (${field}): ${result.error}`;
            // å¤‰æ›´å‰ã®å€¤ã§å†æç”»
            cell.innerHTML = currentValue; 
            return;
        }
        
        // å¤‰æ›´ã‚’é©ç”¨
        stops[index] = result.stop; 

        // æ™‚åˆ»é€†è»¢ãƒã‚§ãƒƒã‚¯
        const consistencyError = checkTimeConsistency();
        if (consistencyError) {
            errorSpan.textContent = consistencyError;
        } else {
            errorSpan.textContent = "";
        }

        updateTable();
        updateJSON();
    };

    input.addEventListener('blur', commitChange);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            commitChange();
            e.preventDefault();
        }
        if (e.key === 'Escape') {
             // å¤‰æ›´ã‚’ç ´æ£„ã—ã¦å…ƒã®å€¤ã«æˆ»ã™
             cell.innerHTML = currentValue; 
             e.preventDefault();
        }
    });

    cell.appendChild(input);
  }

  // === UIæ›´æ–°ã¨ãƒ‡ãƒ¼ã‚¿å‡ºåŠ› ===

  function updateTable() {
    const tbody = document.getElementById("stopsTable");
    tbody.innerHTML = "";
    
    let lastTimeSec = -1; 
    
    stops.forEach((stop, i) => {
      let durationDisplay = "";
      const currentTimeSec = timeToSeconds(stop.arrival || stop.departure);

      if (i === 0) {
          lastTimeSec = timeToSeconds(stop.departure);
      } else if (currentTimeSec !== -1 && lastTimeSec !== -1) {
          let durationSec = currentTimeSec - lastTimeSec;
          const h = Math.floor(durationSec / 3600);
          durationSec %= 3600;
          const m = Math.floor(durationSec / 60);
          const s = durationSec % 60;
          
          durationDisplay = `(+${h}h ${m}m ${s}s)`;
          lastTimeSec = timeToSeconds(stop.departure || stop.arrival);
      } else {
           lastTimeSec = timeToSeconds(stop.departure || stop.arrival);
      }

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i + 1}</td>
        <td class="editable station" onclick="handleEdit(event, ${i}, 'station')">${stop.station}</td>
        <td class="editable time" onclick="handleEdit(event, ${i}, 'arrival')">${stop.arrival}</td>
        <td class="editable time" onclick="handleEdit(event, ${i}, 'departure')">${stop.departure}</td>
        <td class="editable track" onclick="handleEdit(event, ${i}, 'trackN')">${stop.trackN}</td>
        <td class="duration">${durationDisplay}</td>
        <td class="stop-buttons">
          <button class="move-btn" onclick="moveStop(${i}, 'up')" ${i === 0 ? 'disabled' : ''}>â–² ä¸Šã¸</button>
          <button class="move-btn" onclick="moveStop(${i}, 'down')" ${i === stops.length - 1 ? 'disabled' : ''}>â–¼ ä¸‹ã¸</button>
          <button onclick="removeStop(${i})">å‰Šé™¤</button>
        </td>
      `;
      tbody.appendChild(row);
    });

    const overallError = checkTimeConsistency();
    document.getElementById("validationError").textContent = overallError || "";
  }

  function updateJSON() {
    const output = {
      trainNumber: document.getElementById("trainNumber").value,
      type: document.getElementById("type").value,
      dayType: document.getElementById("dayType").value,
      startDate: document.getElementById("startDate").value,
      origin: document.getElementById("origin").value,
      destination: document.getElementById("destination").value,
      speed: document.getElementById("speed").value,
      name: document.getElementById("name").value,
      line: document.getElementById("line").value,
      stops: stops
    };
    document.getElementById("jsonOutput").value = JSON.stringify(output, null, 2);
  }

  // === ãƒ‡ãƒ¼ã‚¿I/Oæ©Ÿèƒ½ ===

  function copyJson() {
    const jsonText = document.getElementById("jsonOutput").value;
    if (jsonText) {
      navigator.clipboard.writeText(jsonText)
        .then(() => alert("JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"))
        .catch(err => console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err));
    } else {
      alert("JSONãŒç©ºã§ã™ã€‚");
    }
  }

  function importJson() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    if (!file) {
      alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        
        document.getElementById("trainNumber").value = data.trainNumber || '';
        document.getElementById("type").value = data.type || '';
        document.getElementById("dayType").value = data.dayType || 'å¹³æ—¥';
        document.getElementById("startDate").value = data.startDate || '';
        document.getElementById("origin").value = data.origin || '';
        document.getElementById("destination").value = data.destination || '';
        document.getElementById("speed").value = data.speed || '';
        document.getElementById("name").value = data.name || '';
        document.getElementById("line").value = data.line || '';

        stops = Array.isArray(data.stops) ? data.stops : [];

        alert("ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
        updateTable();
        updateJSON();
      } catch (error) {
        alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        console.error("Import Error:", error);
      }
    };
    reader.readAsText(file);
  }


  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  document.addEventListener('DOMContentLoaded', updateJSON);
</script>
</body>
</html>
