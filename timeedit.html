<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <style>
    :root { --primary: #2563eb; --next: #059669; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; }
    body { font-family: "Segoe UI", Meiryo, sans-serif; padding: 15px; background-color: var(--bg); font-size: 12px; color: #334155; }
    h1 { font-size: 1.5rem; margin: 0 0 15px 0; color: #1e293b; border-bottom: 3px solid var(--primary); display: inline-block; padding-right: 50px; }
    h2 { font-size: 0.9rem; margin: 0 0 8px 0; border-left: 4px solid var(--primary); padding-left: 8px; color: #475569; }

    .btn-group { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 16px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; font-size: 11px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .btn-blue { background: var(--primary); color: white; }
    .btn-green { background: var(--next); color: white; }
    .btn-gray { background: #64748b; color: white; }
    .btn-orange { background: #f59e0b; color: white; }
    .btn-purple { background: #8b5cf6; color: white; }
    .btn-red { background: #ef4444; color: white; }
    .btn-del { background: #b91c1c; color: white; } /* ä¸€æ‹¬å‰Šé™¤ç”¨ */
    button:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }

    .flex-container { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px; }
    .section { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex: 1; min-width: 350px; }
    
    .grid-info { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-info span { display: block; font-size: 10px; color: #64748b; font-weight: bold; margin-bottom: 2px; }

    input { padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; width: 100%; box-sizing: border-box; transition: border 0.2s; }
    input:focus { border-color: var(--primary); outline: none; background: #fff; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 5px; background: #fff; }
    th, td { border: 1px solid var(--border); padding: 6px; text-align: left; }
    th { background: #f8fafc; font-weight: 600; font-size: 11px; color: #64748b; }

    textarea { width: 100%; height: 600px; font-family: "Cascadia Code", "Consolas", monospace; font-size: 12px; border: 1px solid #333; border-radius: 6px; margin-top: 10px; background: #1e1e1e; color: #dcdcdc; padding: 15px; line-height: 1.6; resize: vertical; }
    
    .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; margin-left: auto; font-weight: bold; }
    .hint-msg { font-size: 12px; color: var(--next); font-weight: bold; }
  </style>
</head>
<body>

<h1>æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ä½œæˆãƒ„ãƒ¼ãƒ«</h1>

<div class="btn-group">
  <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">
  <button class="btn-gray" onclick="document.getElementById('importFile').click()">ğŸ’¾ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  <button class="btn-blue" onclick="copyJson()">ğŸ“‹ JSONã‚³ãƒ”ãƒ¼</button>
  <button class="btn-green" onclick="prepareNextSection()">â¡ æ¬¡åŒºé–“ã¸ã‚¹ãƒ©ã‚¤ãƒ‰</button>
  <button class="btn-orange" onclick="quoteLineTemplate()">ğŸ” è·¯ç·šã‹ã‚‰é§…ã‚’å¼•ç”¨</button>
  <button class="btn-purple" onclick="reverseStops()">ğŸ”ƒ é§…é †ã‚’åè»¢</button>
  <button class="btn-del" onclick="clearAllStops()">ğŸ—‘ï¸ é§…ãƒªã‚¹ãƒˆã‚’å…¨å‰Šé™¤</button>
  <span id="actionMessage"></span>
  <span id="loadStatus" class="status-badge" style="background:#fee2e2; color:#ef4444;">Master: Waiting...</span>
</div>

<div class="flex-container">
  <div class="section">
    <h2>1. åˆ—è»ŠåŸºæœ¬æƒ…å ±</h2>
    <div class="grid-info">
      <label><span>åˆ—è»Šç•ªå·</span><input id="trainNumber" type="text" oninput="updateJSON()"></label>
      <label><span>ç¨®åˆ¥</span><input id="type" type="text" oninput="updateJSON()"></label>
      <label><span>å¹³æ—¥/åœŸä¼‘æ—¥</span><input id="dayType" type="text" placeholder="å¹³æ—¥" oninput="updateJSON()"></label>
      <label><span>å§‹ç™ºé§…ç™ºæ—¥</span><input id="startDate" type="date" oninput="updateJSON()"></label>
      <label><span>è·¯ç·šå (å¼•ç”¨ã‚­ãƒ¼)</span><input id="line" type="text" list="lineList" oninput="updateJSON()">
             <p style="font-size:9px; color:#94a3b8; margin:2px 0 0 0;">â€»è·¯ç·šåã‚’å…¥ã‚Œã¦ã‚ªãƒ¬ãƒ³ã‚¸ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨é§…ãƒªã‚¹ãƒˆãŒå‡ºã¾ã™</p>
      </label>
      <label><span>åˆ—è»Šå</span><input id="name" type="text" oninput="updateJSON()"></label>
      <label><span>å§‹ç™ºé§…</span><input id="origin" type="text" oninput="updateJSON()"></label>
      <label><span>çµ‚ç€é§…</span><input id="destination" type="text" oninput="updateJSON()"></label>
    </div>
  </div>

  <div class="section">
    <h2>2. ç¶™èµ°ãƒ»æ¥ç¶šè¨­å®š (Kid)</h2>
    <table>
      <thead><tr><th>æ–¹å‘</th><th>tt (è·¯ç·š)</th><th>tr (åˆ—ç•ª)</th><th>kid (ID)</th></tr></thead>
      <tbody>
        <tr><td><strong>å‰(1)</strong></td><td><input id="tt1" type="text" oninput="updateJSON()"></td><td><input id="tr1" type="text" oninput="updateJSON()"></td><td><input id="kid1" type="text" oninput="updateJSON()"></td></tr>
        <tr><td><strong>æ¬¡(2)</strong></td><td><input id="tt2" type="text" oninput="updateJSON()"></td><td><input id="tr2" type="text" oninput="updateJSON()"></td><td><input id="kid2" type="text" oninput="updateJSON()"></td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="section">
  <h2>3. åœè»Šé§…ãƒ»ç€ç™ºæ™‚åˆ»ãƒ»ç•ªç·š</h2>
  <table id="mainStopsTable">
    <thead><tr><th style="width:30%">é§…å</th><th style="width:20%">åˆ°ç€</th><th style="width:20%">å‡ºç™º</th><th style="width:20%">ç•ªç·š</th><th style="width:10%">å‰Šé™¤</th></tr></thead>
    <tbody id="stopsBody"></tbody>
  </table>
  <div style="display: flex; gap: 5px; margin-top: 10px; background: #eff6ff; padding: 10px; border-radius: 6px; border: 1px dashed var(--primary);">
    <input id="in_station" type="text" placeholder="é§…å" list="stationList" oninput="updateTrackSuggestions('in_station', 'trackSuggestions')">
    <input id="in_arrival" type="text" placeholder="ç€">
    <input id="in_departure" type="text" placeholder="ç™º">
    <input id="in_track" type="text" placeholder="ç•ªç·š" list="trackSuggestions">
    <button class="btn-blue" onclick="addStop()">è¿½åŠ </button>
  </div>
</div>

<div class="section">
    <h2>4. å®Œæˆãƒ‡ãƒ¼ã‚¿å‡ºåŠ› (JSON)</h2>
    <textarea id="jsonOutput" readonly onclick="this.select()"></textarea>
</div>

<datalist id="stationList"></datalist>
<datalist id="lineList"></datalist>
<datalist id="trackSuggestions"></datalist>

<script>
  let stops = [];
  let masterData = [];

  window.onload = async function() {
    const status = document.getElementById('loadStatus');
    try {
      const res = await fetch('T-time/timetables.json');
      if(res.ok) {
        masterData = await res.json();
        const lines = [...new Set(masterData.map(t => t.line))].filter(Boolean).sort();
        const lineL = document.getElementById('lineList');
        lines.forEach(l => lineL.appendChild(new Option(l, l)));
        const stations = [...new Set(masterData.flatMap(t => t.stops.map(s => s.station)))].sort();
        const stationL = document.getElementById('stationList');
        stations.forEach(s => stationL.appendChild(new Option(s, s)));
        status.innerText = "Master: Loaded (" + lines.length + " lines)";
        status.style.background = "#dcfce7";
        status.style.color = "#166534";
      }
    } catch(e) { status.innerText = "Master: Offline"; }
  };

  // é§…ä¸€æ‹¬å‰Šé™¤
  function clearAllStops() {
    if (confirm("ç¾åœ¨ã®åœè»Šé§…ãƒªã‚¹ãƒˆã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      stops = [];
      updateUI();
      showActionMsg("ğŸ—‘ï¸ ãƒªã‚¹ãƒˆã‚’ç©ºã«ã—ã¾ã—ãŸ");
    }
  }

  // è·¯ç·šã‹ã‚‰å¼•ç”¨ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã‚’æœ€é©åŒ–ï¼šæœ€ã‚‚åœè»Šé§…ãŒå¤šã„åˆ—è»Šã‚’å„ªå…ˆï¼‰
  function quoteLineTemplate() {
    const lineName = document.getElementById('line').value;
    if(!lineName) return;
    const trains = masterData.filter(t => t.line === lineName);
    if(trains.length === 0) { alert("ãã®è·¯ç·šã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"); return; }
    if(confirm(`è·¯ç·šã€Œ${lineName}ã€ã‹ã‚‰é§…æ§‹æˆã‚’å¼•ç”¨ã—ã¾ã™ã‹ï¼Ÿ`)) {
      const base = trains.reduce((p, c) => (p.stops.length > c.stops.length) ? p : c);
      stops = base.stops.map(s => ({ station: s.station, arrival: "", departure: "", trackN: s.trackN || "" }));
      document.getElementById("origin").value = base.origin || "";
      document.getElementById("destination").value = base.destination || "";
      updateUI();
      showActionMsg("ğŸ“‹ ãƒ•ãƒ«ã‚¹ã‚¸æ§‹æˆã‚’å¼•ç”¨ã—ã¾ã—ãŸ");
    }
  }

  function reverseStops() {
    if (stops.length === 0) return;
    if (confirm("é§…é †ã‚’åè»¢ã•ã›ã¾ã™ã‹ï¼Ÿ")) {
      stops.reverse();
      stops = stops.map(s => ({ station: s.station, arrival: s.departure, departure: s.arrival, trackN: s.trackN }));
      const oldOrigin = document.getElementById("origin").value;
      document.getElementById("origin").value = document.getElementById("destination").value;
      document.getElementById("destination").value = oldOrigin;
      updateUI();
      showActionMsg("ğŸ”ƒ åè»¢å®Œäº†");
    }
  }

  function updateTrackSuggestions(inputId, listId) {
    const station = document.getElementById(inputId).value;
    const list = document.getElementById(listId);
    list.innerHTML = "";
    if(!station) return;
    const tracks = [...new Set(masterData.flatMap(t => t.stops.filter(s => s.station === station).map(s => s.trackN)))].filter(Boolean);
    tracks.forEach(t => list.appendChild(new Option(t, t)));
  }

  function updateUI() {
    const tbody = document.getElementById("stopsBody");
    tbody.innerHTML = "";
    stops.forEach((stop, i) => {
      const tr = document.createElement("tr");
      const trackDlId = `dl_track_${i}`;
      tr.innerHTML = `
        <td><input type="text" value="${stop.station}" list="stationList" oninput="stops[${i}].station=this.value;updateJSON()"></td>
        <td><input type="text" value="${stop.arrival}" oninput="stops[${i}].arrival=this.value;updateJSON()"></td>
        <td><input type="text" value="${stop.departure}" oninput="stops[${i}].departure=this.value;updateJSON()"></td>
        <td><input type="text" value="${stop.trackN}" list="${trackDlId}" onfocus="createDynamicDatalist(${i}, '${stop.station}')" oninput="stops[${i}].trackN=this.value;updateJSON()">
            <datalist id="${trackDlId}"></datalist></td>
        <td><button class="btn-red" style="padding:2px 6px;" onclick="stops.splice(${i},1);updateUI()">Ã—</button></td>
      `;
      tbody.appendChild(tr);
    });
    updateJSON();
  }

  function createDynamicDatalist(index, stationName) {
    const dl = document.getElementById(`dl_track_${index}`);
    dl.innerHTML = "";
    const tracks = [...new Set(masterData.flatMap(t => t.stops.filter(s => s.station === stationName).map(s => s.trackN)))].filter(Boolean);
    tracks.forEach(t => dl.appendChild(new Option(t, t)));
  }

  function updateJSON() {
    const rawDate = document.getElementById("startDate").value;
    const data = {
      trainNumber: document.getElementById("trainNumber").value,
      type: document.getElementById("type").value,
      dayType: document.getElementById("dayType").value,
      startDate: rawDate ? rawDate.replace(/-/g, '/') : "",
      origin: document.getElementById("origin").value,
      destination: document.getElementById("destination").value,
      speed: "", name: document.getElementById("name").value,
      line: document.getElementById("line").value,
      tt1: document.getElementById("tt1").value, tt2: document.getElementById("tt2").value,
      tr1: document.getElementById("tr1").value, tr2: document.getElementById("tr2").value,
      kid1: document.getElementById("kid1").value, kid2: document.getElementById("kid2").value,
      stops: stops
    };
    document.getElementById("jsonOutput").value = JSON.stringify(data, null, 2);
  }

  function addStop() {
    const s = document.getElementById("in_station").value;
    if(!s) return;
    stops.push({
      station: s,
      arrival: document.getElementById("in_arrival").value,
      departure: document.getElementById("in_departure").value,
      trackN: document.getElementById("in_track").value
    });
    ["in_station", "in_arrival", "in_departure", "in_track"].forEach(id => document.getElementById(id).value = "");
    updateUI();
  }

  function prepareNextSection() {
    const nextTr = document.getElementById("tr2").value;
    if (!nextTr) { alert("æ¬¡åˆ—è»Šç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    document.getElementById("origin").value = document.getElementById("destination").value;
    document.getElementById("trainNumber").value = nextTr;
    document.getElementById("tr1").value = document.getElementById("trainNumber").value;
    document.getElementById("kid1").value = document.getElementById("kid2").value;
    document.getElementById("tt1").value = document.getElementById("tt2").value;
    ["destination", "tr2", "kid2", "tt2"].forEach(id => document.getElementById(id).value = "");
    stops = []; updateUI();
    showActionMsg("â¡ ã‚¹ãƒ©ã‚¤ãƒ‰ã—ã¾ã—ãŸ");
  }

  function handleImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const d = JSON.parse(e.target.result);
        const ids = ["trainNumber","type","dayType","line","name","origin","destination","tt1","tt2","tr1","tr2","kid1","kid2"];
        ids.forEach(id => document.getElementById(id).value = d[id] || "");
        if (d.startDate) document.getElementById("startDate").value = d.startDate.replace(/\//g, '-');
        stops = Array.isArray(d.stops) ? d.stops : [];
        updateUI();
        showActionMsg("ğŸ’¾ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†");
      } catch (err) { alert("JSONè§£æã‚¨ãƒ©ãƒ¼"); }
    };
    reader.readAsText(file);
  }

  function showActionMsg(msg) {
    const el = document.getElementById("actionMessage");
    el.innerHTML = `<span class="hint-msg">${msg}</span>`;
    setTimeout(() => { el.innerHTML = ""; }, 3000);
  }

  function copyJson() {
    document.getElementById("jsonOutput").select();
    document.execCommand("copy");
    alert("ã‚³ãƒ”ãƒ¼å®Œäº†");
  }
</script>
</body>
</html>
