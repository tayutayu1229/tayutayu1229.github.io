<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ•ãƒ©ã‚¤ãƒˆçµ±åˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ï½œèˆªç©ºç®¡åˆ¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€ç¾½ç”°ç‰¹åŒ–ã€‘</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  :root {
    --bg-primary: #020b18;
    --bg-secondary: #041225;
    --bg-card: #071a2e;
    --bg-card2: #091f35;
    --accent-blue: #00d4ff;
    --accent-cyan: #00ffcc;
    --accent-amber: #ffb700;
    --accent-red: #ff3b5c;
    --accent-green: #00e676;
    --text-primary: #e8f4ff;
    --text-secondary: #7aa8cc;
    --text-muted: #3d6a8a;
    --border: rgba(0,212,255,0.15);
    --border-bright: rgba(0,212,255,0.4);
    --glow: 0 0 20px rgba(0,212,255,0.3);
    --glow-amber: 0 0 20px rgba(255,183,0,0.3);
    --glow-red: 0 0 20px rgba(255,59,92,0.3);
    --glow-green: 0 0 20px rgba(0,230,118,0.3);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content:'';
    position:fixed; inset:0;
    background: 
      radial-gradient(ellipse 80% 50% at 20% 10%, rgba(0,80,160,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(0,30,80,0.15) 0%, transparent 50%);
    pointer-events:none; z-index:0;
  }

  /* ===== HEADER ===== */
  header {
    position: sticky; top:0; z-index:100;
    background: rgba(2,11,24,0.95);
    border-bottom: 1px solid var(--border-bright);
    backdrop-filter: blur(20px);
    padding: 0 24px;
    display: flex; align-items: center; gap: 20px;
    height: 60px;
    box-shadow: 0 2px 30px rgba(0,0,0,0.5), 0 1px 0 rgba(0,212,255,0.2);
  }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-size: 16px; font-weight: 900;
    color: var(--accent-blue);
    text-shadow: 0 0 20px rgba(0,212,255,0.7);
    letter-spacing: 2px;
    white-space: nowrap;
  }

  .header-clock {
    font-family: 'Share Tech Mono', monospace;
    font-size: 20px;
    color: var(--accent-cyan);
    text-shadow: 0 0 15px rgba(0,255,204,0.6);
    letter-spacing: 3px;
  }

  .header-date {
    font-size: 12px;
    color: var(--text-secondary);
    letter-spacing: 1px;
  }

  .header-status {
    margin-left: auto;
    display: flex; align-items: center; gap: 16px;
  }

  .api-status-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: var(--text-secondary);
    letter-spacing: 0.5px;
  }

  .api-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent-green);
    box-shadow: 0 0 8px var(--accent-green);
    animation: pulse-dot 2s ease-in-out infinite;
  }
  .api-dot.error { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); animation: none; }
  .api-dot.loading { background: var(--accent-amber); box-shadow: 0 0 8px var(--accent-amber); }

  @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }

  .refresh-btn {
    background: transparent;
    border: 1px solid var(--border-bright);
    color: var(--accent-blue);
    padding: 6px 14px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 12px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
    letter-spacing: 1px;
  }
  .refresh-btn:hover { background: rgba(0,212,255,0.1); box-shadow: var(--glow); }

  /* ===== NAV TABS ===== */
  .nav-tabs {
    display: flex; gap: 0;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    overflow-x: auto;
    position: sticky; top: 60px; z-index:90;
  }

  .nav-tab {
    padding: 12px 20px;
    font-size: 13px; font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
    letter-spacing: 0.5px;
    user-select: none;
  }
  .nav-tab:hover { color: var(--text-secondary); }
  .nav-tab.active {
    color: var(--accent-blue);
    border-bottom-color: var(--accent-blue);
    text-shadow: 0 0 10px rgba(0,212,255,0.5);
  }

  /* ===== MAIN LAYOUT ===== */
  main { padding: 20px 24px; position: relative; z-index:1; }

  .page { display: none; }
  .page.active { display: block; }

  /* ===== KPI CARDS ===== */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .kpi-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }
  .kpi-card::before {
    content:'';
    position:absolute; top:0; left:0; right:0; height:2px;
    background: var(--accent-blue);
    box-shadow: 0 0 15px var(--accent-blue);
  }
  .kpi-card.amber::before { background: var(--accent-amber); box-shadow: 0 0 15px var(--accent-amber); }
  .kpi-card.red::before { background: var(--accent-red); box-shadow: 0 0 15px var(--accent-red); }
  .kpi-card.green::before { background: var(--accent-green); box-shadow: 0 0 15px var(--accent-green); }
  .kpi-card:hover { border-color: var(--border-bright); }

  .kpi-label {
    font-size: 11px; color: var(--text-muted);
    letter-spacing: 1.5px; text-transform: uppercase;
    margin-bottom: 8px;
  }
  .kpi-value {
    font-family: 'Orbitron', sans-serif;
    font-size: 32px; font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
    margin-bottom: 4px;
  }
  .kpi-sub {
    font-size: 11px; color: var(--text-secondary);
  }
  .kpi-delta {
    font-size: 11px;
    padding: 2px 6px; border-radius: 3px;
    display: inline-block; margin-top: 4px;
  }
  .kpi-delta.pos { background: rgba(0,230,118,0.15); color: var(--accent-green); }
  .kpi-delta.neg { background: rgba(255,59,92,0.15); color: var(--accent-red); }

  /* ===== GRID LAYOUT ===== */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .grid-1-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; margin-bottom: 16px; }
  .grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px; }
  @media(max-width:900px) { .grid-2,.grid-3,.grid-1-2,.grid-2-1 { grid-template-columns:1fr; } }

  /* ===== PANEL ===== */
  .panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .panel-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(0,0,0,0.2);
  }

  .panel-title {
    font-size: 13px; font-weight: 700;
    color: var(--accent-blue);
    letter-spacing: 1px;
    display: flex; align-items: center; gap: 8px;
  }
  .panel-title::before {
    content:'';
    width: 4px; height: 14px;
    background: var(--accent-blue);
    box-shadow: 0 0 8px var(--accent-blue);
    border-radius: 2px;
  }

  .panel-body { padding: 16px; }

  /* ===== FILTER BAR ===== */
  .filter-bar {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin-bottom: 14px; align-items: center;
  }

  .filter-select, .filter-input {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 6px 10px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: border-color 0.2s;
    outline: none;
  }
  .filter-select:focus, .filter-input:focus { border-color: var(--accent-blue); }

  .filter-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 6px 12px;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn:hover,.filter-btn.active {
    border-color: var(--accent-blue);
    color: var(--accent-blue);
    background: rgba(0,212,255,0.08);
  }

  /* ===== FLIGHT TABLE ===== */
  .flight-table-wrap { overflow-x: auto; }

  .flight-table {
    width: 100%; border-collapse: collapse;
    font-size: 12px;
  }

  .flight-table th {
    background: rgba(0,0,0,0.4);
    color: var(--text-muted);
    font-weight: 500;
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    letter-spacing: 0.5px;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
  }
  .flight-table th:hover { color: var(--text-secondary); }
  .flight-table th.sorted { color: var(--accent-blue); }

  .flight-table td {
    padding: 9px 12px;
    border-bottom: 1px solid rgba(0,212,255,0.05);
    white-space: nowrap;
  }

  .flight-table tr.flight-row {
    cursor: pointer;
    transition: background 0.15s;
  }
  .flight-table tr.flight-row:hover { background: rgba(0,212,255,0.06); }

  .flight-num {
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px; font-weight: 700;
  }
  .flight-num.jal { color: #e60033; text-shadow: 0 0 8px rgba(230,0,51,0.5); }
  .flight-num.ana { color: #1a56db; text-shadow: 0 0 8px rgba(26,86,219,0.5); }
  .flight-num.hnd { color: var(--accent-cyan); text-shadow: 0 0 8px rgba(0,255,204,0.4); }
  .flight-num.naa { color: var(--accent-amber); text-shadow: 0 0 8px rgba(255,183,0,0.4); }

  .airline-badge {
    display: inline-block;
    padding: 2px 7px; border-radius: 3px;
    font-size: 11px; font-weight: 700;
    letter-spacing: 0.5px;
  }
  .badge-jal { background: rgba(230,0,51,0.15); color: #ff4d6d; border: 1px solid rgba(230,0,51,0.3); }
  .badge-ana { background: rgba(26,86,219,0.15); color: #60a5fa; border: 1px solid rgba(26,86,219,0.3); }
  .badge-hnd { background: rgba(0,255,204,0.1); color: var(--accent-cyan); border: 1px solid rgba(0,255,204,0.3); }
  .badge-naa { background: rgba(255,183,0,0.1); color: var(--accent-amber); border: 1px solid rgba(255,183,0,0.3); }

  .status-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 500;
  }
  .status-ontime { background: rgba(0,230,118,0.12); color: var(--accent-green); border: 1px solid rgba(0,230,118,0.25); }
  .status-delay { background: rgba(255,183,0,0.12); color: var(--accent-amber); border: 1px solid rgba(255,183,0,0.25); }
  .status-cancel { background: rgba(255,59,92,0.12); color: var(--accent-red); border: 1px solid rgba(255,59,92,0.25); }
  .status-inair { background: rgba(0,212,255,0.12); color: var(--accent-blue); border: 1px solid rgba(0,212,255,0.25); }
  .status-arrived { background: rgba(120,120,180,0.12); color: #aab; border: 1px solid rgba(120,120,180,0.25); }
  .status-boarding { background: rgba(160,80,255,0.12); color: #c084fc; border: 1px solid rgba(160,80,255,0.25); }
  .status-unknown { background: rgba(100,100,100,0.12); color: #888; border: 1px solid rgba(100,100,100,0.25); }

  .status-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }

  .time-cell { font-family:'Share Tech Mono',monospace; font-size:13px; color:var(--text-primary); }
  .time-delayed { color:var(--accent-amber); }
  .time-early { color:var(--accent-green); }

  .airport-code {
    font-family:'Share Tech Mono',monospace; font-size:13px;
    color:var(--accent-blue); font-weight:700;
  }

  .gate-cell {
    font-family:'Share Tech Mono',monospace;
    background: rgba(0,212,255,0.08);
    padding: 2px 8px; border-radius:3px;
    color:var(--accent-cyan); font-size:13px;
  }

  /* ===== MODAL ===== */
  .modal-overlay {
    display:none; position:fixed; inset:0; z-index:1000;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    align-items:center; justify-content:center;
  }
  .modal-overlay.open { display:flex; }

  .modal {
    background: var(--bg-card2);
    border: 1px solid var(--border-bright);
    border-radius: 12px;
    width: min(600px,95vw);
    max-height: 85vh; overflow-y:auto;
    box-shadow: 0 0 60px rgba(0,100,200,0.3);
    animation: modal-in 0.2s ease;
  }
  @keyframes modal-in { from{opacity:0;transform:translateY(-20px)} to{opacity:1;transform:translateY(0)} }

  .modal-header {
    display:flex; align-items:center; justify-content:space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    position:sticky; top:0; background:var(--bg-card2); z-index:1;
  }
  .modal-title {
    font-family:'Orbitron',sans-serif; font-size:16px;
    color:var(--accent-blue); letter-spacing:2px;
  }
  .modal-close {
    background:none; border:none; color:var(--text-muted);
    font-size:22px; cursor:pointer; line-height:1;
    transition:color 0.2s;
  }
  .modal-close:hover { color:var(--text-primary); }

  .modal-body { padding: 20px; }

  .detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .detail-item {
    background: var(--bg-secondary);
    border:1px solid var(--border);
    border-radius:6px; padding:12px;
  }
  .detail-label { font-size:10px; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase; margin-bottom:6px; }
  .detail-value { font-size:14px; color:var(--text-primary); font-weight:500; }

  .timeline-row {
    display:flex; align-items:center; gap:12px;
    padding:10px 0; border-bottom:1px solid rgba(0,212,255,0.06);
  }
  .timeline-label { font-size:11px; color:var(--text-muted); width:80px; flex-shrink:0; }
  .timeline-time { font-family:'Share Tech Mono',monospace; font-size:15px; color:var(--text-primary); }
  .timeline-delta { font-size:11px; margin-left:auto; }

  /* ===== CHART PANEL ===== */
  .chart-container { position:relative; height:200px; }
  .chart-container-lg { position:relative; height:280px; }

  /* ===== PEAK / INSIGHT CARDS ===== */
  .insight-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:16px; }
  @media(max-width:700px){ .insight-grid { grid-template-columns:1fr; } }

  .insight-card {
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:8px; padding:16px;
    position:relative; overflow:hidden;
  }
  .insight-card::after {
    content:''; position:absolute; bottom:0; left:0; right:0; height:1px;
    background:linear-gradient(90deg,transparent,var(--accent-blue),transparent);
  }

  .insight-icon { font-size:24px; margin-bottom:8px; }
  .insight-label { font-size:11px; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
  .insight-main { font-size:18px; font-weight:700; color:var(--text-primary); margin-bottom:2px; }
  .insight-sub { font-size:11px; color:var(--text-secondary); }
  .insight-delta { font-size:11px; margin-top:6px; }

  /* ===== SYSTEM STATUS ===== */
  .sys-status-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; }
  .sys-status-item {
    display:flex; align-items:center; gap:10px;
    background:var(--bg-secondary);
    border:1px solid var(--border); border-radius:6px; padding:12px;
  }
  .sys-status-label { font-size:12px; color:var(--text-secondary); flex:1; }
  .sys-status-badge {
    font-size:11px; padding:2px 8px; border-radius:3px; font-weight:600;
  }
  .sys-ok { background:rgba(0,230,118,0.15); color:var(--accent-green); }
  .sys-warn { background:rgba(255,183,0,0.15); color:var(--accent-amber); }
  .sys-err { background:rgba(255,59,92,0.15); color:var(--accent-red); }

  /* ===== LIVE TICKER ===== */
  .ticker-wrap {
    background:rgba(0,0,0,0.4);
    border:1px solid var(--border);
    border-radius:6px; padding:8px 16px;
    margin-bottom:16px;
    display:flex; align-items:center; gap:12px;
    overflow:hidden;
  }
  .ticker-label {
    font-size:10px; letter-spacing:2px; color:var(--accent-amber);
    background:rgba(255,183,0,0.1);
    padding:3px 8px; border-radius:3px;
    white-space:nowrap; flex-shrink:0;
    border:1px solid rgba(255,183,0,0.2);
  }
  .ticker-content {
    font-size:12px; color:var(--text-secondary);
    white-space:nowrap;
    animation:ticker-scroll 30s linear infinite;
    letter-spacing:0.5px;
  }
  @keyframes ticker-scroll { from{transform:translateX(0)} to{transform:translateX(-50%)} }

  /* ===== AIRPORT MAP / HEAT ===== */
  .heatmap-bar {
    display:flex; align-items:center; gap:8px; margin-bottom:6px;
  }
  .heatmap-label { font-size:11px; color:var(--text-secondary); width:60px; flex-shrink:0; }
  .heatmap-bar-inner {
    flex:1; height:14px; border-radius:3px;
    background:linear-gradient(90deg,rgba(0,212,255,0.1),rgba(0,212,255,0.1));
    position:relative; overflow:hidden;
  }
  .heatmap-fill {
    height:100%; border-radius:3px;
    transition:width 1s ease;
  }
  .heatmap-val { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--text-secondary); width:30px; text-align:right; }

  /* ===== SCROLLBAR ===== */
  ::-webkit-scrollbar { width:4px; height:4px; }
  ::-webkit-scrollbar-track { background:var(--bg-primary); }
  ::-webkit-scrollbar-thumb { background:rgba(0,212,255,0.3); border-radius:2px; }

  /* ===== LOADING ===== */
  .loading-row td {
    text-align:center; color:var(--text-muted);
    padding:40px 0; font-size:13px;
  }
  .spinner {
    display:inline-block; width:16px; height:16px;
    border:2px solid rgba(0,212,255,0.2);
    border-top-color:var(--accent-blue);
    border-radius:50%;
    animation:spin 0.8s linear infinite;
    vertical-align:middle; margin-right:8px;
  }
  @keyframes spin { to{transform:rotate(360deg)} }

  /* ===== TIMETABLE ===== */
  .schedule-row { cursor:pointer; }
  .schedule-row:hover td { background:rgba(0,212,255,0.04); }

  .empty-state {
    text-align:center; padding:60px 20px;
    color:var(--text-muted); font-size:13px;
  }
  .empty-state .empty-icon { font-size:40px; margin-bottom:10px; opacity:0.4; }

  /* ===== PROGRESS ===== */
  .progress-bar {
    height:4px; background:rgba(255,255,255,0.08); border-radius:2px; overflow:hidden;
  }
  .progress-fill { height:100%; border-radius:2px; transition:width 1s ease; }

  .tag { 
    display:inline-block; padding:2px 6px; border-radius:3px;
    font-size:10px; border:1px solid;
  }
  .tag-domestic { background:rgba(0,212,255,0.08); color:var(--accent-blue); border-color:rgba(0,212,255,0.2); }
  .tag-intl { background:rgba(255,183,0,0.08); color:var(--accent-amber); border-color:rgba(255,183,0,0.2); }

  /* Data accumulation notification */
  .save-btn {
    background:rgba(0,230,118,0.1); border:1px solid rgba(0,230,118,0.3);
    color:var(--accent-green); padding:5px 12px; border-radius:4px;
    font-size:12px; cursor:pointer; transition:all 0.2s;
  }
  .save-btn:hover { background:rgba(0,230,118,0.2); }

  .toast {
    position:fixed; bottom:24px; right:24px; z-index:9999;
    background:var(--bg-card2); border:1px solid var(--accent-green);
    border-radius:8px; padding:12px 20px; font-size:13px;
    color:var(--accent-green); box-shadow:var(--glow-green);
    animation:toast-in 0.3s ease;
    display:none;
  }
  @keyframes toast-in { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

  /* ===== HND SPECIAL STYLES ===== */
  .hnd-header {
    background: linear-gradient(135deg, rgba(0,60,120,0.6) 0%, rgba(0,20,50,0.8) 100%);
    border: 1px solid rgba(0,212,255,0.3);
    border-radius: 10px;
    padding: 18px 24px;
    margin-bottom: 16px;
    display: flex; align-items: center; gap: 20px;
    position: relative; overflow: hidden;
  }
  .hnd-header::before {
    content:'HND';
    position:absolute; right:20px; top:50%; transform:translateY(-50%);
    font-family:'Orbitron',sans-serif; font-size:64px; font-weight:900;
    color:rgba(0,212,255,0.06); letter-spacing:8px; user-select:none;
  }
  .hnd-logo-text {
    font-family:'Orbitron',sans-serif; font-size:22px; font-weight:900;
    color: var(--accent-blue); text-shadow: 0 0 30px rgba(0,212,255,0.7);
    line-height:1.2;
  }
  .hnd-logo-sub { font-size:11px; color:var(--text-muted); letter-spacing:3px; margin-top:4px; }

  .terminal-tabs {
    display:flex; gap:6px; flex-wrap:wrap; margin-bottom:14px;
  }
  .terminal-tab {
    padding: 7px 18px; border-radius:20px;
    border: 1px solid var(--border);
    font-size: 12px; font-weight:600;
    cursor:pointer; transition:all 0.2s;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
    background: transparent;
  }
  .terminal-tab:hover { border-color:var(--accent-blue); color:var(--accent-blue); }
  .terminal-tab.active {
    background: rgba(0,212,255,0.15);
    border-color: var(--accent-blue);
    color: var(--accent-blue);
    box-shadow: 0 0 12px rgba(0,212,255,0.2);
  }
  .terminal-tab.t1.active { background:rgba(255,183,0,0.15); border-color:var(--accent-amber); color:var(--accent-amber); box-shadow:0 0 12px rgba(255,183,0,0.2); }
  .terminal-tab.t2.active { background:rgba(0,230,118,0.15); border-color:var(--accent-green); color:var(--accent-green); box-shadow:0 0 12px rgba(0,230,118,0.2); }
  .terminal-tab.t3.active { background:rgba(192,132,252,0.15); border-color:#c084fc; color:#c084fc; box-shadow:0 0 12px rgba(192,132,252,0.2); }

  .sort-chips { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
  .sort-chip {
    padding:5px 12px; border-radius:4px; font-size:11px;
    border: 1px solid var(--border); color:var(--text-muted);
    cursor:pointer; transition:all 0.2s; background:transparent;
    white-space:nowrap;
  }
  .sort-chip:hover { border-color:var(--border-bright); color:var(--text-secondary); }
  .sort-chip.active { border-color:var(--accent-blue); color:var(--accent-blue); background:rgba(0,212,255,0.08); }
  .sort-chip.asc::after { content:' â†‘'; }
  .sort-chip.desc::after { content:' â†“'; }

  /* æ¡ˆå†…ãƒãƒŠãƒ¼ */
  .announce-banner {
    background: linear-gradient(90deg, rgba(255,59,92,0.15), rgba(255,59,92,0.05));
    border: 1px solid rgba(255,59,92,0.4);
    border-left: 4px solid var(--accent-red);
    border-radius: 6px; padding: 12px 16px;
    margin-bottom: 12px;
    display:flex; align-items:flex-start; gap:10px;
  }
  .announce-icon { font-size:18px; flex-shrink:0; margin-top:1px; }
  .announce-content { flex:1; }
  .announce-title { font-size:12px; font-weight:700; color:var(--accent-red); margin-bottom:4px; letter-spacing:0.5px; }
  .announce-body { font-size:13px; color:var(--text-primary); line-height:1.6; }
  .announce-time { font-size:10px; color:var(--text-muted); margin-top:4px; font-family:'Share Tech Mono',monospace; }

  .announce-banner.amber { background:linear-gradient(90deg,rgba(255,183,0,0.15),rgba(255,183,0,0.05)); border-color:rgba(255,183,0,0.4); border-left-color:var(--accent-amber); }
  .announce-banner.amber .announce-title { color:var(--accent-amber); }
  .announce-banner.green { background:linear-gradient(90deg,rgba(0,230,118,0.1),rgba(0,230,118,0.03)); border-color:rgba(0,230,118,0.3); border-left-color:var(--accent-green); }
  .announce-banner.green .announce-title { color:var(--accent-green); }
  .announce-banner.blue { background:linear-gradient(90deg,rgba(0,212,255,0.1),rgba(0,212,255,0.03)); border-color:rgba(0,212,255,0.3); border-left-color:var(--accent-blue); }
  .announce-banner.blue .announce-title { color:var(--accent-blue); }

  /* å¤§å‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
  .hnd-kpi-big {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; margin-bottom:16px;
  }
  .hnd-kpi-item {
    background:var(--bg-card); border:1px solid var(--border); border-radius:8px;
    padding:14px 12px; text-align:center; position:relative; overflow:hidden;
    cursor:pointer; transition:border-color 0.2s;
  }
  .hnd-kpi-item:hover { border-color:var(--border-bright); }
  .hnd-kpi-item.clickable:hover { transform:translateY(-1px); }
  .hnd-kpi-num { font-family:'Orbitron',sans-serif; font-size:28px; font-weight:700; line-height:1; margin-bottom:4px; }
  .hnd-kpi-lbl { font-size:10px; color:var(--text-muted); letter-spacing:1px; }

  /* ãƒ•ãƒ©ã‚¤ãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºç”¨ï¼‰ */
  .flight-cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:10px; }
  .flight-card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:8px; padding:14px 16px;
    cursor:pointer; transition:all 0.2s;
    position:relative; overflow:hidden;
  }
  .flight-card:hover { border-color:var(--border-bright); transform:translateY(-2px); box-shadow:var(--glow); }
  .flight-card.cancel { border-left:3px solid var(--accent-red); }
  .flight-card.delay { border-left:3px solid var(--accent-amber); }
  .flight-card.boarding { border-left:3px solid #c084fc; }
  .flight-card.inair { border-left:3px solid var(--accent-blue); }
  .fc-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .fc-num { font-family:'Share Tech Mono',monospace; font-size:16px; font-weight:700; }
  .fc-status { margin-left:auto; }
  .fc-route { display:flex; align-items:center; gap:8px; font-size:13px; }
  .fc-ap { font-family:'Share Tech Mono',monospace; font-size:15px; color:var(--accent-blue); font-weight:700; }
  .fc-arrow { color:var(--text-muted); font-size:12px; }
  .fc-times { display:flex; gap:16px; margin-top:10px; }
  .fc-time-item { flex:1; }
  .fc-time-label { font-size:10px; color:var(--text-muted); margin-bottom:2px; }
  .fc-time-val { font-family:'Share Tech Mono',monospace; font-size:14px; color:var(--text-primary); }
  .fc-info { margin-top:8px; font-size:11px; color:var(--accent-amber); background:rgba(255,183,0,0.08); padding:5px 8px; border-radius:4px; }

  /* æ¡ˆå†…è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ */
  .info-display-panel {
    background: #000814;
    border: 2px solid var(--accent-blue);
    border-radius: 10px;
    padding: 0;
    overflow: hidden;
    margin-bottom: 16px;
  }
  .info-display-header {
    background: var(--accent-blue);
    padding: 8px 20px;
    font-family:'Orbitron',sans-serif;
    font-size:12px; letter-spacing:3px;
    color:#000; font-weight:900;
    display:flex; align-items:center; justify-content:space-between;
  }
  .info-display-body { padding:16px; }
  .info-row {
    display:grid; grid-template-columns:80px 1fr 90px 90px 90px 120px;
    gap:12px; align-items:center;
    padding:10px 12px; border-bottom:1px solid rgba(0,212,255,0.08);
    font-family:'Share Tech Mono',monospace;
    transition:background 0.15s;
    cursor:pointer;
  }
  .info-row:hover { background:rgba(0,212,255,0.05); }
  .info-row.header-row {
    font-size:10px; color:var(--text-muted); letter-spacing:1px;
    padding:6px 12px; border-bottom:1px solid var(--border);
    cursor:default;
  }
  .info-row:hover { background:rgba(0,212,255,0.06); }
  .ir-fn { font-size:14px; font-weight:700; }
  .ir-dest { font-size:13px; color:var(--text-primary); }
  .ir-time { font-size:15px; }
  .ir-gate { font-size:13px; color:var(--accent-cyan); background:rgba(0,255,204,0.08); padding:2px 8px; border-radius:3px; text-align:center; }
  .ir-status { font-size:12px; text-align:center; }

  /* æ¬ èˆªã‚¢ãƒ©ãƒ¼ãƒˆå¤§è¡¨ç¤º */
  .cancel-alert {
    background: rgba(255,59,92,0.08);
    border: 1px solid rgba(255,59,92,0.35);
    border-radius: 8px; padding: 14px 16px;
    display:flex; align-items:center; gap:14px;
    margin-bottom:10px; cursor:pointer; transition:all 0.2s;
  }
  .cancel-alert:hover { background:rgba(255,59,92,0.14); }
  .ca-num { font-family:'Share Tech Mono',monospace; font-size:18px; font-weight:700; color:var(--accent-red); width:80px; flex-shrink:0; }
  .ca-info { flex:1; }
  .ca-route { font-size:13px; color:var(--text-primary); margin-bottom:3px; }
  .ca-detail { font-size:11px; color:var(--text-muted); }
  .ca-badge { flex-shrink:0; }

  /* æ­ä¹—ä¸­å¤§ã‚«ãƒ¼ãƒ‰ */
  .boarding-card {
    background: linear-gradient(135deg, rgba(192,132,252,0.12), rgba(100,50,200,0.08));
    border: 1px solid rgba(192,132,252,0.35);
    border-radius: 8px; padding:16px;
    cursor:pointer; transition:all 0.2s;
  }
  .boarding-card:hover { border-color:rgba(192,132,252,0.6); box-shadow:0 0 20px rgba(192,132,252,0.15); }
  .bc-top { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
  .bc-num { font-family:'Share Tech Mono',monospace; font-size:20px; font-weight:700; color:#c084fc; }
  .bc-gate-big { font-family:'Share Tech Mono',monospace; font-size:28px; font-weight:700; color:var(--accent-cyan); margin-left:auto; }
  .bc-gate-label { font-size:10px; color:var(--text-muted); letter-spacing:1px; text-align:right; }
  .bc-route { font-size:14px; color:var(--text-primary); margin-bottom:8px; }
  .bc-times { display:flex; gap:16px; }
  .bc-time { }
  .bc-time-label { font-size:10px; color:var(--text-muted); }
  .bc-time-val { font-family:'Share Tech Mono',monospace; font-size:15px; }

  .hnd-section-title {
    font-size:11px; color:var(--accent-blue); letter-spacing:2px;
    text-transform:uppercase; font-weight:700;
    padding:8px 0 6px; margin-bottom:10px;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:8px;
  }
  .hnd-section-title .count-badge {
    background:rgba(0,212,255,0.15); color:var(--accent-blue);
    padding:1px 8px; border-radius:10px; font-size:12px; font-weight:700;
  }
  .hnd-section-title.red { color:var(--accent-red); }
  .hnd-section-title.red .count-badge { background:rgba(255,59,92,0.15); color:var(--accent-red); }
  .hnd-section-title.amber { color:var(--accent-amber); }
  .hnd-section-title.amber .count-badge { background:rgba(255,183,0,0.15); color:var(--accent-amber); }
  .hnd-section-title.purple { color:#c084fc; }
  .hnd-section-title.purple .count-badge { background:rgba(192,132,252,0.15); color:#c084fc; }
  .hnd-section-title.green { color:var(--accent-green); }
  .hnd-section-title.green .count-badge { background:rgba(0,230,118,0.15); color:var(--accent-green); }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">âœˆ FLIGHT CTRL</div>
  <div>
    <div class="header-clock" id="clock">--:--:--</div>
    <div class="header-date" id="dateStr">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
  <div class="header-status">
    <div class="api-status-item"><div class="api-dot loading" id="dot-jal"></div> JAL API</div>
    <div class="api-status-item"><div class="api-dot loading" id="dot-ana"></div> ANA API</div>
    <div class="api-status-item"><div class="api-dot loading" id="dot-hnd"></div> HND-TIAT</div>
    <div class="api-status-item"><div class="api-dot loading" id="dot-naa"></div> NAA</div>
    <button class="refresh-btn" onclick="fetchAllData()">âŸ³ æ›´æ–°</button>
    <button class="save-btn" onclick="saveSnapshot()">ğŸ’¾ ä¿å­˜</button>
  </div>
</header>

<!-- NAV TABS -->
<div class="nav-tabs">
  <div class="nav-tab active" onclick="showPage('dashboard',this)">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
  <div class="nav-tab" onclick="showPage('hnd',this)" style="color:#00d4ff;font-weight:700">âœˆ ç¾½ç”°ç‰¹åŒ–</div>
  <div class="nav-tab" onclick="showPage('departures',this)">ğŸ›« å‡ºç™ºä¾¿</div>
  <div class="nav-tab" onclick="showPage('arrivals',this)">ğŸ›¬ åˆ°ç€ä¾¿</div>
  <div class="nav-tab" onclick="showPage('alerts',this)">ğŸš¨ ç•°å¸¸ä¸€è¦§</div>
  <div class="nav-tab" onclick="showPage('schedule',this)">ğŸ“… æ™‚åˆ»è¡¨</div>
  <div class="nav-tab" onclick="showPage('analytics',this)">ğŸ“Š åˆ†æ</div>
  <div class="nav-tab" onclick="showPage('history',this)">ğŸ—„ å±¥æ­´</div>
  <div class="nav-tab" onclick="showPage('system',this)">âš™ ã‚·ã‚¹ãƒ†ãƒ </div>
</div>

<main>

<!-- ============ DASHBOARD PAGE ============ -->
<div class="page active" id="page-dashboard">

  <!-- Ticker -->
  <div class="ticker-wrap">
    <div class="ticker-label">LIVE</div>
    <div class="ticker-content" id="ticker-text">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­... &nbsp;&nbsp;&nbsp; ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­... &nbsp;&nbsp;&nbsp;</div>
  </div>

  <!-- KPI Grid -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-label">ç·ãƒ•ãƒ©ã‚¤ãƒˆæ•°</div>
      <div class="kpi-value" id="kpi-total">-</div>
      <div class="kpi-sub">æœ¬æ—¥ã®å…¨ä¾¿</div>
    </div>
    <div class="kpi-card amber">
      <div class="kpi-label">é…å»¶ä¾¿æ•°</div>
      <div class="kpi-value" id="kpi-delay">-</div>
      <div class="kpi-sub" id="kpi-delay-pct">-</div>
    </div>
    <div class="kpi-card red">
      <div class="kpi-label">æ¬ èˆªä¾¿æ•°</div>
      <div class="kpi-value" id="kpi-cancel">-</div>
      <div class="kpi-sub" id="kpi-cancel-pct">-</div>
    </div>
    <div class="kpi-card green">
      <div class="kpi-label">å®šæ™‚ç‡</div>
      <div class="kpi-value" id="kpi-ontime">-</div>
      <div class="kpi-sub">ã‚ªãƒ³ã‚¿ã‚¤ãƒ ãƒ¬ã‚¤ãƒˆ</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">å‡ºç™ºä¾¿</div>
      <div class="kpi-value" id="kpi-dep">-</div>
      <div class="kpi-sub">ç¾åœ¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">åˆ°ç€ä¾¿</div>
      <div class="kpi-value" id="kpi-arr">-</div>
      <div class="kpi-sub">ç¾åœ¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </div>
    </div>
  </div>

  <!-- Insights -->
  <div class="insight-grid">
    <div class="insight-card">
      <div class="insight-icon">â°</div>
      <div class="insight-label">ãƒ”ãƒ¼ã‚¯æ··é›‘æ™‚é–“å¸¯</div>
      <div class="insight-main" id="peak-time">16:00 - 18:00</div>
      <div class="insight-sub">æœ€å¤šä¾¿æ•°æ™‚é–“</div>
      <div class="insight-delta"><span class="kpi-delta neg">+12% vs å…ˆé€±</span></div>
    </div>
    <div class="insight-card">
      <div class="insight-icon">â±</div>
      <div class="insight-label">å¹³å‡é…å»¶æ™‚é–“</div>
      <div class="insight-main" id="avg-delay">-- åˆ†</div>
      <div class="insight-sub">å…¨é…å»¶ä¾¿ã®å¹³å‡</div>
      <div class="insight-delta" id="avg-delay-delta"></div>
    </div>
    <div class="insight-card">
      <div class="insight-icon">ğŸ†</div>
      <div class="insight-label">æœ€ç¹å¿™ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</div>
      <div class="insight-main" id="busiest-terminal">HND T3</div>
      <div class="insight-sub" id="busiest-count">-- ä¾¿ / æœ¬æ—¥</div>
      <div class="insight-delta"><span class="kpi-delta pos">å›½éš›ç·šä¸»åŠ›</span></div>
    </div>
  </div>

  <div class="grid-2">
    <!-- Status by Airline -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">èˆªç©ºä¼šç¤¾åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
      </div>
      <div class="panel-body" id="airline-status-body">
        <div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <!-- Airport Load -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">ç©ºæ¸¯åˆ¥ä¾¿æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
      </div>
      <div class="panel-body" id="airport-heatmap">
        <div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <!-- Recent Departures -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">ç›´è¿‘å‡ºç™ºä¾¿ï¼ˆç¾åœ¨æ™‚åˆ»é †ï¼‰</div>
      </div>
      <div class="panel-body" style="padding:0">
        <div class="flight-table-wrap">
          <table class="flight-table">
            <thead>
              <tr>
                <th>ä¾¿å</th><th>è¡Œãå…ˆ</th><th>å®šåˆ»</th><th>å®Ÿç¸¾</th><th>çŠ¶æ…‹</th>
              </tr>
            </thead>
            <tbody id="dash-dep-tbody">
              <tr class="loading-row"><td colspan="5"><span class="spinner"></span>èª­ã¿è¾¼ã¿ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent Arrivals -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">ç›´è¿‘åˆ°ç€ä¾¿ï¼ˆç¾åœ¨æ™‚åˆ»é †ï¼‰</div>
      </div>
      <div class="panel-body" style="padding:0">
        <div class="flight-table-wrap">
          <table class="flight-table">
            <thead>
              <tr>
                <th>ä¾¿å</th><th>å‡ºç™ºåœ°</th><th>å®šåˆ»</th><th>å®Ÿç¸¾</th><th>çŠ¶æ…‹</th>
              </tr>
            </thead>
            <tbody id="dash-arr-tbody">
              <tr class="loading-row"><td colspan="5"><span class="spinner"></span>èª­ã¿è¾¼ã¿ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============ HND SPECIAL PAGE ============ -->
<div class="page" id="page-hnd">

  <!-- HND Header -->
  <div class="hnd-header">
    <div style="font-size:40px">âœˆ</div>
    <div>
      <div class="hnd-logo-text">ç¾½ç”°ç©ºæ¸¯<br>ãƒ•ãƒ©ã‚¤ãƒˆç®¡åˆ¶ã‚»ãƒ³ã‚¿ãƒ¼</div>
      <div class="hnd-logo-sub">TOKYO INTERNATIONAL AIRPORT â€” HANEDA</div>
    </div>
    <div style="margin-left:auto;text-align:right;z-index:1">
      <div style="font-size:11px;color:var(--text-muted);letter-spacing:1px;margin-bottom:6px">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿</div>
      <div class="terminal-tabs" style="justify-content:flex-end;margin-bottom:0">
        <button class="terminal-tab active" onclick="setHndTerminal('all',this)">å…¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</button>
        <button class="terminal-tab t1" onclick="setHndTerminal('1',this)">T1 ç¬¬ä¸€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</button>
        <button class="terminal-tab t2" onclick="setHndTerminal('2',this)">T2 ç¬¬äºŒã‚¿ãƒ¼ãƒŸãƒŠãƒ«</button>
        <button class="terminal-tab t3" onclick="setHndTerminal('3',this)">T3 å›½éš›ç·šã‚¿ãƒ¼ãƒŸãƒŠãƒ«</button>
      </div>
    </div>
  </div>

  <!-- HND KPI -->
  <div class="hnd-kpi-big">
    <div class="hnd-kpi-item clickable" onclick="hndQuickFilter('all')">
      <div class="hnd-kpi-num" style="color:var(--accent-blue)" id="hnd-kpi-total">-</div>
      <div class="hnd-kpi-lbl">ç·ä¾¿æ•°ï¼ˆç¾½ç”°ï¼‰</div>
    </div>
    <div class="hnd-kpi-item clickable" onclick="hndQuickFilter('dep')">
      <div class="hnd-kpi-num" style="color:var(--accent-cyan)" id="hnd-kpi-dep">-</div>
      <div class="hnd-kpi-lbl">å‡ºç™ºä¾¿</div>
    </div>
    <div class="hnd-kpi-item clickable" onclick="hndQuickFilter('arr')">
      <div class="hnd-kpi-num" style="color:var(--accent-green)" id="hnd-kpi-arr">-</div>
      <div class="hnd-kpi-lbl">åˆ°ç€ä¾¿</div>
    </div>
    <div class="hnd-kpi-item clickable" onclick="hndQuickFilter('boarding')">
      <div class="hnd-kpi-num" style="color:#c084fc" id="hnd-kpi-boarding">-</div>
      <div class="hnd-kpi-lbl">æ­ä¹—ä¸­</div>
    </div>
    <div class="hnd-kpi-item clickable" onclick="hndQuickFilter('inair')">
      <div class="hnd-kpi-num" style="color:var(--accent-blue)" id="hnd-kpi-inair">-</div>
      <div class="hnd-kpi-lbl">é£›è¡Œä¸­</div>
    </div>
    <div class="hnd-kpi-item clickable" onclick="hndQuickFilter('delay')">
      <div class="hnd-kpi-num" style="color:var(--accent-amber)" id="hnd-kpi-delay">-</div>
      <div class="hnd-kpi-lbl">é…å»¶ä¾¿</div>
    </div>
    <div class="hnd-kpi-item clickable" onclick="hndQuickFilter('cancel')">
      <div class="hnd-kpi-num" style="color:var(--accent-red)" id="hnd-kpi-cancel">-</div>
      <div class="hnd-kpi-lbl">æ¬ èˆªä¾¿</div>
    </div>
    <div class="hnd-kpi-item">
      <div class="hnd-kpi-num" style="color:var(--accent-green)" id="hnd-kpi-ontime">-%</div>
      <div class="hnd-kpi-lbl">å®šæ™‚ç‡</div>
    </div>
  </div>

  <!-- ãŠå®¢æ§˜æ¡ˆå†…æƒ…å ±ãƒãƒŠãƒ¼ -->
  <div id="hnd-announce-area" style="margin-bottom:16px"></div>

  <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ãƒ»æ–¹å‘åˆ‡æ›¿ -->
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap">
    <div style="font-size:11px;color:var(--text-muted);letter-spacing:1px">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</div>
    <div class="terminal-tabs" style="margin-bottom:0">
      <button class="terminal-tab active" onclick="setHndView('infoboard',this)">ğŸ“‹ æ¡ˆå†…æ¿</button>
      <button class="terminal-tab" onclick="setHndView('cards',this)">ğŸƒ ã‚«ãƒ¼ãƒ‰</button>
      <button class="terminal-tab" onclick="setHndView('table',this)">ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«</button>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <div style="font-size:11px;color:var(--text-muted)">æ–¹å‘ï¼š</div>
      <button class="terminal-tab active" id="hnd-dir-both" onclick="setHndDir('both',this)">å‡ºç™ºï¼‹åˆ°ç€</button>
      <button class="terminal-tab" id="hnd-dir-dep" onclick="setHndDir('dep',this)">å‡ºç™ºã®ã¿</button>
      <button class="terminal-tab" id="hnd-dir-arr" onclick="setHndDir('arr',this)">åˆ°ç€ã®ã¿</button>
    </div>
  </div>

  <!-- ã‚½ãƒ¼ãƒˆãƒãƒƒãƒ— -->
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">
    <div style="font-size:11px;color:var(--text-muted);letter-spacing:1px;flex-shrink:0">ä¸¦ã³é †ï¼š</div>
    <div class="sort-chips" id="hnd-sort-chips">
      <button class="sort-chip active asc" onclick="setHndSort('time',this)">å®šåˆ»æ™‚åˆ»</button>
      <button class="sort-chip" onclick="setHndSort('flightNum',this)">ä¾¿å</button>
      <button class="sort-chip" onclick="setHndSort('airline',this)">èˆªç©ºä¼šç¤¾</button>
      <button class="sort-chip" onclick="setHndSort('status',this)">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
      <button class="sort-chip" onclick="setHndSort('delay',this)">é…å»¶æ™‚é–“</button>
      <button class="sort-chip" onclick="setHndSort('destination',this)">è¡Œãå…ˆ</button>
      <button class="sort-chip" onclick="setHndSort('terminal',this)">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</button>
      <button class="sort-chip" onclick="setHndSort('gate',this)">æ­ä¹—å£</button>
      <button class="sort-chip" onclick="setHndSort('aircraft',this)">æ©Ÿæ</button>
      <button class="sort-chip" onclick="setHndSort('type',this)">å›½å†…/å›½éš›</button>
    </div>
    <input class="filter-input" type="text" placeholder="ä¾¿åãƒ»è¡Œãå…ˆãƒ»ã‚²ãƒ¼ãƒˆæ¤œç´¢..." id="hnd-search" oninput="renderHnd()" style="margin-left:auto;width:220px">
  </div>

  <!-- HND ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div id="hnd-main-content">
    <div style="text-align:center;padding:40px;color:var(--text-muted)"><span class="spinner"></span>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

</div>

<!-- ============ ALERTS PAGE ============ -->
<div class="page" id="page-alerts">

  <div style="margin-bottom:12px">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div style="font-size:11px;color:var(--text-muted);letter-spacing:1px">ç©ºæ¸¯ãƒ•ã‚£ãƒ«ã‚¿ï¼š</div>
      <button class="terminal-tab active" onclick="setAlertAirport('all',this)">å…¨ç©ºæ¸¯</button>
      <button class="terminal-tab t1" onclick="setAlertAirport('HND',this)">ç¾½ç”°ã®ã¿</button>
      <button class="terminal-tab t3" onclick="setAlertAirport('NRT',this)">æˆç”°ã®ã¿</button>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
    <!-- æ¬ èˆªä¾¿ -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title" style="color:var(--accent-red)">ğŸš« æ¬ èˆªä¾¿ä¸€è¦§</div>
        <span style="font-size:13px;font-weight:700;color:var(--accent-red)" id="cancel-count-badge">- ä»¶</span>
      </div>
      <div id="cancel-list-area" style="padding:12px;max-height:450px;overflow-y:auto">
        <div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px"><span class="spinner"></span>èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    <!-- é…å»¶ä¾¿ -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title" style="color:var(--accent-amber)">âš  é…å»¶ä¾¿ä¸€è¦§</div>
        <span style="font-size:13px;font-weight:700;color:var(--accent-amber)" id="delay-count-badge">- ä»¶</span>
      </div>
      <div id="delay-list-area" style="padding:12px;max-height:450px;overflow-y:auto">
        <div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px"><span class="spinner"></span>èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <!-- æ­ä¹—ä¸­ -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title" style="color:#c084fc">ğŸšª æ­ä¹—ä¸­ä¾¿ä¸€è¦§</div>
        <span style="font-size:13px;font-weight:700;color:#c084fc" id="boarding-count-badge">- ä»¶</span>
      </div>
      <div id="boarding-list-area" style="padding:12px;max-height:420px;overflow-y:auto">
        <div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px"><span class="spinner"></span>èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    <!-- é£›è¡Œä¸­ -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title" style="color:var(--accent-blue)">âœˆ é£›è¡Œä¸­ä¾¿ä¸€è¦§</div>
        <span style="font-size:13px;font-weight:700;color:var(--accent-blue)" id="inair-count-badge">- ä»¶</span>
      </div>
      <div id="inair-list-area" style="padding:12px;max-height:420px;overflow-y:auto">
        <div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px"><span class="spinner"></span>èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
</div>

<!-- ============ DEPARTURES PAGE ============ -->
<div class="page" id="page-departures">
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">å‡ºç™ºä¾¿ä¸€è¦§</div>
      <span style="font-size:11px;color:var(--text-muted)" id="dep-count">- ä»¶</span>
    </div>
    <div class="panel-body">
      <div class="filter-bar">
        <select class="filter-select" id="dep-filter-airline" onchange="renderDepartures()">
          <option value="">å…¨èˆªç©ºä¼šç¤¾</option>
          <option value="JAL">JAL</option>
          <option value="ANA">ANA</option>
          <option value="HND-TIAT">HND-TIAT</option>
          <option value="NAA">NAAæˆç”°</option>
        </select>
        <select class="filter-select" id="dep-filter-airport" onchange="renderDepartures()">
          <option value="">å…¨ç©ºæ¸¯</option>
          <option value="HND">ç¾½ç”°</option>
          <option value="NRT">æˆç”°</option>
        </select>
        <select class="filter-select" id="dep-filter-status" onchange="renderDepartures()">
          <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
          <option value="delay">é…å»¶</option>
          <option value="cancel">æ¬ èˆª</option>
          <option value="ontime">å®šåˆ»</option>
          <option value="inair">é£›è¡Œä¸­</option>
        </select>
        <select class="filter-select" id="dep-filter-type" onchange="renderDepartures()">
          <option value="">å›½å†…/å›½éš›</option>
          <option value="domestic">å›½å†…ç·š</option>
          <option value="intl">å›½éš›ç·š</option>
        </select>
        <input class="filter-input" type="text" placeholder="ä¾¿åãƒ»ç©ºæ¸¯æ¤œç´¢..." id="dep-search" oninput="renderDepartures()">
        <button class="filter-btn active" onclick="setDepSort('time')" id="sort-time-btn">â± æ™‚åˆ»é †</button>
        <button class="filter-btn" onclick="setDepSort('airline')" id="sort-airline-btn">âœˆ èˆªç©ºä¼šç¤¾é †</button>
        <button class="filter-btn" onclick="setDepSort('status')" id="sort-status-btn">ğŸ“‹ çŠ¶æ…‹é †</button>
      </div>
      <div class="flight-table-wrap">
        <table class="flight-table">
          <thead>
            <tr>
              <th onclick="setDepSort('num')">ä¾¿å</th>
              <th>èˆªç©ºä¼šç¤¾</th>
              <th>å‡ºç™ºç©ºæ¸¯</th>
              <th>ç›®çš„åœ°</th>
              <th onclick="setDepSort('time')">å®šåˆ»å‡ºç™º</th>
              <th>å®Ÿç¸¾å‡ºç™º</th>
              <th>äºˆå®šå‡ºç™º</th>
              <th>æ­ä¹—å£</th>
              <th>æ©Ÿæ</th>
              <th>çŠ¶æ…‹</th>
              <th>åŒºåˆ†</th>
            </tr>
          </thead>
          <tbody id="dep-tbody">
            <tr class="loading-row"><td colspan="11"><span class="spinner"></span>ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ============ ARRIVALS PAGE ============ -->
<div class="page" id="page-arrivals">
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">åˆ°ç€ä¾¿ä¸€è¦§</div>
      <span style="font-size:11px;color:var(--text-muted)" id="arr-count">- ä»¶</span>
    </div>
    <div class="panel-body">
      <div class="filter-bar">
        <select class="filter-select" id="arr-filter-airline" onchange="renderArrivals()">
          <option value="">å…¨èˆªç©ºä¼šç¤¾</option>
          <option value="JAL">JAL</option>
          <option value="ANA">ANA</option>
          <option value="HND-TIAT">HND-TIAT</option>
          <option value="NAA">NAAæˆç”°</option>
        </select>
        <select class="filter-select" id="arr-filter-airport" onchange="renderArrivals()">
          <option value="">å…¨ç©ºæ¸¯</option>
          <option value="HND">ç¾½ç”°</option>
          <option value="NRT">æˆç”°</option>
        </select>
        <select class="filter-select" id="arr-filter-status" onchange="renderArrivals()">
          <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
          <option value="delay">é…å»¶</option>
          <option value="cancel">æ¬ èˆª</option>
          <option value="ontime">å®šåˆ»</option>
        </select>
        <input class="filter-input" type="text" placeholder="ä¾¿åãƒ»ç©ºæ¸¯æ¤œç´¢..." id="arr-search" oninput="renderArrivals()">
      </div>
      <div class="flight-table-wrap">
        <table class="flight-table">
          <thead>
            <tr>
              <th>ä¾¿å</th>
              <th>èˆªç©ºä¼šç¤¾</th>
              <th>åˆ°ç€ç©ºæ¸¯</th>
              <th>å‡ºç™ºåœ°</th>
              <th>å®šåˆ»åˆ°ç€</th>
              <th>å®Ÿç¸¾åˆ°ç€</th>
              <th>äºˆå®šåˆ°ç€</th>
              <th>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</th>
              <th>æ©Ÿæ</th>
              <th>çŠ¶æ…‹</th>
              <th>åŒºåˆ†</th>
            </tr>
          </thead>
          <tbody id="arr-tbody">
            <tr class="loading-row"><td colspan="11"><span class="spinner"></span>ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ============ SCHEDULE PAGE ============ -->
<div class="page" id="page-schedule">
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">ãƒ•ãƒ©ã‚¤ãƒˆæ™‚åˆ»è¡¨</div>
      <span style="font-size:11px;color:var(--text-muted)" id="sched-count">- ä»¶</span>
    </div>
    <div class="panel-body">
      <div class="filter-bar">
        <select class="filter-select" id="sched-filter-airline" onchange="renderSchedule()">
          <option value="">å…¨èˆªç©ºä¼šç¤¾</option>
          <option value="JAL">JAL</option>
          <option value="ANA">ANA</option>
          <option value="HND-TIAT">HND-TIAT</option>
        </select>
        <select class="filter-select" id="sched-filter-origin" onchange="renderSchedule()">
          <option value="">å‡ºç™ºç©ºæ¸¯ï¼ˆå…¨ã¦ï¼‰</option>
          <option value="HND">ç¾½ç”°</option>
          <option value="NRT">æˆç”°</option>
          <option value="CTS">æ–°åƒæ­³</option>
          <option value="OKA">é‚£è¦‡</option>
          <option value="FUK">ç¦å²¡</option>
          <option value="KIX">é–¢è¥¿å›½éš›</option>
          <option value="NGO">ä¸­éƒ¨</option>
        </select>
        <select class="filter-select" id="sched-filter-dest" onchange="renderSchedule()">
          <option value="">ç›®çš„ç©ºæ¸¯ï¼ˆå…¨ã¦ï¼‰</option>
          <option value="HND">ç¾½ç”°</option>
          <option value="NRT">æˆç”°</option>
          <option value="CTS">æ–°åƒæ­³</option>
          <option value="OKA">é‚£è¦‡</option>
          <option value="FUK">ç¦å²¡</option>
          <option value="KIX">é–¢è¥¿å›½éš›</option>
          <option value="NGO">ä¸­éƒ¨</option>
        </select>
        <input class="filter-input" type="text" placeholder="ä¾¿åæ¤œç´¢..." id="sched-search" oninput="renderSchedule()">
      </div>
      <div class="flight-table-wrap">
        <table class="flight-table">
          <thead>
            <tr>
              <th>ä¾¿å</th>
              <th>èˆªç©ºä¼šç¤¾</th>
              <th>å‡ºç™ºç©ºæ¸¯</th>
              <th>åˆ°ç€ç©ºæ¸¯</th>
              <th>å‡ºç™ºæ™‚åˆ»</th>
              <th>åˆ°ç€æ™‚åˆ»</th>
              <th>æ©Ÿæ</th>
              <th>é‹èˆªæ—¥</th>
              <th>æœ‰åŠ¹æœŸé–“</th>
            </tr>
          </thead>
          <tbody id="sched-tbody">
            <tr class="loading-row"><td colspan="9"><span class="spinner"></span>ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ============ ANALYTICS PAGE ============ -->
<div class="page" id="page-analytics">
  <div class="kpi-grid" style="margin-bottom:20px">
    <div class="kpi-card green">
      <div class="kpi-label">æœ¬æ—¥ã®å®šæ™‚ç‡</div>
      <div class="kpi-value" id="ana-ontime">-</div>
      <div class="kpi-sub">ã‚ªãƒ³ã‚¿ã‚¤ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</div>
    </div>
    <div class="kpi-card amber">
      <div class="kpi-label">é…å»¶ç‡</div>
      <div class="kpi-value" id="ana-delay-rate">-</div>
      <div class="kpi-sub">å…¨ä¾¿ã«å ã‚ã‚‹å‰²åˆ</div>
    </div>
    <div class="kpi-card red">
      <div class="kpi-label">æ¬ èˆªç‡</div>
      <div class="kpi-value" id="ana-cancel-rate">-</div>
      <div class="kpi-sub">å…¨ä¾¿ã«å ã‚ã‚‹å‰²åˆ</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">é£›è¡Œä¸­ä¾¿æ•°</div>
      <div class="kpi-value" id="ana-inair">-</div>
      <div class="kpi-sub">ç¾åœ¨ã®é£›è¡Œä¸­</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <div class="panel-header"><div class="panel-title">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒï¼ˆå‡ºç™ºä¾¿ï¼‰</div></div>
      <div class="panel-body">
        <div class="chart-container-lg">
          <canvas id="chart-status-pie"></canvas>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><div class="panel-title">æ™‚é–“å¸¯åˆ¥ä¾¿æ•°ï¼ˆ24æ™‚é–“ï¼‰</div></div>
      <div class="panel-body">
        <div class="chart-container-lg">
          <canvas id="chart-hourly"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <div class="panel-header"><div class="panel-title">èˆªç©ºä¼šç¤¾åˆ¥ä¾¿æ•°æ¯”è¼ƒ</div></div>
      <div class="panel-body">
        <div class="chart-container">
          <canvas id="chart-airline-bar"></canvas>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header"><div class="panel-title">å‡ºç™º vs åˆ°ç€ æ™‚é–“å¸¯åˆ¥</div></div>
      <div class="panel-body">
        <div class="chart-container">
          <canvas id="chart-dep-arr-line"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-bottom:16px">
    <div class="panel-header"><div class="panel-title">é…å»¶ä¾¿ è©³ç´°ãƒªã‚¹ãƒˆ</div></div>
    <div class="panel-body" style="padding:0">
      <div class="flight-table-wrap">
        <table class="flight-table">
          <thead>
            <tr>
              <th>ä¾¿å</th><th>èˆªç©ºä¼šç¤¾</th><th>å‡ºç™ºåœ°â†’ç›®çš„åœ°</th><th>å®šåˆ»</th><th>å®Ÿç¸¾/äºˆå®š</th><th>é…å»¶æ™‚é–“</th><th>é…å»¶ç†ç”±</th>
            </tr>
          </thead>
          <tbody id="delay-tbody">
            <tr class="loading-row"><td colspan="7"><span class="spinner"></span>èª­ã¿è¾¼ã¿ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ============ HISTORY PAGE ============ -->
<div class="page" id="page-history">
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">ãƒ‡ãƒ¼ã‚¿ä¿å­˜å±¥æ­´</div>
      <button class="filter-btn" onclick="clearHistory()">ğŸ—‘ å±¥æ­´ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="panel-body">
      <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">
        ã€ŒğŸ’¾ ä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ã—ã€éå»ã®ãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
      </p>
      <div id="history-list">
        <div class="empty-state"><div class="empty-icon">ğŸ“‚</div>ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
      </div>
    </div>
  </div>
</div>

<!-- ============ SYSTEM PAGE ============ -->
<div class="page" id="page-system">
  <div class="panel" style="margin-bottom:16px">
    <div class="panel-header"><div class="panel-title">ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div></div>
    <div class="panel-body">
      <div class="sys-status-grid" id="sys-grid">
        <div class="sys-status-item"><span class="api-dot loading"></span><span class="sys-status-label">JAL ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡ºç™º</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item"><span class="api-dot loading"></span><span class="sys-status-label">JAL ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ°ç€</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item"><span class="api-dot loading"></span><span class="sys-status-label">JAL æ™‚åˆ»è¡¨</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item"><span class="api-dot loading"></span><span class="sys-status-label">ANA ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡ºç™º</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item"><span class="api-dot loading"></span><span class="sys-status-label">ANA ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ°ç€</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item"><span class="api-dot loading"></span><span class="sys-status-label">ANA æ™‚åˆ»è¡¨</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item" id="sys-hnd-dep"><span class="api-dot loading"></span><span class="sys-status-label">ç¾½ç”°å›½éš›ç·š å‡ºç™ºï¼ˆæœŸé–“é™å®šï¼‰</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item" id="sys-hnd-arr"><span class="api-dot loading"></span><span class="sys-status-label">ç¾½ç”°å›½éš›ç·š åˆ°ç€ï¼ˆæœŸé–“é™å®šï¼‰</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item" id="sys-naa-dep"><span class="api-dot loading"></span><span class="sys-status-label">æˆç”°ç©ºæ¸¯ å‡ºç™ºï¼ˆæœŸé–“é™å®šï¼‰</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
        <div class="sys-status-item" id="sys-naa-arr"><span class="api-dot loading"></span><span class="sys-status-label">æˆç”°ç©ºæ¸¯ åˆ°ç€ï¼ˆæœŸé–“é™å®šï¼‰</span><span class="sys-status-badge sys-warn">ç¢ºèªä¸­</span></div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-bottom:16px">
    <div class="panel-header"><div class="panel-title">API è¨­å®šæƒ…å ±</div></div>
    <div class="panel-body">
      <div class="detail-grid">
        <div class="detail-item"><div class="detail-label">JAL/ANA ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³</div><div class="detail-value" style="font-family:'Share Tech Mono',monospace;font-size:11px;word-break:break-all">4tf33x46mhk1umi1jhfiy040thiafy3o...</div></div>
        <div class="detail-item"><div class="detail-label">ãƒãƒ£ãƒ¬ãƒ³ã‚¸ API ãƒˆãƒ¼ã‚¯ãƒ³</div><div class="detail-value" style="font-family:'Share Tech Mono',monospace;font-size:11px;word-break:break-all">wvzxbmrc468he3y0p93ufz8ovhcqn5sa...</div></div>
        <div class="detail-item"><div class="detail-label">è‡ªå‹•æ›´æ–°é–“éš”</div><div class="detail-value">5åˆ†ã”ã¨</div></div>
        <div class="detail-item"><div class="detail-label">ãƒãƒ£ãƒ¬ãƒ³ã‚¸APIæœ‰åŠ¹æœŸé™</div><div class="detail-value" style="color:var(--accent-amber)">2026å¹´3æœˆ13æ—¥ã¾ã§</div></div>
        <div class="detail-item"><div class="detail-label">æœ€çµ‚æ›´æ–°</div><div class="detail-value" id="sys-last-update">-</div></div>
        <div class="detail-item"><div class="detail-label">å–å¾—ãƒ‡ãƒ¼ã‚¿ä»¶æ•°</div><div class="detail-value" id="sys-data-count">-</div></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header"><div class="panel-title">å¯¾å¿œç©ºæ¸¯ã‚³ãƒ¼ãƒ‰ä¸€è¦§</div></div>
    <div class="panel-body">
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;font-size:12px" id="airport-list"></div>
    </div>
  </div>
</div>

</main>

<!-- FLIGHT DETAIL MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">ãƒ•ãƒ©ã‚¤ãƒˆè©³ç´°</div>
      <button class="modal-close" onclick="closeModalDirect()">âœ•</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// =============================================
// CONFIGURATION
// =============================================
const CONFIG = {
  API_KEY: '4tf33x46mhk1umi1jhfiy040thiafy3onu9y71ltyrplwnkjka5u5pni8k2d3z6v',
  CHALLENGE_KEY: 'wvzxbmrc468he3y0p93ufz8ovhcqn5sauiiuixepg22wluhptpc42o78xfe38onh',
  BASE_URL: 'https://api.odpt.org/api/v4',
  CHALLENGE_URL: 'https://api-challenge.odpt.org/api/v4',
  CHALLENGE_EXPIRY: new Date('2026-03-13'),
  REFRESH_INTERVAL: 300000, // 5åˆ†
};

// ç©ºæ¸¯ã‚³ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ï¼ˆå¤§å¹…æ‹¡å……ç‰ˆï¼‰
const AIRPORTS = {
  // ===== å›½å†…ç·š =====
  "HND":"ç¾½ç”°", "NRT":"æˆç”°", "ITM":"å¤§é˜ªï¼ˆä¼Šä¸¹ï¼‰", "KIX":"é–¢è¥¿å›½éš›",
  "CTS":"æœ­å¹Œï¼ˆæ–°åƒæ­³ï¼‰", "OKA":"é‚£è¦‡", "NGO":"ä¸­éƒ¨(ã‚»ãƒ³ãƒˆãƒ¬ã‚¢)",
  "FUK":"ç¦å²¡", "KOJ":"é¹¿å…å³¶", "HIJ":"åºƒå³¶", "SDJ":"ä»™å°",
  "AOJ":"é’æ£®", "AXT":"ç§‹ç”°", "FKS":"ç¦å³¶", "MMB":"å¥³æº€åˆ¥",
  "AKJ":"æ—­å·", "HKD":"å‡½é¤¨", "MSJ":"ä¸‰æ²¢", "GAJ":"å±±å½¢",
  "KMJ":"ç†Šæœ¬", "OIT":"å¤§åˆ†", "MYJ":"æ¾å±±", "TAK":"é«˜æ¾",
  "TKS":"å¾³å³¶", "IZO":"å‡ºé›²", "YGJ":"ç±³å­", "TTJ":"é³¥å–",
  "KCZ":"é«˜çŸ¥", "KMI":"å®®å´", "ISG":"çŸ³å£", "MMY":"å®®å¤å³¶",
  "AGJ":"å¥„ç¾å¤§å³¶", "TNE":"ç¨®å­å³¶", "AXJ":"å¤©è‰",
  "OKD":"ä¸˜ç ï¼ˆæœ­å¹Œï¼‰", "WKJ":"ç¨šå†…", "KUH":"é‡§è·¯", "OBO":"å¸¯åºƒ",
  "MBE":"ç´‹åˆ¥", "SHB":"ä¸­æ¨™æ´¥", "IKI":"å£±å²", "TSJ":"å¯¾é¦¬",
  "OIR":"éš å²", "NTQ":"èƒ½ç™»", "KKJ":"åŒ—ä¹å·", "MYJ":"æ¾å±±",
  "UBJ":"å±±å£å®‡éƒ¨", "IWJ":"å²©å›½", "ASJ":"å¥„ç¾å¤§å³¶", "KKX":"å–œç•Œå³¶",
  "TKN":"å¾³ä¹‹å³¶", "OKE":"æ²–æ°¸è‰¯éƒ¨", "YON":"ä¸è«–", "UEO":"ä¹…ç±³å³¶",
  "MMD":"å—å¤§æ±", "KTD":"åŒ—å¤§æ±", "IEJ":"ä¼Šæ±Ÿå³¶", "HTR":"å—ç´€ç™½æµœ",
  "TOY":"å¯Œå±±", "KMQ":"å°æ¾ï¼ˆçŸ³å·ï¼‰", "SDS":"æ¾æœ¬", "FSZ":"é™å²¡",
  "TKS":"å¾³å³¶", "KCZ":"é«˜çŸ¥", "IWK":"å²©è¦‹æ²¢", "RIS":"åˆ©å°»",
  "RBJ":"ç¤¼æ–‡", "OKI":"éš å²", "HIW":"åºƒå³¶è¥¿",
  // ===== åŒ—ç±³ =====
  "SFO":"ã‚µãƒ³ãƒ•ãƒ©ãƒ³ã‚·ã‚¹ã‚³", "JFK":"ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯(JFK)", "LAX":"ãƒ­ã‚µãƒ³ã‚¼ãƒ«ã‚¹",
  "ORD":"ã‚·ã‚«ã‚´(ã‚ªãƒ˜ã‚¢)", "BOS":"ãƒœã‚¹ãƒˆãƒ³", "SEA":"ã‚·ã‚¢ãƒˆãƒ«",
  "LAS":"ãƒ©ã‚¹ãƒ™ã‚¬ã‚¹", "MIA":"ãƒã‚¤ã‚¢ãƒŸ", "ATL":"ã‚¢ãƒˆãƒ©ãƒ³ã‚¿",
  "DFW":"ãƒ€ãƒ©ã‚¹", "IAD":"ãƒ¯ã‚·ãƒ³ãƒˆãƒ³DC(ãƒ€ãƒ¬ã‚¹)", "YYZ":"ãƒˆãƒ­ãƒ³ãƒˆ",
  "YVR":"ãƒãƒ³ã‚¯ãƒ¼ãƒãƒ¼", "GUM":"ã‚°ã‚¢ãƒ ", "HNL":"ãƒ›ãƒãƒ«ãƒ«",
  "KOA":"ãƒãƒ¯ã‚¤å³¶(ã‚³ãƒŠ)", "OGG":"ãƒã‚¦ã‚¤å³¶",
  // ===== ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ =====
  "CDG":"ãƒ‘ãƒª(ã‚·ãƒ£ãƒ«ãƒ«ãƒ»ãƒ‰ã‚´ãƒ¼ãƒ«)", "LHR":"ãƒ­ãƒ³ãƒ‰ãƒ³(ãƒ’ãƒ¼ã‚¹ãƒ­ãƒ¼)",
  "FRA":"ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ", "AMS":"ã‚¢ãƒ ã‚¹ãƒ†ãƒ«ãƒ€ãƒ ",
  "FCO":"ãƒ­ãƒ¼ãƒ(ãƒ•ã‚£ã‚¦ãƒŸãƒãƒ¼ãƒ)", "MAD":"ãƒãƒ‰ãƒªãƒ¼ãƒ‰",
  "BCN":"ãƒãƒ«ã‚»ãƒ­ãƒŠ", "ZRH":"ãƒãƒ¥ãƒ¼ãƒªãƒƒãƒ’",
  "VIE":"ã‚¦ã‚£ãƒ¼ãƒ³", "BRU":"ãƒ–ãƒªãƒ¥ãƒƒã‚»ãƒ«",
  "CPH":"ã‚³ãƒšãƒ³ãƒãƒ¼ã‚²ãƒ³", "ARN":"ã‚¹ãƒˆãƒƒã‚¯ãƒ›ãƒ«ãƒ ",
  "OSL":"ã‚ªã‚¹ãƒ­", "HEL":"ãƒ˜ãƒ«ã‚·ãƒ³ã‚­",
  "MUC":"ãƒŸãƒ¥ãƒ³ãƒ˜ãƒ³", "DUS":"ãƒ‡ãƒ¥ãƒƒã‚»ãƒ«ãƒ‰ãƒ«ãƒ•",
  "LGW":"ãƒ­ãƒ³ãƒ‰ãƒ³(ã‚¬ãƒˆã‚¦ã‚£ãƒƒã‚¯)", "STN":"ãƒ­ãƒ³ãƒ‰ãƒ³(ã‚¹ã‚¿ãƒ³ã‚¹ãƒ†ãƒƒãƒ‰)",
  // ===== ã‚¢ã‚¸ã‚¢ =====
  "ICN":"ã‚½ã‚¦ãƒ«ï¼ˆä»å·ï¼‰", "GMP":"ã‚½ã‚¦ãƒ«ï¼ˆé‡‘æµ¦ï¼‰",
  "PEK":"åŒ—äº¬(é¦–éƒ½)", "PKX":"åŒ—äº¬(å¤§èˆˆ)",
  "PVG":"ä¸Šæµ·(æµ¦æ±)", "SHA":"ä¸Šæµ·(è™¹æ©‹)",
  "CAN":"åºƒå·", "SZX":"æ·±åœ³", "CTU":"æˆéƒ½",
  "HKG":"é¦™æ¸¯", "MFM":"ãƒã‚«ã‚ª",
  "TPE":"å°åŒ—(æ¡ƒåœ’)", "TSA":"å°åŒ—(æ¾å±±)",
  "KHH":"é«˜é›„", "RMQ":"å°ä¸­",
  "SIN":"ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«", "KUL":"ã‚¯ã‚¢ãƒ©ãƒ«ãƒ³ãƒ—ãƒ¼ãƒ«",
  "BKK":"ãƒãƒ³ã‚³ã‚¯(ã‚¹ãƒ¯ãƒ³ãƒŠãƒ—ãƒ¼ãƒ )", "DMK":"ãƒãƒ³ã‚³ã‚¯(ãƒ‰ãƒ³ãƒ ã‚¢ãƒ³)",
  "CNX":"ãƒã‚§ãƒ³ãƒã‚¤", "HKT":"ãƒ—ãƒ¼ã‚±ãƒƒãƒˆ",
  "SGN":"ãƒ›ãƒ¼ãƒãƒŸãƒ³", "HAN":"ãƒãƒã‚¤",
  "DAD":"ãƒ€ãƒŠãƒ³", "PNH":"ãƒ—ãƒãƒ³ãƒšãƒ³",
  "REP":"ã‚·ã‚§ãƒ ãƒªã‚¢ãƒƒãƒ—", "RGN":"ãƒ¤ãƒ³ã‚´ãƒ³",
  "DEL":"ãƒ‡ãƒªãƒ¼", "BOM":"ãƒ ãƒ³ãƒã‚¤",
  "MAA":"ãƒã‚§ãƒ³ãƒŠã‚¤", "BLR":"ãƒãƒ³ã‚¬ãƒ­ãƒ¼ãƒ«",
  "CGK":"ã‚¸ãƒ£ã‚«ãƒ«ã‚¿", "DPS":"ãƒãƒªå³¶(ãƒ‡ãƒ³ãƒ‘ã‚µãƒ¼ãƒ«)",
  "SUB":"ã‚¹ãƒ©ãƒãƒ¤", "MNL":"ãƒãƒ‹ãƒ©",
  "CEB":"ã‚»ãƒ–", "KLO":"ã‚«ãƒªãƒœ(ãƒœãƒ©ã‚«ã‚¤)",
  "ROR":"ãƒ‘ãƒ©ã‚ª", "SPN":"ã‚µã‚¤ãƒ‘ãƒ³",
  "TYO":"æ±äº¬(ä¸€èˆ¬)", "OSA":"å¤§é˜ª(ä¸€èˆ¬)",
  // ===== ä¸­æ±ãƒ»ã‚¢ãƒ•ãƒªã‚«ãƒ»ã‚ªã‚»ã‚¢ãƒ‹ã‚¢ =====
  "DXB":"ãƒ‰ãƒã‚¤", "AUH":"ã‚¢ãƒ–ãƒ€ãƒ“",
  "DOH":"ãƒ‰ãƒ¼ãƒ", "RUH":"ãƒªãƒ¤ãƒ‰",
  "SYD":"ã‚·ãƒ‰ãƒ‹ãƒ¼", "MEL":"ãƒ¡ãƒ«ãƒœãƒ«ãƒ³",
  "BNE":"ãƒ–ãƒªã‚¹ãƒ™ãƒ³", "PER":"ãƒ‘ãƒ¼ã‚¹",
  "AKL":"ã‚ªãƒ¼ã‚¯ãƒ©ãƒ³ãƒ‰", "NAN":"ãƒŠãƒ³ãƒ‡ã‚£(ãƒ•ã‚£ã‚¸ãƒ¼)",
  "PPT":"ãƒ‘ãƒšãƒ¼ãƒ†(ã‚¿ãƒ’ãƒ)", "JNB":"ãƒ¨ãƒãƒã‚¹ãƒ–ãƒ«ã‚°",
  "CAI":"ã‚«ã‚¤ãƒ­", "CMN":"ã‚«ã‚µãƒ–ãƒ©ãƒ³ã‚«",
  // ===== ãƒ­ã‚·ã‚¢ãƒ»ä¸­å¤®ã‚¢ã‚¸ã‚¢ =====
  "SVO":"ãƒ¢ã‚¹ã‚¯ãƒ¯(ã‚·ã‚§ãƒ¬ãƒ¡ãƒ¼ãƒã‚§ãƒœ)", "VVO":"ã‚¦ãƒ©ã‚¸ã‚ªã‚¹ãƒˆã‚¯",
  "KHV":"ãƒãƒãƒ­ãƒ•ã‚¹ã‚¯",
};

// å›½å†…ç©ºæ¸¯ã‚»ãƒƒãƒˆï¼ˆå›½éš›/å›½å†…åˆ¤å®šç”¨ï¼‰
const DOMESTIC_AP = new Set([
  "HND","NRT","ITM","KIX","CTS","OKA","NGO","FUK","KOJ","HIJ","SDJ",
  "AOJ","AXT","FKS","MMB","AKJ","HKD","MSJ","GAJ","KMJ","OIT","MYJ",
  "TAK","TKS","IZO","YGJ","TTJ","KCZ","KMI","ISG","MMY","AGJ","TNE",
  "AXJ","OKD","WKJ","KUH","OBO","MBE","SHB","IKI","TSJ","OIR","NTQ",
  "KKJ","UBJ","IWJ","ASJ","KKX","TKN","OKE","YON","UEO","MMD","KTD",
  "IEJ","HTR","TOY","KMQ","SDS","FSZ","FSZ","RIS","RBJ","OKI",
]);

// ãƒ•ãƒ©ã‚¤ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ—¥æœ¬èªãƒã‚¹ã‚¿
const STATUS_MAP = {
  'odpt.FlightStatus:Departed': { label:'å‡ºç™ºæ¸ˆ', cls:'status-arrived' },
  'odpt.FlightStatus:Arrived': { label:'åˆ°ç€æ¸ˆ', cls:'status-arrived' },
  'odpt.FlightStatus:InAir': { label:'é£›è¡Œä¸­', cls:'status-inair' },
  'odpt.FlightStatus:Delayed': { label:'é…å»¶', cls:'status-delay' },
  'odpt.FlightStatus:Cancelled': { label:'æ¬ èˆª', cls:'status-cancel' },
  'odpt.FlightStatus:Boarding': { label:'æ­ä¹—ä¸­', cls:'status-boarding' },
  'odpt.FlightStatus:GateClosed': { label:'æ­ä¹—å£é–‰é–', cls:'status-boarding' },
  'odpt.FlightStatus:EstimatedDeparture': { label:'å‡ºç™ºäºˆå®š', cls:'status-ontime' },
  'odpt.FlightStatus:EstimatedArrival': { label:'åˆ°ç€äºˆå®š', cls:'status-ontime' },
  'odpt.FlightStatus:CheckIn': { label:'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ä¸­', cls:'status-ontime' },
  'odpt.FlightStatus:OnSchedule': { label:'å®šåˆ»', cls:'status-ontime' },
  'odpt.FlightStatus:EarlyDeparture': { label:'æ—©ç™º', cls:'status-ontime' },
  'odpt.FlightStatus:EarlyArrival': { label:'æ—©ç€', cls:'status-ontime' },
};

const CALENDAR_MAP = {
  'odpt.Calendar:Monday':'æœˆæ›œ', 'odpt.Calendar:Tuesday':'ç«æ›œ',
  'odpt.Calendar:Wednesday':'æ°´æ›œ', 'odpt.Calendar:Thursday':'æœ¨æ›œ',
  'odpt.Calendar:Friday':'é‡‘æ›œ', 'odpt.Calendar:Saturday':'åœŸæ›œ',
  'odpt.Calendar:Sunday':'æ—¥æ›œ', 'odpt.Calendar:Weekday':'å¹³æ—¥',
  'odpt.Calendar:Holiday':'ç¥æ—¥', 'odpt.Calendar:SaturdayHoliday':'åœŸç¥',
  'odpt.Calendar:Everyday':'æ¯æ—¥',
};

// =============================================
// STATE
// =============================================
let allDepartures = [];
let allArrivals = [];
let allSchedules = [];
let apiStatuses = {};
let depSortKey = 'time';
let charts = {};
const challengeActive = new Date() <= CONFIG.CHALLENGE_EXPIRY;

// =============================================
// UTILS
// =============================================
function getAirportName(code) {
  if (!code) return '-';
  const c = code.replace('odpt.Airport:', '');
  return AIRPORTS[c] ? `${c}ï¼ˆ${AIRPORTS[c]}ï¼‰` : c;
}
function getAirportCode(str) {
  return str ? str.replace('odpt.Airport:', '') : '-';
}
function getTerminal(str) {
  if (!str) return '-';
  const m = str.match(/Terminal(\w+)/);
  if (m) return 'T' + m[1];
  return str.replace('odpt.AirportTerminal:','').replace(/.*\./,'');
}
function getAirlineKey(str) {
  if (!str) return '';
  if (str.includes(':JAL')) return 'JAL';
  if (str.includes(':ANA')) return 'ANA';
  if (str.includes(':HND-TIAT')) return 'HND-TIAT';
  if (str.includes(':NAA')) return 'NAA';
  return str.replace('odpt.Operator:','');
}
function getStatusInfo(str) {
  if (!str) return { label:'ä¸æ˜', cls:'status-unknown' };
  return STATUS_MAP[str] || { label: str.replace('odpt.FlightStatus:',''), cls:'status-unknown' };
}
function timeDiff(t1, t2) {
  // HH:MM format -> minutes diff
  if (!t1 || !t2) return null;
  const [h1,m1] = t1.split(':').map(Number);
  const [h2,m2] = t2.split(':').map(Number);
  return (h2*60+m2) - (h1*60+m1);
}
function formatDiff(mins) {
  if (mins === null) return '';
  if (mins > 0) return `<span style="color:var(--accent-amber)">+${mins}åˆ†</span>`;
  if (mins < 0) return `<span style="color:var(--accent-green)">${mins}åˆ†</span>`;
  return `<span style="color:var(--text-muted)">Â±0</span>`;
}
function isIntl(orig, dest) {
  const o = getAirportCode(orig);
  const d = getAirportCode(dest);
  return !DOMESTIC_AP.has(o) || !DOMESTIC_AP.has(d);
}
function getTimeHour(timeStr) {
  if (!timeStr) return -1;
  return parseInt(timeStr.split(':')[0]);
}
function showToast(msg, duration=2500) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => el.style.display='none', duration);
}
function setApiDot(id, status) {
  const dot = document.getElementById('dot-'+id);
  if (!dot) return;
  dot.className = 'api-dot' + (status === 'ok' ? '' : status === 'error' ? ' error' : ' loading');
}

// =============================================
// CLOCK
// =============================================
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('ja-JP',{hour12:false});
  const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  document.getElementById('dateStr').textContent =
    `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼ˆ${days[now.getDay()]}ï¼‰`;
}
setInterval(updateClock, 1000);
updateClock();

// =============================================
// API FETCH
// =============================================
async function fetchAPI(url, label) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    apiStatuses[label] = 'ok';
    return data;
  } catch(e) {
    apiStatuses[label] = 'error';
    console.warn(`API Error [${label}]:`, e.message);
    return [];
  }
}

async function fetchAllData() {
  document.querySelectorAll('.api-dot').forEach(d => d.className='api-dot loading');

  const KEY = CONFIG.API_KEY;
  const CKEY = CONFIG.CHALLENGE_KEY;
  const B = CONFIG.BASE_URL;
  const C = CONFIG.CHALLENGE_URL;

  // All fetches in parallel
  const [
    jalDep, jalArr, jalSched,
    anaDep, anaArr, anaSched,
    hndDep, hndArr,
    naaDep, naaArr
  ] = await Promise.all([
    fetchAPI(`${B}/odpt:FlightInformationDeparture?odpt:operator=odpt.Operator:JAL&acl:consumerKey=${KEY}`, 'jal-dep'),
    fetchAPI(`${B}/odpt:FlightInformationArrival?odpt:operator=odpt.Operator:JAL&acl:consumerKey=${KEY}`, 'jal-arr'),
    fetchAPI(`${B}/odpt:FlightSchedule?odpt:operator=odpt.Operator:JAL&acl:consumerKey=${KEY}`, 'jal-sched'),
    fetchAPI(`${B}/odpt:FlightInformationDeparture?odpt:operator=odpt.Operator:ANA&acl:consumerKey=${KEY}`, 'ana-dep'),
    fetchAPI(`${B}/odpt:FlightInformationArrival?odpt:operator=odpt.Operator:ANA&acl:consumerKey=${KEY}`, 'ana-arr'),
    fetchAPI(`${B}/odpt:FlightSchedule?odpt:operator=odpt.Operator:ANA&acl:consumerKey=${KEY}`, 'ana-sched'),
    challengeActive ? fetchAPI(`${C}/odpt:FlightInformationDeparture?odpt:operator=odpt.Operator:HND-TIAT&acl:consumerKey=${CKEY}`, 'hnd-dep') : [],
    challengeActive ? fetchAPI(`${C}/odpt:FlightInformationArrival?odpt:operator=odpt.Operator:HND-TIAT&acl:consumerKey=${CKEY}`, 'hnd-arr') : [],
    challengeActive ? fetchAPI(`${C}/odpt:FlightInformationDeparture?odpt:operator=odpt.Operator:NAA&acl:consumerKey=${CKEY}`, 'naa-dep') : [],
    challengeActive ? fetchAPI(`${C}/odpt:FlightInformationArrival?odpt:operator=odpt.Operator:NAA&acl:consumerKey=${CKEY}`, 'naa-arr') : [],
  ]);

  // Merge departures
  allDepartures = [
    ...jalDep.map(f => ({...f, _src:'JAL'})),
    ...anaDep.map(f => ({...f, _src:'ANA'})),
    ...hndDep.map(f => ({...f, _src:'HND-TIAT'})),
    ...naaDep.map(f => ({...f, _src:'NAA'})),
  ];

  // Merge arrivals
  allArrivals = [
    ...jalArr.map(f => ({...f, _src:'JAL'})),
    ...anaArr.map(f => ({...f, _src:'ANA'})),
    ...hndArr.map(f => ({...f, _src:'HND-TIAT'})),
    ...naaArr.map(f => ({...f, _src:'NAA'})),
  ];

  // Merge schedules
  allSchedules = [
    ...jalSched.map(f => ({...f, _src:'JAL'})),
    ...anaSched.map(f => ({...f, _src:'ANA'})),
  ];

  // Update API status indicators
  const combinedJal = (apiStatuses['jal-dep']==='ok' && apiStatuses['jal-arr']==='ok') ? 'ok' : 'error';
  const combinedAna = (apiStatuses['ana-dep']==='ok' && apiStatuses['ana-arr']==='ok') ? 'ok' : 'error';
  const combinedHnd = challengeActive ? (apiStatuses['hnd-dep']==='ok' ? 'ok' : 'error') : 'ok';
  const combinedNaa = challengeActive ? (apiStatuses['naa-dep']==='ok' ? 'ok' : 'error') : 'ok';
  setApiDot('jal', combinedJal);
  setApiDot('ana', combinedAna);
  setApiDot('hnd', combinedHnd);
  setApiDot('naa', combinedNaa);

  updateSystemStatus();

  // Render all
  renderDashboard();
  renderDepartures();
  renderArrivals();
  renderSchedule();
  renderAnalytics();
  renderDelayList();
  renderHnd();
  renderAlerts();
  renderHnd();
  renderAlerts();

  document.getElementById('sys-last-update').textContent = new Date().toLocaleString('ja-JP');
  document.getElementById('sys-data-count').textContent =
    `å‡ºç™º${allDepartures.length}ä»¶ / åˆ°ç€${allArrivals.length}ä»¶ / æ™‚åˆ»è¡¨${allSchedules.length}ä»¶`;
}

// =============================================
// SYSTEM STATUS UPDATE
// =============================================
function updateSystemStatus() {
  const items = document.querySelectorAll('#sys-grid .sys-status-item');
  const keys = ['jal-dep','jal-arr','jal-sched','ana-dep','ana-arr','ana-sched','hnd-dep','hnd-arr','naa-dep','naa-arr'];
  items.forEach((item, i) => {
    const key = keys[i];
    const dot = item.querySelector('.api-dot');
    const badge = item.querySelector('.sys-status-badge');
    // Challenge APIs
    if (key.startsWith('hnd') || key.startsWith('naa')) {
      if (!challengeActive) {
        dot.className = 'api-dot';
        dot.style.background = '#444'; dot.style.boxShadow = 'none';
        badge.className = 'sys-status-badge sys-warn';
        badge.textContent = 'æœŸé–“å¤–';
        return;
      }
    }
    const s = apiStatuses[key];
    if (s === 'ok') {
      dot.className = 'api-dot';
      badge.className = 'sys-status-badge sys-ok';
      badge.textContent = 'æ¥ç¶šä¸­';
    } else if (s === 'error') {
      dot.className = 'api-dot error';
      badge.className = 'sys-status-badge sys-err';
      badge.textContent = 'ã‚¨ãƒ©ãƒ¼';
    } else {
      dot.className = 'api-dot loading';
      badge.className = 'sys-status-badge sys-warn';
      badge.textContent = 'ç¢ºèªä¸­';
    }
  });

  // Airport list
  const al = document.getElementById('airport-list');
  al.innerHTML = Object.entries(AIRPORTS).map(([k,v]) =>
    `<div style="display:flex;gap:6px;align-items:center;">
      <span class="airport-code" style="font-size:13px">${k}</span>
      <span style="font-size:12px;color:var(--text-secondary)">${v}</span>
    </div>`
  ).join('');
}

// =============================================
// STATUS HELPERS
// =============================================
function getDepStatusClass(f) {
  const s = f['odpt:flightStatus'];
  if (!s) return { label:'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', cls:'status-ontime' };
  if (s.includes('Cancel')) return { label:'æ¬ èˆª', cls:'status-cancel' };
  if (s.includes('Delay')) return { label:'é…å»¶', cls:'status-delay' };
  if (s.includes('InAir')) return { label:'é£›è¡Œä¸­', cls:'status-inair' };
  if (s.includes('Departed') || s.includes('Arrived')) return { label:'å‡ºç™ºæ¸ˆ', cls:'status-arrived' };
  if (s.includes('Boarding')) return { label:'æ­ä¹—ä¸­', cls:'status-boarding' };
  if (s.includes('GateClosed')) return { label:'æ­ä¹—å£é–‰é–', cls:'status-boarding' };
  if (s.includes('Estimated')) return { label:'äºˆå®š', cls:'status-ontime' };
  return getStatusInfo(s);
}
function isDelayed(f, type='dep') {
  const s = f['odpt:flightStatus'] || '';
  if (s.includes('Cancel')) return false;
  if (s.includes('Delay')) return true;
  if (type === 'dep') {
    const sched = f['odpt:scheduledDepartureTime'];
    const actual = f['odpt:actualDepartureTime'] || f['odpt:estimatedDepartureTime'];
    const diff = timeDiff(sched, actual);
    return diff !== null && diff > 5;
  } else {
    const sched = f['odpt:scheduledArrivalTime'];
    const actual = f['odpt:actualArrivalTime'] || f['odpt:estimatedArrivalTime'];
    const diff = timeDiff(sched, actual);
    return diff !== null && diff > 5;
  }
}
function isCancelled(f) {
  const s = f['odpt:flightStatus'] || '';
  return s.includes('Cancel');
}

// =============================================
// AIRLINE BADGE
// =============================================
function airlineBadge(src) {
  const map = {
    'JAL': '<span class="airline-badge badge-jal">JAL</span>',
    'ANA': '<span class="airline-badge badge-ana">ANA</span>',
    'HND-TIAT': '<span class="airline-badge badge-hnd">HND</span>',
    'NAA': '<span class="airline-badge badge-naa">NAA</span>',
  };
  return map[src] || `<span class="airline-badge">${src}</span>`;
}
function flightNumClass(src) {
  const map = { JAL:'jal', ANA:'ana', 'HND-TIAT':'hnd', NAA:'naa' };
  return map[src] || '';
}

// =============================================
// DASHBOARD RENDER
// =============================================
function renderDashboard() {
  const total = allDepartures.length + allArrivals.length;
  const delays = allDepartures.filter(f => isDelayed(f,'dep')).length
    + allArrivals.filter(f => isDelayed(f,'arr')).length;
  const cancels = [...allDepartures, ...allArrivals].filter(isCancelled).length;
  const ontime = total > 0 ? Math.round(((total - delays - cancels) / total) * 100) : 0;

  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-delay').textContent = delays;
  document.getElementById('kpi-delay-pct').textContent = `${total>0?Math.round(delays/total*100):0}% é…å»¶ç‡`;
  document.getElementById('kpi-cancel').textContent = cancels;
  document.getElementById('kpi-cancel-pct').textContent = `${total>0?Math.round(cancels/total*100):0}% æ¬ èˆªç‡`;
  document.getElementById('kpi-ontime').textContent = ontime + '%';
  document.getElementById('kpi-dep').textContent = allDepartures.length;
  document.getElementById('kpi-arr').textContent = allArrivals.length;

  // Avg delay
  let totalDelay = 0, delayCount = 0;
  allDepartures.forEach(f => {
    const d = timeDiff(f['odpt:scheduledDepartureTime'], f['odpt:actualDepartureTime'] || f['odpt:estimatedDepartureTime']);
    if (d !== null && d > 0) { totalDelay += d; delayCount++; }
  });
  const avgDelay = delayCount > 0 ? Math.round(totalDelay / delayCount) : 0;
  document.getElementById('avg-delay').textContent = avgDelay > 0 ? `${avgDelay} åˆ†` : '0 åˆ†';

  // Busiest terminal
  const termCount = {};
  [...allDepartures, ...allArrivals].forEach(f => {
    const t = getTerminal(f['odpt:departureAirportTerminal'] || f['odpt:arrivalAirportTerminal']);
    if (t && t !== '-') termCount[t] = (termCount[t] || 0) + 1;
  });
  const busiest = Object.entries(termCount).sort((a,b) => b[1]-a[1])[0];
  if (busiest) {
    document.getElementById('busiest-terminal').textContent = busiest[0];
    document.getElementById('busiest-count').textContent = `${busiest[1]}ä¾¿ / æœ¬æ—¥`;
  }

  // Airline status bars
  const airlineBody = document.getElementById('airline-status-body');
  const airlines = { JAL:{dep:0,arr:0,delay:0,cancel:0}, ANA:{dep:0,arr:0,delay:0,cancel:0}, 'HND-TIAT':{dep:0,arr:0,delay:0,cancel:0}, NAA:{dep:0,arr:0,delay:0,cancel:0} };
  allDepartures.forEach(f => {
    const a = f._src;
    if (airlines[a]) {
      airlines[a].dep++;
      if (isDelayed(f,'dep')) airlines[a].delay++;
      if (isCancelled(f)) airlines[a].cancel++;
    }
  });
  allArrivals.forEach(f => {
    const a = f._src;
    if (airlines[a]) airlines[a].arr++;
  });
  airlineBody.innerHTML = Object.entries(airlines).map(([name, d]) => {
    const total = d.dep + d.arr;
    if (total === 0) return '';
    return `<div style="margin-bottom:14px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        ${airlineBadge(name)}
        <span style="font-size:12px;color:var(--text-secondary)">å‡ºç™º${d.dep}ä»¶ / åˆ°ç€${d.arr}ä»¶</span>
        <span style="margin-left:auto;font-size:11px;color:var(--accent-amber)">${d.delay > 0 ? `é…å»¶${d.delay}` : ''}</span>
        <span style="font-size:11px;color:var(--accent-red)">${d.cancel > 0 ? `æ¬ èˆª${d.cancel}` : ''}</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(100,total)}%;background:${name==='JAL'?'#e60033':name==='ANA'?'#1a56db':name==='HND-TIAT'?'var(--accent-cyan)':'var(--accent-amber)'}"></div></div>
    </div>`;
  }).join('');

  // Airport heatmap
  const apCount = {};
  allDepartures.forEach(f => {
    const c = getAirportCode(f['odpt:departureAirport']);
    if (c && c !== '-') apCount[c] = (apCount[c] || 0) + 1;
  });
  allArrivals.forEach(f => {
    const c = getAirportCode(f['odpt:arrivalAirport']);
    if (c && c !== '-') apCount[c] = (apCount[c] || 0) + 1;
  });
  const maxAP = Math.max(...Object.values(apCount), 1);
  const sortedAP = Object.entries(apCount).sort((a,b) => b[1]-a[1]).slice(0, 10);
  const heatEl = document.getElementById('airport-heatmap');
  heatEl.innerHTML = sortedAP.map(([code, cnt]) => {
    const pct = Math.round(cnt / maxAP * 100);
    const name = AIRPORTS[code] || code;
    const color = code === 'HND' ? 'var(--accent-blue)' : code === 'NRT' ? 'var(--accent-amber)' : 'var(--accent-cyan)';
    return `<div class="heatmap-bar">
      <div class="heatmap-label" style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-secondary)">${code}</div>
      <div style="font-size:10px;color:var(--text-muted);width:80px;flex-shrink:0">${name}</div>
      <div class="heatmap-bar-inner">
        <div class="heatmap-fill" style="width:${pct}%;background:${color};opacity:0.8"></div>
      </div>
      <div class="heatmap-val">${cnt}</div>
    </div>`;
  }).join('');

  // Dashboard mini tables (near current time)
  const now = new Date();
  const nowMins = now.getHours()*60 + now.getMinutes();

  const depSorted = [...allDepartures].sort((a, b) => {
    const ta = (a['odpt:scheduledDepartureTime']||'99:99').replace(':','');
    const tb = (b['odpt:scheduledDepartureTime']||'99:99').replace(':','');
    return parseInt(ta) - parseInt(tb);
  });
  // Get flights within Â±2 hours
  const nearDep = depSorted.filter(f => {
    const t = f['odpt:scheduledDepartureTime'];
    if (!t) return false;
    const [h,m] = t.split(':').map(Number);
    const diff = h*60+m - nowMins;
    return diff >= -30 && diff <= 180;
  }).slice(0, 10);

  const dashDepTbody = document.getElementById('dash-dep-tbody');
  if (nearDep.length === 0) {
    dashDepTbody.innerHTML = '<tr><td colspan="5" class="loading-row" style="color:var(--text-muted);text-align:center;padding:20px">è¿‘æ¥å‡ºç™ºä¾¿ãªã—</td></tr>';
  } else {
    dashDepTbody.innerHTML = nearDep.map(f => buildDepMiniRow(f)).join('');
  }

  const arrSorted = [...allArrivals].sort((a, b) => {
    const ta = (a['odpt:scheduledArrivalTime']||'99:99').replace(':','');
    const tb = (b['odpt:scheduledArrivalTime']||'99:99').replace(':','');
    return parseInt(ta) - parseInt(tb);
  });
  const nearArr = arrSorted.filter(f => {
    const t = f['odpt:scheduledArrivalTime'];
    if (!t) return false;
    const [h,m] = t.split(':').map(Number);
    const diff = h*60+m - nowMins;
    return diff >= -30 && diff <= 180;
  }).slice(0, 10);

  const dashArrTbody = document.getElementById('dash-arr-tbody');
  if (nearArr.length === 0) {
    dashArrTbody.innerHTML = '<tr><td colspan="5" class="loading-row" style="color:var(--text-muted);text-align:center;padding:20px">è¿‘æ¥åˆ°ç€ä¾¿ãªã—</td></tr>';
  } else {
    dashArrTbody.innerHTML = nearArr.map(f => buildArrMiniRow(f)).join('');
  }

  // Ticker
  const tickerItems = [];
  allDepartures.filter(isCancelled).slice(0,5).forEach(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    tickerItems.push(`ğŸš« æ¬ èˆª: ${fn} ${getAirportCode(f['odpt:departureAirport'])}â†’${getAirportCode(f['odpt:destinationAirport'])}`);
  });
  allDepartures.filter(f => isDelayed(f,'dep')).slice(0,5).forEach(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const d = timeDiff(f['odpt:scheduledDepartureTime'], f['odpt:actualDepartureTime']||f['odpt:estimatedDepartureTime']);
    tickerItems.push(`âš  é…å»¶: ${fn} ${d ? `+${d}åˆ†` : ''} ${getAirportCode(f['odpt:destinationAirport'])}è¡Œã`);
  });
  allDepartures.filter(f => (f['odpt:flightStatus']||'').includes('InAir')).slice(0,5).forEach(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    tickerItems.push(`âœˆ é£›è¡Œä¸­: ${fn} â†’ ${getAirportCode(f['odpt:destinationAirport'])}`);
  });
  if (tickerItems.length > 0) {
    const txt = tickerItems.join('ã€€ã€€ã€€ã€€') + 'ã€€ã€€ã€€ã€€' + tickerItems.join('ã€€ã€€ã€€ã€€');
    document.getElementById('ticker-text').textContent = txt;
  }
}

function buildDepMiniRow(f) {
  const fn = (f['odpt:flightNumber']||[]).join('/');
  const dest = getAirportCode(f['odpt:destinationAirport']);
  const sched = f['odpt:scheduledDepartureTime'] || '-';
  const actual = f['odpt:actualDepartureTime'] || f['odpt:estimatedDepartureTime'] || '-';
  const status = getDepStatusClass(f);
  return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, 'dep')">
    <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
    <td><span class="airport-code">${dest}</span> <span style="font-size:10px;color:var(--text-muted)">${AIRPORTS[dest]||''}</span></td>
    <td class="time-cell">${sched}</td>
    <td class="time-cell ${actual !== '-' && actual !== sched ? 'time-delayed' : ''}">${actual}</td>
    <td><span class="status-badge ${status.cls}">${status.label}</span></td>
  </tr>`;
}
function buildArrMiniRow(f) {
  const fn = (f['odpt:flightNumber']||[]).join('/');
  const orig = getAirportCode(f['odpt:originAirport']);
  const sched = f['odpt:scheduledArrivalTime'] || '-';
  const actual = f['odpt:actualArrivalTime'] || f['odpt:estimatedArrivalTime'] || '-';
  const status = getDepStatusClass(f);
  return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, 'arr')">
    <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
    <td><span class="airport-code">${orig}</span> <span style="font-size:10px;color:var(--text-muted)">${AIRPORTS[orig]||''}</span></td>
    <td class="time-cell">${sched}</td>
    <td class="time-cell ${actual !== '-' && actual !== sched ? 'time-delayed' : ''}">${actual}</td>
    <td><span class="status-badge ${status.cls}">${status.label}</span></td>
  </tr>`;
}

// =============================================
// DEPARTURES RENDER
// =============================================
let depCurrentSort = 'time';
let depSortAsc = true;

function setDepSort(key) {
  if (depCurrentSort === key) depSortAsc = !depSortAsc;
  else { depCurrentSort = key; depSortAsc = true; }
  document.querySelectorAll('[id^="sort-"]').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById(`sort-${key}-btn`);
  if (btn) btn.classList.add('active');
  renderDepartures();
}

function renderDepartures() {
  const filterAirline = document.getElementById('dep-filter-airline')?.value || '';
  const filterAirport = document.getElementById('dep-filter-airport')?.value || '';
  const filterStatus = document.getElementById('dep-filter-status')?.value || '';
  const filterType = document.getElementById('dep-filter-type')?.value || '';
  const search = (document.getElementById('dep-search')?.value || '').toLowerCase();

  let data = [...allDepartures];

  if (filterAirline) data = data.filter(f => f._src === filterAirline);
  if (filterAirport) data = data.filter(f => {
    const c = getAirportCode(f['odpt:departureAirport']);
    return c === filterAirport;
  });
  if (filterStatus) {
    if (filterStatus === 'delay') data = data.filter(f => isDelayed(f,'dep'));
    if (filterStatus === 'cancel') data = data.filter(f => isCancelled(f));
    if (filterStatus === 'ontime') data = data.filter(f => !isDelayed(f,'dep') && !isCancelled(f));
    if (filterStatus === 'inair') data = data.filter(f => (f['odpt:flightStatus']||'').includes('InAir'));
  }
  if (filterType) {
    if (filterType === 'intl') data = data.filter(f => isIntl(f['odpt:departureAirport'], f['odpt:destinationAirport']));
    if (filterType === 'domestic') data = data.filter(f => !isIntl(f['odpt:departureAirport'], f['odpt:destinationAirport']));
  }
  if (search) data = data.filter(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/').toLowerCase();
    const dest = getAirportCode(f['odpt:destinationAirport']).toLowerCase();
    const destName = (AIRPORTS[getAirportCode(f['odpt:destinationAirport'])]||'').toLowerCase();
    return fn.includes(search) || dest.includes(search) || destName.includes(search);
  });

  // Sort
  data.sort((a, b) => {
    let va, vb;
    if (depCurrentSort === 'time') {
      va = a['odpt:scheduledDepartureTime'] || '99:99';
      vb = b['odpt:scheduledDepartureTime'] || '99:99';
    } else if (depCurrentSort === 'airline') {
      va = a._src; vb = b._src;
    } else if (depCurrentSort === 'status') {
      va = a['odpt:flightStatus'] || 'z'; vb = b['odpt:flightStatus'] || 'z';
    } else {
      va = (a['odpt:flightNumber']||[''])[0];
      vb = (b['odpt:flightNumber']||[''])[0];
    }
    return depSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
  });

  document.getElementById('dep-count').textContent = `${data.length} ä»¶`;

  const tbody = document.getElementById('dep-tbody');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11"><div class="empty-state"><div class="empty-icon">ğŸ›«</div>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ä¾¿ãŒã‚ã‚Šã¾ã›ã‚“</div></td></tr>';
    return;
  }

  tbody.innerHTML = data.map(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const depAP = getAirportCode(f['odpt:departureAirport']);
    const destAP = getAirportCode(f['odpt:destinationAirport']);
    const sched = f['odpt:scheduledDepartureTime'] || '-';
    const actual = f['odpt:actualDepartureTime'] || '-';
    const est = f['odpt:estimatedDepartureTime'] || '-';
    const gate = f['odpt:departureGate'] || '-';
    const aircraft = f['odpt:aircraftType'] || '-';
    const status = getDepStatusClass(f);
    const intlTag = isIntl(f['odpt:departureAirport'], f['odpt:destinationAirport'])
      ? '<span class="tag tag-intl">å›½éš›</span>' : '<span class="tag tag-domestic">å›½å†…</span>';

    return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, 'dep')">
      <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
      <td>${airlineBadge(f._src)}</td>
      <td><span class="airport-code">${depAP}</span><span style="font-size:10px;color:var(--text-muted);margin-left:4px">${AIRPORTS[depAP]||''}</span></td>
      <td><span class="airport-code">${destAP}</span><span style="font-size:10px;color:var(--text-muted);margin-left:4px">${AIRPORTS[destAP]||''}</span></td>
      <td class="time-cell">${sched}</td>
      <td class="time-cell ${actual !== '-' ? (timeDiff(sched,actual)>0 ? 'time-delayed' : 'time-early') : ''}">${actual}</td>
      <td class="time-cell ${est !== '-' ? (timeDiff(sched,est)>0 ? 'time-delayed' : '') : ''}">${est}</td>
      <td>${gate !== '-' ? `<span class="gate-cell">${gate}</span>` : '-'}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-secondary)">${aircraft}</td>
      <td><span class="status-badge ${status.cls}">${status.label}</span></td>
      <td>${intlTag}</td>
    </tr>`;
  }).join('');
}

// =============================================
// ARRIVALS RENDER
// =============================================
function renderArrivals() {
  const filterAirline = document.getElementById('arr-filter-airline')?.value || '';
  const filterAirport = document.getElementById('arr-filter-airport')?.value || '';
  const filterStatus = document.getElementById('arr-filter-status')?.value || '';
  const search = (document.getElementById('arr-search')?.value || '').toLowerCase();

  let data = [...allArrivals];
  if (filterAirline) data = data.filter(f => f._src === filterAirline);
  if (filterAirport) data = data.filter(f => getAirportCode(f['odpt:arrivalAirport']) === filterAirport);
  if (filterStatus) {
    if (filterStatus === 'delay') data = data.filter(f => isDelayed(f,'arr'));
    if (filterStatus === 'cancel') data = data.filter(f => isCancelled(f));
    if (filterStatus === 'ontime') data = data.filter(f => !isDelayed(f,'arr') && !isCancelled(f));
  }
  if (search) data = data.filter(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/').toLowerCase();
    const orig = getAirportCode(f['odpt:originAirport']).toLowerCase();
    return fn.includes(search) || orig.includes(search);
  });

  data.sort((a,b) => {
    const ta = a['odpt:scheduledArrivalTime'] || '99:99';
    const tb = b['odpt:scheduledArrivalTime'] || '99:99';
    return ta.localeCompare(tb);
  });

  document.getElementById('arr-count').textContent = `${data.length} ä»¶`;

  const tbody = document.getElementById('arr-tbody');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11"><div class="empty-state"><div class="empty-icon">ğŸ›¬</div>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ä¾¿ãŒã‚ã‚Šã¾ã›ã‚“</div></td></tr>';
    return;
  }

  tbody.innerHTML = data.map(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const arrAP = getAirportCode(f['odpt:arrivalAirport']);
    const origAP = getAirportCode(f['odpt:originAirport']);
    const sched = f['odpt:scheduledArrivalTime'] || '-';
    const actual = f['odpt:actualArrivalTime'] || '-';
    const est = f['odpt:estimatedArrivalTime'] || '-';
    const term = getTerminal(f['odpt:arrivalAirportTerminal']);
    const aircraft = f['odpt:aircraftType'] || '-';
    const status = getDepStatusClass(f);
    const intlTag = isIntl(f['odpt:originAirport'], f['odpt:arrivalAirport'])
      ? '<span class="tag tag-intl">å›½éš›</span>' : '<span class="tag tag-domestic">å›½å†…</span>';

    return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, 'arr')">
      <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
      <td>${airlineBadge(f._src)}</td>
      <td><span class="airport-code">${arrAP}</span><span style="font-size:10px;color:var(--text-muted);margin-left:4px">${AIRPORTS[arrAP]||''}</span></td>
      <td><span class="airport-code">${origAP}</span><span style="font-size:10px;color:var(--text-muted);margin-left:4px">${AIRPORTS[origAP]||''}</span></td>
      <td class="time-cell">${sched}</td>
      <td class="time-cell ${actual !== '-' ? (timeDiff(sched,actual)>0 ? 'time-delayed' : 'time-early') : ''}">${actual}</td>
      <td class="time-cell ${est !== '-' ? (timeDiff(sched,est)>0 ? 'time-delayed' : '') : ''}">${est}</td>
      <td style="font-size:12px;color:var(--text-secondary)">${term}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-secondary)">${aircraft}</td>
      <td><span class="status-badge ${status.cls}">${status.label}</span></td>
      <td>${intlTag}</td>
    </tr>`;
  }).join('');
}

// =============================================
// SCHEDULE RENDER
// =============================================
function renderSchedule() {
  const filterAirline = document.getElementById('sched-filter-airline')?.value || '';
  const filterOrigin = document.getElementById('sched-filter-origin')?.value || '';
  const filterDest = document.getElementById('sched-filter-dest')?.value || '';
  const search = (document.getElementById('sched-search')?.value || '').toLowerCase();

  // Flatten schedule objects
  let rows = [];
  allSchedules.forEach(s => {
    const airline = getAirlineKey(s['odpt:operator']);
    const orig = getAirportCode(s['odpt:originAirport']);
    const dest = getAirportCode(s['odpt:destinationAirport']);
    const cal = CALENDAR_MAP[s['odpt:calendar']] || s['odpt:calendar']?.replace('odpt.Calendar:','') || '';
    (s['odpt:flightScheduleObject'] || []).forEach(obj => {
      rows.push({ airline, orig, dest, cal,
        flightNum: (obj['odpt:flightNumber']||[]).join('/'),
        origTime: obj['odpt:originTime'] || '-',
        destTime: obj['odpt:destinationTime'] || '-',
        aircraft: obj['odpt:aircraftType'] || '-',
        validFrom: obj['odpt:isValidFrom'] ? obj['odpt:isValidFrom'].substring(0,10) : '-',
        validTo: obj['odpt:isValidTo'] ? obj['odpt:isValidTo'].substring(0,10) : '-',
        note: (obj['odpt:note']||{}).ja || '',
        src: s._src,
      });
    });
  });

  if (filterAirline) rows = rows.filter(r => r.src === filterAirline);
  if (filterOrigin) rows = rows.filter(r => r.orig === filterOrigin);
  if (filterDest) rows = rows.filter(r => r.dest === filterDest);
  if (search) rows = rows.filter(r =>
    r.flightNum.toLowerCase().includes(search) ||
    r.orig.toLowerCase().includes(search) ||
    r.dest.toLowerCase().includes(search)
  );

  rows.sort((a,b) => a.origTime.localeCompare(b.origTime));

  document.getElementById('sched-count').textContent = `${rows.length} ä»¶`;

  const tbody = document.getElementById('sched-tbody');
  if (rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ğŸ“…</div>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ™‚åˆ»è¡¨ãŒã‚ã‚Šã¾ã›ã‚“</div></td></tr>';
    return;
  }

  tbody.innerHTML = rows.slice(0, 500).map(r => `
    <tr class="schedule-row">
      <td><span class="flight-num ${flightNumClass(r.src)}">${r.flightNum}</span></td>
      <td>${airlineBadge(r.src)}</td>
      <td><span class="airport-code">${r.orig}</span><span style="font-size:10px;color:var(--text-muted);margin-left:4px">${AIRPORTS[r.orig]||''}</span></td>
      <td><span class="airport-code">${r.dest}</span><span style="font-size:10px;color:var(--text-muted);margin-left:4px">${AIRPORTS[r.dest]||''}</span></td>
      <td class="time-cell">${r.origTime}</td>
      <td class="time-cell">${r.destTime}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-secondary)">${r.aircraft}</td>
      <td style="font-size:11px;color:var(--text-secondary)">${r.cal}</td>
      <td style="font-size:10px;color:var(--text-muted)">${r.validFrom}ã€œ${r.validTo}${r.note ? `<br><span style="color:var(--accent-amber)">${r.note}</span>` : ''}</td>
    </tr>
  `).join('');
}

// =============================================
// ANALYTICS RENDER
// =============================================
function renderAnalytics() {
  const total = allDepartures.length + allArrivals.length;
  const delays = allDepartures.filter(f => isDelayed(f,'dep')).length;
  const cancels = [...allDepartures,...allArrivals].filter(isCancelled).length;
  const inair = allDepartures.filter(f => (f['odpt:flightStatus']||'').includes('InAir')).length;
  const ontime = total > 0 ? Math.round(((total - delays - cancels) / total) * 100) : 0;

  document.getElementById('ana-ontime').textContent = ontime + '%';
  document.getElementById('ana-delay-rate').textContent = total>0 ? Math.round(delays/total*100)+'%' : '-';
  document.getElementById('ana-cancel-rate').textContent = total>0 ? Math.round(cancels/total*100)+'%' : '-';
  document.getElementById('ana-inair').textContent = inair;

  // Status pie
  const statusCounts = {};
  [...allDepartures].forEach(f => {
    const s = getDepStatusClass(f).label;
    statusCounts[s] = (statusCounts[s]||0) + 1;
  });

  renderChart('chart-status-pie', 'doughnut', {
    labels: Object.keys(statusCounts),
    datasets: [{
      data: Object.values(statusCounts),
      backgroundColor: ['#00d4ff','#00e676','#ffb700','#ff3b5c','#c084fc','#7aa8cc','#444'],
      borderColor: 'rgba(0,0,0,0.3)',
      borderWidth: 1,
    }]
  }, {
    plugins: { legend: { labels: { color: '#7aa8cc', font: { size: 11 } } } }
  });

  // Hourly chart
  const hourly = new Array(24).fill(0);
  const hourlyArr = new Array(24).fill(0);
  allDepartures.forEach(f => {
    const h = getTimeHour(f['odpt:scheduledDepartureTime']);
    if (h >= 0) hourly[h]++;
  });
  allArrivals.forEach(f => {
    const h = getTimeHour(f['odpt:scheduledArrivalTime']);
    if (h >= 0) hourlyArr[h]++;
  });

  const labels24 = Array.from({length:24}, (_,i) => `${String(i).padStart(2,'0')}:00`);

  renderChart('chart-hourly', 'bar', {
    labels: labels24,
    datasets: [{
      label: 'å‡ºç™ºä¾¿',
      data: hourly,
      backgroundColor: 'rgba(0,212,255,0.5)',
      borderColor: 'rgba(0,212,255,0.8)',
      borderWidth: 1,
    },{
      label: 'åˆ°ç€ä¾¿',
      data: hourlyArr,
      backgroundColor: 'rgba(0,230,118,0.4)',
      borderColor: 'rgba(0,230,118,0.7)',
      borderWidth: 1,
    }]
  }, {
    plugins: { legend: { labels: { color: '#7aa8cc', font:{size:11} } } },
    scales: {
      x: { ticks: { color: '#3d6a8a', font:{size:9} }, grid: { color: 'rgba(0,212,255,0.05)' } },
      y: { ticks: { color: '#3d6a8a', font:{size:10} }, grid: { color: 'rgba(0,212,255,0.08)' } }
    }
  });

  // Airline bar chart
  const airlineData = {};
  [...allDepartures, ...allArrivals].forEach(f => {
    airlineData[f._src] = (airlineData[f._src]||0) + 1;
  });
  const airlineColors = { JAL:'rgba(230,0,51,0.7)', ANA:'rgba(26,86,219,0.7)', 'HND-TIAT':'rgba(0,255,204,0.6)', NAA:'rgba(255,183,0,0.6)' };
  renderChart('chart-airline-bar', 'bar', {
    labels: Object.keys(airlineData).map(k => k === 'HND-TIAT' ? 'ç¾½ç”°å›½éš›' : k === 'NAA' ? 'æˆç”°' : k),
    datasets: [{
      label: 'ä¾¿æ•°',
      data: Object.values(airlineData),
      backgroundColor: Object.keys(airlineData).map(k => airlineColors[k]||'rgba(120,120,120,0.5)'),
      borderRadius: 4,
    }]
  }, {
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: '#7aa8cc', font:{size:12} }, grid: { color: 'rgba(0,212,255,0.05)' } },
      y: { ticks: { color: '#3d6a8a', font:{size:10} }, grid: { color: 'rgba(0,212,255,0.08)' } }
    }
  });

  // Dep vs Arr line
  renderChart('chart-dep-arr-line', 'line', {
    labels: labels24,
    datasets: [{
      label: 'å‡ºç™ºä¾¿',
      data: hourly,
      borderColor: 'rgba(0,212,255,0.8)',
      backgroundColor: 'rgba(0,212,255,0.1)',
      fill: true,
      tension: 0.4,
      pointRadius: 2,
    },{
      label: 'åˆ°ç€ä¾¿',
      data: hourlyArr,
      borderColor: 'rgba(255,183,0,0.8)',
      backgroundColor: 'rgba(255,183,0,0.1)',
      fill: true,
      tension: 0.4,
      pointRadius: 2,
    }]
  }, {
    plugins: { legend: { labels: { color: '#7aa8cc', font:{size:11} } } },
    scales: {
      x: { ticks: { color: '#3d6a8a', font:{size:9} }, grid: { color: 'rgba(0,212,255,0.05)' } },
      y: { ticks: { color: '#3d6a8a', font:{size:10} }, grid: { color: 'rgba(0,212,255,0.08)' } }
    }
  });
}

function renderChart(id, type, data, options={}) {
  const canvas = document.getElementById(id);
  if (!canvas) return;
  if (charts[id]) { charts[id].destroy(); }
  charts[id] = new Chart(canvas, {
    type,
    data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      ...options,
      plugins: {
        ...(options.plugins||{}),
        legend: {
          ...(options.plugins?.legend||{}),
          labels: {
            color: '#7aa8cc',
            font: { size: 11 },
            ...(options.plugins?.legend?.labels||{}),
          }
        }
      }
    }
  });
}

// =============================================
// DELAY LIST
// =============================================
function renderDelayList() {
  const delayed = allDepartures.filter(f => isDelayed(f,'dep') || isCancelled(f));
  const tbody = document.getElementById('delay-tbody');
  if (delayed.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">âœ…</div>é…å»¶ãƒ»æ¬ èˆªä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div></td></tr>';
    return;
  }
  tbody.innerHTML = delayed.map(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const depAP = getAirportCode(f['odpt:departureAirport']);
    const destAP = getAirportCode(f['odpt:destinationAirport']);
    const sched = f['odpt:scheduledDepartureTime'] || '-';
    const actual = f['odpt:actualDepartureTime'] || f['odpt:estimatedDepartureTime'] || '-';
    const d = timeDiff(sched, actual);
    const reason = (f['odpt:flightInformationText']||{}).ja || (f['odpt:flightInformationSummary']||{}).ja || '-';
    const status = getDepStatusClass(f);
    return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, 'dep')">
      <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
      <td>${airlineBadge(f._src)}</td>
      <td>${depAP}â†’${destAP}</td>
      <td class="time-cell">${sched}</td>
      <td class="time-cell time-delayed">${actual}</td>
      <td>${d !== null && d > 0 ? `<span style="color:var(--accent-amber);font-family:'Share Tech Mono',monospace">+${d}åˆ†</span>` : isCancelled(f) ? '<span class="status-badge status-cancel">æ¬ èˆª</span>' : '-'}</td>
      <td style="font-size:11px;color:var(--text-secondary);max-width:200px">${reason}</td>
    </tr>`;
  }).join('');
}

// =============================================
// FLIGHT DETAIL MODAL
// =============================================
function showFlightDetail(jsonStr, type) {
  const f = JSON.parse(jsonStr);
  const fn = (f['odpt:flightNumber']||[]).join(' / ');
  const status = getDepStatusClass(f);
  const airline = f._src || getAirlineKey(f['odpt:airline']);

  document.getElementById('modal-title').textContent = `âœˆ ${fn}`;

  let html = '';

  // Status banner
  html += `<div style="background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:6px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;gap:16px">
    ${airlineBadge(airline)}
    <span class="status-badge ${status.cls}" style="font-size:14px;padding:6px 14px">${status.label}</span>
    <span style="font-size:12px;color:var(--text-secondary);margin-left:auto">æ©Ÿæ: <strong style="color:var(--text-primary)">${f['odpt:aircraftType']||'-'}</strong></span>
  </div>`;

  if (type === 'dep') {
    const depAP = getAirportCode(f['odpt:departureAirport']);
    const destAP = getAirportCode(f['odpt:destinationAirport']);
    const sched = f['odpt:scheduledDepartureTime'] || '-';
    const actual = f['odpt:actualDepartureTime'] || '-';
    const est = f['odpt:estimatedDepartureTime'] || '-';
    const gate = f['odpt:departureGate'] || '-';
    const term = getTerminal(f['odpt:departureAirportTerminal']);
    const d = timeDiff(sched, actual !== '-' ? actual : est);

    html += `<div class="detail-grid" style="margin-bottom:16px">
      <div class="detail-item"><div class="detail-label">å‡ºç™ºç©ºæ¸¯</div><div class="detail-value"><span class="airport-code">${depAP}</span> ${AIRPORTS[depAP]||''}</div></div>
      <div class="detail-item"><div class="detail-label">ç›®çš„åœ°</div><div class="detail-value"><span class="airport-code">${destAP}</span> ${AIRPORTS[destAP]||''}</div></div>
      <div class="detail-item"><div class="detail-label">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</div><div class="detail-value">${term}</div></div>
      <div class="detail-item"><div class="detail-label">æ­ä¹—å£</div><div class="detail-value">${gate !== '-' ? `<span class="gate-cell">${gate}</span>` : '-'}</div></div>
    </div>`;

    html += `<div style="background:rgba(0,0,0,0.2);border-radius:6px;padding:14px;margin-bottom:16px">
      <div style="font-size:11px;color:var(--text-muted);letter-spacing:1px;margin-bottom:10px">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
      <div class="timeline-row">
        <div class="timeline-label">å®šåˆ»å‡ºç™º</div>
        <div class="timeline-time">${sched}</div>
      </div>
      ${actual !== '-' ? `<div class="timeline-row">
        <div class="timeline-label">å®Ÿç¸¾å‡ºç™º</div>
        <div class="timeline-time ${d&&d>0?'time-delayed':d&&d<0?'time-early':''}">${actual}</div>
        <div class="timeline-delta">${formatDiff(d)}</div>
      </div>` : ''}
      ${est !== '-' ? `<div class="timeline-row">
        <div class="timeline-label">äºˆå®šå‡ºç™º</div>
        <div class="timeline-time ${d&&d>0?'time-delayed':''}">${est}</div>
        <div class="timeline-delta">${formatDiff(d)}</div>
      </div>` : ''}
    </div>`;
  } else {
    const arrAP = getAirportCode(f['odpt:arrivalAirport']);
    const origAP = getAirportCode(f['odpt:originAirport']);
    const sched = f['odpt:scheduledArrivalTime'] || '-';
    const actual = f['odpt:actualArrivalTime'] || '-';
    const est = f['odpt:estimatedArrivalTime'] || '-';
    const term = getTerminal(f['odpt:arrivalAirportTerminal']);
    const d = timeDiff(sched, actual !== '-' ? actual : est);

    html += `<div class="detail-grid" style="margin-bottom:16px">
      <div class="detail-item"><div class="detail-label">åˆ°ç€ç©ºæ¸¯</div><div class="detail-value"><span class="airport-code">${arrAP}</span> ${AIRPORTS[arrAP]||''}</div></div>
      <div class="detail-item"><div class="detail-label">å‡ºç™ºåœ°</div><div class="detail-value"><span class="airport-code">${origAP}</span> ${AIRPORTS[origAP]||''}</div></div>
      <div class="detail-item"><div class="detail-label">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</div><div class="detail-value">${term}</div></div>
      <div class="detail-item"><div class="detail-label">åŒºåˆ†</div><div class="detail-value">${isIntl(f['odpt:originAirport'], f['odpt:arrivalAirport']) ? '<span class="tag tag-intl">å›½éš›ç·š</span>' : '<span class="tag tag-domestic">å›½å†…ç·š</span>'}</div></div>
    </div>`;

    html += `<div style="background:rgba(0,0,0,0.2);border-radius:6px;padding:14px;margin-bottom:16px">
      <div style="font-size:11px;color:var(--text-muted);letter-spacing:1px;margin-bottom:10px">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
      <div class="timeline-row">
        <div class="timeline-label">å®šåˆ»åˆ°ç€</div>
        <div class="timeline-time">${sched}</div>
      </div>
      ${actual !== '-' ? `<div class="timeline-row">
        <div class="timeline-label">å®Ÿç¸¾åˆ°ç€</div>
        <div class="timeline-time ${d&&d>0?'time-delayed':d&&d<0?'time-early':''}">${actual}</div>
        <div class="timeline-delta">${formatDiff(d)}</div>
      </div>` : ''}
      ${est !== '-' ? `<div class="timeline-row">
        <div class="timeline-label">äºˆå®šåˆ°ç€</div>
        <div class="timeline-time ${d&&d>0?'time-delayed':''}">${est}</div>
        <div class="timeline-delta">${formatDiff(d)}</div>
      </div>` : ''}
    </div>`;
  }

  // Flight info text
  const infoText = (f['odpt:flightInformationText']||{}).ja;
  const infoSummary = (f['odpt:flightInformationSummary']||{}).ja;
  if (infoText || infoSummary) {
    html += `<div style="background:rgba(255,183,0,0.08);border:1px solid rgba(255,183,0,0.2);border-radius:6px;padding:12px;margin-bottom:16px">
      <div style="font-size:11px;color:var(--accent-amber);letter-spacing:1px;margin-bottom:6px">â„¹ ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±</div>
      ${infoSummary ? `<div style="font-size:13px;font-weight:600;color:var(--accent-amber);margin-bottom:4px">${infoSummary}</div>` : ''}
      ${infoText ? `<div style="font-size:12px;color:var(--text-secondary)">${infoText}</div>` : ''}
    </div>`;
  }

  // Raw data (collapsible)
  html += `<details style="margin-top:8px">
    <summary style="font-size:11px;color:var(--text-muted);cursor:pointer;letter-spacing:1px">â–¶ ç”Ÿãƒ‡ãƒ¼ã‚¿ (JSON)</summary>
    <pre style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text-muted);background:rgba(0,0,0,0.3);padding:10px;border-radius:4px;overflow-x:auto;margin-top:8px">${JSON.stringify(f, null, 2)}</pre>
  </details>`;

  document.getElementById('modal-body').innerHTML = html;
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal(e) {
  if (e.target.id === 'modal-overlay') closeModalDirect();
}
function closeModalDirect() {
  document.getElementById('modal-overlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModalDirect(); });

// =============================================
// PAGE NAVIGATION
// =============================================
function showPage(name, tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`page-${name}`).classList.add('active');
  if (tab) tab.classList.add('active');

  // Trigger chart rendering when analytics tab is opened
  if (name === 'analytics') setTimeout(renderAnalytics, 50);
  if (name === 'history') renderHistory();
  if (name === 'hnd') renderHnd();
  if (name === 'alerts') renderAlerts();
  if (name === 'hnd') { hndQuickMode = 'all'; renderHnd(); }
  if (name === 'alerts') renderAlerts();
}

// =============================================
// DATA SNAPSHOT STORAGE
// =============================================
function saveSnapshot() {
  const snapshot = {
    timestamp: new Date().toISOString(),
    departures: allDepartures.length,
    arrivals: allArrivals.length,
    delays: allDepartures.filter(f=>isDelayed(f,'dep')).length,
    cancels: [...allDepartures,...allArrivals].filter(isCancelled).length,
    data: { departures: allDepartures.slice(0, 50), arrivals: allArrivals.slice(0, 50) }
  };
  try {
    const history = JSON.parse(localStorage.getItem('flightHistory') || '[]');
    history.unshift(snapshot);
    if (history.length > 20) history.length = 20;
    localStorage.setItem('flightHistory', JSON.stringify(history));
    showToast('âœ… ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    renderHistory();
  } catch(e) {
    showToast('âš  ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡è¶…éã®å¯èƒ½æ€§ï¼‰');
  }
}

function renderHistory() {
  const el = document.getElementById('history-list');
  try {
    const history = JSON.parse(localStorage.getItem('flightHistory') || '[]');
    if (history.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‚</div>ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br><small style="font-size:11px;margin-top:8px;display:block">ã€ŒğŸ’¾ ä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—ã§ãã¾ã™</small></div>';
      return;
    }
    el.innerHTML = history.map((s, i) => {
      const dt = new Date(s.timestamp).toLocaleString('ja-JP');
      const ontime = (s.departures + s.arrivals) > 0
        ? Math.round(((s.departures + s.arrivals - s.delays - s.cancels) / (s.departures + s.arrivals)) * 100) : 0;
      return `<div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:16px">
        <div>
          <div style="font-size:11px;color:var(--text-muted)">#${i+1}</div>
          <div style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--accent-blue);margin-top:2px">${dt}</div>
        </div>
        <div style="display:flex;gap:20px;flex:1">
          <div style="text-align:center"><div style="font-size:18px;font-weight:700">${s.departures + s.arrivals}</div><div style="font-size:10px;color:var(--text-muted)">ç·ä¾¿æ•°</div></div>
          <div style="text-align:center"><div style="font-size:18px;font-weight:700;color:var(--accent-amber)">${s.delays}</div><div style="font-size:10px;color:var(--text-muted)">é…å»¶</div></div>
          <div style="text-align:center"><div style="font-size:18px;font-weight:700;color:var(--accent-red)">${s.cancels}</div><div style="font-size:10px;color:var(--text-muted)">æ¬ èˆª</div></div>
          <div style="text-align:center"><div style="font-size:18px;font-weight:700;color:var(--accent-green)">${ontime}%</div><div style="font-size:10px;color:var(--text-muted)">å®šæ™‚ç‡</div></div>
        </div>
        <button onclick="deleteSnapshot(${i})" style="background:none;border:1px solid rgba(255,59,92,0.3);color:var(--accent-red);padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px">å‰Šé™¤</button>
      </div>`;
    }).join('');
  } catch(e) {
    el.innerHTML = '<div class="empty-state">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

function deleteSnapshot(i) {
  try {
    const history = JSON.parse(localStorage.getItem('flightHistory') || '[]');
    history.splice(i, 1);
    localStorage.setItem('flightHistory', JSON.stringify(history));
    renderHistory();
  } catch(e) {}
}

function clearHistory() {
  if (confirm('å…¨ã¦ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    localStorage.removeItem('flightHistory');
    renderHistory();
    showToast('ğŸ—‘ å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  }
}

// =============================================
// HND SPECIAL â€” STATE
// =============================================
let hndTerminal = 'all';
let hndView = 'infoboard';
let hndDir = 'both';
let hndSortKey = 'time';
let hndSortAsc = true;
let hndQuickMode = 'all'; // all/dep/arr/boarding/inair/delay/cancel
let alertAirport = 'all';

// =============================================
// HND: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒ»è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ãƒ»æ–¹å‘ãƒ»ã‚½ãƒ¼ãƒˆã‚»ãƒƒã‚¿ãƒ¼
// =============================================
function setHndTerminal(val, btn) {
  hndTerminal = val;
  document.querySelectorAll('.terminal-tabs .terminal-tab').forEach(b => {
    if (b.closest('#page-hnd .hnd-header')) b.classList.remove('active');
  });
  btn.classList.add('active');
  renderHnd();
}
function setHndView(val, btn) {
  hndView = val;
  btn.closest('.terminal-tabs').querySelectorAll('.terminal-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderHnd();
}
function setHndDir(val, btn) {
  hndDir = val;
  ['hnd-dir-both','hnd-dir-dep','hnd-dir-arr'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
  btn.classList.add('active');
  renderHnd();
}
function setHndSort(key, btn) {
  if (hndSortKey === key) hndSortAsc = !hndSortAsc;
  else { hndSortKey = key; hndSortAsc = true; }
  document.querySelectorAll('#hnd-sort-chips .sort-chip').forEach(b => {
    b.classList.remove('active','asc','desc');
  });
  btn.classList.add('active', hndSortAsc ? 'asc' : 'desc');
  renderHnd();
}
function hndQuickFilter(mode) {
  hndQuickMode = mode;
  if (mode === 'dep') { hndDir = 'dep'; document.getElementById('hnd-dir-dep').click(); }
  else if (mode === 'arr') { hndDir = 'arr'; document.getElementById('hnd-dir-arr').click(); }
  else renderHnd();
}
function setAlertAirport(ap, btn) {
  alertAirport = ap;
  btn.closest('div').querySelectorAll('.terminal-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderAlerts();
}

// =============================================
// HND: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
// =============================================
function getHndFlights() {
  // ç¾½ç”°é–¢ä¿‚ã®ãƒ•ãƒ©ã‚¤ãƒˆã‚’å‡ºç™ºãƒ»åˆ°ç€ã‹ã‚‰æŠ½å‡º
  const depFlights = allDepartures.filter(f => {
    const ap = getAirportCode(f['odpt:departureAirport']);
    return ap === 'HND';
  }).map(f => ({...f, _dir:'dep'}));

  const arrFlights = allArrivals.filter(f => {
    const ap = getAirportCode(f['odpt:arrivalAirport']);
    return ap === 'HND';
  }).map(f => ({...f, _dir:'arr'}));

  let flights = [];
  if (hndDir === 'both') flights = [...depFlights, ...arrFlights];
  else if (hndDir === 'dep') flights = depFlights;
  else flights = arrFlights;

  // ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãƒ•ã‚£ãƒ«ã‚¿
  if (hndTerminal !== 'all') {
    flights = flights.filter(f => {
      const t = getTerminal(f['odpt:departureAirportTerminal'] || f['odpt:arrivalAirportTerminal']);
      return t === 'T' + hndTerminal;
    });
  }

  // ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿
  if (hndQuickMode === 'boarding') {
    flights = flights.filter(f => (f['odpt:flightStatus']||'').includes('Boarding') || (f['odpt:flightStatus']||'').includes('GateClosed'));
  } else if (hndQuickMode === 'inair') {
    flights = flights.filter(f => (f['odpt:flightStatus']||'').includes('InAir'));
  } else if (hndQuickMode === 'delay') {
    flights = flights.filter(f => {
      if (f._dir === 'dep') return isDelayed(f,'dep');
      return isDelayed(f,'arr');
    });
  } else if (hndQuickMode === 'cancel') {
    flights = flights.filter(f => isCancelled(f));
  }

  // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
  const search = (document.getElementById('hnd-search')?.value || '').toLowerCase();
  if (search) {
    flights = flights.filter(f => {
      const fn = (f['odpt:flightNumber']||[]).join('/').toLowerCase();
      const dest = getAirportCode(f['odpt:destinationAirport'] || f['odpt:originAirport']).toLowerCase();
      const destName = (AIRPORTS[getAirportCode(f['odpt:destinationAirport'] || f['odpt:originAirport'])]||'').toLowerCase();
      const gate = (f['odpt:departureGate']||'').toLowerCase();
      return fn.includes(search) || dest.includes(search) || destName.includes(search) || gate.includes(search);
    });
  }

  // ã‚½ãƒ¼ãƒˆ
  flights.sort((a, b) => {
    let va, vb;
    const getSchedTime = f => f._dir === 'dep'
      ? (f['odpt:scheduledDepartureTime'] || '99:99')
      : (f['odpt:scheduledArrivalTime'] || '99:99');
    const getDelayMins = f => {
      if (f._dir === 'dep') return timeDiff(f['odpt:scheduledDepartureTime'], f['odpt:actualDepartureTime']||f['odpt:estimatedDepartureTime']) || 0;
      return timeDiff(f['odpt:scheduledArrivalTime'], f['odpt:actualArrivalTime']||f['odpt:estimatedArrivalTime']) || 0;
    };
    switch (hndSortKey) {
      case 'time': va = getSchedTime(a); vb = getSchedTime(b); break;
      case 'flightNum': va=(a['odpt:flightNumber']||[''])[0]; vb=(b['odpt:flightNumber']||[''])[0]; break;
      case 'airline': va=a._src; vb=b._src; break;
      case 'status': va=a['odpt:flightStatus']||'z'; vb=b['odpt:flightStatus']||'z'; break;
      case 'delay': va=getDelayMins(a); vb=getDelayMins(b); return hndSortAsc ? va-vb : vb-va;
      case 'destination':
        va = getAirportCode(a['odpt:destinationAirport']||a['odpt:originAirport']);
        vb = getAirportCode(b['odpt:destinationAirport']||b['odpt:originAirport']); break;
      case 'terminal':
        va = getTerminal(a['odpt:departureAirportTerminal']||a['odpt:arrivalAirportTerminal']);
        vb = getTerminal(b['odpt:departureAirportTerminal']||b['odpt:arrivalAirportTerminal']); break;
      case 'gate': va=a['odpt:departureGate']||'zzz'; vb=b['odpt:departureGate']||'zzz'; break;
      case 'aircraft': va=a['odpt:aircraftType']||''; vb=b['odpt:aircraftType']||''; break;
      case 'type':
        va = isIntl(a['odpt:departureAirport']||a['odpt:originAirport'], a['odpt:destinationAirport']||a['odpt:arrivalAirport']) ? 'å›½éš›' : 'å›½å†…';
        vb = isIntl(b['odpt:departureAirport']||b['odpt:originAirport'], b['odpt:destinationAirport']||b['odpt:arrivalAirport']) ? 'å›½éš›' : 'å›½å†…'; break;
      default: va=getSchedTime(a); vb=getSchedTime(b);
    }
    const cmp = String(va).localeCompare(String(vb), 'ja');
    return hndSortAsc ? cmp : -cmp;
  });

  return flights;
}

// =============================================
// HND: KPIæ›´æ–°
// =============================================
function updateHndKpi() {
  const depAll = allDepartures.filter(f => getAirportCode(f['odpt:departureAirport'])==='HND');
  const arrAll = allArrivals.filter(f => getAirportCode(f['odpt:arrivalAirport'])==='HND');
  const all = [...depAll, ...arrAll];

  const boarding = depAll.filter(f => {
    const s = f['odpt:flightStatus']||'';
    return s.includes('Boarding') || s.includes('GateClosed');
  });
  const inair = depAll.filter(f => (f['odpt:flightStatus']||'').includes('InAir'));
  const delays = depAll.filter(f => isDelayed(f,'dep'));
  const cancels = all.filter(f => isCancelled(f));
  const total = all.length;
  const ontime = total > 0 ? Math.round(((total - delays.length - cancels.length) / total)*100) : 0;

  document.getElementById('hnd-kpi-total').textContent = total;
  document.getElementById('hnd-kpi-dep').textContent = depAll.length;
  document.getElementById('hnd-kpi-arr').textContent = arrAll.length;
  document.getElementById('hnd-kpi-boarding').textContent = boarding.length;
  document.getElementById('hnd-kpi-inair').textContent = inair.length;
  document.getElementById('hnd-kpi-delay').textContent = delays.length;
  document.getElementById('hnd-kpi-cancel').textContent = cancels.length;
  document.getElementById('hnd-kpi-ontime').textContent = ontime + '%';

  // ãŠå®¢æ§˜æ¡ˆå†…ãƒãƒŠãƒ¼
  const announceArea = document.getElementById('hnd-announce-area');
  const banners = [];

  if (cancels.length > 0) {
    const nums = cancels.slice(0,3).map(f=>(f['odpt:flightNumber']||[]).join('/')).join('ã€');
    banners.push(`<div class="announce-banner">
      <div class="announce-icon">ğŸš«</div>
      <div class="announce-content">
        <div class="announce-title">âš  æ¬ èˆªä¾¿ã®ã”æ¡ˆå†…</div>
        <div class="announce-body">æœ¬æ—¥ã®æ¬ èˆªä¾¿: <strong style="color:var(--accent-red)">${nums}${cancels.length>3?' ã»ã‹'+(cancels.length-3)+'ä¾¿':''}</strong>ã€‚ä»£æ›¿ä¾¿ã‚„æ‰•ã„æˆ»ã—ã«ã¤ã„ã¦ã¯å„ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</div>
        <div class="announce-time">æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP',{hour12:false})}</div>
      </div>
    </div>`);
  }

  if (delays.length > 0) {
    const worst = delays.reduce((acc, f) => {
      const d = timeDiff(f['odpt:scheduledDepartureTime'], f['odpt:actualDepartureTime']||f['odpt:estimatedDepartureTime']) || 0;
      return d > (acc.d||0) ? {f, d} : acc;
    }, {}).f;
    const wNum = worst ? (worst['odpt:flightNumber']||[]).join('/') : '';
    const wDest = worst ? getAirportCode(worst['odpt:destinationAirport']) : '';
    banners.push(`<div class="announce-banner amber">
      <div class="announce-icon">â°</div>
      <div class="announce-content">
        <div class="announce-title">âš  é…å»¶ä¾¿ã®ã”æ¡ˆå†…</div>
        <div class="announce-body">ç¾åœ¨ <strong style="color:var(--accent-amber)">${delays.length}ä¾¿</strong> ãŒé…å»¶ã—ã¦ãŠã‚Šã¾ã™ã€‚æœ€å¤§é…å»¶ä¾¿: <strong>${wNum}</strong>ï¼ˆ${AIRPORTS[wDest]||wDest}è¡Œãï¼‰ã€‚æœ€æ–°ã®æ­ä¹—å£æƒ…å ±ã¯æ¡ˆå†…æ¿ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</div>
        <div class="announce-time">æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP',{hour12:false})}</div>
      </div>
    </div>`);
  }

  if (boarding.length > 0) {
    const bNums = boarding.slice(0,4).map(f => {
      const fn = (f['odpt:flightNumber']||[]).join('/');
      const gate = f['odpt:departureGate'] ? `ï¼ˆ${f['odpt:departureGate']}ç•ªï¼‰` : '';
      return `${fn}${gate}`;
    }).join('ã€');
    banners.push(`<div class="announce-banner blue">
      <div class="announce-icon">ğŸšª</div>
      <div class="announce-content">
        <div class="announce-title">æ­ä¹—ä¸­ä¾¿ã®ã”æ¡ˆå†…</div>
        <div class="announce-body">ç¾åœ¨ <strong style="color:var(--accent-blue)">${boarding.length}ä¾¿</strong> ãŒæ­ä¹—ä¸­ã§ã™: ${bNums}${boarding.length>4?' ã»ã‹'+(boarding.length-4)+'ä¾¿':''}ã€‚æŒ‡å®šæ­ä¹—å£ã¸ãŠæ€¥ããã ã•ã„ã€‚</div>
        <div class="announce-time">æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP',{hour12:false})}</div>
      </div>
    </div>`);
  }

  if (banners.length === 0) {
    banners.push(`<div class="announce-banner green">
      <div class="announce-icon">âœ…</div>
      <div class="announce-content">
        <div class="announce-title">é‹èˆªçŠ¶æ³ â€” æ­£å¸¸</div>
        <div class="announce-body">ç¾åœ¨ã€ç¾½ç”°ç©ºæ¸¯ç™ºç€ä¾¿ã¯æ¦‚ã­å®šåˆ»é€šã‚Šé‹èˆªã—ã¦ãŠã‚Šã¾ã™ã€‚</div>
        <div class="announce-time">æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP',{hour12:false})}</div>
      </div>
    </div>`);
  }

  announceArea.innerHTML = banners.join('');
}

// =============================================
// HND: ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// =============================================
function renderHnd() {
  updateHndKpi();
  const flights = getHndFlights();
  const container = document.getElementById('hnd-main-content');

  if (flights.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">âœˆ</div>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ç¾½ç”°ä¾¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  if (hndView === 'infoboard') renderHndInfoboard(flights, container);
  else if (hndView === 'cards') renderHndCards(flights, container);
  else renderHndTable(flights, container);
}

// æ¡ˆå†…æ¿ãƒ“ãƒ¥ãƒ¼
function renderHndInfoboard(flights, container) {
  const now = new Date();
  const nowMins = now.getHours()*60 + now.getMinutes();

  let html = `<div class="info-display-panel">
    <div class="info-display-header">
      <span>âœˆ ç¾½ç”°ç©ºæ¸¯ ãƒ•ãƒ©ã‚¤ãƒˆæ¡ˆå†…æ¿</span>
      <span>${new Date().toLocaleString('ja-JP',{hour12:false})}</span>
    </div>
    <div class="info-display-body">
      <div class="info-row header-row">
        <div>ä¾¿å</div><div>å‡ºç™ºåœ°/ç›®çš„åœ°</div>
        <div>å®šåˆ»</div><div>å®Ÿç¸¾/äºˆå®š</div><div>æ­ä¹—å£</div><div>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
      </div>`;

  flights.forEach(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const isDep = f._dir === 'dep';
    const otherAP = getAirportCode(isDep ? f['odpt:destinationAirport'] : f['odpt:originAirport']);
    const otherName = AIRPORTS[otherAP] || otherAP;
    const sched = isDep ? (f['odpt:scheduledDepartureTime']||'-') : (f['odpt:scheduledArrivalTime']||'-');
    const actual = isDep
      ? (f['odpt:actualDepartureTime'] || f['odpt:estimatedDepartureTime'] || '-')
      : (f['odpt:actualArrivalTime'] || f['odpt:estimatedArrivalTime'] || '-');
    const gate = f['odpt:departureGate'] || '-';
    const status = getDepStatusClass(f);
    const d = timeDiff(sched, actual);
    const term = getTerminal(f['odpt:departureAirportTerminal'] || f['odpt:arrivalAirportTerminal']);
    const dirIcon = isDep ? 'ğŸ›«' : 'ğŸ›¬';

    const statusColor = status.cls.includes('cancel') ? 'var(--accent-red)'
      : status.cls.includes('delay') ? 'var(--accent-amber)'
      : status.cls.includes('inair') ? 'var(--accent-blue)'
      : status.cls.includes('boarding') ? '#c084fc'
      : 'var(--accent-green)';

    html += `<div class="info-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, '${isDep?'dep':'arr'}')">
      <div class="ir-fn">
        <div class="flight-num ${flightNumClass(f._src)}" style="font-size:14px">${fn}</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${dirIcon} ${isDep?'å‡ºç™º':'åˆ°ç€'} ${term}</div>
      </div>
      <div class="ir-dest">
        <div style="font-size:13px;color:var(--text-primary)">${AIRPORTS[otherAP]||otherAP}</div>
        <div style="font-size:11px;color:var(--text-muted)">${otherAP} ${isIntl(f['odpt:departureAirport']||f['odpt:originAirport'], f['odpt:destinationAirport']||f['odpt:arrivalAirport']) ? 'ğŸŒå›½éš›' : 'ğŸ—¾å›½å†…'}</div>
      </div>
      <div class="ir-time time-cell">${sched}</div>
      <div class="ir-time time-cell ${d&&d>0?'time-delayed':d&&d<0?'time-early':''}">${actual}${d&&d>0?` <span style="font-size:10px;color:var(--accent-amber)">+${d}åˆ†</span>`:''}</div>
      <div>${gate !== '-' ? `<span class="gate-cell" style="font-size:13px">${gate}</span>` : '<span style="color:var(--text-muted)">-</span>'}</div>
      <div><span class="status-badge ${status.cls}">${status.label}</span></div>
    </div>`;
  });

  html += `</div></div><div style="font-size:11px;color:var(--text-muted);text-align:right;margin-top:6px">${flights.length}ä»¶è¡¨ç¤ºä¸­</div>`;
  container.innerHTML = html;
}

// ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼
function renderHndCards(flights, container) {
  const cards = flights.map(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const isDep = f._dir === 'dep';
    const otherAP = getAirportCode(isDep ? f['odpt:destinationAirport'] : f['odpt:originAirport']);
    const sched = isDep ? (f['odpt:scheduledDepartureTime']||'-') : (f['odpt:scheduledArrivalTime']||'-');
    const actual = isDep
      ? (f['odpt:actualDepartureTime']||f['odpt:estimatedDepartureTime']||'-')
      : (f['odpt:actualArrivalTime']||f['odpt:estimatedArrivalTime']||'-');
    const gate = f['odpt:departureGate'];
    const status = getDepStatusClass(f);
    const d = timeDiff(sched, actual);
    const term = getTerminal(f['odpt:departureAirportTerminal']||f['odpt:arrivalAirportTerminal']);
    const infoText = (f['odpt:flightInformationText']||{}).ja || (f['odpt:flightInformationSummary']||{}).ja;

    const cardCls = isCancelled(f) ? 'cancel' : isDelayed(f, isDep?'dep':'arr') ? 'delay'
      : (f['odpt:flightStatus']||'').includes('Boarding') ? 'boarding'
      : (f['odpt:flightStatus']||'').includes('InAir') ? 'inair' : '';

    return `<div class="flight-card ${cardCls}" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, '${isDep?'dep':'arr'}')">
      <div class="fc-header">
        <div class="fc-num ${flightNumClass(f._src)}">${fn}</div>
        ${airlineBadge(f._src)}
        <span style="font-size:10px;color:var(--text-muted)">${isDep?'ğŸ›«å‡ºç™º':'ğŸ›¬åˆ°ç€'} ${term}</span>
        <span class="fc-status"><span class="status-badge ${status.cls}">${status.label}</span></span>
      </div>
      <div class="fc-route">
        <span class="fc-ap">HND</span>
        <span class="fc-arrow">${isDep?'â†’':'â†'}</span>
        <span class="fc-ap">${otherAP}</span>
        <span style="font-size:12px;color:var(--text-muted);margin-left:4px">${AIRPORTS[otherAP]||''}</span>
        <span class="tag ${isIntl(f['odpt:departureAirport']||f['odpt:originAirport'], f['odpt:destinationAirport']||f['odpt:arrivalAirport']) ? 'tag-intl' : 'tag-domestic'}" style="margin-left:auto">${isIntl(f['odpt:departureAirport']||f['odpt:originAirport'], f['odpt:destinationAirport']||f['odpt:arrivalAirport'])?'å›½éš›':'å›½å†…'}</span>
      </div>
      <div class="fc-times">
        <div class="fc-time-item"><div class="fc-time-label">å®šåˆ»</div><div class="fc-time-val">${sched}</div></div>
        <div class="fc-time-item"><div class="fc-time-label">${actual!=='-'?'å®Ÿç¸¾':'äºˆå®š'}</div><div class="fc-time-val ${d&&d>0?'time-delayed':d&&d<0?'time-early':''}">${actual}${d&&d>0?` <span style="font-size:10px">+${d}åˆ†</span>`:''}</div></div>
        ${gate ? `<div class="fc-time-item"><div class="fc-time-label">æ­ä¹—å£</div><div class="fc-time-val"><span class="gate-cell">${gate}</span></div></div>` : ''}
        <div class="fc-time-item"><div class="fc-time-label">æ©Ÿæ</div><div class="fc-time-val" style="font-size:12px;color:var(--text-secondary)">${f['odpt:aircraftType']||'-'}</div></div>
      </div>
      ${infoText ? `<div class="fc-info">â„¹ ${infoText}</div>` : ''}
    </div>`;
  }).join('');

  container.innerHTML = `<div class="flight-cards">${cards}</div><div style="font-size:11px;color:var(--text-muted);text-align:right;margin-top:10px">${flights.length}ä»¶è¡¨ç¤ºä¸­</div>`;
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ“ãƒ¥ãƒ¼
function renderHndTable(flights, container) {
  const rows = flights.map(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const isDep = f._dir === 'dep';
    const depAP = getAirportCode(f['odpt:departureAirport']||f['odpt:arrivalAirport']);
    const otherAP = getAirportCode(isDep ? f['odpt:destinationAirport'] : f['odpt:originAirport']);
    const sched = isDep ? (f['odpt:scheduledDepartureTime']||'-') : (f['odpt:scheduledArrivalTime']||'-');
    const actual = isDep
      ? (f['odpt:actualDepartureTime']||'-')
      : (f['odpt:actualArrivalTime']||'-');
    const est = isDep
      ? (f['odpt:estimatedDepartureTime']||'-')
      : (f['odpt:estimatedArrivalTime']||'-');
    const gate = f['odpt:departureGate']||'-';
    const term = getTerminal(f['odpt:departureAirportTerminal']||f['odpt:arrivalAirportTerminal']);
    const status = getDepStatusClass(f);
    const d = timeDiff(sched, actual!=='-'?actual:est);
    const intlTag = isIntl(f['odpt:departureAirport']||f['odpt:originAirport'], f['odpt:destinationAirport']||f['odpt:arrivalAirport'])
      ? '<span class="tag tag-intl">å›½éš›</span>' : '<span class="tag tag-domestic">å›½å†…</span>';

    return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, '${isDep?'dep':'arr'}')">
      <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
      <td>${airlineBadge(f._src)}</td>
      <td><span style="font-size:10px;padding:2px 6px;border-radius:3px;background:${isDep?'rgba(0,212,255,0.1)':'rgba(0,230,118,0.1)'};">${isDep?'ğŸ›«å‡ºç™º':'ğŸ›¬åˆ°ç€'}</span></td>
      <td style="font-size:12px;color:var(--text-secondary)">${term}</td>
      <td><span class="airport-code">${otherAP}</span><span style="font-size:10px;color:var(--text-muted);margin-left:4px">${AIRPORTS[otherAP]||''}</span></td>
      <td class="time-cell">${sched}</td>
      <td class="time-cell ${actual!=='-'?(d&&d>0?'time-delayed':d&&d<0?'time-early':''):''}">${actual}</td>
      <td class="time-cell ${est!=='-'?(d&&d>0?'time-delayed':''):''}">${est}</td>
      <td>${gate!=='-'?`<span class="gate-cell">${gate}</span>`:'-'}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-secondary)">${f['odpt:aircraftType']||'-'}</td>
      <td>${d&&d>0?`<span style="color:var(--accent-amber);font-family:'Share Tech Mono',monospace">+${d}åˆ†</span>`:d&&d<0?`<span style="color:var(--accent-green)">${d}åˆ†</span>`:'<span style="color:var(--text-muted)">Â±0</span>'}</td>
      <td><span class="status-badge ${status.cls}">${status.label}</span></td>
      <td>${intlTag}</td>
    </tr>`;
  }).join('');

  container.innerHTML = `<div class="panel">
    <div class="panel-header">
      <div class="panel-title">ç¾½ç”°ç©ºæ¸¯ãƒ•ãƒ©ã‚¤ãƒˆä¸€è¦§</div>
      <span style="font-size:11px;color:var(--text-muted)">${flights.length}ä»¶</span>
    </div>
    <div style="padding:0">
      <div class="flight-table-wrap">
        <table class="flight-table">
          <thead><tr>
            <th>ä¾¿å</th><th>èˆªç©ºä¼šç¤¾</th><th>æ–¹å‘</th><th>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</th>
            <th>å‡ºç™ºåœ°/ç›®çš„åœ°</th><th>å®šåˆ»</th><th>å®Ÿç¸¾</th><th>äºˆå®š</th>
            <th>æ­ä¹—å£</th><th>æ©Ÿæ</th><th>é…å»¶</th><th>çŠ¶æ…‹</th><th>åŒºåˆ†</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>
  </div>`;
}

// =============================================
// ALERTS PAGE
// =============================================
function renderAlerts() {
  const apFilter = f => {
    if (alertAirport === 'all') return true;
    const depAP = getAirportCode(f['odpt:departureAirport'] || f['odpt:arrivalAirport']);
    const destAP = getAirportCode(f['odpt:destinationAirport'] || f['odpt:originAirport']);
    return depAP === alertAirport || destAP === alertAirport;
  };

  // æ¬ èˆªä¾¿
  const cancelled = [...allDepartures, ...allArrivals].filter(f => isCancelled(f) && apFilter(f));
  document.getElementById('cancel-count-badge').textContent = cancelled.length + ' ä»¶';
  const cancelArea = document.getElementById('cancel-list-area');
  if (cancelled.length === 0) {
    cancelArea.innerHTML = '<div class="empty-state" style="padding:30px"><div class="empty-icon">âœ…</div>æ¬ èˆªä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    cancelArea.innerHTML = cancelled.map(f => {
      const fn = (f['odpt:flightNumber']||[]).join('/');
      const isDep = !!f['odpt:departureAirport'];
      const depAP = getAirportCode(f['odpt:departureAirport'] || f['odpt:arrivalAirport']);
      const destAP = getAirportCode(f['odpt:destinationAirport'] || f['odpt:originAirport']);
      const sched = f['odpt:scheduledDepartureTime'] || f['odpt:scheduledArrivalTime'] || '-';
      const info = (f['odpt:flightInformationText']||{}).ja || (f['odpt:flightInformationSummary']||{}).ja || '';
      return `<div class="cancel-alert" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, '${isDep?'dep':'arr'}')">
        <div class="ca-num">${fn}</div>
        <div class="ca-info">
          <div class="ca-route">${airlineBadge(f._src)} &nbsp; ${AIRPORTS[depAP]||depAP} â†’ ${AIRPORTS[destAP]||destAP}</div>
          <div class="ca-detail">å®šåˆ»: ${sched}ã€€${info ? `ç†ç”±: ${info}` : ''}</div>
        </div>
        <div class="ca-badge"><span class="status-badge status-cancel">æ¬ èˆª</span></div>
      </div>`;
    }).join('');
  }

  // é…å»¶ä¾¿
  const delayed = allDepartures.filter(f => isDelayed(f,'dep') && apFilter(f))
    .map(f => ({...f, _delayMins: timeDiff(f['odpt:scheduledDepartureTime'], f['odpt:actualDepartureTime']||f['odpt:estimatedDepartureTime'])||0, _dir:'dep'}));
  delayed.sort((a,b) => b._delayMins - a._delayMins);
  document.getElementById('delay-count-badge').textContent = delayed.length + ' ä»¶';
  const delayArea = document.getElementById('delay-list-area');
  if (delayed.length === 0) {
    delayArea.innerHTML = '<div class="empty-state" style="padding:30px"><div class="empty-icon">âœ…</div>é…å»¶ä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    delayArea.innerHTML = delayed.map(f => {
      const fn = (f['odpt:flightNumber']||[]).join('/');
      const depAP = getAirportCode(f['odpt:departureAirport']);
      const destAP = getAirportCode(f['odpt:destinationAirport']);
      const sched = f['odpt:scheduledDepartureTime']||'-';
      const actual = f['odpt:actualDepartureTime']||f['odpt:estimatedDepartureTime']||'-';
      const d = f._delayMins;
      const info = (f['odpt:flightInformationText']||{}).ja || '';
      const gate = f['odpt:departureGate'];
      return `<div class="cancel-alert" style="border-color:rgba(255,183,0,0.35);background:rgba(255,183,0,0.06)" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, 'dep')">
        <div class="ca-num" style="color:var(--accent-amber)">${fn}</div>
        <div class="ca-info">
          <div class="ca-route">${airlineBadge(f._src)} &nbsp; ${AIRPORTS[depAP]||depAP} â†’ ${AIRPORTS[destAP]||destAP}</div>
          <div class="ca-detail">å®šåˆ»: ${sched} â†’ å®Ÿç¸¾/äºˆå®š: <span style="color:var(--accent-amber)">${actual}</span> ï¼ˆ+${d}åˆ†ï¼‰${gate?` ã€€æ­ä¹—å£: ${gate}ç•ª`:''}${info?` ã€€${info}`:''}</div>
        </div>
        <div class="ca-badge"><span style="font-family:'Share Tech Mono',monospace;font-size:14px;font-weight:700;color:var(--accent-amber)">+${d}åˆ†</span></div>
      </div>`;
    }).join('');
  }

  // æ­ä¹—ä¸­ä¾¿
  const boarding = allDepartures.filter(f => {
    const s = f['odpt:flightStatus']||'';
    return (s.includes('Boarding') || s.includes('GateClosed')) && apFilter(f);
  });
  document.getElementById('boarding-count-badge').textContent = boarding.length + ' ä»¶';
  const boardingArea = document.getElementById('boarding-list-area');
  if (boarding.length === 0) {
    boardingArea.innerHTML = '<div class="empty-state" style="padding:30px"><div class="empty-icon">ğŸšª</div>æ­ä¹—ä¸­ä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    boardingArea.innerHTML = boarding.map(f => {
      const fn = (f['odpt:flightNumber']||[]).join('/');
      const destAP = getAirportCode(f['odpt:destinationAirport']);
      const sched = f['odpt:scheduledDepartureTime']||'-';
      const gate = f['odpt:departureGate']||'-';
      const term = getTerminal(f['odpt:departureAirportTerminal']);
      const isGateClosed = (f['odpt:flightStatus']||'').includes('GateClosed');
      return `<div class="boarding-card" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, 'dep')">
        <div class="bc-top">
          <div>
            <div class="bc-num">${fn}</div>
            <div style="margin-top:2px">${airlineBadge(f._src)}</div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div class="bc-gate-label">æ­ä¹—å£</div>
            <div class="bc-gate-big">${gate}</div>
            <div style="font-size:10px;color:var(--text-muted)">${term}</div>
          </div>
        </div>
        <div class="bc-route">
          <span class="airport-code">HND</span>
          <span style="color:var(--text-muted);margin:0 8px">â†’</span>
          <span class="airport-code">${destAP}</span>
          <span style="font-size:12px;color:var(--text-muted);margin-left:6px">${AIRPORTS[destAP]||''}</span>
        </div>
        <div class="bc-times">
          <div class="bc-time"><div class="bc-time-label">å®šåˆ»å‡ºç™º</div><div class="bc-time-val">${sched}</div></div>
          <div style="margin-left:auto">
            ${isGateClosed
              ? `<span class="status-badge status-boarding" style="font-size:12px;padding:5px 12px">ğŸ”’ æ­ä¹—å£é–‰é–</span>`
              : `<span class="status-badge status-boarding" style="font-size:12px;padding:5px 12px">ğŸšª æ­ä¹—ä¸­</span>`}
          </div>
        </div>
      </div>`;
    }).join('');
  }

  // é£›è¡Œä¸­ä¾¿
  const inair = allDepartures.filter(f => (f['odpt:flightStatus']||'').includes('InAir') && apFilter(f));
  document.getElementById('inair-count-badge').textContent = inair.length + ' ä»¶';
  const inairArea = document.getElementById('inair-list-area');
  if (inair.length === 0) {
    inairArea.innerHTML = '<div class="empty-state" style="padding:30px"><div class="empty-icon">âœˆ</div>é£›è¡Œä¸­ä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    inairArea.innerHTML = `<div class="flight-table-wrap">
      <table class="flight-table">
        <thead><tr><th>ä¾¿å</th><th>å‡ºç™ºåœ°</th><th>ç›®çš„åœ°</th><th>å‡ºç™ºæ™‚åˆ»</th><th>åˆ°ç€ç©ºæ¸¯</th></tr></thead>
        <tbody>${inair.map(f => {
          const fn = (f['odpt:flightNumber']||[]).join('/');
          const depAP = getAirportCode(f['odpt:departureAirport']);
          const destAP = getAirportCode(f['odpt:destinationAirport']);
          const actual = f['odpt:actualDepartureTime']||'-';
          return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, 'dep')">
            <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
            <td><span class="airport-code">${depAP}</span></td>
            <td><span class="airport-code">${destAP}</span> <span style="font-size:10px;color:var(--text-muted)">${AIRPORTS[destAP]||''}</span></td>
            <td class="time-cell">${actual}</td>
            <td>${airlineBadge(f._src)}</td>
          </tr>`;
        }).join('')}</tbody>
      </table>
    </div>`;
  }
}



function setHndTerminal(val, el) {
  hndTerminalFilter = val;
  // HNDãƒšãƒ¼ã‚¸å†…ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã¿ãƒªã‚»ãƒƒãƒˆ
  const hndHeader = document.querySelector('#page-hnd .hnd-header');
  if (hndHeader) {
    hndHeader.querySelectorAll('.terminal-tab').forEach(t => t.classList.remove('active'));
  }
  el.classList.add('active');
  renderHnd();
}

function setHndView(val, el) {
  hndViewMode = val;
  el.closest('.terminal-tabs').querySelectorAll('.terminal-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderHnd();
}

function setHndDir(val, el) {
  hndDirFilter = val;
  ['both','dep','arr'].forEach(d => {
    const b = document.getElementById(`hnd-dir-${d}`);
    if (b) b.classList.remove('active');
  });
  el.classList.add('active');
  renderHnd();
}

function setHndSort(key, el) {
  if (hndSortKey === key) hndSortAsc = !hndSortAsc;
  else { hndSortKey = key; hndSortAsc = true; }
  document.querySelectorAll('#hnd-sort-chips .sort-chip').forEach(c => {
    c.classList.remove('active','asc','desc');
  });
  el.classList.add('active', hndSortAsc ? 'asc' : 'desc');
  renderHnd();
}

function hndQuickFilter(val) {
  hndQuickFilterActive = val;
  renderHnd();
}

function setAlertAirport(val, el) {
  alertAirportFilter = val;
  el.closest('div').querySelectorAll('.terminal-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderAlerts();
}

// =============================================
// HND DATA HELPERS
// =============================================
function isHndFlight(f) {
  const depAP = getAirportCode(f['odpt:departureAirport']);
  const arrAP = getAirportCode(f['odpt:arrivalAirport']);
  return depAP === 'HND' || arrAP === 'HND';
}

function getHndFlights() {
  // dep flights from HND + arr flights to HND
  const deps = allDepartures.filter(f => getAirportCode(f['odpt:departureAirport']) === 'HND');
  const arrs = allArrivals.filter(f => getAirportCode(f['odpt:arrivalAirport']) === 'HND');
  return { deps, arrs };
}

function applyHndTerminalFilter(flights, type) {
  if (hndTerminalFilter === 'all') return flights;
  return flights.filter(f => {
    const term = type === 'dep'
      ? getTerminal(f['odpt:departureAirportTerminal'])
      : getTerminal(f['odpt:arrivalAirportTerminal']);
    return term && term.includes(hndTerminalFilter);
  });
}

function getHndDelayMins(f, type) {
  const sched = type === 'dep' ? f['odpt:scheduledDepartureTime'] : f['odpt:scheduledArrivalTime'];
  const actual = type === 'dep'
    ? (f['odpt:actualDepartureTime'] || f['odpt:estimatedDepartureTime'])
    : (f['odpt:actualArrivalTime'] || f['odpt:estimatedArrivalTime']);
  return timeDiff(sched, actual);
}

function sortHndFlights(arr, type) {
  return arr.sort((a, b) => {
    let va, vb;
    switch(hndSortKey) {
      case 'time':
        va = type === 'dep' ? (a['odpt:scheduledDepartureTime']||'99:99') : (a['odpt:scheduledArrivalTime']||'99:99');
        vb = type === 'dep' ? (b['odpt:scheduledDepartureTime']||'99:99') : (b['odpt:scheduledArrivalTime']||'99:99');
        break;
      case 'flightNum':
        va = (a['odpt:flightNumber']||[''])[0];
        vb = (b['odpt:flightNumber']||[''])[0];
        break;
      case 'airline':
        va = a._src || ''; vb = b._src || '';
        break;
      case 'status':
        va = a['odpt:flightStatus']||'z'; vb = b['odpt:flightStatus']||'z';
        break;
      case 'delay':
        va = getHndDelayMins(a, type) || -999;
        vb = getHndDelayMins(b, type) || -999;
        return hndSortAsc ? vb - va : va - vb; // é…å»¶å¤§ãã„é †
      case 'destination':
        va = type === 'dep' ? getAirportCode(a['odpt:destinationAirport']) : getAirportCode(a['odpt:originAirport']);
        vb = type === 'dep' ? getAirportCode(b['odpt:destinationAirport']) : getAirportCode(b['odpt:originAirport']);
        break;
      case 'terminal':
        va = type === 'dep' ? getTerminal(a['odpt:departureAirportTerminal']) : getTerminal(a['odpt:arrivalAirportTerminal']);
        vb = type === 'dep' ? getTerminal(b['odpt:departureAirportTerminal']) : getTerminal(b['odpt:arrivalAirportTerminal']);
        break;
      case 'gate':
        va = a['odpt:departureGate'] || 'zzz';
        vb = b['odpt:departureGate'] || 'zzz';
        break;
      case 'aircraft':
        va = a['odpt:aircraftType']||'z'; vb = b['odpt:aircraftType']||'z';
        break;
      case 'type':
        va = isIntl(a['odpt:departureAirport']||a['odpt:originAirport'], a['odpt:destinationAirport']||a['odpt:arrivalAirport']) ? '1' : '0';
        vb = isIntl(b['odpt:departureAirport']||b['odpt:originAirport'], b['odpt:destinationAirport']||b['odpt:arrivalAirport']) ? '1' : '0';
        break;
      default:
        va = ''; vb = '';
    }
    if (typeof va === 'string') return hndSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
    return hndSortAsc ? va - vb : vb - va;
  });
}

// =============================================
// RENDER HND MAIN
// =============================================
function renderHnd() {
  let { deps, arrs } = getHndFlights();

  // Terminal filter
  deps = applyHndTerminalFilter(deps, 'dep');
  arrs = applyHndTerminalFilter(arrs, 'arr');

  // Quick filter (KPI click)
  if (hndQuickFilterActive === 'dep') arrs = [];
  else if (hndQuickFilterActive === 'arr') deps = [];
  else if (hndQuickFilterActive === 'boarding') {
    deps = deps.filter(f => (f['odpt:flightStatus']||'').includes('Boarding') || (f['odpt:flightStatus']||'').includes('GateClosed'));
    arrs = [];
  } else if (hndQuickFilterActive === 'inair') {
    deps = deps.filter(f => (f['odpt:flightStatus']||'').includes('InAir'));
    arrs = [];
  } else if (hndQuickFilterActive === 'delay') {
    deps = deps.filter(f => isDelayed(f,'dep'));
    arrs = arrs.filter(f => isDelayed(f,'arr'));
  } else if (hndQuickFilterActive === 'cancel') {
    deps = deps.filter(isCancelled);
    arrs = arrs.filter(isCancelled);
  }

  // Dir filter
  if (hndDirFilter === 'dep') arrs = [];
  if (hndDirFilter === 'arr') deps = [];

  // Search
  const search = (document.getElementById('hnd-search')?.value || '').toLowerCase();
  if (search) {
    const match = f => {
      const fn = (f['odpt:flightNumber']||[]).join('/').toLowerCase();
      const dest = (getAirportCode(f['odpt:destinationAirport']||f['odpt:originAirport']||'')).toLowerCase();
      const destName = (AIRPORTS[getAirportCode(f['odpt:destinationAirport']||f['odpt:originAirport']||'')] || '').toLowerCase();
      const gate = (f['odpt:departureGate']||'').toLowerCase();
      return fn.includes(search) || dest.includes(search) || destName.includes(search) || gate.includes(search);
    };
    deps = deps.filter(match);
    arrs = arrs.filter(match);
  }

  // Sort
  sortHndFlights(deps, 'dep');
  sortHndFlights(arrs, 'arr');

  // Update KPI
  const { deps: allDeps, arrs: allArrs } = getHndFlights();
  const hndTotal = allDeps.length + allArrs.length;
  const hndBoarding = allDeps.filter(f => (f['odpt:flightStatus']||'').includes('Boarding')||(f['odpt:flightStatus']||'').includes('GateClosed')).length;
  const hndInAir = allDeps.filter(f => (f['odpt:flightStatus']||'').includes('InAir')).length;
  const hndDelay = allDeps.filter(f=>isDelayed(f,'dep')).length + allArrs.filter(f=>isDelayed(f,'arr')).length;
  const hndCancel = [...allDeps,...allArrs].filter(isCancelled).length;
  const hndOt = hndTotal>0 ? Math.round(((hndTotal-hndDelay-hndCancel)/hndTotal)*100) : 0;

  document.getElementById('hnd-kpi-total').textContent = hndTotal;
  document.getElementById('hnd-kpi-dep').textContent = allDeps.length;
  document.getElementById('hnd-kpi-arr').textContent = allArrs.length;
  document.getElementById('hnd-kpi-boarding').textContent = hndBoarding;
  document.getElementById('hnd-kpi-inair').textContent = hndInAir;
  document.getElementById('hnd-kpi-delay').textContent = hndDelay;
  document.getElementById('hnd-kpi-cancel').textContent = hndCancel;
  document.getElementById('hnd-kpi-ontime').textContent = hndOt + '%';

  // ãŠå®¢æ§˜æ¡ˆå†…ãƒãƒŠãƒ¼ç”Ÿæˆ
  const announceArea = document.getElementById('hnd-announce-area');
  const banners = [];
  const cancelFlights = allDeps.filter(isCancelled);
  if (cancelFlights.length > 0) {
    const names = cancelFlights.map(f => (f['odpt:flightNumber']||[]).join('/')).join('ãƒ»');
    banners.push(`<div class="announce-banner">
      <div class="announce-icon">ğŸš«</div>
      <div class="announce-content">
        <div class="announce-title">ã€æ¬ èˆªã®ã”æ¡ˆå†…ã€‘${cancelFlights.length}ä¾¿ãŒæ¬ èˆªã¨ãªã£ã¦ãŠã‚Šã¾ã™</div>
        <div class="announce-body">å¯¾è±¡ä¾¿ï¼š${names}<br>æ‰•ã„æˆ»ã—ãƒ»æŒ¯æ›¿ã«ã¤ã„ã¦ã¯å„èˆªç©ºä¼šç¤¾ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</div>
        <div class="announce-time">æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP',{hour12:false})}</div>
      </div>
    </div>`);
  }
  const delayFlights = allDeps.filter(f=>isDelayed(f,'dep'));
  if (delayFlights.length > 0) {
    const maxDelay = delayFlights.reduce((max, f) => {
      const d = getHndDelayMins(f,'dep') || 0;
      return d > max ? d : max;
    }, 0);
    banners.push(`<div class="announce-banner amber">
      <div class="announce-icon">âš </div>
      <div class="announce-content">
        <div class="announce-title">ã€é…å»¶ã®ã”æ¡ˆå†…ã€‘${delayFlights.length}ä¾¿ã§å‡ºç™ºé…å»¶ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™</div>
        <div class="announce-body">æœ€å¤§é…å»¶ï¼šç´„${maxDelay}åˆ†ã€‚æ­ä¹—å£ã‚„å‡ºç™ºæ™‚åˆ»ãŒå¤‰æ›´ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ¢ãƒ‹ã‚¿ãƒ¼ã¾ãŸã¯ä¿‚å“¡ã«ã¦ã”ç¢ºèªãã ã•ã„ã€‚</div>
        <div class="announce-time">æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP',{hour12:false})}</div>
      </div>
    </div>`);
  }
  const boardingFlights = allDeps.filter(f => (f['odpt:flightStatus']||'').includes('Boarding'));
  if (boardingFlights.length > 0) {
    boardingFlights.slice(0,3).forEach(f => {
      const fn = (f['odpt:flightNumber']||[]).join('/');
      const dest = getAirportCode(f['odpt:destinationAirport']);
      const destName = AIRPORTS[dest] || dest;
      const gate = f['odpt:departureGate'];
      const sched = f['odpt:scheduledDepartureTime'];
      banners.push(`<div class="announce-banner" style="background:linear-gradient(90deg,rgba(192,132,252,0.12),rgba(192,132,252,0.04));border-color:rgba(192,132,252,0.4);border-left-color:#c084fc;">
        <div class="announce-icon">ğŸšª</div>
        <div class="announce-content">
          <div class="announce-title" style="color:#c084fc">ã€æ­ä¹—é–‹å§‹ã€‘${fn} ${destName}è¡Œã</div>
          <div class="announce-body">${gate ? `æ­ä¹—å£ï¼š<strong>${gate}ç•ªã‚²ãƒ¼ãƒˆ</strong>ã€€` : ''}å®šåˆ»å‡ºç™ºï¼š<strong>${sched}</strong><br>ãŸã ã„ã¾æ­ä¹—ã‚’é–‹å§‹ã—ã¦ãŠã‚Šã¾ã™ã€‚ãŠæ—©ã‚ã«ã‚²ãƒ¼ãƒˆã¸ãŠè¶Šã—ãã ã•ã„ã€‚</div>
        </div>
      </div>`);
    });
  }
  if (banners.length === 0) {
    banners.push(`<div class="announce-banner green">
      <div class="announce-icon">âœ…</div>
      <div class="announce-content">
        <div class="announce-title">ã€é‹èˆªçŠ¶æ³ã€‘ç¾åœ¨å¤§ããªé…å»¶ãƒ»æ¬ èˆªã¯ç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“</div>
        <div class="announce-body">å…¨ä¾¿æ¦‚ã­å®šåˆ»é€šã‚Šã®é‹èˆªãŒè¦‹è¾¼ã¾ã‚Œã¾ã™ã€‚</div>
        <div class="announce-time">æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP',{hour12:false})}</div>
      </div>
    </div>`);
  }
  announceArea.innerHTML = banners.join('');

  // Render main content
  const container = document.getElementById('hnd-main-content');
  if (hndViewMode === 'infoboard') {
    container.innerHTML = renderHndInfoboard(deps, arrs);
  } else if (hndViewMode === 'cards') {
    container.innerHTML = renderHndCards(deps, arrs);
  } else {
    container.innerHTML = renderHndTable(deps, arrs);
  }
}

// --- æ¡ˆå†…æ¿ãƒ¢ãƒ¼ãƒ‰ ---
function renderHndInfoboard(deps, arrs) {
  let html = '';

  if (hndDirFilter !== 'arr') {
    html += `<div class="info-display-panel" style="margin-bottom:16px">
      <div class="info-display-header">
        <span>âœˆ å‡ºç™ºä¾¿æ¡ˆå†…æ¿ã€€DEPARTURES</span>
        <span style="font-family:'Share Tech Mono',monospace">${deps.length}ä¾¿</span>
      </div>
      <div class="info-display-body">
        <div class="info-row header-row">
          <div>ä¾¿å</div><div>ç›®çš„åœ°</div><div>å®šåˆ»</div><div>å®Ÿç¸¾/äºˆå®š</div><div>ã‚²ãƒ¼ãƒˆ</div><div>çŠ¶æ…‹</div>
        </div>`;
    if (deps.length === 0) {
      html += `<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:12px">è¡¨ç¤ºå¯¾è±¡ã®ä¾¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    } else {
      deps.forEach(f => {
        const fn = (f['odpt:flightNumber']||[]).join('/');
        const dest = getAirportCode(f['odpt:destinationAirport']);
        const destName = AIRPORTS[dest] || dest;
        const sched = f['odpt:scheduledDepartureTime'] || '--:--';
        const actual = f['odpt:actualDepartureTime'] || f['odpt:estimatedDepartureTime'] || '';
        const gate = f['odpt:departureGate'] || '';
        const status = getDepStatusClass(f);
        const d = timeDiff(sched, actual);
        const fnCls = flightNumClass(f._src);
        html += `<div class="info-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))},'dep')">
          <div class="ir-fn"><span class="flight-num ${fnCls}">${fn}</span></div>
          <div class="ir-dest"><strong>${dest}</strong><span style="font-size:11px;color:var(--text-muted);margin-left:6px">${destName}</span></div>
          <div class="ir-time time-cell">${sched}</div>
          <div class="ir-time time-cell ${d&&d>0?'time-delayed':d&&d<0?'time-early':''}">${actual || '-'}</div>
          <div>${gate ? `<span class="ir-gate">${gate}</span>` : '-'}</div>
          <div class="ir-status"><span class="status-badge ${status.cls}">${status.label}</span></div>
        </div>`;
      });
    }
    html += `</div></div>`;
  }

  if (hndDirFilter !== 'dep') {
    html += `<div class="info-display-panel">
      <div class="info-display-header" style="background:var(--accent-green);color:#000">
        <span>ğŸ›¬ åˆ°ç€ä¾¿æ¡ˆå†…æ¿ã€€ARRIVALS</span>
        <span style="font-family:'Share Tech Mono',monospace">${arrs.length}ä¾¿</span>
      </div>
      <div class="info-display-body">
        <div class="info-row header-row">
          <div>ä¾¿å</div><div>å‡ºç™ºåœ°</div><div>å®šåˆ»</div><div>å®Ÿç¸¾/äºˆå®š</div><div>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</div><div>çŠ¶æ…‹</div>
        </div>`;
    if (arrs.length === 0) {
      html += `<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:12px">è¡¨ç¤ºå¯¾è±¡ã®ä¾¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    } else {
      arrs.forEach(f => {
        const fn = (f['odpt:flightNumber']||[]).join('/');
        const orig = getAirportCode(f['odpt:originAirport']);
        const origName = AIRPORTS[orig] || orig;
        const sched = f['odpt:scheduledArrivalTime'] || '--:--';
        const actual = f['odpt:actualArrivalTime'] || f['odpt:estimatedArrivalTime'] || '';
        const term = getTerminal(f['odpt:arrivalAirportTerminal']);
        const status = getDepStatusClass(f);
        const d = timeDiff(sched, actual);
        const fnCls = flightNumClass(f._src);
        html += `<div class="info-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))},'arr')">
          <div class="ir-fn"><span class="flight-num ${fnCls}">${fn}</span></div>
          <div class="ir-dest"><strong>${orig}</strong><span style="font-size:11px;color:var(--text-muted);margin-left:6px">${origName}</span></div>
          <div class="ir-time time-cell">${sched}</div>
          <div class="ir-time time-cell ${d&&d>0?'time-delayed':d&&d<0?'time-early':''}">${actual || '-'}</div>
          <div style="font-size:12px;color:var(--text-secondary)">${term}</div>
          <div class="ir-status"><span class="status-badge ${status.cls}">${status.label}</span></div>
        </div>`;
      });
    }
    html += `</div></div>`;
  }
  return html;
}

// --- ã‚«ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ ---
function renderHndCards(deps, arrs) {
  const makeCard = (f, type) => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const status = getDepStatusClass(f);
    const statCls = isCancelled(f)?'cancel':isDelayed(f,type)?'delay':(f['odpt:flightStatus']||'').includes('Boarding')?'boarding':(f['odpt:flightStatus']||'').includes('InAir')?'inair':'';
    const dest = type==='dep' ? getAirportCode(f['odpt:destinationAirport']) : getAirportCode(f['odpt:originAirport']);
    const destName = AIRPORTS[dest] || dest;
    const home = type==='dep' ? getAirportCode(f['odpt:departureAirport']) : getAirportCode(f['odpt:arrivalAirport']);
    const sched = type==='dep' ? f['odpt:scheduledDepartureTime'] : f['odpt:scheduledArrivalTime'];
    const actual = type==='dep' ? (f['odpt:actualDepartureTime']||f['odpt:estimatedDepartureTime']) : (f['odpt:actualArrivalTime']||f['odpt:estimatedArrivalTime']);
    const gate = f['odpt:departureGate'];
    const term = type==='dep' ? getTerminal(f['odpt:departureAirportTerminal']) : getTerminal(f['odpt:arrivalAirportTerminal']);
    const d = timeDiff(sched, actual);
    const info = (f['odpt:flightInformationSummary']||{}).ja || (f['odpt:flightInformationText']||{}).ja;
    const fnCls = flightNumClass(f._src);
    return `<div class="flight-card ${statCls}" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))},'${type}')">
      <div class="fc-header">
        <span class="fc-num ${fnCls}">${fn}</span>
        ${airlineBadge(f._src)}
        <span style="font-size:11px;color:var(--text-muted)">${type==='dep'?'å‡ºç™º':'åˆ°ç€'}</span>
        <span class="fc-status"><span class="status-badge ${status.cls}">${status.label}</span></span>
      </div>
      <div class="fc-route">
        <span class="fc-ap">${home}</span>
        <span class="fc-arrow">${type==='dep'?'â†’':'â†'}</span>
        <span class="fc-ap">${dest}</span>
        <span style="font-size:11px;color:var(--text-muted);margin-left:4px">${destName}</span>
        <span style="margin-left:auto;font-size:10px;color:var(--text-muted)">${isIntl(f['odpt:departureAirport']||f['odpt:originAirport'],f['odpt:destinationAirport']||f['odpt:arrivalAirport'])?'<span class="tag tag-intl">å›½éš›</span>':'<span class="tag tag-domestic">å›½å†…</span>'}</span>
      </div>
      <div class="fc-times">
        <div class="fc-time-item">
          <div class="fc-time-label">å®šåˆ»</div>
          <div class="fc-time-val">${sched||'-'}</div>
        </div>
        ${actual ? `<div class="fc-time-item">
          <div class="fc-time-label">å®Ÿç¸¾/äºˆå®š</div>
          <div class="fc-time-val ${d&&d>0?'time-delayed':d&&d<0?'time-early':''}">${actual}${d&&d>0?` <span style="font-size:10px;color:var(--accent-amber)">+${d}åˆ†</span>`:''}</div>
        </div>` : ''}
        ${gate ? `<div class="fc-time-item">
          <div class="fc-time-label">ã‚²ãƒ¼ãƒˆ</div>
          <div class="fc-time-val"><span class="gate-cell">${gate}</span></div>
        </div>` : ''}
        <div class="fc-time-item">
          <div class="fc-time-label">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</div>
          <div class="fc-time-val" style="font-size:13px">${term}</div>
        </div>
        <div class="fc-time-item">
          <div class="fc-time-label">æ©Ÿæ</div>
          <div class="fc-time-val" style="font-size:12px;color:var(--text-secondary)">${f['odpt:aircraftType']||'-'}</div>
        </div>
      </div>
      ${info ? `<div class="fc-info">â„¹ ${info}</div>` : ''}
    </div>`;
  };

  let html = '';
  if (hndDirFilter !== 'arr' && deps.length > 0) {
    html += `<div class="hnd-section-title">âœˆ å‡ºç™ºä¾¿ <span class="count-badge">${deps.length}</span></div>
      <div class="flight-cards" style="margin-bottom:20px">${deps.map(f=>makeCard(f,'dep')).join('')}</div>`;
  }
  if (hndDirFilter !== 'dep' && arrs.length > 0) {
    html += `<div class="hnd-section-title green">ğŸ›¬ åˆ°ç€ä¾¿ <span class="count-badge">${arrs.length}</span></div>
      <div class="flight-cards">${arrs.map(f=>makeCard(f,'arr')).join('')}</div>`;
  }
  if (!html) html = '<div class="empty-state"><div class="empty-icon">âœˆ</div>å¯¾è±¡ã®ä¾¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  return html;
}

// --- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¢ãƒ¼ãƒ‰ ---
function renderHndTable(deps, arrs) {
  const makeRows = (data, type) => data.map(f => {
    const fn = (f['odpt:flightNumber']||[]).join('/');
    const dest = type==='dep' ? getAirportCode(f['odpt:destinationAirport']) : getAirportCode(f['odpt:originAirport']);
    const destName = AIRPORTS[dest] || '';
    const sched = type==='dep' ? f['odpt:scheduledDepartureTime'] : f['odpt:scheduledArrivalTime'];
    const actual = type==='dep' ? (f['odpt:actualDepartureTime']||'-') : (f['odpt:actualArrivalTime']||'-');
    const est = type==='dep' ? (f['odpt:estimatedDepartureTime']||'-') : (f['odpt:estimatedArrivalTime']||'-');
    const gate = f['odpt:departureGate'] || '-';
    const term = type==='dep' ? getTerminal(f['odpt:departureAirportTerminal']) : getTerminal(f['odpt:arrivalAirportTerminal']);
    const status = getDepStatusClass(f);
    const d = timeDiff(sched, actual !== '-' ? actual : est);
    const intlTag = isIntl(f['odpt:departureAirport']||f['odpt:originAirport'], f['odpt:destinationAirport']||f['odpt:arrivalAirport'])
      ? '<span class="tag tag-intl">å›½éš›</span>' : '<span class="tag tag-domestic">å›½å†…</span>';
    return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))},'${type}')">
      <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
      <td>${airlineBadge(f._src)}</td>
      <td><span class="airport-code">${dest}</span><span style="font-size:10px;color:var(--text-muted);margin-left:4px">${destName}</span></td>
      <td class="time-cell">${sched||'-'}</td>
      <td class="time-cell ${actual!=='-'?(d&&d>0?'time-delayed':d&&d<0?'time-early':''):''}">${actual}</td>
      <td class="time-cell ${est!=='-'?(d&&d>0?'time-delayed':''):''}">${est}</td>
      <td>${gate!=='-'?`<span class="gate-cell">${gate}</span>`:'-'}</td>
      <td style="font-size:12px;color:var(--text-secondary)">${term}</td>
      <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-secondary)">${f['odpt:aircraftType']||'-'}</td>
      <td><span class="status-badge ${status.cls}">${status.label}</span></td>
      <td>${intlTag}</td>
      <td>${d&&d>0?`<span style="color:var(--accent-amber);font-family:'Share Tech Mono',monospace;font-size:12px">+${d}åˆ†</span>`:'-'}</td>
    </tr>`;
  }).join('');

  let html = '';
  const thead = `<thead><tr>
    <th>ä¾¿å</th><th>èˆªç©ºä¼šç¤¾</th><th>è¡Œãå…ˆ/å‡ºç™ºåœ°</th><th>å®šåˆ»</th><th>å®Ÿç¸¾</th><th>äºˆå®š</th>
    <th>ã‚²ãƒ¼ãƒˆ</th><th>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</th><th>æ©Ÿæ</th><th>çŠ¶æ…‹</th><th>åŒºåˆ†</th><th>é…å»¶</th>
  </tr></thead>`;

  if (hndDirFilter !== 'arr' && deps.length > 0) {
    html += `<div class="hnd-section-title" style="margin-bottom:10px">âœˆ å‡ºç™ºä¾¿ <span class="count-badge">${deps.length}</span></div>
      <div class="flight-table-wrap" style="margin-bottom:20px">
        <table class="flight-table">${thead}<tbody>${makeRows(deps,'dep')}</tbody></table>
      </div>`;
  }
  if (hndDirFilter !== 'dep' && arrs.length > 0) {
    html += `<div class="hnd-section-title green" style="margin-bottom:10px">ğŸ›¬ åˆ°ç€ä¾¿ <span class="count-badge">${arrs.length}</span></div>
      <div class="flight-table-wrap">
        <table class="flight-table">${thead}<tbody>${makeRows(arrs,'arr')}</tbody></table>
      </div>`;
  }
  if (!html) html = '<div class="empty-state"><div class="empty-icon">âœˆ</div>å¯¾è±¡ã®ä¾¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  return html;
}

// =============================================
// RENDER ALERTS (æ¬ èˆªãƒ»é…å»¶ãƒ»æ­ä¹—ä¸­ãƒ»é£›è¡Œä¸­)
// =============================================
function renderAlerts() {
  const filterAP = alertAirportFilter;
  const filterFlight = (f, type) => {
    if (filterAP === 'HND') {
      const ap = type==='dep' ? getAirportCode(f['odpt:departureAirport']) : getAirportCode(f['odpt:arrivalAirport']);
      return ap === 'HND';
    }
    if (filterAP === 'NRT') {
      const ap = type==='dep' ? getAirportCode(f['odpt:departureAirport']) : getAirportCode(f['odpt:arrivalAirport']);
      return ap === 'NRT';
    }
    return true;
  };

  // æ¬ èˆªä¾¿
  const cancelDep = allDepartures.filter(f => isCancelled(f) && filterFlight(f,'dep'));
  const cancelArr = allArrivals.filter(f => isCancelled(f) && filterFlight(f,'arr'));
  const allCancel = [...cancelDep.map(f=>({...f,_dir:'dep'})),...cancelArr.map(f=>({...f,_dir:'arr'}))];
  document.getElementById('cancel-count-badge').textContent = allCancel.length + ' ä»¶';

  const cancelArea = document.getElementById('cancel-list-area');
  if (allCancel.length === 0) {
    cancelArea.innerHTML = '<div class="empty-state"><div class="empty-icon">âœ…</div>æ¬ èˆªä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    cancelArea.innerHTML = allCancel.map(f => {
      const fn = (f['odpt:flightNumber']||[]).join('/');
      const depAP = getAirportCode(f['odpt:departureAirport']||'');
      const destAP = getAirportCode(f['odpt:destinationAirport']||f['odpt:arrivalAirport']||'');
      const origAP = getAirportCode(f['odpt:originAirport']||'');
      const sched = f['odpt:scheduledDepartureTime'] || f['odpt:scheduledArrivalTime'] || '-';
      const term = getTerminal(f['odpt:departureAirportTerminal']||f['odpt:arrivalAirportTerminal']||'');
      const reason = (f['odpt:flightInformationText']||{}).ja || (f['odpt:flightInformationSummary']||{}).ja || '';
      const route = f._dir==='dep' ? `${depAP}â†’${destAP}` : `${origAP}â†’${getAirportCode(f['odpt:arrivalAirport']||'')}`;
      const routeName = f._dir==='dep'
        ? `${AIRPORTS[depAP]||depAP} â†’ ${AIRPORTS[destAP]||destAP}`
        : `${AIRPORTS[origAP]||origAP} â†’ ${AIRPORTS[getAirportCode(f['odpt:arrivalAirport']||'')] || getAirportCode(f['odpt:arrivalAirport']||'')}`;
      return `<div class="cancel-alert" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))}, '${f._dir}')">
        <div>
          <div class="ca-num">${fn}</div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${airlineBadge(f._src)}</div>
        </div>
        <div class="ca-info">
          <div class="ca-route">âœˆ ${routeName}</div>
          <div class="ca-detail">å®šåˆ»: ${sched}ã€€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«: ${term}ã€€${reason ? `ç†ç”±: ${reason}` : ''}</div>
        </div>
        <div class="ca-badge"><span class="status-badge status-cancel">æ¬ èˆª</span></div>
      </div>`;
    }).join('');
  }

  // é…å»¶ä¾¿
  const delayDep = allDepartures.filter(f => isDelayed(f,'dep') && filterFlight(f,'dep'));
  const delayArr = allArrivals.filter(f => isDelayed(f,'arr') && filterFlight(f,'arr'));
  const allDelay = [
    ...delayDep.map(f=>({...f,_dir:'dep'})),
    ...delayArr.map(f=>({...f,_dir:'arr'}))
  ].sort((a,b)=>{
    const da = getHndDelayMins(a,a._dir)||0;
    const db = getHndDelayMins(b,b._dir)||0;
    return db - da; // é…å»¶å¤§ãã„é †
  });
  document.getElementById('delay-count-badge').textContent = allDelay.length + ' ä»¶';

  const delayArea = document.getElementById('delay-list-area');
  if (allDelay.length === 0) {
    delayArea.innerHTML = '<div class="empty-state"><div class="empty-icon">âœ…</div>é…å»¶ä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    delayArea.innerHTML = allDelay.map(f => {
      const fn = (f['odpt:flightNumber']||[]).join('/');
      const sched = f._dir==='dep' ? f['odpt:scheduledDepartureTime'] : f['odpt:scheduledArrivalTime'];
      const actual = f._dir==='dep'
        ? (f['odpt:actualDepartureTime']||f['odpt:estimatedDepartureTime'])
        : (f['odpt:actualArrivalTime']||f['odpt:estimatedArrivalTime']);
      const d = timeDiff(sched, actual);
      const depAP = getAirportCode(f['odpt:departureAirport']||f['odpt:originAirport']||'');
      const destAP = getAirportCode(f['odpt:destinationAirport']||f['odpt:arrivalAirport']||'');
      const dirLabel = f._dir==='dep'?'å‡ºç™º':'åˆ°ç€';
      const reason = (f['odpt:flightInformationText']||{}).ja || (f['odpt:flightInformationSummary']||{}).ja || '';
      return `<div style="background:rgba(255,183,0,0.06);border:1px solid rgba(255,183,0,0.2);border-radius:6px;padding:12px 14px;margin-bottom:8px;cursor:pointer;transition:background 0.15s;" 
        onmouseover="this.style.background='rgba(255,183,0,0.12)'" onmouseout="this.style.background='rgba(255,183,0,0.06)'"
        onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))},'${f._dir}')">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
          <span class="flight-num ${flightNumClass(f._src)}" style="font-size:16px">${fn}</span>
          ${airlineBadge(f._src)}
          <span style="font-size:11px;color:var(--text-muted)">${dirLabel}</span>
          <span style="margin-left:auto;font-family:'Share Tech Mono',monospace;font-size:18px;font-weight:700;color:var(--accent-amber)">+${d||'?'}åˆ†</span>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px">
          <span class="airport-code" style="font-size:12px">${depAP}</span>
          <span style="color:var(--text-muted)"> â†’ </span>
          <span class="airport-code" style="font-size:12px">${destAP}</span>
          <span style="color:var(--text-muted);margin-left:6px">${AIRPORTS[destAP]||''}</span>
        </div>
        <div style="display:flex;gap:16px;font-size:11px;color:var(--text-muted)">
          <span>å®šåˆ»: <span class="time-cell" style="font-size:11px">${sched||'-'}</span></span>
          <span>å®Ÿç¸¾/äºˆå®š: <span class="time-cell time-delayed" style="font-size:11px">${actual||'-'}</span></span>
          ${reason ? `<span style="color:var(--accent-amber)">${reason}</span>` : ''}
        </div>
      </div>`;
    }).join('');
  }

  // æ­ä¹—ä¸­ä¾¿
  const boardingFlights = allDepartures.filter(f =>
    ((f['odpt:flightStatus']||'').includes('Boarding') || (f['odpt:flightStatus']||'').includes('GateClosed'))
    && filterFlight(f,'dep')
  );
  document.getElementById('boarding-count-badge').textContent = boardingFlights.length + ' ä»¶';

  const boardingArea = document.getElementById('boarding-list-area');
  if (boardingFlights.length === 0) {
    boardingArea.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸšª</div>ç¾åœ¨æ­ä¹—ä¸­ã®ä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    boardingArea.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px">` +
      boardingFlights.map(f => {
        const fn = (f['odpt:flightNumber']||[]).join('/');
        const dest = getAirportCode(f['odpt:destinationAirport']);
        const destName = AIRPORTS[dest] || dest;
        const sched = f['odpt:scheduledDepartureTime'] || '-';
        const gate = f['odpt:departureGate'];
        const term = getTerminal(f['odpt:departureAirportTerminal']);
        const status = getDepStatusClass(f);
        return `<div class="boarding-card" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))},'dep')">
          <div class="bc-top">
            <span class="bc-num">${fn}</span>
            ${airlineBadge(f._src)}
            <div style="margin-left:auto;text-align:right">
              ${gate ? `<div class="bc-gate-big">${gate}</div><div class="bc-gate-label">GATE</div>` : `<div class="bc-gate-big" style="font-size:18px">${term}</div><div class="bc-gate-label">TERM</div>`}
            </div>
          </div>
          <div class="bc-route">âœˆ ${getAirportCode(f['odpt:departureAirport'])} â†’ <strong>${dest}</strong>ã€€${destName}</div>
          <div class="bc-times">
            <div class="bc-time"><div class="bc-time-label">å‡ºç™ºæ™‚åˆ»</div><div class="bc-time-val">${sched}</div></div>
            <div class="bc-time" style="margin-left:auto"><div class="bc-time-label">çŠ¶æ…‹</div><div><span class="status-badge ${status.cls}">${status.label}</span></div></div>
          </div>
        </div>`;
      }).join('') + `</div>`;
  }

  // é£›è¡Œä¸­ä¾¿
  const inairFlights = allDepartures.filter(f =>
    (f['odpt:flightStatus']||'').includes('InAir')
    && filterFlight(f,'dep')
  );
  document.getElementById('inair-count-badge').textContent = inairFlights.length + ' ä»¶';

  const inairArea = document.getElementById('inair-list-area');
  if (inairFlights.length === 0) {
    inairArea.innerHTML = '<div class="empty-state"><div class="empty-icon">âœˆ</div>ç¾åœ¨é£›è¡Œä¸­ã®ä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    inairArea.innerHTML = `<div class="flight-table-wrap">
      <table class="flight-table">
        <thead><tr><th>ä¾¿å</th><th>èˆªç©ºä¼šç¤¾</th><th>å‡ºç™ºåœ°</th><th>ç›®çš„åœ°</th><th>å®šåˆ»å‡ºç™º</th><th>å®Ÿå‡ºç™º</th><th>é…å»¶</th><th>æ©Ÿæ</th></tr></thead>
        <tbody>` +
      inairFlights.map(f => {
        const fn = (f['odpt:flightNumber']||[]).join('/');
        const depAP = getAirportCode(f['odpt:departureAirport']);
        const destAP = getAirportCode(f['odpt:destinationAirport']);
        const sched = f['odpt:scheduledDepartureTime'] || '-';
        const actual = f['odpt:actualDepartureTime'] || '-';
        const d = timeDiff(sched, actual);
        return `<tr class="flight-row" onclick="showFlightDetail(${JSON.stringify(JSON.stringify(f))},'dep')">
          <td><span class="flight-num ${flightNumClass(f._src)}">${fn}</span></td>
          <td>${airlineBadge(f._src)}</td>
          <td><span class="airport-code">${depAP}</span><span style="font-size:10px;color:var(--text-muted);margin-left:3px">${AIRPORTS[depAP]||''}</span></td>
          <td><span class="airport-code">${destAP}</span><span style="font-size:10px;color:var(--text-muted);margin-left:3px">${AIRPORTS[destAP]||''}</span></td>
          <td class="time-cell">${sched}</td>
          <td class="time-cell ${d&&d>0?'time-delayed':d&&d<0?'time-early':''}">${actual}</td>
          <td>${d&&d>0?`<span style="color:var(--accent-amber);font-family:'Share Tech Mono',monospace">+${d}åˆ†</span>`:d&&d<0?`<span style="color:var(--accent-green)">${d}åˆ†</span>`:'-'}</td>
          <td style="font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--text-secondary)">${f['odpt:aircraftType']||'-'}</td>
        </tr>`;
      }).join('') +
      `</tbody></table></div>`;
  }
}

// =============================================
// INIT
// =============================================
fetchAllData();
setInterval(fetchAllData, CONFIG.REFRESH_INTERVAL);

// Challenge API expiry warning
if (!challengeActive) {
  console.info('ãƒãƒ£ãƒ¬ãƒ³ã‚¸APIï¼ˆHND-TIAT/NAAï¼‰ã¯æœŸé–“å¤–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚');
}
</script>
</body>
</html>
