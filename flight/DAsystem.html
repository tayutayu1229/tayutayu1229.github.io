<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›¢ç€é™¸ç™ºç€ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        /* =======================================================
           1. åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« & ãƒªã‚»ãƒƒãƒˆ (æ–°ãƒ‡ã‚¶ã‚¤ãƒ³)
           ======================================================= */
        :root {
            --color-ana: #0076a8; 
            --color-jal: #e4002b; 
            --color-base-bg: #eef7ff; /* ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ */
            --color-panel-bg: #ffffff;
            --color-header-bg: #004477; /* ãƒ€ãƒ¼ã‚¯ãƒãƒªãƒ³ */
            --color-header-text: #ffffff;
            --color-accent: #004477; 
            --color-warning: #e08e00; /* ã‚´ãƒ¼ãƒ«ãƒ‰ */
            --color-error: var(--color-jal); 
            --color-success: #1a7a40; 
            --color-border-sharp: #99aacc; /* æ˜ã‚‹ã„ãƒœãƒ¼ãƒ€ãƒ¼ */
            --font-main: 'Meiryo UI', 'MS UI Gothic', 'Segoe UI', Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            background-color: var(--color-base-bg);
            color: #222;
            line-height: 1.4;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px 20px;
        }
        
        /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚åˆ»è¡¨ç¤º */
        #current-time-display {
            background-color: #dbe4f0;
            padding: 5px 10px;
            margin-bottom: 10px;
            border: 1px solid var(--color-border-sharp);
            font-size: 16px;
            font-weight: bold;
            color: var(--color-header-bg);
            text-align: right;
        }

        /* =======================================================
           2. ãƒ˜ãƒƒãƒ€ãƒ¼ & ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
           ======================================================= */
        header {
            background-color: var(--color-header-bg);
            padding: 10px 20px;
            border-bottom: 2px solid var(--color-accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-area {
            font-size: 20px;
            font-weight: bold;
            color: var(--color-header-text);
        }

        .tab-navigation {
            display: flex;
            gap: 2px;
        }

        .tab-button {
            padding: 8px 15px;
            background-color: var(--color-base-bg);
            border: 1px solid var(--color-border-sharp);
            cursor: pointer;
            transition: all 0.1s;
            font-weight: 600;
            border-radius: 4px 4px 0 0; /* è§’ã‚’ä¸¸ã */
            font-size: 14px;
        }

        .tab-button.active {
            background-color: var(--color-panel-bg);
            color: var(--color-accent);
            border-bottom: none;
            border-top: 3px solid var(--color-accent); /* å¼·èª¿ */
            z-index: 10;
        }
        
        #airport-selection-warning {
            padding: 8px;
            margin: 10px 0;
            background-color: #fff8e1; /* ãƒ©ã‚¤ãƒˆã‚¤ã‚¨ãƒ­ãƒ¼ */
            border: 1px solid var(--color-warning);
            color: var(--color-warning);
            font-weight: bold;
            border-radius: 4px;
            text-align: center;
            font-size: 1.0em;
        }
        
        /* =======================================================
           3. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° & ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢
           ======================================================= */
        .control-panel {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            align-items: flex-start;
        }
        
        .filter-area {
            background-color: var(--color-panel-bg);
            padding: 15px;
            border: 1px solid var(--color-border-sharp);
            border-radius: 4px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            flex-grow: 1;
            align-items: flex-end;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* ğŸ’¡ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚¨ãƒªã‚¢ */
        #alert-setting-area {
            background-color: #f0f8ff; /* ã‚ˆã‚Šæ˜ã‚‹ã„èƒŒæ™¯ */
            padding: 15px;
            border: 1px solid var(--color-accent);
            border-radius: 4px;
            flex-grow: 1;
            margin-top: 10px;
        }
        #alert-setting-area h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--color-accent);
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
        }
        #alert-setting-area .filter-group {
            width: 100%;
            margin-bottom: 10px;
        }


        .utility-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 250px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: bold;
            color: var(--color-accent);
        }

        .filter-group select,
        .filter-group input[type="text"],
        .filter-group input[type="date"],
        .filter-group input[type="time"],
        .utility-panel button,
        #required-airport-select {
            padding: 6px 8px;
            border: 1px solid #aaa;
            border-radius: 4px;
            min-width: 100px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        
        #required-airport-select {
            border: 2px solid var(--color-error); /* èµ¤ã§ç›®ç«‹ãŸã›ã‚‹ */
            font-weight: bold;
            min-width: 150px;
        }
        
        .utility-panel button {
            background-color: var(--color-accent);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
        }
        .utility-panel button:hover {
            background-color: #005a9b;
        }
        
        /* ã‚°ãƒ©ãƒ•ã¨ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .dashboard-area {
            display: flex;
            gap: 10px;
            min-width: 250px;
            flex-grow: 1;
        }

        .chart-container, .notes-container {
            border: 1px solid var(--color-border-sharp);
            background-color: var(--color-panel-bg);
            padding: 15px;
            flex: 1;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .chart-container h4, .notes-container h4 {
            margin-top: 0;
            font-size: 14px;
            color: var(--color-accent);
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .chart-wrapper {
            max-height: 100px;
            width: 100%; 
        }
        #operational-chart {
            width: 100% !important;
            height: 90px !important; 
        }
        #business-notes {
            width: 100%;
            min-height: 100px;
            border: 1px solid #ccc;
            padding: 8px;
            box-sizing: border-box;
            resize: vertical;
            font-family: var(--font-main);
            font-size: 13px;
            border-radius: 4px;
        }

        /* =======================================================
           4. ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ (ãƒ†ãƒ¼ãƒ–ãƒ«)
           ======================================================= */
        .flight-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--color-panel-bg);
            border: 1px solid var(--color-border-sharp);
            margin-top: 10px;
            table-layout: auto;
            border-radius: 4px;
            overflow: hidden; /* è§’ä¸¸å¯¾å¿œ */
        }

        .flight-table th, .flight-table td {
            padding: 6px 10px; 
            text-align: left;
            border: 1px solid #e0e0e0;
            font-size: 13px; 
            white-space: nowrap;
        }

        .flight-table th {
            background-color: #f0f5ff; /* æ˜ã‚‹ã„ãƒ˜ãƒƒãƒ€ãƒ¼ */
            color: var(--color-accent);
            cursor: pointer;
            user-select: none;
            font-weight: bold;
        }
        
        /* ã‚½ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
        .flight-table th .sort-indicator {
            margin-left: 5px;
            color: var(--color-error);
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è‰²ä»˜ã‘ */
        .status-cell { font-weight: bold; }
        .status-departed, .status-arrived, .status-ontime { color: var(--color-success); }
        .status-delayed { color: var(--color-warning); }
        .status-cancelled { color: var(--color-error); }
        .flight-number-link { cursor: pointer; text-decoration: underline; color: var(--color-accent); }
        
        /* =======================================================
           5. ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« 
           ======================================================= */
        #debug-panel-container {
            margin-top: 20px;
        }
        #debug-panel {
            white-space: pre;
            overflow-x: auto;
            max-height: 200px;
            background-color: #2c3e50; /* æ¿ƒã„é’ */
            color: #ecf0f1;
            padding: 10px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        /* =======================================================
           6. ãƒ¢ãƒ¼ãƒ€ãƒ«
           ======================================================= */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            padding-top: 50px;
        }

        .modal-content {
            background-color: var(--color-panel-bg);
            margin: 5% auto;
            padding: 20px;
            border: 2px solid var(--color-accent);
            width: 80%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
            border-radius: 8px;
        }
        .modal-content h2 {
            font-size: 1.4em;
            color: var(--color-header-bg);
            border-bottom: 2px solid var(--color-accent);
            padding-bottom: 5px;
            margin-top: 0;
        }
        .modal-content table {
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            width: 100%; /* è¿½åŠ  */
            margin-top: 10px;
        }
        .modal-content td {
            border: 1px solid #eee;
            padding: 6px;
        }

        /* çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #statisticsModal .modal-content {
            max-width: 600px;
        }
        #statisticsModal h3 {
            font-size: 1.1em;
            color: var(--color-accent);
            margin-top: 15px;
        }
        #statisticsChartContainer {
             height: 150px; 
             margin-top: 10px;
        }
        
        /* =======================================================
           7. ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« (æ–°è¦è¿½åŠ )
           ======================================================= */
        /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ™‚ã¯èƒŒæ™¯ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ã®è¦ç´ ã‚’éè¡¨ç¤ºã«ã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µ */
        :fullscreen body {
            background-color: var(--color-base-bg);
        }

        :fullscreen .container {
            padding: 0;
            max-width: none;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        :fullscreen #current-time-display {
            padding: 10px 20px;
            font-size: 1.2em;
        }
        
        /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºä¸­ã€ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠä»¥å¤–ã®è¦ç´ ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        :fullscreen .control-panel,
        :fullscreen .dashboard-area,
        :fullscreen #debug-panel-container,
        :fullscreen header { 
            display: none !important;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚’ç”»é¢å…¨ä½“ã«åºƒã’ã‚‹ */
        :fullscreen #flight-data-view {
            flex-grow: 1; 
            overflow: auto; 
            padding: 10px 0;
        }
        
        :fullscreen .flight-table {
            /* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ™‚ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
            font-size: 15px; 
            height: 100%; 
        }
        
        :fullscreen .flight-table th, 
        :fullscreen .flight-table td {
            padding: 10px 15px;
        }
        
    </style>
</head>
<body>

    <header>
        <div class="logo-area">
            é›¢ç€é™¸ç™ºç€ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
        </div>
        <div class="tab-navigation">
            <button class="tab-button active" data-view="schedule">æ™‚åˆ»è¡¨</button>
            <button class="tab-button" data-view="departure">å‡ºç™º</button>
            <button class="tab-button" data-view="arrival">åˆ°ç€</button>
        </div>
    </header>

    <div class="container">
        <div id="current-time-display"></div>
        
        <div id="airport-selection-warning" style="display: block;">
            ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ã¾ãšã€Œä½¿ç”¨ç©ºæ¸¯ (å¿…é ˆ)ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        </div>

        <div class="control-panel">
            <div style="flex-grow: 1;">
                <div class="filter-area">
                    <div class="filter-group">
                        <label for="required-airport-select">ä½¿ç”¨ç©ºæ¸¯ (å¿…é ˆ)</label>
                        <select id="required-airport-select" required>
                            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                            <option value="HND">æ±äº¬ï¼ˆç¾½ç”°ï¼‰</option>
                            <option value="NRT">æ±äº¬ï¼ˆæˆç”°ï¼‰</option>
                            <option value="ITM">å¤§é˜ªï¼ˆä¼Šä¸¹ï¼‰</option>
                            <option value="KIX">é–¢è¥¿å›½éš›</option>
                            <option value="FUK">ç¦å²¡</option>
                            <option value="CTS">æœ­å¹Œï¼ˆæ–°åƒæ­³ï¼‰</option>
                            <option value="OKA">é‚£è¦‡</option>
                            <option value="NGO">ä¸­éƒ¨(ã‚»ãƒ³ãƒˆãƒ¬ã‚¢)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filter-operator">é‹èˆªä¼šç¤¾</label>
                        <select id="filter-operator">
                            <option value="ALL">ã™ã¹ã¦</option>
                            <option value="ANA">ANA</option>
                            <option value="JAL">JAL</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-flight-number">ä¾¿å</label>
                        <input type="text" id="filter-flight-number" placeholder="ä¾‹: NH123">
                    </div>
                    <div class="filter-group realtime-only" style="display: none;">
                        <label for="filter-date">æ—¥ä»˜</label>
                        <input type="date" id="filter-date">
                    </div>
                    <div class="filter-group">
                        <label for="filter-time-slot">æ™‚åˆ»å¸¯</label>
                        <select id="filter-time-slot">
                            <option value="ALL">ã™ã¹ã¦</option>
                            <option value="morning">åˆå‰</option>
                            <option value="afternoon">åˆå¾Œ</option>
                            <option value="night">å¤œé–“</option>
                        </select>
                    </div>
                    <div class="filter-group schedule-only">
                        <label for="filter-weekday">æ›œæ—¥ (æœ¬æ—¥è‡ªå‹•è¨­å®š)</label>
                        <select id="filter-weekday">
                            <option value="ALL">ã™ã¹ã¦</option>
                            <option value="odpt.Calendar:Sunday">æ—¥æ›œ</option>
                            <option value="odpt.Calendar:Monday">æœˆæ›œ</option>
                            <option value="odpt.Calendar:Tuesday">ç«æ›œ</option>
                            <option value="odpt.Calendar:Wednesday">æ°´æ›œ</option>
                            <option value="odpt.Calendar:Thursday">æœ¨æ›œ</option>
                            <option value="odpt.Calendar:Friday">é‡‘æ›œ</option>
                            <option value="odpt.Calendar:Saturday">åœŸæ›œ</option>
                        </select>
                    </div>
                    <div class="filter-group realtime-only" style="display: none;">
                        <label for="filter-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select id="filter-status">
                            <option value="ALL">ã™ã¹ã¦</option>
                            <option value="odpt.FlightStatus:Scheduled">äºˆå®š</option>
                            <option value="odpt.FlightStatus:OnTime">å®šåˆ»</option>
                            <option value="odpt.FlightStatus:Delayed">é…å»¶</option>
                            <option value="odpt.FlightStatus:Cancelled">æ¬ èˆª</option>
                            <option value="odpt.FlightStatus:Departed">å‡ºç™ºæ¸ˆ</option>
                            <option value="odpt.FlightStatus:Arrived">åˆ°ç€æ¸ˆ</option>
                            <option value="odpt.FlightStatus:Landed">ç€é™¸</option>
                            <option value="odpt.FlightStatus:LeftGate">ã‚²ãƒ¼ãƒˆå‡ºç™º</option>
                        </select>
                    </div>
                </div>
                
                <div id="alert-setting-area">
                    <h4>ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥è¨­å®š (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã®ã¿é©ç”¨)</h4>
                    <p style="font-size: 12px; margin-top: -5px; color: var(--color-accent);">
                       **ã€æ¬ èˆªé€šçŸ¥ã€‘**ã¯å…¨ä¾¿ãŒå¯¾è±¡ã§ã™ã€‚**ã€é…å»¶/å®Œäº†é€šçŸ¥ã€‘**ã¯ä»¥ä¸‹ã®æ¡ä»¶ã«åˆè‡´ã™ã‚‹ä¾¿ã®ã¿é€šçŸ¥ã•ã‚Œã¾ã™ã€‚
                    </p>
                    <div style="display: flex; gap: 15px;">
                        <div class="filter-group" style="flex: 1;">
                            <label for="alert-flight-number">å¯¾è±¡ä¾¿å (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                            <input type="text" id="alert-flight-number" placeholder="ä¾‹: NH123,JL456">
                        </div>
                        <div class="filter-group" style="flex: 1;">
                            <label for="alert-airport-code">å¯¾è±¡å‡ºç™ºåœ°/åˆ°ç€åœ°ã‚³ãƒ¼ãƒ‰ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                            <input type="text" id="alert-airport-code" placeholder="ä¾‹: FUK,ITM">
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="utility-panel">
                <div style="font-weight: bold; margin-bottom: 5px;">ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</div>
                <button id="toggle-fullscreen">ğŸ–¼ï¸ å…¨ç”»é¢è¡¨ç¤º</button> <button id="export-csv">CSVå‡ºåŠ›</button>
                <button id="show-statistics">ğŸ“Š é‹è¡Œçµ±è¨ˆãƒ»å®šæ™‚æ€§åˆ†æ</button>
                <div id="realtime-status" style="font-size: 13px; text-align: center; padding: 5px 0;"></div>
            </div>
        </div>


        <div style="display: flex; gap: 20px; margin-bottom: 10px;">
            <div class="dashboard-area">
                <div class="chart-container">
                    <h4>é‹è¡ŒçŠ¶æ³ã‚°ãƒ©ãƒ• (ç¾åœ¨ã®è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿)</h4>
                    <div class="chart-wrapper">
                        <canvas id="operational-chart"></canvas>
                    </div>
                    <p style="font-size: 12px; margin-top: 5px;">
                        ç·ä¾¿æ•°: <span id="gauge-total-count" style="font-weight: bold;">0</span>
                        <span style="margin-left: 20px; color: var(--color-success);">â–  å®šåˆ»/å‡ºç™ºæ¸ˆ</span>
                        <span style="margin-left: 10px; color: var(--color-warning);">â–  é…å»¶</span>
                        <span style="margin-left: 10px; color: var(--color-error);">â–  æ¬ èˆª</span>
                    </p>
                </div>
                <div class="notes-container">
                    <h4>æ¥­å‹™å¼•ãç¶™ããƒãƒ¼ãƒˆ</h4>
                    <textarea id="business-notes" placeholder="æ¥­å‹™é€£çµ¡äº‹é …ã€ç‰¹è¨˜äº‹é …ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚"></textarea>
                </div>
            </div>
        </div>


        <div id="flight-data-view">
            <div class="no-data">ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€å·¦ä¸Šã®ã€Œä½¿ç”¨ç©ºæ¸¯ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
        </div>
        
        <details id="debug-panel-container">
            <summary>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
            <div id="debug-panel">åˆæœŸåŒ–ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™...</div>
        </details>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 1.5em;">&times;</span>
            <h2 id="modal-flight-number">ãƒ•ãƒ©ã‚¤ãƒˆè©³ç´°æƒ…å ±</h2>
            <table style="font-size: 14px; margin-top: 10px; border-collapse: collapse;">
                <tr><td style="width: 35%; background-color: #f7f7f7;"><strong>é‹èˆªä¼šç¤¾</strong></td><td id="modal-operator" style="width: 65%;"></td></tr>
                <tr><td style="background-color: #f7f7f7;"><strong>å‡ºç™ºåœ°</strong></td><td id="modal-origin"></td></tr>
                <tr><td style="background-color: #f7f7f7;"><strong>ç›®çš„åœ°</strong></td><td id="modal-destination"></td></tr>
                <tr><td style="background-color: #f7f7f7;"><strong>äºˆå®šæ™‚åˆ»</strong></td><td id="modal-scheduled-time"></td></tr>
                <tr><td style="background-color: #f7f7f7;"><strong id="modal-actual-time-label">å®Ÿç¸¾/äºˆæ¸¬æ™‚åˆ»</strong></td><td id="modal-actual-time"></td></tr>
                <tr><td style="background-color: #f7f7f7;"><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</strong></td><td id="modal-status"></td></tr>
                <tr><td style="background-color: #f7f7f7;"><strong id="modal-gate-label">ã‚²ãƒ¼ãƒˆ/ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</strong></td><td id="modal-gate"></td></tr>
                <tr><td style="background-color: #f7f7f7;"><strong>æ©Ÿæ</strong></td><td id="modal-aircraft"></td></tr>
            </table>
            <h3 style="font-size: 1.1em; margin-top: 15px; border-top: 1px solid #ccc; padding-top: 5px;">é‹è¡Œæƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆ</h3>
            <p id="modal-info-text" style="font-size: 13px; border: 1px solid #ddd; padding: 5px; background-color: #fff;"></p>
        </div>
    </div>
    
    <div id="statisticsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" style="position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 1.5em;">&times;</span>
            <h2>ğŸ“Š é‹è¡Œçµ±è¨ˆãƒ»å®šæ™‚æ€§åˆ†æ</h2>
            <p style="font-size: 12px; color: #666;">**ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«åŸºã¥ãã€å®šæ™‚æ€§ï¼ˆOTPï¼‰ã‚’åˆ†æã—ã¾ã™ã€‚**</p>
            
            <h3>ã‚µãƒãƒªãƒ¼çµ±è¨ˆ</h3>
            <table id="statistics-summary-table">
                 <tr><td style="width: 40%; background-color: #f7f7f7;">**ç·å¯¾è±¡ä¾¿æ•°**</td><td id="stat-total">0</td></tr>
                 <tr><td style="background-color: #f7f7f7; color: var(--color-success);">**å®šæ™‚/æ­£å¸¸ç‡ (OTP)**</td><td id="stat-normal-rate">0.0%</td></tr>
                 <tr><td style="background-color: #f7f7f7; color: var(--color-warning);">**é…å»¶/äºˆæ¸¬ç‡**</td><td id="stat-delayed-rate">0.0%</td></tr>
                 <tr><td style="background-color: #f7f7f7; color: var(--color-error);">**æ¬ èˆªç‡**</td><td id="stat-cancelled-rate">0.0%</td></tr>
            </table>

            <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥å†…è¨³</h3>
            <div id="statisticsChartContainer">
                 <canvas id="statistics-pie-chart"></canvas>
            </div>
            
        </div>
    </div>
    
    <audio id="alertSound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhAAAAAAoBAAAAAgECAgIAAAMDAwMDAQICAQAAAAECAgAAAAIAAgICAQAAAAIBAgICAgAA" preload="auto"></audio>


    <script>
        // =======================================================
        // 9. JavaScript: ãƒ‡ãƒ¼ã‚¿ã¨APIå®šç¾©
        // =======================================================

        const ACCESS_TOKEN = "4tf33x46mhk1umi1jhfiy040thiafy3onu9y71ltyrplwnkjka5u5pni8k2d3z6v"; 
        const API_BASE = "https://api.odpt.org/api/v4/";
        const REALTIME_UPDATE_INTERVAL = 300000; // 5åˆ† (5åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°)

        const API_ENDPOINTS = {
            schedule: {
                ANA: `${API_BASE}odpt:FlightSchedule?odpt:operator=odpt.Operator:ANA&acl:consumerKey=${ACCESS_TOKEN}`,
                JAL: `${API_BASE}odpt:FlightSchedule?odpt:operator=odpt.Operator:JAL&acl:consumerKey=${ACCESS_TOKEN}`
            },
            departure: {
                ANA: `${API_BASE}odpt:FlightInformationDeparture?odpt:operator=odpt.Operator:ANA&acl:consumerKey=${ACCESS_TOKEN}`,
                JAL: `${API_BASE}odpt:FlightInformationDeparture?odpt:operator=odpt.Operator:JAL&acl:consumerKey=${ACCESS_TOKEN}`
            },
            arrival: {
                ANA: `${API_BASE}odpt:FlightInformationArrival?odpt:operator=odpt.Operator:ANA&acl:consumerKey=${ACCESS_TOKEN}`,
                JAL: `${API_BASE}odpt:FlightInformationArrival?odpt:operator=odpt.Operator:JAL&acl:consumerKey=${ACCESS_TOKEN}`
            }
        };

        let currentView = 'schedule';
        let currentSortKey = null;
        // isAscendingã¯æ™‚åˆ»è¡¨ã§ã®ã¿ä½¿ç”¨ã•ã‚Œã‚‹
        let isAscending = true; 
        // ğŸ’¡ çŠ¶æ…‹ç®¡ç†å¤‰æ•°ã‚’è¿½åŠ : æ™‚åˆ»è¡¨ãƒ“ãƒ¥ãƒ¼ã§ã®ã¿ä½¿ç”¨ (1:æ˜‡é †, -1:é™é †, 0:ç¾åœ¨æ™‚åˆ»é †)
        let timeSortState = 1; 
        
        let flightData = [];
        let previousStatusMap = {};
        
        const WEEKDAY_MAP_KEYS = {
            'odpt.Calendar:Sunday': 'æ—¥æ›œ', 'odpt.Calendar:Monday': 'æœˆæ›œ', 'odpt.Calendar:Tuesday': 'ç«æ›œ',
            'odpt.Calendar:Wednesday': 'æ°´æ›œ', 'odpt.Calendar:Thursday': 'æœ¨æ›œ', 'odpt.Calendar:Friday': 'é‡‘æ›œ',
            'odpt.Calendar:Saturday': 'åœŸæ›œ', 'odpt.Calendar:Weekday': 'å¹³æ—¥', 'odpt.Calendar:Holiday': 'ä¼‘æ—¥'
        };
        const DAY_OF_WEEK_KEYS = ['odpt.Calendar:Sunday', 'odpt.Calendar:Monday', 'odpt.Calendar:Tuesday', 
                                  'odpt.Calendar:Wednesday', 'odpt.Calendar:Thursday', 'odpt.Calendar:Friday', 
                                  'odpt.Calendar:Saturday'];

        const AIRPORT_MAP_JAPANESE = {
            "ITM": "å¤§é˜ªï¼ˆä¼Šä¸¹ï¼‰", "HND": "æ±äº¬ï¼ˆç¾½ç”°ï¼‰", "NRT": "æ±äº¬ï¼ˆæˆç”°ï¼‰",
            "CTS": "æœ­å¹Œï¼ˆæ–°åƒæ­³ï¼‰", "OKA": "é‚£è¦‡", "KIX": "é–¢è¥¿å›½éš›",
            "NGO": "ä¸­éƒ¨(ã‚»ãƒ³ãƒˆãƒ¬ã‚¢)", "FUK": "ç¦å²¡", "KOJ": "é¹¿å…å³¶",
            "HIJ": "åºƒå³¶", "SDJ": "ä»™å°", "AOJ": "é’æ£®", "AXT": "ç§‹ç”°",
            "FKS": "ç¦å³¶",
            // ... (ãã®ä»–ã®ç©ºæ¸¯ã‚³ãƒ¼ãƒ‰)
        };

        const STATUS_MAP = {
            'odpt.FlightStatus:Scheduled': 'äºˆå®š', 
            'odpt.FlightStatus:OnTime': 'å®šåˆ»',
            'odpt.FlightStatus:Delayed': 'é…å»¶', 
            'odpt.FlightStatus:Cancelled': 'æ¬ èˆª',
            'odpt.FlightStatus:Departed': 'å‡ºç™ºæ¸ˆ', 
            'odpt.FlightStatus:Arrived': 'åˆ°ç€æ¸ˆ',
            'odpt.FlightStatus:Landed': 'ç€é™¸', 
            'odpt.FlightStatus:Boarding': 'æ­ä¹—ä¸­', 
            'odpt.FlightStatus:GateClosed': 'ã‚²ãƒ¼ãƒˆé–‰é–',
            'odpt.FlightStatus:InAir': 'é£›è¡Œä¸­', 
            'odpt.FlightStatus:EstimatedDeparture': 'å‡ºç™ºäºˆæ¸¬', 
            'odpt.FlightStatus:EstimatedArrival': 'åˆ°ç€äºˆæ¸¬', 
            'odpt.FlightStatus:LeftGate': 'ã‚²ãƒ¼ãƒˆå‡ºç™º', 
        };
        
        let operationalChart = null; 
        let statisticsPieChart = null; 

        // =======================================================
        // 10. JavaScript: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // =======================================================
        
        function debugLog(message, isError = false) {
            const panel = document.getElementById('debug-panel');
            if (!panel) return;
            const now = new Date().toLocaleTimeString('ja-JP');
            const logEntry = `[${now}] ${isError ? 'ERROR: ' : 'INFO: '}${message}\n`;
            panel.innerHTML = logEntry + panel.innerHTML;
        }

        function mapAirportCode(code) {
            if (!code) return '-';
            const airportCode = code.split(':').pop();
            const japaneseName = AIRPORT_MAP_JAPANESE[airportCode];
            return japaneseName ? `${japaneseName}` : airportCode; 
        }
        
        function mapFlightStatus(status) {
            if (!status) return '-'; 
            return STATUS_MAP[status] || status.split(':').pop();
        }
        
        function mapCalendarToJapanese(calendarKey) {
            return WEEKDAY_MAP_KEYS[calendarKey] || calendarKey.split(':').pop();
        }

        function getStatusClass(status) {
             if (!status) return ''; 
             
            const statusType = status.split(':').pop().toLowerCase();
            if (statusType.includes('departed') || statusType.includes('arrived') || statusType.includes('ontime') || statusType.includes('inair') || statusType.includes('landed') || statusType.includes('leftgate')) return 'status-departed';
            if (statusType.includes('delayed') || statusType.includes('estimated')) return 'status-delayed';
            if (statusType.includes('cancelled')) return 'status-cancelled';
            return 'status-scheduled';
        }

        function updateCurrentTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dayStr = now.toLocaleDateString('ja-JP', { weekday: 'long' });
            document.getElementById('current-time-display').textContent = `æ—¥æ™‚: ${dateStr} (${dayStr}) ${timeStr}`;
        }
        
        function exportToCSV(data, view) {
            // CSVå‡ºåŠ›ãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥
            if (data.length === 0) {
                alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const headers = BASE_HEADERS[view];
            const requiredAirportCode = document.getElementById('required-airport-select').value;
            const requiredAirportName = mapAirportCode(`odpt.Airport:${requiredAirportCode}`);

            const csvHeader = headers.map(h => {
                return h.key === 'sort:currentTime' ? `äºˆå®šæ™‚åˆ»ï¼ˆ${requiredAirportName}ï¼‰` : h.label;
            }).join(',');
            
            const csvRows = data.map(item => {
                return headers.map(header => {
                    let displayValue = '';
                    switch (header.key) {
                        case 'odpt:operator':
                            displayValue = item[header.key] ? item[header.key].split(':').pop() : '';
                            break;
                        case 'odpt:flightNumber':
                            displayValue = (Array.isArray(item[header.key]) ? item[header.key].join(', ') : item[header.key]) || '';
                            break;
                        case 'odpt:originAirport':
                        case 'odpt:destinationAirport':
                            // åˆ°ç€ãƒ“ãƒ¥ãƒ¼ã®å‡ºç™ºåœ°å‚ç…§ã‚’ä¿®æ­£
                            const airportKey = (view === 'schedule' || view === 'departure') ? header.key : (
                                // arrival view
                                header.key === 'odpt:originAirport' ? 'odpt:originAirport' : 'odpt:arrivalAirport'
                            );
                            displayValue = mapAirportCode(item[airportKey] || item[header.key]);
                            break;
                        case 'odpt:flightStatus':
                            displayValue = mapFlightStatus(item[header.key]);
                            break;
                        case 'odpt:flightInformationSummary':
                            displayValue = (item[header.key] && item[header.key].ja) ? item[header.key].ja : '';
                            break;
                        case 'odpt:calendar':
                            displayValue = item[header.key] ? mapCalendarToJapanese(item[header.key]) : '';
                            break;
                        case 'odpt:gate':
                        case 'odpt:terminal':
                            displayValue = item[header.key] ? item[header.key].split(':').pop() : '';
                            break;
                        case 'sort:currentTime':
                            const requiredAirportTag = `odpt.Airport:${document.getElementById('required-airport-select').value}`;
                            if (view === 'schedule') {
                                const timeKey = item['odpt:originAirport'] === requiredAirportTag ? 'odpt:originTime' : 'odpt:destinationTime';
                                displayValue = item[timeKey] ? item[timeKey].substring(0, 5) : '';
                            } else {
                                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã®äºˆå®šæ™‚åˆ»ã‚­ãƒ¼ã‚’ä½¿ç”¨
                                const timeKey = view === 'departure' ? 'odpt:scheduledDepartureTime' : 'odpt:scheduledArrivalTime';
                                displayValue = item[timeKey] ? item[timeKey].substring(0, 5) : '';
                            }
                            break;
                        case 'odpt:actualDepartureTime':
                        case 'odpt:actualArrivalTime':
                            displayValue = item[header.key] ? item[header.key].substring(0, 5) : '';
                            break;
                        default:
                            displayValue = item[header.key] || '';
                            if (typeof displayValue === 'string' && (displayValue.includes(',') || displayValue.includes('\n') || displayValue.includes('"'))) {
                                displayValue = `"${displayValue.replace(/"/g, '""')}"`;
                            }
                            break;
                    }
                    return displayValue;
                }).join(',');
            });

            const csvContent = [csvHeader, ...csvRows].join('\n');
            const blob = new Blob(["\ufeff", csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            const today = new Date().toISOString().substring(0, 10).replace(/-/g, '');
            const filename = `${mapAirportCode(`odpt.Airport:${document.getElementById('required-airport-select').value}`)}-${view}-${today}.csv`;
            
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: ${filename}`);
        }

        function playAlertSound() {
            const audio = document.getElementById('alertSound');
            try {
                audio.play();
            } catch (e) {
                debugLog('ã‚¢ãƒ©ãƒ¼ãƒˆéŸ³ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™ã€‚', true);
            }
        }
        
        /**
         * HH:MM å½¢å¼ã®æ™‚åˆ»æ–‡å­—åˆ—ã‚’ã€ãã®æ—¥ã® 00:00 ã‹ã‚‰ã®çµŒéåˆ†æ•°ã«å¤‰æ›ã™ã‚‹
         * @param {string} timeStr - æ™‚åˆ»æ–‡å­—åˆ— (ä¾‹: "10:30")
         * @returns {number} 00:00ã‹ã‚‰ã®çµŒéåˆ†æ•°
         */
        function timeToMinutes(timeStr) {
             if (!timeStr || timeStr.length < 5) return Infinity; // ç„¡åŠ¹ãªæ™‚åˆ»ã¯æœ€å¾Œã«
             const parts = timeStr.split(':');
             const hours = parseInt(parts[0], 10);
             const minutes = parseInt(parts[1], 10);
             return hours * 60 + minutes;
        }

        function checkStatusChanges(currentData) {
            if (currentView === 'schedule') return; 

            const alertFlightNumbers = document.getElementById('alert-flight-number').value.toUpperCase().split(',').map(s => s.trim()).filter(s => s.length > 0);
            const alertAirportCodes = document.getElementById('alert-airport-code').value.toUpperCase().split(',').map(s => s.trim()).filter(s => s.length > 0);

            let newStatusMap = {};
            let alertMessages = [];

            currentData.forEach(item => {
                const uniqueId = item._uniqueId;
                const currentStatus = item['odpt:flightStatus'];
                newStatusMap[uniqueId] = currentStatus;
                
                const previousStatus = previousStatusMap[uniqueId];

                if (!previousStatus) return; 

                const flightNumber = (Array.isArray(item['odpt:flightNumber']) ? item['odpt:flightNumber'][0] : item['odpt:flightNumber']) || 'ä¸æ˜';
                
                const destinationCode = item['odpt:destinationAirport'] ? item['odpt:destinationAirport'].split(':').pop() : null;
                const originCode = item['odpt:originAirport'] ? item['odpt:originAirport'].split(':').pop() : null;
                
                const relevantAirport = currentView === 'departure' ? destinationCode : originCode;

                const airportName = mapAirportCode(currentView === 'departure' ? item['odpt:destinationAirport'] : item['odpt:originAirport']);
                const timeKey = currentView === 'departure' ? 'odpt:scheduledDepartureTime' : 'odpt:scheduledArrivalTime';
                const scheduledTime = item[timeKey] ? item[timeKey].substring(0, 5) : 'æ™‚åˆ»ä¸æ˜';
                const direction = currentView === 'departure' ? 'å‡ºç™º' : 'åˆ°ç€';
                
                let trigger = false;
                let message = `ã€${direction}ä¾¿é‡è¦é€šçŸ¥ã€‘`;

                // --- ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥æ¡ä»¶ã®åˆ¤å®š ---
                
                // 1. æ¬ èˆªã‚¢ãƒ©ãƒ¼ãƒˆ (å…¨ã¦ã®ä¾¿ãŒå¯¾è±¡)
                if (currentStatus === 'odpt.FlightStatus:Cancelled' && previousStatus !== 'odpt.FlightStatus:Cancelled') {
                    trigger = true;
                    message += `ä¾¿å: ${flightNumber} (${airportName}) ${scheduledTime} ${direction}ä¾¿ãŒ**æ¬ èˆª**ã—ã¾ã—ãŸã€‚(å…¨ä¾¿å¯¾è±¡)`;
                } 
                
                // 2. é…å»¶/å®Œäº†ã‚¢ãƒ©ãƒ¼ãƒˆ (æŒ‡å®šæ¡ä»¶ã®ä¾¿ã®ã¿å¯¾è±¡)
                const isTargetFlight = 
                    (alertFlightNumbers.includes(flightNumber.toUpperCase())) ||
                    (relevantAirport && alertAirportCodes.includes(relevantAirport));
                
                if (isTargetFlight) {
                    if (['odpt.FlightStatus:Delayed', 'odpt.FlightStatus:EstimatedDeparture', 'odpt.FlightStatus:EstimatedArrival'].includes(currentStatus) &&
                        !['odpt.FlightStatus:Delayed', 'odpt.FlightStatus:EstimatedDeparture', 'odpt.FlightStatus:EstimatedArrival', 'odpt.FlightStatus:Cancelled', 'odpt.FlightStatus:Departed', 'odpt.FlightStatus:Arrived', 'odpt.FlightStatus:Landed', 'odpt.FlightStatus:LeftGate'].includes(previousStatus)) {
                        
                        // å‰å›ãŒã€Œäºˆå®šã€ã‚„ã€Œå®šåˆ»ã€ã‹ã‚‰ã€Œé…å»¶ã€ã«ãªã£ãŸå ´åˆ
                        trigger = true;
                        message += `ä¾¿å: ${flightNumber} (${airportName}) ${scheduledTime} ${direction}ä¾¿ãŒ**é…å»¶/äºˆæ¸¬**ã«å¤‰ã‚ã‚Šã¾ã—ãŸã€‚`;
                    }
                    // 3. å®Œäº†ã‚¢ãƒ©ãƒ¼ãƒˆ (æŒ‡å®šæ¡ä»¶ã®ä¾¿ã®ã¿å¯¾è±¡)
                    // å‡ºç™º
                    else if (currentView === 'departure' && ['odpt.FlightStatus:Departed', 'odpt.FlightStatus:LeftGate'].includes(currentStatus) && !['odpt.FlightStatus:Departed', 'odpt.FlightStatus:LeftGate'].includes(previousStatus)) {
                        const statusText = currentStatus === 'odpt.FlightStatus:Departed' ? 'å‡ºç™ºæ¸ˆ' : 'ã‚²ãƒ¼ãƒˆå‡ºç™º';
                        trigger = true;
                        message += `ä¾¿å: ${flightNumber} (${airportName}) ${scheduledTime} ${direction}ä¾¿ãŒ**${statusText}**ã«ãªã‚Šã¾ã—ãŸã€‚`;
                    }
                    // åˆ°ç€
                     else if (currentView === 'arrival' && ['odpt.FlightStatus:Arrived', 'odpt.FlightStatus:Landed'].includes(currentStatus) && !['odpt.FlightStatus:Arrived', 'odpt.FlightStatus:Landed'].includes(previousStatus)) {
                        const statusText = currentStatus === 'odpt.FlightStatus:Arrived' ? 'åˆ°ç€æ¸ˆ' : 'ç€é™¸';
                        trigger = true;
                        message += `ä¾¿å: ${flightNumber} (${airportName}) ${scheduledTime} ${direction}ä¾¿ãŒ**${statusText}**ã«ãªã‚Šã¾ã—ãŸã€‚`;
                    }
                }
                // --- ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥æ¡ä»¶ã®åˆ¤å®š çµ‚äº† ---


                if (trigger) {
                    alertMessages.push(message);
                    debugLog(message);
                }
            });

            
            if (alertMessages.length > 0) {
                playAlertSound();
                alert(alertMessages.join('\n\n')); 
            }
        }

        /**
         * ğŸ’¡ æ–°è¦è¿½åŠ : ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
         */
        function toggleFullscreen() {
            const elem = document.documentElement; // ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«ã™ã‚‹
            const button = document.getElementById('toggle-fullscreen');

            if (!document.fullscreenElement) {
                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’è¦æ±‚
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
                button.textContent = 'ğŸ–¥ï¸ å…¨ç”»é¢è§£é™¤';
            } else {
                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE11 */
                    document.msExitFullscreen();
                }
                button.textContent = 'ğŸ–¼ï¸ å…¨ç”»é¢è¡¨ç¤º';
            }
        }
        
        // ğŸ’¡ æ–°è¦è¿½åŠ : ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹
        function handleFullscreenChange() {
            const button = document.getElementById('toggle-fullscreen');
            if (document.fullscreenElement) {
                 button.textContent = 'ğŸ–¥ï¸ å…¨ç”»é¢è§£é™¤';
            } else {
                 button.textContent = 'ğŸ–¼ï¸ å…¨ç”»é¢è¡¨ç¤º';
            }
        }


        // =======================================================
        // 10.5. è¨­å®šã®æ°¸ç¶šåŒ– (localStorage)
        // =======================================================

        function saveSettings() {
            const settings = {
                requiredAirport: document.getElementById('required-airport-select').value,
                view: currentView,
                operator: document.getElementById('filter-operator').value,
                flightNumber: document.getElementById('filter-flight-number').value,
                timeSlot: document.getElementById('filter-time-slot').value,
                weekday: document.getElementById('filter-weekday').value,
                date: document.getElementById('filter-date').value,
                status: document.getElementById('filter-status').value,
                alertFlightNumber: document.getElementById('alert-flight-number').value,
                alertAirportCode: document.getElementById('alert-airport-code').value,
                // ğŸ’¡ ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚‚ä¿å­˜
                currentSortKey: currentSortKey,
                isAscending: isAscending,
                timeSortState: timeSortState,
            };
            localStorage.setItem('flight_pro_settings', JSON.stringify(settings));
            localStorage.setItem('flight_pro_notes', document.getElementById('business-notes').value);
        }

        function loadSettings() {
            const settingsString = localStorage.getItem('flight_pro_settings');
            const notes = localStorage.getItem('flight_pro_notes');
            
            if (notes) {
                document.getElementById('business-notes').value = notes;
            }

            if (settingsString) {
                const settings = JSON.parse(settingsString);
                
                document.getElementById('required-airport-select').value = settings.requiredAirport || '';
                
                currentView = settings.view || 'schedule';
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-view') === currentView) {
                        btn.classList.add('active');
                    }
                });
                
                document.getElementById('filter-operator').value = settings.operator || 'ALL';
                document.getElementById('filter-flight-number').value = settings.flightNumber || '';
                document.getElementById('filter-time-slot').value = settings.timeSlot || 'ALL';
                
                const today = new Date().getDay(); 
                const todayKey = DAY_OF_WEEK_KEYS[today];
                document.getElementById('filter-weekday').value = settings.weekday || todayKey;
                
                document.getElementById('filter-date').value = settings.date || (currentView !== 'schedule' ? new Date().toISOString().substring(0, 10) : '');
                
                document.getElementById('filter-status').value = settings.status || 'ALL';
                
                document.getElementById('alert-flight-number').value = settings.alertFlightNumber || '';
                document.getElementById('alert-airport-code').value = settings.alertAirportCode || '';

                // ğŸ’¡ ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã®å¾©å…ƒ
                currentSortKey = settings.currentSortKey || null;
                isAscending = settings.isAscending !== undefined ? settings.isAscending : true;
                timeSortState = settings.timeSortState !== undefined ? settings.timeSortState : 1;


                return true;
            }
            return false;
        }

        // =======================================================
        // 11. JavaScript: ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»å‡¦ç† (å¤‰æ›´ãªã—)
        // =======================================================

        async function fetchFlightData(view) {
            const requiredAirportCode = document.getElementById('required-airport-select').value;
            if (!requiredAirportCode) {
                document.getElementById('flight-data-view').innerHTML = '<div class="no-data">ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ã¾ãšã€Œä½¿ç”¨ç©ºæ¸¯ (å¿…é ˆ)ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
                document.getElementById('airport-selection-warning').style.display = 'block';
                return [];
            }
            document.getElementById('airport-selection-warning').style.display = 'none';

            debugLog(`ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹: ${view}, å¯¾è±¡ç©ºæ¸¯: ${requiredAirportCode}`);
            const urls = API_ENDPOINTS[view];
            const allData = [];

            try {
                document.getElementById('flight-data-view').innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­ã§ã™...</div>';
                
                const results = await Promise.allSettled([
                    fetch(urls.ANA).then(res => res.json()),
                    fetch(urls.JAL).then(res => res.json())
                ]);

                results.forEach((result, index) => {
                    const operator = index === 0 ? 'ANA' : 'JAL';
                    if (result.status === 'fulfilled' && Array.isArray(result.value)) {
                        debugLog(`ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ (${operator}: ${result.value.length}ä»¶)`);
                        allData.push(...result.value);
                    } else {
                        debugLog(`${operator}ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—/ç„¡åŠ¹: ${result.reason || 'ã‚¨ãƒ©ãƒ¼è©³ç´°ä¸æ˜'}`, true);
                    }
                });

            } catch (error) {
                debugLog(`è‡´å‘½çš„ãªãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                document.getElementById('flight-data-view').innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
                return [];
            }
            
            let processedData = [];
            const requiredAirportTag = `odpt.Airport:${requiredAirportCode}`;

            if (view === 'schedule') {
                allData.forEach(schedule => {
                    const isRelevant = schedule['odpt:originAirport'] === requiredAirportTag || 
                                       schedule['odpt:destinationAirport'] === requiredAirportTag;

                    if (isRelevant) {
                        schedule['odpt:flightScheduleObject'].forEach((flight, index) => {
                            processedData.push({
                                ...flight,
                                '_uniqueId': `${schedule['owl:sameAs']}-${index}`,
                                'odpt:originAirport': schedule['odpt:originAirport'],
                                'odpt:destinationAirport': schedule['odpt:destinationAirport'],
                                'odpt:calendar': schedule['odpt:calendar'],
                                'odpt:operator': schedule['odpt:operator'],
                                'odpt:aircraftType': flight['odpt:aircraftType'],
                            });
                        });
                    }
                });
            } else {
                 allData.forEach((item, index) => {
                    const isRelevant = (view === 'departure' && item['odpt:departureAirport'] === requiredAirportTag) || 
                                       (view === 'arrival' && item['odpt:arrivalAirport'] === requiredAirportTag);
                    
                    if (isRelevant) {
                        processedData.push({
                            ...item,
                            '_uniqueId': `${item['owl:sameAs']}-${index}`,
                        });
                    }
                 });
            }
            
            debugLog(`ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®æœ€çµ‚ãƒ‡ãƒ¼ã‚¿æ•° (ä½¿ç”¨ç©ºæ¸¯: ${requiredAirportCode}): ${processedData.length}`);
            return processedData;
        }

        // =======================================================
        // 12. JavaScript: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆ (ä¿®æ­£ãªã—)
        // =======================================================

        function filterAndSortData(data) {
            const operatorFilter = document.getElementById('filter-operator').value;
            const flightNumberFilter = document.getElementById('filter-flight-number').value.toUpperCase();
            const weekdayFilter = currentView === 'schedule' ? document.getElementById('filter-weekday').value : null;
            const timeSlotFilter = document.getElementById('filter-time-slot').value;
            const dateFilter = document.getElementById('filter-date').value;
            const statusFilter = currentView !== 'schedule' ? document.getElementById('filter-status').value : 'ALL';
            
            const now = new Date();
            // ç¾åœ¨æ™‚åˆ» (åˆ†å˜ä½ã®æ•°å€¤)
            const nowMinutes = now.getHours() * 60 + now.getMinutes(); 
            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            let filtered = data.filter(item => {
                const operatorMatch = operatorFilter === 'ALL' || item['odpt:operator'] === `odpt.Operator:${operatorFilter}`;
                const flightNumberMatch = flightNumberFilter === '' || (item['odpt:flightNumber'] || []).some(num => (num || '').toUpperCase().includes(flightNumberFilter));
                
                const weekdayMatch = currentView !== 'schedule' || weekdayFilter === 'ALL' || item['odpt:calendar'] === weekdayFilter;
                
                let timeKey;
                if (currentView === 'schedule') {
                    const requiredAirportTag = `odpt.Airport:${document.getElementById('required-airport-select').value}`;
                    timeKey = item['odpt:originAirport'] === requiredAirportTag ? 'odpt:originTime' : 'odpt:destinationTime';
                } else {
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã§ã¯äºˆå®šæ™‚åˆ»ã‚­ãƒ¼ã‚’ä½¿ç”¨
                    timeKey = currentView === 'departure' ? 'odpt:scheduledDepartureTime' : 'odpt:scheduledArrivalTime';
                }

                let timeSlotMatch = true;
                if (timeSlotFilter !== 'ALL') {
                    const timeString = item[timeKey];
                    if (timeString) {
                        const hour = parseInt(timeString.split(':')[0], 10);
                        if (timeSlotFilter === 'morning' && (hour < 0 || hour > 11)) timeSlotMatch = false;
                        if (timeSlotFilter === 'afternoon' && (hour < 12 || hour > 17)) timeSlotMatch = false;
                        if (timeSlotFilter === 'night' && (hour < 18 || hour > 23)) timeSlotMatch = false;
                    }
                }
                
                let dateMatch = true;
                if (currentView !== 'schedule' && dateFilter) {
                    const dateToCheck = item['dc:date'] ? item['dc:date'].substring(0, 10) : null;
                    dateMatch = dateToCheck === dateFilter;
                }
                
                const statusMatch = statusFilter === 'ALL' || item['odpt:flightStatus'] === statusFilter;
                
                let timeExclusionMatch = true;
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã§ã®éå»æ™‚é–“ã®è‡ªå‹•é™¤å¤–ãƒ­ã‚¸ãƒƒã‚¯ (æ™‚åˆ»è¡¨ã§ã¯é©ç”¨ã—ãªã„)
                if (currentView !== 'schedule') {
                    const scheduledTime = item[timeKey] || '99:99'; 
                    
                    const isPast = scheduledTime < currentTimeStr;
                    const isCompleted = ['odpt.FlightStatus:Departed', 'odpt.FlightStatus:Arrived', 'odpt.FlightStatus:Landed', 'odpt.FlightStatus:Cancelled', 'odpt.FlightStatus:LeftGate'].includes(item['odpt:flightStatus']);

                    // äºˆå®šæ™‚åˆ»ãŒéå»ã§ã‚ã‚Šã€ã‹ã¤æœªå®Œäº†ã®ä¾¿ã¯ãƒªã‚¹ãƒˆã‹ã‚‰é™¤å¤–ã™ã‚‹
                    if (isPast && !isCompleted) {
                        timeExclusionMatch = false;
                    }
                }
                
                return operatorMatch && flightNumberMatch && weekdayMatch && timeSlotMatch && dateMatch && statusMatch && timeExclusionMatch;
            });
            
            // ğŸ’¡ ã‚½ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ã¨å¼·åŒ–
            if (currentSortKey === null) {
                 currentSortKey = 'sort:currentTime'; 
                 isAscending = true;
                 timeSortState = 1; 
            }

            if (currentSortKey) {
                filtered.sort((a, b) => {
                    let comparison = 0;
                    
                    let sortKeyToUse = currentSortKey;
                    let timeA, timeB;
                    let timeKeyA, timeKeyB;

                    if (sortKeyToUse === 'sort:currentTime') {
                        // æ™‚åˆ»è¡¨ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‚ç…§ã™ã‚‹æ™‚åˆ»ã‚­ãƒ¼ãŒç•°ãªã‚‹
                        if (currentView === 'schedule') {
                            const requiredAirportTag = `odpt.Airport:${document.getElementById('required-airport-select').value}`;
                            timeKeyA = a['odpt:originAirport'] === requiredAirportTag ? 'odpt:originTime' : 'odpt:destinationTime';
                            timeKeyB = b['odpt:originAirport'] === requiredAirportTag ? 'odpt:originTime' : 'odpt:destinationTime';
                        } else {
                            timeKeyA = timeKeyB = currentView === 'departure' ? 'odpt:scheduledDepartureTime' : 'odpt:scheduledArrivalTime';
                        }
                        
                        timeA = a[timeKeyA] || '24:00';
                        timeB = b[timeKeyB] || '24:00';
                        
                        if (currentView === 'schedule' && timeSortState === 0) {
                            // ğŸ’¡ ç¾åœ¨æ™‚åˆ»é †ã‚½ãƒ¼ãƒˆ (æ™‚åˆ»è¡¨ãƒ“ãƒ¥ãƒ¼ã®ã¿)
                            const minutesA = timeToMinutes(timeA);
                            const minutesB = timeToMinutes(timeB);
                            
                            const diffA = Math.abs(minutesA - nowMinutes);
                            const diffB = Math.abs(minutesB - nowMinutes);
                            
                            comparison = diffA - diffB;
                            
                        } else {
                            // æ˜‡é †/é™é †ã‚½ãƒ¼ãƒˆ
                            comparison = timeA.localeCompare(timeB);
                            if (currentView === 'schedule' && timeSortState === -1) {
                                comparison = -comparison; // é™é †
                            } else if (currentView !== 'schedule' && !isAscending) {
                                comparison = -comparison; // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã®é™é †
                            }
                        }

                    } else if (sortKeyToUse.endsWith('Time') || sortKeyToUse.endsWith('originTime') || sortKeyToUse.endsWith('Time')) {
                         // ãã®ä»–ã®æ™‚åˆ»ã‚­ãƒ¼
                         comparison = (a[sortKeyToUse] || '24:00').localeCompare(b[sortKeyToUse] || '24:00');
                         if (!isAscending) comparison = -comparison;

                    } else if (sortKeyToUse === 'odpt:flightNumber') {
                         const numA = (Array.isArray(a[sortKeyToUse]) ? a[sortKeyToUse][0] : a[sortKeyToUse]) || '';
                         const numB = (Array.isArray(b[sortKeyToUse]) ? b[sortKeyToUse][0] : b[sortKeyToUse]) || '';
                         comparison = numA.localeCompare(numB);
                         if (!isAscending) comparison = -comparison;
                    } else {
                        // ãã®ä»–ã®æ–‡å­—åˆ—ã‚­ãƒ¼
                        const valA = a[sortKeyToUse] || '';
                        const valB = b[sortKeyToUse] || '';
                        comparison = String(valA).localeCompare(String(valB));
                        if (!isAscending) comparison = -comparison;
                    }
                    
                    return comparison;
                });
            }
            
            updateOperationalChart(filtered); 
            return filtered;
        }

        // é‹è¡ŒçŠ¶æ³ã‚°ãƒ©ãƒ•ã®æ›´æ–° (å¤‰æ›´ãªã—)
        function updateOperationalChart(data) {
            const total = data.length;
            
            const normal = data.filter(item => {
                 if (!item['odpt:flightStatus']) return false; 
                 
                 return ['odpt.FlightStatus:OnTime', 
                         'odpt.FlightStatus:Departed', 
                         'odpt.FlightStatus:Arrived', 
                         'odpt.FlightStatus:Scheduled',
                         'odpt.FlightStatus:InAir',
                         'odpt.FlightStatus:Landed',
                         'odpt.FlightStatus:LeftGate' 
                        ].includes(item['odpt:flightStatus']);
            }).length;
            
            const delayed = data.filter(item => {
                if (!item['odpt:flightStatus']) return false;
                return ['odpt.FlightStatus:Delayed', 
                        'odpt.FlightStatus:EstimatedDeparture', 
                        'odpt.FlightStatus:EstimatedArrival'
                        ].includes(item['odpt:flightStatus']);
            }).length;
            
            const cancelled = data.filter(item => item['odpt:flightStatus'] === 'odpt.FlightStatus:Cancelled').length;
            
            const totalCounted = normal + delayed + cancelled;

            document.getElementById('gauge-total-count').textContent = total;

            const chartData = {
                labels: ['é‹è¡ŒçŠ¶æ³'],
                datasets: [
                    {
                        label: 'å®šåˆ»/å‡ºç™ºæ¸ˆ/åˆ°ç€æ¸ˆ/ç€é™¸/é£›è¡Œä¸­',
                        data: [normal],
                        backgroundColor: 'rgba(26, 122, 64, 0.8)',
                        borderColor: 'rgba(26, 122, 64, 1)',
                        borderWidth: 1,
                    },
                    {
                        label: 'é…å»¶/äºˆæ¸¬',
                        data: [delayed],
                        backgroundColor: 'rgba(224, 142, 0, 0.8)',
                        borderColor: 'rgba(224, 142, 0, 1)',
                        borderWidth: 1,
                    },
                    {
                        label: 'æ¬ èˆª',
                        data: [cancelled],
                        backgroundColor: 'rgba(228, 0, 43, 0.8)',
                        borderColor: 'rgba(228, 0, 43, 1)',
                        borderWidth: 1,
                    }
                ]
            };

            const ctx = document.getElementById('operational-chart').getContext('2d');

            if (operationalChart) {
                operationalChart.destroy();
                operationalChart = null; 
            } 
            
             if (totalCounted === 0) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 return;
             }

            operationalChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const percent = totalCounted > 0 ? (value / totalCounted * 100).toFixed(1) : 0;
                                    return `${context.dataset.label}: ${value}ä¾¿ (${percent}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ä¾¿æ•°',
                                font: { size: 12, family: 'Meiryo UI' }
                            },
                            ticks: { font: { size: 11, family: 'Meiryo UI' } }
                        },
                        y: {
                            stacked: true,
                            display: false 
                        }
                    }
                }
            });
        }
        
        // çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•° (å¤‰æ›´ãªã—)
        function showStatisticsModal() {
            const modal = document.getElementById('statisticsModal');
            const data = filterAndSortData(flightData); 
            
            const total = data.length;
            
            const normal = data.filter(item => {
                 if (!item['odpt:flightStatus']) return false; 
                 return ['odpt.FlightStatus:OnTime', 'odpt.FlightStatus:Departed', 'odpt.FlightStatus:Arrived', 'odpt.FlightStatus:Scheduled', 'odpt.FlightStatus:InAir', 'odpt.FlightStatus:Landed', 'odpt.FlightStatus:LeftGate'].includes(item['odpt:flightStatus']);
            }).length;
            
            const delayed = data.filter(item => {
                if (!item['odpt:flightStatus']) return false;
                return ['odpt.FlightStatus:Delayed', 'odpt.FlightStatus:EstimatedDeparture', 'odpt.FlightStatus:EstimatedArrival'].includes(item['odpt:flightStatus']);
            }).length;
            
            const cancelled = data.filter(item => item['odpt:flightStatus'] === 'odpt.FlightStatus:Cancelled').length;
            
            const totalCounted = normal + delayed + cancelled;
            
            let normalRate = totalCounted > 0 ? (normal / totalCounted * 100).toFixed(1) : '0.0';
            let delayedRate = totalCounted > 0 ? (delayed / totalCounted * 100).toFixed(1) : '0.0';
            let cancelledRate = totalCounted > 0 ? (cancelled / totalCounted * 100).toFixed(1) : '0.0';
            
            document.getElementById('stat-total').textContent = totalCounted;
            document.getElementById('stat-normal-rate').textContent = `${normalRate}% (${normal}ä¾¿)`;
            document.getElementById('stat-delayed-rate').textContent = `${delayedRate}% (${delayed}ä¾¿)`;
            document.getElementById('stat-cancelled-rate').textContent = `${cancelledRate}% (${cancelled}ä¾¿)`;

            const pieData = {
                labels: ['å®šæ™‚/æ­£å¸¸', 'é…å»¶/äºˆæ¸¬', 'æ¬ èˆª'],
                datasets: [{
                    data: [normal, delayed, cancelled],
                    backgroundColor: [
                        'rgba(26, 122, 64, 0.8)', 
                        'rgba(224, 142, 0, 0.8)', 
                        'rgba(228, 0, 43, 0.8)'   
                    ],
                    hoverBackgroundColor: [
                        'rgba(26, 122, 64, 1)', 
                        'rgba(224, 142, 0, 1)', 
                        'rgba(228, 0, 43, 1)'
                    ]
                }]
            };

            const ctx = document.getElementById('statistics-pie-chart').getContext('2d');
            if (statisticsPieChart) {
                statisticsPieChart.destroy();
            }

            statisticsPieChart = new Chart(ctx, {
                type: 'doughnut', 
                data: pieData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 13,
                                    family: 'Meiryo UI'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percent = totalCounted > 0 ? (value / totalCounted * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value}ä¾¿ (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });

            modal.style.display = 'block';
        }


        // =======================================================
        // 13. JavaScript: æç”»ãƒ»ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ (ä¿®æ­£ã‚ã‚Š)
        // =======================================================

        const BASE_HEADERS = {
            schedule: [
                { key: 'odpt:operator', label: 'ä¼šç¤¾', sortable: true },
                { key: 'odpt:flightNumber', label: 'ä¾¿å', sortable: true },
                { key: 'sort:currentTime', label: 'äºˆå®šæ™‚åˆ»', sortable: true }, 
                { key: 'odpt:originAirport', label: 'å‡ºç™ºåœ°', sortable: true },
                { key: 'odpt:destinationAirport', label: 'åˆ°ç€åœ°', sortable: true },
                { key: 'odpt:originTime', label: 'äºˆå®šå‡ºç™º', sortable: true },
                { key: 'odpt:destinationTime', label: 'äºˆå®šåˆ°ç€', sortable: true },
                { key: 'odpt:calendar', label: 'æ›œæ—¥', sortable: true },
                { key: 'odpt:aircraftType', label: 'æ©Ÿæ', sortable: true },
            ],
            departure: [
                { key: 'odpt:operator', label: 'ä¼šç¤¾', sortable: true },
                { key: 'sort:currentTime', label: 'äºˆå®šæ™‚åˆ»', sortable: true }, 
                { key: 'odpt:actualDepartureTime', label: 'å®Ÿç¸¾/äºˆæ¸¬', sortable: true },
                { key: 'odpt:flightNumber', label: 'ä¾¿å', sortable: true },
                { key: 'odpt:destinationAirport', label: 'åˆ°ç€åœ°', sortable: true },
                { key: 'odpt:gate', label: 'ã‚²ãƒ¼ãƒˆ', sortable: true }, 
                { key: 'odpt:aircraftType', label: 'æ©Ÿæ', sortable: true }, 
                { key: 'odpt:flightStatus', label: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', sortable: true },
                { key: 'odpt:flightInformationSummary', label: 'æ¦‚è¦', sortable: false },
            ],
            arrival: [
                { key: 'odpt:operator', label: 'ä¼šç¤¾', sortable: true },
                { key: 'sort:currentTime', label: 'äºˆå®šæ™‚åˆ»', sortable: true }, 
                { key: 'odpt:actualArrivalTime', label: 'å®Ÿç¸¾/äºˆæ¸¬', sortable: true },
                { key: 'odpt:flightNumber', label: 'ä¾¿å', sortable: true },
                { key: 'odpt:originAirport', label: 'å‡ºç™ºåœ°', sortable: true }, 
                { key: 'odpt:terminal', label: 'ã‚¿ãƒ¼ãƒŸãƒŠãƒ«', sortable: true }, 
                { key: 'odpt:aircraftType', label: 'æ©Ÿæ', sortable: true }, 
                { key: 'odpt:flightStatus', label: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', sortable: true },
                { key: 'odpt:flightInformationSummary', label: 'æ¦‚è¦', sortable: false },
            ]
        };
        
        function renderTable(data, view) {
            const viewElement = document.getElementById('flight-data-view');
            const requiredAirportCode = document.getElementById('required-airport-select').value;
            const requiredAirportName = mapAirportCode(`odpt.Airport:${requiredAirportCode}`);

            const headers = BASE_HEADERS[view].map(header => {
                 // äºˆå®šæ™‚åˆ»ã®ãƒ©ãƒ™ãƒ«ã‚’å‹•çš„ã«æ›´æ–°
                if (header.key === 'sort:currentTime') {
                    return { 
                        ...header, 
                        label: `äºˆå®šæ™‚åˆ»ï¼ˆ${requiredAirportName}ï¼‰` 
                    };
                }
                // åˆ°ç€ãƒ“ãƒ¥ãƒ¼ã®å‡ºç™ºåœ°åˆ—ã®ãƒ©ãƒ™ãƒ«ã‚’ã€Œå‡ºç™ºåœ°ã€ã§å›ºå®š
                if (view === 'arrival' && header.key === 'odpt:originAirport') {
                    return { ...header, label: 'å‡ºç™ºåœ°' };
                }
                return header;
            });


            if (!requiredAirportCode) {
                viewElement.innerHTML = '<div class="no-data">ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ã¾ãšã€Œä½¿ç”¨ç©ºæ¸¯ (å¿…é ˆ)ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }

            if (!data || data.length === 0) {
                viewElement.innerHTML = '<div class="no-data">è©²å½“ã™ã‚‹ãƒ•ãƒ©ã‚¤ãƒˆæƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
                return;
            }

            let html = '<table class="flight-table"><thead><tr>';

            headers.forEach(header => {
                const isCurrentSort = currentSortKey === header.key;
                let indicator = '';

                if (isCurrentSort) {
                    if (header.key === 'sort:currentTime' && view === 'schedule') {
                         // æ™‚åˆ»è¡¨ãƒ“ãƒ¥ãƒ¼ã®æ™‚åˆ»ã‚½ãƒ¼ãƒˆ: 1:æ˜‡é †(â–²), -1:é™é †(â–¼), 0:ç¾åœ¨æ™‚åˆ»é †(â˜…)
                         if (timeSortState === 1) indicator = ' â–²'; 
                         else if (timeSortState === -1) indicator = ' â–¼';
                         else if (timeSortState === 0) indicator = ' â˜…'; // ç¾åœ¨æ™‚åˆ»é †
                    } else {
                        // ãã®ä»–ã®ã‚½ãƒ¼ãƒˆ: æ˜‡é †(â–²), é™é †(â–¼)
                        indicator = isAscending ? ' â–²' : ' â–¼';
                    }
                }
                
                const sortClass = header.sortable ? 'sortable' : '';
                html += `<th data-key="${header.key}" class="${sortClass}">
                            ${header.label}
                            ${indicator ? `<span class="sort-indicator">${indicator}</span>` : ''}
                        </th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach(item => {
                const rowClass = ''; 
                html += `<tr class="${rowClass}">`;
                
                headers.forEach(header => {
                    const key = header.key;
                    let displayValue = item[key];
                    let cellClass = '';
                    
                    try { 
                        switch(key) {
                            case 'sort:currentTime':
                                if (view === 'schedule') {
                                    const requiredAirportTag = `odpt.Airport:${document.getElementById('required-airport-select').value}`;
                                    const timeKey = item['odpt:originAirport'] === requiredAirportTag ? 'odpt:originTime' : 'odpt:destinationTime';
                                    displayValue = item[timeKey] ? item[timeKey].substring(0, 5) : '-';
                                } else {
                                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã®äºˆå®šæ™‚åˆ»ã‚­ãƒ¼ã‚’ä½¿ç”¨
                                    const timeKey = view === 'departure' ? 'odpt:scheduledDepartureTime' : 'odpt:scheduledArrivalTime';
                                    displayValue = item[timeKey] ? item[timeKey].substring(0, 5) : '-';
                                }
                                cellClass = 'status-cell';
                                break;
                            case 'odpt:operator':
                                const operatorCode = item[key] ? item[key].split(':').pop() : '-';
                                displayValue = operatorCode;
                                cellClass = operatorCode === 'ANA' ? 'airline-ana' : 'airline-jal';
                                break;
                            case 'odpt:flightNumber':
                                displayValue = (Array.isArray(item[key]) ? item[key].join(', ') : item[key]) || '-';
                                displayValue = `<span class="flight-number-link" data-flight-id="${item._uniqueId}">${displayValue}</span>`;
                                break;
                            case 'odpt:originAirport':
                            case 'odpt:destinationAirport':
                                // ğŸ’¡ ä¿®æ­£ãƒ­ã‚¸ãƒƒã‚¯ã®é©ç”¨: åˆ°ç€ãƒ“ãƒ¥ãƒ¼ã§odpt:originAirportåˆ—ãŒæ­£ã—ãitem['odpt:originAirport']ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«
                                let airportKey;
                                if (view === 'schedule' || view === 'departure') {
                                    airportKey = key; 
                                } else { // arrival
                                    // åˆ°ç€ä¾¿ãƒ“ãƒ¥ãƒ¼ã®å ´åˆã€odpt:originAirportåˆ—ã¯item['odpt:originAirport']ã€odpt:destinationAirportåˆ—ã¯item['odpt:arrivalAirport']ã‚’å‚ç…§
                                    airportKey = (key === 'odpt:originAirport') ? 'odpt:originAirport' : 'odpt:arrivalAirport';
                                }
                                displayValue = mapAirportCode(item[airportKey] || item[key]);
                                break;
                            case 'odpt:flightStatus':
                                displayValue = mapFlightStatus(item[key]);
                                cellClass = `status-cell ${getStatusClass(item[key] || '')}`;
                                break;
                            case 'odpt:flightInformationSummary':
                                displayValue = (item[key] && item[key].ja) ? item[key].ja : '-';
                                cellClass = displayValue.includes('é…å»¶') || displayValue.includes('æ¬ èˆª') ? 'status-delayed' : '';
                                break;
                            case 'odpt:calendar':
                                displayValue = item[key] ? mapCalendarToJapanese(item[key]) : '-';
                                break;
                            case 'odpt:gate':
                            case 'odpt:terminal':
                                displayValue = item[key] ? item[key].split(':').pop() : '-';
                                break;
                            case 'odpt:actualDepartureTime':
                            case 'odpt:actualArrivalTime':
                                displayValue = item[key] ? item[key].substring(0, 5) : '-';
                                break;
                            case 'odpt:originTime':
                            case 'odpt:destinationTime':
                            case 'odpt:aircraftType':
                                displayValue = item[key] ? (key.endsWith('Time') ? item[key].substring(0, 5) : item[key]) : '-';
                                break;
                            default:
                                displayValue = displayValue || '-';
                                break;
                        }
                    } catch (e) {
                         debugLog(`ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ã‚¨ãƒ©ãƒ¼ (ã‚­ãƒ¼: ${key}, ID: ${item._uniqueId}): ${e.message}`, true);
                         displayValue = 'ã‚¨ãƒ©ãƒ¼';
                    }
                    html += `<td class="${cellClass}">${displayValue}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            viewElement.innerHTML = html;

            document.querySelectorAll('.flight-table th.sortable').forEach(th => {
                th.addEventListener('click', handleSort);
            });
            document.querySelectorAll('.flight-number-link').forEach(link => {
                link.addEventListener('click', (e) => showDetailModal(e.currentTarget.getAttribute('data-flight-id')));
            });
        }
        
        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—)
        function showDetailModal(uniqueId) {
            const flight = flightData.find(item => item._uniqueId === uniqueId);
            if (!flight) return;

            document.getElementById('modal-flight-number').textContent = `ä¾¿å: ${(Array.isArray(flight['odpt:flightNumber']) ? flight['odpt:flightNumber'].join(', ') : flight['odpt:flightNumber']) || 'ä¸æ˜'}`;
            document.getElementById('modal-operator').textContent = flight['odpt:operator'] ? flight['odpt:operator'].split(':').pop() : '-';
            
            const isSchedule = currentView === 'schedule';
            const isDeparture = currentView === 'departure';

            const requiredAirportTag = `odpt.Airport:${document.getElementById('required-airport-select').value}`;
            
            let originKey, destinationKey;
            let scheduledTimeKey, actualTimeKey;

            if (isSchedule) {
                originKey = 'odpt:originAirport';
                destinationKey = 'odpt:destinationAirport';
                scheduledTimeKey = flight['odpt:originAirport'] === requiredAirportTag ? 'odpt:originTime' : 'odpt:destinationTime';
                actualTimeKey = null;
            } else if (isDeparture) {
                originKey = 'odpt:departureAirport';
                destinationKey = 'odpt:destinationAirport';
                scheduledTimeKey = 'odpt:scheduledDepartureTime'; 
                actualTimeKey = 'odpt:actualDepartureTime';
            } else { // arrival
                originKey = 'odpt:originAirport'; // ğŸ’¡ ä¿®æ­£ç®‡æ‰€ï¼šåˆ°ç€ãƒ“ãƒ¥ãƒ¼ã§ã¯odpt:originAirportãŒçœŸã®å‡ºç™ºåœ°
                destinationKey = 'odpt:arrivalAirport';
                scheduledTimeKey = 'odpt:scheduledArrivalTime'; 
                actualTimeKey = 'odpt:actualArrivalTime';
            }

            document.getElementById('modal-origin').textContent = mapAirportCode(flight[originKey]) || '-';
            document.getElementById('modal-destination').textContent = mapAirportCode(flight[destinationKey]) || '-';
            
            document.getElementById('modal-scheduled-time').textContent = flight[scheduledTimeKey] ? flight[scheduledTimeKey].substring(0, 5) : '-';
            
            const actualTime = actualTimeKey ? (flight[actualTimeKey] ? flight[actualTimeKey].substring(0, 5) : '-') : 'N/A';
            document.getElementById('modal-actual-time-label').textContent = actualTimeKey ? 'å®Ÿç¸¾/äºˆæ¸¬æ™‚åˆ»' : 'å®Ÿç¸¾/äºˆæ¸¬æ™‚åˆ» (N/A)';
            document.getElementById('modal-actual-time').textContent = actualTime;

            const status = mapFlightStatus(flight['odpt:flightStatus']);
            document.getElementById('modal-status').textContent = status;
            document.getElementById('modal-aircraft').textContent = flight['odpt:aircraftType'] || '-';
            
            const gateOrTerminalCode = isDeparture ? flight['odpt:gate'] : flight['odpt:terminal'];
            const gateOrTerminalLabel = isDeparture ? 'ã‚²ãƒ¼ãƒˆ' : 'ã‚¿ãƒ¼ãƒŸãƒŠãƒ«';
            
            document.getElementById('modal-gate-label').textContent = gateOrTerminalLabel;

            document.getElementById('modal-gate').textContent = gateOrTerminalCode ? gateOrTerminalCode.split(':').pop() : '-';

            document.getElementById('modal-info-text').textContent = (flight['odpt:flightInformationSummary'] && flight['odpt:flightInformationSummary'].ja) || 'ç‰¹è¨˜äº‹é …ãªã—';

            document.getElementById('detailModal').style.display = 'block';
        }

        function handleSort(event) {
            const newSortKey = event.currentTarget.getAttribute('data-key');
            
            if (currentSortKey === newSortKey) {
                if (currentView === 'schedule' && newSortKey === 'sort:currentTime') {
                    // æ™‚åˆ»è¡¨ãƒ“ãƒ¥ãƒ¼ã§ã€Œäºˆå®šæ™‚åˆ»ã€ã‚’é€£ç¶šã‚¯ãƒªãƒƒã‚¯
                    timeSortState = (timeSortState + 1) % 3; // 1 (æ˜‡é †) -> -1 (é™é †) -> 0 (ç¾åœ¨æ™‚åˆ»é †) -> 1 (æ˜‡é †)
                    if (timeSortState === 2) timeSortState = -1; // 0, 1, -1 ã®3çŠ¶æ…‹
                    if (timeSortState === -1) isAscending = false;
                    else if (timeSortState === 1) isAscending = true;
                    else isAscending = true; // ç¾åœ¨æ™‚åˆ»é †ã®å ´åˆã€isAscendingã¯æ„å‘³ã‚’æŒãŸãªã„ãŒã€ä¾¿å®œä¸Štrueã«
                    
                } else {
                    // ãã®ä»–ã®ã‚­ãƒ¼ã€ã¾ãŸã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã®æ™‚åˆ»ã‚½ãƒ¼ãƒˆ
                    isAscending = !isAscending;
                }
            } else {
                currentSortKey = newSortKey;
                isAscending = true; 
                if (currentView === 'schedule' && newSortKey === 'sort:currentTime') {
                    timeSortState = 1; // æ–°ã—ã„ã‚­ãƒ¼é¸æŠæ™‚ã€æ™‚åˆ»ã‚½ãƒ¼ãƒˆã¯æ˜‡é †ã‹ã‚‰é–‹å§‹
                } else {
                    timeSortState = 1; // æ™‚åˆ»ã‚½ãƒ¼ãƒˆä»¥å¤–ã®ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€æ™‚åˆ»ã‚½ãƒ¼ãƒˆã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                }
            }
            
            // ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å†æç”» (ã‚½ãƒ¼ãƒˆå‡¦ç†) ã‚’å®Ÿè¡Œ
            renderView(currentView, false);
        }
        
        async function renderView(view, fetchData = true) {
            
            const requiredAirportCode = document.getElementById('required-airport-select').value;
            
            if (!requiredAirportCode) {
                document.getElementById('flight-data-view').innerHTML = '<div class="no-data">ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ã¾ãš**ã€Œä½¿ç”¨ç©ºæ¸¯ (å¿…é ˆ)ã€**ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
                document.getElementById('airport-selection-warning').style.display = 'block';
                updateOperationalChart([]);
                saveSettings();
                return;
            }
            document.getElementById('airport-selection-warning').style.display = 'none';

            const isSchedule = view === 'schedule';
            document.querySelectorAll('.schedule-only').forEach(el => el.style.display = isSchedule ? 'flex' : 'none');
            document.querySelectorAll('.realtime-only').forEach(el => el.style.display = isSchedule ? 'none' : 'flex');
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚¨ãƒªã‚¢ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã«é€£å‹•
            document.getElementById('alert-setting-area').style.display = isSchedule ? 'none' : 'block';

            const realtimeStatus = document.getElementById('realtime-status');
            realtimeStatus.innerHTML = `<span style="color: ${isSchedule ? '#666' : 'var(--color-success)'};">${isSchedule ? 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿' : 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿'}</span>`;
            
            if (fetchData) {
                
                // ãƒ‡ãƒ¼ã‚¿å–å¾—å‰ã«å‰å›ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜ã™ã‚‹
                if (currentView !== 'schedule') {
                     previousStatusMap = {};
                     flightData.forEach(item => {
                        previousStatusMap[item._uniqueId] = item['odpt:flightStatus'];
                     });
                     debugLog(`å‰å›ã®ãƒ•ãƒ©ã‚¤ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’${Object.keys(previousStatusMap).length}ä»¶ä¿å­˜ã—ã¾ã—ãŸã€‚`);
                } else {
                    previousStatusMap = {}; 
                }
                
                flightData = await fetchFlightData(view);
                
                // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ã®åˆæœŸåŒ–
                if (currentSortKey === null || currentSortKey === 'sort:currentTime') {
                    currentSortKey = 'sort:currentTime'; 
                    isAscending = true; 
                    timeSortState = 1;
                }
            }

            const dataToRender = filterAndSortData(flightData);
            renderTable(dataToRender, view);
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒ‡ãƒ¼ã‚¿ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
            if (currentView !== 'schedule') {
                checkStatusChanges(dataToRender); 
            }
            
            saveSettings();
        }


        // =======================================================
        // 14. JavaScript: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        // =======================================================

        function init() {
            debugLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');

            const settingsLoaded = loadSettings();

            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            if (!settingsLoaded) {
                const today = new Date().getDay(); 
                const todayKey = DAY_OF_WEEK_KEYS[today];
                document.getElementById('filter-weekday').value = todayKey;
                document.getElementById('filter-date').value = new Date().toISOString().substring(0, 10);
            }

            // 1. ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    document.querySelector('.tab-button.active')?.classList.remove('active');
                    e.currentTarget.classList.add('active');
                    currentView = e.currentTarget.getAttribute('data-view');
                    document.getElementById('filter-date').value = currentView !== 'schedule' ? new Date().toISOString().substring(0, 10) : '';
                    
                    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    currentSortKey = null;
                    isAscending = true;
                    timeSortState = 1;
                    
                    await renderView(currentView, true);
                });
            });

            // 2. ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´
            const filterInputs = [
                'filter-operator', 'filter-flight-number', 'filter-weekday', 'filter-time-slot', 
                'filter-date', 'filter-status'
            ];
            filterInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(element.tagName === 'INPUT' && element.type === 'text' ? 'input' : 'change', 
                                              () => renderView(currentView, false));
                }
            });
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã®å¤‰æ›´æ™‚ã‚‚è¨­å®šã‚’ä¿å­˜
            const alertInputs = ['alert-flight-number', 'alert-airport-code'];
            alertInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveSettings);
                }
            });


            // å¿…é ˆç©ºæ¸¯é¸æŠæ™‚ã®å‡¦ç†
            document.getElementById('required-airport-select').addEventListener('change', (e) => {
                debugLog(`ä½¿ç”¨ç©ºæ¸¯ãŒ ${e.target.value} ã«è¨­å®šã•ã‚Œã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ãƒ»æç”»ã—ã¾ã™ã€‚`);
                renderView(currentView, true);
            });

            // æ¥­å‹™ãƒãƒ¼ãƒˆã®ä¿å­˜
            document.getElementById('business-notes').addEventListener('input', saveSettings);
            
            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            document.getElementById('export-csv').addEventListener('click', () => { 
                exportToCSV(filterAndSortData(flightData), currentView); 
            });
            
            // çµ±è¨ˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('show-statistics').addEventListener('click', showStatisticsModal);
            
            // ğŸ’¡ ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('toggle-fullscreen').addEventListener('click', toggleFullscreen);
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('msfullscreenchange', handleFullscreenChange);

            // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³è¨­å®š
            const modalIds = ['detailModal', 'statisticsModal'];
            modalIds.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.querySelector('.close-button').onclick = () => { modal.style.display = 'none'; };
                    window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } };
                }
            });


            // 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°æ©Ÿèƒ½ (5åˆ†ã”ã¨)
            setInterval(() => {
                if (currentView !== 'schedule' && document.getElementById('required-airport-select').value) {
                    debugLog('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼');
                    renderView(currentView, true);
                }
            }, REALTIME_UPDATE_INTERVAL);
            
            // åˆå›æç”»ã®å®Ÿè¡Œ
            renderView(currentView, true);

            debugLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†ã€‚åˆå›æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã—ãŸã€‚');
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
        window.onload = init;
    </script>
</body>
</html>
