<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }

        .control-panel {
            background-color: #01977a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            white-space: nowrap;
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        select, input {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #cccccc;
            background-color: #f0f0f0;
            height: 30px;
        }

        .display-btn {
            background-color: white;
            color: #01977a;
            border: none;
            padding: 5px 20px;
            border-radius: 3px;
            cursor: pointer;
            height: 30px;
        }

        .display-btn:hover {
            background-color: #f0f0f0;
        }

        table {
			width: 100%;
			table-layout: fixed;
			border-collapse: collapse;
		}

        thead, tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        tbody {
			display: table;
			width: 100%;
			max-height: none;
			overflow-y: visible;
		}


        
		th, td {
			width: auto;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

        th {
            background-color: #01977a;
            color: white;
            text-align: left;
        }

        .col-direction { width: 10%; }
        .col-train-number { width: 23%; }
		.col-train-type { width: 22%; }
		.col-time { width: 30%; }
		.col-destination { width: 30%; }
		.col-nonono { width: 30%; }

        tr.down-train {
            background-color: #f0f0f0;
        }
        tr.up-train {
            background-color: #ffffff;
        }
        tr.separator {
            border-top: 3px solid #01977a;
        }

        .control-label {
            background-color: #01977a;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
	<div class="header">
            <h1>駅別ダイヤモニタ</h1>
    </div>
	<a href="toppage.html" class="button">メインメニューへ戻る</a>
    <div class="control-panel">
        <div class="control-item">
            <span class="control-label">表示内容選択</span>
        </div>
        <div class="control-item">
            <label>線区：</label>
            <select id="lineSelect">
                <option value="">選択してください</option>
                <option value="ChuoRapid">中央快速線</option>
                <option value="SobuRapid">総武快速線</option>
                <option value="Yamanote">山手線</option>
            </select>
        </div>
        <div class="control-item">
            <label>駅：</label>
            <select id="stationSelect">
                <option value="">選択してください</option>
            </select>
        </div>
        <div class="control-item">
            <label>日付：</label>
            <input type="date" id="dateSelect">
        </div>
        <div class="control-item">
            <label>時刻：</label>
            <input type="time" id="timeSelect">
        </div>
        <button class="display-btn" id="displayBtn">表示</button>
    </div>

    <table>
        <thead>
            <tr>
                <th class="col-direction">線別</th>
                <th class="col-train-number">列車番号</th>
                <th class="col-train-type">種別</th>
                <th class="col-time">発時刻</th>
                <th class="col-destination">行先</th>
				<th class="col-nonono">　</th>
            </tr>
        </thead>
        <tbody id="trainTable"></tbody>
    </table>

    <script>
        const trainTypeMap = {
            'odpt.TrainType:JR-East.Local': '普通',
            'odpt.TrainType:JR-East.Rapid': '快速',
            'odpt.TrainType:JR-East.LimitedExpress': '特急'
        };

        const destinationMap = {
            'odpt.Station:JR-East.ChuoRapid.Takao': '高尾',
            'odpt.Station:JR-East.ChuoRapid.Toyoda': '豊田',
            'odpt.Station:JR-East.ChuoRapid.Hachioji': '八王子',
            'odpt.Station:JR-East.ChuoRapid.Tokyo': '東京',
            'odpt.Station:JR-East.ChuoRapid.Shinjuku': '新宿'
        };

        const stationsByLine = {
            ChuoRapid: [
                { id: 'odpt.Station:JR-East.ChuoRapid.Tokyo', name: '東京' },
                { id: 'odpt.Station:JR-East.ChuoRapid.Shinjuku', name: '新宿' },
                { id: 'odpt.Station:JR-East.ChuoRapid.Hino', name: '日野' },
		{ id: 'odpt.Station:JR-East.ChuoRapid.Toyoda', name: '豊田' }
            ]
        };

        const lineSelect = document.getElementById('lineSelect');
        const stationSelect = document.getElementById('stationSelect');
        const dateSelect = document.getElementById('dateSelect');
        const timeSelect = document.getElementById('timeSelect');
        const displayBtn = document.getElementById('displayBtn');
        const trainTable = document.getElementById('trainTable');

        const now = new Date();
        dateSelect.value = now.toISOString().split('T')[0];
        timeSelect.value = now.toTimeString().slice(0,5);

        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        lineSelect.addEventListener('change', (e) => {
            const line = e.target.value;
            
            stationSelect.innerHTML = '<option value="">選択してください</option>';
            if (line && stationsByLine[line]) {
                stationsByLine[line].forEach(station => {
                    const option = document.createElement('option');
                    option.value = station.id;
                    option.textContent = station.name;
                    stationSelect.appendChild(option);
                });
            }
        });

        const token = "4w5vinot98zhhx1n1mjgpk1yshyp7k0pv42uzrvhq57ipr38ln8aodrr9ghzo75d";
        const baseUrl = "https://api-challenge2024.odpt.org/api/v4/odpt:StationTimetable";

        displayBtn.addEventListener('click', async () => {
            if (!lineSelect.value || !stationSelect.value) {
                alert('線区と駅を選択してください。');
                return;
            }

            trainTable.innerHTML = '';
            const selectedTime = timeToMinutes(timeSelect.value);
            
            try {
                const directions = ['Outbound', 'Inbound'];
                let allTrains = [];

                for (const direction of directions) {
                    const url = `${baseUrl}?odpt:operator=odpt.Operator:JR-East&odpt:station=${stationSelect.value}&odpt:railway=odpt.Railway:JR-East.${lineSelect.value}&odpt:railDirection=odpt.RailDirection:${direction}&acl:consumerKey=${token}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data && data.length > 0 && data[0]['odpt:stationTimetableObject']) {
                        const trains = data[0]['odpt:stationTimetableObject'].map(train => ({
                            trainNumber: train['odpt:trainNumber'],
                            trainType: train['odpt:trainType'],
                            departureTime: train['odpt:departureTime'],
                            destinationStation: train['odpt:destinationStation']?.[0],
                            direction: direction === 'Outbound' ? '下り' : '上り',
                            timeInMinutes: timeToMinutes(train['odpt:departureTime'])
                        }));
                        allTrains = [...allTrains, ...trains];
                    }
                }

                const downTrains = allTrains
                    .filter(train => train.direction === '下り' && train.timeInMinutes >= selectedTime)
                    .sort((a, b) => a.timeInMinutes - b.timeInMinutes)
                    .slice(0, 9);

                const upTrains = allTrains
                    .filter(train => train.direction === '上り' && train.timeInMinutes >= selectedTime)
                    .sort((a, b) => a.timeInMinutes - b.timeInMinutes)
                    .slice(0, 9);

                downTrains.forEach(train => {
                    const row = document.createElement('tr');
                    row.classList.add('down-train');
                    row.innerHTML = `
                        <td class="col-direction">下り</td>
                        <td>${train.trainNumber}</td>
                        <td>${trainTypeMap[train.trainType] || train.trainType}</td>
                        <td>${train.departureTime}</td>
                        <td>${destinationMap[train.destinationStation] || train.destinationStation}</td>
                    `;
                    trainTable.appendChild(row);
                });

                const separatorRow = document.createElement('tr');
                separatorRow.classList.add('separator');
                trainTable.appendChild(separatorRow);

                upTrains.forEach(train => {
                    const row = document.createElement('tr');
                    row.classList.add('up-train');
                    row.innerHTML = `
                        <td class="col-direction">上り</td>
                        <td>${train.trainNumber}</td>
                        <td>${trainTypeMap[train.trainType] || train.trainType}</td>
                        <td>${train.departureTime}</td>
                        <td>${destinationMap[train.destinationStation] || train.destinationStation}</td>
                    `;
                    trainTable.appendChild(row);
                });

            } catch (error) {
                console.error('エラー:', error);
                alert('データの取得中にエラーが発生しました。');
            }
        });
    </script>
</body>
</html>
